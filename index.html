<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sentinel Ops v6.19.4 | Newark Security Operations</title>
    
    <!--
        v6.19.4 CHANGELOG (December 2025)
        ==================================
        
        COVERAGE SUGGESTION ENGINE:
        - AI-ranked guard suggestions for open shifts
        - Scores guards on 8 factors: availability, certification, primary site,
          site familiarity, fatigue, overtime risk, and workload distribution
        - Armed/unarmed filtering for post type matching
        - One-click assign from suggestions modal
        - Accessible via Command Palette (âŒ˜K â†’ "Find Available Guards")
        - Integrates with FatigueModule for real-time fatigue scoring
        
        ALERT DISMISS FUNCTIONALITY:
        - X button on each alert to dismiss for 4 hours
        - "Dismiss All" button for warning alerts
        - "Show X dismissed" button to restore hidden alerts
        - Collapse entire Command Center with X button
        - Dismissed state persists across page reloads
        
        DASHBOARD DIRECT-TO-ISSUE NAVIGATION:
        - Site Status KPI â†’ Shows modal with actual sites & incidents
        - Clicking site with âš  â†’ Shows that site's open incidents
        - Open Incidents KPI â†’ Navigates to incidents filtered to Open
        - Contracts Expiring â†’ Shows modal with specific expiring contracts
        - Certs Expiring â†’ Shows modal with specific expiring certifications
        - Tasks Due Today â†’ Filters tasks to today's due items
        - Dashboard auto-refreshes on modal close (any data changes reflected)
        
        BUG FIXES:
        - Site Status now only counts OPEN incidents as "issues" (not resolved)
        - "X Critical" badge only counts OPEN critical/high incidents
        - quickFilter now navigates to Incidents page before applying filter
        - Status matching fixed: 'in progress' not 'in-progress'
        - Modal close triggers dashboard refresh
        
        CODE CLEANUP (Removed Redundancies):
        - REMOVED: AttentionPanel (~280 lines) - replaced by Command Center
        - REMOVED: RemindersPanel (~160 lines) - use TasksModule instead
        - REMOVED: Validators.normalizeGuard - replaced by GuardNormalizer
        - REMOVED: AvailabilityModule.searchAvailable - replaced by CoverageSuggestionEngine
        - CONSOLIDATED: "Find Available Guards" now uses Coverage Suggestion Engine
        
        UNIVERSAL DATA NORMALIZERS:
        - DataNormalizer: Core utility for phone, date, time, boolean, status normalization
        - SOPNormalizer: Handles ANY SOP format (sop_master.json, internal, legacy)
        - GuardNormalizer: Handles ANY guard format (CSV, manual, Firestore)
        - Normalization runs on every retrieval, not just import
        
        v6.19.2 CHANGELOG (December 2025)
        ==================================
        
        SITES BOOTSTRAP FIX:
        - Auto-creates site records from SOP_DATA when sites collection is empty
        - Sites now appear in Sites grid and Dashboard immediately on first load
        - Bootstrap runs during app initialization (Step 4)
        
        UI REFRESH (Slate/Gold Theme):
        - New color palette: slate backgrounds (#0f1218, #1a1e26) with gold primary accents (#d69e2e)
        - Command palette icons upgraded from emojis to clean SVG stroke icons
        - Gold gradient buttons with hover glow effects
        - Refined header buttons (36px, gold accent on hover)
        
        SECURITY HARDENING:
        - SecurityUtils.sanitizeString now escapes HTML entities (&, <, >, ", ')
        
        ALL V6.19.0 FEATURES PRESERVED:
        - SOP Module with supervisor-locked site SOPs
        - Full SOP_DATA database for all sites
        - All 19 sections and 50+ modules intact
    -->
    
    <!--
        v6.19.1 CHANGELOG (December 2025)
        ==================================
        
        UI REFRESH (Slate/Gold Theme):
        - New color palette: slate backgrounds (#0f1218, #1a1e26) with gold primary accents (#d69e2e)
        - Command palette icons upgraded from emojis to clean SVG stroke icons
        - Gold gradient buttons with hover glow effects
        - Refined header buttons (36px, gold accent on hover)
        - Improved visual consistency across all UI elements
        
        SECURITY HARDENING:
        - SecurityUtils.sanitizeString now escapes HTML entities (&, <, >, ", ')
        - Prevents XSS via stored data even if escapeHtml is missed in rendering
        
        ALL V6.19.0 FEATURES PRESERVED:
        - SOP Module with supervisor-locked site SOPs
        - Full SOP_DATA database for all sites
        - All 19 sections and 50+ modules intact
    -->
    
    <!--
        v6.10.5 CHANGELOG (December 2025)
        ==================================
        
        SOP MODULE INTEGRATION:
        - Added SOP_DATA constant for supervisor-locked site SOPs
        - Added SOPModule with renderSOP() for formatted SOP display
        - Added SOP tab to Site Detail modal (Info | SOP | Protocols)
        - SOP tab shows green checkmark when data exists for site
        - Displays: Coverage, Staffing, Patrols, Access Control,
          Authority, Escalation Chain, Known Issues, Use of Force Policy
        - Initial data: Zion Towers, Georgia King Village
        - Slugified site name matching for flexible ID resolution
        
        v6.9.0 CHANGELOG (December 2025)
        ================================
        
        INSIGHTS ENGINE REFACTOR:
        - Replaced monolithic AIInsights with rule-driven InsightsEngine
        - Added explicit rule definitions with metadata (id, category, severity, description)
        - Added confidence scoring (0-1) for each insight based on data quality
        - Added severity classification (low/medium/high) with color-coded UI
        - Added plain-language explanations for all insights
        - Added weekly comparison capability (COVERAGE_TREND_WEEKLY rule)
        - Detects week-over-week coverage degradation/improvement (10%+ threshold)
        
        PRESERVED FUNCTIONALITY:
        - All 5 original insight types maintained with identical logic
        - Backward compatible: AIInsights alias maintained for existing code
        - UI rendering pipeline unchanged
        - Cache behavior preserved (5-minute TTL)
        
        NEW FEATURES:
        - Insights sorted by severity (high > medium > low) then confidence
        - Confidence percentage displayed on each insight
        - Explanation text shows reasoning behind each detection
        - Weekly trend detection compares current vs previous week coverage
        
        TECHNICAL IMPROVEMENTS:
        - Rules are independently testable
        - Evaluation engine catches and logs rule failures
        - Structured metadata enables future filtering/grouping
        - No external dependencies or async complexity
    -->
    
    <!-- Security: Referrer Policy -->
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Security operations dashboard for Newark Security - manage guards, schedules, incidents, and inspections">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sentinel Ops">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Sentinel Ops">
    <meta name="msapplication-TileColor" content="#0f172a">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- PWA Manifest -->
    
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230f172a' width='100' height='100' rx='20'/><text x='50' y='68' font-size='50' text-anchor='middle' fill='%2338bdf8'>ğŸ›¡ï¸</text></svg>">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230f172a' width='100' height='100' rx='15'/><text x='50' y='65' font-size='45' text-anchor='middle' fill='%2338bdf8'>ğŸ›¡ï¸</text></svg>">

    <!-- Firebase SDK v9+ (Modular) -->
    <script type="module">
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FIREBASE CONFIGURATION â€” Replace with your Firebase project config
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import {
            getFirestore,
            collection,
            doc,
            getDocs,
            getDoc,
            setDoc,
            addDoc,
            updateDoc,
            deleteDoc,
            query,
            where,
            orderBy,
            onSnapshot,
            writeBatch,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase Auth
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signOut,
            onAuthStateChanged,
            sendPasswordResetEmail,
            updateProfile
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // âš ï¸ REPLACE THIS CONFIG with your Firebase project configuration
        // Get this from: Firebase Console â†’ Project Settings â†’ Your apps â†’ Web app
        const firebaseConfig = {
            apiKey: "AIzaSyC-j7QoXsjRrsT10a3r_9fskDNINaof7Zk",
            authDomain: "security-dashboard-8109.firebaseapp.com",
            projectId: "security-dashboard-8109",
            storageBucket: "security-dashboard-8109.firebasestorage.app",
            messagingSenderId: "239794956522",
            appId: "1:239794956522:web:d30f5c1a8ca2d03989cf93"
        };

        // Initialize Firebase
        let app, db;
        let firestoreEnabled = false;

        try {
            // Check if config is set up
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                firestoreEnabled = true;
                console.log('[FIREBASE] Firestore initialized successfully');
            } else {
                console.warn('âš ï¸ Firebase config not set. Using localStorage only. Add your Firebase config above.');
            }
        } catch (error) {
            console.error('âŒ Firebase initialization failed:', error);
            console.warn('Falling back to localStorage');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FIREBASE AUTH INITIALIZATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let auth;
        if (firestoreEnabled) {
            try {
                auth = getAuth(app);
                window.firebaseAuth = auth;
                console.log('[AUTH] Firebase Auth initialized');
            } catch (authError) {
                console.error('âŒ Firebase Auth initialization failed:', authError);
            }
        }

        // Export auth functions globally for SentinelAuth module
        window.getAuth = getAuth;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.sendPasswordResetEmail = sendPasswordResetEmail;
        window.updateProfile = updateProfile;
        window.firebaseApp = app;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SECURITY UTILITIES â€” Cryptographically secure operations (v6.8)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const SecurityUtils = {
            generateSecureId(prefix = '', length = 16) {
                const array = new Uint8Array(length);
                crypto.getRandomValues(array);
                const id = Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
                return prefix ? `${prefix}-${id}` : id;
            },
            generateUUID() {
                if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                    return crypto.randomUUID();
                }
                const array = new Uint8Array(16);
                crypto.getRandomValues(array);
                array[6] = (array[6] & 0x0f) | 0x40;
                array[8] = (array[8] & 0x3f) | 0x80;
                const hex = Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
                return `${hex.slice(0,8)}-${hex.slice(8,12)}-${hex.slice(12,16)}-${hex.slice(16,20)}-${hex.slice(20)}`;
            },
            isSecureContext() {
                return window.isSecureContext || location.protocol === 'https:' || 
                       location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            },
            safeSpread(target, ...sources) {
                const result = Object.create(null);
                const dangerous = ['__proto__', 'constructor', 'prototype'];
                if (target && typeof target === 'object') {
                    Object.keys(target).forEach(key => {
                        if (!dangerous.includes(key)) result[key] = target[key];
                    });
                }
                sources.forEach(source => {
                    if (source && typeof source === 'object') {
                        Object.keys(source).forEach(key => {
                            if (!dangerous.includes(key)) result[key] = source[key];
                        });
                    }
                });
                return result;
            },
            sanitizeString(str, maxLength = 10000) {
                if (typeof str !== 'string') return '';
                // Remove null bytes, escape HTML entities, trim
                return str.slice(0, maxLength)
                    .replace(/\0/g, '')
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;')
                    .trim();
            }
        };
        window.SecurityUtils = SecurityUtils;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VALIDATORS MODULE â€” Data validation and normalization (v6.8)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const Validators = {
            EMAIL_REGEX: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
            PHONE_REGEX: /^[\d\s\-\(\)\+\.]{7,20}$/,
            SAFE_STRING_REGEX: /^[^<>]*$/,
            
            site(site) {
                const errors = [];
                if (!site) return { valid: false, errors: ['Site object is required'] };
                if (!site.id || typeof site.id !== 'string') errors.push('Site ID is required');
                if (!site.name || typeof site.name !== 'string' || site.name.trim().length < 2) errors.push('Site name is required (min 2 characters)');
                if (!site.address || typeof site.address !== 'string') errors.push('Site address is required');
                if (site.status && !['active', 'on_hold', 'terminated'].includes(site.status)) errors.push('Invalid site status');
                if (site.riskLevel && !['low', 'medium', 'high'].includes(site.riskLevel)) errors.push('Invalid risk level');
                ['name', 'address', 'clientName', 'sopHighlights', 'riskNotes'].forEach(field => {
                    if (site[field] && !this.SAFE_STRING_REGEX.test(site[field])) errors.push(`${field} contains invalid characters`);
                });
                return { valid: errors.length === 0, errors };
            },
            
            normalizeSite(site) {
                return SecurityUtils.safeSpread({
                    id: site.id || SecurityUtils.generateSecureId('site'),
                    name: SecurityUtils.sanitizeString(site.name || 'Unnamed Site'),
                    address: SecurityUtils.sanitizeString(site.address || ''),
                    status: ['active', 'on_hold', 'terminated'].includes(site.status) ? site.status : 'active',
                    riskLevel: ['low', 'medium', 'high'].includes(site.riskLevel) ? site.riskLevel : 'low',
                    category: site.category || 'other',
                    clientName: SecurityUtils.sanitizeString(site.clientName || ''),
                    shiftPatterns: Array.isArray(site.shiftPatterns) ? site.shiftPatterns : [],
                    contacts: Array.isArray(site.contacts) ? site.contacts : [],
                    createdAt: site.createdAt || new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
            },
            
            guard(guard) {
                const errors = [];
                if (!guard) return { valid: false, errors: ['Guard object is required'] };
                if (!guard.id || typeof guard.id !== 'string') errors.push('Guard ID is required');
                if (!guard.firstName && !guard.name) errors.push('Guard name is required');
                if (guard.email && !this.EMAIL_REGEX.test(guard.email)) errors.push('Invalid email format');
                if (guard.phone && !this.PHONE_REGEX.test(guard.phone)) errors.push('Invalid phone format');
                if (guard.status && !['active', 'inactive', 'suspended', 'terminated'].includes(guard.status)) errors.push('Invalid guard status');
                ['firstName', 'lastName', 'name', 'notes', 'emergencyContact'].forEach(field => {
                    if (guard[field] && !this.SAFE_STRING_REGEX.test(guard[field])) errors.push(`${field} contains invalid characters`);
                });
                return { valid: errors.length === 0, errors };
            },
            
            incident(incident) {
                const errors = [];
                if (!incident) return { valid: false, errors: ['Incident object is required'] };
                if (!incident.id) errors.push('Incident ID is required');
                if (!incident.type) errors.push('Incident type is required');
                if (!incident.siteId) errors.push('Site ID is required');
                if (incident.severity && !['Low', 'Medium', 'High', 'Critical'].includes(incident.severity)) errors.push('Invalid severity level');
                if (incident.status && !['Open', 'Investigating', 'Resolved', 'Closed'].includes(incident.status)) errors.push('Invalid incident status');
                return { valid: errors.length === 0, errors };
            },
            
            inspection(inspection) {
                const errors = [];
                if (!inspection) return { valid: false, errors: ['Inspection object is required'] };
                if (!inspection.id) errors.push('Inspection ID is required');
                if (!inspection.siteId) errors.push('Site ID is required');
                return { valid: errors.length === 0, errors };
            },
            
            sanitizeCSVValue(value) {
                if (typeof value !== 'string') return value;
                const dangerous = ['=', '+', '-', '@', '\t', '\r', '\n'];
                let sanitized = value;
                while (dangerous.some(char => sanitized.startsWith(char))) {
                    sanitized = sanitized.slice(1);
                }
                return sanitized.replace(/"/g, '""');
            },
            
            sanitizeImportRow(row, entityType) {
                const sanitized = {};
                const dangerous = ['__proto__', 'constructor', 'prototype'];
                Object.keys(row).forEach(key => {
                    if (!dangerous.includes(key)) {
                        const value = row[key];
                        sanitized[key] = typeof value === 'string' ? this.sanitizeCSVValue(SecurityUtils.sanitizeString(value)) : value;
                    }
                });
                switch (entityType) {
                    case 'guard': return GuardNormalizer.normalize(sanitized, { generateId: !sanitized.id });
                    case 'site': return this.normalizeSite(sanitized);
                    default: return sanitized;
                }
            }
        };
        window.Validators = Validators;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RATE LIMITER â€” Brute force protection (v6.8)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const RateLimiter = {
            _attempts: new Map(),
            MAX_ATTEMPTS: 5,
            WINDOW_MS: 15 * 60 * 1000,
            LOCKOUT_MS: 30 * 60 * 1000,
            
            isAllowed(key) {
                const record = this._attempts.get(key);
                const now = Date.now();
                if (!record) return { allowed: true, remaining: this.MAX_ATTEMPTS };
                if (record.lockedUntil && now < record.lockedUntil) {
                    const waitTime = Math.ceil((record.lockedUntil - now) / 1000 / 60);
                    return { allowed: false, remaining: 0, lockedFor: waitTime, message: `Too many attempts. Try again in ${waitTime} minutes.` };
                }
                record.attempts = record.attempts.filter(t => now - t < this.WINDOW_MS);
                const remaining = this.MAX_ATTEMPTS - record.attempts.length;
                return { allowed: remaining > 0, remaining: Math.max(0, remaining), message: remaining <= 2 ? `${remaining} attempts remaining` : null };
            },
            
            recordAttempt(key) {
                const now = Date.now();
                let record = this._attempts.get(key);
                if (!record) { record = { attempts: [], lockedUntil: null }; this._attempts.set(key, record); }
                record.attempts = record.attempts.filter(t => now - t < this.WINDOW_MS);
                record.attempts.push(now);
                if (record.attempts.length >= this.MAX_ATTEMPTS) {
                    record.lockedUntil = now + this.LOCKOUT_MS;
                    console.warn(`[SECURITY] Rate limit exceeded for key: ${key.substring(0, 20)}...`);
                }
            },
            
            clearAttempts(key) { this._attempts.delete(key); },
            getRemainingAttempts(key) { return this.isAllowed(key).remaining; }
        };
        window.RateLimiter = RateLimiter;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FIRESTORE DATA STORE â€” Cloud-synced data operations
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        window.FirestoreDB = {
            enabled: firestoreEnabled,
            db: db,

            // Collection names
            COLLECTIONS: {
                SITES: 'sites',
                GUARDS: 'guards',
                INCIDENTS: 'incidents',
                INSPECTIONS: 'inspections',
                DAILY_REPORTS: 'dailyReports',
                SCHEDULES: 'schedules',
                AVAILABILITY: 'availability',
                SUPERVISOR_LOG: 'supervisorLog',
                CALLOFFS: 'calloffs',
                CONTACTS: 'contacts',
                SETTINGS: 'settings',
                DOCUMENTS: 'documents',
                COMMUNICATIONS: 'communications',
                PROTOCOLS: 'protocols'
            },

            // Generic fetch all documents from a collection
            async getAll(collectionName) {
                if (!this.enabled) return null;
                try {
                    const querySnapshot = await getDocs(collection(db, collectionName));
                    return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error(`Firestore getAll(${collectionName}) error:`, error);
                    return null;
                }
            },

            // Get single document
            async getById(collectionName, docId) {
                if (!this.enabled) return null;
                try {
                    const docRef = doc(db, collectionName, docId);
                    const docSnap = await getDoc(docRef);
                    return docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null;
                } catch (error) {
                    console.error(`Firestore getById error:`, error);
                    return null;
                }
            },

            // Save/Update document (merge)
            async save(collectionName, docId, data) {
                if (!this.enabled) return false;
                try {
                    const docRef = doc(db, collectionName, docId);
                    await setDoc(docRef, { ...data, updatedAt: serverTimestamp() }, { merge: true });
                    return true;
                } catch (error) {
                    console.error(`Firestore save error:`, error);
                    return false;
                }
            },

            // Add document with auto-generated ID
            async add(collectionName, data) {
                if (!this.enabled) return null;
                try {
                    const docRef = await addDoc(collection(db, collectionName), {
                        ...data,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                    return docRef.id;
                } catch (error) {
                    console.error(`Firestore add error:`, error);
                    return null;
                }
            },

            // Update specific fields
            async update(collectionName, docId, updates) {
                if (!this.enabled) return false;
                try {
                    const docRef = doc(db, collectionName, docId);
                    await updateDoc(docRef, { ...updates, updatedAt: serverTimestamp() });
                    return true;
                } catch (error) {
                    console.error(`Firestore update error:`, error);
                    return false;
                }
            },

            // Delete document
            async delete(collectionName, docId) {
                if (!this.enabled) return false;
                try {
                    await deleteDoc(doc(db, collectionName, docId));
                    return true;
                } catch (error) {
                    console.error(`Firestore delete error:`, error);
                    return false;
                }
            },

            // Batch save all items (for initial sync)
            async saveAll(collectionName, items) {
                if (!this.enabled) return false;
                try {
                    const batch = writeBatch(db);
                    items.forEach(item => {
                        const docRef = doc(db, collectionName, item.id);
                        batch.set(docRef, { ...item, updatedAt: serverTimestamp() }, { merge: true });
                    });
                    await batch.commit();
                    return true;
                } catch (error) {
                    console.error(`Firestore saveAll error:`, error);
                    return false;
                }
            },

            // Subscribe to real-time updates
            subscribe(collectionName, callback) {
                if (!this.enabled) return () => { };
                try {
                    return onSnapshot(collection(db, collectionName), (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        callback(data);
                    });
                } catch (error) {
                    console.error(`Firestore subscribe error:`, error);
                    return () => { };
                }
            },

            // === COLLECTION-SPECIFIC METHODS ===

            // Sites
            async getSites() { return this.getAll(this.COLLECTIONS.SITES); },
            async saveSites(sites) { return this.saveAll(this.COLLECTIONS.SITES, sites); },
            async saveSite(site) { return this.save(this.COLLECTIONS.SITES, site.id, site); },
            async updateSite(id, updates) { return this.update(this.COLLECTIONS.SITES, id, updates); },
            async deleteSite(id) { return this.delete(this.COLLECTIONS.SITES, id); },

            // Guards
            async getGuards() { return this.getAll(this.COLLECTIONS.GUARDS); },
            async saveGuards(guards) { return this.saveAll(this.COLLECTIONS.GUARDS, guards); },
            async saveGuard(guard) { return this.save(this.COLLECTIONS.GUARDS, guard.id, guard); },
            async addGuard(guard) { return this.save(this.COLLECTIONS.GUARDS, guard.id, guard); },
            async updateGuard(id, updates) { return this.update(this.COLLECTIONS.GUARDS, id, updates); },
            async deleteGuard(id) { return this.delete(this.COLLECTIONS.GUARDS, id); },

            // Incidents
            async getIncidents() { return this.getAll(this.COLLECTIONS.INCIDENTS); },
            async saveIncidents(incidents) { return this.saveAll(this.COLLECTIONS.INCIDENTS, incidents); },
            async addIncident(incident) {
                const id = await this.add(this.COLLECTIONS.INCIDENTS, incident);
                return id ? { ...incident, id } : null;
            },
            async updateIncident(id, updates) { return this.update(this.COLLECTIONS.INCIDENTS, id, updates); },

            // Inspections
            async getInspections() { return this.getAll(this.COLLECTIONS.INSPECTIONS); },
            async saveInspections(inspections) { return this.saveAll(this.COLLECTIONS.INSPECTIONS, inspections); },
            async addInspection(inspection) { return this.add(this.COLLECTIONS.INSPECTIONS, inspection); },

            // Protocols (FIX: Added missing methods for v6.8)
            async getProtocols() { return this.getAll(this.COLLECTIONS.PROTOCOLS); },
            async saveProtocols(protocols) { return this.saveAll(this.COLLECTIONS.PROTOCOLS, protocols); },
            async addProtocol(protocol) { return this.save(this.COLLECTIONS.PROTOCOLS, protocol.id, protocol); },
            async updateProtocol(id, updates) { return this.update(this.COLLECTIONS.PROTOCOLS, id, updates); },
            async deleteProtocol(id) { return this.delete(this.COLLECTIONS.PROTOCOLS, id); },

            // Schedules (stored by weekKey)
            async getScheduleForWeek(weekKey) {
                const data = await this.getById(this.COLLECTIONS.SCHEDULES, weekKey);
                return data?.shifts || [];
            },
            async saveScheduleForWeek(weekKey, shifts) {
                return this.save(this.COLLECTIONS.SCHEDULES, weekKey, { shifts, weekKey });
            },

            // Availability
            async getAvailability() {
                // Returns array of availability records
                const items = await this.getAll(this.COLLECTIONS.AVAILABILITY);
                return Array.isArray(items) ? items : [];
            },
            async saveAvailability(availabilityArray) {
                // Saves entire availability array
                return this.saveAll(this.COLLECTIONS.AVAILABILITY, availabilityArray || []);
            },

            // Supervisor Log
            async getSupervisorLog() { return this.getAll(this.COLLECTIONS.SUPERVISOR_LOG); },
            async addLogEntry(entry) { return this.add(this.COLLECTIONS.SUPERVISOR_LOG, entry); },
            async updateLogEntry(id, updates) { return this.update(this.COLLECTIONS.SUPERVISOR_LOG, id, updates); },
            async deleteLogEntry(id) { return this.delete(this.COLLECTIONS.SUPERVISOR_LOG, id); },

            // Calloffs
            async getCalloffs() { return this.getAll(this.COLLECTIONS.CALLOFFS); },
            async saveCallOffs(calloffs) { return this.saveAll(this.COLLECTIONS.CALLOFFS, calloffs); },
            async addCalloff(calloff) { return this.add(this.COLLECTIONS.CALLOFFS, calloff); },
            async updateCalloff(id, updates) { return this.update(this.COLLECTIONS.CALLOFFS, id, updates); },
            async deleteCalloff(id) { return this.delete(this.COLLECTIONS.CALLOFFS, id); },

            // Contacts
            async getContacts() { return this.getAll(this.COLLECTIONS.CONTACTS); },
            async saveContacts(contacts) { return this.saveAll(this.COLLECTIONS.CONTACTS, contacts); },
            async addContact(contact) { return this.add(this.COLLECTIONS.CONTACTS, contact); },
            async updateContact(id, updates) { return this.update(this.COLLECTIONS.CONTACTS, id, updates); },
            async deleteContact(id) { return this.delete(this.COLLECTIONS.CONTACTS, id); },

            // Communications
            async getCommunications() { return this.getAll(this.COLLECTIONS.COMMUNICATIONS); },
            async saveCommunications(comms) { return this.saveAll(this.COLLECTIONS.COMMUNICATIONS, comms); },
            async addCommunication(comm) { 
                // Use the existing ID from the comm object
                return this.save(this.COLLECTIONS.COMMUNICATIONS, comm.id, comm);
            },
            async updateCommunication(id, updates) { return this.update(this.COLLECTIONS.COMMUNICATIONS, id, updates); },
            async deleteCommunication(id) { return this.delete(this.COLLECTIONS.COMMUNICATIONS, id); },

            // Documents
            async getDocuments() { return this.getAll(this.COLLECTIONS.DOCUMENTS); },
            async saveDocuments(documents) { return this.saveAll(this.COLLECTIONS.DOCUMENTS, documents); },
            async addDocument(document) { return this.save(this.COLLECTIONS.DOCUMENTS, document.id, document); },
            async updateDocument(id, updates) { return this.update(this.COLLECTIONS.DOCUMENTS, id, updates); },
            async deleteDocument(id) { return this.delete(this.COLLECTIONS.DOCUMENTS, id); },

            // Settings
            async getSettings() {
                const data = await this.getById(this.COLLECTIONS.SETTINGS, 'app');
                return data || { theme: 'dark' };
            },
            async saveSettings(settings) { return this.save(this.COLLECTIONS.SETTINGS, 'app', settings); },

            // Daily Reports
            async getDailyReports() { return this.getAll(this.COLLECTIONS.DAILY_REPORTS); },
            async addDailyReport(report) { return this.add(this.COLLECTIONS.DAILY_REPORTS, report); },
            async updateDailyReport(id, updates) { return this.update(this.COLLECTIONS.DAILY_REPORTS, id, updates); },
            async deleteDailyReport(id) { return this.delete(this.COLLECTIONS.DAILY_REPORTS, id); },

            // === SYNC UTILITIES ===

            // Migrate localStorage data to Firestore
            async migrateFromLocalStorage(localData) {
                if (!this.enabled) return false;

                console.log('ğŸ”„ Starting migration to Firestore...');
                const results = {
                    sites: await this.saveAll(this.COLLECTIONS.SITES, localData.sites || []),
                    guards: await this.saveAll(this.COLLECTIONS.GUARDS, localData.guards || []),
                    incidents: await this.saveAll(this.COLLECTIONS.INCIDENTS, localData.incidents || []),
                    inspections: await this.saveAll(this.COLLECTIONS.INSPECTIONS, localData.inspections || []),
                    contacts: await this.saveAll(this.COLLECTIONS.CONTACTS, localData.contacts || []),
                    supervisorLog: await this.saveAll(this.COLLECTIONS.SUPERVISOR_LOG, localData.supervisorLog || []),
                    calloffs: await this.saveAll(this.COLLECTIONS.CALLOFFS, localData.calloffs || []),
                    dailyReports: await this.saveAll(this.COLLECTIONS.DAILY_REPORTS, localData.dailyReports || []),
                    communications: await this.saveAll(this.COLLECTIONS.COMMUNICATIONS, localData.communications || []),
                    documents: await this.saveAll(this.COLLECTIONS.DOCUMENTS, localData.documents || [])
                };

                // Migrate schedules (keyed by week)
                if (localData.schedules) {
                    for (const [weekKey, shifts] of Object.entries(localData.schedules)) {
                        await this.saveScheduleForWeek(weekKey, shifts);
                    }
                }

                // Migrate availability (keyed by guardId_weekKey)
                if (localData.availability) {
                    for (const [key, data] of Object.entries(localData.availability)) {
                        await this.save(this.COLLECTIONS.AVAILABILITY, key, data);
                    }
                }

                // Migrate settings
                if (localData.settings) {
                    await this.saveSettings(localData.settings);
                }

                console.log('[FIREBASE] Migration complete:', results);
                return true;
            },

            // Check if Firestore has data
            async hasData() {
                if (!this.enabled) return false;
                const sites = await this.getSites();
                return sites && sites.length > 0;
            }
        };

        // Make it available globally for the sync layer
        window.FirestoreReady = firestoreEnabled;
        
        // v6.8: Signal that Firebase module has finished loading
        window.FirebaseModuleReady = true;
        window.dispatchEvent(new CustomEvent('firebase-ready'));
    </script>

    <style>
/* Icon baseline (header + general) */
.icon{width:18px;height:18px;display:inline-block;color:inherit;}
.icon use{pointer-events:none;}

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PWA & MOBILE SAFE AREAS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* Handle iPhone notch and home indicator */
        @supports (padding: env(safe-area-inset-top)) {
            .main-header {
                padding-top: env(safe-area-inset-top);
            }
            
            .pwa-standalone .main-header {
                padding-top: calc(env(safe-area-inset-top) + var(--space-2));
            }
            
            .field-nav {
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .modal {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
        
        /* PWA Standalone Mode Adjustments */
        .pwa-standalone .main-header {
            padding-top: var(--space-4);
        }
        
        /* Prevent text selection on tap (more app-like) */
        .pwa-standalone button,
        .pwa-standalone .btn,
        .pwa-standalone .nav-tab,
        .pwa-standalone .kpi-card {
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Smoother pull-to-refresh feel */
        html {
            overscroll-behavior-y: contain;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DESIGN TOKENS â€” Edit these to customize the entire dashboard
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        :root {
            /* Color Palette â€” Slate/Gold Theme (v6.19.1) */
            --color-bg: #0f1218;
            --color-surface: #1a1e26;
            --color-surface-elevated: #252b37;
            --color-border: #363e4d;
            --color-border-subtle: #252b37;

            /* Brand Colors â€” Gold Primary */
            --color-primary: #d69e2e;
            --color-primary-hover: #b7791f;
            --color-accent: #ecc94b;
            --color-accent-hover: #d69e2e;

            /* Status Colors */
            --color-success: #48bb78;
            --color-success-bg: rgba(72, 187, 120, 0.15);
            --color-warning: #ed8936;
            --color-warning-bg: rgba(237, 137, 54, 0.15);
            --color-danger: #f56565;
            --color-danger-bg: rgba(245, 101, 101, 0.15);
            --color-info: #4299e1;
            --color-info-bg: rgba(66, 153, 225, 0.15);

            /* Text Colors */
            --color-text: #e2e8f0;
            --color-text-secondary: #a0aec0;
            --color-text-muted: #718096;
            --color-text-inverse: #0a0c10;

            /* Typography */
            --font-family-display: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-family-body: 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-family-mono: 'SF Mono', 'Fira Code', 'Consolas', monospace;

            --font-size-xs: 0.75rem;
            --font-size-sm: 0.8125rem;
            --font-size-base: 0.9375rem;
            --font-size-lg: 1.0625rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.625rem;
            --font-size-3xl: 2.125rem;

            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;

            --line-height-tight: 1.25;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.75;

            /* Spacing Scale */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
            --space-16: 4rem;

            /* Border Radius */
            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-full: 9999px;

            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.3);

            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-base: 200ms ease;
            --transition-slow: 300ms ease;

            /* Layout */
            --header-height: 64px;
            --content-max-width: 1400px;

            /* Z-Index Scale */
            --z-dropdown: 100;
            --z-sticky: 200;
            --z-modal-backdrop: 300;
            --z-modal: 400;
            --z-toast: 500;
        }

        /* Light Theme Override */
        [data-theme="light"] {
            --color-bg: #f8fafc;
            --color-surface: #ffffff;
            --color-surface-elevated: #ffffff;
            --color-border: #e2e8f0;
            --color-border-subtle: #f1f5f9;
            --color-text: #1e293b;
            --color-text-secondary: #475569;
            --color-text-muted: #94a3b8;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }


        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PRINT STYLESHEET â€” ENHANCED v4.6
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media print {

            .main-header .header-actions,
            .btn,
            .search-box,
            #theme-toggle,
            #help-btn,
            .toolbar {
                display: none !important;
            }

            /* Show simplified header brand in print */
            .main-header {
                background: #fff !important;
                border-bottom: 2px solid #000 !important;
                padding: 0.5rem 1rem !important;
                position: relative !important;
            }

            .header-brand-icon {
                background: #000 !important;
                color: #fff !important;
            }

            .header-brand-title,
            .header-brand-section {
                color: #000 !important;
            }

            body {
                color: #000;
                background: #fff;
            }

            .main-content {
                margin-left: 0 !important;
                padding: 1rem !important;
            }

            .table {
                border: 1px solid #000;
                page-break-inside: avoid;
            }

            .table th,
            .table td {
                border: 1px solid #000;
                padding: 0.5rem;
            }

            .card {
                border: 1px solid #000;
                box-shadow: none;
                page-break-inside: avoid;
            }

            h1,
            h2,
            h3 {
                color: #000;
                page-break-after: avoid;
            }

            /* Print footer with timestamp */
            @page {
                margin: 0.75in;
            }

            /* Warning Notice Print Styles */
            .warning-notice-print {
                display: block !important;
                background: #fff !important;
                color: #000 !important;
                padding: 0.5in !important;
            }

            .warning-notice-print * {
                color: #000 !important;
                background: transparent !important;
            }

            .warning-notice-print .notice-header {
                border-bottom: 2px solid #000 !important;
            }

            .warning-notice-print .checkbox-item input[type="checkbox"] {
                -webkit-appearance: none;
                appearance: none;
                width: 14px;
                height: 14px;
                border: 1px solid #000 !important;
                background: #fff !important;
            }

            .warning-notice-print .checkbox-item input[type="checkbox"]:checked::after {
                content: "âœ“";
                display: block;
                text-align: center;
                line-height: 12px;
                font-size: 12px;
            }

            .warning-notice-print .signature-line {
                border-bottom: 1px solid #000 !important;
            }
        }

        /* Warning Notice Form Styles (screen) */
        .warning-notice-form {
            max-width: 800px;
            margin: 0 auto;
        }

        .warning-notice-form .form-section {
            margin-bottom: var(--space-5);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--color-border);
        }

        .warning-notice-form .form-section:last-child {
            border-bottom: none;
        }

        .warning-notice-form .section-title {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
            margin-bottom: var(--space-3);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .warning-notice-form .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: var(--space-2);
        }

        .warning-notice-form .checkbox-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .warning-notice-form .checkbox-item:hover {
            border-color: var(--color-primary);
            background: var(--color-surface-elevated);
        }

        .warning-notice-form .checkbox-item.checked {
            border-color: var(--color-primary);
            background: var(--color-info-bg);
        }

        .warning-notice-form .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--color-primary);
        }

        .warning-notice-form .checkbox-item label {
            cursor: pointer;
            font-size: var(--font-size-sm);
        }

        .warning-notice-form .radio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: var(--space-2);
        }

        .warning-notice-form .radio-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .warning-notice-form .radio-item:hover {
            border-color: var(--color-primary);
        }

        .warning-notice-form .radio-item.selected {
            border-color: var(--color-primary);
            background: var(--color-info-bg);
        }

        .warning-notice-form .radio-item input[type="radio"] {
            width: 16px;
            height: 16px;
            accent-color: var(--color-primary);
        }

        /* Warning Notice Print Preview */
        .warning-notice-preview {
            background: #fff;
            color: #000;
            padding: 0.5in;
            font-family: 'Times New Roman', Times, serif;
            font-size: 12pt;
            line-height: 1.4;
            max-width: 8.5in;
            margin: 0 auto;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
        }

        .warning-notice-preview * {
            color: #000;
        }

        .warning-notice-preview .notice-header {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 12pt;
            margin-bottom: 16pt;
        }

        .warning-notice-preview .notice-header h1 {
            font-size: 18pt;
            font-weight: bold;
            margin: 0 0 4pt 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .warning-notice-preview .notice-header .company-name {
            font-size: 14pt;
            font-weight: bold;
            margin-bottom: 2pt;
        }

        .warning-notice-preview .info-section {
            margin-bottom: 16pt;
        }

        .warning-notice-preview .info-row {
            display: flex;
            margin-bottom: 8pt;
        }

        .warning-notice-preview .info-label {
            font-weight: bold;
            width: 120pt;
            flex-shrink: 0;
        }

        .warning-notice-preview .info-value {
            flex: 1;
            border-bottom: 1px solid #000;
            padding-bottom: 2pt;
            min-height: 16pt;
        }

        .warning-notice-preview .checkbox-section {
            margin-bottom: 16pt;
        }

        .warning-notice-preview .checkbox-section h3 {
            font-size: 11pt;
            font-weight: bold;
            margin-bottom: 8pt;
            text-decoration: underline;
        }

        .warning-notice-preview .checkbox-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4pt 16pt;
        }

        .warning-notice-preview .checkbox-list-item {
            display: flex;
            align-items: center;
            gap: 6pt;
            font-size: 11pt;
        }

        .warning-notice-preview .check-box {
            width: 12pt;
            height: 12pt;
            border: 1px solid #000;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10pt;
            flex-shrink: 0;
        }

        .warning-notice-preview .notes-section {
            margin-bottom: 20pt;
        }

        .warning-notice-preview .notes-section h3 {
            font-size: 11pt;
            font-weight: bold;
            margin-bottom: 6pt;
        }

        .warning-notice-preview .notes-content {
            border: 1px solid #000;
            min-height: 80pt;
            padding: 8pt;
            white-space: pre-wrap;
        }

        .warning-notice-preview .signature-section {
            margin-top: 24pt;
        }

        .warning-notice-preview .signature-row {
            display: flex;
            gap: 40pt;
            margin-bottom: 20pt;
        }

        .warning-notice-preview .signature-block {
            flex: 1;
        }

        .warning-notice-preview .signature-line {
            border-bottom: 1px solid #000;
            height: 30pt;
            margin-bottom: 4pt;
        }

        .warning-notice-preview .signature-label {
            font-size: 10pt;
        }

        .warning-notice-preview .date-line {
            width: 120pt;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESET & BASE STYLES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-family-body);
            font-size: var(--font-size-base);
            line-height: var(--line-height-normal);
            color: var(--color-text);
            background-color: var(--color-bg);
            min-height: 100vh;
            overflow-x: hidden;
        }

        a {
            color: var(--color-primary);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        button {
            font-family: inherit;
            cursor: pointer;
            border: none;
            background: none;
        }

        input,
        select,
        textarea {
            font-family: inherit;
            font-size: inherit;
        }

        /* Focus styles for accessibility */
        :focus-visible {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }


        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SEARCH BOX STYLES â€” ENHANCED v4.6
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .search-box {
            position: relative;
            margin-bottom: var(--space-4);
        }

        .search-input {
            width: 100%;
            padding: var(--space-3) var(--space-4) var(--space-3) var(--space-10);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            color: var(--color-text);
            font-size: var(--font-size-base);
            transition: all var(--transition-base);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-icon {
            position: absolute;
            left: var(--space-3);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-muted);
            pointer-events: none;
        }

        .search-clear {
            position: absolute;
            right: var(--space-3);
            top: 50%;
            transform: translateY(-50%);
            background: var(--color-surface-elevated);
            border: none;
            color: var(--color-text-secondary);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: var(--font-size-sm);
            display: none;
        }

        .search-clear:hover {
            background: var(--color-border);
        }

        .search-box.has-value .search-clear {
            display: block;
        }

        .keyboard-hint {
            position: fixed;
            bottom: var(--space-4);
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-2) var(--space-4);
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            z-index: var(--z-toast);
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .keyboard-hint.show {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .kbd {
            display: inline-block;
            padding: 2px 6px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 3px;
            font-family: var(--font-family-mono);
            font-size: 0.7rem;
            margin: 0 2px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LAYOUT STRUCTURE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header Brand (replaces sidebar logo) */
        .header-brand {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .header-brand-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-base);
        }

        .header-brand-text {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .header-brand-title {
            font-family: var(--font-family-display);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
            letter-spacing: -0.01em;
        }

        .header-brand-section {
            font-size: var(--font-size-xs);
            color: var(--color-primary);
            font-weight: var(--font-weight-medium);
            background: var(--color-info-bg);
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            margin-top: 2px;
            display: inline-block;
        }

        .main-header {
            position: sticky;
            top: 0;
            height: var(--header-height);
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-6);
            z-index: var(--z-sticky);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        /* Sidebar toggle is now always visible, styled above */

        .page-title {
            font-family: var(--font-family-display);
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        /* Sync Button States */
        #sync-btn.syncing svg {
            animation: spin 1s linear infinite;
            color: var(--color-primary);
        }

        #sync-btn.error svg {
            color: var(--color-danger);
        }

        #sync-btn.synced svg {
            color: var(--color-success);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .header-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
            transition: all var(--transition-fast);
            position: relative;
            background: transparent;
        }

        .header-btn:hover {
            background: var(--color-surface-elevated);
            color: var(--color-primary);
        }

        .header-btn.active {
            background: var(--color-surface-elevated);
            color: var(--color-primary);
        }

        .header-btn svg {
            width: 20px;
            height: 20px;
        }

        .header-btn-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 8px;
            height: 8px;
            background: var(--color-danger);
            border-radius: var(--radius-full);
            border: 2px solid var(--color-surface);
        }

        /* v6.8.6: Header Dropdown (for AI Insights) */
        .header-dropdown {
            position: relative;
        }

        .header-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: var(--space-2);
            width: 320px;
            max-height: 400px;
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            overflow: hidden;
        }

        .header-dropdown.open .header-dropdown-menu {
            display: block;
            animation: dropdownFadeIn 0.15s ease-out;
        }

        @keyframes dropdownFadeIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dropdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--color-border);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
        }

        .dropdown-content {
            max-height: 340px;
            overflow-y: auto;
        }

        .dropdown-empty {
            padding: var(--space-6);
            text-align: center;
            color: var(--color-text-muted);
            font-size: var(--font-size-sm);
        }

        .dropdown-insight {
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--color-border-subtle);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .dropdown-insight:hover {
            background: var(--color-surface-hover);
        }

        .dropdown-insight:last-child {
            border-bottom: none;
        }

        .dropdown-insight-type {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-primary);
            margin-bottom: var(--space-1);
        }

        .dropdown-insight-message {
            font-size: var(--font-size-sm);
            color: var(--color-text);
            line-height: 1.4;
        }

        .dropdown-insight-action {
            font-size: var(--font-size-xs);
            color: var(--color-primary);
            margin-top: var(--space-1);
        }

        /* v6.9.0: Insights Engine enhancements */
        .insight-confidence {
            display: inline-block;
            font-size: var(--font-size-xs);
            padding: 2px 6px;
            background: var(--color-surface-hover);
            border-radius: var(--radius-sm);
            margin-left: var(--space-2);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-muted);
        }

        .insight-explanation {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
            margin-top: var(--space-2);
            padding-top: var(--space-2);
            border-top: 1px solid var(--color-border-subtle);
            font-style: italic;
        }

        .dropdown-insight[data-severity="high"] .dropdown-insight-type {
            color: var(--color-danger);
        }

        .dropdown-insight[data-severity="medium"] .dropdown-insight-type {
            color: var(--color-warning);
        }

        .dropdown-insight[data-severity="low"] .dropdown-insight-type {
            color: var(--color-info);
        }

        #insights-toggle.has-insights {
            color: var(--color-primary);
        }

        .main-body {
            flex: 1;
            padding: var(--space-6);
            max-width: var(--content-max-width);
            width: 100%;
            margin: 0 auto;
        }

        /* Page Sections */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
            animation: fadeIn var(--transition-base);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           COMPONENT LIBRARY
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        /* Cards */
        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .card-header {
            padding: var(--space-4) var(--space-5);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-4);
        }

        .card-title {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
        }

        .card-body {
            padding: var(--space-5);
            flex: 1;
        }

        .card-footer {
            padding: var(--space-4) var(--space-5);
            border-top: 1px solid var(--color-border);
            background: var(--color-surface-elevated);
            margin-top: auto;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TASKS MODULE STYLES - v6.8.6
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-5);
            flex-wrap: wrap;
            gap: var(--space-3);
        }

        .tasks-header-left {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .tasks-view-toggle {
            display: flex;
            background: var(--color-surface-elevated);
            border-radius: var(--radius-md);
            padding: 4px;
            gap: 4px;
        }

        .tasks-view-btn {
            padding: var(--space-2) var(--space-3);
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
            transition: all var(--transition-fast);
        }

        .tasks-view-btn.active {
            background: var(--color-primary);
            color: white;
        }

        .tasks-view-btn:hover:not(.active) {
            background: var(--color-surface-hover);
            color: var(--color-text);
        }

        .tasks-quick-add {
            display: flex;
            gap: var(--space-2);
            flex: 1;
            max-width: 500px;
        }

        .tasks-quick-add input {
            flex: 1;
        }

        /* Kanban Board View */
        .tasks-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-4);
            min-height: 500px;
        }

        .tasks-lane {
            background: var(--color-surface-elevated);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            display: flex;
            flex-direction: column;
            min-height: 400px;
        }

        .tasks-lane-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: var(--space-3);
            margin-bottom: var(--space-3);
            border-bottom: 2px solid var(--color-border);
        }

        .tasks-lane-title {
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-sm);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .tasks-lane-count {
            background: var(--color-surface);
            color: var(--color-text-muted);
            font-size: var(--font-size-xs);
            padding: 2px 8px;
            border-radius: var(--radius-full);
        }

        .tasks-lane[data-lane="inbox"] .tasks-lane-header { border-bottom-color: var(--color-warning); }
        .tasks-lane[data-lane="next"] .tasks-lane-header { border-bottom-color: var(--color-primary); }
        .tasks-lane[data-lane="waiting"] .tasks-lane-header { border-bottom-color: var(--color-info); }
        .tasks-lane[data-lane="done"] .tasks-lane-header { border-bottom-color: var(--color-success); }

        .tasks-lane-items {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            overflow-y: auto;
        }

        .task-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .task-card:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .task-card.priority-p0 { border-left: 3px solid var(--color-danger); }
        .task-card.priority-p1 { border-left: 3px solid var(--color-warning); }
        .task-card.priority-p2 { border-left: 3px solid var(--color-text-muted); }

        .task-card-title {
            font-weight: var(--font-weight-medium);
            line-height: 1.3;
        }

        .task-card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
        }

        .task-card-tag {
            background: var(--color-surface-elevated);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
        }

        .task-card-due {
            font-size: var(--font-size-xs);
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            background: var(--color-surface-elevated);
        }

        .task-card-due.overdue {
            color: var(--color-danger);
            font-weight: var(--font-weight-semibold);
            background: rgba(239, 68, 68, 0.1);
        }

        .task-card-due.today {
            color: var(--color-warning);
            font-weight: var(--font-weight-semibold);
            background: rgba(245, 158, 11, 0.1);
        }

        .task-card-due.upcoming {
            color: var(--color-primary);
        }

        .task-card-due.completed {
            color: var(--color-success);
            background: rgba(34, 197, 94, 0.1);
        }

        .task-card-recurring {
            color: var(--color-primary);
        }

        /* List View */
        .tasks-list {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            overflow: hidden;
        }

        .tasks-list-header {
            display: grid;
            grid-template-columns: 40px 1fr 120px 100px 100px 100px 100px 60px;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            background: var(--color-surface-elevated);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text-muted);
            border-bottom: 1px solid var(--color-border);
        }

        .tasks-list-item {
            display: grid;
            grid-template-columns: 40px 1fr 120px 100px 100px 100px 100px 60px;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            align-items: center;
            border-bottom: 1px solid var(--color-border-subtle);
            transition: background var(--transition-fast);
        }

        .tasks-list-item:hover {
            background: var(--color-surface-hover);
        }

        .tasks-list-item:last-child {
            border-bottom: none;
        }

        .tasks-list-item.done .task-list-title {
            text-decoration: line-through;
            color: var(--color-text-muted);
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border-radius: var(--radius-sm);
            border: 2px solid var(--color-border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .task-checkbox:hover {
            border-color: var(--color-primary);
        }

        .task-checkbox.checked {
            background: var(--color-success);
            border-color: var(--color-success);
            color: white;
        }

        .task-list-title {
            font-weight: var(--font-weight-medium);
            cursor: pointer;
        }

        .task-list-title:hover {
            color: var(--color-primary);
        }

        /* Calendar View */
        .tasks-calendar {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            overflow: hidden;
        }

        .tasks-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-4);
            background: var(--color-surface-elevated);
            border-bottom: 1px solid var(--color-border);
        }

        .tasks-calendar-nav {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .tasks-calendar-title {
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-lg);
            min-width: 180px;
            text-align: center;
        }

        .tasks-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .tasks-calendar-day-header {
            padding: var(--space-2);
            text-align: center;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            text-transform: uppercase;
            color: var(--color-text-muted);
            background: var(--color-surface-elevated);
            border-bottom: 1px solid var(--color-border);
        }

        .tasks-calendar-day {
            min-height: 100px;
            padding: var(--space-2);
            border-right: 1px solid var(--color-border-subtle);
            border-bottom: 1px solid var(--color-border-subtle);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .tasks-calendar-day:nth-child(7n) {
            border-right: none;
        }

        .tasks-calendar-day:hover {
            background: var(--color-surface-hover);
        }

        .tasks-calendar-day.other-month {
            background: var(--color-surface-elevated);
            color: var(--color-text-muted);
        }

        .tasks-calendar-day.today {
            background: rgba(59, 130, 246, 0.1);
        }

        .tasks-calendar-date {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-1);
        }

        .tasks-calendar-day.today .tasks-calendar-date {
            color: var(--color-primary);
        }

        .tasks-calendar-items {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .tasks-calendar-item {
            font-size: var(--font-size-xs);
            padding: 2px 4px;
            border-radius: var(--radius-sm);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .tasks-calendar-item.priority-p0 { background: rgba(239, 68, 68, 0.2); color: var(--color-danger); }
        .tasks-calendar-item.priority-p1 { background: rgba(245, 158, 11, 0.2); color: var(--color-warning); }
        .tasks-calendar-item.priority-p2 { background: var(--color-surface-elevated); }

        .tasks-calendar-more {
            font-size: var(--font-size-xs);
            color: var(--color-primary);
            cursor: pointer;
        }

        /* Task Modal */
        .task-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4);
        }

        .task-form-full {
            grid-column: 1 / -1;
        }

        /* Filters Bar */
        .tasks-filters {
            display: flex;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
            flex-wrap: wrap;
        }

        .tasks-filter-group {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .tasks-filter-group label {
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
        }

        /* Dashboard Tasks Widget */
        .dashboard-tasks-widget {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
        }

        .dashboard-tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }

        .dashboard-tasks-title {
            font-weight: var(--font-weight-semibold);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .dashboard-tasks-count {
            background: var(--color-danger);
            color: white;
            font-size: var(--font-size-xs);
            padding: 2px 8px;
            border-radius: var(--radius-full);
        }

        .dashboard-tasks-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .dashboard-task-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-2);
            background: var(--color-surface-elevated);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .dashboard-task-item:hover {
            background: var(--color-surface-hover);
        }

        .dashboard-task-priority {
            width: 4px;
            height: 24px;
            border-radius: 2px;
        }

        .dashboard-task-priority.p0 { background: var(--color-danger); }
        .dashboard-task-priority.p1 { background: var(--color-warning); }
        .dashboard-task-priority.p2 { background: var(--color-text-muted); }

        .dashboard-task-content {
            flex: 1;
            min-width: 0;
        }

        .dashboard-task-title {
            font-size: var(--font-size-sm);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dashboard-task-due {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
        }

        .dashboard-task-due.overdue {
            color: var(--color-danger);
        }

        @media (max-width: 1200px) {
            .tasks-board {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .tasks-board {
                grid-template-columns: 1fr;
            }
            
            .tasks-list-header,
            .tasks-list-item {
                grid-template-columns: 40px 1fr 100px 60px;
            }
            
            .tasks-list-header > *:nth-child(n+5):not(:last-child),
            .tasks-list-item > *:nth-child(n+5):not(:last-child) {
                display: none;
            }
        }

        /* Quick Ops Panel */
        .quick-ops-panel {
            background: linear-gradient(135deg, var(--color-surface) 0%, var(--color-surface-elevated) 100%);
            border: 2px solid var(--color-primary);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            margin-bottom: var(--space-5);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.15);
        }

        .quick-ops-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-border);
        }

        .quick-ops-header h3 {
            margin: 0;
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
        }

        .quick-ops-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-3);
        }

        .quick-ops-card {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-ops-card:hover {
            border-color: var(--color-primary);
            background: var(--color-primary-bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .quick-ops-card:active {
            transform: translateY(0);
        }

        .quick-ops-icon {
            font-size: 2rem;
            margin-bottom: var(--space-2);
        }

        .quick-ops-label {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            color: var(--color-text);
            margin-bottom: var(--space-1);
        }

        .quick-ops-hint {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
        }

        /* Quick Ops Modal Styles */
        .quick-ops-modal-body {
            padding: var(--space-4);
        }

        .relief-site-select {
            margin-bottom: var(--space-4);
        }

        .relief-chain {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .relief-shift {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
        }

        .relief-shift.current {
            border-color: var(--color-success);
            background: var(--color-success-bg);
        }

        .relief-time {
            font-weight: var(--font-weight-semibold);
            min-width: 120px;
            font-family: var(--font-mono);
        }

        .relief-guard {
            flex: 1;
        }

        .relief-guards {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .relief-guard-item {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-1);
        }

        .relief-arrow {
            color: var(--color-text-muted);
        }

        .relief-relieved-by {
            color: var(--color-primary);
            font-weight: var(--font-weight-medium);
        }

        /* Available Guards List */
        .avail-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            max-height: 400px;
            overflow-y: auto;
        }

        .avail-entry {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: var(--space-3);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            gap: var(--space-3);
        }

        .avail-entry:hover {
            border-color: var(--color-primary);
        }

        .avail-guard-info {
            flex: 1;
        }

        .avail-guard-name {
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-1);
        }

        .avail-details {
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
        }

        .avail-days {
            display: flex;
            gap: var(--space-1);
            flex-wrap: wrap;
            margin-top: var(--space-1);
        }

        .avail-day-badge {
            font-size: var(--font-size-xs);
            padding: 2px 6px;
            background: var(--color-primary-bg);
            color: var(--color-primary);
            border-radius: var(--radius-sm);
        }

        .avail-shift-badge {
            font-size: var(--font-size-xs);
            padding: 2px 6px;
            background: var(--color-info-bg);
            color: var(--color-info);
            border-radius: var(--radius-sm);
        }

        .avail-actions {
            display: flex;
            gap: var(--space-2);
        }

        /* Site Quick View */
        .site-quick-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4);
            background: var(--color-surface-elevated);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
        }

        .site-quick-name {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
        }

        .site-quick-section {
            margin-bottom: var(--space-4);
        }

        .site-quick-section h4 {
            font-size: var(--font-size-sm);
            text-transform: uppercase;
            color: var(--color-text-muted);
            margin-bottom: var(--space-2);
            letter-spacing: 0.05em;
        }

        .site-contact-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-2) var(--space-3);
            background: var(--color-surface);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-1);
        }

        .site-contact-role {
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
        }

        .site-contact-name {
            font-weight: var(--font-weight-medium);
        }

        /* Quick Call-off */
        .calloff-candidates {
            margin-top: var(--space-4);
        }

        .calloff-candidate {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-2);
        }

        .calloff-candidate:hover {
            border-color: var(--color-success);
            background: var(--color-success-bg);
        }

        .calloff-candidate-info {
            flex: 1;
        }

        .calloff-candidate-name {
            font-weight: var(--font-weight-semibold);
        }

        .calloff-candidate-reason {
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
        }

        .calloff-fit-score {
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
        }

        .calloff-fit-score.excellent {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .calloff-fit-score.good {
            background: var(--color-info-bg);
            color: var(--color-info);
        }

        .calloff-fit-score.fair {
            background: var(--color-warning-bg);
            color: var(--color-warning);
        }

        .calloff-candidate-actions {
            margin-left: var(--space-3);
        }

        .ot-warning {
            color: var(--color-warning);
            font-weight: 600;
        }

        .hours-ok {
            color: var(--color-text-muted);
        }

        .reliability-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            margin-left: var(--space-2);
            font-weight: 500;
        }

        .reliability-badge.good {
            background: rgba(34, 197, 94, 0.15);
            color: var(--color-success);
        }

        .reliability-badge.fair {
            background: rgba(245, 158, 11, 0.15);
            color: var(--color-warning);
        }

        .reliability-badge.poor {
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-danger);
        }

        /* Day picker for availability */
        .day-picker {
            display: flex;
            gap: var(--space-2);
            flex-wrap: wrap;
            margin: var(--space-3) 0;
        }

        .day-picker-btn {
            width: 44px;
            height: 44px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-surface);
            cursor: pointer;
            font-weight: var(--font-weight-medium);
            transition: all 0.15s ease;
        }

        .day-picker-btn:hover {
            border-color: var(--color-primary);
        }

        .day-picker-btn.selected {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .shift-picker {
            display: flex;
            gap: var(--space-2);
            flex-wrap: wrap;
            margin: var(--space-3) 0;
        }

        .shift-picker-btn {
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-surface);
            cursor: pointer;
            font-size: var(--font-size-sm);
            transition: all 0.15s ease;
        }

        .shift-picker-btn:hover {
            border-color: var(--color-primary);
        }

        .shift-picker-btn.selected {
            background: var(--color-info);
            color: white;
            border-color: var(--color-info);
        }

        @media (max-width: 768px) {
            .quick-ops-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .quick-ops-card {
                padding: var(--space-3);
            }
            
            .quick-ops-icon {
                font-size: 1.5rem;
            }
        }

        /* Searchable Guard Input */
        .guard-search-container {
            position: relative;
            width: 100%;
        }

        .guard-search-input {
            width: 100%;
            padding: var(--space-3);
            padding-right: 40px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-bg);
            color: var(--color-text);
            font-size: var(--font-size-base);
        }

        .guard-search-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-primary-bg);
        }

        .guard-search-input::placeholder {
            color: var(--color-text-muted);
        }

        .guard-search-clear {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 4px;
            line-height: 1;
            display: none;
        }

        .guard-search-clear:hover {
            color: var(--color-text);
        }

        .guard-search-container.has-value .guard-search-clear {
            display: block;
        }

        .guard-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 250px;
            overflow-y: auto;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-top: none;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: none;
        }

        .guard-search-container.active .guard-search-results {
            display: block;
        }

        .guard-search-item {
            padding: var(--space-3);
            cursor: pointer;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .guard-search-item:last-child {
            border-bottom: none;
        }

        .guard-search-item:hover,
        .guard-search-item.highlighted {
            background: var(--color-primary-bg);
        }

        .guard-search-item-name {
            font-weight: var(--font-weight-medium);
        }

        .guard-search-item-role {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
            padding: 2px 6px;
            background: var(--color-surface-elevated);
            border-radius: var(--radius-sm);
        }

        .guard-search-empty {
            padding: var(--space-4);
            text-align: center;
            color: var(--color-text-muted);
        }

        .guard-search-match {
            background: var(--color-warning-bg);
            padding: 0 2px;
            border-radius: 2px;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .kpi-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            position: relative;
            overflow: hidden;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .kpi-card[onclick] {
            cursor: pointer;
        }

        /* Sparkline background */
        .kpi-sparkline {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            opacity: 0.15;
            pointer-events: none;
        }

        .kpi-sparkline svg {
            width: 100%;
            height: 100%;
        }

        .kpi-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }

        .kpi-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
            font-weight: var(--font-weight-medium);
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .kpi-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .kpi-icon.success {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .kpi-icon.warning {
            background: var(--color-warning-bg);
            color: var(--color-warning);
        }

        .kpi-icon.danger {
            background: var(--color-danger-bg);
            color: var(--color-danger);
        }

        .kpi-icon.info {
            background: var(--color-info-bg);
            color: var(--color-info);
        }

        .kpi-value {
            font-family: var(--font-family-display);
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text);
            line-height: 1;
            font-variant-numeric: tabular-nums;
        }

        .kpi-subtext {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .kpi-trend {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }

        .kpi-trend.up {
            color: var(--color-success);
        }

        .kpi-trend.down {
            color: var(--color-danger);
        }

        .kpi-trend.neutral {
            color: var(--color-text-muted);
        }

        .kpi-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: auto;
            padding-top: var(--space-2);
            border-top: 1px solid var(--color-border-subtle);
        }

        .kpi-footer-meta {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
        }

        .kpi-action {
            font-size: var(--font-size-xs);
            color: var(--color-primary);
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .kpi-card:hover .kpi-action {
            opacity: 1;
        }

        /* Status Lozenges - Enhanced Pill Badges */
        .lozenge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 100px;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .lozenge-success {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .lozenge-warning {
            background: var(--color-warning-bg);
            color: #92400e;
        }

        .lozenge-danger {
            background: var(--color-danger-bg);
            color: var(--color-danger);
        }

        .lozenge-info {
            background: var(--color-info-bg);
            color: var(--color-info);
        }

        .lozenge-neutral {
            background: var(--color-surface-hover);
            color: var(--color-text-secondary);
        }

        .lozenge-active {
            background: rgba(16, 185, 129, 0.15);
            color: #059669;
        }

        .lozenge-active::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse-dot 2s ease-in-out infinite;
        }

        .lozenge-success {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        /* Empty States - Fortune 500 Style */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-8) var(--space-4);
            text-align: center;
        }

        .empty-state-icon {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            background: var(--color-surface-elevated);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--space-4);
            color: var(--color-text-muted);
        }

        .empty-state-icon.success {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .empty-state-title {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            color: var(--color-text);
            margin-bottom: var(--space-1);
        }

        .empty-state-text {
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
            max-width: 280px;
        }

        .empty-state-action {
            margin-top: var(--space-4);
        }

        /* Data Freshness Indicator */
        .data-freshness {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
        }

        .data-freshness-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--color-success);
        }

        .data-freshness.stale .data-freshness-dot {
            background: var(--color-warning);
        }

        /* Card with Fortune 500 anatomy */
        .f500-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .f500-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4);
            border-bottom: 1px solid var(--color-border-subtle);
        }

        .f500-card-title {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .f500-card-actions {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .f500-card-body {
            flex: 1;
            overflow: auto;
        }

        .f500-card-footer {
            padding: var(--space-3) var(--space-4);
            border-top: 1px solid var(--color-border-subtle);
            background: var(--color-surface-elevated);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Quick Action Buttons */
        .quick-action {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: var(--radius-md);
            border: none;
            background: transparent;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .quick-action:hover {
            background: var(--color-surface-hover);
            color: var(--color-text);
        }

        .quick-action.danger:hover {
            background: var(--color-danger-bg);
            color: var(--color-danger);
        }

        .quick-action.success:hover {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        /* List Items with Actions */
        .list-item-actions {
            display: flex;
            gap: var(--space-1);
            opacity: 0;
            transition: opacity 0.15s;
        }

        .list-item:hover .list-item-actions {
            opacity: 1;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
            white-space: nowrap;
            height: 36px;
        }

        .btn-sm {
            height: 32px;
            padding: var(--space-1) var(--space-3);
            font-size: var(--font-size-sm);
        }

        .btn-lg {
            height: 44px;
            padding: var(--space-3) var(--space-6);
            font-size: var(--font-size-base);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover));
            color: var(--color-text-inverse);
            box-shadow: 0 2px 4px rgba(214, 158, 46, 0.2);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--color-accent), var(--color-primary));
            box-shadow: 0 4px 12px rgba(214, 158, 46, 0.3);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--color-surface-elevated);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: var(--color-border);
        }

        .btn-ghost {
            color: var(--color-text-secondary);
        }

        .btn-ghost:hover {
            background: var(--color-surface-elevated);
            color: var(--color-text);
        }

        /* Dropdown Menu */
        .dropdown-menu.show {
            display: block !important;
        }

        .dropdown-item:hover {
            background: var(--color-surface-hover) !important;
        }

        .btn-danger {
            background: var(--color-danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-icon {
            width: 36px;
            padding: 0;
        }

        .btn-icon.btn-sm {
            width: 32px;
        }

        /* Forms */
        .form-group {
            margin-bottom: var(--space-4);
        }

        .form-label {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text);
            margin-bottom: var(--space-2);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            height: 40px;
            padding: var(--space-2) var(--space-3);
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text);
            font-size: var(--font-size-base);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }

        .form-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' stroke='%2394a3b8' viewBox='0 0 24 24'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
            cursor: pointer;
        }

        .form-select option {
            background: var(--color-surface);
            color: var(--color-text);
            padding: var(--space-2);
        }

        .form-textarea {
            height: auto;
            min-height: 100px;
            resize: vertical;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        .form-input::placeholder,
        .form-textarea::placeholder {
            color: var(--color-text-muted);
        }

        /* Date/Time Input Picker Styling */
        .form-input[type="date"],
        .form-input[type="datetime-local"],
        .form-input[type="time"] {
            position: relative;
            cursor: pointer;
        }

        .form-input[type="date"]::-webkit-calendar-picker-indicator,
        .form-input[type="datetime-local"]::-webkit-calendar-picker-indicator,
        .form-input[type="time"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            padding: 4px;
            margin-right: -4px;
            border-radius: var(--radius-sm);
            background-color: var(--color-surface-elevated);
            filter: invert(0.7);
            transition: all var(--transition-fast);
        }

        .form-input[type="date"]::-webkit-calendar-picker-indicator:hover,
        .form-input[type="datetime-local"]::-webkit-calendar-picker-indicator:hover,
        .form-input[type="time"]::-webkit-calendar-picker-indicator:hover {
            background-color: var(--color-primary);
            filter: invert(1);
        }

        /* Firefox date picker fix */
        .form-input[type="date"],
        .form-input[type="datetime-local"],
        .form-input[type="time"] {
            color-scheme: dark;
        }

        [data-theme="light"] .form-input[type="date"],
        [data-theme="light"] .form-input[type="datetime-local"],
        [data-theme="light"] .form-input[type="time"] {
            color-scheme: light;
        }

        [data-theme="light"] .form-input[type="date"]::-webkit-calendar-picker-indicator,
        [data-theme="light"] .form-input[type="datetime-local"]::-webkit-calendar-picker-indicator,
        [data-theme="light"] .form-input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(0.3);
        }

        [data-theme="light"] .form-input[type="date"]::-webkit-calendar-picker-indicator:hover,
        [data-theme="light"] .form-input[type="datetime-local"]::-webkit-calendar-picker-indicator:hover,
        [data-theme="light"] .form-input[type="time"]::-webkit-calendar-picker-indicator:hover {
            filter: invert(1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
        }

        .form-hint {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
            margin-top: var(--space-1);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
        }

        .table th {
            background: var(--color-surface-elevated);
            padding: var(--space-3) var(--space-4);
            text-align: left;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-muted);
            text-transform: uppercase;
            font-size: var(--font-size-xs);
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--color-border);
            white-space: nowrap;
        }

        .table td {
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--color-border-subtle);
            color: var(--color-text);
        }

        .table tbody tr:hover {
            background: var(--color-surface-elevated);
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: 2px 8px;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            border-radius: var(--radius-full);
            white-space: nowrap;
        }

        .badge-success {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .badge-success::before {
            content: 'âœ“ ';
        }

        .badge-warning {
            background: var(--color-warning-bg);
            color: var(--color-warning);
        }

        .badge-warning::before {
            content: 'âš  ';
        }

        .badge-danger {
            background: var(--color-danger-bg);
            color: var(--color-danger);
        }

        .badge-danger::before {
            content: 'â— ';
        }

        .badge-info {
            background: var(--color-info-bg);
            color: var(--color-info);
        }

        .badge-neutral {
            background: var(--color-surface-elevated);
            color: var(--color-text-secondary);
        }

        .badge-secondary {
            background: var(--color-surface-elevated);
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
        }

        /* Status Dots */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: var(--radius-full);
            flex-shrink: 0;
        }

        .status-dot.active {
            background: var(--color-success);
        }

        .status-dot.warning {
            background: var(--color-warning);
        }

        .status-dot.danger {
            background: var(--color-danger);
        }

        .status-dot.neutral {
            background: var(--color-text-muted);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: var(--space-1);
            border-bottom: 1px solid var(--color-border);
            margin-bottom: var(--space-5);
        }

        .tab {
            padding: var(--space-3) var(--space-4);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-muted);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all var(--transition-fast);
        }

        .tab:hover {
            color: var(--color-text);
        }

        .tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: var(--z-modal-backdrop);
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
        }

        .modal-backdrop.active {
            display: flex;
        }

        .modal {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 560px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: modalIn var(--transition-base);
        }

        .modal-lg {
            max-width: 800px;
        }

        .modal-xl {
            max-width: 1000px;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            padding: var(--space-5);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--color-surface-elevated);
            color: var(--color-text);
        }

        .modal-body {
            padding: var(--space-5);
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: var(--space-4) var(--space-5);
            border-top: 1px solid var(--color-border);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-3);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: var(--space-4);
            right: var(--space-4);
            z-index: var(--z-toast);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        /* Scroll to Top Button */
        .scroll-top-btn {
            position: fixed;
            bottom: var(--space-6);
            right: var(--space-6);
            width: 44px;
            height: 44px;
            border-radius: var(--radius-full);
            background: var(--color-primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 99;
        }

        .scroll-top-btn.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .scroll-top-btn:hover {
            background: var(--color-primary-hover);
            transform: translateY(-2px);
        }

        .scroll-top-btn:active {
            transform: translateY(0);
        }

        .toast {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            min-width: 300px;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            animation: toastIn var(--transition-base);
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            color: var(--color-success);
        }

        .toast.error .toast-icon {
            color: var(--color-danger);
        }

        .toast.warning .toast-icon {
            color: var(--color-warning);
        }

        .toast.info .toast-icon {
            color: var(--color-info);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
            margin-bottom: var(--space-1);
        }

        .toast-message {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .toast-close {
            width: 20px;
            height: 20px;
            color: var(--color-text-muted);
            flex-shrink: 0;
        }

        .toast-close:hover {
            color: var(--color-text);
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: var(--space-12) var(--space-6);
            color: var(--color-text-muted);
        }

        .empty-state-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto var(--space-4);
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-2);
        }

        .empty-state-text {
            font-size: var(--font-size-sm);
            max-width: 360px;
            margin: 0 auto var(--space-4);
        }

        /* CSV Import Drop Zone */
        .csv-drop-zone {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-8) var(--space-6);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-base);
            background: var(--color-bg);
        }

        .csv-drop-zone:hover {
            border-color: var(--color-primary);
            background: var(--color-info-bg);
        }

        .csv-drop-zone.drag-over {
            border-color: var(--color-primary);
            background: var(--color-info-bg);
            transform: scale(1.01);
        }

        .csv-drop-zone.processing {
            pointer-events: none;
            opacity: 0.7;
        }

        .csv-preview-table {
            width: 100%;
            font-size: var(--font-size-sm);
            border-collapse: collapse;
        }

        .csv-preview-table th,
        .csv-preview-table td {
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--color-border);
            text-align: left;
        }

        .csv-preview-table th {
            background: var(--color-surface-elevated);
            font-weight: var(--font-weight-semibold);
        }

        .csv-preview-table tr:nth-child(even) {
            background: var(--color-bg);
        }

        .csv-import-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .csv-import-stat {
            background: var(--color-bg);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            text-align: center;
        }

        .csv-import-stat-value {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text);
        }

        .csv-import-stat-label {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .field-mapping-row {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-2) 0;
            border-bottom: 1px solid var(--color-border-subtle);
        }

        .field-mapping-source {
            flex: 1;
            font-family: var(--font-family-mono);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .field-mapping-arrow {
            color: var(--color-text-muted);
        }

        .field-mapping-target {
            flex: 1;
            font-weight: var(--font-weight-medium);
        }

        .field-mapping-target.mapped {
            color: var(--color-success);
        }

        .field-mapping-target.unmapped {
            color: var(--color-text-muted);
            font-style: italic;
        }

        /* Search Bar */
        .search-bar {
            position: relative;
            max-width: 320px;
        }

        .search-bar-icon {
            position: absolute;
            left: var(--space-3);
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            color: var(--color-text-muted);
            pointer-events: none;
        }

        .search-bar .form-input {
            padding-left: 40px;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-4);
            margin-bottom: var(--space-5);
            flex-wrap: wrap;
        }

        .toolbar-left,
        .toolbar-right {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            flex-wrap: wrap;
        }

        /* Bulk Action Bar */
        .bulk-action-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3) var(--space-4);
            background: var(--color-info-bg);
            border: 1px solid var(--color-info);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 0.75s linear infinite;
            vertical-align: middle;
            margin-right: var(--space-2);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .bulk-count {
            font-weight: var(--font-weight-semibold);
            color: var(--color-info);
        }

        /* Row selection checkbox */
        .row-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--color-primary);
        }

        .table tr.selected {
            background: var(--color-info-bg);
        }

        /* Filter Dropdown */
        .filter-dropdown {
            position: relative;
        }

        .filter-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: var(--space-2);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            padding: var(--space-2);
            z-index: var(--z-dropdown);
            display: none;
        }

        .filter-dropdown.active .filter-dropdown-menu {
            display: block;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            color: var(--color-text);
            width: 100%;
            text-align: left;
        }

        .filter-option:hover {
            background: var(--color-surface-elevated);
        }

        /* Week Navigation */
        .week-nav {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .week-nav-label {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
            min-width: 180px;
            text-align: center;
        }

        /* Scheduler Grid */
        .scheduler-wrapper {
            max-height: 70vh;
            overflow: auto;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
        }
        
        .scheduler-grid {
            display: grid;
            grid-template-columns: 180px repeat(7, 1fr);
            min-width: 900px;
        }

        .scheduler-header-cell {
            background: var(--color-surface-elevated);
            padding: var(--space-3);
            text-align: center;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--color-border);
            position: sticky;
            top: 0;
            z-index: 2;
        }
        
        .scheduler-header-cell:first-child {
            position: sticky;
            left: 0;
            z-index: 3;
        }

        .scheduler-header-cell:not(:last-child) {
            border-right: 1px solid var(--color-border);
        }

        .scheduler-site-cell {
            background: var(--color-surface);
            padding: var(--space-3);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text);
            border-bottom: 1px solid var(--color-border);
            border-right: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            min-height: 80px;
            position: sticky;
            left: 0;
            z-index: 1;
        }

        .scheduler-shift-cell {
            background: var(--color-surface);
            padding: var(--space-2);
            border-bottom: 1px solid var(--color-border);
            border-right: 1px solid var(--color-border);
            min-height: 80px;
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .scheduler-shift-cell:hover {
            background: var(--color-surface-hover);
        }

        .empty-cell-prompt {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 60px;
            color: var(--color-text-muted);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }

        .scheduler-shift-cell:hover .empty-cell-prompt {
            opacity: 0.5;
        }

        .scheduler-shift-cell:hover .empty-cell-prompt:hover {
            opacity: 1;
        }

        .scheduler-shift-cell:last-child {
            border-right: none;
        }

        .scheduler-grid>div:nth-last-child(-n+8) {
            border-bottom: none;
        }

        .shift-card {
            background: var(--color-surface-elevated);
            border-radius: var(--radius-md);
            padding: var(--space-2);
            font-size: var(--font-size-xs);
            margin-bottom: var(--space-1);
            cursor: pointer;
            transition: all var(--transition-fast);
            border-left: 3px solid transparent;
        }

        .shift-card:hover {
            background: var(--color-border);
        }

        .shift-card.assigned {
            border-left-color: var(--color-success);
        }

        .shift-card.confirmed {
            border-left-color: var(--color-warning);
        }

        .shift-card.open {
            border-left-color: var(--color-danger);
            background: var(--color-danger-bg);
        }

        .shift-time {
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
            margin-bottom: 2px;
        }

        .shift-guard {
            color: var(--color-text-secondary);
        }

        .shift-guard.open {
            color: var(--color-danger);
            font-weight: var(--font-weight-medium);
        }

        /* Multi-guard shifts */
        .shift-guard.multi-guard {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .multi-guard-entry {
            font-size: var(--font-size-xs);
            line-height: 1.3;
            padding: 1px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .multi-guard-entry.open {
            color: var(--color-danger);
            font-weight: var(--font-weight-medium);
        }

        /* Make shift cards taller for multi-guard */
        .shift-card:has(.multi-guard) {
            min-height: auto;
        }

        /* Signature Canvas */
        .signature-pad {
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-bg);
            cursor: crosshair;
            touch-action: none;
        }

        .signature-actions {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-2);
        }

        /* Checklist */
        .checklist-category {
            margin-bottom: var(--space-5);
        }

        .checklist-category-title {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-2);
            border-bottom: 1px solid var(--color-border);
        }

        .checklist-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            padding: var(--space-2) 0;
        }

        .checklist-item-label {
            flex: 1;
            font-size: var(--font-size-sm);
            color: var(--color-text);
        }

        .checklist-options {
            display: flex;
            gap: var(--space-2);
        }

        .checklist-option {
            padding: var(--space-1) var(--space-2);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            border-radius: var(--radius-sm);
            border: 1px solid var(--color-border);
            color: var(--color-text-muted);
            background: transparent;
            transition: all var(--transition-fast);
        }

        .checklist-option:hover {
            background: var(--color-surface-elevated);
        }

        .checklist-option.selected {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }

        .checklist-option.selected-yes {
            background: var(--color-success);
            border-color: var(--color-success);
        }

        .checklist-option.selected-no {
            background: var(--color-danger);
            border-color: var(--color-danger);
        }

        /* Charts placeholder */
        .chart-container {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-surface-elevated);
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
        }

        .chart-canvas {
            width: 100%;
            height: 100%;
        }

        /* Utility Classes */
        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: var(--space-2);
        }

        .gap-3 {
            gap: var(--space-3);
        }

        .gap-4 {
            gap: var(--space-4);
        }

        .mt-2 {
            margin-top: var(--space-2);
        }

        .mt-4 {
            margin-top: var(--space-4);
        }

        .mb-2 {
            margin-bottom: var(--space-2);
        }

        .mb-4 {
            margin-bottom: var(--space-4);
        }

        .mb-6 {
            margin-bottom: var(--space-6);
        }

        .text-sm {
            font-size: var(--font-size-sm);
        }

        .text-muted {
            color: var(--color-text-muted);
        }

        .text-right {
            text-align: right;
        }

        .font-medium {
            font-weight: var(--font-weight-medium);
        }

        .font-semibold {
            font-weight: var(--font-weight-semibold);
        }

        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MOBILE RESPONSIVE STYLES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media (max-width: 1024px) {
            .scheduler-grid {
                display: block;
                overflow-x: auto;
            }
        }

        @media (max-width: 768px) {

            /* Mobile styles - no sidebar to handle */
            .header-brand-title {
                display: none;
            }

            .main-body {
                padding: var(--space-4);
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar-left,
            .toolbar-right {
                justify-content: space-between;
            }

            .search-bar {
                max-width: none;
                width: 100%;
            }

            /* Table to cards on mobile */
            .table-mobile-cards thead {
                display: none;
            }

            .table-mobile-cards tbody tr {
                display: block;
                background: var(--color-surface);
                border: 1px solid var(--color-border);
                border-radius: var(--radius-lg);
                margin-bottom: var(--space-3);
                padding: var(--space-4);
            }

            .table-mobile-cards tbody tr:hover {
                background: var(--color-surface);
            }

            .table-mobile-cards tbody td {
                display: flex;
                justify-content: space-between;
                padding: var(--space-2) 0;
                border-bottom: 1px solid var(--color-border-subtle);
            }

            .table-mobile-cards tbody td:last-child {
                border-bottom: none;
            }

            .table-mobile-cards tbody td::before {
                content: attr(data-label);
                font-weight: var(--font-weight-semibold);
                color: var(--color-text-muted);
                font-size: var(--font-size-xs);
                text-transform: uppercase;
            }

            .modal {
                margin: var(--space-4);
                max-height: calc(100vh - 32px);
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Print Styles */
        @media print {

            .main-header,
            .btn,
            .toolbar,
            .toast-container,
            .quick-ops-panel,
            #schedule-stats,
            .mobile-nav,
            .page-header,
            .empty-cell-prompt,
            #command-center,
            #ops-pulse,
            .no-print {
                display: none !important;
            }

            .main-content {
                margin-left: 0;
            }

            .main-body {
                padding: 0;
                max-width: none;
            }

            .card {
                border: 1px solid #ccc;
                break-inside: avoid;
            }

            body {
                background: white;
                color: black;
                font-size: 10pt;
            }
            
            /* Schedule Print Styles - High Specificity */
            .scheduler-container,
            #section-scheduler .scheduler-container {
                overflow: visible !important;
            }
            
            .scheduler-wrapper,
            #section-scheduler .scheduler-wrapper {
                max-height: none !important;
                overflow: visible !important;
                border: none !important;
            }
            
            .scheduler-grid,
            #section-scheduler .scheduler-grid,
            #scheduler-grid {
                display: grid !important;
                grid-template-columns: 100px repeat(7, 1fr) !important;
                min-width: auto !important;
                width: 100% !important;
                font-size: 8pt !important;
                border: 1px solid #333 !important;
            }
            
            .scheduler-header-cell {
                background: #f0f0f0 !important;
                color: #000 !important;
                padding: 4px !important;
                font-size: 8pt !important;
                border: 1px solid #ccc !important;
                position: static !important;
            }
            
            .scheduler-site-cell {
                background: #fafafa !important;
                color: #000 !important;
                padding: 4px !important;
                font-size: 8pt !important;
                border: 1px solid #ccc !important;
                position: static !important;
                min-height: auto !important;
            }
            
            .scheduler-shift-cell {
                background: #fff !important;
                padding: 2px !important;
                border: 1px solid #ccc !important;
                min-height: auto !important;
                page-break-inside: avoid;
            }
            
            .shift-card {
                background: #fff !important;
                border: 1px solid #999 !important;
                border-left: 3px solid #333 !important;
                padding: 2px 4px !important;
                margin: 1px 0 !important;
                font-size: 7pt !important;
                page-break-inside: avoid;
            }
            
            .shift-card.open {
                border-left-color: #c00 !important;
                background: #fff0f0 !important;
            }
            
            .shift-card.assigned {
                border-left-color: #00c !important;
            }
            
            .shift-card.confirmed {
                border-left-color: #0a0 !important;
            }
            
            .shift-time {
                font-weight: bold !important;
                color: #000 !important;
            }
            
            .shift-guard {
                color: #333 !important;
            }
            
            /* Print Header */
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 10px;
                padding-bottom: 10px;
                border-bottom: 2px solid #333;
            }
            
            .print-header h2 {
                margin: 0;
                font-size: 14pt;
            }
            
            .print-header .print-meta {
                font-size: 9pt;
                color: #666;
            }
            
            /* Legend for print */
            .print-legend {
                display: flex !important;
                gap: 20px;
                font-size: 8pt;
                margin-top: 10px;
                padding-top: 10px;
                border-top: 1px solid #ccc;
            }
            
            .print-legend span {
                display: flex;
                align-items: center;
                gap: 4px;
            }
            
            .print-legend .legend-box {
                width: 12px;
                height: 12px;
                border: 1px solid #999;
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           AVAILABILITY MODULE STYLES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .availability-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: var(--space-3);
        }

        .availability-day {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .availability-day.today {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 1px var(--color-primary);
        }

        .availability-day.past {
            opacity: 0.6;
        }

        .availability-day-header {
            background: var(--color-surface-elevated);
            padding: var(--space-3);
            text-align: center;
            border-bottom: 1px solid var(--color-border);
        }

        .availability-day-header .day-name {
            display: block;
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
        }

        .availability-day-header .day-date {
            display: block;
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
        }

        .availability-day-body {
            padding: var(--space-3);
        }

        .shift-checkboxes {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--font-size-xs);
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: var(--color-primary);
        }

        /* Month Calendar Styles */
        .month-calendar {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .month-calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--color-surface-elevated);
            border-bottom: 1px solid var(--color-border);
        }

        .month-calendar-header-cell {
            padding: var(--space-3);
            text-align: center;
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .month-calendar-body {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .month-calendar-day {
            min-height: 100px;
            padding: var(--space-2);
            border-right: 1px solid var(--color-border);
            border-bottom: 1px solid var(--color-border);
            background: var(--color-surface);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .month-calendar-day:nth-child(7n) {
            border-right: none;
        }

        .month-calendar-day:hover {
            background: var(--color-surface-elevated);
        }

        .month-calendar-day.other-month {
            background: var(--color-bg);
            opacity: 0.5;
        }

        .month-calendar-day.today {
            background: var(--color-info-bg);
        }

        .month-calendar-day.selected {
            background: var(--color-primary);
            color: white;
        }

        .month-calendar-day-number {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-2);
        }

        .month-calendar-day.today .month-calendar-day-number {
            background: var(--color-primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .month-calendar-day-content {
            font-size: var(--font-size-xs);
        }

        .avail-count {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            margin-bottom: var(--space-1);
        }

        .avail-count.available {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .avail-count.partial {
            background: var(--color-warning-bg);
            color: var(--color-warning);
        }

        .avail-count.unavailable {
            background: var(--color-danger-bg);
            color: var(--color-danger);
        }

        /* Find Available Modal */
        .find-avail-results {
            max-height: 400px;
            overflow-y: auto;
        }

        .find-avail-guard {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3);
            border-bottom: 1px solid var(--color-border);
        }

        .find-avail-guard:last-child {
            border-bottom: none;
        }

        .find-avail-guard-info {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .find-avail-guard-avatar {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            background: var(--color-primary-bg);
            color: var(--color-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
        }

        .find-avail-guard-name {
            font-weight: var(--font-weight-medium);
        }

        .find-avail-guard-sites {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
        }

        .find-avail-guard-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        /* Coverage Suggestion Engine Styles - v6.19.4 */
        .coverage-suggestion {
            transition: background-color 0.15s ease;
        }

        .coverage-suggestion:hover {
            background: var(--color-surface-elevated) !important;
        }

        .coverage-score {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            font-weight: var(--font-weight-bold);
        }

        .coverage-score.excellent {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .coverage-score.good {
            background: var(--color-info-bg);
            color: var(--color-info);
        }

        .coverage-score.fair {
            background: var(--color-warning-bg);
            color: var(--color-warning);
        }

        .coverage-score.poor {
            background: var(--color-surface);
            color: var(--color-text-muted);
        }

        /* Fatigue Management Styles */
        .fatigue-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        .fatigue-indicator.green {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .fatigue-indicator.yellow {
            background: var(--color-warning-bg);
            color: var(--color-warning);
        }

        .fatigue-indicator.red {
            background: var(--color-danger-bg);
            color: var(--color-danger);
        }

        .fatigue-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-3);
        }

        .fatigue-card.warning {
            border-left: 4px solid var(--color-warning);
        }

        .fatigue-card.critical {
            border-left: 4px solid var(--color-danger);
        }

        .fatigue-metric {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-2) 0;
        }

        .fatigue-metric-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .fatigue-metric-icon.warning {
            background: var(--color-warning-bg);
        }

        .fatigue-metric-icon.danger {
            background: var(--color-danger-bg);
        }

        .fatigue-metric-value {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
        }

        .fatigue-metric-label {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
        }

        .fatigue-guard-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3);
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .fatigue-guard-row:hover {
            background: var(--color-surface-elevated);
        }

        .fatigue-guard-row:last-child {
            border-bottom: none;
        }

        /* Document Vault Styles */
        .doc-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            display: flex;
            gap: var(--space-4);
            margin-bottom: var(--space-3);
            transition: all var(--transition-fast);
        }

        .doc-card:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-md);
        }

        .doc-card.expired {
            border-left: 4px solid var(--color-danger);
            opacity: 0.8;
        }

        .doc-card.expiring {
            border-left: 4px solid var(--color-warning);
        }

        .doc-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            background: var(--color-surface-elevated);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .doc-icon.contract { background: var(--color-info-bg); }
        .doc-icon.insurance { background: var(--color-success-bg); }
        .doc-icon.license { background: var(--color-warning-bg); }
        .doc-icon.site_map { background: var(--color-info-bg); }
        .doc-icon.post_orders { background: var(--color-danger-bg); }
        .doc-icon.emergency { background: var(--color-danger-bg); }
        .doc-icon.training { background: var(--color-success-bg); }

        .doc-info {
            flex: 1;
            min-width: 0;
        }

        .doc-title {
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-1);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .doc-title a {
            color: var(--color-text);
            text-decoration: none;
        }

        .doc-title a:hover {
            color: var(--color-primary);
        }

        .doc-meta {
            display: flex;
            gap: var(--space-4);
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
            flex-wrap: wrap;
        }

        .doc-meta-item {
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        .doc-expiry {
            font-weight: var(--font-weight-medium);
        }

        .doc-expiry.danger {
            color: var(--color-danger);
        }

        .doc-expiry.warning {
            color: var(--color-warning);
        }

        .doc-expiry.success {
            color: var(--color-success);
        }

        .doc-actions {
            display: flex;
            gap: var(--space-2);
            flex-shrink: 0;
        }

        .doc-upload-zone {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-8);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .doc-upload-zone:hover {
            border-color: var(--color-primary);
            background: var(--color-info-bg);
        }

        .doc-upload-zone.dragover {
            border-color: var(--color-primary);
            background: var(--color-info-bg);
        }

        .doc-category-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            background: var(--color-surface-elevated);
        }

        /* Guard Performance Styles */
        .perf-scorecard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-4);
        }

        .perf-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .perf-card:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-md);
        }

        .perf-card.high-risk {
            border-left: 4px solid var(--color-danger);
        }

        .perf-card.watch {
            border-left: 4px solid var(--color-warning);
        }

        .perf-card.good {
            border-left: 4px solid var(--color-success);
        }

        .perf-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-3);
        }

        .perf-card-name {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-base);
        }

        .perf-card-role {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
        }

        .perf-score {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-lg);
        }

        .perf-score.excellent { background: var(--color-success-bg); color: var(--color-success); }
        .perf-score.good { background: var(--color-info-bg); color: var(--color-info); }
        .perf-score.fair { background: var(--color-warning-bg); color: var(--color-warning); }
        .perf-score.poor { background: var(--color-danger-bg); color: var(--color-danger); }

        .perf-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-2);
            margin-top: var(--space-3);
        }

        .perf-metric {
            text-align: center;
            padding: var(--space-2);
            background: var(--color-surface-elevated);
            border-radius: var(--radius-sm);
        }

        .perf-metric-value {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-base);
        }

        .perf-metric-value.negative { color: var(--color-danger); }
        .perf-metric-value.positive { color: var(--color-success); }
        .perf-metric-value.neutral { color: var(--color-text-muted); }

        .perf-metric-label {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
        }

        .perf-flags {
            display: flex;
            gap: var(--space-2);
            flex-wrap: wrap;
            margin-top: var(--space-3);
        }

        .perf-flag {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: 2px var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        .perf-flag.risk { background: var(--color-danger-bg); color: var(--color-danger); }
        .perf-flag.warning { background: var(--color-warning-bg); color: var(--color-warning); }
        .perf-flag.positive { background: var(--color-success-bg); color: var(--color-success); }

        .perf-timeline {
            margin-top: var(--space-4);
        }

        .perf-timeline-item {
            display: flex;
            gap: var(--space-3);
            padding: var(--space-3) 0;
            border-bottom: 1px solid var(--color-border);
        }

        .perf-timeline-item:last-child {
            border-bottom: none;
        }

        .perf-timeline-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.9rem;
        }

        .perf-timeline-icon.incident { background: var(--color-warning-bg); }
        .perf-timeline-icon.calloff { background: var(--color-danger-bg); }
        .perf-timeline-icon.discipline { background: var(--color-info-bg); }
        .perf-timeline-icon.commendation { background: var(--color-success-bg); }

        .perf-timeline-content {
            flex: 1;
            min-width: 0;
        }

        .perf-timeline-title {
            font-weight: var(--font-weight-medium);
        }

        .perf-timeline-detail {
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
        }

        .perf-timeline-date {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
            flex-shrink: 0;
        }

        .perf-link {
            color: var(--color-primary);
            cursor: pointer;
            text-decoration: none;
        }

        .perf-link:hover {
            text-decoration: underline;
        }

        /* Overtime Tracker Styles */
        .ot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--space-3);
        }

        .ot-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
        }

        .ot-card.warning {
            border-left: 4px solid var(--color-warning);
            background: var(--color-warning-bg);
        }

        .ot-card.danger {
            border-left: 4px solid var(--color-danger);
            background: var(--color-danger-bg);
        }

        .ot-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-3);
        }

        .ot-name {
            font-weight: var(--font-weight-semibold);
        }

        .ot-site {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
        }

        .ot-hours {
            text-align: right;
        }

        .ot-hours-value {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
        }

        .ot-hours-label {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
        }

        .ot-bar {
            height: 8px;
            background: var(--color-surface-elevated);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-top: var(--space-2);
        }

        .ot-bar-fill {
            height: 100%;
            border-radius: var(--radius-full);
            transition: width var(--transition-base);
        }

        .ot-bar-fill.safe { background: var(--color-success); }
        .ot-bar-fill.warning { background: var(--color-warning); }
        .ot-bar-fill.danger { background: var(--color-danger); }

        /* Replacement Wizard Styles */
        .replacement-wizard {
            max-height: 400px;
            overflow-y: auto;
        }

        .replacement-option {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-2);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .replacement-option:hover {
            border-color: var(--color-primary);
            background: var(--color-surface);
        }

        .replacement-option.selected {
            border-color: var(--color-primary);
            background: var(--color-primary-bg);
        }

        .replacement-option.ot-warning {
            border-left: 3px solid var(--color-warning);
        }

        .replacement-option.ot-danger {
            border-left: 3px solid var(--color-danger);
        }

        .replacement-score {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-sm);
            flex-shrink: 0;
        }

        .replacement-score.excellent { background: var(--color-success-bg); color: var(--color-success); }
        .replacement-score.good { background: var(--color-info-bg); color: var(--color-info); }
        .replacement-score.fair { background: var(--color-warning-bg); color: var(--color-warning); }

        .replacement-info {
            flex: 1;
            min-width: 0;
        }

        .replacement-name {
            font-weight: var(--font-weight-medium);
        }

        .replacement-meta {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
            display: flex;
            gap: var(--space-3);
            flex-wrap: wrap;
        }

        .replacement-tags {
            display: flex;
            gap: var(--space-1);
            flex-wrap: wrap;
        }

        .replacement-tag {
            font-size: 10px;
            padding: 1px 6px;
            border-radius: var(--radius-sm);
            background: var(--color-surface);
            color: var(--color-text-muted);
        }

        .replacement-tag.positive { background: var(--color-success-bg); color: var(--color-success); }
        .replacement-tag.warning { background: var(--color-warning-bg); color: var(--color-warning); }
        .replacement-tag.danger { background: var(--color-danger-bg); color: var(--color-danger); }

        /* SOP Library & Version History Styles */
        .version-history {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
        }

        .version-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            padding: var(--space-3);
            border-bottom: 1px solid var(--color-border);
        }

        .version-item:last-child {
            border-bottom: none;
        }

        .version-item.current {
            background: var(--color-success-bg);
        }

        .version-item.superseded {
            opacity: 0.7;
        }

        .version-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 48px;
            padding: var(--space-1) var(--space-2);
            background: var(--color-surface-elevated);
            border-radius: var(--radius-sm);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
        }

        .version-badge.current {
            background: var(--color-success);
            color: white;
        }

        .version-info {
            flex: 1;
            min-width: 0;
        }

        .version-dates {
            display: flex;
            gap: var(--space-4);
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
            margin-top: var(--space-1);
        }

        .version-link {
            color: var(--color-primary);
            text-decoration: none;
            cursor: pointer;
        }

        .version-link:hover {
            text-decoration: underline;
        }

        .sop-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: var(--color-warning-bg);
            color: var(--color-warning);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        .doc-card-tags {
            display: flex;
            gap: var(--space-2);
            flex-wrap: wrap;
            margin-top: var(--space-2);
        }

        /* Client Portal Styles */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: var(--space-4);
        }

        .stat-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            text-align: center;
        }

        .stat-card .stat-value {
            font-family: var(--font-family-display);
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text);
            line-height: 1.2;
        }

        .stat-card .stat-label {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: var(--space-2);
        }

        .portal-tab {
            border-radius: 0;
            border-bottom: 2px solid transparent;
            padding: var(--space-2) var(--space-4);
        }

        .portal-tab.active {
            border-bottom-color: var(--color-primary);
            color: var(--color-primary);
            background: transparent;
        }

        .portal-tab:hover:not(.active) {
            background: var(--color-surface-elevated);
        }

        #portal-dashboard .stat-card-danger {
            border-color: var(--color-danger);
        }

        #portal-dashboard .stat-card-danger .stat-value {
            color: var(--color-danger);
        }

        /* Portal Mode - Hide admin elements when client portal is active */
        body.portal-mode .sidebar {
            display: none !important;
        }

        body.portal-mode .main-content {
            margin-left: 0 !important;
        }

        body.portal-mode #ai-console-toggle-btn {
            display: none !important;
        }

        body.portal-mode .header-actions [id="settings-btn"],
        body.portal-mode .header-actions [id="help-btn"] {
            display: none !important;
        }

        body.portal-mode .header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
        }

        body.portal-mode .header-title::before {
            content: "ğŸ¢ ";
        }

        /* Portal Mode: Hide create/edit/delete/export actions in all sections */
        body.portal-mode .action-new,
        body.portal-mode .action-edit,
        body.portal-mode .action-delete,
        body.portal-mode .action-export,
        body.portal-mode [data-action="new"],
        body.portal-mode [data-action="edit"],
        body.portal-mode [data-action="delete"],
        body.portal-mode [data-action="export"] {
            display: none !important;
        }

        /* Portal Mode: Hide home button to prevent dashboard access */
        body.portal-mode #home-btn {
            display: none !important;
        }

        /* Portal Mode: Add read-only badge styling */
        .portal-readonly-badge {
            background: var(--color-warning);
            color: var(--color-warning-dark);
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .fatigue-guard-info {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .fatigue-guard-avatar {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            background: var(--color-surface-elevated);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
        }

        .fatigue-guard-details {
            display: flex;
            flex-direction: column;
        }

        .fatigue-guard-name {
            font-weight: var(--font-weight-medium);
        }

        .fatigue-guard-flags {
            display: flex;
            gap: var(--space-2);
            flex-wrap: wrap;
        }

        .fatigue-flag {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: 2px var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
        }

        .fatigue-flag.consecutive {
            background: var(--color-warning-bg);
            color: var(--color-warning);
        }

        .fatigue-flag.overtime {
            background: var(--color-danger-bg);
            color: var(--color-danger);
        }

        .fatigue-flag.no-rest {
            background: var(--color-danger-bg);
            color: var(--color-danger);
        }

        .fatigue-flag.back-to-back {
            background: var(--color-warning-bg);
            color: var(--color-warning);
        }

        .conflict-warning {
            background: var(--color-warning-bg);
            border: 1px solid var(--color-warning);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
        }

        .conflict-warning svg {
            flex-shrink: 0;
            color: var(--color-warning);
        }

        .conflict-warning-text {
            font-size: var(--font-size-sm);
        }

        @media (max-width: 1024px) {
            .availability-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 640px) {
            .availability-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           AI COMMAND CONSOLE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .ai-console-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(3px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .ai-console-overlay[hidden] {
            display: none;
        }

        .ai-console-panel {
            width: min(520px, 100vw - 32px);
            height: min(80vh, 680px);
            background: #0f172a;
            color: #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 24px 60px rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            padding: 16px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            box-sizing: border-box;
        }

        .ai-console-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .ai-console-title {
            font-size: 16px;
            font-weight: 600;
        }

        .ai-console-subtitle {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 2px;
        }

        .ai-console-close-btn {
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
        }

        .ai-console-close-btn:hover {
            color: #e5e7eb;
        }

        .ai-console-context-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 11px;
            color: #9ca3af;
            border-radius: 6px;
            padding: 6px 10px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(55, 65, 81, 0.8);
            margin-bottom: 10px;
        }

        .ai-console-context-bar span {
            white-space: nowrap;
        }

        .ai-console-shortcuts {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .ai-console-chip {
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            background: rgba(15, 23, 42, 0.9);
            font-size: 11px;
            padding: 5px 12px;
            color: #e5e7eb;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .ai-console-chip:hover {
            background: rgba(30, 64, 175, 0.8);
            border-color: rgba(59, 130, 246, 0.9);
        }

        .ai-console-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
        }

        .ai-console-tab {
            flex: 0 0 auto;
            border-radius: 999px;
            border: 1px solid transparent;
            background: transparent;
            font-size: 11px;
            color: #9ca3af;
            padding: 5px 12px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .ai-console-tab:hover {
            color: #e5e7eb;
        }

        .ai-console-tab-active {
            background: rgba(30, 64, 175, 0.9);
            color: #e5e7eb;
            border-color: rgba(59, 130, 246, 0.8);
        }

        .ai-console-body {
            flex: 1;
            min-height: 0;
            border-radius: 8px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(31, 41, 55, 0.9);
            padding: 10px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .ai-console-output {
            height: 100%;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.6;
        }

        .ai-console-output-block {
            padding: 8px 0;
            border-bottom: 1px dashed rgba(55, 65, 81, 0.7);
        }

        .ai-console-output-block:last-child {
            border-bottom: none;
        }

        .ai-console-output-label {
            font-size: 11px;
            color: #60a5fa;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .ai-console-output-text {
            white-space: pre-wrap;
            color: #e5e7eb;
        }

        .ai-console-input-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 6px;
        }

        .ai-console-input {
            flex: 1;
            border-radius: 999px;
            border: 1px solid rgba(55, 65, 81, 0.9);
            background: #020617;
            color: #e5e7eb;
            padding: 8px 14px;
            font-size: 13px;
        }

        .ai-console-input::placeholder {
            color: #6b7280;
        }

        .ai-console-input:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.9);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        .ai-console-send-btn {
            border-radius: 999px;
            border: 1px solid rgba(59, 130, 246, 0.9);
            background: rgba(30, 64, 175, 0.95);
            color: #e5e7eb;
            font-size: 12px;
            font-weight: 500;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .ai-console-send-btn:hover {
            background: rgba(37, 99, 235, 0.95);
        }

        .ai-console-hints {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 10px;
            color: #6b7280;
        }

        .ai-console-hints span {
            padding: 2px 6px;
            background: rgba(31, 41, 55, 0.5);
            border-radius: 4px;
        }

        @media (max-width: 480px) {
            .ai-console-panel {
                width: calc(100vw - 24px);
                height: calc(100vh - 80px);
                padding: 12px;
            }

            .ai-console-hints {
                display: none;
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           COMMAND PALETTE STYLES â€” v4.7
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        /* Backdrop with blur */
        .command-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 12vh;
            z-index: var(--z-modal);
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-base), visibility var(--transition-base);
        }

        .command-backdrop.active {
            opacity: 1;
            visibility: visible;
        }

        /* Main command box */
        .command-box {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 600px;
            overflow: hidden;
            box-shadow: var(--shadow-xl), 0 0 0 1px rgba(255, 255, 255, 0.05);
            transform: scale(0.96) translateY(-20px);
            opacity: 0;
            transition: transform var(--transition-base), opacity var(--transition-base);
        }

        .command-backdrop.active .command-box {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        /* Input area */
        .command-input-wrap {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4);
            border-bottom: 1px solid var(--color-border);
        }

        .command-input-icon {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            color: var(--color-text-muted);
        }

        .command-input {
            flex: 1;
            background: transparent;
            border: none;
            font-size: var(--font-size-lg);
            font-family: var(--font-family-body);
            color: var(--color-text);
            outline: none;
        }

        .command-input::placeholder {
            color: var(--color-text-muted);
        }

        .command-shortcut-hint {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
        }

        /* Results container */
        .command-results {
            max-height: 420px;
            overflow-y: auto;
            overscroll-behavior: contain;
        }

        .command-results::-webkit-scrollbar {
            width: 6px;
        }

        .command-results::-webkit-scrollbar-track {
            background: transparent;
        }

        .command-results::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 3px;
        }

        /* Empty state */
        .command-empty {
            padding: var(--space-8);
            text-align: center;
            color: var(--color-text-muted);
        }

        .command-empty-icon {
            font-size: 2rem;
            margin-bottom: var(--space-2);
            opacity: 0.5;
        }

        /* Section grouping */
        .command-section {
            padding: var(--space-2);
        }

        .command-section:not(:last-child) {
            border-bottom: 1px solid var(--color-border-subtle);
        }

        .command-section-title {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: var(--space-2) var(--space-3);
            margin-bottom: var(--space-1);
        }

        /* Individual result items */
        .command-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .command-item:hover,
        .command-item.selected {
            background: var(--color-primary);
        }

        .command-item:hover .command-item-title,
        .command-item.selected .command-item-title {
            color: white;
        }

        .command-item:hover .command-item-desc,
        .command-item.selected .command-item-desc {
            color: rgba(255, 255, 255, 0.8);
        }

        .command-item-icon {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            background: var(--color-surface-elevated);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
            color: var(--color-text-muted);
        }

        .command-item-icon svg {
            width: 18px;
            height: 18px;
        }

        .command-item:hover .command-item-icon,
        .command-item.selected .command-item-icon {
            color: var(--color-primary);
        }

        .command-item-content {
            flex: 1;
            min-width: 0;
        }

        .command-item-title {
            font-weight: var(--font-weight-medium);
            color: var(--color-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: color var(--transition-fast);
        }

        .command-item-desc {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: color var(--transition-fast);
        }

        .command-item-badge {
            flex-shrink: 0;
            padding: var(--space-1) var(--space-2);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            background: var(--color-surface-elevated);
            border-radius: var(--radius-sm);
            color: var(--color-text-muted);
        }

        /* Footer with keyboard hints */
        .command-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3) var(--space-4);
            border-top: 1px solid var(--color-border);
            background: var(--color-surface-elevated);
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
        }

        .command-footer-group {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .command-footer-hint {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        /* Search trigger button in header */
        .search-trigger-btn {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .search-trigger-btn:hover {
            background: var(--color-surface);
            border-color: var(--color-primary);
            color: var(--color-text);
        }

        .search-trigger-btn svg {
            width: 16px;
            height: 16px;
        }

        .search-trigger-btn .kbd {
            font-size: var(--font-size-xs);
            padding: 2px 6px;
        }

        /* Mobile adjustments for Command Palette */
        @media (max-width: 768px) {
            .command-backdrop {
                padding-top: var(--space-4);
                padding-left: var(--space-4);
                padding-right: var(--space-4);
            }

            .command-box {
                max-width: none;
            }

            .command-footer {
                display: none;
            }

            .search-trigger-btn .search-text,
            .search-trigger-btn .kbd {
                display: none;
            }
        }

        /* Privacy Mode - v6.8.6 Comprehensive */
        html[data-privacy="on"] .sensitive,
        html[data-privacy="on"] .shift-guard,
        html[data-privacy="on"] .shift-guard span,
        html[data-privacy="on"] .multi-guard-entry,
        html[data-privacy="on"] .reminder-item-text,
        html[data-privacy="on"] .ai-insight-message,
        html[data-privacy="on"] [data-guard-name],
        html[data-privacy="on"] .guard-name,
        html[data-privacy="on"] .contact-name,
        html[data-privacy="on"] .officer-name {
            filter: blur(5px) !important;
            user-select: none !important;
            transition: filter 0.2s ease;
        }

        html[data-privacy="on"] .sensitive:hover,
        html[data-privacy="on"] .shift-guard:hover,
        html[data-privacy="on"] .shift-guard span:hover,
        html[data-privacy="on"] .multi-guard-entry:hover,
        html[data-privacy="on"] .ai-insight-message:hover {
            filter: blur(0) !important;
        }

        /* Toasts should never be blurred in privacy mode */
        html[data-privacy="on"] .toast-container,
        html[data-privacy="on"] .toast-container * {
            filter: none !important;
        }

        #privacy-toggle.active {
            background: var(--color-warning-bg) !important;
            color: var(--color-warning) !important;
        }
    </style>

    <script>
      (function() {
        try {
          // Generate a simple SVG icon for PWA
          const svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192">
            <rect width="192" height="192" rx="24" fill="#0a0a0f"/>
            <path d="M96 32L48 80v80l48 32 48-32V80L96 32z" fill="none" stroke="#3b82f6" stroke-width="8"/>
            <circle cx="96" cy="104" r="24" fill="#3b82f6"/>
          </svg>`;
          const svgBlob = new Blob([svgIcon], { type: 'image/svg+xml' });
          const iconUrl = URL.createObjectURL(svgBlob);
          
          const manifest = {
            name: "Sentinel Ops",
            short_name: "Sentinel",
            description: "Security Operations Dashboard for Newark Security",
            start_url: ".",
            display: "standalone",
            background_color: "#0a0a0f",
            theme_color: "#0a0a0f",
            icons: [
              { src: iconUrl, sizes: "192x192", type: "image/svg+xml", purpose: "any maskable" },
              { src: iconUrl, sizes: "512x512", type: "image/svg+xml", purpose: "any maskable" }
            ]
          };

          const blob = new Blob([JSON.stringify(manifest)], { type: "application/manifest+json" });
          const url = URL.createObjectURL(blob);

          let link = document.querySelector('link[rel="manifest"]');
          if (!link) {
            link = document.createElement('link');
            link.setAttribute('rel', 'manifest');
            document.head.appendChild(link);
          }
          link.setAttribute('href', url);
        } catch (e) {}
      })();
    </script>

</head>

<body>
<svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;overflow:hidden" aria-hidden="true" focusable="false">
  <symbol id="i-home" viewBox="0 0 24 24">
    <path d="M3 10.5 12 3l9 7.5V21a1.5 1.5 0 0 1-1.5 1.5H15v-7.5H9v7.5H4.5A1.5 1.5 0 0 1 3 21z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
  </symbol>
  <symbol id="i-search" viewBox="0 0 24 24">
    <circle cx="11" cy="11" r="7" fill="none" stroke="currentColor" stroke-width="2"/>
    <path d="M20 20l-3.5-3.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </symbol>
  <symbol id="i-ops" viewBox="0 0 24 24">
    <path d="M22 12h-4l-3 9-6-18-3 9H2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </symbol>
  <symbol id="i-sync" viewBox="0 0 24 24">
    <path d="M17 18a4 4 0 0 0 0-8 5.5 5.5 0 0 0-10.6 1.7A4 4 0 0 0 7 19h10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M12 12v8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <path d="M8.5 15.5 12 12l3.5 3.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </symbol>
  <symbol id="i-user" viewBox="0 0 24 24">
    <circle cx="12" cy="8" r="4" fill="none" stroke="currentColor" stroke-width="2"/>
    <path d="M4 21v-2a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </symbol>
  <symbol id="i-ai" viewBox="0 0 24 24">
    <path d="M12 2l1.7 5.6L19.3 9.3l-5.6 1.7L12 16.6 10.3 11 4.7 9.3l5.6-1.7z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
    <path d="M19 14l.8 2.6L22 17.4l-2.2.8L19 21l-.8-2.8L16 17.4l2.2-.8z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
  </symbol>
  <symbol id="i-lock" viewBox="0 0 24 24">
    <rect x="4" y="11" width="16" height="11" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
    <path d="M8 11V7a4 4 0 0 1 8 0v4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </symbol>
</svg>

    <div class="app-container">
        <!-- Main Content Area (Full Width - No Sidebar) -->
        <main class="main-content">
            <header class="main-header">
                <div class="header-left">
                    <div class="header-brand">
                        <span class="header-brand-icon">S</span>
                        <div class="header-brand-text">
                            <span class="header-brand-title">Sentinel Ops</span>
                            <span class="header-brand-section" id="current-section">Dashboard</span>
                        </div>
                    </div>
                </div>
                <div class="header-right">
                    <button class="header-btn" id="home-btn" onclick="Router.navigate('dashboard')" aria-label="Go to Dashboard" title="Dashboard (Home)">
                        <svg class="icon" width="20" height="20" aria-hidden="true" focusable="false"><use href="#i-home"></use></svg>
                    </button>
                    <button class="header-btn" id="search-trigger-btn" aria-label="Open command palette" title="Search (âŒ˜K)">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                    <button class="header-btn" id="ai-console-toggle-btn" aria-label="Operations Console (Ctrl+Shift+K)" title="Operations Console (Ctrl+Shift+K)">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                        </svg>
                    </button>
                    <button class="header-btn" id="sync-btn" onclick="DataStore.syncAllToCloud()" aria-label="Sync to cloud" title="Sync to cloud">
                        <svg class="icon" width="20" height="20" aria-hidden="true" focusable="false"><use href="#i-sync"></use></svg>
                    </button>
                    <div id="user-display"></div>
                    <button class="header-btn" id="auth-btn" onclick="SentinelAuth.showLoginModal()" aria-label="Sign in" title="Sign in">
                        <svg class="icon" width="20" height="20" aria-hidden="true" focusable="false"><use href="#i-user"></use></svg>
                    </button>
                    <!-- v6.8.6: AI Insights as compact dropdown -->
                    <div class="header-dropdown" id="insights-dropdown">
                        <button class="header-btn" id="insights-toggle" aria-label="AI Insights" title="AI Insights">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                    d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                            <span class="header-btn-badge" id="insights-badge" style="display: none;"></span>
                        </button>
                        <div class="header-dropdown-menu" id="insights-menu">
                            <div class="dropdown-header">
                                <span>AI Insights</span>
                                <button class="btn btn-xs btn-ghost" onclick="AIInsights.refresh(); event.stopPropagation();" title="Refresh">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="dropdown-content" id="insights-dropdown-content">
                                <div class="dropdown-empty">No insights available</div>
                            </div>
                        </div>
                    </div>
                    <button class="header-btn" id="privacy-toggle" aria-label="Toggle privacy mode"
                        title="Privacy Mode (blur sensitive info)">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </button>
                    <button class="header-btn" id="theme-toggle" aria-label="Toggle theme"
                        title="Toggle dark/light theme">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                    </button>
                    <button class="header-btn" id="help-btn" aria-label="Help" title="Help & keyboard shortcuts">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                </div>
            </header>

            <div class="main-body">
                <!-- Dashboard Section -->
                <section class="page-section active" id="section-dashboard" aria-labelledby="page-title">

                    <!-- Dashboard Header with Data Freshness -->
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-4);">
                        <div>
                            <h1 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-text); margin: 0;">
                                Operations Overview
                            </h1>
                            <p class="text-sm text-muted" id="dashboard-date" style="margin-top: 2px;"></p>
                        </div>
                        <div class="data-freshness" id="dashboard-freshness">
                            <span class="data-freshness-dot"></span>
                            <span id="freshness-text">Live</span>
                        </div>
                    </div>

                    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                    <!-- COMMAND CENTER - Unified Alert Hub (v6.18.0)                        -->
                    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                    <div id="command-center" style="margin-bottom: var(--space-5);">
                        <!-- Populated by DashboardModule.renderCommandCenter() -->
                    </div>

                    <!-- OPERATIONAL PULSE - Real-time Status Bar -->
                    <div id="ops-pulse" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: var(--space-3); margin-bottom: var(--space-5); padding: var(--space-4); background: linear-gradient(135deg, var(--color-surface-elevated) 0%, var(--color-surface) 100%); border-radius: var(--radius-lg); border: 1px solid var(--color-border);">
                        <!-- Populated by JS -->
                    </div>

                    <div class="kpi-grid" id="kpi-grid">
                        <!-- KPIs rendered by JS -->
                    </div>

                    <!-- QUICK OPS PANEL - For rapid phone call responses -->
                    <div class="quick-ops-panel" id="quick-ops-panel">
                        <div class="quick-ops-header">
                            <h3>âš¡ Quick Ops</h3>
                            <span class="text-muted text-sm">Tap to expand</span>
                        </div>
                        <div class="quick-ops-grid">
                            <!-- Relief Lookup -->
                            <div class="quick-ops-card" onclick="QuickOps.openRelief()">
                                <div class="quick-ops-icon">ğŸ”„</div>
                                <div class="quick-ops-label">Relief Lookup</div>
                                <div class="quick-ops-hint">Who's relieving who?</div>
                            </div>
                            <!-- Quick Call-off -->
                            <div class="quick-ops-card" onclick="QuickOps.openCallOff()">
                                <div class="quick-ops-icon">ğŸ“µ</div>
                                <div class="quick-ops-label">Quick Call-off</div>
                                <div class="quick-ops-hint">Log + find coverage</div>
                            </div>
                            <!-- Available Guards -->
                            <div class="quick-ops-card" onclick="QuickOps.openAvailable()">
                                <div class="quick-ops-icon" id="avail-count-badge">ğŸ“‹</div>
                                <div class="quick-ops-label">Available Guards</div>
                                <div class="quick-ops-hint" id="avail-count-hint">Who can work?</div>
                            </div>
                            <!-- Site Quick View -->
                            <div class="quick-ops-card" onclick="QuickOps.openSiteView()">
                                <div class="quick-ops-icon">ğŸ¢</div>
                                <div class="quick-ops-label">Site View</div>
                                <div class="quick-ops-hint">Contacts + status</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Navigation -->
                    <div style="display: flex; flex-wrap: wrap; gap: var(--space-2); margin-bottom: var(--space-5); padding: var(--space-3); background: var(--color-surface); border-radius: var(--radius-lg); border: 1px solid var(--color-border);">
                        <button class="btn btn-sm btn-ghost" onclick="Router.navigate('scheduler')" style="gap: var(--space-2);">ğŸ“… Scheduler</button>
                        <button class="btn btn-sm btn-ghost" onclick="Router.navigate('incidents')" style="gap: var(--space-2);">âš ï¸ Incidents</button>
                        <button class="btn btn-sm btn-ghost" onclick="Router.navigate('roster')" style="gap: var(--space-2);">ğŸ‘¥ Roster</button>
                        <button class="btn btn-sm btn-ghost" onclick="Router.navigate('performance')" style="gap: var(--space-2);">ğŸ“Š Performance</button>
                        <button class="btn btn-sm btn-ghost" onclick="Router.navigate('sites')" style="gap: var(--space-2);">ğŸ¢ Sites</button>
                        <button class="btn btn-sm btn-ghost" onclick="Router.navigate('documents')" style="gap: var(--space-2);">ğŸ“ Documents</button>
                        <button class="btn btn-sm btn-ghost" onclick="Router.navigate('availability')" style="gap: var(--space-2);">ğŸ“† Availability</button>
                        <button class="btn btn-sm btn-ghost" onclick="Router.navigate('calloffs')" style="gap: var(--space-2);">ğŸ“µ Call-offs</button>
                        <button class="btn btn-sm btn-ghost" onclick="Router.navigate('contacts')" style="gap: var(--space-2);">ğŸ“‡ Contacts</button>
                        <button class="btn btn-sm btn-ghost" onclick="Router.navigate('reports')" style="gap: var(--space-2);">ğŸ“‹ Reports</button>
                        <button class="btn btn-sm btn-ghost" onclick="Router.navigate('analytics')" style="gap: var(--space-2);">ğŸ“ˆ Analytics</button>
                        <button class="btn btn-sm btn-ghost" onclick="Router.navigate('settings')" style="gap: var(--space-2);">âš™ï¸ Settings</button>
                    </div>

                    <!-- PRIORITY: Today's Operations - What needs attention NOW -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-5);">
                        <div class="card">
                            <div class="card-header" style="padding: var(--space-3) var(--space-4);">
                                <h3 class="card-title" style="display: flex; align-items: center; gap: var(--space-2); font-size: var(--font-size-sm);">
                                    <span>ğŸ“‹</span> Today's Shifts
                                </h3>
                                <button class="btn btn-xs btn-ghost" onclick="Router.navigate('scheduler')">View â†’</button>
                            </div>
                            <div class="card-body" style="padding: 0;">
                                <div id="today-shifts-list" style="max-height: 260px; overflow-y: auto;">
                                    <!-- Rendered by JS -->
                                </div>
                            </div>
                        </div>

                        <!-- Tasks Widget -->
                        <div class="card dashboard-tasks-widget" id="dashboard-tasks-widget">
                            <div class="card-header dashboard-tasks-header" style="padding: var(--space-3) var(--space-4);">
                                <h3 class="card-title dashboard-tasks-title" style="font-size: var(--font-size-sm);">
                                    <span>âš¡</span> Tasks Due
                                    <span class="dashboard-tasks-count" style="display: none;">0</span>
                                </h3>
                                <button class="btn btn-xs btn-ghost" onclick="Router.navigate('tasks')">View â†’</button>
                            </div>
                            <div class="card-body" style="padding: 0;">
                                <div class="dashboard-tasks-list" style="max-height: 260px; overflow-y: auto; padding: var(--space-2);">
                                    <!-- Rendered by TasksModule -->
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header" style="padding: var(--space-3) var(--space-4);">
                                <h3 class="card-title" style="display: flex; align-items: center; gap: var(--space-2); font-size: var(--font-size-sm);">
                                    <span>âš ï¸</span> Recent Incidents
                                </h3>
                                <button class="btn btn-xs btn-ghost" onclick="Router.navigate('incidents')">View â†’</button>
                            </div>
                            <div class="card-body" style="padding: 0;">
                                <div id="recent-incidents-list" style="max-height: 260px; overflow-y: auto;">
                                    <!-- Rendered by JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Timeline + Site Status Row -->
                    <div class="card" style="margin-bottom: var(--space-5);">
                        <div class="card-header" style="padding: var(--space-3) var(--space-4);">
                            <h3 class="card-title" style="display: flex; align-items: center; gap: var(--space-2); font-size: var(--font-size-sm);">
                                ğŸ¢ Site Status
                            </h3>
                            <div style="display: flex; gap: var(--space-2);">
                                <span class="badge badge-success" id="sites-operational-count" style="font-size: 0.65rem; cursor: pointer;" onclick="Router.navigate('sites')">0</span>
                                <span class="badge badge-warning" id="sites-issues-count" style="display: none; font-size: 0.65rem; cursor: pointer;" onclick="DashboardModule.showSiteIssues()">0</span>
                            </div>
                        </div>
                        <div class="card-body" style="padding: var(--space-3);">
                            <div id="site-status-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: var(--space-2);">
                                <!-- Rendered by JS -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Timeline is rendered inside today-shifts for context -->
                    <div id="timeline-view" style="display: none;"></div>
                    <span id="timeline-time" style="display: none;"></span>

                    <!-- Quick Actions - Moved lower, less prominent -->
                    <div class="card" id="quick-actions-panel" style="border-color: var(--color-border-subtle);">
                        <div class="card-header">
                            <h3 class="card-title" style="color: var(--color-text-secondary);">Quick Actions</h3>
                            <button class="btn btn-sm btn-primary" id="generate-summary-btn">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Generate Daily Summary
                            </button>
                        </div>
                        <div class="card-body">
                            <form id="quick-log-form"
                                style="display: flex; gap: var(--space-3); align-items: flex-end; flex-wrap: wrap;">
                                <div class="form-group" style="flex: 0 0 140px; margin-bottom: 0;">
                                    <label class="form-label text-sm">Source</label>
                                    <select class="form-select" id="quick-log-source" style="height: 36px;">
                                        <option value="Field Visit">Field Visit</option>
                                        <option value="Day Supervisor">Day Supervisor</option>
                                        <option value="Night Supervisor">Night Supervisor</option>
                                        <option value="Guard">Guard</option>
                                        <option value="Phone Call">Phone Call</option>
                                        <option value="Email">Email</option>
                                        <option value="Property Manager">Property Manager</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1; min-width: 250px; margin-bottom: 0;">
                                    <label class="form-label text-sm">Quick Note</label>
                                    <input type="text" class="form-input" id="quick-log-note"
                                        placeholder="Enter a quick log note..." style="height: 36px;">
                                </div>
                                <div class="form-group" style="flex: 0 0 auto; margin-bottom: 0;">
                                    <label class="checkbox-label"
                                        style="height: 36px; display: flex; align-items: center;">
                                        <input type="checkbox" id="quick-log-followup">
                                        <span class="text-sm">Follow-up</span>
                                    </label>
                                </div>
                                <button type="submit" class="btn btn-primary" style="height: 36px;">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                    Add Entry
                                </button>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- Scheduler Section -->
                <section class="page-section" id="section-scheduler" aria-label="Scheduler">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <div class="week-nav">
                                <button class="btn btn-icon btn-secondary" id="prev-week" aria-label="Previous week">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 19l-7-7 7-7" />
                                    </svg>
                                </button>
                                <span class="week-nav-label" id="week-label">Week of Dec 1, 2025</span>
                                <button class="btn btn-icon btn-secondary" id="next-week" aria-label="Next week">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 5l7 7-7 7" />
                                    </svg>
                                </button>
                                <button class="btn btn-sm btn-ghost" id="today-btn">Today</button>
                            </div>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-sm btn-primary" onclick="SchedulerModule.openAddShiftModal()" title="Add a new shift">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                Add Shift
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="SchedulerModule.copyLastWeek()" title="Copy last week's schedule to this week">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                                Copy Last Week
                            </button>
                            <button class="btn btn-sm btn-secondary" id="export-schedule-csv">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Export
                            </button>
                            <button class="btn btn-sm btn-secondary" id="print-schedule">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                </svg>
                                Print
                            </button>
                            <div class="dropdown" style="position: relative; display: inline-block;">
                                <button class="btn btn-sm btn-ghost" onclick="this.nextElementSibling.classList.toggle('show')" title="More options">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                    </svg>
                                </button>
                                <div class="dropdown-menu" style="position: absolute; right: 0; top: 100%; background: var(--color-surface-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-md); min-width: 180px; z-index: 100; display: none; box-shadow: var(--shadow-lg);">
                                    <button class="dropdown-item" onclick="SchedulerModule.removeDuplicates(); this.parentElement.classList.remove('show');" style="display: block; width: 100%; padding: var(--space-2) var(--space-3); text-align: left; background: none; border: none; cursor: pointer; color: var(--color-text);">
                                        ğŸ”§ Remove Duplicates
                                    </button>
                                    <button class="dropdown-item" onclick="SchedulerModule.clearWeek(); this.parentElement.classList.remove('show');" style="display: block; width: 100%; padding: var(--space-2) var(--space-3); text-align: left; background: none; border: none; cursor: pointer; color: var(--color-danger);">
                                        ğŸ—‘ï¸ Clear Week Schedule
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Coverage Stats Panel -->
                    <div id="schedule-stats" style="margin-bottom: var(--space-2);"></div>

                    <!-- Print Header (hidden on screen, shown on print) -->
                    <div class="print-header" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span id="print-timestamp" style="font-size: 9pt; color: #666;"></span>
                            <span style="font-size: 10pt; font-weight: bold;">Sentinel Ops | Newark Security Operations</span>
                        </div>
                        <div id="print-stats" style="display: flex; justify-content: center; gap: 30px; margin-bottom: 8px;"></div>
                    </div>

                    <div class="card">
                        <div class="card-body" style="padding: 0;">
                            <div class="scheduler-wrapper">
                                <div class="scheduler-grid" id="scheduler-grid">
                                    <!-- Rendered by JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Print Legend (hidden on screen, shown on print) -->
                    <div class="print-legend" style="display: none;">
                        <span><span class="legend-box" style="background: #fff; border-left: 3px solid #00c;"></span> Assigned</span>
                        <span><span class="legend-box" style="background: #fff; border-left: 3px solid #0a0;"></span> DP Confirmed</span>
                        <span><span class="legend-box" style="background: #fff0f0; border-left: 3px solid #c00;"></span> Open</span>
                    </div>

                    <div class="flex gap-4 mt-4" style="flex-wrap: wrap;">
                        <div class="flex items-center gap-2">
                            <div
                                style="width: 12px; height: 12px; border-radius: 2px; background: var(--color-success);">
                            </div>
                            <span class="text-sm text-muted">Assigned</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div
                                style="width: 12px; height: 12px; border-radius: 2px; background: var(--color-warning);">
                            </div>
                            <span class="text-sm text-muted">DP Confirmed</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div
                                style="width: 12px; height: 12px; border-radius: 2px; background: var(--color-danger);">
                            </div>
                            <span class="text-sm text-muted">Open</span>
                        </div>
                    </div>
                </section>

                <!-- Incidents Section -->
                <section class="page-section" id="section-incidents" aria-label="Incidents">
                    <!-- Bulk Action Bar (hidden by default) -->
                    <div class="bulk-action-bar" id="incidents-bulk-bar" style="display: none;">
                        <div style="display: flex; align-items: center; gap: var(--space-3);">
                            <span class="bulk-count"><span id="incidents-selected-count">0</span> selected</span>
                            <button class="btn btn-sm btn-secondary"
                                onclick="IncidentsModule.bulkUpdateStatus('In Progress')" title="Mark as In Progress">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                In Progress
                            </button>
                            <button class="btn btn-sm btn-success"
                                onclick="IncidentsModule.bulkUpdateStatus('Resolved')" title="Mark as Resolved">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Resolved
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="IncidentsModule.bulkDelete()"
                                title="Delete Selected">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Delete
                            </button>
                        </div>
                        <button class="btn btn-sm btn-ghost" onclick="IncidentsModule.clearSelection()">Clear
                            Selection</button>
                    </div>

                    <div class="toolbar">
                        <div class="toolbar-left">
                            <div class="search-bar">
                                <svg class="search-bar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                <input type="text" class="form-input" id="incident-search"
                                    placeholder="Search incidents...">
                            </div>
                            <select class="form-select" id="incident-filter-site" style="width: auto;">
                                <option value="">All Sites</option>
                            </select>
                            <select class="form-select" id="incident-filter-severity" style="width: auto;">
                                <option value="">All Severities</option>
                                <option value="Critical">Critical</option>
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                            <select class="form-select" id="incident-filter-status" style="width: auto;">
                                <option value="">All Status</option>
                                <option value="Open">ğŸ”´ Open</option>
                                <option value="In Progress">ğŸŸ¡ In Progress</option>
                                <option value="Under Investigation">ğŸ” Under Investigation</option>
                                <option value="Pending Review">â³ Pending Review</option>
                                <option value="Escalated">âš ï¸ Escalated</option>
                                <option value="Resolved">âœ… Resolved</option>
                                <option value="Closed">ğŸ“ Closed</option>
                            </select>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-sm btn-secondary action-export" id="export-incidents-csv">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Export CSV
                            </button>
                            <button class="btn btn-primary action-new" id="new-incident-btn">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                                New Incident
                            </button>
                        </div>
                    </div>

                    <!-- Incidents Stats Panel -->
                    <div id="incidents-stats" style="margin-bottom: var(--space-2);"></div>

                    <div class="table-container">
                        <table class="table table-mobile-cards" id="incidents-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox" class="row-checkbox"
                                            id="incidents-select-all"
                                            onchange="IncidentsModule.toggleSelectAll(this.checked)" title="Select all">
                                    </th>
                                    <th>ID</th>
                                    <th>Site</th>
                                    <th>Date/Time</th>
                                    <th>Type</th>
                                    <th>Severity</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="incidents-tbody">
                                <!-- Rendered by JS -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Inspections Section -->
                <section class="page-section" id="section-inspections" aria-label="Inspections">
                    <div class="tabs" role="tablist">
                        <button class="tab active" data-tab="inspection-new" role="tab" aria-selected="true">New
                            Inspection</button>
                        <button class="tab" data-tab="inspection-history" role="tab"
                            aria-selected="false">History</button>
                    </div>

                    <div class="tab-content active" id="tab-inspection-new">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">SecureInspect Enterprise+ Form</h3>
                                <span class="badge badge-info" id="inspection-id">INS-20251201-0001</span>
                            </div>
                            <div class="card-body">
                                <form id="inspection-form">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Date/Time</label>
                                            <input type="datetime-local" class="form-input" id="insp-datetime" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Inspector Name</label>
                                            <input type="text" class="form-input" id="insp-inspector"
                                                value="Mike Howard" required>
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Site</label>
                                            <select class="form-select" id="insp-site" required>
                                                <option value="">Select site...</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Guard on Duty</label>
                                            <select class="form-select" id="insp-guard">
                                                <option value="">Select guard...</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Address</label>
                                        <input type="text" class="form-input" id="insp-address">
                                    </div>

                                    <h4
                                        style="margin: var(--space-6) 0 var(--space-4); font-size: var(--font-size-base); font-weight: var(--font-weight-semibold);">
                                        Inspection Checklist</h4>

                                    <div id="inspection-checklist">
                                        <!-- Rendered by JS -->
                                    </div>

                                    <div class="form-row mt-4">
                                        <div class="form-group">
                                            <label class="form-label">Inspector Signature</label>
                                            <canvas id="sig-inspector" class="signature-pad" width="300"
                                                height="100"></canvas>
                                            <div class="signature-actions">
                                                <button type="button" class="btn btn-sm btn-ghost"
                                                    onclick="InspectionsModule.clearSignature('inspector')">Clear</button>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Client Signature (Optional)</label>
                                            <canvas id="sig-client" class="signature-pad" width="300"
                                                height="100"></canvas>
                                            <div class="signature-actions">
                                                <button type="button" class="btn btn-sm btn-ghost"
                                                    onclick="InspectionsModule.clearSignature('client')">Clear</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Photo Attachments</label>
                                        <input type="file" class="form-input" id="insp-photos" multiple accept="image/*"
                                            style="padding: var(--space-2);">
                                        <p class="form-hint">Attach photos for documentation (metadata only stored)</p>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Overall Status</label>
                                        <select class="form-select" id="insp-status" required>
                                            <option value="Pass">Pass</option>
                                            <option value="Fail">Fail</option>
                                            <option value="Needs Follow-Up">Needs Follow-Up</option>
                                        </select>
                                    </div>

                                    <div class="flex gap-3 mt-4">
                                        <button type="submit" class="btn btn-primary action-new">Save Inspection</button>
                                        <button type="button" class="btn btn-secondary action-edit"
                                            onclick="InspectionsModule.resetForm()">Reset</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="tab-inspection-history">
                        <div class="toolbar">
                            <div class="toolbar-left">
                                <select class="form-select" id="insp-filter-site" style="width: auto;">
                                    <option value="">All Sites</option>
                                </select>
                                <select class="form-select" id="insp-filter-status" style="width: auto;">
                                    <option value="">All Status</option>
                                    <option value="Pass">Pass</option>
                                    <option value="Fail">Fail</option>
                                    <option value="Needs Follow-Up">Needs Follow-Up</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table table-mobile-cards">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Site</th>
                                        <th>Date</th>
                                        <th>Inspector</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inspections-tbody">
                                    <!-- Rendered by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Supervisor's Log Section -->
                <section class="page-section" id="section-supervisorlog" aria-label="Supervisor's Log">
                    <div class="tabs" role="tablist">
                        <button class="tab active" data-tab="log-entries" role="tab" aria-selected="true">All
                            Entries</button>
                        <button class="tab" data-tab="log-open" role="tab" aria-selected="false">
                            Open Items
                            <span class="nav-item-badge" id="tab-open-count"
                                style="margin-left: var(--space-2);">0</span>
                        </button>
                    </div>

                    <div class="tab-content active" id="tab-log-entries">
                        <div class="toolbar">
                            <div class="toolbar-left">
                                <div class="search-bar">
                                    <svg class="search-bar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                    <input type="text" class="form-input" id="log-search"
                                        placeholder="Search entries...">
                                </div>
                                <select class="form-select" id="log-filter-source" style="width: auto;">
                                    <option value="">All Sources</option>
                                    <option value="Day Supervisor">Day Supervisor</option>
                                    <option value="Night Supervisor">Night Supervisor</option>
                                    <option value="Guard">Guard</option>
                                    <option value="Field Visit">Field Visit</option>
                                    <option value="Phone Call">Phone Call</option>
                                    <option value="Email">Email</option>
                                    <option value="Property Manager">Property Manager</option>
                                    <option value="Other">Other</option>
                                </select>
                                <select class="form-select" id="log-filter-site" style="width: auto;">
                                    <option value="">All Sites</option>
                                </select>
                            </div>
                            <div class="toolbar-right">
                                <button class="btn btn-secondary action-export" id="export-log-csv">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    Export CSV
                                </button>
                                <button class="btn btn-primary action-new" id="new-log-entry-btn">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                    New Entry
                                </button>
                            </div>
                        </div>

                        <div id="log-entries-list">
                            <!-- Rendered by JS -->
                        </div>
                    </div>

                    <div class="tab-content" id="tab-log-open">
                        <div class="toolbar">
                            <div class="toolbar-left">
                                <p class="text-muted">Items flagged for follow-up that haven't been resolved yet.</p>
                            </div>
                        </div>

                        <div id="log-open-list">
                            <!-- Rendered by JS -->
                        </div>
                    </div>
                </section>

                <!-- Communications Log Section -->
                <section class="page-section" id="section-commslog" aria-label="Communications Log">
                    <div class="tabs" role="tablist">
                        <button class="tab active" data-tab="comms-all" role="tab" aria-selected="true">All Communications</button>
                        <button class="tab" data-tab="comms-followup" role="tab" aria-selected="false">
                            Follow-ups Due
                            <span class="nav-item-badge" id="tab-followup-count" style="margin-left: var(--space-2);">0</span>
                        </button>
                        <button class="tab" data-tab="comms-today" role="tab" aria-selected="false">Today</button>
                    </div>

                    <div class="tab-content active" id="tab-comms-all">
                        <div class="toolbar">
                            <div class="toolbar-left">
                                <div class="search-bar">
                                    <svg class="search-bar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                    <input type="text" class="form-input" id="comms-search" placeholder="Search communications...">
                                </div>
                                <select class="form-select" id="comms-filter-type" style="width: auto;">
                                    <option value="">All Types</option>
                                    <option value="phone_inbound">ğŸ“ Phone (Inbound)</option>
                                    <option value="phone_outbound">ğŸ“± Phone (Outbound)</option>
                                    <option value="email_inbound">ğŸ“¨ Email (Received)</option>
                                    <option value="email_outbound">ğŸ“§ Email (Sent)</option>
                                    <option value="in_person">ğŸ¤ In-Person</option>
                                    <option value="text">ğŸ’¬ Text/SMS</option>
                                    <option value="video">ğŸ–¥ï¸ Video Call</option>
                                    <option value="radio">ğŸ“» Radio</option>
                                </select>
                                <select class="form-select" id="comms-filter-party" style="width: auto;">
                                    <option value="">All Parties</option>
                                    <option value="client">Client/Property Manager</option>
                                    <option value="guard">Guard/Officer</option>
                                    <option value="vendor">Vendor/Contractor</option>
                                    <option value="internal">Internal Staff</option>
                                    <option value="emergency">Emergency Services</option>
                                    <option value="resident">Resident/Tenant</option>
                                    <option value="other">Other</option>
                                </select>
                                <select class="form-select" id="comms-filter-site" style="width: auto;">
                                    <option value="">All Sites</option>
                                </select>
                            </div>
                            <div class="toolbar-right">
                                <button class="btn btn-ghost action-delete" onclick="CommsLogModule.cleanupDuplicates()" title="Remove duplicate entries">
                                    ğŸ§¹ Clean Duplicates
                                </button>
                                <button class="btn btn-secondary action-export" id="export-comms-csv">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Export
                                </button>
                                <button class="btn btn-primary action-new" id="new-comm-btn">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                    Log Communication
                                </button>
                            </div>
                        </div>

                        <!-- Quick Stats -->
                        <div id="comms-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: var(--space-3); margin-bottom: var(--space-4);">
                            <!-- Rendered by JS -->
                        </div>

                        <div id="comms-list">
                            <!-- Rendered by JS -->
                        </div>
                    </div>

                    <div class="tab-content" id="tab-comms-followup">
                        <div class="toolbar">
                            <div class="toolbar-left">
                                <p class="text-muted">Communications flagged for follow-up action.</p>
                            </div>
                        </div>
                        <div id="comms-followup-list">
                            <!-- Rendered by JS -->
                        </div>
                    </div>

                    <div class="tab-content" id="tab-comms-today">
                        <div class="toolbar">
                            <div class="toolbar-left">
                                <p class="text-muted">All communications logged today.</p>
                            </div>
                        </div>
                        <div id="comms-today-list">
                            <!-- Rendered by JS -->
                        </div>
                    </div>
                </section>

                <!-- Call-off Log Section -->
                <section class="page-section" id="section-calloffs" aria-label="Call-off Log">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <div class="search-bar">
                                <svg class="search-bar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                <input type="text" class="form-input" id="calloff-search"
                                    placeholder="Search call-offs...">
                            </div>
                            <select class="form-select" id="calloff-filter-site" style="width: auto;">
                                <option value="">All Sites</option>
                            </select>
                            <select class="form-select" id="calloff-filter-status" style="width: auto;">
                                <option value="">All Status</option>
                                <option value="covered">Covered</option>
                                <option value="uncovered">Uncovered</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-sm btn-secondary" onclick="OvertimeModule.openTracker()" title="View overtime status">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                OT Tracker
                            </button>
                            <button class="btn btn-sm btn-secondary action-export" id="export-calloffs-csv">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Export CSV
                            </button>
                            <button class="btn btn-primary action-new" id="new-calloff-btn">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                                Log Call-off
                            </button>
                        </div>
                    </div>

                    <div class="tabs" role="tablist">
                        <button class="tab active" data-tab="calloff-all" role="tab" aria-selected="true">All
                            Call-offs</button>
                        <button class="tab" data-tab="calloff-pending" role="tab" aria-selected="false">
                            Pending Coverage
                            <span class="nav-item-badge" id="tab-pending-count" style="margin-left: 6px;">0</span>
                        </button>
                        <button class="tab" data-tab="calloff-today" role="tab" aria-selected="false">Today</button>
                        <button class="tab" data-tab="calloff-overtime" role="tab" aria-selected="false">
                            Overtime
                            <span class="nav-item-badge" id="tab-overtime-count" style="margin-left: 6px; display: none;">0</span>
                        </button>
                    </div>

                    <div class="tab-content active" id="tab-calloff-all">
                        <div class="table-container">
                            <table class="table table-mobile-cards" id="calloffs-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Guard</th>
                                        <th>Site</th>
                                        <th>Shift</th>
                                        <th>Reason</th>
                                        <th>Coverage</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="calloffs-tbody">
                                    <!-- Rendered by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-content" id="tab-calloff-pending">
                        <div id="calloff-pending-list">
                            <!-- Rendered by JS -->
                        </div>
                    </div>

                    <div class="tab-content" id="tab-calloff-today">
                        <div id="calloff-today-list">
                            <!-- Rendered by JS -->
                        </div>
                    </div>

                    <div class="tab-content" id="tab-calloff-overtime">
                        <div id="overtime-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: var(--space-3); margin-bottom: var(--space-4);">
                            <!-- Rendered by JS -->
                        </div>
                        <div class="ot-grid" id="overtime-grid">
                            <!-- Rendered by JS -->
                        </div>
                    </div>
                </section>

                <!-- Sites Section -->
                <section class="page-section" id="section-sites" aria-label="Sites">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <div class="search-bar">
                                <svg class="search-bar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                <input type="text" class="form-input" id="site-search" placeholder="Search sites...">
                            </div>
                            <select class="form-select" id="site-filter-status" style="width: auto;">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="on_hold">On Hold</option>
                                <option value="terminated">Terminated</option>
                            </select>
                            <select class="form-select" id="site-filter-category" style="width: auto;">
                                <option value="">All Categories</option>
                                <option value="residential">Residential</option>
                                <option value="commercial">Commercial</option>
                                <option value="warehouse">Warehouse</option>
                                <option value="office">Office</option>
                                <option value="parking">Parking</option>
                                <option value="industrial">Industrial</option>
                                <option value="mixed">Mixed Use</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-primary action-new" id="new-site-btn">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                                Add Site
                            </button>
                        </div>
                    </div>

                    <div id="sites-grid"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: var(--space-4);">
                        <!-- Rendered by JS -->
                    </div>
                </section>

                <!-- Contacts Section -->
                <section class="page-section" id="section-contacts" aria-label="Contacts">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <div class="search-bar">
                                <svg class="search-bar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                <input type="text" class="form-input" id="contact-search"
                                    placeholder="Search contacts...">
                            </div>
                            <select class="form-select" id="contact-filter-category" style="width: auto;">
                                <option value="">All Categories</option>
                                <option value="emergency">ğŸš¨ Emergency Services</option>
                                <option value="client">ğŸ¢ Client Contacts</option>
                                <option value="internal">ğŸ‘” Internal Staff</option>
                                <option value="vendor">ğŸ”§ Vendors</option>
                                <option value="utility">âš¡ Utility/Maintenance</option>
                                <option value="government">ğŸ›ï¸ Government</option>
                                <option value="legal">âš–ï¸ Legal/Insurance</option>
                                <option value="resident">ğŸ  Resident/On-Site</option>
                            </select>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-primary action-new" id="new-contact-btn">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                                Add Contact
                            </button>
                        </div>
                    </div>

                    <div id="contacts-container">
                        <!-- Rendered by JS -->
                    </div>
                </section>

                <!-- Roster Section -->
                <section class="page-section" id="section-roster" aria-label="Guard Roster">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <div class="search-bar">
                                <svg class="search-bar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                <input type="text" class="form-input" id="guard-search" placeholder="Search guards...">
                            </div>
                            <select class="form-select" id="guard-filter-status" style="width: auto;">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="training">In Training</option>
                                <option value="on_leave">On Leave</option>
                                <option value="suspended">Suspended</option>
                                <option value="terminated">Terminated</option>
                            </select>
                            <select class="form-select" id="guard-filter-role" style="width: auto;">
                                <option value="">All Roles</option>
                                <option value="armed">Armed</option>
                                <option value="unarmed">Unarmed</option>
                                <option value="floater">Floater</option>
                                <option value="supervisor">Supervisor</option>
                            </select>
                            <button class="btn btn-sm btn-ghost" id="guard-cert-alert-btn" onclick="RosterModule.showCertAlerts()" title="View Certification Alerts" style="color: var(--color-warning);">
                                âš ï¸ Cert Alerts
                            </button>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-secondary action-new" id="warning-notice-btn" onclick="WarningNoticeModule.open()" title="Create Employee Warning Notice">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                Warning Notice
                            </button>
                            <button class="btn btn-primary action-new" id="new-guard-btn">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                                Add Guard
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table table-mobile-cards">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Primary Sites</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="roster-tbody">
                                <!-- Rendered by JS -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Availability Section -->
                <section class="page-section" id="section-availability" aria-label="Guard Availability">
                    <div class="toolbar" style="margin-bottom: var(--space-4);">
                        <div class="toolbar-left">
                            <div class="search-bar" style="min-width: 280px;">
                                <svg class="search-bar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                <input type="text" class="form-input" id="avail-search" placeholder="Search guards...">
                            </div>
                            <select class="form-select" id="avail-site-filter" style="width: auto;">
                                <option value="">All Sites</option>
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-secondary action-export" onclick="ExportModule.exportAllAvailability()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                                Export
                            </button>
                            <button class="btn btn-secondary" id="find-available-btn" onclick="CoverageSuggestionEngine.openQuickSuggest()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                Find Available Guards
                            </button>
                        </div>
                    </div>

                    <div class="tabs" role="tablist">
                        <button class="tab active" data-tab="avail-submit" role="tab" aria-selected="true">Submit
                            Availability</button>
                        <button class="tab" data-tab="avail-records" role="tab" aria-selected="false">Records</button>
                        <button class="tab" data-tab="avail-overview" role="tab" aria-selected="false">Team
                            Overview</button>
                        <button class="tab" data-tab="avail-calendar" role="tab" aria-selected="false">Month
                            Calendar</button>
                    </div>

                    <div class="tab-content active" id="tab-avail-submit">
                        <div class="card">
                            <div class="card-header">
                                <div style="display: flex; align-items: center; gap: var(--space-4);">
                                    <button class="btn btn-sm btn-ghost" id="avail-prev-week">
                                        <svg width="16" height="16" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15 19l-7-7 7-7" />
                                        </svg>
                                    </button>
                                    <h3 class="card-title" id="avail-week-label">Loading...</h3>
                                    <button class="btn btn-sm btn-ghost" id="avail-next-week">
                                        <svg width="16" height="16" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 5l7 7-7 7" />
                                        </svg>
                                    </button>
                                </div>
                                <div style="display: flex; align-items: center; gap: var(--space-3);">
                                    <select class="form-select" id="avail-guard-select" style="width: 200px;">
                                        <option value="">Select a guard...</option>
                                    </select>
                                    <button class="btn btn-primary" id="save-availability">
                                        <svg width="16" height="16" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M5 13l4 4L19 7" />
                                        </svg>
                                        Save
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="guard-availability-grid">
                                    <!-- Rendered by JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Records Tab - Shows individual availability records -->
                    <div class="tab-content" id="tab-avail-records">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Availability Records</h3>
                                <div style="display: flex; align-items: center; gap: var(--space-3);">
                                    <select class="form-select" id="avail-records-guard-filter" style="width: 180px;">
                                        <option value="">All Guards</option>
                                    </select>
                                    <select class="form-select" id="avail-records-status-filter" style="width: 150px;">
                                        <option value="">All Statuses</option>
                                        <option value="available">Available</option>
                                        <option value="prefers">Prefers</option>
                                        <option value="unavailable">Unavailable</option>
                                        <option value="blocked">Blocked</option>
                                    </select>
                                    <input type="date" class="form-input" id="avail-records-date-filter" style="width: 150px;">
                                </div>
                            </div>
                            <div class="card-body" style="padding: 0;">
                                <div id="availability-records-table">
                                    <!-- Rendered by JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="tab-avail-overview">
                        <div class="card">
                            <div class="card-header">
                                <div style="display: flex; align-items: center; gap: var(--space-4);">
                                    <button class="btn btn-sm btn-ghost" onclick="AvailabilityModule.changeWeek(-1)"
                                        title="Previous week" aria-label="Previous week">
                                        <svg width="16" height="16" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15 19l-7-7 7-7" />
                                        </svg>
                                    </button>
                                    <h3 class="card-title">Team Availability</h3>
                                    <button class="btn btn-sm btn-ghost" onclick="AvailabilityModule.changeWeek(1)"
                                        title="Next week" aria-label="Next week">
                                        <svg width="16" height="16" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 5l7 7-7 7" />
                                        </svg>
                                    </button>
                                </div>
                                <p class="text-muted" style="font-size: var(--font-size-sm);">Click any cell to view
                                    details</p>
                            </div>
                            <div class="card-body">
                                <div id="availability-overview-grid">
                                    <!-- Rendered by JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Month Calendar View -->
                    <div class="tab-content" id="tab-avail-calendar">
                        <div class="card">
                            <div class="card-header">
                                <div style="display: flex; align-items: center; gap: var(--space-4);">
                                    <button class="btn btn-sm btn-ghost" onclick="AvailabilityModule.changeMonth(-1)"
                                        title="Previous month" aria-label="Previous month">
                                        <svg width="16" height="16" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15 19l-7-7 7-7" />
                                        </svg>
                                    </button>
                                    <h3 class="card-title" id="avail-month-label">Loading...</h3>
                                    <button class="btn btn-sm btn-ghost" onclick="AvailabilityModule.changeMonth(1)"
                                        title="Next month" aria-label="Next month">
                                        <svg width="16" height="16" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 5l7 7-7 7" />
                                        </svg>
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="AvailabilityModule.goToToday()" style="margin-left: var(--space-2);">
                                        Today
                                    </button>
                                </div>
                                <div style="display: flex; align-items: center; gap: var(--space-3);">
                                    <select class="form-select" id="avail-calendar-guard" style="width: 180px;">
                                        <option value="">All Guards</option>
                                    </select>
                                    <select class="form-select" id="avail-calendar-shift" style="width: 120px;">
                                        <option value="">Any Shift</option>
                                        <option value="12A-8A">12A-8A</option>
                                        <option value="8A-4P">8A-4P</option>
                                        <option value="4P-12A">4P-12A</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="availability-calendar-grid">
                                    <!-- Rendered by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Daily Reports Section -->
                <section class="page-section" id="section-reports" aria-label="Daily Reports">
                    <div class="tabs" role="tablist">
                        <button class="tab active" data-tab="report-new" role="tab" aria-selected="true">New
                            Report</button>
                        <button class="tab" data-tab="report-history" role="tab" aria-selected="false">History</button>
                    </div>

                    <div class="tab-content active" id="tab-report-new">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Daily Operations Report</h3>
                            </div>
                            <div class="card-body">
                                <form id="daily-report-form">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Report Date</label>
                                            <input type="date" class="form-input" id="report-date" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Sites Covered</label>
                                            <input type="number" class="form-input" id="report-sites-covered" min="0"
                                                value="13">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Call-offs & Replacements</label>
                                        <textarea class="form-textarea" id="report-calloffs"
                                            placeholder="List any call-offs and their replacements..."></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Incidents & Notable Events</label>
                                        <textarea class="form-textarea" id="report-incidents"
                                            placeholder="Summarize any incidents or notable events by site..."></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Extra Guards Added</label>
                                        <textarea class="form-textarea" id="report-extra-guards"
                                            placeholder="List sites where extra guards were deployed..."></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Supplies/Equipment Needed</label>
                                        <textarea class="form-textarea" id="report-supplies"
                                            placeholder="List any supplies or equipment needs by site..."></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Training Conducted</label>
                                        <textarea class="form-textarea" id="report-training"
                                            placeholder="Note any training performed..."></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Additional Notes</label>
                                        <textarea class="form-textarea" id="report-notes"
                                            placeholder="Any other notes for management..."></textarea>
                                    </div>

                                    <div class="flex gap-3 mt-4">
                                        <button type="submit" class="btn btn-primary action-new">Save Report</button>
                                        <button type="button" class="btn btn-secondary action-export" id="export-report-pdf">Export
                                            PDF</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="tab-report-history">
                        <div class="table-container">
                            <table class="table table-mobile-cards">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Sites Covered</th>
                                        <th>Call-offs</th>
                                        <th>Incidents</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="reports-tbody">
                                    <!-- Rendered by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Analytics Section -->
                <section class="page-section" id="section-analytics" aria-label="Analytics">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <select class="form-select" id="analytics-range" style="width: auto;">
                                <option value="7">Last 7 Days</option>
                                <option value="30" selected>Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                            </select>
                        </div>
                    </div>

                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--space-5);">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Incidents by Severity</h3>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" id="chart-incidents-severity">
                                    <canvas id="canvas-incidents-severity" class="chart-canvas"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Shift Coverage Rate</h3>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" id="chart-coverage">
                                    <canvas id="canvas-coverage" class="chart-canvas"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Incidents by Site</h3>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" id="chart-incidents-site">
                                    <canvas id="canvas-incidents-site" class="chart-canvas"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Inspection Results</h3>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" id="chart-inspections">
                                    <canvas id="canvas-inspections" class="chart-canvas"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Documents Section -->
                <section class="page-section" id="section-documents" aria-label="Document Vault">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <div class="search-bar">
                                <svg class="search-bar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                <input type="text" class="form-input" id="doc-search" placeholder="Search documents...">
                            </div>
                            <select class="form-select" id="doc-filter-category" style="width: auto;">
                                <option value="">All Categories</option>
                                <optgroup label="SOPs & Procedures">
                                    <option value="post_orders">ğŸ“‹ Post Orders</option>
                                    <option value="sop">ğŸ“– SOP</option>
                                    <option value="memo">ğŸ“ Memo / Notice</option>
                                    <option value="emergency">ğŸš¨ Emergency Procedures</option>
                                    <option value="training">ğŸ“š Training Materials</option>
                                    <option value="rollout">ğŸ“¢ Rollout Notice</option>
                                </optgroup>
                                <optgroup label="Compliance & Admin">
                                    <option value="contract">ğŸ“„ Contracts</option>
                                    <option value="insurance">ğŸ›¡ï¸ Insurance Certs</option>
                                    <option value="license">ğŸ“œ Licenses</option>
                                    <option value="site_map">ğŸ—ºï¸ Site Maps</option>
                                    <option value="other">ğŸ“ Other</option>
                                </optgroup>
                            </select>
                            <select class="form-select" id="doc-filter-site" style="width: auto;">
                                <option value="">All Sites</option>
                                <option value="company-wide">Company-Wide</option>
                            </select>
                            <select class="form-select" id="doc-filter-status" style="width: auto;">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="expiring">Expiring Soon</option>
                                <option value="expired">Expired</option>
                            </select>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-secondary" onclick="DocumentsModule.openLookupModal()" title="Find what was active on a specific date">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Date Lookup
                            </button>
                            <button class="btn btn-primary" id="new-document-btn">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                                Add Document
                            </button>
                        </div>
                    </div>

                    <!-- Expiring Documents Alert -->
                    <div id="doc-expiring-alert" style="display: none;"></div>

                    <!-- Quick Stats -->
                    <div id="doc-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: var(--space-3); margin-bottom: var(--space-4);">
                        <!-- Rendered by JS -->
                    </div>

                    <div class="table-container">
                        <table class="table table-mobile-cards">
                            <thead>
                                <tr>
                                    <th>Document</th>
                                    <th>Category</th>
                                    <th>Site</th>
                                    <th>Version</th>
                                    <th>Effective</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="documents-tbody">
                                <!-- Rendered by JS -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Guard Performance Section -->
                <section class="page-section" id="section-performance" aria-label="Guard Performance">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <div class="search-bar">
                                <svg class="search-bar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                <input type="text" class="form-input" id="perf-search" placeholder="Search guards...">
                            </div>
                            <select class="form-select" id="perf-filter-status" style="width: auto;">
                                <option value="">All Status</option>
                                <option value="high-risk">ğŸ”´ High Risk</option>
                                <option value="watch">ğŸŸ¡ Watch</option>
                                <option value="good">ğŸŸ¢ Good Standing</option>
                            </select>
                            <select class="form-select" id="perf-filter-site" style="width: auto;">
                                <option value="">All Sites</option>
                            </select>
                            <select class="form-select" id="perf-period" style="width: auto;">
                                <option value="30">Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="180">Last 6 Months</option>
                                <option value="365">Last Year</option>
                            </select>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-secondary" id="export-perf-btn">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Export Report
                            </button>
                        </div>
                    </div>

                    <!-- Summary Stats -->
                    <div id="perf-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-3); margin-bottom: var(--space-5);">
                        <!-- Rendered by JS -->
                    </div>

                    <!-- Guard Scorecards -->
                    <div class="perf-scorecard" id="perf-scorecard">
                        <!-- Rendered by JS -->
                    </div>
                </section>

                <!-- Settings Section -->
                <!-- Export Center Section -->
                <section class="page-section" id="section-exports" aria-label="Export Center">
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <h2 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin: 0;">Export Center</h2>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-secondary action-export" onclick="ExportModule.exportFullBackup()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                                Full Backup (JSON)
                            </button>
                        </div>
                    </div>

                    <!-- Quick Export Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6);">
                        
                        <!-- Weekly Operations Report -->
                        <div class="card" style="cursor: pointer;" onclick="ExportModule.generateWeeklyReport()">
                            <div class="card-body" style="padding: var(--space-4);">
                                <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
                                    <div style="font-size: 2rem;">ğŸ“Š</div>
                                    <div>
                                        <h4 style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-1);">Weekly Ops Report</h4>
                                        <p class="text-sm text-muted">Coverage stats, incidents, call-offs, overtime summary for the past 7 days</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Incident Summary -->
                        <div class="card" style="cursor: pointer;" onclick="ExportModule.openIncidentExport()">
                            <div class="card-body" style="padding: var(--space-4);">
                                <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
                                    <div style="font-size: 2rem;">ğŸš¨</div>
                                    <div>
                                        <h4 style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-1);">Incident Report</h4>
                                        <p class="text-sm text-muted">Export incidents by date range, site, or severity</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Guard Roster -->
                        <div class="card" style="cursor: pointer;" onclick="ExportModule.exportGuardRoster()">
                            <div class="card-body" style="padding: var(--space-4);">
                                <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
                                    <div style="font-size: 2rem;">ğŸ‘¥</div>
                                    <div>
                                        <h4 style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-1);">Guard Roster</h4>
                                        <p class="text-sm text-muted">Full personnel list with contact info, certifications, sites</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Schedule Export -->
                        <div class="card" style="cursor: pointer;" onclick="ExportModule.openScheduleExport()">
                            <div class="card-body" style="padding: var(--space-4);">
                                <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
                                    <div style="font-size: 2rem;">ğŸ“…</div>
                                    <div>
                                        <h4 style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-1);">Schedule Export</h4>
                                        <p class="text-sm text-muted">Weekly schedule by site or guard with shift details</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payroll Report -->
                        <div class="card" style="cursor: pointer;" onclick="ExportModule.openPayrollExport()">
                            <div class="card-body" style="padding: var(--space-4);">
                                <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
                                    <div style="font-size: 2rem;">ğŸ’°</div>
                                    <div>
                                        <h4 style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-1);">Payroll/Hours Report</h4>
                                        <p class="text-sm text-muted">Guard hours, overtime, and billing summary</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Client Report -->
                        <div class="card" style="cursor: pointer;" onclick="ExportModule.openClientReport()">
                            <div class="card-body" style="padding: var(--space-4);">
                                <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
                                    <div style="font-size: 2rem;">ğŸ¢</div>
                                    <div>
                                        <h4 style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-1);">Client Site Report</h4>
                                        <p class="text-sm text-muted">Activity summary for a specific site (client-ready)</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Export Builder -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Custom Export Builder</h3>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4);">
                                
                                <!-- Date Range -->
                                <div class="form-group">
                                    <label class="form-label">Date Range</label>
                                    <select class="form-select" id="export-date-range" onchange="ExportModule.updateDateRange()">
                                        <option value="today">Today</option>
                                        <option value="yesterday">Yesterday</option>
                                        <option value="week" selected>This Week</option>
                                        <option value="lastweek">Last Week</option>
                                        <option value="month">This Month</option>
                                        <option value="lastmonth">Last Month</option>
                                        <option value="custom">Custom Range...</option>
                                    </select>
                                </div>

                                <div class="form-group" id="custom-date-start" style="display: none;">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" class="form-input" id="export-start-date">
                                </div>

                                <div class="form-group" id="custom-date-end" style="display: none;">
                                    <label class="form-label">End Date</label>
                                    <input type="date" class="form-input" id="export-end-date">
                                </div>

                                <!-- Site Filter -->
                                <div class="form-group">
                                    <label class="form-label">Site</label>
                                    <select class="form-select" id="export-site-filter">
                                        <option value="">All Sites</option>
                                    </select>
                                </div>

                                <!-- Format -->
                                <div class="form-group">
                                    <label class="form-label">Format</label>
                                    <select class="form-select" id="export-format">
                                        <option value="csv">CSV (Spreadsheet)</option>
                                        <option value="json">JSON (Data)</option>
                                        <option value="print">Print-Ready HTML</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Data Selection -->
                            <div style="margin-top: var(--space-4);">
                                <label class="form-label">Include Data</label>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--space-3); margin-top: var(--space-2);">
                                    <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                                        <input type="checkbox" id="export-inc-incidents" checked>
                                        <span>ğŸš¨ Incidents</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                                        <input type="checkbox" id="export-inc-schedule" checked>
                                        <span>ğŸ“… Schedule/Shifts</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                                        <input type="checkbox" id="export-inc-calloffs" checked>
                                        <span>ğŸ“µ Call-offs</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                                        <input type="checkbox" id="export-inc-inspections">
                                        <span>âœ… Inspections</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                                        <input type="checkbox" id="export-inc-supervisorlog">
                                        <span>ğŸ“ Supervisor Log</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                                        <input type="checkbox" id="export-inc-communications">
                                        <span>ğŸ“ Communications</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                                        <input type="checkbox" id="export-inc-dailyreports">
                                        <span>ğŸ“‹ Daily Reports</span>
                                    </label>
                                </div>
                            </div>

                            <div style="margin-top: var(--space-5); display: flex; gap: var(--space-3);">
                                <button class="btn btn-primary" onclick="ExportModule.runCustomExport()">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                    </svg>
                                    Export Selected Data
                                </button>
                                <button class="btn btn-secondary" onclick="ExportModule.previewExport()">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                    </svg>
                                    Preview
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Bulk Data Export -->
                    <div class="card" style="margin-top: var(--space-4);">
                        <div class="card-header">
                            <h3 class="card-title">Bulk Data Export (CSV)</h3>
                        </div>
                        <div class="card-body">
                            <p class="text-sm text-muted mb-4">Export complete datasets as CSV files for spreadsheet analysis or external system integration.</p>
                            <div style="display: flex; flex-wrap: wrap; gap: var(--space-3);">
                                <button class="btn btn-secondary" onclick="ExportModule.exportAllIncidents()">ğŸ“Š All Incidents</button>
                                <button class="btn btn-secondary" onclick="ExportModule.exportAllCalloffs()">ğŸ“µ All Call-offs</button>
                                <button class="btn btn-secondary" onclick="ExportModule.exportAllInspections()">âœ… All Inspections</button>
                                <button class="btn btn-secondary" onclick="ExportModule.exportAllContacts()">ğŸ“‡ All Contacts</button>
                                <button class="btn btn-secondary" onclick="ExportModule.exportAllSites()">ğŸ¢ All Sites</button>
                                <button class="btn btn-secondary" onclick="ExportModule.exportAllGuards()">ğŸ‘¤ All Guards</button>
                                <button class="btn btn-secondary" onclick="ExportModule.exportAllAvailability()">ğŸ“† All Availability</button>
                                <button class="btn btn-secondary" onclick="ExportModule.exportAllCommunications()">ğŸ“ All Communications</button>
                                <button class="btn btn-secondary" onclick="ExportModule.exportAllDocuments()">ğŸ“ All Documents</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                     TASKS SECTION - v6.8.6
                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <section class="page-section" id="section-tasks" aria-label="Tasks">
                    <div class="tasks-header">
                        <div class="tasks-header-left">
                            <div class="tasks-view-toggle">
                                <button class="tasks-view-btn active" data-view="board" onclick="TasksModule.setView('board')">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="vertical-align: middle;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/>
                                    </svg>
                                    Board
                                </button>
                                <button class="tasks-view-btn" data-view="list" onclick="TasksModule.setView('list')">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="vertical-align: middle;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                                    </svg>
                                    List
                                </button>
                                <button class="tasks-view-btn" data-view="calendar" onclick="TasksModule.setView('calendar')">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="vertical-align: middle;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                    Calendar
                                </button>
                            </div>
                        </div>
                        <div class="tasks-quick-add">
                            <input type="text" class="form-input" id="tasks-quick-input" placeholder="Quick add task... (press Enter)">
                            <button class="btn btn-primary" onclick="TasksModule.openTaskModal()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Add Task
                            </button>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="tasks-filters">
                        <div class="tasks-filter-group">
                            <label>Priority:</label>
                            <select class="form-select form-select-sm" id="tasks-filter-priority" onchange="TasksModule.render()">
                                <option value="">All</option>
                                <option value="p0">P0 - Critical</option>
                                <option value="p1">P1 - This Week</option>
                                <option value="p2">P2 - Later</option>
                            </select>
                        </div>
                        <div class="tasks-filter-group">
                            <label>Category:</label>
                            <select class="form-select form-select-sm" id="tasks-filter-category" onchange="TasksModule.render()">
                                <option value="">All</option>
                                <option value="training">Training</option>
                                <option value="meeting">Meeting</option>
                                <option value="coverage">Coverage</option>
                                <option value="admin">Admin</option>
                                <option value="errand">Errand</option>
                            </select>
                        </div>
                        <div class="tasks-filter-group">
                            <label>Owner:</label>
                            <select class="form-select form-select-sm" id="tasks-filter-owner" onchange="TasksModule.render()">
                                <option value="">All</option>
                            </select>
                        </div>
                        <div class="tasks-filter-group">
                            <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                                <input type="checkbox" id="tasks-filter-hide-done" onchange="TasksModule.render()">
                                Hide completed
                            </label>
                        </div>
                    </div>

                    <!-- Board View (Default) -->
                    <div id="tasks-view-board" class="tasks-board">
                        <div class="tasks-lane" data-lane="inbox">
                            <div class="tasks-lane-header">
                                <span class="tasks-lane-title">ğŸ“¥ Inbox</span>
                                <span class="tasks-lane-count" id="lane-count-inbox">0</span>
                            </div>
                            <div class="tasks-lane-items" id="lane-items-inbox"></div>
                        </div>
                        <div class="tasks-lane" data-lane="next">
                            <div class="tasks-lane-header">
                                <span class="tasks-lane-title">âš¡ Next</span>
                                <span class="tasks-lane-count" id="lane-count-next">0</span>
                            </div>
                            <div class="tasks-lane-items" id="lane-items-next"></div>
                        </div>
                        <div class="tasks-lane" data-lane="waiting">
                            <div class="tasks-lane-header">
                                <span class="tasks-lane-title">â³ Waiting</span>
                                <span class="tasks-lane-count" id="lane-count-waiting">0</span>
                            </div>
                            <div class="tasks-lane-items" id="lane-items-waiting"></div>
                        </div>
                        <div class="tasks-lane" data-lane="done">
                            <div class="tasks-lane-header">
                                <span class="tasks-lane-title">âœ… Done</span>
                                <span class="tasks-lane-count" id="lane-count-done">0</span>
                            </div>
                            <div class="tasks-lane-items" id="lane-items-done"></div>
                        </div>
                    </div>

                    <!-- List View -->
                    <div id="tasks-view-list" class="tasks-list" style="display: none;">
                        <div class="tasks-list-header">
                            <div></div>
                            <div>Task</div>
                            <div>Category</div>
                            <div>Priority</div>
                            <div>Due</div>
                            <div>Status</div>
                            <div>Owner</div>
                            <div></div>
                        </div>
                        <div id="tasks-list-items"></div>
                    </div>

                    <!-- Calendar View -->
                    <div id="tasks-view-calendar" class="tasks-calendar" style="display: none;">
                        <div class="tasks-calendar-header">
                            <div class="tasks-calendar-nav">
                                <button class="btn btn-ghost" onclick="TasksModule.calendarPrev()">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                    </svg>
                                </button>
                                <span class="tasks-calendar-title" id="tasks-calendar-title">December 2025</span>
                                <button class="btn btn-ghost" onclick="TasksModule.calendarNext()">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </button>
                            </div>
                            <button class="btn btn-secondary" onclick="TasksModule.calendarToday()">Today</button>
                        </div>
                        <div class="tasks-calendar-grid" id="tasks-calendar-grid">
                            <!-- Calendar populated by JS -->
                        </div>
                    </div>
                </section>

                <section class="page-section" id="section-settings" aria-label="Settings">
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--space-5);">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Appearance</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Theme</label>
                                    <select class="form-select" id="settings-theme">
                                        <option value="dark">Dark</option>
                                        <option value="light">Light</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">AI Assistant</h3>
                                <span class="badge badge-info">Optional</span>
                            </div>
                            <div class="card-body">
                                <p class="text-sm text-muted mb-4">Connect to Claude AI for intelligent operations
                                    assistance. Get your API key from <a href="https://console.anthropic.com/"
                                        target="_blank" rel="noopener">console.anthropic.com</a></p>

                                <div class="form-group">
                                    <label class="form-label">Anthropic API Key</label>
                                    <div style="position: relative;">
                                        <input type="password" class="form-input" id="settings-api-key"
                                            placeholder="sk-ant-api03-..." style="padding-right: 80px;">
                                        <button type="button" class="btn btn-sm btn-ghost"
                                            id="toggle-api-key-visibility"
                                            style="position: absolute; right: 4px; top: 50%; transform: translateY(-50%);">
                                            Show
                                        </button>
                                    </div>
                                    <span class="text-xs text-muted"
                                        style="margin-top: var(--space-1); display: block;">Your key is stored locally
                                        and never sent to any server except Anthropic.</span>
                                </div>

                                <div style="display: flex; gap: var(--space-2); margin-top: var(--space-3);">
                                    <button class="btn btn-primary" id="save-api-key">
                                        <svg width="16" height="16" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M5 13l4 4L19 7" />
                                        </svg>
                                        Save Key
                                    </button>
                                    <button class="btn btn-secondary" id="test-api-key">
                                        <svg width="16" height="16" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        Test Connection
                                    </button>
                                    <button class="btn btn-ghost" id="clear-api-key" title="Remove API Key">
                                        <svg width="16" height="16" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>

                                <div id="api-key-status" style="margin-top: var(--space-3); display: none;">
                                    <!-- Status message shown here -->
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">CSV Import</h3>
                                <span class="badge badge-info">Universal</span>
                            </div>
                            <div class="card-body">
                                <p class="text-sm text-muted mb-4">Import schedule, roster, or site data from CSV files.
                                    The system auto-detects the data type and maps fields automatically.</p>

                                <div class="csv-drop-zone" id="csv-drop-zone">
                                    <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                        style="opacity: 0.5; margin-bottom: var(--space-3);">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                    </svg>
                                    <p style="font-weight: var(--font-weight-medium); margin-bottom: var(--space-1);">
                                        Drop CSV file here</p>
                                    <p class="text-sm text-muted">or click to browse</p>
                                    <input type="file" id="csv-file-input" accept=".csv,.txt" style="display: none;">
                                </div>

                                <div class="mt-4" style="display: flex; gap: var(--space-3); flex-wrap: wrap;">
                                    <div class="text-xs text-muted"
                                        style="display: flex; align-items: center; gap: var(--space-2);">
                                        <span
                                            style="width: 8px; height: 8px; border-radius: 50%; background: var(--color-success);"></span>
                                        Schedules
                                    </div>
                                    <div class="text-xs text-muted"
                                        style="display: flex; align-items: center; gap: var(--space-2);">
                                        <span
                                            style="width: 8px; height: 8px; border-radius: 50%; background: var(--color-info);"></span>
                                        Guard Roster
                                    </div>
                                    <div class="text-xs text-muted"
                                        style="display: flex; align-items: center; gap: var(--space-2);">
                                        <span
                                            style="width: 8px; height: 8px; border-radius: 50%; background: var(--color-warning);"></span>
                                        Sites
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Data Management</h3>
                            </div>
                            <div class="card-body">
                                <div class="mb-4">
                                    <h4 class="font-semibold mb-2">Export Backup</h4>
                                    <p class="text-sm text-muted mb-2">Download all data as a JSON file for safekeeping.
                                    </p>
                                    <button class="btn btn-secondary" id="export-backup">
                                        <svg width="16" height="16" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                        </svg>
                                        Export Backup
                                    </button>
                                </div>

                                <div class="mb-4">
                                    <h4 class="font-semibold mb-2">Import Backup</h4>
                                    <p class="text-sm text-muted mb-2">Restore data from a previously exported JSON
                                        file.</p>
                                    <input type="file" id="import-backup-file" accept=".json" style="display: none;">
                                    <button class="btn btn-secondary" id="import-backup">
                                        <svg width="16" height="16" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                        </svg>
                                        Import Backup
                                    </button>
                                </div>

                                <!-- SOP MASTER IMPORT -->
                                <div class="mb-4" style="border-top: 1px solid var(--color-border); padding-top: var(--space-4); margin-top: var(--space-4);">
                                    <h4 class="font-semibold mb-2" style="display: flex; align-items: center; gap: var(--space-2);">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                        </svg>
                                        SOP Master Data
                                        <span class="badge badge-info">Site SOPs</span>
                                    </h4>
                                    <p class="text-sm text-muted mb-3">
                                        Import site SOP configuration from <code>sop_master.json</code>. This populates the SOP tab in Site Details.
                                    </p>

                                    <input type="file" id="import-sop-master-file" accept=".json" style="display: none;">

                                    <div style="display: flex; gap: var(--space-2); flex-wrap: wrap; align-items: center;">
                                        <button class="btn btn-primary" id="import-sop-master-btn">
                                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                            </svg>
                                            Import SOP Master
                                        </button>
                                        <button class="btn btn-secondary" id="clear-sop-imports-btn">
                                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                            Clear Imported
                                        </button>
                                        <span class="text-xs text-muted" id="sop-import-count" style="margin-left: var(--space-1);"></span>
                                    </div>

                                    <div id="sop-import-status" class="text-sm" style="display:none; margin-top: var(--space-3); padding: var(--space-3); border-radius: var(--radius-md); border: 1px solid var(--color-border); background: var(--color-surface-elevated);"></div>
                                </div>

                                
                                <div class="mb-4" style="border-top: 1px solid var(--color-border); padding-top: var(--space-4); margin-top: var(--space-4);">
                                    <h4 class="font-semibold mb-2" style="display: flex; align-items: center; gap: var(--space-2);">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m-6-8h6M7 4h10a2 2 0 012 2v14l-3-2-3 2-3-2-3 2V6a2 2 0 012-2z"/>
                                        </svg>
                                        SOP / Protocol Library
                                    </h4>
                                    <p class="text-sm text-muted mb-3">
                                        Import protocol JSON generated from site SOP documents. Supports merge, update, and replace modes.
                                    </p>

                                    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: var(--space-3); margin-bottom: var(--space-3);">
                                        <div class="form-group">
                                            <label class="form-label text-sm">Target Site</label>
                                            <select class="form-input" id="protocol-import-site" style="height: 40px;">
                                                <option value="">Auto-match from JSON</option>
                                            </select>
                                            <span class="text-xs text-muted" style="margin-top: var(--space-1); display: block;">
                                                Leave on auto to match by Site ID or Site Name from the JSON.
                                            </span>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label text-sm">Import Mode</label>
                                            <select class="form-input" id="protocol-import-mode" style="height: 40px;">
                                                <option value="merge">Merge (skip duplicates)</option>
                                                <option value="upsert">Merge (update duplicates)</option>
                                                <option value="replace-site">Replace target site protocols</option>
                                                <option value="replace-all">Replace all protocols</option>
                                            </select>
                                            <span class="text-xs text-muted" style="margin-top: var(--space-1); display: block;">
                                                Duplicate match uses Protocol ID when present, otherwise Title + Site.
                                            </span>
                                        </div>
                                    </div>

                                    <input type="file" id="import-protocols-file" accept=".json" style="display: none;">

                                    <div style="display: flex; gap: var(--space-2); flex-wrap: wrap; align-items: center;">
                                        <button class="btn btn-primary" id="import-protocols-btn">
                                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                            </svg>
                                            Import Protocols
                                        </button>
                                        <button class="btn btn-secondary" id="export-protocols-btn">
                                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                            </svg>
                                            Export Protocols
                                        </button>
                                        <span class="text-xs text-muted" id="protocols-count-label" style="margin-left: var(--space-1);"></span>
                                    </div>

                                    <div id="protocols-import-status" class="text-sm" style="display:none; margin-top: var(--space-3); padding: var(--space-3); border-radius: var(--radius-md); border: 1px solid var(--color-border); background: var(--color-surface-elevated);"></div>
                                </div>

                                <div class="mb-4" style="border-top: 1px solid var(--color-border); padding-top: var(--space-4); margin-top: var(--space-4);">
                                    <h4 class="font-semibold mb-2" style="display: flex; align-items: center; gap: var(--space-2);">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                                        </svg>
                                        Automated Cloud Backup
                                        <span class="badge badge-success">NEW</span>
                                    </h4>
                                    <p class="text-sm text-muted mb-3">
                                        Automatically backup to Google Drive daily at 3 AM. Requires one-time setup with Google Apps Script.
                                    </p>
                                    
                                    <div class="form-group mb-3">
                                        <label class="form-label text-sm">Google Apps Script Web App URL</label>
                                        <input type="url" class="form-input" id="cloud-backup-url" 
                                            placeholder="https://script.google.com/macros/s/.../exec"
                                            style="font-family: monospace; font-size: 0.875rem;">
                                        <span class="text-xs text-muted" style="margin-top: var(--space-1); display: block;">
                                            Paste the deployment URL from your Google Apps Script web app.
                                        </span>
                                    </div>

                                    <div style="display: flex; gap: var(--space-2); flex-wrap: wrap;">
                                        <button class="btn btn-primary" id="save-cloud-backup-url">
                                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                            </svg>
                                            Save URL
                                        </button>
                                        <button class="btn btn-secondary" id="test-cloud-backup">
                                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                            </svg>
                                            Test Backup Now
                                        </button>
                                        <button class="btn btn-ghost" id="view-backup-instructions" title="Setup Instructions">
                                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            Setup Guide
                                        </button>
                                    </div>

                                    <div id="cloud-backup-status" style="margin-top: var(--space-3); padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md); display: none;">
                                        <!-- Status shown here -->
                                    </div>
                                </div>

                                <div>
                                    <h4 class="font-semibold mb-2" style="color: var(--color-danger);">Clear All Data
                                    </h4>
                                    <p class="text-sm text-muted mb-2">Permanently delete all stored data. This cannot
                                        be undone.</p>
                                    <button class="btn btn-danger" id="clear-data">
                                        <svg width="16" height="16" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                        Clear All Data
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">About</h3>
                            </div>
                            <div class="card-body">
                                <p class="mb-2"><strong>Sentinel Ops</strong> <span id="about-version"></span></p>
                                <p class="text-sm text-muted mb-4">Security Operations Dashboard for Newark Operations â€” 150 Officers, 13 Sites
                                </p>
                                <p class="text-sm text-muted">All data is stored locally in your browser. No data is
                                    sent to external servers. Use the backup feature or CSV import to manage your data.
                                </p>
                            </div>
                        </div>

                        <!-- Client Portal Configuration -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Client Portal</h3>
                                <span class="badge badge-info">Read-Only Access</span>
                            </div>
                            <div class="card-body">
                                <p class="text-sm text-muted mb-4">Configure read-only portal access for property managers and clients to view their site activity.</p>
                                
                                <div class="form-group">
                                    <label class="form-label">Portal Access PINs</label>
                                    <p class="text-xs text-muted mb-2">Each site can have a unique PIN for client access.</p>
                                    <div id="portal-pins-list" style="display: grid; gap: var(--space-2); margin-bottom: var(--space-3);">
                                        <!-- Dynamically populated -->
                                    </div>
                                    <button class="btn btn-secondary btn-sm" onclick="ClientPortalModule.openPinManager()">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                        </svg>
                                        Manage Portal PINs
                                    </button>
                                </div>

                                <div style="margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--color-border);">
                                    <button class="btn btn-primary" onclick="ClientPortalModule.launchPortal()">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                        </svg>
                                        Launch Client Portal
                                    </button>
                                    <p class="text-xs text-muted mt-2">Opens portal in a new window. Share this with clients after setting up PIN access.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Client Portal Section (Hidden by default, shown via portal mode) -->
                <section class="page-section" id="section-portal" aria-label="Client Portal">
                    <div id="portal-login" style="max-width: 400px; margin: 60px auto;">
                        <div class="card">
                            <div class="card-body" style="padding: var(--space-6); text-align: center;">
                                <div style="font-size: 3rem; margin-bottom: var(--space-4);">ğŸ¢</div>
                                <h2 style="font-size: var(--font-size-xl); margin-bottom: var(--space-2);">Client Portal</h2>
                                <p class="text-muted mb-4">Newark Security Operations</p>
                                
                                <div class="form-group" style="text-align: left;">
                                    <label class="form-label">Access PIN</label>
                                    <input type="password" class="form-input" id="portal-pin-input" placeholder="Enter your 6-digit PIN" maxlength="6" style="text-align: center; font-size: var(--font-size-lg); letter-spacing: 0.5em;">
                                </div>
                                
                                <button class="btn btn-primary" style="width: 100%; margin-top: var(--space-3);" onclick="ClientPortalModule.authenticate()">
                                    Access Portal
                                </button>
                                
                                <p class="text-xs text-muted mt-4">Contact your security account manager if you need access credentials.</p>
                            </div>
                        </div>
                    </div>

                    <div id="portal-dashboard" style="display: none;">
                        <!-- Portal header -->
                        <div class="toolbar" style="margin-bottom: var(--space-4);">
                            <div class="toolbar-left">
                                <h2 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin: 0;">
                                    ğŸ¢ <span id="portal-site-name">Site Portal</span>
                                </h2>
                                <span class="badge badge-info" style="margin-left: var(--space-2);">Read-Only</span>
                            </div>
                            <div class="toolbar-right">
                                <span class="text-sm text-muted" id="portal-last-updated"></span>
                                <button class="btn btn-secondary btn-sm" onclick="ClientPortalModule.refresh()">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                    </svg>
                                    Refresh
                                </button>
                                <button class="btn btn-ghost btn-sm" onclick="ClientPortalModule.logout()" title="Exit Portal">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                    </svg>
                                    Logout
                                </button>
                            </div>
                        </div>

                        <!-- Portal Stats -->
                        <div class="quick-stats" id="portal-stats" style="margin-bottom: var(--space-5);">
                            <!-- Dynamically populated -->
                        </div>

                        <!-- Portal Tabs -->
                        <div class="card">
                            <div class="card-header" style="border-bottom: 1px solid var(--color-border);">
                                <div style="display: flex; gap: var(--space-1);">
                                    <button class="btn btn-ghost portal-tab active" data-tab="overview" onclick="ClientPortalModule.switchTab('overview')">Overview</button>
                                    <button class="btn btn-ghost portal-tab" data-tab="incidents" onclick="ClientPortalModule.switchTab('incidents')">Incidents</button>
                                    <button class="btn btn-ghost portal-tab" data-tab="coverage" onclick="ClientPortalModule.switchTab('coverage')">Coverage</button>
                                    <button class="btn btn-ghost portal-tab" data-tab="inspections" onclick="ClientPortalModule.switchTab('inspections')">Inspections</button>
                                    <button class="btn btn-ghost portal-tab" data-tab="communications" onclick="ClientPortalModule.switchTab('communications')">Communications</button>
                                </div>
                            </div>
                            <div class="card-body" id="portal-tab-content">
                                <!-- Tab content rendered here -->
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container" role="alert" aria-live="polite"></div>

    <!-- Scroll to Top Button -->
    <button class="scroll-top-btn" id="scroll-top-btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" aria-label="Scroll to top" title="Back to top">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
        </svg>
    </button>

    <!-- Modals -->
    <div class="modal-backdrop" id="modal-backdrop">
        <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Modal Title</h2>
                <button class="modal-close" onclick="UI.closeModal()" aria-label="Close modal">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer" id="modal-footer">
                <!-- Dynamic buttons -->
            </div>
        </div>
    </div>

    <!-- Help Modal Content Template -->
    <template id="help-content">
        <div style="max-width: 700px; max-height: 70vh; overflow-y: auto;">
            <h3 style="margin-bottom: var(--space-4); font-size: var(--font-size-lg);"><span id="onboarding-version">Sentinel Ops</span> â€” Complete
                Guide</h3>

            <!-- Command Palette / Search Section -->
            <div
                style="margin-bottom: var(--space-6); padding: var(--space-4); background: linear-gradient(135deg, var(--color-primary-bg), var(--color-surface-elevated)); border-radius: var(--radius-lg); border: 1px solid var(--color-primary);">
                <h4
                    style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-3); color: var(--color-primary);">
                    ğŸ” Universal Search (Command Palette)</h4>
                <p class="text-sm" style="margin-bottom: var(--space-3);">Press <span class="kbd">Ctrl</span>+<span
                        class="kbd">K</span> or click the search bar to access <strong>everything</strong> in Sentinel
                    Ops:</p>
                <div style="display: grid; gap: var(--space-2); padding-left: var(--space-3);">
                    <div class="text-sm"><strong>Navigate:</strong> Dashboard, Scheduler, Incidents, Inspections,
                        Supervisor Log, Call-offs, Sites, Contacts, Roster, Availability, Reports, Analytics, Settings
                    </div>
                    <div class="text-sm"><strong>Quick Actions:</strong> New Incident, Add Guard, Add Contact, Log
                        Call-off, New Inspection</div>
                    <div class="text-sm"><strong>Tools:</strong> Export Backup, Toggle Theme, Undo, AI Assistant, Help
                    </div>
                    <div class="text-sm"><strong>Dynamic Search:</strong> Type any guard name, site, contact, or
                        incident to find it instantly</div>
                </div>
            </div>

            <!-- Keyboard Shortcuts Section -->
            <div
                style="margin-bottom: var(--space-6); padding: var(--space-4); background: var(--color-surface-elevated); border-radius: var(--radius-lg); border: 1px solid var(--color-border);">
                <h4 style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-3);">âŒ¨ï¸ Keyboard
                    Shortcuts</h4>
                <div style="display: grid; gap: var(--space-2);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="text-sm text-muted">Open Command Palette / Search</span>
                        <div><span class="kbd">Ctrl</span> + <span class="kbd">K</span></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="text-sm text-muted">Undo last action</span>
                        <div><span class="kbd">Ctrl</span> + <span class="kbd">Z</span></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="text-sm text-muted">Export backup</span>
                        <div><span class="kbd">Ctrl</span> + <span class="kbd">S</span></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="text-sm text-muted">Go to Dashboard</span>
                        <div><span class="kbd">Ctrl</span> + <span class="kbd">D</span></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="text-sm text-muted">Navigate Command Palette</span>
                        <div><span class="kbd">â†‘</span> <span class="kbd">â†“</span> + <span class="kbd">Enter</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="text-sm text-muted">Close modal/dialog</span>
                        <div><span class="kbd">Esc</span></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="text-sm text-muted">Print current view</span>
                        <div><span class="kbd">Ctrl</span> + <span class="kbd">P</span></div>
                    </div>
                </div>
                <div style="margin-top: var(--space-3); padding-top: var(--space-3); border-top: 1px solid var(--color-border);">
                    <p class="text-xs text-muted" style="margin-bottom: var(--space-2);">Quick Navigation (when not typing):</p>
                    <div style="display: flex; gap: var(--space-4); flex-wrap: wrap;">
                        <span class="text-sm"><span class="kbd">H</span> Home</span>
                        <span class="text-sm"><span class="kbd">S</span> Scheduler</span>
                        <span class="text-sm"><span class="kbd">I</span> Incidents</span>
                        <span class="text-sm"><span class="kbd">?</span> Help</span>
                    </div>
                </div>
            </div>

            <!-- Modules Overview -->
            <div style="margin-bottom: var(--space-6);">
                <h4 style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4);">ğŸ“¦ Module Guide
                </h4>

                <div style="display: grid; gap: var(--space-4);">
                    <div
                        style="padding: var(--space-3); background: var(--color-surface); border-radius: var(--radius-md); border: 1px solid var(--color-border-subtle);">
                        <h5
                            style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2); display: flex; align-items: center; gap: var(--space-2);">
                            ğŸ“Š Dashboard</h5>
                        <p class="text-sm text-muted">Real-time operational overview with KPI cards, quick log entry,
                            recent incidents, and site status grid. Your command center.</p>
                    </div>

                    <div
                        style="padding: var(--space-3); background: var(--color-surface); border-radius: var(--radius-md); border: 1px solid var(--color-border-subtle);">
                        <h5
                            style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2); display: flex; align-items: center; gap: var(--space-2);">
                            ğŸ“… Scheduler</h5>
                        <p class="text-sm text-muted">Weekly shift calendar by site. Click any cell to assign guards,
                            mark shifts as OPEN, or add notes. Navigate weeks with arrow buttons.</p>
                    </div>

                    <div
                        style="padding: var(--space-3); background: var(--color-surface); border-radius: var(--radius-md); border: 1px solid var(--color-border-subtle);">
                        <h5
                            style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2); display: flex; align-items: center; gap: var(--space-2);">
                            âš ï¸ Incidents</h5>
                        <p class="text-sm text-muted">Log security incidents with site, guards involved, severity,
                            narrative, and status. Filter by status/severity. Full edit and delete capability.</p>
                    </div>

                    <div
                        style="padding: var(--space-3); background: var(--color-surface); border-radius: var(--radius-md); border: 1px solid var(--color-border-subtle);">
                        <h5
                            style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2); display: flex; align-items: center; gap: var(--space-2);">
                            âœ… Inspections</h5>
                        <p class="text-sm text-muted">Comprehensive site inspection forms with checklist, notes, and
                            digital signatures. Auto-generates inspection IDs. View inspection history.</p>
                    </div>

                    <div
                        style="padding: var(--space-3); background: var(--color-surface); border-radius: var(--radius-md); border: 1px solid var(--color-border-subtle);">
                        <h5
                            style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2); display: flex; align-items: center; gap: var(--space-2);">
                            ğŸ“ Supervisor's Log</h5>
                        <p class="text-sm text-muted">Daily shift notes with follow-up tracking. Mark items as needing
                            follow-up, filter by open/resolved. Resolve with notes when complete.</p>
                    </div>

                    <div
                        style="padding: var(--space-3); background: var(--color-surface); border-radius: var(--radius-md); border: 1px solid var(--color-border-subtle);">
                        <h5
                            style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2); display: flex; align-items: center; gap: var(--space-2);">
                            ğŸ“µ Call-off Log</h5>
                        <p class="text-sm text-muted">Track guard absences with reason, coverage status
                            (Pending/Covered/Uncovered), and replacement guard assignment.</p>
                    </div>

                    <div
                        style="padding: var(--space-3); background: var(--color-surface); border-radius: var(--radius-md); border: 1px solid var(--color-border-subtle);">
                        <h5
                            style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2); display: flex; align-items: center; gap: var(--space-2);">
                            ğŸ¢ Sites</h5>
                        <p class="text-sm text-muted">Manage all site locations with code, address, shift times, and
                            post orders. Search and filter. Edit or delete sites.</p>
                    </div>

                    <div
                        style="padding: var(--space-3); background: var(--color-surface); border-radius: var(--radius-md); border: 1px solid var(--color-border-subtle);">
                        <h5
                            style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2); display: flex; align-items: center; gap: var(--space-2);">
                            ğŸ“‡ Contacts</h5>
                        <p class="text-sm text-muted">Centralized contact directory with 8 categories: ğŸš¨ Emergency, ğŸ¢ Clients, ğŸ‘” Internal, ğŸ”§ Vendors, âš¡ Utility, ğŸ›ï¸ Government, âš–ï¸ Legal, ğŸ  Residents. Link contacts to sites for quick lookup during incidents.</p>
                    </div>

                    <div
                        style="padding: var(--space-3); background: var(--color-surface); border-radius: var(--radius-md); border: 1px solid var(--color-border-subtle);">
                        <h5
                            style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2); display: flex; align-items: center; gap: var(--space-2);">
                            ğŸ‘¥ Guard Roster</h5>
                        <p class="text-sm text-muted">Personnel management with name, phone, role
                            (Armed/Unarmed/Floater/Supervisor), status (Active/On Leave/Suspended/Terminated), and
                            primary site assignments.</p>
                    </div>

                    <div
                        style="padding: var(--space-3); background: var(--color-surface); border-radius: var(--radius-md); border: 1px solid var(--color-border-subtle);">
                        <h5
                            style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2); display: flex; align-items: center; gap: var(--space-2);">
                            ğŸ“† Availability</h5>
                        <p class="text-sm text-muted">Submit and view guard availability by week. Guards can mark days
                            as Available, Preferred, Unavailable, or Request Off. Team overview shows coverage at a
                            glance.</p>
                    </div>

                    <div
                        style="padding: var(--space-3); background: var(--color-surface); border-radius: var(--radius-md); border: 1px solid var(--color-border-subtle);">
                        <h5
                            style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2); display: flex; align-items: center; gap: var(--space-2);">
                            ğŸ“‹ Daily Reports</h5>
                        <p class="text-sm text-muted">End-of-shift reports by site with guard, shift time, patrol count,
                            and narrative. Filter by site or date range.</p>
                    </div>

                    <div
                        style="padding: var(--space-3); background: var(--color-surface); border-radius: var(--radius-md); border: 1px solid var(--color-border-subtle);">
                        <h5
                            style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2); display: flex; align-items: center; gap: var(--space-2);">
                            ğŸ“ˆ Analytics</h5>
                        <p class="text-sm text-muted">Operational insights including incident trends by type/severity,
                            site performance metrics, and guard activity statistics.</p>
                    </div>

                    <div
                        style="padding: var(--space-3); background: var(--color-surface); border-radius: var(--radius-md); border: 1px solid var(--color-border-subtle);">
                        <h5
                            style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2); display: flex; align-items: center; gap: var(--space-2);">
                            âš™ï¸ Settings</h5>
                        <p class="text-sm text-muted">Theme toggle (Dark/Light), AI Assistant API key configuration, CSV
                            Import for bulk data, Export/Import backups, and data management.</p>
                    </div>
                </div>
            </div>

            <!-- AI Assistant Section -->
            <div
                style="margin-bottom: var(--space-6); padding: var(--space-4); background: var(--color-surface-elevated); border-radius: var(--radius-lg); border: 1px solid var(--color-border);">
                <h4 style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-3);">ğŸ¤– AI Operations
                    Assistant</h4>
                <p class="text-sm text-muted" style="margin-bottom: var(--space-3);">Click the AI button in the header
                    or search "AI Assistant" to open. Requires an Anthropic API key (configure in Settings).</p>
                <div class="text-sm text-muted"><strong>Capabilities:</strong></div>
                <ul
                    style="list-style: none; padding: 0; margin: var(--space-2) 0 0 var(--space-3); display: grid; gap: var(--space-1);">
                    <li class="text-sm text-muted">â€¢ Find available guards for coverage</li>
                    <li class="text-sm text-muted">â€¢ Analyze incident patterns and trends</li>
                    <li class="text-sm text-muted">â€¢ Generate operational reports</li>
                    <li class="text-sm text-muted">â€¢ Scheduling recommendations</li>
                    <li class="text-sm text-muted">â€¢ Compliance and alert monitoring</li>
                </ul>
            </div>

            <!-- Data Management Section -->
            <div
                style="margin-bottom: var(--space-6); padding: var(--space-4); background: var(--color-surface-elevated); border-radius: var(--radius-lg); border: 1px solid var(--color-border);">
                <h4 style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-3);">ğŸ’¾ Data Management
                </h4>
                <div style="display: grid; gap: var(--space-3);">
                    <div>
                        <div class="text-sm" style="font-weight: var(--font-weight-medium);">Local Storage</div>
                        <p class="text-sm text-muted">All data is stored in your browser's local storage. Clearing
                            browser data will erase everything â€” always keep backups!</p>
                    </div>
                    <div>
                        <div class="text-sm" style="font-weight: var(--font-weight-medium);">Auto-Backup</div>
                        <p class="text-sm text-muted">Automatic backup every 4 hours to localStorage. Manual backup
                            reminder after 7 days without export.</p>
                    </div>
                    <div>
                        <div class="text-sm" style="font-weight: var(--font-weight-medium);">CSV Import</div>
                        <p class="text-sm text-muted">Import schedules, guards, or sites from CSV files. The system
                            auto-detects data type and maps columns automatically.</p>
                    </div>
                    <div>
                        <div class="text-sm" style="font-weight: var(--font-weight-medium);">Undo System</div>
                        <p class="text-sm text-muted">Last 50 actions are saved. Press Ctrl+Z to undo deletions, edits,
                            or additions.</p>
                    </div>
                </div>
            </div>

            <!-- Pro Tips -->
            <div
                style="padding: var(--space-4); background: var(--color-info-bg); border-radius: var(--radius-lg); border: 1px solid var(--color-info);">
                <h4
                    style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-2); color: var(--color-info);">
                    ğŸ’¡ Pro Tips</h4>
                <ul style="list-style: none; padding: 0; margin: 0; display: grid; gap: var(--space-2);">
                    <li class="text-sm" style="color: var(--color-info);">â€¢ <strong>Ctrl+K opens Command Palette, Ctrl+Shift+K opens Console</strong>
                        â€” search anything, navigate anywhere, take any action</li>
                    <li class="text-sm" style="color: var(--color-info);">â€¢ Click phone numbers in Contacts to call
                        directly (on mobile)</li>
                    <li class="text-sm" style="color: var(--color-info);">â€¢ Use Command Palette to search guards by
                        phone number</li>
                    <li class="text-sm" style="color: var(--color-info);">â€¢ Export backups regularly to Dropbox, Google
                        Drive, or USB</li>
                    <li class="text-sm" style="color: var(--color-info);">â€¢ Print any page with Ctrl+P for clean,
                        professional output</li>
                </ul>
            </div>
        </div>
    </template>


    <!-- Keyboard Shortcut Hint -->
    <div class="keyboard-hint" id="keyboard-hint">
        Press <span class="kbd">Ctrl</span>+<span class="kbd">K</span> to search |
        <span class="kbd">Ctrl</span>+<span class="kbd">Z</span> to undo |
        <span class="kbd">Esc</span> to close
    </div>

    <!-- AI Command Console -->
    <div id="ai-console-overlay" class="ai-console-overlay" hidden>
        <div class="ai-console-panel" role="dialog" aria-modal="true" aria-labelledby="ai-console-title">
            <div class="ai-console-header">
                <div>
                    <div id="ai-console-title" class="ai-console-title">Operations Console</div>
                    <div class="ai-console-subtitle">Search, commands, and AI in one place</div>
                </div>
                <button type="button" class="ai-console-close-btn" id="ai-console-close-btn" aria-label="Close (Esc)">âœ•</button>
            </div>

            <div class="ai-console-context-bar" id="ai-console-context-bar">
                <span id="ai-console-context-module">Module: â€”</span>
                <span id="ai-console-context-site">Site: â€”</span>
                <span id="ai-console-context-date">Date: â€”</span>
                <span id="ai-console-context-guard">Guard: â€”</span>
            </div>

            <div class="ai-console-shortcuts">
                <button type="button" class="ai-console-chip" data-command="/who-can-cover">
                    Coverage help
                </button>
                <button type="button" class="ai-console-chip" data-command="/incidents-summary">
                    Incident summary
                </button>
                <button type="button" class="ai-console-chip" data-command="/daily-ops">
                    Daily ops report
                </button>
            </div>

            <div class="ai-console-tabs">
                <button type="button" class="ai-console-tab ai-console-tab-active" data-tab="assistant">Ops Assistant</button>
                <button type="button" class="ai-console-tab" data-tab="shortcuts">Shortcuts</button>
                <button type="button" class="ai-console-tab" data-tab="raw">Raw Output</button>
            </div>

            <div class="ai-console-body">
                <div id="ai-console-output" class="ai-console-output" aria-live="polite">
                    <div class="ai-console-output-block">
                        <div class="ai-console-output-label">System</div>
                        <div class="ai-console-output-text">Operations Console ready.
Type a command like /who-can-cover or ask a question.

Available commands:
  /who-can-cover â€” find guards for coverage
  /incidents-summary â€” summarize recent incidents
  /daily-ops â€” build daily operations report</div>
                    </div>
                </div>
            </div>

            <div class="ai-console-input-row">
                <input
                    id="ai-console-input"
                    class="ai-console-input"
                    type="text"
                    placeholder="Type a command (e.g. /who-can-cover) or ask a questionâ€¦"
                    autocomplete="off"
                />
                <button type="button" id="ai-console-send-btn" class="ai-console-send-btn" title="Send (Enter)">
                    Enter
                </button>
            </div>

            <div class="ai-console-hints">
                <span>/who-can-cover â€” find coverage for the current shift</span>
                <span>/incidents-summary â€” summarize recent incidents</span>
                <span>/daily-ops â€” build a daily ops summary</span>
                <span>Ctrl+Shift+K â€” open console</span>
            </div>
        </div>
    </div>

    <!-- Command Palette -->
    <div class="command-backdrop" id="command-backdrop">
        <div class="command-box">
            <!-- Search Input -->
            <div class="command-input-wrap">
                <svg class="command-input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" class="command-input" id="command-input"
                    placeholder="Search commands, guards, sites..." autocomplete="off" spellcheck="false">
                <kbd class="kbd" style="margin-left: auto; opacity: 0.6;">Esc</kbd>
            </div>

            <!-- Results -->
            <div class="command-results" id="command-results" aria-live="polite" aria-label="Search results">
                <!-- Rendered by JavaScript -->
            </div>

            <!-- Footer -->
            <div class="command-footer">
                <div class="command-footer-group">
                    <div class="command-footer-hint">
                        <span class="kbd">â†‘</span><span class="kbd">â†“</span>
                        <span>Navigate</span>
                    </div>
                    <div class="command-footer-hint">
                        <span class="kbd">â†µ</span>
                        <span>Select</span>
                    </div>
                </div>
                <div class="command-footer-group">
                    <span id="app-version-display">Sentinel Ops</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SENTINEL OPS v4.0 â€” JavaScript Core
           Newark Security Operations Dashboard
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // APP VERSION â€” Single source of truth for version number
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const APP_VERSION = '6.19.2';
        const APP_NAME = 'Sentinel Ops';
        const APP_FULL_NAME = `${APP_NAME} v${APP_VERSION}`;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ENHANCED FEATURES v4.6 â€” UNDO, AUTO-BACKUP, SEARCH
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const UndoManager = {
            stack: [],
            maxSize: 50,
            enabled: true,

            push: function (action) {
                if (!this.enabled) return;

                try {
                    const snapshot = {
                        action: action,
                        timestamp: Date.now(),
                        data: JSON.stringify({
                            sites: DataStore.getSites() || [],
                            guards: DataStore.getGuards() || [],
                            schedules: DataStore.getSchedules() || [],
                            incidents: DataStore.getIncidents() || [],
                            inspections: DataStore.getInspections() || [],
                            supervisorLog: DataStore.getSupervisorLog() || [],
                            calloffs: DataStore.getCalloffs() || []
                        })
                    };

                    this.stack.push(snapshot);

                    if (this.stack.length > this.maxSize) {
                        this.stack.shift();
                    }

                    localStorage.setItem('sentinel_undo_stack', JSON.stringify(this.stack.map(s => ({
                        action: s.action,
                        timestamp: s.timestamp,
                        data: s.data
                    }))));
                } catch (e) {
                    console.warn('Undo stack full, clearing oldest:', e);
                    this.stack = this.stack.slice(-25);
                }
            },

            undo: function () {
                if (this.stack.length === 0) {
                    UI.toast('Nothing to Undo', 'No actions available to undo', 'info');
                    return;
                }

                const snapshot = this.stack.pop();

                this.enabled = false;
                try {
                    const data = JSON.parse(snapshot.data);
                    DataStore.importSites(data.sites || []);
                    DataStore.importGuards(data.guards || []);
                    DataStore.importSchedules(data.schedules || []);
                    DataStore.importIncidents(data.incidents || []);
                    DataStore.importInspections(data.inspections || []);
                    DataStore.importSupervisorLog(data.supervisorLog || []);
                    DataStore.importCalloffs(data.calloffs || []);
                } catch (e) {
                    console.error('Undo failed:', e);
                }
                this.enabled = true;

                localStorage.setItem('sentinel_undo_stack', JSON.stringify(this.stack));

                Router.refresh();

                UI.toast('Undo Complete', `Reverted: ${snapshot.action}`, 'success');
            },

            loadStack: function () {
                try {
                    const saved = localStorage.getItem('sentinel_undo_stack');
                    if (saved) {
                        this.stack = JSON.parse(saved);
                    }
                } catch (e) {
                    this.stack = [];
                }
            },

            clear: function () {
                this.stack = [];
                localStorage.removeItem('sentinel_undo_stack');
            }
        };

        const BackupReminder = {
            check: function () {
                const lastBackup = localStorage.getItem('sentinel_last_manual_backup');
                if (!lastBackup) return;

                const daysSince = (Date.now() - parseInt(lastBackup)) / (1000 * 60 * 60 * 24);
                if (daysSince >= 7) {
                    UI.toast('Backup Reminder',
                        `Last manual backup was ${Math.floor(daysSince)} days ago. Consider exporting from Settings.`,
                        'warning');
                }
            },

            markManualBackup: function () {
                localStorage.setItem('sentinel_last_manual_backup', Date.now().toString());
            }
        };

        const SearchUtility = {
            createSearchBox: function (id, placeholder = 'Search...') {
                return `
                <div class="search-box" id="${id}-container">
                    <svg class="search-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input type="text" class="search-input" id="${id}" placeholder="${placeholder}" />
                    <button class="search-clear" onclick="SearchUtility.clearSearch('${id}')">Clear</button>
                </div>
            `;
            },

            attachToTable: function (inputId, tableId) {
                const input = document.getElementById(inputId);
                const container = document.getElementById(`${inputId}-container`);

                if (!input) return;

                input.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    const table = document.getElementById(tableId);

                    if (!table) return;

                    const rows = table.querySelectorAll('tbody tr:not(.no-results-row)');
                    let visibleCount = 0;

                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        const match = text.includes(query);
                        row.style.display = match ? '' : 'none';
                        if (match) visibleCount++;
                    });

                    if (query) {
                        container.classList.add('has-value');
                    } else {
                        container.classList.remove('has-value');
                    }

                    this.updateNoResults(tableId, visibleCount);
                });
            },

            clearSearch: function (inputId) {
                const input = document.getElementById(inputId);
                const container = document.getElementById(`${inputId}-container`);

                if (input) {
                    input.value = '';
                    input.dispatchEvent(new Event('input'));
                    container.classList.remove('has-value');
                }
            },

            updateNoResults: function (tableId, visibleCount) {
                const table = document.getElementById(tableId);
                if (!table) return;

                let noResultsRow = table.querySelector('.no-results-row');

                if (visibleCount === 0) {
                    if (!noResultsRow) {
                        const tbody = table.querySelector('tbody');
                        noResultsRow = document.createElement('tr');
                        noResultsRow.className = 'no-results-row';
                        noResultsRow.innerHTML = `
                        <td colspan="100" style="text-align: center; padding: var(--space-8); color: var(--color-text-muted);">
                            No results found
                        </td>
                    `;
                        tbody.appendChild(noResultsRow);
                    }
                    noResultsRow.style.display = '';
                } else {
                    if (noResultsRow) {
                        noResultsRow.style.display = 'none';
                    }
                }
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SVG ICON MAP â€” Clean stroke icons for command palette (v6.19.1)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const SVG_ICONS = {
            'ğŸ ': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
            'ğŸ“…': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
            'âœ…': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>',
            'âš ï¸': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
            'ğŸ“': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
            'ğŸ“': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',
            'ğŸ“µ': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72"/><line x1="1" y1="1" x2="23" y2="23"/></svg>',
            'ğŸ¢': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><path d="M9 22v-4h6v4"/><line x1="8" y1="6" x2="8" y2="6.01"/><line x1="12" y1="6" x2="12" y2="6.01"/><line x1="16" y1="6" x2="16" y2="6.01"/><line x1="8" y1="10" x2="8" y2="10.01"/><line x1="12" y1="10" x2="12" y2="10.01"/><line x1="16" y1="10" x2="16" y2="10.01"/><line x1="8" y1="14" x2="8" y2="14.01"/><line x1="12" y1="14" x2="12" y2="14.01"/><line x1="16" y1="14" x2="16" y2="14.01"/></svg>',
            'ğŸ“‡': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
            'ğŸ‘¥': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
            'ğŸ“†': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/></svg>',
            'ğŸ“‹': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>',
            'ğŸ“ˆ': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
            'ğŸ“': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>',
            'ğŸ“Š': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>',
            'â°': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
            'âš™ï¸': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
            'ğŸ“¤': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',
            'ğŸš¨': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
            'â•': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
            'ğŸ—ï¸': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="12" y1="6" x2="12" y2="18"/><line x1="8" y1="10" x2="16" y2="10"/></svg>',
            'ğŸ”': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>',
            'ğŸ“„': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
            'ğŸ•': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
            'ğŸ”§': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',
            'ğŸ”’': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',
            'ğŸ“¥': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
            'ğŸ”„': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>',
            'ğŸ—‘ï¸': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
            'ğŸ’¾': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>',
            'ğŸ›¡ï¸': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
            'â“': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
            'ğŸ¯': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
            'âŒ¨ï¸': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M6 12h.01M18 12h.01M8 16h8"/></svg>',
            'ğŸ“–': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>'
        };

        // Helper to get SVG icon or fallback to emoji
        function getSvgIcon(emoji) {
            return SVG_ICONS[emoji] || `<span style="font-size:1.1rem">${emoji}</span>`;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // COMMAND PALETTE â€” Spotlight-style Global Search (v4.7)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const CommandPalette = {
            isOpen: false,
            selectedIndex: 0,
            results: [],

            // Static commands available in the palette
            commands: [
                // Navigation
                { id: 'nav-dashboard', title: 'Go to Dashboard', desc: 'View operational overview (H)', action: () => Router.navigate('dashboard'), category: 'Navigation', icon: 'ğŸ ' },
                { id: 'nav-scheduler', title: 'Go to Scheduler', desc: 'Weekly shift scheduling (S)', action: () => Router.navigate('scheduler'), category: 'Navigation', icon: 'ğŸ“…' },
                { id: 'nav-tasks', title: 'Go to Tasks', desc: 'Task management (T)', action: () => Router.navigate('tasks'), category: 'Navigation', icon: 'âœ…' },
                { id: 'nav-incidents', title: 'Go to Incidents', desc: 'Incident reports log (I)', action: () => Router.navigate('incidents'), category: 'Navigation', icon: 'âš ï¸' },
                { id: 'nav-inspections', title: 'Go to Inspections', desc: 'Site inspection records', action: () => Router.navigate('inspections'), category: 'Navigation', icon: 'âœ…' },
                { id: 'nav-supervisorlog', title: 'Go to Supervisor Log', desc: 'Daily supervisor notes', action: () => Router.navigate('supervisorlog'), category: 'Navigation', icon: 'ğŸ“' },
                { id: 'nav-commslog', title: 'Go to Communications Log', desc: 'Phone calls, emails, meetings', action: () => Router.navigate('commslog'), category: 'Navigation', icon: 'ğŸ“' },
                { id: 'nav-calloffs', title: 'Go to Call-off Log', desc: 'Absence tracking', action: () => Router.navigate('calloffs'), category: 'Navigation', icon: 'ğŸ“µ' },
                { id: 'nav-sites', title: 'Go to Sites', desc: 'Manage site locations', action: () => Router.navigate('sites'), category: 'Navigation', icon: 'ğŸ¢' },
                { id: 'nav-contacts', title: 'Go to Contacts', desc: 'Staff, clients, and vendors', action: () => Router.navigate('contacts'), category: 'Navigation', icon: 'ğŸ“‡' },
                { id: 'nav-roster', title: 'Go to Guard Roster', desc: 'Personnel management', action: () => Router.navigate('roster'), category: 'Navigation', icon: 'ğŸ‘¥' },
                { id: 'nav-availability', title: 'Go to Availability', desc: 'Guard scheduling availability', action: () => Router.navigate('availability'), category: 'Navigation', icon: 'ğŸ“†' },
                { id: 'nav-reports', title: 'Go to Daily Reports', desc: 'Shift reports and summaries', action: () => Router.navigate('reports'), category: 'Navigation', icon: 'ğŸ“‹' },
                { id: 'nav-analytics', title: 'Go to Analytics', desc: 'Operational insights', action: () => Router.navigate('analytics'), category: 'Navigation', icon: 'ğŸ“ˆ' },
                { id: 'nav-documents', title: 'Go to Document Vault', desc: 'Contracts, licenses, site documents', action: () => Router.navigate('documents'), category: 'Navigation', icon: 'ğŸ“' },
                { id: 'nav-sop', title: 'Go to SOP Library', desc: 'SOPs, post orders, procedures', action: () => { Router.navigate('documents'); DocumentsModule.filterByType('sop'); }, category: 'Navigation', icon: 'ğŸ“‹' },
                { id: 'nav-performance', title: 'Go to Guard Performance', desc: 'Scorecards, metrics, discipline tracking', action: () => Router.navigate('performance'), category: 'Navigation', icon: 'ğŸ“Š' },
                { id: 'nav-overtime', title: 'View Overtime Tracker', desc: 'See guard hours and OT status', action: () => OvertimeModule.openTracker(), category: 'Navigation', icon: 'â°' },
                { id: 'nav-settings', title: 'Go to Settings', desc: 'System configuration', action: () => Router.navigate('settings'), category: 'Navigation', icon: 'âš™ï¸' },
                { id: 'nav-exports', title: 'Go to Export Center', desc: 'Reports, data exports, backups', action: () => Router.navigate('exports'), category: 'Navigation', icon: 'ğŸ“¤' },
                { id: 'nav-portal', title: 'Launch Client Portal', desc: 'Read-only client access', action: () => ClientPortalModule.launchPortal(), category: 'Navigation', icon: 'ğŸ¢' },

                // Quick Actions
                { id: 'act-new-shift', title: 'Add New Shift', desc: 'Add a shift to the schedule', action: () => { Router.navigate('scheduler'); setTimeout(() => SchedulerModule.openAddShiftModal(), 150); }, category: 'Quick Actions', icon: 'ğŸ“…' },
                { id: 'act-new-task', title: 'New Task', desc: 'Add a task to your list', action: () => { Router.navigate('tasks'); setTimeout(() => TasksModule.openTaskModal(), 150); }, category: 'Quick Actions', icon: 'âœ…' },
                { id: 'act-new-incident', title: 'New Incident Report', desc: 'Log a new security incident', action: () => { Router.navigate('incidents'); setTimeout(() => document.getElementById('new-incident-btn')?.click(), 150); }, category: 'Quick Actions', icon: 'ğŸš¨' },
                { id: 'act-new-guard', title: 'Add New Guard', desc: 'Register a new officer', action: () => { Router.navigate('roster'); setTimeout(() => document.getElementById('new-guard-btn')?.click(), 150); }, category: 'Quick Actions', icon: 'â•' },
                { id: 'act-new-site', title: 'Add New Site', desc: 'Register a new location', action: () => { Router.navigate('sites'); setTimeout(() => document.getElementById('new-site-btn')?.click(), 150); }, category: 'Quick Actions', icon: 'ğŸ—ï¸' },
                { id: 'act-new-contact', title: 'Add New Contact', desc: 'Add staff, client, or vendor', action: () => { Router.navigate('contacts'); setTimeout(() => document.getElementById('new-contact-btn')?.click(), 150); }, category: 'Quick Actions', icon: 'ğŸ“‡' },
                { id: 'act-log-calloff', title: 'Log Call-off', desc: 'Record guard absence', action: () => { Router.navigate('calloffs'); setTimeout(() => document.getElementById('new-calloff-btn')?.click(), 150); }, category: 'Quick Actions', icon: 'ğŸ“' },
                { id: 'act-new-inspection', title: 'New Inspection', desc: 'Start a site inspection', action: () => { Router.navigate('inspections'); setTimeout(() => document.getElementById('new-inspection-btn')?.click(), 150); }, category: 'Quick Actions', icon: 'ğŸ”' },
                { id: 'act-new-log', title: 'New Log Entry', desc: 'Add supervisor log note', action: () => { Router.navigate('supervisorlog'); setTimeout(() => document.getElementById('new-log-btn')?.click(), 150); }, category: 'Quick Actions', icon: 'ğŸ“' },
                { id: 'act-new-comm', title: 'Log Communication', desc: 'Record phone call, email, meeting', action: () => { Router.navigate('commslog'); setTimeout(() => document.getElementById('new-comm-btn')?.click(), 150); }, category: 'Quick Actions', icon: 'ğŸ“' },
                { id: 'act-new-report', title: 'New Daily Report', desc: 'Submit shift report', action: () => { Router.navigate('reports'); setTimeout(() => document.getElementById('new-report-btn')?.click(), 150); }, category: 'Quick Actions', icon: 'ğŸ“‹' },
                { id: 'act-new-document', title: 'Add New Document', desc: 'Add SOP, contract, or license', action: () => { Router.navigate('documents'); setTimeout(() => document.getElementById('new-document-btn')?.click(), 150); }, category: 'Quick Actions', icon: 'ğŸ“„' },
                { id: 'act-date-lookup', title: 'SOP Date Lookup', desc: 'Find which SOPs were active on a specific date', action: () => { Router.navigate('documents'); setTimeout(() => DocumentsModule.openLookupModal(), 150); }, category: 'Quick Actions', icon: 'ğŸ•' },
                { id: 'act-warning-notice', title: 'Employee Warning Notice', desc: 'Create a formal write-up document', action: () => WarningNoticeModule.open(), category: 'Quick Actions', icon: 'âš ï¸' },
                { id: 'act-coverage-suggestions', title: 'Find Available Guards', desc: 'AI-ranked suggestions by availability, certifications, fatigue', action: () => CoverageSuggestionEngine.openQuickSuggest(), category: 'Quick Actions', icon: 'ğŸ¯' },
                { id: 'act-fatigue-report', title: 'Fatigue Report', desc: 'View guard workload and fatigue alerts', action: () => FatigueModule.openReport(), category: 'Quick Actions', icon: 'ğŸ˜°' },

                // Tools
                { id: 'tool-export', title: 'Export Backup', desc: 'Download all data as JSON', action: () => SettingsModule.exportBackup(), category: 'Tools', icon: 'ğŸ’¾' },
                { id: 'tool-weekly-report', title: 'Weekly Ops Report', desc: 'Generate weekly summary report', action: () => ExportModule.generateWeeklyReport(), category: 'Tools', icon: 'ğŸ“Š' },
                { id: 'tool-export-center', title: 'Open Export Center', desc: 'Custom reports and data exports', action: () => Router.navigate('exports'), category: 'Tools', icon: 'ğŸ“¤' },
                { id: 'tool-portal-pins', title: 'Manage Portal PINs', desc: 'Configure client access PINs', action: () => ClientPortalModule.openPinManager(), category: 'Tools', icon: 'ğŸ”' },
                { id: 'tool-import', title: 'Import CSV', desc: 'Import data from CSV file', action: () => { Router.navigate('settings'); setTimeout(() => document.getElementById('csv-file-input')?.click(), 150); }, category: 'Tools', icon: 'ğŸ“¥' },
                { id: 'tool-theme', title: 'Toggle Theme', desc: 'Switch between dark and light mode', action: () => { const t = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light'; SettingsModule.setTheme(t); }, category: 'Tools', icon: 'ğŸŒ“' },
                { id: 'tool-privacy', title: 'Toggle Privacy Mode', desc: 'Blur sensitive info (names, phones, addresses)', action: () => document.getElementById('privacy-toggle')?.click(), category: 'Tools', icon: 'ğŸ‘ï¸' },
                { id: 'tool-undo', title: 'Undo Last Action', desc: 'Revert the most recent change', action: () => UndoManager.undo(), category: 'Tools', icon: 'â†©ï¸' },
                { id: 'tool-ai', title: 'Open AI Assistant', desc: 'Get intelligent operations help', action: () => AIAssistant.togglePanel(), category: 'Tools', icon: 'ğŸ¤–' },
                { id: 'tool-search-address', title: 'Look Up Address', desc: 'Search for an address on Google Maps', action: () => QuickSearch.openAddressSearch(), category: 'Web Search', icon: 'ğŸ“' },
                { id: 'tool-search-weather', title: 'Check Weather', desc: 'Current weather for Newark NJ', action: () => QuickSearch.openWeather(), category: 'Web Search', icon: 'ğŸŒ¤ï¸' },
                { id: 'tool-search-news', title: 'Local News', desc: 'Newark area news headlines', action: () => QuickSearch.openNews(), category: 'Web Search', icon: 'ğŸ“°' },
                { id: 'tool-search-web', title: 'Web Search', desc: 'Search Google for anything', action: () => QuickSearch.openSearch(), category: 'Web Search', icon: 'ğŸ”' },
                { id: 'tool-help', title: 'Show Help', desc: 'View complete guide and shortcuts', action: () => document.getElementById('help-btn')?.click(), category: 'Tools', icon: 'â“' },
            ],

            init: function () {
                const input = document.getElementById('command-input');
                const backdrop = document.getElementById('command-backdrop');
                const resultsContainer = document.getElementById('command-results');

                if (!input || !backdrop || !resultsContainer) {
                    console.warn('Command Palette: Required elements not found');
                    return;
                }

                // Debounced search on input
                input.addEventListener('input', Utils.debounce((e) => {
                    this.search(e.target.value);
                }, 150));

                // Event delegation for result clicks
                resultsContainer.addEventListener('click', (e) => {
                    const item = e.target.closest('.command-item');
                    if (item) {
                        const idx = parseInt(item.dataset.idx, 10);
                        if (!isNaN(idx)) {
                            this.execute(idx);
                        }
                    }
                });

                // Mouse hover to select
                resultsContainer.addEventListener('mouseover', (e) => {
                    const item = e.target.closest('.command-item');
                    if (item) {
                        const idx = parseInt(item.dataset.idx, 10);
                        if (!isNaN(idx) && idx !== this.selectedIndex) {
                            this.selectedIndex = idx;
                            this.updateSelection();
                        }
                    }
                });

                // Keyboard controls within input
                input.addEventListener('keydown', (e) => {
                    switch (e.key) {
                        case 'ArrowUp':
                            e.preventDefault();
                            this.navigate('up');
                            break;
                        case 'ArrowDown':
                            e.preventDefault();
                            this.navigate('down');
                            break;
                        case 'Enter':
                            e.preventDefault();
                            this.execute();
                            break;
                        case 'Escape':
                            this.close();
                            break;
                        case 'Tab':
                            e.preventDefault();
                            this.navigate(e.shiftKey ? 'up' : 'down');
                            break;
                    }
                });

                // Click outside to close
                backdrop.addEventListener('click', (e) => {
                    if (e.target === backdrop) this.close();
                });

                // Global shortcut âŒ˜K / Ctrl+K
                document.addEventListener('keydown', (e) => {
                    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                        // Block Command Palette in client portal mode
                        if (typeof RoleContext !== 'undefined' && RoleContext.isPortalMode()) {
                            e.preventDefault();
                            return;
                        }
                        e.preventDefault();
                        this.toggle();
                    }
                });

                // Search trigger button
                const triggerBtn = document.getElementById('search-trigger-btn');
                if (triggerBtn) {
                    triggerBtn.addEventListener('click', () => this.open());
                }

                console.log('âŒ˜ Command Palette initialized (Ctrl/Cmd+K to open)');
            },

            toggle: function () {
                this.isOpen ? this.close() : this.open();
            },

            open: function () {
                this.isOpen = true;
                this.selectedIndex = 0;
                this.results = [];

                const backdrop = document.getElementById('command-backdrop');
                const input = document.getElementById('command-input');

                backdrop.classList.add('active');
                document.body.style.overflow = 'hidden';
                input.value = '';

                // Render default commands
                this.render();

                // Focus input after animation
                setTimeout(() => input.focus(), 50);
            },

            close: function () {
                this.isOpen = false;
                document.getElementById('command-backdrop').classList.remove('active');
                document.body.style.overflow = '';
            },

            search: function (query) {
                const q = query.toLowerCase().trim();

                if (!q) {
                    this.results = [];
                    this.selectedIndex = 0;
                    this.render();
                    return;
                }

                try {
                // Filter static commands
                let matches = this.commands.filter(cmd =>
                    cmd.title.toLowerCase().includes(q) ||
                    cmd.desc.toLowerCase().includes(q) ||
                    cmd.category.toLowerCase().includes(q)
                );

                // Search guards dynamically
                const guards = DataStore.getGuards() || [];
                const guardMatches = guards
                    .filter(g =>
                        (g.name && g.name.toLowerCase().includes(q)) ||
                        (g.phone && g.phone.includes(q)) ||
                        (g.role && g.role.toLowerCase().includes(q))
                    )
                    .slice(0, 6)
                    .map(g => ({
                        id: 'guard-' + g.id,
                        title: g.name || 'Unknown Guard',
                        desc: `${this.formatRole(g.role)} â€¢ ${Utils.formatPhone(g.phone) || 'No phone'} â€¢ ${this.formatStatus(g.status)}`,
                        action: () => {
                            Router.navigate('roster');
                            setTimeout(() => RosterModule.editGuard(g.id), 150);
                        },
                        category: 'Guards',
                        icon: this.getGuardIcon(g.role),
                        badge: g.status
                    }));

                // Search sites dynamically
                const sites = DataStore.getSites() || [];
                const siteMatches = sites
                    .filter(s =>
                        (s.name && s.name.toLowerCase().includes(q)) ||
                        (s.code && s.code.toLowerCase().includes(q)) ||
                        (s.address && s.address.toLowerCase().includes(q))
                    )
                    .slice(0, 5)
                    .map(s => ({
                        id: 'site-' + s.id,
                        title: s.name || 'Unknown Site',
                        desc: `${s.code || 'No code'} â€¢ ${s.address || 'No address'}`,
                        action: () => {
                            Router.navigate('sites');
                            setTimeout(() => SitesModule.viewSite(s.id), 150);
                        },
                        category: 'Sites',
                        icon: 'ğŸ¢'
                    }));

                // Search contacts dynamically
                const contacts = DataStore.getContacts() || [];
                const contactMatches = contacts
                    .filter(c =>
                        (c.name && c.name.toLowerCase().includes(q)) ||
                        (c.company && c.company.toLowerCase().includes(q)) ||
                        (c.role && c.role.toLowerCase().includes(q)) ||
                        (c.phone && c.phone.includes(q)) ||
                        (c.email && c.email.toLowerCase().includes(q))
                    )
                    .slice(0, 5)
                    .map(c => ({
                        id: 'contact-' + c.id,
                        title: c.name || 'Unknown Contact',
                        desc: `${c.role || c.category || ''} â€¢ ${c.company || ''} â€¢ ${Utils.formatPhone(c.phone) || c.email || ''}`.replace(/ â€¢ $/, '').replace(/ â€¢  â€¢ /, ' â€¢ '),
                        action: () => {
                            Router.navigate('contacts');
                            setTimeout(() => ContactsModule.editContact(c.id), 150);
                        },
                        category: 'Contacts',
                        icon: c.category === 'internal' ? 'ğŸ‘”' : c.category === 'client' ? 'ğŸ¢' : 'ğŸ› ï¸'
                    }));

                // Search recent incidents dynamically
                const incidents = DataStore.getIncidents() || [];
                const incidentMatches = incidents
                    .filter(i =>
                        (i.type && i.type.toLowerCase().includes(q)) ||
                        (i.description && i.description.toLowerCase().includes(q))
                    )
                    .slice(0, 4)
                    .map(i => {
                        const site = DataStore.getSiteById(i.siteId);
                        return {
                            id: 'incident-' + i.id,
                            title: `${i.type || 'Unknown'} Incident`,
                            desc: `${site?.name || 'Unknown Site'} â€¢ ${Utils.formatDate(i.date)}`,
                            action: () => {
                                Router.navigate('incidents');
                                setTimeout(() => IncidentsModule.viewIncident(i.id), 150);
                            },
                            category: 'Incidents',
                            icon: this.getSeverityIcon(i.severity)
                        };
                    });

                // Combine results
                this.results = [...matches, ...guardMatches, ...siteMatches, ...contactMatches, ...incidentMatches];
                this.selectedIndex = 0;
                this.render();
                } catch (err) {
                    console.error('[CommandPalette] Search error:', err);
                    this.results = [];
                    this.render();
                }
            },

            render: function () {
                const container = document.getElementById('command-results');
                const items = this.results.length > 0 ? this.results : this.commands.slice(0, 10);

                if (items.length === 0) {
                    container.innerHTML = `
                    <div class="command-empty">
                        <div class="command-empty-icon">ğŸ”</div>
                        <p>No results found</p>
                    </div>
                `;
                    return;
                }

                // Group by category
                const grouped = {};
                items.forEach(item => {
                    if (!grouped[item.category]) grouped[item.category] = [];
                    grouped[item.category].push(item);
                });

                let html = '';
                let idx = 0;

                Object.entries(grouped).forEach(([category, categoryItems]) => {
                    html += `<div class="command-section">
                    <div class="command-section-title">${Utils.escapeHtml(category)}</div>`;

                    categoryItems.forEach(item => {
                        const isSelected = idx === this.selectedIndex;
                        html += `
                        <div class="command-item${isSelected ? ' selected' : ''}" 
                             data-idx="${idx}">
                            <div class="command-item-icon">${getSvgIcon(item.icon)}</div>
                            <div class="command-item-content">
                                <div class="command-item-title">${Utils.escapeHtml(item.title)}</div>
                                <div class="command-item-desc">${Utils.escapeHtml(item.desc)}</div>
                            </div>
                            ${item.badge ? `<div class="command-item-badge">${Utils.escapeHtml(item.badge)}</div>` : ''}
                        </div>`;
                        idx++;
                    });

                    html += '</div>';
                });

                container.innerHTML = html;

                // Scroll selected item into view
                this.scrollToSelected();
            },

            updateSelection: function () {
                const container = document.getElementById('command-results');
                const items = container.querySelectorAll('.command-item');
                items.forEach((item, idx) => {
                    item.classList.toggle('selected', idx === this.selectedIndex);
                });
                this.scrollToSelected();
            },

            setSelected: function (idx) {
                this.selectedIndex = idx;
                this.updateSelection();
            },

            navigate: function (direction) {
                const items = this.results.length > 0 ? this.results : this.commands.slice(0, 10);
                const max = items.length - 1;

                if (direction === 'up') {
                    this.selectedIndex = this.selectedIndex > 0 ? this.selectedIndex - 1 : max;
                } else {
                    this.selectedIndex = this.selectedIndex < max ? this.selectedIndex + 1 : 0;
                }

                this.updateSelection();
            },

            scrollToSelected: function () {
                const container = document.getElementById('command-results');
                const selected = container.querySelector('.command-item.selected');
                if (selected) {
                    selected.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
            },

            execute: function (idx = this.selectedIndex) {
                const items = this.results.length > 0 ? this.results : this.commands.slice(0, 10);
                const item = items[idx];

                if (item?.action) {
                    this.close();
                    item.action();
                }
            },

            // Helper methods for formatting
            formatRole: function (role) {
                const roles = {
                    'armed': 'ğŸ›¡ï¸ Armed',
                    'unarmed': 'ğŸ‘¤ Unarmed',
                    'supervisor': 'â­ Supervisor',
                    'floater': 'ğŸ”„ Floater'
                };
                return roles[role] || role || 'Unknown';
            },

            formatStatus: function (status) {
                const statuses = {
                    'active': 'âœ… Active',
                    'on_leave': 'ğŸ–ï¸ On Leave',
                    'suspended': 'âš ï¸ Suspended',
                    'terminated': 'âŒ Terminated'
                };
                return statuses[status] || status || 'Unknown';
            },

            getGuardIcon: function (role) {
                const icons = {
                    'armed': 'ğŸ›¡ï¸',
                    'unarmed': 'ğŸ‘¤',
                    'supervisor': 'â­',
                    'floater': 'ğŸ”„'
                };
                return icons[role] || 'ğŸ‘¤';
            },

            getSeverityIcon: function (severity) {
                const icons = {
                    'critical': 'ğŸ”´',
                    'high': 'ğŸŸ ',
                    'medium': 'ğŸŸ¡',
                    'low': 'ğŸŸ¢'
                };
                return icons[severity] || 'âš ï¸';
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AI OPERATIONS ASSISTANT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // QUICK SEARCH â€” Web lookups with styled modals
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const QuickSearch = {
            // Default location for weather/news
            location: 'Newark, NJ',
            weatherApiKey: null, // Optional: Add OpenWeatherMap API key for embedded weather

            openSearch: function () {
                const content = `
                    <div class="form-group">
                        <label class="form-label">What do you want to search for?</label>
                        <input type="text" class="form-input" id="quick-search-query" placeholder="Enter search query..." autofocus>
                    </div>
                    <div class="text-sm text-muted mt-2">
                        <p>Press Enter to search on Google</p>
                    </div>
                `;
                
                UI.modal('ğŸ” Web Search', content, [
                    { text: 'Cancel', class: 'btn-secondary', action: () => UI.closeModal() },
                    { text: 'Search', class: 'btn-primary', action: () => {
                        const query = document.getElementById('quick-search-query').value.trim();
                        if (query) {
                            window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
                            UI.closeModal();
                        } else {
                            UI.toast('Enter a search query', '', 'warning');
                        }
                    }}
                ]);
                
                // Focus input and handle Enter key
                setTimeout(() => {
                    const input = document.getElementById('quick-search-query');
                    if (input) {
                        input.focus();
                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                const query = input.value.trim();
                                if (query) {
                                    window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
                                    UI.closeModal();
                                }
                            }
                        });
                    }
                }, 100);
            },

            openAddressSearch: function () {
                const sites = DataStore.getSites();
                const siteOptions = sites.map(s => `<option value="${Utils.escapeHtml(s.address || s.name)}">${Utils.escapeHtml(s.name)}</option>`).join('');
                
                const content = `
                    <div class="form-group">
                        <label class="form-label">Quick select a site</label>
                        <select class="form-select" id="address-site-select">
                            <option value="">â€” Or enter custom address below â€”</option>
                            ${siteOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address or Place Name</label>
                        <input type="text" class="form-input" id="address-search-input" placeholder="123 Main St, Newark NJ..." autofocus>
                    </div>
                    <div class="text-sm text-muted mt-2">
                        <p>ğŸ“ Opens in Google Maps</p>
                    </div>
                `;
                
                UI.modal('ğŸ“ Address Lookup', content, [
                    { text: 'Cancel', class: 'btn-secondary', action: () => UI.closeModal() },
                    { text: 'Open in Maps', class: 'btn-primary', action: () => {
                        const input = document.getElementById('address-search-input').value.trim();
                        const select = document.getElementById('address-site-select').value;
                        const address = input || select;
                        if (address) {
                            window.open(`https://www.google.com/maps/search/${encodeURIComponent(address)}`, '_blank');
                            UI.closeModal();
                        } else {
                            UI.toast('Enter an address', '', 'warning');
                        }
                    }}
                ]);
                
                // Handle site select change
                setTimeout(() => {
                    const select = document.getElementById('address-site-select');
                    const input = document.getElementById('address-search-input');
                    if (select && input) {
                        select.addEventListener('change', () => {
                            if (select.value) {
                                input.value = select.value;
                            }
                        });
                        input.focus();
                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                const address = input.value.trim() || select.value;
                                if (address) {
                                    window.open(`https://www.google.com/maps/search/${encodeURIComponent(address)}`, '_blank');
                                    UI.closeModal();
                                }
                            }
                        });
                    }
                }, 100);
            },

            openWeather: function () {
                const content = `
                    <div style="text-align: center; padding: var(--space-4);">
                        <div style="font-size: 48px; margin-bottom: var(--space-3);">ğŸŒ¤ï¸</div>
                        <h3 style="margin: 0 0 var(--space-2) 0; font-size: var(--font-size-xl);">Newark, NJ Weather</h3>
                        <p class="text-muted mb-4">Get current conditions and forecast</p>
                        
                        <div id="weather-content" style="margin: var(--space-4) 0;">
                            <div class="quick-stats" style="grid-template-columns: repeat(2, 1fr); gap: var(--space-3);">
                                <div class="stat-card" onclick="QuickSearch.openWeatherLink('current')" style="cursor: pointer;">
                                    <div style="font-size: 24px; margin-bottom: var(--space-2);">ğŸŒ¡ï¸</div>
                                    <div class="stat-label">Current Weather</div>
                                </div>
                                <div class="stat-card" onclick="QuickSearch.openWeatherLink('forecast')" style="cursor: pointer;">
                                    <div style="font-size: 24px; margin-bottom: var(--space-2);">ğŸ“…</div>
                                    <div class="stat-label">7-Day Forecast</div>
                                </div>
                                <div class="stat-card" onclick="QuickSearch.openWeatherLink('radar')" style="cursor: pointer;">
                                    <div style="font-size: 24px; margin-bottom: var(--space-2);">ğŸ›°ï¸</div>
                                    <div class="stat-label">Radar Map</div>
                                </div>
                                <div class="stat-card" onclick="QuickSearch.openWeatherLink('alerts')" style="cursor: pointer;">
                                    <div style="font-size: 24px; margin-bottom: var(--space-2);">âš ï¸</div>
                                    <div class="stat-label">Weather Alerts</div>
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-xs text-muted">Click any option to open in new tab</p>
                    </div>
                `;
                
                UI.modal('ğŸŒ¤ï¸ Weather', content, [
                    { text: 'Close', class: 'btn-secondary', action: () => UI.closeModal() },
                    { text: 'Open Full Weather', class: 'btn-primary', action: () => {
                        window.open(`https://weather.com/weather/today/l/Newark+NJ`, '_blank');
                        UI.closeModal();
                    }}
                ]);
            },
            
            openWeatherLink: function(type) {
                const links = {
                    current: 'https://weather.com/weather/today/l/Newark+NJ',
                    forecast: 'https://weather.com/weather/tenday/l/Newark+NJ',
                    radar: 'https://weather.com/weather/radar/interactive/l/Newark+NJ',
                    alerts: 'https://weather.com/weather/alerts/l/Newark+NJ'
                };
                window.open(links[type] || links.current, '_blank');
                UI.closeModal();
            },

            openNews: function () {
                const content = `
                    <div style="text-align: center; padding: var(--space-4);">
                        <div style="font-size: 48px; margin-bottom: var(--space-3);">ğŸ“°</div>
                        <h3 style="margin: 0 0 var(--space-4) 0; font-size: var(--font-size-xl);">News Sources</h3>
                        
                        <div class="quick-stats" style="grid-template-columns: 1fr; gap: var(--space-3);">
                            <div class="stat-card" onclick="QuickSearch.openNewsLink('local')" style="cursor: pointer; text-align: left; padding: var(--space-3);">
                                <div style="display: flex; align-items: center; gap: var(--space-3);">
                                    <span style="font-size: 24px;">ğŸ™ï¸</span>
                                    <div>
                                        <div class="font-medium">Newark Local News</div>
                                        <div class="text-xs text-muted">Latest news from Newark area</div>
                                    </div>
                                </div>
                            </div>
                            <div class="stat-card" onclick="QuickSearch.openNewsLink('security')" style="cursor: pointer; text-align: left; padding: var(--space-3);">
                                <div style="display: flex; align-items: center; gap: var(--space-3);">
                                    <span style="font-size: 24px;">ğŸ›¡ï¸</span>
                                    <div>
                                        <div class="font-medium">NJ Security News</div>
                                        <div class="text-xs text-muted">Security industry updates</div>
                                    </div>
                                </div>
                            </div>
                            <div class="stat-card" onclick="QuickSearch.openNewsLink('general')" style="cursor: pointer; text-align: left; padding: var(--space-3);">
                                <div style="display: flex; align-items: center; gap: var(--space-3);">
                                    <span style="font-size: 24px;">ğŸŒ</span>
                                    <div>
                                        <div class="font-medium">General News</div>
                                        <div class="text-xs text-muted">Top stories from Google News</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                UI.modal('ğŸ“° News', content, [
                    { text: 'Close', class: 'btn-secondary', action: () => UI.closeModal() }
                ]);
            },
            
            openNewsLink: function(type) {
                const links = {
                    local: `https://news.google.com/search?q=${encodeURIComponent('Newark NJ news')}&hl=en-US`,
                    security: `https://news.google.com/search?q=${encodeURIComponent('New Jersey security news')}&hl=en-US`,
                    general: 'https://news.google.com/?hl=en-US&gl=US&ceid=US:en'
                };
                window.open(links[type] || links.local, '_blank');
                UI.closeModal();
            },

            // Search for a specific site's address
            searchSiteAddress: function (siteName) {
                window.open(`https://www.google.com/maps/search/${encodeURIComponent(siteName + ' Newark NJ')}`, '_blank');
            },

            // Search for business info
            searchBusiness: function (businessName) {
                window.open(`https://www.google.com/search?q=${encodeURIComponent(businessName + ' Newark NJ')}`, '_blank');
            }
        };

        const AIAssistant = {
            isOpen: false,
            conversationHistory: [],
            isProcessing: false,

            init: function () {
                // Setup input field enter key handler
                const input = document.getElementById('ai-input');
                if (input) {
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });
                }

                // Check API key state on init
                this.updateInputState();

                console.log('ğŸ¤– AI Assistant initialized');
            },

            updateInputState: function () {
                const input = document.getElementById('ai-input');
                const sendBtn = document.getElementById('ai-send-btn');
                const apiKey = localStorage.getItem('sentinel_api_key');

                if (input) {
                    if (!apiKey) {
                        input.disabled = true;
                        input.placeholder = 'API key required â€” configure in Settings';
                        if (sendBtn) sendBtn.disabled = true;
                    } else {
                        input.disabled = false;
                        input.placeholder = 'Ask about operations, shifts, guards... (Ctrl+Enter to send)';
                        if (sendBtn) sendBtn.disabled = false;
                    }
                }
            },

            togglePanel: function () {
                const panel = document.getElementById('ai-assistant-panel');

                // Check API key state when opening
                this.updateInputState();

                this.isOpen = !this.isOpen;

                if (this.isOpen) {
                    panel.classList.add('open');
                    document.body.style.overflow = 'hidden';

                    // Focus input when opening
                    setTimeout(() => {
                        document.getElementById('ai-input')?.focus();
                    }, 100);
                } else {
                    panel.classList.remove('open');
                    document.body.style.overflow = '';
                }
            },

            sendMessage: function () {
                const input = document.getElementById('ai-input');
                const message = input?.value.trim();

                if (!message || this.isProcessing) return;

                // Add user message to UI
                this.addMessage(message, 'user');

                // Clear input
                input.value = '';
                input.style.height = 'auto';

                // Show typing indicator
                this.showTyping(true);

                // Process the message
                this.processMessage(message);
            },

            addMessage: function (content, type = 'assistant') {
                const messagesContainer = document.getElementById('ai-messages');

                const messageDiv = document.createElement('div');
                messageDiv.className = `ai-message ai-${type}`;

                const icon = type === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';

                messageDiv.innerHTML = `
                <div class="ai-message-icon">${icon}</div>
                <div class="ai-message-content">${this.formatMessage(content)}</div>
            `;

                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            },

            formatMessage: function (content) {
                // SECURITY FIX v6.8: Escape HTML BEFORE applying formatting
                content = Utils.escapeHtml(content);
                // Basic markdown-like formatting (now safe)
                content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                content = content.replace(/\n/g, '<br>');

                // Convert bullet points
                content = content.replace(/^- (.+)$/gm, '<li>$1</li>');
                if (content.includes('<li>')) {
                    content = content.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
                }

                return content;
            },

            showTyping: function (show) {
                const typingIndicator = document.getElementById('ai-typing');
                if (typingIndicator) {
                    typingIndicator.style.display = show ? 'flex' : 'none';
                }
            },

            async processMessage(userMessage) {
                this.isProcessing = true;

                try {
                    // Check for API key
                    const apiKey = localStorage.getItem('sentinel_api_key');
                    if (!apiKey) {
                        this.showTyping(false);
                        this.addMessage(
                            'âš ï¸ **API Key Required**\n\nTo use the AI Assistant, please add your Anthropic API key in **Settings â†’ AI Assistant**.\n\nYou can get an API key from [console.anthropic.com](https://console.anthropic.com/)',
                            'assistant'
                        );
                        this.isProcessing = false;
                        return;
                    }

                    // Gather current context
                    const context = this.gatherContext();

                    // Build prompt with context
                    const systemPrompt = this.buildSystemPrompt(context);
                    
                    // Get tool definitions
                    const tools = this.getToolDefinitions();

                    // Call Claude API with tools
                    let response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "x-api-key": apiKey,
                            "anthropic-version": "2023-06-01",
                            "anthropic-dangerous-direct-browser-access": "true"
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 2000,
                            system: systemPrompt,
                            tools: tools,
                            messages: [
                                ...this.conversationHistory,
                                { role: "user", content: userMessage }
                            ]
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMsg = errorData.error?.message || `API request failed: ${response.status}`;
                        throw new Error(errorMsg);
                    }

                    let data = await response.json();
                    
                    // Handle tool use if needed
                    let messages = [
                        ...this.conversationHistory,
                        { role: "user", content: userMessage }
                    ];
                    
                    // Process tool calls in a loop (in case of multiple tool calls)
                    while (data.stop_reason === 'tool_use') {
                        // Find tool use blocks
                        const toolUseBlocks = data.content.filter(block => block.type === 'tool_use');
                        
                        // Execute each tool and collect results
                        const toolResults = [];
                        for (const toolUse of toolUseBlocks) {
                            console.log('Executing tool:', toolUse.name, toolUse.input);
                            const result = this.executeTool(toolUse.name, toolUse.input);
                            console.log('Tool result:', result);
                            toolResults.push({
                                type: 'tool_result',
                                tool_use_id: toolUse.id,
                                content: JSON.stringify(result)
                            });
                        }
                        
                        // Add assistant's tool use message and our tool results
                        messages.push({ role: "assistant", content: data.content });
                        messages.push({ role: "user", content: toolResults });
                        
                        // Call API again with tool results
                        response = await fetch("https://api.anthropic.com/v1/messages", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "x-api-key": apiKey,
                                "anthropic-version": "2023-06-01",
                                "anthropic-dangerous-direct-browser-access": "true"
                            },
                            body: JSON.stringify({
                                model: "claude-sonnet-4-20250514",
                                max_tokens: 2000,
                                system: systemPrompt,
                                tools: tools,
                                messages: messages
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.error?.message || `API request failed: ${response.status}`);
                        }
                        
                        data = await response.json();
                    }
                    
                    // Extract text response
                    const textBlocks = data.content.filter(block => block.type === 'text');
                    const assistantMessage = textBlocks.map(block => block.text).join('\n');

                    // Update conversation history (simplified - just user message and final response)
                    this.conversationHistory.push(
                        { role: "user", content: userMessage },
                        { role: "assistant", content: assistantMessage }
                    );

                    // Keep history manageable (last 10 messages)
                    if (this.conversationHistory.length > 20) {
                        this.conversationHistory = this.conversationHistory.slice(-20);
                    }

                    // Hide typing and show response
                    this.showTyping(false);
                    this.addMessage(assistantMessage, 'assistant');
                    
                    // Refresh the scheduler view if we modified schedules
                    if (Router.currentRoute === 'scheduler') {
                        SchedulerModule.render();
                    }

                } catch (error) {
                    console.error('AI Assistant error:', error);
                    this.showTyping(false);

                    let errorMessage = 'âŒ Sorry, I encountered an error processing your request.';
                    if (error.message.includes('invalid_api_key') || error.message.includes('Invalid API')) {
                        errorMessage = 'âŒ **Invalid API Key**\n\nYour API key appears to be invalid. Please check it in **Settings â†’ AI Assistant**.';
                    } else if (error.message.includes('rate_limit')) {
                        errorMessage = 'â³ **Rate Limited**\n\nToo many requests. Please wait a moment and try again.';
                    } else if (error.message.includes('insufficient_quota')) {
                        errorMessage = 'ğŸ’³ **Quota Exceeded**\n\nYour API quota has been exceeded. Please check your Anthropic account.';
                    } else {
                        errorMessage += `\n\n*Error: ${error.message}*`;
                    }

                    this.addMessage(errorMessage, 'assistant');
                }

                this.isProcessing = false;
            },

            gatherContext: function () {
                const guards = DataStore.getGuards() || [];
                const sites = DataStore.getSites() || [];
                const incidents = DataStore.getIncidents() || [];
                const calloffs = DataStore.getCalloffs() || [];
                const logs = DataStore.getSupervisorLog() || [];

                const today = Utils.toISODate(new Date());
                const tomorrow = Utils.toISODate(new Date(Date.now() + 86400000));
                const weekKey = Utils.getWeekKey(new Date());
                const shifts = DataStore.getScheduleForWeek(weekKey) || [];

                // Today's shifts with coverage status
                const todayShifts = shifts.filter(s => s.date === today).map(s => {
                    const site = sites.find(st => st.id === s.siteId);
                    const guard = guards.find(g => g.id === s.guardId);
                    return {
                        site: site?.name || 'Unknown',
                        shift: s.shiftLabel,
                        guard: guard?.name || 'UNCOVERED',
                        status: s.status || (guard ? 'Assigned' : 'OPEN'),
                        role: guard?.role || null
                    };
                });

                // Tomorrow's shifts
                const tomorrowShifts = shifts.filter(s => s.date === tomorrow).map(s => {
                    const site = sites.find(st => st.id === s.siteId);
                    const guard = guards.find(g => g.id === s.guardId);
                    return {
                        site: site?.name || 'Unknown',
                        shift: s.shiftLabel,
                        guard: guard?.name || 'UNCOVERED',
                        status: s.status || (guard ? 'Assigned' : 'OPEN')
                    };
                });

                // Uncovered shifts
                const uncoveredToday = todayShifts.filter(s => s.guard === 'UNCOVERED' || s.status === 'OPEN');
                const uncoveredTomorrow = tomorrowShifts.filter(s => s.guard === 'UNCOVERED' || s.status === 'OPEN');

                // Call-offs with details
                const pendingCalloffs = calloffs.filter(c => c.coverageStatus === 'pending').map(c => {
                    const guard = guards.find(g => g.id === c.guardId);
                    const site = sites.find(s => s.id === c.siteId);
                    return {
                        guard: guard?.name || 'Unknown',
                        site: site?.name || 'Unknown',
                        date: c.date,
                        shift: c.shiftLabel,
                        reason: c.reason
                    };
                });

                // Open incidents
                const openIncidents = incidents.filter(i => i.status !== 'Resolved').map(i => {
                    const site = sites.find(s => s.id === i.siteId);
                    const daysSince = Math.floor((Date.now() - new Date(i.dateTime).getTime()) / 86400000);
                    return {
                        id: i.id,
                        site: site?.name || 'Unknown',
                        type: i.type,
                        severity: i.severity,
                        status: i.status,
                        daysOpen: daysSince,
                        narrative: i.narrative?.substring(0, 200)
                    };
                });

                // Log entries needing follow-up
                const followUpLogs = logs.filter(l => l.needsFollowUp && l.status !== 'resolved').map(l => {
                    const site = sites.find(s => s.id === l.siteId);
                    return {
                        date: l.dateTime,
                        source: l.source,
                        site: site?.name || 'General',
                        note: l.note?.substring(0, 150)
                    };
                });

                // Available guards (active, not already scheduled today)
                const scheduledGuardIds = todayShifts.map(s => {
                    const guard = guards.find(g => g.name === s.guard);
                    return guard?.id;
                }).filter(Boolean);

                const availableGuards = guards.filter(g =>
                    g.status === 'active' && !scheduledGuardIds.includes(g.id)
                ).map(g => ({
                    name: g.name,
                    role: g.role,
                    phone: g.phone,
                    primarySites: (g.primarySites || []).map(sId =>
                        sites.find(s => s.id === sId)?.name
                    ).filter(Boolean)
                }));

                // Guards returning from suspension
                const returningGuards = guards.filter(g => {
                    if (g.status !== 'suspended' || !g.suspensionEnd) return false;
                    const daysUntil = Math.floor((new Date(g.suspensionEnd) - Date.now()) / 86400000);
                    return daysUntil >= 0 && daysUntil <= 7;
                }).map(g => ({
                    name: g.name,
                    role: g.role,
                    returnsOn: g.suspensionEnd
                }));

                return {
                    today,
                    tomorrow,
                    currentPage: Router.currentRoute || 'dashboard',

                    // Summary stats
                    stats: {
                        totalGuards: guards.length,
                        activeGuards: guards.filter(g => g.status === 'active').length,
                        suspendedGuards: guards.filter(g => g.status === 'suspended').length,
                        totalSites: sites.length,
                        shiftsToday: todayShifts.length,
                        uncoveredToday: uncoveredToday.length,
                        uncoveredTomorrow: uncoveredTomorrow.length,
                        pendingCalloffs: pendingCalloffs.length,
                        openIncidents: openIncidents.length,
                        followUpsNeeded: followUpLogs.length
                    },

                    // Detailed data
                    todayShifts,
                    tomorrowShifts,
                    uncoveredToday,
                    uncoveredTomorrow,
                    pendingCalloffs,
                    openIncidents,
                    followUpLogs,
                    availableGuards,
                    returningGuards,

                    // Reference data
                    allSites: sites.map(s => ({ name: s.name, type: s.type })),
                    allGuards: guards.map(g => ({
                        name: g.name,
                        role: g.role,
                        status: g.status,
                        phone: g.phone
                    }))
                };
            },

            buildSystemPrompt: function (context) {
                const c = context;
                const s = c.stats;

                return `You are Mike's AI Operations Assistant for his security company managing 150+ security officers across 13 sites in Newark, NJ area.

TODAY: ${c.today}
CURRENT PAGE: ${c.currentPage}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
OPERATIONAL STATUS AT A GLANCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Guards: ${s.totalGuards} total (${s.activeGuards} active, ${s.suspendedGuards} suspended)
Sites: ${s.totalSites}
Today's Shifts: ${s.shiftsToday} scheduled, ${s.uncoveredToday} UNCOVERED
Tomorrow's Shifts: ${s.uncoveredTomorrow} UNCOVERED
Pending Call-offs: ${s.pendingCalloffs}
Open Incidents: ${s.openIncidents}
Follow-ups Needed: ${s.followUpsNeeded}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TODAY'S SHIFT COVERAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${c.todayShifts.length > 0 ? c.todayShifts.map(s =>
                    `â€¢ ${s.site} (${s.shift}): ${s.guard} [${s.status}]${s.role ? ' - ' + s.role : ''}`
                ).join('\n') : 'No shifts scheduled today'}

${c.uncoveredToday.length > 0 ? `
âš ï¸ UNCOVERED TODAY:
${c.uncoveredToday.map(s => `â€¢ ${s.site} - ${s.shift}`).join('\n')}
` : ''}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TOMORROW'S COVERAGE GAPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${c.uncoveredTomorrow.length > 0 ? c.uncoveredTomorrow.map(s =>
                    `â€¢ ${s.site} - ${s.shift}: NEEDS COVERAGE`
                ).join('\n') : 'All shifts covered for tomorrow âœ“'}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PENDING CALL-OFFS (Need Coverage Decision)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${c.pendingCalloffs.length > 0 ? c.pendingCalloffs.map(co =>
                    `â€¢ ${co.guard} @ ${co.site} (${co.date} ${co.shift}) - Reason: ${co.reason || 'Not specified'}`
                ).join('\n') : 'No pending call-offs âœ“'}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
AVAILABLE GUARDS (Active, Not Scheduled Today)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${c.availableGuards.length > 0 ? c.availableGuards.map(g =>
                    `â€¢ ${g.name} [${g.role}] - ${g.phone || 'No phone'}${g.primarySites.length > 0 ? ' | Primary: ' + g.primarySites.join(', ') : ''}`
                ).join('\n') : 'All active guards are scheduled today'}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
OPEN INCIDENTS (Unresolved)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${c.openIncidents.length > 0 ? c.openIncidents.map(i =>
                    `â€¢ [${i.severity}] ${i.site}: ${i.type} - ${i.status} (${i.daysOpen} days open)
      ${i.narrative ? '"' + i.narrative + '..."' : ''}`
                ).join('\n\n') : 'No open incidents âœ“'}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
LOG ENTRIES NEEDING FOLLOW-UP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${c.followUpLogs.length > 0 ? c.followUpLogs.map(l =>
                    `â€¢ ${l.date} [${l.source}] ${l.site}: ${l.note}...`
                ).join('\n') : 'No pending follow-ups âœ“'}

${c.returningGuards.length > 0 ? `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
GUARDS RETURNING FROM SUSPENSION (Next 7 Days)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${c.returningGuards.map(g => `â€¢ ${g.name} [${g.role}] returns ${g.returnsOn}`).join('\n')}
` : ''}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
YOUR CAPABILITIES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
You can help Mike with:
1. COVERAGE DECISIONS: "Who can cover [site] [shift]?" â†’ Suggest from available guards
2. DAILY SUMMARIES: "Generate daily report" â†’ Summarize shifts, incidents, call-offs
3. INCIDENT ANALYSIS: "Show incident patterns" â†’ Analyze by site, time, type
4. STAFFING: "Who's available tomorrow?" â†’ List unscheduled active guards
5. FOLLOW-UPS: "What needs my attention?" â†’ Prioritize action items
6. DRAFT REPORTS: "Draft incident report for [site]" â†’ Client-ready language

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—“ï¸ SCHEDULE MANAGEMENT TOOLS (You can READ and WRITE schedules)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Use these tools to manage the schedule:

ADD SHIFT: "Add [guard] to [site] [shift] on [date]"
  â†’ Example: "Add John Smith to Zion Towers 8am-4pm tomorrow"
  â†’ Example: "Schedule Maria for the overnight at Georgia King on Monday"

REMOVE SHIFT: "Remove [guard] from [site] on [date]"
  â†’ Example: "Remove John from Zion Towers tomorrow"

SWAP GUARDS: "Replace [guard1] with [guard2] at [site] on [date]"
  â†’ Example: "Swap John and Maria at Zion Towers tomorrow"
  â†’ Example: "Replace Pedro with Carlos at 244 Chadwick on Monday"

VIEW GUARD SCHEDULE: "What's [guard]'s schedule this week?"
  â†’ Shows all shifts for that guard

VIEW SITE SCHEDULE: "Who's working at [site] this week?"
  â†’ Shows all shifts at that site

FIND OPEN SHIFTS: "Show me open/uncovered shifts"
  â†’ Lists all shifts that need coverage

CHECK AVAILABILITY: "Who's available [date]?"
  â†’ Lists guards not scheduled that day

COPY SCHEDULE: "Copy Monday's schedule to Tuesday"
  â†’ Duplicates all shifts from one day to another

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ CALL-OFF MANAGEMENT TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

LOG CALL-OFF: "[guard] called off" or "Log call-off for [guard]"
  â†’ Example: "John called off sick for tomorrow"
  â†’ Example: "Log a call-off for Maria - car trouble - today's shift at Zion"
  â†’ Auto-detects site/shift from schedule if not specified
  â†’ Detects NCNS (No-Call-No-Show) from keywords

GET PENDING CALL-OFFS: "Show pending call-offs" or "What needs coverage?"
  â†’ Lists all call-offs that haven't been covered yet

FIND COVERAGE: "Who can cover [guard]'s shift?" or "Find coverage for [call-off]"
  â†’ Suggests available guards, prioritizes those with site experience
  â†’ Includes phone numbers for quick contact

MARK COVERED: "[replacement] will cover" or "Mark covered by [guard]"
  â†’ Example: "Maria will cover John's shift"
  â†’ Example: "Carlos is covering the Zion call-off"
  â†’ Updates call-off status and records replacement

MARK UNCOVERED: "Mark it uncovered" or "Couldn't find coverage"
  â†’ Marks call-off as uncovered with notes

CALL-OFF HISTORY: "Show [guard]'s call-off history" or "Call-offs at [site]"
  â†’ Shows patterns, frequent callers, stats
  â†’ Default: last 30 days

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ‘¤ GUARD MANAGEMENT TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ADD GUARD: "Add new guard [name] [phone]" or "Hire [name]"
  â†’ Example: "Add new guard John Doe 973-555-1234"
  â†’ Example: "Hire Maria Garcia, phone 973-555-5678, she's a supervisor"
  â†’ Can specify role, email, primary sites

UPDATE GUARD: "Update [guard]'s [field]" or "Change [guard]'s phone"
  â†’ Example: "Update John's phone to 973-555-9999"
  â†’ Example: "Change Maria's email to maria@email.com"
  â†’ Can update: phone, email, role, notes, primary sites

SUSPEND GUARD: "Suspend [guard]" or "[guard] is suspended"
  â†’ Example: "Suspend John for 3 days - late to shifts"
  â†’ Example: "Pedro is suspended until Friday"
  â†’ Tracks suspension start, end date, and reason

ACTIVATE GUARD: "Activate [guard]" or "Unsuspend [guard]"
  â†’ Example: "Activate Maria" or "John is back from suspension"
  â†’ Returns guard to active status

DEACTIVATE GUARD: "Deactivate [guard]" or "[guard] quit/terminated"
  â†’ Example: "Deactivate John - resigned"
  â†’ Example: "Pedro was terminated"
  â†’ Sets status to inactive

GET GUARD INFO: "Show [guard]'s info" or "What's [guard]'s phone?"
  â†’ Shows full profile: phone, email, role, status
  â†’ Includes this week's schedule
  â†’ Shows call-off stats (last 30 days)

LIST GUARDS: "Show all guards" or "Who's suspended?" or "List supervisors"
  â†’ Example: "Show all active guards"
  â†’ Example: "Who's suspended?"
  â†’ Example: "List supervisors at Zion Towers"
  â†’ Can filter by status, role, or site

SEARCH GUARDS: "Search for [query]"
  â†’ Searches name, phone, email
  â†’ Example: "Search for 973-555" or "Search Garcia"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ COMMUNICATIONS LOG TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

LOG COMMUNICATION: "Log a call with [contact]" or "I emailed [contact]"
  â†’ Example: "Log a call with John from ABC Property - discussed security concerns"
  â†’ Example: "I emailed the property manager about the incident report"
  â†’ Auto-detects type (phone/email/text/meeting) from context
  â†’ Can set follow-up reminder

GET COMMUNICATIONS: "Show recent communications" or "What calls did we have?"
  â†’ Example: "Show communications from today"
  â†’ Example: "What did we discuss with Georgia King management?"
  â†’ Can filter by site, contact, type, or date range

GET PENDING FOLLOW-UPS: "What follow-ups do I have?"
  â†’ Shows all communications needing follow-up
  â†’ Highlights overdue items
  â†’ Sorted by urgency

COMPLETE FOLLOW-UP: "Completed the follow-up with [contact]"
  â†’ Example: "Mark the ABC Property follow-up as done"
  â†’ Records completion date and notes

SEARCH COMMUNICATIONS: "Search communications for [topic]"
  â†’ Example: "Search for incident report discussions"
  â†’ Searches subject, summary, contact name

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš¨ INCIDENT MANAGEMENT TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

LOG INCIDENT: "Log incident at [site]" or "There was a [type] at [site]"
  â†’ Example: "Log incident at Zion Towers - unauthorized vehicle in parking lot"
  â†’ Example: "There was a fire alarm at Georgia King, false alarm from cooking smoke"
  â†’ Auto-generates incident ID (INC-XXX)
  â†’ Severity: Low, Medium, High, Critical (default Medium)

GET INCIDENTS: "Show incidents" or "Open incidents" or "What happened at [site]?"
  â†’ Example: "Show all open incidents"
  â†’ Example: "What incidents happened at Georgia King this week?"
  â†’ Can filter by site, status, severity, date range

UPDATE INCIDENT: "Update incident [ID]" or "Mark incident resolved"
  â†’ Example: "Mark INC-003 as resolved"
  â†’ Example: "Update the Zion incident to In Progress"
  â†’ Can update status, severity, add to narrative

GET INCIDENT STATS: "Incident patterns" or "Incident summary"
  â†’ Shows stats by type, severity, site
  â†’ Top incident types and problem sites
  â†’ Average resolution time

SEARCH INCIDENTS: "Search incidents for [keyword]"
  â†’ Example: "Search for trespassing incidents"
  â†’ Searches type, narrative, ID

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¢ SITE MANAGEMENT TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

GET SITE INFO: "Tell me about [site]" or "Site info for [site]"
  â†’ Shows address, type, management company
  â†’ Today's coverage (guards + shifts)
  â†’ Linked contacts with phone/email
  â†’ Recent incident stats

LIST SITES: "Show all sites" or "List our properties"
  â†’ Shows all sites with stats
  â†’ Coverage status, incident counts, contact counts

ADD SITE: "Add new site [name]" or "Create site"
  â†’ Example: "Add new site Parkview Towers at 123 Main St"
  â†’ Creates site with default shift pattern

UPDATE SITE: "Update [site]" or "Change [site] info"
  â†’ Example: "Update Georgia King management company to ABC Properties"
  â†’ Can update name, address, management company, type, notes

GET SITE COVERAGE: "Who's at [site]?" or "Coverage for [site]"
  â†’ Shows guards scheduled for next 7 days
  â†’ Flags uncovered days

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‡ CONTACT MANAGEMENT TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ADD CONTACT: "Add contact [name]" or "Save [name]'s info"
  â†’ Auto-detects category from role/company:
    â€¢ dispatch, supervisor, manager â†’ ğŸ‘¤ Internal
    â€¢ property manager, site manager â†’ ğŸ¢ Client  
    â€¢ technician, contractor, rep â†’ ğŸ”§ Vendor
    â€¢ police, fire, EMS â†’ ğŸš¨ Emergency
    â€¢ elevator, HVAC, electrician â†’ âš¡ Utility
    â€¢ inspector, code enforcement â†’ ğŸ›ï¸ Government
    â€¢ attorney, insurance â†’ âš–ï¸ Legal
    â€¢ tenant, concierge, doorman â†’ ğŸ  Resident
  â†’ Example: "Add Joe Shmoe as dispatch at Zion, 973-555-1234"
  â†’ Auto-links to site when mentioned

UPDATE CONTACT: "Update [contact]'s info" or "Change [name]'s phone"
  â†’ Example: "Update Sarah's phone to 973-555-9999"
  â†’ Example: "Link John to Georgia King"

GET CONTACT INFO: "Who is [name]?" or "[name]'s phone number"
  â†’ Shows full contact details
  â†’ Shows which sites they're linked to

LIST CONTACTS: "Show contacts" or "List clients" or "Vendors for [site]"
  â†’ Filter by category (client, internal, vendor, emergency)
  â†’ Filter by site

SEARCH CONTACTS: "Search contacts for [query]"
  â†’ Searches name, phone, email, company, role

GET CONTACTS FOR SITE: "Who should I contact for [site]?"
  â†’ Returns all contacts grouped by category
  â†’ Client contacts, internal, vendors, emergency

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¢ SITE MANAGEMENT TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

GET SITE INFO: "Tell me about [site]" or "Site info for [site]"
  â†’ Shows address, type, management company
  â†’ Lists all contacts linked to the site
  â†’ Shows today's coverage (guards assigned)
  â†’ Shows incident stats (last 30 days)

LIST SITES: "Show all sites" or "List our properties"
  â†’ Lists all sites with summary stats
  â†’ Shows coverage status, incident counts, contact counts

ADD SITE: "Add new site [name]"
  â†’ Example: "Add new site Newark Plaza at 123 Main St"
  â†’ Creates site with default shift pattern

UPDATE SITE: "Update [site]"
  â†’ Example: "Change Georgia King management to ABC Properties"
  â†’ Can update name, address, management company, notes

GET SITE COVERAGE: "Who's at [site]?" or "Coverage at [site]"
  â†’ Shows scheduled guards for next 7 days
  â†’ Includes guard phone numbers for quick contact
  â†’ Highlights days without coverage

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‡ CONTACT MANAGEMENT TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CONTACT CATEGORIES (use these for natural organization):
  ğŸš¨ emergency - Police precincts, Fire dept, EMS, Hospitals
  ğŸ¢ client - Property managers, Site managers, POCs
  ğŸ‘” internal - Your team: Dispatch, Supervisors, HR, Admin
  ğŸ”§ vendor - Account reps, Service techs, Contractors
  âš¡ utility - Electric, Gas, Water, Elevator, HVAC, Locksmith
  ğŸ›ï¸ government - Building inspectors, Code enforcement, Licensing
  âš–ï¸ legal - Attorneys, Insurance adjusters, Claims reps
  ğŸ  resident - Building presidents, HOA, Key tenants, Supers

ADD CONTACT: "Add contact [name]" or "Save [name]'s info"
  â†’ Example: "Add contact John Smith, property manager at ABC Management, phone 973-555-1234, linked to Zion Towers"
  â†’ Example: "Add emergency contact - Newark Police 5th Precinct 973-555-0000"
  â†’ Link contacts to specific sites for easy lookup

UPDATE CONTACT: "Update [name]'s phone" or "Change [name]'s info"
  â†’ Example: "Update Sarah's phone to 973-555-9999"
  â†’ Can update phone, email, role, company, linked sites

GET CONTACT INFO: "Who is [name]?" or "[Name]'s phone number"
  â†’ Example: "What's John's phone number?"
  â†’ Shows full contact details and linked sites

LIST CONTACTS: "Show contacts" or "List clients" or "Who are our vendors?"
  â†’ Example: "Show all emergency contacts"
  â†’ Example: "Contacts for Georgia King"
  â†’ Filter by category or site

SEARCH CONTACTS: "Search for [query]"
  â†’ Searches name, phone, email, company
  â†’ Example: "Search for ABC Management"

GET CONTACTS FOR SITE: "Who should I call for [site]?"
  â†’ Example: "Who are the contacts for Zion Towers?"
  â†’ Groups contacts by category (emergency, client, vendor, etc.)
  â†’ Perfect for incident response - see all relevant contacts at once

IMPORTANT:
- Match guard/site names flexibly (partial names OK)
- Support day names: "Monday", "Tuesday", etc.
- Support relative dates: "today", "tomorrow", "yesterday"
- For shifts, understand: "8A-4P", "8am to 4pm", "day shift", "overnight", "4pm-midnight"
- Always confirm actions with details (guard name, phone, site, shift, date)
- Check for conflicts before adding shifts
- Warn if guard is suspended or inactive

RESPONSE GUIDELINES:
- Be direct and action-oriented. Mike has ADHD â€” keep it scannable.
- Lead with the answer, then explain if needed.
- Use bullet points and clear headers.
- If recommending a guard for coverage, include their phone number.
- Flag anything urgent at the top.
- When generating reports, use professional language suitable for property managers.`;
            },

            // Tool definitions for schedule management
            getToolDefinitions: function() {
                return [
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // SCHEDULER TOOLS
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    {
                        name: "add_shift",
                        description: "Add a guard to a shift at a specific site. Use this when the user asks to schedule, add, or assign a guard to work a shift.",
                        input_schema: {
                            type: "object",
                            properties: {
                                guard_name: {
                                    type: "string",
                                    description: "The name of the guard to schedule (can be first name, last name, or full name)"
                                },
                                site_name: {
                                    type: "string",
                                    description: "The name of the site (can be partial match)"
                                },
                                date: {
                                    type: "string",
                                    description: "The date in YYYY-MM-DD format, or 'today', 'tomorrow', 'monday', 'tuesday', etc."
                                },
                                start_time: {
                                    type: "string",
                                    description: "Shift start time in HH:MM 24-hour format (e.g., '08:00', '16:00', '00:00')"
                                },
                                end_time: {
                                    type: "string",
                                    description: "Shift end time in HH:MM 24-hour format (e.g., '16:00', '00:00', '08:00')"
                                }
                            },
                            required: ["guard_name", "site_name", "date", "start_time", "end_time"]
                        }
                    },
                    {
                        name: "remove_shift",
                        description: "Remove a guard from a shift. Use this when the user asks to unassign, remove, or cancel a guard's shift.",
                        input_schema: {
                            type: "object",
                            properties: {
                                guard_name: {
                                    type: "string",
                                    description: "The name of the guard to remove"
                                },
                                site_name: {
                                    type: "string",
                                    description: "The name of the site"
                                },
                                date: {
                                    type: "string",
                                    description: "The date of the shift in YYYY-MM-DD format or 'today', 'tomorrow', etc."
                                }
                            },
                            required: ["guard_name", "site_name", "date"]
                        }
                    },
                    {
                        name: "swap_guards",
                        description: "Swap two guards' shifts. Use when user asks to swap, switch, or replace one guard with another.",
                        input_schema: {
                            type: "object",
                            properties: {
                                guard1_name: {
                                    type: "string",
                                    description: "The first guard's name (the one being replaced or swapping from)"
                                },
                                guard2_name: {
                                    type: "string",
                                    description: "The second guard's name (the replacement or swapping to)"
                                },
                                site_name: {
                                    type: "string",
                                    description: "The site where the swap occurs"
                                },
                                date: {
                                    type: "string",
                                    description: "The date of the shift"
                                }
                            },
                            required: ["guard1_name", "guard2_name", "site_name", "date"]
                        }
                    },
                    {
                        name: "get_guard_schedule",
                        description: "Get a specific guard's schedule for the week. Use when user asks 'what is [guard]'s schedule' or 'when is [guard] working'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                guard_name: {
                                    type: "string",
                                    description: "The guard's name"
                                },
                                week_offset: {
                                    type: "integer",
                                    description: "0 for this week, 1 for next week, -1 for last week. Default 0."
                                }
                            },
                            required: ["guard_name"]
                        }
                    },
                    {
                        name: "get_site_schedule",
                        description: "Get all shifts at a specific site for the week. Use when user asks 'who is working at [site]' or 'show [site] schedule'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                site_name: {
                                    type: "string",
                                    description: "The site name"
                                },
                                week_offset: {
                                    type: "integer",
                                    description: "0 for this week, 1 for next week. Default 0."
                                }
                            },
                            required: ["site_name"]
                        }
                    },
                    {
                        name: "get_open_shifts",
                        description: "Find all uncovered/open shifts. Use when user asks about open shifts, uncovered shifts, or what needs coverage.",
                        input_schema: {
                            type: "object",
                            properties: {
                                date: {
                                    type: "string",
                                    description: "Specific date to check, or 'today', 'tomorrow', 'this_week'. Default is 'this_week'."
                                },
                                site_name: {
                                    type: "string",
                                    description: "Optional - filter to specific site"
                                }
                            },
                            required: []
                        }
                    },
                    {
                        name: "list_available_guards",
                        description: "Get a list of guards who are available (not scheduled) for a specific date.",
                        input_schema: {
                            type: "object",
                            properties: {
                                date: {
                                    type: "string",
                                    description: "The date to check availability for"
                                }
                            },
                            required: ["date"]
                        }
                    },
                    {
                        name: "copy_day_schedule",
                        description: "Copy all shifts from one day to another. Use when user asks to 'copy Monday to Tuesday' or 'duplicate schedule'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                from_date: {
                                    type: "string",
                                    description: "Source date to copy from (YYYY-MM-DD or day name)"
                                },
                                to_date: {
                                    type: "string",
                                    description: "Target date to copy to (YYYY-MM-DD or day name)"
                                },
                                site_name: {
                                    type: "string",
                                    description: "Optional - only copy shifts for this site. If omitted, copies all sites."
                                }
                            },
                            required: ["from_date", "to_date"]
                        }
                    },
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // CALL-OFF TOOLS
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    {
                        name: "log_calloff",
                        description: "Log a new call-off when a guard calls in sick, has an emergency, or won't make their shift. Use when user says '[guard] called off' or 'log a call-off for [guard]'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                guard_name: {
                                    type: "string",
                                    description: "Name of the guard who is calling off"
                                },
                                site_name: {
                                    type: "string",
                                    description: "The site they were scheduled to work"
                                },
                                date: {
                                    type: "string",
                                    description: "Date of the shift they're missing (YYYY-MM-DD or 'today', 'tomorrow')"
                                },
                                shift: {
                                    type: "string",
                                    description: "The shift time (e.g., '8A-4P', '4P-12A', '12A-8A')"
                                },
                                reason: {
                                    type: "string",
                                    description: "Reason for calling off (sick, emergency, car trouble, family emergency, etc.)"
                                },
                                is_ncns: {
                                    type: "boolean",
                                    description: "True if this is a No-Call-No-Show (guard didn't call, just didn't show up)"
                                }
                            },
                            required: ["guard_name", "date", "reason"]
                        }
                    },
                    {
                        name: "get_pending_calloffs",
                        description: "Get all call-offs that still need coverage. Use when user asks 'show pending call-offs' or 'what call-offs need coverage'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                date: {
                                    type: "string",
                                    description: "Optional - filter to specific date. If omitted, shows all pending."
                                }
                            },
                            required: []
                        }
                    },
                    {
                        name: "find_calloff_coverage",
                        description: "Find available guards who can cover a specific call-off. Use when user asks 'who can cover [guard]'s shift' or 'find coverage for the call-off'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                calloff_id: {
                                    type: "string",
                                    description: "The ID of the call-off to find coverage for (from get_pending_calloffs)"
                                },
                                guard_name: {
                                    type: "string",
                                    description: "Alternative: the guard who called off (will find their most recent pending call-off)"
                                }
                            },
                            required: []
                        }
                    },
                    {
                        name: "mark_calloff_covered",
                        description: "Mark a call-off as covered by a replacement guard. Use when user says 'Maria will cover' or '[guard] is covering the call-off'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                calloff_id: {
                                    type: "string",
                                    description: "The ID of the call-off"
                                },
                                guard_name: {
                                    type: "string",
                                    description: "Alternative: name of guard who called off (finds their pending call-off)"
                                },
                                replacement_name: {
                                    type: "string",
                                    description: "Name of the guard who will cover the shift"
                                },
                                notes: {
                                    type: "string",
                                    description: "Optional notes about the coverage"
                                }
                            },
                            required: ["replacement_name"]
                        }
                    },
                    {
                        name: "mark_calloff_uncovered",
                        description: "Mark a call-off as unable to find coverage. Use when user says 'couldn't find coverage' or 'mark it uncovered'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                calloff_id: {
                                    type: "string",
                                    description: "The ID of the call-off"
                                },
                                guard_name: {
                                    type: "string",
                                    description: "Alternative: name of guard who called off"
                                },
                                notes: {
                                    type: "string",
                                    description: "Notes about why coverage couldn't be found"
                                }
                            },
                            required: []
                        }
                    },
                    {
                        name: "get_calloff_history",
                        description: "Get call-off history for a guard or site. Use when user asks about someone's call-off history or patterns.",
                        input_schema: {
                            type: "object",
                            properties: {
                                guard_name: {
                                    type: "string",
                                    description: "Filter by guard name"
                                },
                                site_name: {
                                    type: "string",
                                    description: "Filter by site"
                                },
                                days: {
                                    type: "integer",
                                    description: "How many days back to look (default 30)"
                                }
                            },
                            required: []
                        }
                    },
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // GUARD MANAGEMENT TOOLS
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    {
                        name: "add_guard",
                        description: "Add a new guard to the roster. Use when user says 'add a new guard' or 'hire [name]'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                name: {
                                    type: "string",
                                    description: "Full name of the guard (e.g., 'John Smith')"
                                },
                                phone: {
                                    type: "string",
                                    description: "Phone number"
                                },
                                email: {
                                    type: "string",
                                    description: "Email address (optional)"
                                },
                                role: {
                                    type: "string",
                                    description: "Role: 'Officer', 'Supervisor', 'Field Supervisor', 'Manager', or 'Admin'. Default is 'Officer'."
                                },
                                primary_sites: {
                                    type: "array",
                                    items: { type: "string" },
                                    description: "List of site names this guard primarily works at (optional)"
                                }
                            },
                            required: ["name", "phone"]
                        }
                    },
                    {
                        name: "update_guard",
                        description: "Update a guard's information. Use when user says 'update [guard]'s phone' or 'change [guard]'s email'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                guard_name: {
                                    type: "string",
                                    description: "Name of the guard to update"
                                },
                                phone: {
                                    type: "string",
                                    description: "New phone number"
                                },
                                email: {
                                    type: "string",
                                    description: "New email address"
                                },
                                role: {
                                    type: "string",
                                    description: "New role"
                                },
                                primary_sites: {
                                    type: "array",
                                    items: { type: "string" },
                                    description: "New list of primary site names"
                                },
                                notes: {
                                    type: "string",
                                    description: "Notes about the guard"
                                }
                            },
                            required: ["guard_name"]
                        }
                    },
                    {
                        name: "suspend_guard",
                        description: "Suspend a guard. Use when user says 'suspend [guard]' or '[guard] is suspended'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                guard_name: {
                                    type: "string",
                                    description: "Name of the guard to suspend"
                                },
                                days: {
                                    type: "integer",
                                    description: "Number of days to suspend (default 3)"
                                },
                                end_date: {
                                    type: "string",
                                    description: "Alternative: specific end date (YYYY-MM-DD)"
                                },
                                reason: {
                                    type: "string",
                                    description: "Reason for suspension"
                                }
                            },
                            required: ["guard_name"]
                        }
                    },
                    {
                        name: "activate_guard",
                        description: "Activate a suspended or inactive guard. Use when user says 'activate [guard]' or 'unsuspend [guard]' or '[guard] is back'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                guard_name: {
                                    type: "string",
                                    description: "Name of the guard to activate"
                                },
                                notes: {
                                    type: "string",
                                    description: "Optional notes about the activation"
                                }
                            },
                            required: ["guard_name"]
                        }
                    },
                    {
                        name: "deactivate_guard",
                        description: "Deactivate/terminate a guard. Use when user says 'deactivate [guard]', 'terminate [guard]', or '[guard] quit'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                guard_name: {
                                    type: "string",
                                    description: "Name of the guard to deactivate"
                                },
                                reason: {
                                    type: "string",
                                    description: "Reason for deactivation (quit, terminated, etc.)"
                                }
                            },
                            required: ["guard_name"]
                        }
                    },
                    {
                        name: "get_guard_info",
                        description: "Get detailed information about a guard. Use when user asks 'show me [guard]'s info' or 'what's [guard]'s phone number'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                guard_name: {
                                    type: "string",
                                    description: "Name of the guard"
                                }
                            },
                            required: ["guard_name"]
                        }
                    },
                    {
                        name: "list_guards",
                        description: "List guards, optionally filtered by status or role. Use when user asks 'show all guards', 'who's suspended', 'list supervisors'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                status: {
                                    type: "string",
                                    description: "Filter by status: 'active', 'suspended', 'inactive', or 'all'. Default 'active'."
                                },
                                role: {
                                    type: "string",
                                    description: "Filter by role (e.g., 'Supervisor', 'Officer')"
                                },
                                site_name: {
                                    type: "string",
                                    description: "Filter by primary site"
                                }
                            },
                            required: []
                        }
                    },
                    {
                        name: "search_guards",
                        description: "Search for guards by name, phone, or email. Use for finding guards when user gives partial info.",
                        input_schema: {
                            type: "object",
                            properties: {
                                query: {
                                    type: "string",
                                    description: "Search term (name, phone, or email)"
                                }
                            },
                            required: ["query"]
                        }
                    },
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // COMMUNICATIONS TOOLS
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    {
                        name: "log_communication",
                        description: "Log a phone call, email, text, or meeting. Use when user says 'log a call', 'I talked to', 'I emailed', 'meeting with'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                type: {
                                    type: "string",
                                    description: "Type: 'phone_inbound', 'phone_outbound', 'email_inbound', 'email_outbound', 'in_person', 'text', 'video', 'radio'. Default based on context."
                                },
                                party: {
                                    type: "string",
                                    description: "Who: 'client', 'guard', 'vendor', 'internal', 'emergency', 'resident', 'other'. Default 'client'."
                                },
                                contact_name: {
                                    type: "string",
                                    description: "Name of the person contacted"
                                },
                                contact_info: {
                                    type: "string",
                                    description: "Phone/email of contact (optional)"
                                },
                                site_name: {
                                    type: "string",
                                    description: "Related site (optional)"
                                },
                                guard_name: {
                                    type: "string",
                                    description: "Related guard if applicable (optional)"
                                },
                                subject: {
                                    type: "string",
                                    description: "Subject/topic of communication"
                                },
                                summary: {
                                    type: "string",
                                    description: "Summary of what was discussed"
                                },
                                duration: {
                                    type: "integer",
                                    description: "Duration in minutes (optional)"
                                },
                                follow_up_required: {
                                    type: "boolean",
                                    description: "Whether follow-up is needed"
                                },
                                follow_up_date: {
                                    type: "string",
                                    description: "Follow-up date if required (YYYY-MM-DD)"
                                },
                                follow_up_action: {
                                    type: "string",
                                    description: "What needs to be done for follow-up"
                                }
                            },
                            required: ["subject"]
                        }
                    },
                    {
                        name: "get_communications",
                        description: "Get communication history. Use when user asks 'show communications', 'what did we discuss with [contact]', 'calls today'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                site_name: {
                                    type: "string",
                                    description: "Filter by site"
                                },
                                party: {
                                    type: "string",
                                    description: "Filter by party type (client, guard, vendor, etc.)"
                                },
                                contact_name: {
                                    type: "string",
                                    description: "Search by contact name"
                                },
                                type: {
                                    type: "string",
                                    description: "Filter by type (phone, email, etc.)"
                                },
                                days: {
                                    type: "integer",
                                    description: "How many days back to look (default 7)"
                                },
                                today_only: {
                                    type: "boolean",
                                    description: "Only show today's communications"
                                }
                            },
                            required: []
                        }
                    },
                    {
                        name: "get_pending_followups",
                        description: "Get communications that need follow-up. Use when user asks 'what follow-ups do I have', 'pending communications'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                include_overdue: {
                                    type: "boolean",
                                    description: "Include overdue follow-ups (default true)"
                                }
                            },
                            required: []
                        }
                    },
                    {
                        name: "complete_followup",
                        description: "Mark a communication follow-up as complete. Use when user says 'completed the follow-up', 'done with [contact] follow-up'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                communication_id: {
                                    type: "string",
                                    description: "ID of the communication"
                                },
                                contact_name: {
                                    type: "string",
                                    description: "Alternative: find by contact name (uses most recent)"
                                },
                                notes: {
                                    type: "string",
                                    description: "Notes about how follow-up was completed"
                                }
                            },
                            required: []
                        }
                    },
                    {
                        name: "search_communications",
                        description: "Search communications by keyword. Use for finding specific conversations.",
                        input_schema: {
                            type: "object",
                            properties: {
                                query: {
                                    type: "string",
                                    description: "Search term (searches subject, summary, contact name)"
                                },
                                days: {
                                    type: "integer",
                                    description: "How many days back to search (default 30)"
                                }
                            },
                            required: ["query"]
                        }
                    },
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // INCIDENT MANAGEMENT TOOLS
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    {
                        name: "log_incident",
                        description: "Log a new security incident. Use when user says 'log incident', 'there was an incident at', 'report [issue] at [site]'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                site_name: {
                                    type: "string",
                                    description: "Site where incident occurred"
                                },
                                type: {
                                    type: "string",
                                    description: "Type of incident (e.g., 'trespassing', 'theft', 'fire alarm', 'medical emergency', 'vandalism', 'domestic disturbance', 'unauthorized vehicle')"
                                },
                                severity: {
                                    type: "string",
                                    description: "Severity: 'Low', 'Medium', 'High', 'Critical'. Default 'Medium'."
                                },
                                narrative: {
                                    type: "string",
                                    description: "Description of what happened"
                                },
                                guard_name: {
                                    type: "string",
                                    description: "Guard who reported or was involved (optional)"
                                },
                                date_time: {
                                    type: "string",
                                    description: "When it happened (default now). Can be 'today 3pm', 'yesterday', or ISO format."
                                },
                                status: {
                                    type: "string",
                                    description: "Status: 'Open', 'In Progress', 'Resolved'. Default 'Open'."
                                }
                            },
                            required: ["site_name", "type", "narrative"]
                        }
                    },
                    {
                        name: "get_incidents",
                        description: "Get incident list. Use when user asks 'show incidents', 'what incidents happened', 'open incidents'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                site_name: {
                                    type: "string",
                                    description: "Filter by site"
                                },
                                status: {
                                    type: "string",
                                    description: "Filter by status: 'Open', 'In Progress', 'Resolved', or 'all'"
                                },
                                severity: {
                                    type: "string",
                                    description: "Filter by severity: 'Low', 'Medium', 'High', 'Critical'"
                                },
                                days: {
                                    type: "integer",
                                    description: "How many days back to look (default 30)"
                                }
                            },
                            required: []
                        }
                    },
                    {
                        name: "update_incident",
                        description: "Update an incident's status or details. Use when user says 'update incident', 'mark incident as resolved', 'close the incident'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                incident_id: {
                                    type: "string",
                                    description: "Incident ID (e.g., 'INC-001')"
                                },
                                site_name: {
                                    type: "string",
                                    description: "Alternative: find by site (uses most recent open incident)"
                                },
                                status: {
                                    type: "string",
                                    description: "New status: 'Open', 'In Progress', 'Resolved'"
                                },
                                severity: {
                                    type: "string",
                                    description: "New severity"
                                },
                                narrative: {
                                    type: "string",
                                    description: "Additional narrative to append"
                                }
                            },
                            required: []
                        }
                    },
                    {
                        name: "get_incident_stats",
                        description: "Get incident statistics and patterns. Use when user asks 'incident patterns', 'incident summary', 'how many incidents'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                site_name: {
                                    type: "string",
                                    description: "Filter stats to specific site"
                                },
                                days: {
                                    type: "integer",
                                    description: "Analysis period in days (default 30)"
                                }
                            },
                            required: []
                        }
                    },
                    {
                        name: "search_incidents",
                        description: "Search incidents by keyword. Use for finding specific incidents.",
                        input_schema: {
                            type: "object",
                            properties: {
                                query: {
                                    type: "string",
                                    description: "Search term (searches type, narrative)"
                                },
                                days: {
                                    type: "integer",
                                    description: "How many days back to search (default 90)"
                                }
                            },
                            required: ["query"]
                        }
                    },
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // SITE MANAGEMENT TOOLS
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    {
                        name: "get_site_info",
                        description: "Get detailed info about a site including contacts, coverage status, and recent activity. Use when user asks 'tell me about [site]', 'site info for [site]', 'who's the contact for [site]'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                site_name: {
                                    type: "string",
                                    description: "Name of the site"
                                }
                            },
                            required: ["site_name"]
                        }
                    },
                    {
                        name: "list_sites",
                        description: "List all sites with summary info. Use when user asks 'show all sites', 'list sites', 'which sites do we have'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                include_stats: {
                                    type: "boolean",
                                    description: "Include incident/coverage stats (default true)"
                                }
                            },
                            required: []
                        }
                    },
                    {
                        name: "add_site",
                        description: "Add a new site. Use when user says 'add new site', 'create site', 'we have a new property'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                name: {
                                    type: "string",
                                    description: "Site name"
                                },
                                address: {
                                    type: "string",
                                    description: "Site address"
                                },
                                type: {
                                    type: "string",
                                    description: "Site type: 'Residential', 'Commercial', 'Industrial', 'Mixed Use', 'Retail', 'Other'"
                                },
                                management_company: {
                                    type: "string",
                                    description: "Property management company name"
                                }
                            },
                            required: ["name", "address"]
                        }
                    },
                    {
                        name: "update_site",
                        description: "Update site information. Use when user says 'update [site]', 'change [site] address', 'new management company for [site]'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                site_name: {
                                    type: "string",
                                    description: "Name of site to update"
                                },
                                new_name: {
                                    type: "string",
                                    description: "New site name"
                                },
                                address: {
                                    type: "string",
                                    description: "New address"
                                },
                                management_company: {
                                    type: "string",
                                    description: "New management company"
                                },
                                type: {
                                    type: "string",
                                    description: "New site type"
                                },
                                notes: {
                                    type: "string",
                                    description: "Notes to add (SOP highlights, risk notes)"
                                }
                            },
                            required: ["site_name"]
                        }
                    },
                    {
                        name: "get_site_coverage",
                        description: "Get current and upcoming coverage for a site. Use when user asks 'who's at [site]', 'coverage at [site]', 'is [site] covered'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                site_name: {
                                    type: "string",
                                    description: "Name of the site"
                                },
                                days: {
                                    type: "integer",
                                    description: "How many days of schedule to show (default 7)"
                                }
                            },
                            required: ["site_name"]
                        }
                    },
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // CONTACT MANAGEMENT TOOLS
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    {
                        name: "add_contact",
                        description: "Add a new contact. Use when user says 'add contact', 'new contact', 'save [name]'s info'. Auto-detects category from role (dispatch/supervisorâ†’internal, property managerâ†’client, technicianâ†’vendor, police/fireâ†’emergency).",
                        input_schema: {
                            type: "object",
                            properties: {
                                name: {
                                    type: "string",
                                    description: "Contact's full name"
                                },
                                role: {
                                    type: "string",
                                    description: "Job title/role - category auto-detected from this (e.g., 'Dispatch'â†’internal, 'Property Manager'â†’client, 'Technician'â†’vendor, 'Police'â†’emergency)"
                                },
                                category: {
                                    type: "string",
                                    description: "Optional override: 'internal', 'client', 'vendor', 'emergency', 'utility', 'government', 'legal', 'resident'. Auto-detected from role if not provided."
                                },
                                company: {
                                    type: "string",
                                    description: "Company or organization name"
                                },
                                phone: {
                                    type: "string",
                                    description: "Primary phone number"
                                },
                                phone_alt: {
                                    type: "string",
                                    description: "Alternate phone number"
                                },
                                email: {
                                    type: "string",
                                    description: "Email address"
                                },
                                site_name: {
                                    type: "string",
                                    description: "Site to link this contact to"
                                },
                                linked_sites: {
                                    type: "array",
                                    items: { type: "string" },
                                    description: "Multiple site names if linking to more than one"
                                },
                                notes: {
                                    type: "string",
                                    description: "Additional notes"
                                }
                            },
                            required: ["name"]
                        }
                    },
                    {
                        name: "update_contact",
                        description: "Update contact information. Use when user says 'update [contact]', 'change [name]'s phone'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                contact_name: {
                                    type: "string",
                                    description: "Name of contact to update"
                                },
                                phone: {
                                    type: "string",
                                    description: "New phone number"
                                },
                                phone_alt: {
                                    type: "string",
                                    description: "New alternate phone"
                                },
                                email: {
                                    type: "string",
                                    description: "New email"
                                },
                                role: {
                                    type: "string",
                                    description: "New role/title"
                                },
                                company: {
                                    type: "string",
                                    description: "New company"
                                },
                                linked_sites: {
                                    type: "array",
                                    items: { type: "string" },
                                    description: "New list of linked site names (replaces existing)"
                                },
                                notes: {
                                    type: "string",
                                    description: "Notes to add"
                                },
                                status: {
                                    type: "string",
                                    description: "'active' or 'inactive'"
                                }
                            },
                            required: ["contact_name"]
                        }
                    },
                    {
                        name: "get_contact_info",
                        description: "Get contact details. Use when user asks 'who is [name]', 'contact info for [name]', '[name]'s phone number'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                contact_name: {
                                    type: "string",
                                    description: "Name of the contact"
                                }
                            },
                            required: ["contact_name"]
                        }
                    },
                    {
                        name: "list_contacts",
                        description: "List contacts with optional filters. Use when user asks 'show contacts', 'list clients', 'contacts for [site]', 'who are our vendors'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                category: {
                                    type: "string",
                                    description: "Filter by category: 'client', 'internal', 'vendor', 'emergency'"
                                },
                                site_name: {
                                    type: "string",
                                    description: "Filter by linked site"
                                },
                                company: {
                                    type: "string",
                                    description: "Filter by company name"
                                }
                            },
                            required: []
                        }
                    },
                    {
                        name: "search_contacts",
                        description: "Search contacts by name, phone, email, or company. Use for finding contacts when user gives partial info.",
                        input_schema: {
                            type: "object",
                            properties: {
                                query: {
                                    type: "string",
                                    description: "Search term"
                                }
                            },
                            required: ["query"]
                        }
                    },
                    {
                        name: "get_contacts_for_site",
                        description: "Get all contacts associated with a specific site. Use when user asks 'who should I contact for [site]', 'contacts at [site]'.",
                        input_schema: {
                            type: "object",
                            properties: {
                                site_name: {
                                    type: "string",
                                    description: "Name of the site"
                                }
                            },
                            required: ["site_name"]
                        }
                    }
                ];
            },

            // Execute tool calls
            executeTool: function(toolName, toolInput) {
                const guards = DataStore.getGuards() || [];
                const sites = DataStore.getSites() || [];
                
                // Helper to find guard by name (flexible matching)
                const findGuard = (name) => {
                    if (!name) return null;
                    const lower = name.toLowerCase().trim();
                    // Try exact match first
                    let guard = guards.find(g => g.name?.toLowerCase() === lower);
                    if (guard) return guard;
                    // Try includes match
                    guard = guards.find(g => g.name?.toLowerCase().includes(lower));
                    if (guard) return guard;
                    // Try first name
                    guard = guards.find(g => g.firstName?.toLowerCase() === lower);
                    if (guard) return guard;
                    // Try last name
                    guard = guards.find(g => g.lastName?.toLowerCase() === lower);
                    return guard;
                };
                
                // Helper to find site by name (flexible matching)
                const findSite = (name) => {
                    if (!name) return null;
                    const lower = name.toLowerCase().trim();
                    let site = sites.find(s => s.name?.toLowerCase() === lower);
                    if (site) return site;
                    site = sites.find(s => s.name?.toLowerCase().includes(lower));
                    return site;
                };
                
                // Helper to parse date (supports 'today', 'tomorrow', day names)
                const parseDate = (dateStr) => {
                    if (!dateStr) return Utils.toISODate(new Date());
                    const lower = dateStr.toLowerCase().trim();
                    const today = new Date();
                    
                    if (lower === 'today') {
                        return Utils.toISODate(today);
                    } else if (lower === 'tomorrow') {
                        const tomorrow = new Date(today);
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        return Utils.toISODate(tomorrow);
                    } else if (lower === 'yesterday') {
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        return Utils.toISODate(yesterday);
                    }
                    
                    // Day names
                    const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                    const dayIndex = dayNames.indexOf(lower);
                    if (dayIndex !== -1) {
                        const target = new Date(today);
                        const currentDay = today.getDay();
                        let daysToAdd = dayIndex - currentDay;
                        if (daysToAdd <= 0) daysToAdd += 7; // Next occurrence
                        target.setDate(today.getDate() + daysToAdd);
                        return Utils.toISODate(target);
                    }
                    
                    // Assume already in YYYY-MM-DD format
                    return dateStr;
                };
                
                // Helper to format time label
                const formatTimeLabel = (t) => {
                    if (!t) return '??';
                    const [h, m] = t.split(':');
                    const hour = parseInt(h);
                    if (hour === 0) return '12A';
                    if (hour === 12) return '12P';
                    if (hour < 12) return hour + 'A';
                    return (hour - 12) + 'P';
                };

                switch(toolName) {
                    case 'add_shift': {
                        const guard = findGuard(toolInput.guard_name);
                        const site = findSite(toolInput.site_name);
                        const date = parseDate(toolInput.date);
                        
                        if (!guard) {
                            return { success: false, error: `Could not find guard matching "${toolInput.guard_name}". Active guards: ${guards.filter(g => g.status === 'active').slice(0, 10).map(g => g.name).join(', ')}...` };
                        }
                        if (!site) {
                            return { success: false, error: `Could not find site matching "${toolInput.site_name}". Sites: ${sites.map(s => s.name).join(', ')}` };
                        }
                        if (guard.status !== 'active') {
                            return { success: false, error: `${guard.name} is currently ${guard.status} and cannot be scheduled.` };
                        }
                        
                        const weekKey = Utils.getWeekKey(new Date(date + 'T00:00:00'));
                        const shifts = DataStore.getScheduleForWeek(weekKey) || [];
                        
                        // Check if already scheduled at this exact time
                        const existing = shifts.find(s => 
                            s.guardId === guard.id && 
                            s.siteId === site.id && 
                            s.date === date &&
                            s.startTime === toolInput.start_time
                        );
                        
                        if (existing) {
                            return { success: false, error: `${guard.name} is already scheduled at ${site.name} on ${date} at ${toolInput.start_time}` };
                        }
                        
                        // Check if guard has conflicting shift
                        const conflict = shifts.find(s => 
                            s.guardId === guard.id && 
                            s.date === date &&
                            s.startTime === toolInput.start_time
                        );
                        if (conflict) {
                            const conflictSite = sites.find(st => st.id === conflict.siteId);
                            return { success: false, error: `${guard.name} already has a shift at ${conflictSite?.name || 'another site'} on ${date} at that time.` };
                        }
                        
                        const shiftLabel = `${formatTimeLabel(toolInput.start_time)}-${formatTimeLabel(toolInput.end_time)}`;
                        
                        const newShift = {
                            id: Utils.generateId('shift-'),
                            siteId: site.id,
                            guardId: guard.id,
                            date: date,
                            startTime: toolInput.start_time,
                            endTime: toolInput.end_time,
                            shiftLabel: shiftLabel,
                            status: 'assigned',
                            createdAt: new Date().toISOString()
                        };
                        
                        shifts.push(newShift);
                        DataStore.saveScheduleForWeek(weekKey, shifts);
                        
                        return { 
                            success: true, 
                            message: `âœ… Added ${guard.name} to ${site.name} for ${shiftLabel} on ${date}`,
                            details: { guard: guard.name, guardPhone: guard.phone, site: site.name, date, shift: shiftLabel }
                        };
                    }
                    
                    case 'remove_shift': {
                        const guard = findGuard(toolInput.guard_name);
                        const site = findSite(toolInput.site_name);
                        const date = parseDate(toolInput.date);
                        
                        if (!guard) {
                            return { success: false, error: `Could not find guard matching "${toolInput.guard_name}"` };
                        }
                        if (!site) {
                            return { success: false, error: `Could not find site matching "${toolInput.site_name}"` };
                        }
                        
                        const weekKey = Utils.getWeekKey(new Date(date + 'T00:00:00'));
                        let shifts = DataStore.getScheduleForWeek(weekKey) || [];
                        
                        const shiftIndex = shifts.findIndex(s => 
                            s.guardId === guard.id && 
                            s.siteId === site.id && 
                            s.date === date
                        );
                        
                        if (shiftIndex === -1) {
                            return { success: false, error: `No shift found for ${guard.name} at ${site.name} on ${date}` };
                        }
                        
                        const removedShift = shifts[shiftIndex];
                        shifts.splice(shiftIndex, 1);
                        DataStore.saveScheduleForWeek(weekKey, shifts);
                        
                        return { 
                            success: true, 
                            message: `âœ… Removed ${guard.name} from ${site.name} on ${date} (was ${removedShift.shiftLabel || removedShift.startTime + '-' + removedShift.endTime})` 
                        };
                    }
                    
                    case 'swap_guards': {
                        const guard1 = findGuard(toolInput.guard1_name);
                        const guard2 = findGuard(toolInput.guard2_name);
                        const site = findSite(toolInput.site_name);
                        const date = parseDate(toolInput.date);
                        
                        if (!guard1) {
                            return { success: false, error: `Could not find guard matching "${toolInput.guard1_name}"` };
                        }
                        if (!guard2) {
                            return { success: false, error: `Could not find guard matching "${toolInput.guard2_name}"` };
                        }
                        if (!site) {
                            return { success: false, error: `Could not find site matching "${toolInput.site_name}"` };
                        }
                        
                        const weekKey = Utils.getWeekKey(new Date(date + 'T00:00:00'));
                        let shifts = DataStore.getScheduleForWeek(weekKey) || [];
                        
                        // Find guard1's shift at this site
                        const shift1Index = shifts.findIndex(s => 
                            s.guardId === guard1.id && s.siteId === site.id && s.date === date
                        );
                        
                        if (shift1Index === -1) {
                            return { success: false, error: `${guard1.name} doesn't have a shift at ${site.name} on ${date}` };
                        }
                        
                        // Replace guard1 with guard2
                        shifts[shift1Index].guardId = guard2.id;
                        shifts[shift1Index].status = 'assigned';
                        DataStore.saveScheduleForWeek(weekKey, shifts);
                        
                        const shiftLabel = shifts[shift1Index].shiftLabel || `${shifts[shift1Index].startTime}-${shifts[shift1Index].endTime}`;
                        
                        return {
                            success: true,
                            message: `âœ… Swapped: ${guard2.name} now covers ${site.name} ${shiftLabel} on ${date} (was ${guard1.name})`,
                            details: {
                                originalGuard: guard1.name,
                                newGuard: guard2.name,
                                newGuardPhone: guard2.phone,
                                site: site.name,
                                shift: shiftLabel,
                                date
                            }
                        };
                    }
                    
                    case 'get_guard_schedule': {
                        const guard = findGuard(toolInput.guard_name);
                        if (!guard) {
                            return { success: false, error: `Could not find guard matching "${toolInput.guard_name}"` };
                        }
                        
                        const offset = toolInput.week_offset || 0;
                        const targetDate = new Date();
                        targetDate.setDate(targetDate.getDate() + (offset * 7));
                        const weekKey = Utils.getWeekKey(targetDate);
                        const shifts = DataStore.getScheduleForWeek(weekKey) || [];
                        
                        const guardShifts = shifts.filter(s => s.guardId === guard.id)
                            .sort((a, b) => a.date.localeCompare(b.date) || (a.startTime || '').localeCompare(b.startTime || ''))
                            .map(s => {
                                const site = sites.find(st => st.id === s.siteId);
                                return {
                                    date: s.date,
                                    dayName: new Date(s.date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long' }),
                                    site: site?.name || 'Unknown',
                                    shift: s.shiftLabel || `${s.startTime}-${s.endTime}`,
                                    startTime: s.startTime,
                                    endTime: s.endTime
                                };
                            });
                        
                        return {
                            success: true,
                            guard: guard.name,
                            phone: guard.phone,
                            role: guard.role,
                            status: guard.status,
                            weekOf: weekKey,
                            shifts: guardShifts,
                            totalShifts: guardShifts.length
                        };
                    }
                    
                    case 'get_site_schedule': {
                        const site = findSite(toolInput.site_name);
                        if (!site) {
                            return { success: false, error: `Could not find site matching "${toolInput.site_name}"` };
                        }
                        
                        const offset = toolInput.week_offset || 0;
                        const targetDate = new Date();
                        targetDate.setDate(targetDate.getDate() + (offset * 7));
                        const weekKey = Utils.getWeekKey(targetDate);
                        const shifts = DataStore.getScheduleForWeek(weekKey) || [];
                        
                        const siteShifts = shifts.filter(s => s.siteId === site.id)
                            .sort((a, b) => a.date.localeCompare(b.date) || (a.startTime || '').localeCompare(b.startTime || ''))
                            .map(s => {
                                const guard = guards.find(g => g.id === s.guardId);
                                return {
                                    date: s.date,
                                    dayName: new Date(s.date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long' }),
                                    guard: guard?.name || 'UNASSIGNED',
                                    guardPhone: guard?.phone,
                                    shift: s.shiftLabel || `${s.startTime}-${s.endTime}`,
                                    startTime: s.startTime,
                                    endTime: s.endTime
                                };
                            });
                        
                        return {
                            success: true,
                            site: site.name,
                            address: site.address,
                            weekOf: weekKey,
                            shifts: siteShifts,
                            totalShifts: siteShifts.length
                        };
                    }
                    
                    case 'get_open_shifts': {
                        const dateFilter = (toolInput.date || 'this_week').toLowerCase();
                        const siteFilter = toolInput.site_name ? findSite(toolInput.site_name) : null;
                        
                        const today = new Date();
                        const weekKey = Utils.getWeekKey(today);
                        const shifts = DataStore.getScheduleForWeek(weekKey) || [];
                        
                        // Find shifts without guards or with 'open' status
                        let openShifts = shifts.filter(s => {
                            if (!s.guardId || s.status === 'open' || s.status === 'uncovered') {
                                return true;
                            }
                            return false;
                        });
                        
                        // Apply date filter
                        if (dateFilter === 'today') {
                            const todayStr = Utils.toISODate(today);
                            openShifts = openShifts.filter(s => s.date === todayStr);
                        } else if (dateFilter === 'tomorrow') {
                            const tomorrow = new Date(today);
                            tomorrow.setDate(tomorrow.getDate() + 1);
                            const tomorrowStr = Utils.toISODate(tomorrow);
                            openShifts = openShifts.filter(s => s.date === tomorrowStr);
                        }
                        
                        // Apply site filter
                        if (siteFilter) {
                            openShifts = openShifts.filter(s => s.siteId === siteFilter.id);
                        }
                        
                        const result = openShifts.map(s => {
                            const site = sites.find(st => st.id === s.siteId);
                            return {
                                date: s.date,
                                dayName: new Date(s.date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long' }),
                                site: site?.name || 'Unknown',
                                shift: s.shiftLabel || `${s.startTime}-${s.endTime}`,
                                startTime: s.startTime,
                                endTime: s.endTime
                            };
                        }).sort((a, b) => a.date.localeCompare(b.date));
                        
                        return {
                            success: true,
                            filter: dateFilter,
                            openShifts: result,
                            count: result.length,
                            message: result.length === 0 ? 'No open shifts found!' : `Found ${result.length} open shift(s)`
                        };
                    }
                    
                    case 'list_available_guards': {
                        const date = parseDate(toolInput.date);
                        const weekKey = Utils.getWeekKey(new Date(date + 'T00:00:00'));
                        const shifts = DataStore.getScheduleForWeek(weekKey) || [];
                        
                        const scheduledGuardIds = shifts
                            .filter(s => s.date === date)
                            .map(s => s.guardId);
                        
                        const available = guards.filter(g => 
                            g.status === 'active' && !scheduledGuardIds.includes(g.id)
                        );
                        
                        return {
                            success: true,
                            date: date,
                            dayName: new Date(date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long' }),
                            availableGuards: available.map(g => ({
                                name: g.name,
                                phone: g.phone,
                                role: g.role
                            })),
                            count: available.length
                        };
                    }
                    
                    case 'copy_day_schedule': {
                        const fromDate = parseDate(toolInput.from_date);
                        const toDate = parseDate(toolInput.to_date);
                        const siteFilter = toolInput.site_name ? findSite(toolInput.site_name) : null;
                        
                        if (fromDate === toDate) {
                            return { success: false, error: "Source and target dates cannot be the same" };
                        }
                        
                        const fromWeekKey = Utils.getWeekKey(new Date(fromDate + 'T00:00:00'));
                        const toWeekKey = Utils.getWeekKey(new Date(toDate + 'T00:00:00'));
                        
                        const fromShifts = DataStore.getScheduleForWeek(fromWeekKey) || [];
                        let toShifts = DataStore.getScheduleForWeek(toWeekKey) || [];
                        
                        // Get shifts to copy
                        let shiftsToCopy = fromShifts.filter(s => s.date === fromDate);
                        if (siteFilter) {
                            shiftsToCopy = shiftsToCopy.filter(s => s.siteId === siteFilter.id);
                        }
                        
                        if (shiftsToCopy.length === 0) {
                            return { success: false, error: `No shifts found on ${fromDate}${siteFilter ? ' at ' + siteFilter.name : ''}` };
                        }
                        
                        // Create new shifts for target date
                        let added = 0;
                        let skipped = 0;
                        
                        for (const shift of shiftsToCopy) {
                            // Check if already exists
                            const exists = toShifts.find(s => 
                                s.siteId === shift.siteId &&
                                s.date === toDate &&
                                s.startTime === shift.startTime
                            );
                            
                            if (exists) {
                                skipped++;
                                continue;
                            }
                            
                            const newShift = {
                                ...shift,
                                id: Utils.generateId('shift-'),
                                date: toDate,
                                createdAt: new Date().toISOString()
                            };
                            toShifts.push(newShift);
                            added++;
                        }
                        
                        DataStore.saveScheduleForWeek(toWeekKey, toShifts);
                        
                        return {
                            success: true,
                            message: `âœ… Copied ${added} shift(s) from ${fromDate} to ${toDate}${skipped > 0 ? ` (${skipped} skipped - already existed)` : ''}`,
                            fromDate,
                            toDate,
                            shiftsAdded: added,
                            shiftsSkipped: skipped
                        };
                    }
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // CALL-OFF TOOLS
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    
                    case 'log_calloff': {
                        const guard = findGuard(toolInput.guard_name);
                        const site = toolInput.site_name ? findSite(toolInput.site_name) : null;
                        const date = parseDate(toolInput.date);
                        
                        if (!guard) {
                            return { success: false, error: `Could not find guard matching "${toolInput.guard_name}"` };
                        }
                        
                        // Try to find the guard's shift on this date to auto-fill site/shift
                        let shiftInfo = null;
                        const weekKey = Utils.getWeekKey(new Date(date + 'T00:00:00'));
                        const shifts = DataStore.getScheduleForWeek(weekKey) || [];
                        const guardShift = shifts.find(s => s.guardId === guard.id && s.date === date);
                        
                        let siteId = site?.id;
                        let siteName = site?.name;
                        let shiftLabel = toolInput.shift || '';
                        
                        if (guardShift) {
                            const shiftSite = sites.find(s => s.id === guardShift.siteId);
                            siteId = siteId || guardShift.siteId;
                            siteName = siteName || shiftSite?.name || 'Unknown';
                            shiftLabel = shiftLabel || guardShift.shiftLabel || `${guardShift.startTime}-${guardShift.endTime}`;
                        }
                        
                        if (!siteId && !siteName) {
                            return { success: false, error: `Could not determine site. ${guard.name} doesn't appear to have a shift on ${date}. Please specify the site.` };
                        }
                        
                        const calloff = {
                            id: Utils.generateId('calloff-'),
                            date: date,
                            timeOfCall: new Date().toTimeString().slice(0, 5),
                            guardId: guard.id,
                            siteId: siteId,
                            shift: shiftLabel,
                            reason: toolInput.reason || 'Not specified',
                            documentedBy: 'AI Assistant',
                            coverageStatus: 'pending',
                            replacementGuardId: null,
                            notes: toolInput.is_ncns ? 'NO CALL NO SHOW' : '',
                            isNCNS: toolInput.is_ncns || false,
                            createdAt: new Date().toISOString()
                        };
                        
                        // Check for NCNS keywords in reason
                        if (calloff.reason.toLowerCase().includes('no call') || 
                            calloff.reason.toLowerCase().includes('ncns') ||
                            calloff.reason.toLowerCase().includes('no show')) {
                            calloff.isNCNS = true;
                            calloff.notes = (calloff.notes ? calloff.notes + ' - ' : '') + 'NO CALL NO SHOW';
                        }
                        
                        DataStore.addCalloff(calloff);
                        
                        return {
                            success: true,
                            message: `âœ… Call-off logged for ${guard.name}`,
                            calloff_id: calloff.id,
                            details: {
                                guard: guard.name,
                                guardPhone: guard.phone,
                                site: siteName,
                                date: date,
                                shift: shiftLabel,
                                reason: calloff.reason,
                                isNCNS: calloff.isNCNS,
                                status: 'PENDING - Needs coverage'
                            }
                        };
                    }
                    
                    case 'get_pending_calloffs': {
                        const calloffs = DataStore.getCalloffs() || [];
                        const dateFilter = toolInput.date ? parseDate(toolInput.date) : null;
                        
                        let pending = calloffs.filter(c => c.coverageStatus === 'pending');
                        
                        if (dateFilter) {
                            pending = pending.filter(c => c.date === dateFilter);
                        }
                        
                        const result = pending.map(c => {
                            const guard = guards.find(g => g.id === c.guardId);
                            const site = sites.find(s => s.id === c.siteId);
                            return {
                                id: c.id,
                                date: c.date,
                                dayName: new Date(c.date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long' }),
                                guard: guard?.name || 'Unknown',
                                guardPhone: guard?.phone,
                                site: site?.name || 'Unknown',
                                shift: c.shift,
                                reason: c.reason,
                                isNCNS: c.isNCNS || false,
                                timeOfCall: c.timeOfCall
                            };
                        }).sort((a, b) => a.date.localeCompare(b.date));
                        
                        return {
                            success: true,
                            pendingCalloffs: result,
                            count: result.length,
                            message: result.length === 0 ? 'No pending call-offs! ğŸ‰' : `${result.length} call-off(s) need coverage`
                        };
                    }
                    
                    case 'find_calloff_coverage': {
                        const calloffs = DataStore.getCalloffs() || [];
                        let calloff = null;
                        
                        // Find the call-off by ID or by guard name
                        if (toolInput.calloff_id) {
                            calloff = calloffs.find(c => c.id === toolInput.calloff_id);
                        } else if (toolInput.guard_name) {
                            const guard = findGuard(toolInput.guard_name);
                            if (guard) {
                                // Find most recent pending call-off for this guard
                                calloff = calloffs
                                    .filter(c => c.guardId === guard.id && c.coverageStatus === 'pending')
                                    .sort((a, b) => b.date.localeCompare(a.date))[0];
                            }
                        }
                        
                        if (!calloff) {
                            return { success: false, error: 'Could not find the call-off. Please specify the guard name or use get_pending_calloffs to see all pending.' };
                        }
                        
                        const calledOffGuard = guards.find(g => g.id === calloff.guardId);
                        const site = sites.find(s => s.id === calloff.siteId);
                        
                        // Find available guards for this date
                        const weekKey = Utils.getWeekKey(new Date(calloff.date + 'T00:00:00'));
                        const shifts = DataStore.getScheduleForWeek(weekKey) || [];
                        const scheduledGuardIds = shifts
                            .filter(s => s.date === calloff.date)
                            .map(s => s.guardId);
                        
                        const available = guards.filter(g => 
                            g.status === 'active' && 
                            g.id !== calloff.guardId &&
                            !scheduledGuardIds.includes(g.id)
                        );
                        
                        // Prioritize guards who have worked at this site before
                        const withSiteExperience = available.filter(g => {
                            const primarySites = g.primarySites || [];
                            return primarySites.some(ps => 
                                ps.toLowerCase().includes(site?.name?.toLowerCase() || '') ||
                                site?.name?.toLowerCase().includes(ps.toLowerCase())
                            );
                        });
                        
                        const otherAvailable = available.filter(g => !withSiteExperience.includes(g));
                        
                        return {
                            success: true,
                            calloff_id: calloff.id,
                            calloffDetails: {
                                guard: calledOffGuard?.name || 'Unknown',
                                site: site?.name || 'Unknown',
                                date: calloff.date,
                                shift: calloff.shift,
                                reason: calloff.reason
                            },
                            recommendedGuards: withSiteExperience.map(g => ({
                                name: g.name,
                                phone: g.phone,
                                role: g.role,
                                note: 'Has site experience'
                            })),
                            otherAvailable: otherAvailable.slice(0, 10).map(g => ({
                                name: g.name,
                                phone: g.phone,
                                role: g.role
                            })),
                            totalAvailable: available.length
                        };
                    }
                    
                    case 'mark_calloff_covered': {
                        const calloffs = DataStore.getCalloffs() || [];
                        let calloff = null;
                        
                        // Find the call-off
                        if (toolInput.calloff_id) {
                            calloff = calloffs.find(c => c.id === toolInput.calloff_id);
                        } else if (toolInput.guard_name) {
                            const guard = findGuard(toolInput.guard_name);
                            if (guard) {
                                calloff = calloffs
                                    .filter(c => c.guardId === guard.id && c.coverageStatus === 'pending')
                                    .sort((a, b) => b.date.localeCompare(a.date))[0];
                            }
                        } else {
                            // Get most recent pending call-off
                            calloff = calloffs
                                .filter(c => c.coverageStatus === 'pending')
                                .sort((a, b) => b.createdAt?.localeCompare(a.createdAt || ''))[0];
                        }
                        
                        if (!calloff) {
                            return { success: false, error: 'Could not find a pending call-off to mark as covered.' };
                        }
                        
                        const replacement = findGuard(toolInput.replacement_name);
                        if (!replacement) {
                            return { success: false, error: `Could not find replacement guard matching "${toolInput.replacement_name}"` };
                        }
                        
                        if (replacement.status !== 'active') {
                            return { success: false, error: `${replacement.name} is currently ${replacement.status} and cannot cover shifts.` };
                        }
                        
                        // Update the call-off
                        DataStore.updateCalloff(calloff.id, {
                            coverageStatus: 'covered',
                            replacementGuardId: replacement.id,
                            notes: (calloff.notes ? calloff.notes + '\n' : '') + 
                                   (toolInput.notes || `Covered by ${replacement.name}`) +
                                   ` - ${new Date().toLocaleString()}`
                        });
                        
                        const calledOffGuard = guards.find(g => g.id === calloff.guardId);
                        const site = sites.find(s => s.id === calloff.siteId);
                        
                        return {
                            success: true,
                            message: `âœ… Call-off covered! ${replacement.name} will cover ${site?.name || 'the shift'} on ${calloff.date}`,
                            details: {
                                originalGuard: calledOffGuard?.name,
                                replacement: replacement.name,
                                replacementPhone: replacement.phone,
                                site: site?.name,
                                date: calloff.date,
                                shift: calloff.shift
                            }
                        };
                    }
                    
                    case 'mark_calloff_uncovered': {
                        const calloffs = DataStore.getCalloffs() || [];
                        let calloff = null;
                        
                        if (toolInput.calloff_id) {
                            calloff = calloffs.find(c => c.id === toolInput.calloff_id);
                        } else if (toolInput.guard_name) {
                            const guard = findGuard(toolInput.guard_name);
                            if (guard) {
                                calloff = calloffs
                                    .filter(c => c.guardId === guard.id && c.coverageStatus === 'pending')
                                    .sort((a, b) => b.date.localeCompare(a.date))[0];
                            }
                        } else {
                            calloff = calloffs
                                .filter(c => c.coverageStatus === 'pending')
                                .sort((a, b) => b.createdAt?.localeCompare(a.createdAt || ''))[0];
                        }
                        
                        if (!calloff) {
                            return { success: false, error: 'Could not find a pending call-off to mark as uncovered.' };
                        }
                        
                        DataStore.updateCalloff(calloff.id, {
                            coverageStatus: 'uncovered',
                            notes: (calloff.notes ? calloff.notes + '\n' : '') + 
                                   (toolInput.notes || 'Unable to find coverage') +
                                   ` - ${new Date().toLocaleString()}`
                        });
                        
                        const calledOffGuard = guards.find(g => g.id === calloff.guardId);
                        const site = sites.find(s => s.id === calloff.siteId);
                        
                        return {
                            success: true,
                            message: `âš ï¸ Call-off marked as UNCOVERED for ${site?.name || 'the site'} on ${calloff.date}`,
                            details: {
                                guard: calledOffGuard?.name,
                                site: site?.name,
                                date: calloff.date,
                                shift: calloff.shift
                            }
                        };
                    }
                    
                    case 'get_calloff_history': {
                        const calloffs = DataStore.getCalloffs() || [];
                        const days = toolInput.days || 30;
                        const cutoffDate = new Date();
                        cutoffDate.setDate(cutoffDate.getDate() - days);
                        const cutoffStr = Utils.toISODate(cutoffDate);
                        
                        let filtered = calloffs.filter(c => c.date >= cutoffStr);
                        
                        // Filter by guard
                        if (toolInput.guard_name) {
                            const guard = findGuard(toolInput.guard_name);
                            if (guard) {
                                filtered = filtered.filter(c => c.guardId === guard.id);
                            }
                        }
                        
                        // Filter by site
                        if (toolInput.site_name) {
                            const site = findSite(toolInput.site_name);
                            if (site) {
                                filtered = filtered.filter(c => c.siteId === site.id);
                            }
                        }
                        
                        const history = filtered.map(c => {
                            const guard = guards.find(g => g.id === c.guardId);
                            const site = sites.find(s => s.id === c.siteId);
                            const replacement = c.replacementGuardId ? guards.find(g => g.id === c.replacementGuardId) : null;
                            return {
                                date: c.date,
                                guard: guard?.name || 'Unknown',
                                site: site?.name || 'Unknown',
                                shift: c.shift,
                                reason: c.reason,
                                status: c.coverageStatus,
                                replacement: replacement?.name || null,
                                isNCNS: c.isNCNS || false
                            };
                        }).sort((a, b) => b.date.localeCompare(a.date));
                        
                        // Calculate stats
                        const stats = {
                            total: history.length,
                            covered: history.filter(h => h.status === 'covered').length,
                            uncovered: history.filter(h => h.status === 'uncovered').length,
                            pending: history.filter(h => h.status === 'pending').length,
                            ncns: history.filter(h => h.isNCNS).length
                        };
                        
                        // Find frequent callers
                        const guardCounts = {};
                        history.forEach(h => {
                            guardCounts[h.guard] = (guardCounts[h.guard] || 0) + 1;
                        });
                        const frequentCallers = Object.entries(guardCounts)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 5)
                            .map(([name, count]) => ({ name, count }));
                        
                        return {
                            success: true,
                            period: `Last ${days} days`,
                            stats,
                            frequentCallers,
                            history: history.slice(0, 20), // Limit to 20 most recent
                            totalRecords: history.length
                        };
                    }
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // GUARD MANAGEMENT TOOLS
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    
                    case 'add_guard': {
                        const name = toolInput.name?.trim();
                        if (!name) {
                            return { success: false, error: 'Guard name is required' };
                        }
                        
                        // Check for duplicates
                        const existing = guards.find(g => g.name?.toLowerCase() === name.toLowerCase());
                        if (existing) {
                            return { success: false, error: `A guard named "${name}" already exists (${existing.status})` };
                        }
                        
                        const nameParts = name.split(' ');
                        const firstName = nameParts[0] || '';
                        const lastName = nameParts.slice(1).join(' ') || '';
                        
                        // Resolve primary sites if provided
                        let primarySiteIds = [];
                        if (toolInput.primary_sites && toolInput.primary_sites.length > 0) {
                            primarySiteIds = toolInput.primary_sites
                                .map(siteName => findSite(siteName))
                                .filter(s => s)
                                .map(s => s.id);
                        }
                        
                        const newGuard = {
                            id: Utils.generateId('guard-'),
                            name: name,
                            firstName: firstName,
                            lastName: lastName,
                            phone: toolInput.phone || '',
                            email: toolInput.email || '',
                            primarySites: primarySiteIds,
                            role: toolInput.role || 'Officer',
                            status: 'active',
                            notes: `Added via AI Assistant on ${new Date().toLocaleDateString()}`,
                            createdAt: new Date().toISOString()
                        };
                        
                        guards.push(newGuard);
                        DataStore.saveGuards(guards);
                        
                        const siteNames = primarySiteIds.map(id => sites.find(s => s.id === id)?.name).filter(Boolean);
                        
                        return {
                            success: true,
                            message: `âœ… Added ${newGuard.name} to the roster`,
                            guard: {
                                id: newGuard.id,
                                name: newGuard.name,
                                phone: newGuard.phone,
                                email: newGuard.email,
                                role: newGuard.role,
                                status: newGuard.status,
                                primarySites: siteNames
                            }
                        };
                    }
                    
                    case 'update_guard': {
                        const guard = findGuard(toolInput.guard_name);
                        if (!guard) {
                            return { success: false, error: `Could not find guard matching "${toolInput.guard_name}"` };
                        }
                        
                        const idx = guards.findIndex(g => g.id === guard.id);
                        if (idx === -1) {
                            return { success: false, error: 'Guard not found in roster' };
                        }
                        
                        const updates = [];
                        
                        if (toolInput.phone) {
                            guards[idx].phone = toolInput.phone;
                            updates.push(`phone â†’ ${toolInput.phone}`);
                        }
                        
                        if (toolInput.email) {
                            guards[idx].email = toolInput.email;
                            updates.push(`email â†’ ${toolInput.email}`);
                        }
                        
                        if (toolInput.role) {
                            guards[idx].role = toolInput.role;
                            updates.push(`role â†’ ${toolInput.role}`);
                        }
                        
                        if (toolInput.notes) {
                            guards[idx].notes = (guards[idx].notes ? guards[idx].notes + '\n' : '') + toolInput.notes;
                            updates.push('notes updated');
                        }
                        
                        if (toolInput.primary_sites && toolInput.primary_sites.length > 0) {
                            const siteIds = toolInput.primary_sites
                                .map(siteName => findSite(siteName))
                                .filter(s => s)
                                .map(s => s.id);
                            guards[idx].primarySites = siteIds;
                            const siteNames = siteIds.map(id => sites.find(s => s.id === id)?.name).filter(Boolean);
                            updates.push(`primary sites â†’ ${siteNames.join(', ')}`);
                        }
                        
                        if (updates.length === 0) {
                            return { success: false, error: 'No updates provided. Specify phone, email, role, notes, or primary_sites.' };
                        }
                        
                        DataStore.saveGuards(guards);
                        
                        return {
                            success: true,
                            message: `âœ… Updated ${guard.name}`,
                            updates: updates,
                            guard: {
                                name: guards[idx].name,
                                phone: guards[idx].phone,
                                email: guards[idx].email,
                                role: guards[idx].role,
                                status: guards[idx].status
                            }
                        };
                    }
                    
                    case 'suspend_guard': {
                        const guard = findGuard(toolInput.guard_name);
                        if (!guard) {
                            return { success: false, error: `Could not find guard matching "${toolInput.guard_name}"` };
                        }
                        
                        if (guard.status === 'suspended') {
                            return { success: false, error: `${guard.name} is already suspended until ${guard.suspensionEnd || 'TBD'}` };
                        }
                        
                        const idx = guards.findIndex(g => g.id === guard.id);
                        
                        const startDate = Utils.toISODate(new Date());
                        let endDate;
                        
                        if (toolInput.end_date) {
                            endDate = parseDate(toolInput.end_date);
                        } else {
                            const days = toolInput.days || 3;
                            const end = new Date();
                            end.setDate(end.getDate() + days);
                            endDate = Utils.toISODate(end);
                        }
                        
                        guards[idx].status = 'suspended';
                        guards[idx].suspensionStart = startDate;
                        guards[idx].suspensionEnd = endDate;
                        guards[idx].suspensionNotes = toolInput.reason || 'Suspended via AI Assistant';
                        
                        DataStore.saveGuards(guards);
                        
                        return {
                            success: true,
                            message: `âš ï¸ ${guard.name} has been SUSPENDED`,
                            details: {
                                guard: guard.name,
                                suspensionStart: startDate,
                                suspensionEnd: endDate,
                                reason: guards[idx].suspensionNotes
                            }
                        };
                    }
                    
                    case 'activate_guard': {
                        const guard = findGuard(toolInput.guard_name);
                        if (!guard) {
                            return { success: false, error: `Could not find guard matching "${toolInput.guard_name}"` };
                        }
                        
                        if (guard.status === 'active') {
                            return { success: false, error: `${guard.name} is already active` };
                        }
                        
                        const idx = guards.findIndex(g => g.id === guard.id);
                        const previousStatus = guards[idx].status;
                        
                        guards[idx].status = 'active';
                        guards[idx].suspensionStart = null;
                        guards[idx].suspensionEnd = null;
                        guards[idx].notes = (guards[idx].notes ? guards[idx].notes + '\n' : '') + 
                            `Activated from ${previousStatus} on ${new Date().toLocaleDateString()}` +
                            (toolInput.notes ? ` - ${toolInput.notes}` : '');
                        
                        DataStore.saveGuards(guards);
                        
                        return {
                            success: true,
                            message: `âœ… ${guard.name} is now ACTIVE and available for scheduling`,
                            details: {
                                guard: guard.name,
                                phone: guard.phone,
                                previousStatus: previousStatus
                            }
                        };
                    }
                    
                    case 'deactivate_guard': {
                        const guard = findGuard(toolInput.guard_name);
                        if (!guard) {
                            return { success: false, error: `Could not find guard matching "${toolInput.guard_name}"` };
                        }
                        
                        if (guard.status === 'inactive') {
                            return { success: false, error: `${guard.name} is already inactive` };
                        }
                        
                        const idx = guards.findIndex(g => g.id === guard.id);
                        
                        guards[idx].status = 'inactive';
                        guards[idx].notes = (guards[idx].notes ? guards[idx].notes + '\n' : '') + 
                            `Deactivated on ${new Date().toLocaleDateString()}` +
                            (toolInput.reason ? ` - Reason: ${toolInput.reason}` : '');
                        
                        DataStore.saveGuards(guards);
                        
                        return {
                            success: true,
                            message: `ğŸš« ${guard.name} has been DEACTIVATED`,
                            details: {
                                guard: guard.name,
                                reason: toolInput.reason || 'Not specified'
                            }
                        };
                    }
                    
                    case 'get_guard_info': {
                        const guard = findGuard(toolInput.guard_name);
                        if (!guard) {
                            return { success: false, error: `Could not find guard matching "${toolInput.guard_name}"` };
                        }
                        
                        // Get their schedule for this week
                        const weekKey = Utils.getWeekKey(new Date());
                        const allShifts = DataStore.getScheduleForWeek(weekKey) || [];
                        const guardShifts = allShifts.filter(s => s.guardId === guard.id)
                            .sort((a, b) => a.date.localeCompare(b.date))
                            .map(s => {
                                const site = sites.find(st => st.id === s.siteId);
                                return {
                                    date: s.date,
                                    site: site?.name || 'Unknown',
                                    shift: s.shiftLabel || `${s.startTime}-${s.endTime}`
                                };
                            });
                        
                        // Get call-off stats
                        const calloffs = DataStore.getCalloffs() || [];
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        const recentCalloffs = calloffs.filter(c => 
                            c.guardId === guard.id && 
                            new Date(c.date) >= thirtyDaysAgo
                        );
                        
                        // Get primary site names
                        const primarySiteNames = (guard.primarySites || [])
                            .map(id => sites.find(s => s.id === id)?.name)
                            .filter(Boolean);
                        
                        return {
                            success: true,
                            guard: {
                                id: guard.id,
                                name: guard.name,
                                phone: guard.phone,
                                email: guard.email,
                                role: guard.role,
                                status: guard.status,
                                primarySites: primarySiteNames,
                                notes: guard.notes,
                                suspension: guard.status === 'suspended' ? {
                                    start: guard.suspensionStart,
                                    end: guard.suspensionEnd,
                                    reason: guard.suspensionNotes
                                } : null
                            },
                            thisWeekShifts: guardShifts,
                            calloffStats: {
                                last30Days: recentCalloffs.length,
                                ncnsCount: recentCalloffs.filter(c => c.isNCNS).length
                            }
                        };
                    }
                    
                    case 'list_guards': {
                        let filtered = [...guards];
                        
                        // Filter by status
                        const statusFilter = (toolInput.status || 'active').toLowerCase();
                        if (statusFilter !== 'all') {
                            filtered = filtered.filter(g => g.status === statusFilter);
                        }
                        
                        // Filter by role
                        if (toolInput.role) {
                            const roleLower = toolInput.role.toLowerCase();
                            filtered = filtered.filter(g => g.role?.toLowerCase().includes(roleLower));
                        }
                        
                        // Filter by site
                        if (toolInput.site_name) {
                            const site = findSite(toolInput.site_name);
                            if (site) {
                                filtered = filtered.filter(g => 
                                    (g.primarySites || []).includes(site.id)
                                );
                            }
                        }
                        
                        const result = filtered.map(g => ({
                            name: g.name,
                            phone: g.phone,
                            role: g.role,
                            status: g.status,
                            suspensionEnd: g.status === 'suspended' ? g.suspensionEnd : null
                        })).sort((a, b) => a.name.localeCompare(b.name));
                        
                        return {
                            success: true,
                            filters: {
                                status: statusFilter,
                                role: toolInput.role || 'all',
                                site: toolInput.site_name || 'all'
                            },
                            guards: result,
                            count: result.length,
                            totalInSystem: guards.length
                        };
                    }
                    
                    case 'search_guards': {
                        const query = (toolInput.query || '').toLowerCase().trim();
                        if (!query) {
                            return { success: false, error: 'Search query is required' };
                        }
                        
                        const matches = guards.filter(g => 
                            g.name?.toLowerCase().includes(query) ||
                            g.firstName?.toLowerCase().includes(query) ||
                            g.lastName?.toLowerCase().includes(query) ||
                            g.phone?.includes(query) ||
                            g.email?.toLowerCase().includes(query)
                        ).map(g => ({
                            name: g.name,
                            phone: g.phone,
                            email: g.email,
                            role: g.role,
                            status: g.status
                        }));
                        
                        return {
                            success: true,
                            query: toolInput.query,
                            results: matches,
                            count: matches.length
                        };
                    }
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // COMMUNICATIONS TOOLS
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    
                    case 'log_communication': {
                        if (!toolInput.subject) {
                            return { success: false, error: 'Subject is required for logging communication' };
                        }
                        
                        // Determine type from context if not specified
                        let commType = toolInput.type || 'phone_outbound';
                        if (!toolInput.type) {
                            const subjectLower = (toolInput.subject + ' ' + (toolInput.summary || '')).toLowerCase();
                            if (subjectLower.includes('email') || subjectLower.includes('sent') || subjectLower.includes('wrote')) {
                                commType = 'email_outbound';
                            } else if (subjectLower.includes('received') || subjectLower.includes('got a call')) {
                                commType = 'phone_inbound';
                            } else if (subjectLower.includes('meeting') || subjectLower.includes('met with')) {
                                commType = 'in_person';
                            } else if (subjectLower.includes('text') || subjectLower.includes('sms')) {
                                commType = 'text';
                            }
                        }
                        
                        // Determine party type
                        let party = toolInput.party || 'client';
                        if (!toolInput.party && toolInput.contact_name) {
                            // Check if contact is a guard
                            const matchedGuard = findGuard(toolInput.contact_name);
                            if (matchedGuard) {
                                party = 'guard';
                            }
                        }
                        
                        // Resolve site and guard if provided
                        const site = toolInput.site_name ? findSite(toolInput.site_name) : null;
                        const relatedGuard = toolInput.guard_name ? findGuard(toolInput.guard_name) : null;
                        
                        const comm = {
                            id: Utils.generateId('comm-'),
                            type: commType,
                            party: party,
                            contactName: toolInput.contact_name || null,
                            contactInfo: toolInput.contact_info || null,
                            dateTime: new Date().toISOString(),
                            duration: toolInput.duration || null,
                            siteId: site?.id || null,
                            guardId: relatedGuard?.id || null,
                            subject: toolInput.subject,
                            summary: toolInput.summary || null,
                            loggedBy: 'AI Assistant',
                            followUpRequired: toolInput.follow_up_required || false,
                            followUpDate: toolInput.follow_up_date ? parseDate(toolInput.follow_up_date) : null,
                            followUpAction: toolInput.follow_up_action || null,
                            followUpStatus: toolInput.follow_up_required ? 'pending' : null,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        DataStore.addCommunication(comm);
                        
                        const typeLabels = {
                            phone_inbound: 'ğŸ“ Phone (Inbound)',
                            phone_outbound: 'ğŸ“± Phone (Outbound)',
                            email_inbound: 'ğŸ“¨ Email (Received)',
                            email_outbound: 'ğŸ“§ Email (Sent)',
                            in_person: 'ğŸ¤ In-Person',
                            text: 'ğŸ’¬ Text/SMS',
                            video: 'ğŸ–¥ï¸ Video Call',
                            radio: 'ğŸ“» Radio'
                        };
                        
                        return {
                            success: true,
                            message: `âœ… Communication logged`,
                            communication: {
                                id: comm.id,
                                type: typeLabels[commType] || commType,
                                contact: toolInput.contact_name || 'Not specified',
                                subject: comm.subject,
                                site: site?.name || null,
                                followUp: comm.followUpRequired ? `Yes - ${comm.followUpDate || 'Date TBD'}` : 'No'
                            }
                        };
                    }
                    
                    case 'get_communications': {
                        let comms = DataStore.getCommunications() || [];
                        
                        // Apply date filter
                        if (toolInput.today_only) {
                            const today = Utils.toISODate(new Date());
                            comms = comms.filter(c => c.dateTime?.startsWith(today));
                        } else {
                            const days = toolInput.days || 7;
                            const cutoff = new Date();
                            cutoff.setDate(cutoff.getDate() - days);
                            comms = comms.filter(c => new Date(c.dateTime) >= cutoff);
                        }
                        
                        // Filter by site
                        if (toolInput.site_name) {
                            const site = findSite(toolInput.site_name);
                            if (site) {
                                comms = comms.filter(c => c.siteId === site.id);
                            }
                        }
                        
                        // Filter by party
                        if (toolInput.party) {
                            comms = comms.filter(c => c.party === toolInput.party);
                        }
                        
                        // Filter by type
                        if (toolInput.type) {
                            comms = comms.filter(c => c.type?.includes(toolInput.type));
                        }
                        
                        // Search by contact name
                        if (toolInput.contact_name) {
                            const searchTerm = toolInput.contact_name.toLowerCase();
                            comms = comms.filter(c => 
                                c.contactName?.toLowerCase().includes(searchTerm)
                            );
                        }
                        
                        const typeLabels = {
                            phone_inbound: 'ğŸ“ Inbound',
                            phone_outbound: 'ğŸ“± Outbound',
                            email_inbound: 'ğŸ“¨ Received',
                            email_outbound: 'ğŸ“§ Sent',
                            in_person: 'ğŸ¤ In-Person',
                            text: 'ğŸ’¬ Text',
                            video: 'ğŸ–¥ï¸ Video',
                            radio: 'ğŸ“» Radio'
                        };
                        
                        const result = comms.slice(0, 20).map(c => {
                            const site = c.siteId ? sites.find(s => s.id === c.siteId) : null;
                            return {
                                id: c.id,
                                date: new Date(c.dateTime).toLocaleDateString(),
                                time: new Date(c.dateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                                type: typeLabels[c.type] || c.type,
                                contact: c.contactName || 'Not specified',
                                subject: c.subject,
                                site: site?.name || null,
                                hasFollowUp: c.followUpRequired,
                                followUpStatus: c.followUpStatus
                            };
                        });
                        
                        return {
                            success: true,
                            communications: result,
                            count: result.length,
                            totalMatching: comms.length
                        };
                    }
                    
                    case 'get_pending_followups': {
                        const comms = DataStore.getCommunications() || [];
                        const now = new Date();
                        const includeOverdue = toolInput.include_overdue !== false;
                        
                        let pending = comms.filter(c => 
                            c.followUpRequired && 
                            c.followUpStatus !== 'completed'
                        );
                        
                        // Sort by urgency (overdue first, then by date)
                        pending = pending.map(c => {
                            const followUpDate = c.followUpDate ? new Date(c.followUpDate) : null;
                            const isOverdue = followUpDate && followUpDate < now;
                            return { ...c, isOverdue, followUpDateObj: followUpDate };
                        }).sort((a, b) => {
                            if (a.isOverdue && !b.isOverdue) return -1;
                            if (!a.isOverdue && b.isOverdue) return 1;
                            if (a.followUpDateObj && b.followUpDateObj) {
                                return a.followUpDateObj - b.followUpDateObj;
                            }
                            return 0;
                        });
                        
                        const result = pending.slice(0, 15).map(c => {
                            const site = c.siteId ? sites.find(s => s.id === c.siteId) : null;
                            return {
                                id: c.id,
                                contact: c.contactName || 'Unknown',
                                subject: c.subject,
                                site: site?.name || null,
                                originalDate: new Date(c.dateTime).toLocaleDateString(),
                                followUpDate: c.followUpDate || 'Not set',
                                followUpAction: c.followUpAction || 'Not specified',
                                isOverdue: c.isOverdue,
                                urgency: c.isOverdue ? 'ğŸ”´ OVERDUE' : 'ğŸŸ¡ Pending'
                            };
                        });
                        
                        const overdueCount = result.filter(r => r.isOverdue).length;
                        
                        return {
                            success: true,
                            followUps: result,
                            count: result.length,
                            overdueCount: overdueCount,
                            message: overdueCount > 0 ? 
                                `âš ï¸ ${overdueCount} overdue follow-up(s)!` : 
                                result.length > 0 ? `${result.length} pending follow-up(s)` : 'No pending follow-ups! ğŸ‰'
                        };
                    }
                    
                    case 'complete_followup': {
                        const comms = DataStore.getCommunications() || [];
                        let comm = null;
                        
                        if (toolInput.communication_id) {
                            comm = comms.find(c => c.id === toolInput.communication_id);
                        } else if (toolInput.contact_name) {
                            const searchTerm = toolInput.contact_name.toLowerCase();
                            comm = comms.find(c => 
                                c.followUpRequired && 
                                c.followUpStatus !== 'completed' &&
                                c.contactName?.toLowerCase().includes(searchTerm)
                            );
                        } else {
                            // Get most recent pending follow-up
                            comm = comms.find(c => 
                                c.followUpRequired && 
                                c.followUpStatus !== 'completed'
                            );
                        }
                        
                        if (!comm) {
                            return { success: false, error: 'Could not find a pending follow-up to complete. Use get_pending_followups to see all.' };
                        }
                        
                        DataStore.updateCommunication(comm.id, {
                            followUpStatus: 'completed',
                            followUpNotes: (comm.followUpNotes ? comm.followUpNotes + '\n' : '') +
                                `Completed on ${new Date().toLocaleString()}` +
                                (toolInput.notes ? ` - ${toolInput.notes}` : '')
                        });
                        
                        return {
                            success: true,
                            message: `âœ… Follow-up completed for ${comm.contactName || 'communication'}`,
                            details: {
                                subject: comm.subject,
                                contact: comm.contactName,
                                originalDate: new Date(comm.dateTime).toLocaleDateString(),
                                completedNotes: toolInput.notes || 'Marked complete'
                            }
                        };
                    }
                    
                    case 'search_communications': {
                        const query = (toolInput.query || '').toLowerCase().trim();
                        if (!query) {
                            return { success: false, error: 'Search query is required' };
                        }
                        
                        let comms = DataStore.getCommunications() || [];
                        
                        // Date filter
                        const days = toolInput.days || 30;
                        const cutoff = new Date();
                        cutoff.setDate(cutoff.getDate() - days);
                        comms = comms.filter(c => new Date(c.dateTime) >= cutoff);
                        
                        // Search in subject, summary, contact name
                        const matches = comms.filter(c =>
                            c.subject?.toLowerCase().includes(query) ||
                            c.summary?.toLowerCase().includes(query) ||
                            c.contactName?.toLowerCase().includes(query) ||
                            c.followUpAction?.toLowerCase().includes(query)
                        );
                        
                        const result = matches.slice(0, 15).map(c => {
                            const site = c.siteId ? sites.find(s => s.id === c.siteId) : null;
                            return {
                                id: c.id,
                                date: new Date(c.dateTime).toLocaleDateString(),
                                contact: c.contactName || 'Not specified',
                                subject: c.subject,
                                summary: c.summary ? (c.summary.length > 100 ? c.summary.slice(0, 100) + '...' : c.summary) : null,
                                site: site?.name || null
                            };
                        });
                        
                        return {
                            success: true,
                            query: toolInput.query,
                            results: result,
                            count: result.length,
                            searchedDays: days
                        };
                    }
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // INCIDENT MANAGEMENT TOOLS
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    
                    case 'log_incident': {
                        const site = findSite(toolInput.site_name);
                        if (!site) {
                            return { success: false, error: `Could not find site matching "${toolInput.site_name}". Sites: ${sites.map(s => s.name).join(', ')}` };
                        }
                        
                        if (!toolInput.type) {
                            return { success: false, error: 'Incident type is required (e.g., trespassing, theft, fire alarm)' };
                        }
                        
                        if (!toolInput.narrative) {
                            return { success: false, error: 'Incident narrative/description is required' };
                        }
                        
                        // Parse date/time
                        let incidentDateTime = new Date();
                        if (toolInput.date_time) {
                            const dtLower = toolInput.date_time.toLowerCase();
                            if (dtLower === 'now') {
                                incidentDateTime = new Date();
                            } else if (dtLower === 'yesterday') {
                                incidentDateTime = new Date();
                                incidentDateTime.setDate(incidentDateTime.getDate() - 1);
                            } else if (dtLower.includes('today')) {
                                // Parse time like "today 3pm"
                                const timeMatch = dtLower.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/i);
                                if (timeMatch) {
                                    let hours = parseInt(timeMatch[1]);
                                    const minutes = parseInt(timeMatch[2] || '0');
                                    const ampm = timeMatch[3]?.toLowerCase();
                                    if (ampm === 'pm' && hours < 12) hours += 12;
                                    if (ampm === 'am' && hours === 12) hours = 0;
                                    incidentDateTime.setHours(hours, minutes, 0, 0);
                                }
                            } else {
                                // Try parsing as date
                                const parsed = new Date(toolInput.date_time);
                                if (!isNaN(parsed)) incidentDateTime = parsed;
                            }
                        }
                        
                        // Get guard if specified
                        const involvedGuard = toolInput.guard_name ? findGuard(toolInput.guard_name) : null;
                        
                        // Generate incident ID
                        const incidents = DataStore.getIncidents() || [];
                        const incNum = String(incidents.length + 1).padStart(3, '0');
                        
                        const incident = {
                            id: `INC-${incNum}`,
                            siteId: site.id,
                            dateTime: incidentDateTime.toISOString(),
                            guardIds: involvedGuard ? [involvedGuard.id] : [],
                            type: toolInput.type,
                            severity: toolInput.severity || 'Medium',
                            narrative: toolInput.narrative,
                            attachments: [],
                            status: toolInput.status || 'Open',
                            createdAt: new Date().toISOString(),
                            createdBy: 'AI Assistant'
                        };
                        
                        DataStore.addIncident(incident);
                        
                        const severityIcons = { Low: 'ğŸŸ¢', Medium: 'ğŸŸ¡', High: 'ğŸŸ ', Critical: 'ğŸ”´' };
                        
                        return {
                            success: true,
                            message: `${severityIcons[incident.severity] || 'âš ï¸'} Incident ${incident.id} logged`,
                            incident: {
                                id: incident.id,
                                site: site.name,
                                type: incident.type,
                                severity: incident.severity,
                                status: incident.status,
                                dateTime: incidentDateTime.toLocaleString(),
                                guard: involvedGuard?.name || null
                            }
                        };
                    }
                    
                    case 'get_incidents': {
                        let incidents = DataStore.getIncidents() || [];
                        
                        // Date filter
                        const days = toolInput.days || 30;
                        const cutoff = new Date();
                        cutoff.setDate(cutoff.getDate() - days);
                        incidents = incidents.filter(i => new Date(i.dateTime) >= cutoff);
                        
                        // Filter by site
                        if (toolInput.site_name) {
                            const site = findSite(toolInput.site_name);
                            if (site) {
                                incidents = incidents.filter(i => i.siteId === site.id);
                            }
                        }
                        
                        // Filter by status
                        if (toolInput.status && toolInput.status.toLowerCase() !== 'all') {
                            incidents = incidents.filter(i => 
                                i.status?.toLowerCase() === toolInput.status.toLowerCase()
                            );
                        }
                        
                        // Filter by severity
                        if (toolInput.severity) {
                            incidents = incidents.filter(i => 
                                i.severity?.toLowerCase() === toolInput.severity.toLowerCase()
                            );
                        }
                        
                        // Sort by date descending
                        incidents.sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));
                        
                        const severityIcons = { Low: 'ğŸŸ¢', Medium: 'ğŸŸ¡', High: 'ğŸŸ ', Critical: 'ğŸ”´' };
                        
                        const result = incidents.slice(0, 20).map(i => {
                            const site = sites.find(s => s.id === i.siteId);
                            const daysOpen = i.status !== 'Resolved' ? 
                                Math.floor((new Date() - new Date(i.dateTime)) / (1000 * 60 * 60 * 24)) : null;
                            return {
                                id: i.id,
                                date: new Date(i.dateTime).toLocaleDateString(),
                                site: site?.name || 'Unknown',
                                type: i.type,
                                severity: `${severityIcons[i.severity] || 'âš ï¸'} ${i.severity}`,
                                status: i.status,
                                daysOpen: daysOpen,
                                narrative: i.narrative?.length > 80 ? i.narrative.slice(0, 80) + '...' : i.narrative
                            };
                        });
                        
                        const openCount = incidents.filter(i => i.status === 'Open').length;
                        const criticalCount = incidents.filter(i => i.severity === 'Critical' && i.status !== 'Resolved').length;
                        
                        return {
                            success: true,
                            incidents: result,
                            count: result.length,
                            totalMatching: incidents.length,
                            summary: {
                                open: openCount,
                                critical: criticalCount
                            },
                            message: criticalCount > 0 ? `ğŸ”´ ${criticalCount} critical incident(s) need attention!` : 
                                     openCount > 0 ? `${openCount} open incident(s)` : 'No open incidents'
                        };
                    }
                    
                    case 'update_incident': {
                        const incidents = DataStore.getIncidents() || [];
                        let incident = null;
                        
                        if (toolInput.incident_id) {
                            incident = incidents.find(i => 
                                i.id?.toLowerCase() === toolInput.incident_id.toLowerCase()
                            );
                        } else if (toolInput.site_name) {
                            const site = findSite(toolInput.site_name);
                            if (site) {
                                // Find most recent open incident at this site
                                incident = incidents.find(i => 
                                    i.siteId === site.id && i.status !== 'Resolved'
                                );
                            }
                        } else {
                            // Get most recent open incident
                            incident = incidents.find(i => i.status !== 'Resolved');
                        }
                        
                        if (!incident) {
                            return { success: false, error: 'Could not find incident to update. Specify incident_id or site_name.' };
                        }
                        
                        const updates = [];
                        const updateData = {};
                        
                        if (toolInput.status) {
                            updateData.status = toolInput.status;
                            updates.push(`status â†’ ${toolInput.status}`);
                        }
                        
                        if (toolInput.severity) {
                            updateData.severity = toolInput.severity;
                            updates.push(`severity â†’ ${toolInput.severity}`);
                        }
                        
                        if (toolInput.narrative) {
                            updateData.narrative = (incident.narrative || '') + 
                                `\n\n--- Update ${new Date().toLocaleString()} ---\n${toolInput.narrative}`;
                            updates.push('narrative updated');
                        }
                        
                        if (updates.length === 0) {
                            return { success: false, error: 'No updates provided. Specify status, severity, or narrative.' };
                        }
                        
                        updateData.updatedAt = new Date().toISOString();
                        DataStore.updateIncident(incident.id, updateData);
                        
                        const site = sites.find(s => s.id === incident.siteId);
                        
                        return {
                            success: true,
                            message: `âœ… Updated incident ${incident.id}`,
                            incident: {
                                id: incident.id,
                                site: site?.name,
                                type: incident.type,
                                newStatus: updateData.status || incident.status,
                                newSeverity: updateData.severity || incident.severity
                            },
                            updates: updates
                        };
                    }
                    
                    case 'get_incident_stats': {
                        let incidents = DataStore.getIncidents() || [];
                        
                        // Date filter
                        const days = toolInput.days || 30;
                        const cutoff = new Date();
                        cutoff.setDate(cutoff.getDate() - days);
                        incidents = incidents.filter(i => new Date(i.dateTime) >= cutoff);
                        
                        // Site filter
                        if (toolInput.site_name) {
                            const site = findSite(toolInput.site_name);
                            if (site) {
                                incidents = incidents.filter(i => i.siteId === site.id);
                            }
                        }
                        
                        // Calculate stats
                        const byStatus = {};
                        const bySeverity = {};
                        const byType = {};
                        const bySite = {};
                        
                        incidents.forEach(i => {
                            byStatus[i.status] = (byStatus[i.status] || 0) + 1;
                            bySeverity[i.severity] = (bySeverity[i.severity] || 0) + 1;
                            byType[i.type] = (byType[i.type] || 0) + 1;
                            
                            const site = sites.find(s => s.id === i.siteId);
                            const siteName = site?.name || 'Unknown';
                            bySite[siteName] = (bySite[siteName] || 0) + 1;
                        });
                        
                        // Top incident types
                        const topTypes = Object.entries(byType)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 5)
                            .map(([type, count]) => ({ type, count }));
                        
                        // Sites with most incidents
                        const topSites = Object.entries(bySite)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 5)
                            .map(([site, count]) => ({ site, count }));
                        
                        // Average resolution time
                        const resolvedIncidents = incidents.filter(i => i.status === 'Resolved' && i.dateTime);
                        let avgResolutionDays = null;
                        if (resolvedIncidents.length > 0) {
                            const totalDays = resolvedIncidents.reduce((sum, i) => {
                                const created = new Date(i.dateTime);
                                const updated = new Date(i.updatedAt || i.dateTime);
                                return sum + Math.max(0, (updated - created) / (1000 * 60 * 60 * 24));
                            }, 0);
                            avgResolutionDays = Math.round(totalDays / resolvedIncidents.length * 10) / 10;
                        }
                        
                        return {
                            success: true,
                            period: `Last ${days} days`,
                            totalIncidents: incidents.length,
                            byStatus,
                            bySeverity,
                            topTypes,
                            topSites,
                            avgResolutionDays,
                            openCount: byStatus['Open'] || 0,
                            criticalOpen: incidents.filter(i => i.severity === 'Critical' && i.status !== 'Resolved').length
                        };
                    }
                    
                    case 'search_incidents': {
                        const query = (toolInput.query || '').toLowerCase().trim();
                        if (!query) {
                            return { success: false, error: 'Search query is required' };
                        }
                        
                        let incidents = DataStore.getIncidents() || [];
                        
                        // Date filter
                        const days = toolInput.days || 90;
                        const cutoff = new Date();
                        cutoff.setDate(cutoff.getDate() - days);
                        incidents = incidents.filter(i => new Date(i.dateTime) >= cutoff);
                        
                        // Search
                        const matches = incidents.filter(i =>
                            i.type?.toLowerCase().includes(query) ||
                            i.narrative?.toLowerCase().includes(query) ||
                            i.id?.toLowerCase().includes(query)
                        );
                        
                        const severityIcons = { Low: 'ğŸŸ¢', Medium: 'ğŸŸ¡', High: 'ğŸŸ ', Critical: 'ğŸ”´' };
                        
                        const result = matches.slice(0, 15).map(i => {
                            const site = sites.find(s => s.id === i.siteId);
                            return {
                                id: i.id,
                                date: new Date(i.dateTime).toLocaleDateString(),
                                site: site?.name || 'Unknown',
                                type: i.type,
                                severity: `${severityIcons[i.severity] || 'âš ï¸'} ${i.severity}`,
                                status: i.status,
                                narrative: i.narrative?.length > 80 ? i.narrative.slice(0, 80) + '...' : i.narrative
                            };
                        });
                        
                        return {
                            success: true,
                            query: toolInput.query,
                            results: result,
                            count: result.length,
                            searchedDays: days
                        };
                    }
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // SITE MANAGEMENT TOOLS
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    
                    case 'get_site_info': {
                        const site = findSite(toolInput.site_name);
                        if (!site) {
                            return { success: false, error: `Could not find site matching "${toolInput.site_name}". Sites: ${sites.map(s => s.name).join(', ')}` };
                        }
                        
                        // Get contacts for this site
                        const contacts = DataStore.getContacts() || [];
                        const siteContacts = contacts.filter(c => 
                            c.linkedSites?.includes(site.id) && c.status === 'active'
                        ).map(c => ({
                            name: c.name,
                            role: c.role,
                            phone: c.phone,
                            email: c.email,
                            category: c.category
                        }));
                        
                        // Get today's coverage
                        const today = Utils.toISODate(new Date());
                        const weekKey = Utils.getWeekKey(new Date());
                        const allShifts = DataStore.getScheduleForWeek(weekKey) || [];
                        const todayShifts = allShifts.filter(s => s.siteId === site.id && s.date === today)
                            .map(s => {
                                const guard = guards.find(g => g.id === s.guardId);
                                return {
                                    guard: guard?.name || 'UNASSIGNED',
                                    phone: guard?.phone,
                                    shift: s.shiftLabel || `${s.startTime}-${s.endTime}`
                                };
                            });
                        
                        // Get recent incidents (last 30 days)
                        const incidents = DataStore.getIncidents() || [];
                        const cutoff = new Date();
                        cutoff.setDate(cutoff.getDate() - 30);
                        const recentIncidents = incidents.filter(i => 
                            i.siteId === site.id && new Date(i.dateTime) >= cutoff
                        );
                        const openIncidents = recentIncidents.filter(i => i.status !== 'Resolved');
                        
                        return {
                            success: true,
                            site: {
                                id: site.id,
                                name: site.name,
                                address: site.address,
                                type: site.type || 'Not specified',
                                managementCompany: site.managementCompany || 'Not specified',
                                shiftPatterns: site.shiftPatterns || [],
                                sopHighlights: site.sopHighlights || null,
                                riskNotes: site.riskNotes || null
                            },
                            contacts: siteContacts,
                            todayCoverage: todayShifts,
                            incidentStats: {
                                last30Days: recentIncidents.length,
                                currentlyOpen: openIncidents.length
                            }
                        };
                    }
                    
                    case 'list_sites': {
                        const includeStats = toolInput.include_stats !== false;
                        const incidents = includeStats ? (DataStore.getIncidents() || []) : [];
                        const contacts = DataStore.getContacts() || [];
                        
                        const today = Utils.toISODate(new Date());
                        const weekKey = Utils.getWeekKey(new Date());
                        const allShifts = includeStats ? (DataStore.getScheduleForWeek(weekKey) || []) : [];
                        
                        const cutoff = new Date();
                        cutoff.setDate(cutoff.getDate() - 30);
                        
                        const result = sites.map(site => {
                            const siteData = {
                                name: site.name,
                                address: site.address,
                                type: site.type || 'Not specified',
                                managementCompany: site.managementCompany || 'Not specified'
                            };
                            
                            if (includeStats) {
                                const siteIncidents = incidents.filter(i => i.siteId === site.id && new Date(i.dateTime) >= cutoff);
                                const todayShifts = allShifts.filter(s => s.siteId === site.id && s.date === today);
                                const siteContacts = contacts.filter(c => c.linkedSites?.includes(site.id) && c.status === 'active');
                                
                                siteData.incidentsLast30Days = siteIncidents.length;
                                siteData.openIncidents = siteIncidents.filter(i => i.status !== 'Resolved').length;
                                siteData.todayShifts = todayShifts.length;
                                siteData.contactCount = siteContacts.length;
                                siteData.hasCoverage = todayShifts.length > 0 ? 'âœ…' : 'âš ï¸ No coverage today';
                            }
                            
                            return siteData;
                        });
                        
                        return {
                            success: true,
                            sites: result,
                            count: result.length
                        };
                    }
                    
                    case 'add_site': {
                        if (!toolInput.name) {
                            return { success: false, error: 'Site name is required' };
                        }
                        if (!toolInput.address) {
                            return { success: false, error: 'Site address is required' };
                        }
                        
                        // Check for duplicate
                        const existing = sites.find(s => s.name?.toLowerCase() === toolInput.name.toLowerCase());
                        if (existing) {
                            return { success: false, error: `Site "${toolInput.name}" already exists` };
                        }
                        
                        const newSite = {
                            id: Utils.generateId('site-'),
                            name: toolInput.name,
                            address: toolInput.address,
                            type: toolInput.type || 'Other',
                            managementCompany: toolInput.management_company || '',
                            primaryContacts: [],
                            shiftPatterns: [{ label: 'Day', startTime: '08:00', endTime: '16:00' }],
                            sopHighlights: '',
                            riskNotes: '',
                            createdAt: new Date().toISOString()
                        };
                        
                        sites.push(newSite);
                        DataStore.saveSites(sites);
                        
                        return {
                            success: true,
                            message: `âœ… Site "${newSite.name}" created`,
                            site: {
                                id: newSite.id,
                                name: newSite.name,
                                address: newSite.address,
                                type: newSite.type
                            }
                        };
                    }
                    
                    case 'update_site': {
                        const site = findSite(toolInput.site_name);
                        if (!site) {
                            return { success: false, error: `Could not find site matching "${toolInput.site_name}"` };
                        }
                        
                        const idx = sites.findIndex(s => s.id === site.id);
                        const updates = [];
                        
                        if (toolInput.new_name) {
                            sites[idx].name = toolInput.new_name;
                            updates.push(`name â†’ ${toolInput.new_name}`);
                        }
                        if (toolInput.address) {
                            sites[idx].address = toolInput.address;
                            updates.push(`address updated`);
                        }
                        if (toolInput.management_company) {
                            sites[idx].managementCompany = toolInput.management_company;
                            updates.push(`management company â†’ ${toolInput.management_company}`);
                        }
                        if (toolInput.type) {
                            sites[idx].type = toolInput.type;
                            updates.push(`type â†’ ${toolInput.type}`);
                        }
                        if (toolInput.notes) {
                            sites[idx].sopHighlights = (sites[idx].sopHighlights ? sites[idx].sopHighlights + '\n' : '') + toolInput.notes;
                            updates.push('notes added');
                        }
                        
                        if (updates.length === 0) {
                            return { success: false, error: 'No updates provided' };
                        }
                        
                        DataStore.saveSites(sites);
                        
                        return {
                            success: true,
                            message: `âœ… Updated ${site.name}`,
                            updates: updates
                        };
                    }
                    
                    case 'get_site_coverage': {
                        const site = findSite(toolInput.site_name);
                        if (!site) {
                            return { success: false, error: `Could not find site matching "${toolInput.site_name}"` };
                        }
                        
                        const days = toolInput.days || 7;
                        const today = new Date();
                        const coverage = [];
                        
                        for (let i = 0; i < days; i++) {
                            const date = new Date(today);
                            date.setDate(date.getDate() + i);
                            const dateStr = Utils.toISODate(date);
                            const weekKey = Utils.getWeekKey(date);
                            const allShifts = DataStore.getScheduleForWeek(weekKey) || [];
                            
                            const dayShifts = allShifts
                                .filter(s => s.siteId === site.id && s.date === dateStr)
                                .map(s => {
                                    const guard = guards.find(g => g.id === s.guardId);
                                    return {
                                        guard: guard?.name || 'UNASSIGNED',
                                        phone: guard?.phone,
                                        shift: s.shiftLabel || `${s.startTime}-${s.endTime}`
                                    };
                                });
                            
                            coverage.push({
                                date: dateStr,
                                dayName: date.toLocaleDateString('en-US', { weekday: 'long' }),
                                shifts: dayShifts,
                                status: dayShifts.length > 0 ? 'âœ… Covered' : 'âš ï¸ No coverage'
                            });
                        }
                        
                        const uncoveredDays = coverage.filter(c => c.shifts.length === 0);
                        
                        return {
                            success: true,
                            site: site.name,
                            coverage: coverage,
                            summary: uncoveredDays.length > 0 ? 
                                `âš ï¸ ${uncoveredDays.length} day(s) without coverage` : 
                                `âœ… All ${days} days covered`
                        };
                    }
                    
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    // CONTACT MANAGEMENT TOOLS
                    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    
                    case 'add_contact': {
                        if (!toolInput.name) {
                            return { success: false, error: 'Contact name is required' };
                        }
                        
                        const contacts = DataStore.getContacts() || [];
                        
                        // Check for duplicate
                        const existing = contacts.find(c => c.name?.toLowerCase() === toolInput.name.toLowerCase());
                        if (existing) {
                            return { success: false, error: `Contact "${toolInput.name}" already exists` };
                        }
                        
                        // Auto-detect category from role if not provided
                        const rolePresets = {
                            internal: ['dispatch', 'supervisor', 'manager', 'hr', 'operations', 'training', 'admin', 'coordinator', 'director', 'owner', 'ceo', 'coo', 'office', 'scheduler', 'payroll', 'accounting'],
                            client: ['property manager', 'site manager', 'facility director', 'security director', 'building manager', 'poc', 'executive', 'superintendent', 'super', 'resident manager', 'leasing', 'tenant liaison', 'hoa', 'board member', 'association'],
                            vendor: ['account rep', 'sales', 'service tech', 'technician', 'driver', 'supplier', 'contractor', 'rep', 'representative', 'installer', 'maintenance', 'repair'],
                            emergency: ['police', 'fire', 'ems', 'ambulance', 'hospital', '911', 'emergency', 'detective', 'officer', 'marshal', 'sheriff', 'paramedic', 'first responder'],
                            utility: ['electric', 'gas', 'water', 'elevator', 'hvac', 'plumber', 'plumbing', 'electrician', 'utility', 'power', 'cable', 'internet', 'telecom'],
                            government: ['inspector', 'code enforcement', 'city', 'county', 'state', 'federal', 'health department', 'fire marshal', 'osha', 'compliance', 'regulator'],
                            legal: ['attorney', 'lawyer', 'insurance', 'adjuster', 'claims', 'legal', 'counsel', 'risk management'],
                            resident: ['tenant', 'resident', 'concierge', 'doorman', 'front desk', 'building staff', 'porter', 'custodian', 'janitor']
                        };
                        
                        let category = toolInput.category;
                        const roleLower = (toolInput.role || '').toLowerCase();
                        const companyLower = (toolInput.company || '').toLowerCase();
                        const combinedText = roleLower + ' ' + companyLower;
                        
                        if (!category && (roleLower || companyLower)) {
                            // Try to auto-detect category from role or company
                            for (const [cat, keywords] of Object.entries(rolePresets)) {
                                if (keywords.some(kw => combinedText.includes(kw))) {
                                    category = cat;
                                    break;
                                }
                            }
                        }
                        
                        // Default to internal if still not determined
                        if (!category) {
                            category = 'internal';
                        }
                        
                        // Resolve linked sites - can be string or array
                        let linkedSiteIds = [];
                        let sitesToLink = toolInput.linked_sites || [];
                        if (typeof sitesToLink === 'string') {
                            sitesToLink = [sitesToLink];
                        }
                        if (toolInput.site_name) {
                            sitesToLink.push(toolInput.site_name);
                        }
                        if (sitesToLink.length > 0) {
                            linkedSiteIds = sitesToLink
                                .map(siteName => findSite(siteName))
                                .filter(s => s)
                                .map(s => s.id);
                        }
                        
                        const contact = {
                            id: Utils.generateId('contact-'),
                            name: toolInput.name,
                            category: category,
                            role: toolInput.role || '',
                            company: toolInput.company || '',
                            phone: toolInput.phone || '',
                            phoneAlt: toolInput.phone_alt || '',
                            email: toolInput.email || '',
                            linkedSites: linkedSiteIds,
                            notes: toolInput.notes || '',
                            status: 'active',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        DataStore.addContact(contact);
                        
                        const linkedSiteNames = linkedSiteIds.map(id => sites.find(s => s.id === id)?.name).filter(Boolean);
                        const categoryLabels = { 
                            internal: 'ğŸ‘¤ Internal Staff', 
                            client: 'ğŸ¢ Client Contact', 
                            vendor: 'ğŸ”§ Vendor', 
                            emergency: 'ğŸš¨ Emergency',
                            utility: 'âš¡ Utility',
                            government: 'ğŸ›ï¸ Government',
                            legal: 'âš–ï¸ Legal',
                            resident: 'ğŸ  Resident/Building Staff'
                        };
                        
                        return {
                            success: true,
                            message: `âœ… Contact "${contact.name}" added as ${categoryLabels[category] || category}`,
                            contact: {
                                name: contact.name,
                                category: categoryLabels[category] || category,
                                role: contact.role || 'Not specified',
                                company: contact.company || 'Not specified',
                                phone: contact.phone || 'Not provided',
                                email: contact.email || 'Not provided',
                                linkedSites: linkedSiteNames.length > 0 ? linkedSiteNames : 'None'
                            }
                        };
                    }
                    
                    case 'update_contact': {
                        const contacts = DataStore.getContacts() || [];
                        const searchTerm = toolInput.contact_name?.toLowerCase();
                        const contact = contacts.find(c => c.name?.toLowerCase().includes(searchTerm));
                        
                        if (!contact) {
                            return { success: false, error: `Could not find contact matching "${toolInput.contact_name}"` };
                        }
                        
                        const updates = [];
                        
                        if (toolInput.phone) {
                            contact.phone = toolInput.phone;
                            updates.push(`phone â†’ ${toolInput.phone}`);
                        }
                        if (toolInput.phone_alt) {
                            contact.phoneAlt = toolInput.phone_alt;
                            updates.push(`alt phone â†’ ${toolInput.phone_alt}`);
                        }
                        if (toolInput.email) {
                            contact.email = toolInput.email;
                            updates.push(`email â†’ ${toolInput.email}`);
                        }
                        if (toolInput.role) {
                            contact.role = toolInput.role;
                            updates.push(`role â†’ ${toolInput.role}`);
                        }
                        if (toolInput.company) {
                            contact.company = toolInput.company;
                            updates.push(`company â†’ ${toolInput.company}`);
                        }
                        if (toolInput.notes) {
                            contact.notes = (contact.notes ? contact.notes + '\n' : '') + toolInput.notes;
                            updates.push('notes added');
                        }
                        if (toolInput.status) {
                            contact.status = toolInput.status;
                            updates.push(`status â†’ ${toolInput.status}`);
                        }
                        if (toolInput.linked_sites) {
                            const linkedSiteIds = toolInput.linked_sites
                                .map(siteName => findSite(siteName))
                                .filter(s => s)
                                .map(s => s.id);
                            contact.linkedSites = linkedSiteIds;
                            updates.push(`linked to ${linkedSiteIds.length} site(s)`);
                        }
                        
                        if (updates.length === 0) {
                            return { success: false, error: 'No updates provided' };
                        }
                        
                        contact.updatedAt = new Date().toISOString();
                        DataStore.updateContact(contact.id, contact);
                        
                        return {
                            success: true,
                            message: `âœ… Updated ${contact.name}`,
                            updates: updates
                        };
                    }
                    
                    case 'get_contact_info': {
                        const contacts = DataStore.getContacts() || [];
                        const searchTerm = toolInput.contact_name?.toLowerCase();
                        const contact = contacts.find(c => 
                            c.name?.toLowerCase().includes(searchTerm) ||
                            c.company?.toLowerCase().includes(searchTerm)
                        );
                        
                        if (!contact) {
                            return { success: false, error: `Could not find contact matching "${toolInput.contact_name}"` };
                        }
                        
                        const linkedSiteNames = (contact.linkedSites || [])
                            .map(id => sites.find(s => s.id === id)?.name)
                            .filter(Boolean);
                        
                        return {
                            success: true,
                            contact: {
                                name: contact.name,
                                category: contact.category,
                                role: contact.role,
                                company: contact.company,
                                phone: contact.phone,
                                phoneAlt: contact.phoneAlt,
                                email: contact.email,
                                linkedSites: linkedSiteNames,
                                notes: contact.notes,
                                status: contact.status
                            }
                        };
                    }
                    
                    case 'list_contacts': {
                        let contacts = DataStore.getContacts() || [];
                        
                        // Filter by category
                        if (toolInput.category) {
                            contacts = contacts.filter(c => c.category === toolInput.category);
                        }
                        
                        // Filter by site
                        if (toolInput.site_name) {
                            const site = findSite(toolInput.site_name);
                            if (site) {
                                contacts = contacts.filter(c => c.linkedSites?.includes(site.id));
                            }
                        }
                        
                        // Filter by company
                        if (toolInput.company) {
                            const companyLower = toolInput.company.toLowerCase();
                            contacts = contacts.filter(c => c.company?.toLowerCase().includes(companyLower));
                        }
                        
                        // Only active by default
                        contacts = contacts.filter(c => c.status === 'active');
                        
                        const result = contacts.map(c => {
                            const linkedSiteNames = (c.linkedSites || [])
                                .map(id => sites.find(s => s.id === id)?.name)
                                .filter(Boolean);
                            return {
                                name: c.name,
                                category: c.category,
                                role: c.role,
                                company: c.company,
                                phone: c.phone,
                                email: c.email,
                                linkedSites: linkedSiteNames.length > 0 ? linkedSiteNames : null
                            };
                        });
                        
                        return {
                            success: true,
                            contacts: result,
                            count: result.length
                        };
                    }
                    
                    case 'search_contacts': {
                        const query = (toolInput.query || '').toLowerCase().trim();
                        if (!query) {
                            return { success: false, error: 'Search query is required' };
                        }
                        
                        const contacts = DataStore.getContacts() || [];
                        const matches = contacts.filter(c =>
                            c.name?.toLowerCase().includes(query) ||
                            c.phone?.includes(query) ||
                            c.phoneAlt?.includes(query) ||
                            c.email?.toLowerCase().includes(query) ||
                            c.company?.toLowerCase().includes(query) ||
                            c.role?.toLowerCase().includes(query)
                        );
                        
                        const result = matches.map(c => ({
                            name: c.name,
                            category: c.category,
                            role: c.role,
                            company: c.company,
                            phone: c.phone,
                            email: c.email,
                            status: c.status
                        }));
                        
                        return {
                            success: true,
                            query: toolInput.query,
                            results: result,
                            count: result.length
                        };
                    }
                    
                    case 'get_contacts_for_site': {
                        const site = findSite(toolInput.site_name);
                        if (!site) {
                            return { success: false, error: `Could not find site matching "${toolInput.site_name}"` };
                        }
                        
                        const contacts = DataStore.getContacts() || [];
                        const siteContacts = contacts.filter(c => 
                            c.linkedSites?.includes(site.id) && c.status === 'active'
                        );
                        
                        // Group by category - ordered by urgency/importance
                        const categoryOrder = ['emergency', 'client', 'internal', 'utility', 'vendor', 'government', 'legal', 'resident'];
                        const categoryLabels = {
                            emergency: 'ğŸš¨ Emergency Services',
                            client: 'ğŸ¢ Client/Property',
                            internal: 'ğŸ‘” Internal Staff',
                            vendor: 'ğŸ”§ Vendors',
                            utility: 'âš¡ Utility/Maintenance',
                            government: 'ğŸ›ï¸ Government',
                            legal: 'âš–ï¸ Legal/Insurance',
                            resident: 'ğŸ  Resident/On-Site'
                        };
                        
                        const formatContact = c => ({
                            name: c.name,
                            role: c.role,
                            phone: c.phone,
                            phoneAlt: c.phoneAlt || null,
                            email: c.email,
                            company: c.company
                        });
                        
                        // Build grouped result
                        const groupedContacts = {};
                        categoryOrder.forEach(cat => {
                            const catContacts = siteContacts.filter(c => c.category === cat);
                            if (catContacts.length > 0) {
                                groupedContacts[categoryLabels[cat]] = catContacts.map(formatContact);
                            }
                        });
                        
                        return {
                            success: true,
                            site: site.name,
                            contacts: groupedContacts,
                            totalCount: siteContacts.length,
                            message: siteContacts.length === 0 ? 
                                `No contacts linked to ${site.name}. Use add_contact to create one.` : 
                                `${siteContacts.length} contact(s) for ${site.name}`
                        };
                    }
                    
                    default:
                        return { success: false, error: `Unknown tool: ${toolName}` };
                }
            },

            quickAction: function (action) {
                const input = document.getElementById('ai-input');

                const quickQueries = {
                    'scheduling': 'What needs coverage right now? Show me uncovered shifts and suggest available guards with their phone numbers.',
                    'incidents': 'Summarize open incidents. Which are oldest and need resolution? Any patterns I should know about?',
                    'reports': 'Generate a daily operations summary I can send to management. Include coverage status, incidents, and any issues.',
                    'alerts': 'What needs my attention right now? Prioritize by urgency.'
                };

                if (input && quickQueries[action]) {
                    input.value = quickQueries[action];
                    input.focus();
                    // Auto-send after a brief delay so user can see what's being asked
                    setTimeout(() => this.sendMessage(), 500);
                }
            },

            clearHistory: function () {
                this.conversationHistory = [];
                const messagesContainer = document.getElementById('ai-messages');
                if (messagesContainer) {
                    messagesContainer.innerHTML = `
                    <div class="ai-message ai-assistant">
                        <div class="ai-message-icon">ğŸ¤–</div>
                        <div class="ai-message-content">
                            <strong>Conversation cleared.</strong>
                            <p>How can I help you today?</p>
                        </div>
                    </div>
                `;
                }
            }
        };


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AI COMMAND CONSOLE MODULE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const CommandConsole = (function () {
            let overlayEl;
            let panelEl;
            let inputEl;
            let sendBtnEl;
            let toggleBtnEl;
            let closeBtnEl;
            let outputEl;
            let contextBarEls = {};
            let activeTab = 'assistant';

            const CurrentContext = {
                module: null,
                siteId: null,
                siteName: null,
                date: null,
                shiftLabel: null,
                guardId: null,
                guardName: null
            };

            function init() {
                overlayEl = document.getElementById('ai-console-overlay');
                panelEl = overlayEl ? overlayEl.querySelector('.ai-console-panel') : null;
                inputEl = document.getElementById('ai-console-input');
                sendBtnEl = document.getElementById('ai-console-send-btn');
                toggleBtnEl = document.getElementById('ai-console-toggle-btn');
                closeBtnEl = document.getElementById('ai-console-close-btn');
                outputEl = document.getElementById('ai-console-output');

                contextBarEls.module = document.getElementById('ai-console-context-module');
                contextBarEls.site = document.getElementById('ai-console-context-site');
                contextBarEls.date = document.getElementById('ai-console-context-date');
                contextBarEls.guard = document.getElementById('ai-console-context-guard');

                if (!overlayEl || !panelEl || !inputEl || !sendBtnEl) {
                    console.warn('CommandConsole: Missing required elements');
                    return;
                }

                if (toggleBtnEl) {
                    toggleBtnEl.addEventListener('click', open);
                }
                if (closeBtnEl) {
                    closeBtnEl.addEventListener('click', close);
                }

                // Click outside to close
                overlayEl.addEventListener('click', function(e) {
                    if (e.target === overlayEl) {
                        close();
                    }
                });

                sendBtnEl.addEventListener('click', handleSubmit);
                inputEl.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSubmit();
                    }
                });

                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape' && !overlayEl.hidden) {
                        e.preventDefault();
                        close();
                    }
                    // Ctrl+Shift+K or Cmd+Shift+K to toggle console (avoids collision with Command Palette)
                    if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key.toLowerCase() === 'k') {
                        // Block Command Console in client portal mode
                        if (typeof RoleContext !== 'undefined' && RoleContext.isPortalMode()) {
                            e.preventDefault();
                            return;
                        }
                        e.preventDefault();
                        if (overlayEl.hidden) {
                            open();
                        } else {
                            close();
                        }
                    }
                });

                // Wire up shortcut chips
                const chips = overlayEl.querySelectorAll('.ai-console-chip');
                chips.forEach(function (chip) {
                    chip.addEventListener('click', function () {
                        const cmd = chip.getAttribute('data-command');
                        if (cmd) {
                            inputEl.value = cmd + ' ';
                            inputEl.focus();
                        }
                    });
                });

                // Wire up tabs
                const tabs = overlayEl.querySelectorAll('.ai-console-tab');
                tabs.forEach(function (tab) {
                    tab.addEventListener('click', function () {
                        const tabId = tab.getAttribute('data-tab');
                        setActiveTab(tabId);
                    });
                });

                // Set initial context
                setContext({
                    module: 'Dashboard',
                    siteId: null,
                    siteName: null,
                    date: Utils.toISODate(new Date()),
                    shiftLabel: null,
                    guardId: null,
                    guardName: null
                });

                console.log('ğŸ“Ÿ Command Console initialized');
            }

            function open() {
                if (!overlayEl) return;
                overlayEl.hidden = false;
                document.body.style.overflow = 'hidden';
                if (inputEl) {
                    inputEl.focus();
                    inputEl.select();
                }
                refreshContextBar();
            }

            function close() {
                if (!overlayEl) return;
                overlayEl.hidden = true;
                document.body.style.overflow = '';
            }

            function isOpen() {
                return overlayEl && !overlayEl.hidden;
            }

            function setActiveTab(tabId) {
                activeTab = tabId || 'assistant';
                const tabs = overlayEl.querySelectorAll('.ai-console-tab');
                tabs.forEach(function (tab) {
                    const thisId = tab.getAttribute('data-tab');
                    if (thisId === activeTab) {
                        tab.classList.add('ai-console-tab-active');
                    } else {
                        tab.classList.remove('ai-console-tab-active');
                    }
                });
            }

            function setContext(ctx) {
                CurrentContext.module = ctx.module || null;
                CurrentContext.siteId = ctx.siteId || null;
                CurrentContext.siteName = ctx.siteName || null;
                CurrentContext.date = ctx.date || null;
                CurrentContext.shiftLabel = ctx.shiftLabel || null;
                CurrentContext.guardId = ctx.guardId || null;
                CurrentContext.guardName = ctx.guardName || null;
                refreshContextBar();
            }

            function refreshContextBar() {
                if (!contextBarEls.module) return;
                contextBarEls.module.textContent = 'Module: ' + (CurrentContext.module || 'â€”');
                contextBarEls.site.textContent = 'Site: ' + (CurrentContext.siteName || 'â€”');
                contextBarEls.date.textContent = 'Date: ' + (CurrentContext.date || 'â€”');
                contextBarEls.guard.textContent = 'Guard: ' + (CurrentContext.guardName || 'â€”');
            }

            function handleSubmit() {
                if (!inputEl) return;
                var raw = inputEl.value.trim();
                if (!raw) {
                    return;
                }
                inputEl.value = '';

                if (raw[0] === '/') {
                    handleCommand(raw);
                } else {
                    handleFreeform(raw);
                }
            }

            function appendOutput(label, text, type) {
                if (!outputEl) return;
                var block = document.createElement('div');
                block.className = 'ai-console-output-block';

                var labelEl = document.createElement('div');
                labelEl.className = 'ai-console-output-label';
                labelEl.style.color = type === 'error' ? '#ef4444' : (type === 'user' ? '#60a5fa' : '#9ca3af');
                labelEl.textContent = label;
                block.appendChild(labelEl);

                var textEl = document.createElement('div');
                textEl.className = 'ai-console-output-text';
                textEl.textContent = text;
                block.appendChild(textEl);

                outputEl.appendChild(block);
                outputEl.scrollTop = outputEl.scrollHeight;
            }

            function clearOutput() {
                if (!outputEl) return;
                outputEl.innerHTML = '';
            }

            // -------------------------------------------------------------------------
            // Command handlers
            // -------------------------------------------------------------------------

            function handleCommand(raw) {
                var parts = raw.split(/\s+/);
                var command = parts[0].toLowerCase();
                var args = parts.slice(1);

                appendOutput('Command', raw, 'user');

                if (command === '/who-can-cover') {
                    handleWhoCanCover(args);
                    return;
                }
                if (command === '/incidents-summary') {
                    handleIncidentsSummary(args);
                    return;
                }
                if (command === '/daily-ops') {
                    handleDailyOps(args);
                    return;
                }
                if (command === '/clear') {
                    clearOutput();
                    appendOutput('System', 'Output cleared.');
                    return;
                }
                if (command === '/help') {
                    handleHelp();
                    return;
                }
                if (command === '/stats') {
                    handleStats();
                    return;
                }

                appendOutput('System', 'Unknown command: ' + command + '\n\nAvailable commands:\n  /who-can-cover â€” find guards for coverage\n  /incidents-summary â€” summarize recent incidents\n  /daily-ops â€” daily operations report\n  /stats â€” show system statistics\n  /clear â€” clear output\n  /help â€” show help', 'error');
            }

            function handleHelp() {
                var helpText = [
                    'Operations Console Commands:',
                    '',
                    '  /who-can-cover [site] [date] [shift]',
                    '    Find available guards for coverage.',
                    '    Uses current context if arguments omitted.',
                    '',
                    '  /incidents-summary',
                    '    Summarize incidents from the last 24 hours.',
                    '',
                    '  /daily-ops',
                    '    Show the most recent daily operations report.',
                    '',
                    '  /stats',
                    '    Show current system statistics.',
                    '',
                    '  /clear',
                    '    Clear the output window.',
                    '',
                    'Or just type a question to ask the AI assistant.'
                ].join('\n');
                appendOutput('Help', helpText);
            }

            function handleStats() {
                var guards = DataStore.getGuards ? DataStore.getGuards() : [];
                var sites = DataStore.getSites ? DataStore.getSites() : [];
                var incidents = DataStore.getIncidents ? DataStore.getIncidents() : [];
                var schedules = DataStore.getAllSchedules ? DataStore.getAllSchedules() : [];
                
                var activeGuards = guards.filter(function(g) { return g.status === 'active'; }).length;
                var activeSites = sites.filter(function(s) { return s.status === 'active'; }).length;
                var openIncidents = incidents.filter(function(i) { 
                    return i.status === 'Open' || i.status === 'In Progress'; 
                }).length;

                var lines = [
                    'System Statistics:',
                    '',
                    '  Guards: ' + guards.length + ' total (' + activeGuards + ' active)',
                    '  Sites: ' + sites.length + ' total (' + activeSites + ' active)',
                    '  Schedules: ' + schedules.length + ' total',
                    '  Incidents: ' + incidents.length + ' total (' + openIncidents + ' open)',
                    '',
                    '  Current Date: ' + (CurrentContext.date || DateUtils.today()),
                    '  Active Module: ' + (CurrentContext.module || 'Dashboard')
                ];
                appendOutput('Stats', lines.join('\n'));
            }

            function handleWhoCanCover(args) {
                var date = args[0] || CurrentContext.date || DateUtils.today();
                var siteId = CurrentContext.siteId || null;
                var shiftLabel = args[1] || CurrentContext.shiftLabel || '8A-4P';

                // Use DataStore.findAvailableGuards if available (v6.3.0+)
                if (typeof DataStore.findAvailableGuards === 'function') {
                    var results = DataStore.findAvailableGuards(date, shiftLabel, siteId);
                    
                    if (!results || results.length === 0) {
                        appendOutput('Coverage', 'No available guards found for ' + date + ' (' + shiftLabel + ').\n\nTry checking the Availability module for more options.');
                        return;
                    }

                    var lines = [];
                    lines.push('Available guards for ' + (CurrentContext.siteName || 'coverage') + ' on ' + date + ' (' + shiftLabel + '):');
                    lines.push('');
                    
                    // Group by availability
                    var preferred = results.filter(function(r) { return r.availability === 'prefers'; });
                    var available = results.filter(function(r) { return r.availability === 'available'; });
                    var unspecified = results.filter(function(r) { return r.availability === 'unspecified'; });

                    if (preferred.length > 0) {
                        lines.push('â˜… PREFERS THIS SHIFT:');
                        preferred.slice(0, 5).forEach(function(item, idx) {
                            var meta = [];
                            if (item.isPrimarySite) meta.push('primary site');
                            meta.push(item.weeklyHours + 'h/wk');
                            if (item.otRisk) meta.push('âš  OT');
                            lines.push('  ' + (idx + 1) + '. ' + item.guard.name + ' (' + meta.join(', ') + ')');
                        });
                        lines.push('');
                    }

                    if (available.length > 0) {
                        lines.push('âœ“ AVAILABLE:');
                        available.slice(0, 5).forEach(function(item, idx) {
                            var meta = [];
                            if (item.isPrimarySite) meta.push('primary site');
                            meta.push(item.weeklyHours + 'h/wk');
                            if (item.otRisk) meta.push('âš  OT');
                            lines.push('  ' + (idx + 1) + '. ' + item.guard.name + ' (' + meta.join(', ') + ')');
                        });
                        lines.push('');
                    }

                    if (unspecified.length > 0) {
                        lines.push('? NO RECORD (may be available):');
                        unspecified.slice(0, 3).forEach(function(item, idx) {
                            var meta = [];
                            meta.push(item.weeklyHours + 'h/wk');
                            if (item.otRisk) meta.push('âš  OT');
                            lines.push('  ' + (idx + 1) + '. ' + item.guard.name + ' (' + meta.join(', ') + ')');
                        });
                    }

                    appendOutput('Coverage', lines.join('\n'));
                    return;
                }

                // Fallback: simple guard list
                var guards = DataStore.getGuards ? DataStore.getGuards() : [];
                var activeGuards = guards.filter(function(g) { return g.status === 'active'; });
                
                if (activeGuards.length === 0) {
                    appendOutput('Coverage', 'No active guards found in the system.');
                    return;
                }

                var lines = ['Active guards (check availability manually):'];
                activeGuards.slice(0, 10).forEach(function(g, idx) {
                    lines.push('  ' + (idx + 1) + '. ' + g.name);
                });
                if (activeGuards.length > 10) {
                    lines.push('  ... and ' + (activeGuards.length - 10) + ' more');
                }
                appendOutput('Coverage', lines.join('\n'));
            }

            function handleIncidentsSummary(args) {
                var incidents = DataStore.getIncidents ? DataStore.getIncidents() : [];
                
                if (incidents.length === 0) {
                    appendOutput('Incidents', 'No incidents recorded in the system.');
                    return;
                }

                // Filter to last 24 hours if possible
                var now = new Date();
                var yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                var recentIncidents = incidents.filter(function(inc) {
                    if (!inc.date) return false;
                    var incDate = new Date(inc.date);
                    return incDate >= yesterday;
                });

                var toAnalyze = recentIncidents.length > 0 ? recentIncidents : incidents.slice(-20);
                var timeRange = recentIncidents.length > 0 ? 'last 24 hours' : 'recent';

                // Count by severity and status
                var bySeverity = {};
                var byStatus = {};
                var bySite = {};

                toAnalyze.forEach(function(inc) {
                    var sev = inc.severity || 'Unknown';
                    var stat = inc.status || 'Unknown';
                    var site = inc.siteName || inc.siteId || 'Unknown';
                    
                    bySeverity[sev] = (bySeverity[sev] || 0) + 1;
                    byStatus[stat] = (byStatus[stat] || 0) + 1;
                    bySite[site] = (bySite[site] || 0) + 1;
                });

                var openCount = (byStatus['Open'] || 0) + (byStatus['In Progress'] || 0);

                var lines = [];
                lines.push('Incident Summary (' + timeRange + '):');
                lines.push('');
                lines.push('  Total: ' + toAnalyze.length);
                lines.push('  Open/In Progress: ' + openCount);
                lines.push('');
                lines.push('By Severity:');
                Object.keys(bySeverity).sort().forEach(function(sev) {
                    lines.push('  â€¢ ' + sev + ': ' + bySeverity[sev]);
                });
                lines.push('');
                lines.push('By Status:');
                Object.keys(byStatus).sort().forEach(function(stat) {
                    lines.push('  â€¢ ' + stat + ': ' + byStatus[stat]);
                });
                
                if (Object.keys(bySite).length <= 5) {
                    lines.push('');
                    lines.push('By Site:');
                    Object.keys(bySite).forEach(function(site) {
                        lines.push('  â€¢ ' + site + ': ' + bySite[site]);
                    });
                }

                appendOutput('Incidents', lines.join('\n'));
            }

            function handleDailyOps(args) {
                var reports = DataStore.getDailyReports ? DataStore.getDailyReports() : [];
                
                if (!reports || reports.length === 0) {
                    appendOutput('Daily Ops', 'No daily operations reports found.\n\nDaily reports are typically created by supervisors at end of shift.');
                    return;
                }

                var latest = reports[reports.length - 1];
                var lines = [];
                lines.push('Daily Operations Report');
                lines.push('Date: ' + (latest.date || 'Unknown'));
                lines.push('');
                
                if (latest.sitesCovered) {
                    lines.push('Sites Covered: ' + latest.sitesCovered);
                }
                if (latest.callOffs) {
                    lines.push('Call-offs: ' + latest.callOffs);
                }
                if (latest.incidents) {
                    lines.push('');
                    lines.push('Incidents:');
                    lines.push(latest.incidents);
                }
                if (latest.extraGuards) {
                    lines.push('');
                    lines.push('Extra Guards Added:');
                    lines.push(latest.extraGuards);
                }
                if (latest.notes) {
                    lines.push('');
                    lines.push('Notes:');
                    lines.push(latest.notes);
                }

                appendOutput('Daily Ops', lines.join('\n'));
            }

            // -------------------------------------------------------------------------
            // Freeform questions
            // -------------------------------------------------------------------------

            function handleFreeform(raw) {
                appendOutput('You', raw, 'user');

                // Build context for response
                var guards = DataStore.getGuards ? DataStore.getGuards() : [];
                var sites = DataStore.getSites ? DataStore.getSites() : [];
                var incidents = DataStore.getIncidents ? DataStore.getIncidents() : [];

                // Check if API key exists
                var apiKey = localStorage.getItem('sentinel_api_key');
                
                if (apiKey) {
                    // Actually call the Anthropic API
                    appendOutput('System', 'Processing with AI... (this may take a moment)');
                    
                    // Build comprehensive context for the AI
                    var contextSummary = 'SECURITY OPERATIONS DASHBOARD DATA:\n\n';
                    
                    // CRITICAL: Current time and timezone
                    var now = new Date();
                    var todayStr = now.toISOString().split('T')[0];
                    var currentTime = now.toLocaleTimeString('en-US', {
                        timeZone: 'America/New_York',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });
                    var currentHour = now.getHours();
                    
                    contextSummary += '=== CURRENT TIME & DATE ===\n';
                    contextSummary += 'Date: ' + todayStr + '\n';
                    contextSummary += 'Time: ' + currentTime + ' EST/EDT (America/New_York timezone)\n';
                    contextSummary += 'This is the ACTUAL current time. Use this to determine which shifts are active NOW.\n\n';
                    
                    // Function to determine if shift is currently active
                    function isShiftActive(shiftLabel) {
                        // Parse shift times (e.g., "8A-4P", "4P-12A", "12A-8A")
                        var parts = shiftLabel.split('-');
                        if (parts.length !== 2) return false;
                        
                        var startStr = parts[0];
                        var endStr = parts[1];
                        
                        function parseShiftTime(str) {
                            var isPM = str.includes('P');
                            var hour = parseInt(str);
                            if (isPM && hour !== 12) hour += 12;
                            if (!isPM && hour === 12) hour = 0;
                            return hour;
                        }
                        
                        var startHour = parseShiftTime(startStr);
                        var endHour = parseShiftTime(endStr);
                        
                        // Handle overnight shifts (e.g., 4P-12A, 12A-8A)
                        if (endHour <= startHour) {
                            return currentHour >= startHour || currentHour < endHour;
                        } else {
                            return currentHour >= startHour && currentHour < endHour;
                        }
                    }
                    
                    // Today's schedule
                    var weekKey = Utils.getWeekKey(now);
                    var allShifts = DataStore.getScheduleForWeek ? DataStore.getScheduleForWeek(weekKey) : [];
                    var todayShifts = allShifts.filter(function(s) { return s.date === todayStr; });
                    
                    // Separate current/upcoming/past shifts
                    var currentShifts = [];
                    var upcomingShifts = [];
                    var pastShifts = [];
                    
                    todayShifts.forEach(function(shift) {
                        if (isShiftActive(shift.shiftLabel)) {
                            currentShifts.push(shift);
                        } else {
                            var startHour = parseInt(shift.shiftLabel.split('-')[0]);
                            if (startHour > currentHour) {
                                upcomingShifts.push(shift);
                            } else {
                                pastShifts.push(shift);
                            }
                        }
                    });
                    
                    contextSummary += '=== CURRENTLY ACTIVE SHIFTS (RIGHT NOW) ===\n';
                    if (currentShifts.length > 0) {
                        currentShifts.forEach(function(shift) {
                            var site = sites.find(function(s) { return s.id === shift.siteId; });
                            var guard = guards.find(function(g) { return g.id === shift.guardId; });
                            var siteName = site ? site.name : 'Unknown Site';
                            var guardName = guard ? guard.name : 'ğŸ”´ OPEN/UNASSIGNED';
                            var guardPhone = guard && guard.phone ? ' - ' + guard.phone : '';
                            contextSummary += 'âœ… ACTIVE NOW: ' + siteName + ' | ' + shift.shiftLabel + ' | ' + guardName + guardPhone + '\n';
                        });
                    } else {
                        contextSummary += 'âš ï¸ No shifts are currently active at this time.\n';
                    }
                    contextSummary += '\n';
                    
                    contextSummary += '=== UPCOMING SHIFTS TODAY ===\n';
                    if (upcomingShifts.length > 0) {
                        upcomingShifts.forEach(function(shift) {
                            var site = sites.find(function(s) { return s.id === shift.siteId; });
                            var guard = guards.find(function(g) { return g.id === shift.guardId; });
                            var siteName = site ? site.name : 'Unknown Site';
                            var guardName = guard ? guard.name : 'OPEN';
                            contextSummary += 'â° Later: ' + siteName + ' | ' + shift.shiftLabel + ' | ' + guardName + '\n';
                        });
                    } else {
                        contextSummary += 'No more shifts scheduled today.\n';
                    }
                    contextSummary += '\n';
                    
                    contextSummary += '=== ALL SHIFTS TODAY (' + todayStr + ') ===\n';
                    if (todayShifts.length > 0) {
                        todayShifts.forEach(function(shift) {
                            var site = sites.find(function(s) { return s.id === shift.siteId; });
                            var guard = guards.find(function(g) { return g.id === shift.guardId; });
                            var siteName = site ? site.name : 'Unknown Site';
                            var guardName = guard ? guard.name : 'OPEN/Unassigned';
                            contextSummary += '- ' + siteName + ' | ' + shift.shiftLabel + ' | ' + guardName + '\n';
                        });
                    } else {
                        contextSummary += '- No shifts scheduled for today\n';
                    }
                    
                    // Sites list
                    contextSummary += '\nSITES:\n';
                    sites.forEach(function(site) {
                        contextSummary += '- ' + site.name + ' (ID: ' + site.id + ')\n';
                    });
                    
                    // Guards list
                    contextSummary += '\nGUARDS:\n';
                    guards.forEach(function(guard) {
                        contextSummary += '- ' + guard.name + ' (' + (guard.status || 'active') + ')' + (guard.phone ? ' - ' + guard.phone : '') + '\n';
                    });
                    
                    // Open incidents
                    var openIncidents = incidents.filter(function(i) { return i.status !== 'Resolved'; });
                    if (openIncidents.length > 0) {
                        contextSummary += '\nOPEN INCIDENTS:\n';
                        openIncidents.slice(0, 5).forEach(function(inc) {
                            var site = sites.find(function(s) { return s.id === inc.siteId; });
                            contextSummary += '- ' + (site ? site.name : 'Unknown') + ': ' + (inc.type || inc.incidentType || 'Incident') + ' - ' + inc.status + '\n';
                        });
                    }
                    
                    // Make API call
                    fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "x-api-key": apiKey,
                            "anthropic-version": "2023-06-01",
                            "anthropic-dangerous-direct-browser-access": "true"
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 1000,
                            system: "You are an AI assistant for Newark Security Operations in Newark, NJ. You have access to real-time dashboard data including CURRENT TIME.\n\nIMPORTANT: When asked about 'current' or 'now' or 'right now', use the CURRENT TIME provided in the context to determine which shifts are actively on duty at this moment.\n\nAnswer questions directly using the data provided. Be concise and specific.\n\n" + contextSummary,
                            messages: [
                                { role: "user", content: raw }
                            ]
                        })
                    })
                    .then(function(response) {
                        if (!response.ok) {
                            return response.json().then(function(err) {
                                throw new Error(err.error?.message || 'API request failed');
                            });
                        }
                        return response.json();
                    })
                    .then(function(data) {
                        var textBlocks = data.content.filter(function(block) { return block.type === 'text'; });
                        var aiResponse = textBlocks.map(function(block) { return block.text; }).join('\n');
                        appendOutput('Assistant', aiResponse);
                    })
                    .catch(function(error) {
                        console.error('Console AI error:', error);
                        var errorMsg = 'âŒ AI Error: ' + error.message;
                        if (error.message.includes('invalid_api_key') || error.message.includes('Invalid API')) {
                            errorMsg = 'âŒ Invalid API Key. Please check Settings â†’ AI Assistant.';
                        }
                        appendOutput('System', errorMsg);
                        // Fall back to local response
                        var contextResponse = generateContextResponse(raw, guards, sites, incidents);
                        appendOutput('Assistant', contextResponse);
                    });
                } else {
                    // No API key - provide helpful local response
                    var contextResponse = generateContextResponse(raw, guards, sites, incidents);
                    appendOutput('Assistant', contextResponse);
                }
            }

            function generateContextResponse(question, guards, sites, incidents) {
                var q = question.toLowerCase();
                var lines = [];

                // Try to answer based on keywords
                if (q.includes('guard') || q.includes('officer') || q.includes('staff')) {
                    var active = guards.filter(function(g) { return g.status === 'active'; });
                    lines.push('Guard Information:');
                    lines.push('  Total guards: ' + guards.length);
                    lines.push('  Active: ' + active.length);
                    lines.push('');
                    lines.push('Try /who-can-cover to find available guards for a shift.');
                }
                else if (q.includes('incident') || q.includes('report')) {
                    var open = incidents.filter(function(i) { 
                        return i.status === 'Open' || i.status === 'In Progress'; 
                    });
                    lines.push('Incident Information:');
                    lines.push('  Total incidents: ' + incidents.length);
                    lines.push('  Currently open: ' + open.length);
                    lines.push('');
                    lines.push('Try /incidents-summary for a detailed breakdown.');
                }
                else if (q.includes('site') || q.includes('location')) {
                    var active = sites.filter(function(s) { return s.status === 'active'; });
                    lines.push('Site Information:');
                    lines.push('  Total sites: ' + sites.length);
                    lines.push('  Active: ' + active.length);
                    if (active.length > 0) {
                        lines.push('');
                        lines.push('Sites: ' + active.slice(0, 5).map(function(s) { return s.name; }).join(', '));
                        if (active.length > 5) lines.push('  ... and ' + (active.length - 5) + ' more');
                    }
                }
                else if (q.includes('schedule') || q.includes('shift') || q.includes('coverage')) {
                    lines.push('For scheduling help, try:');
                    lines.push('  /who-can-cover â€” find available guards');
                    lines.push('  Navigate to Scheduler module for full schedule view');
                }
                else if (q.includes('help') || q.includes('what can')) {
                    lines.push('I can help with:');
                    lines.push('  â€¢ Finding guards for coverage (/who-can-cover)');
                    lines.push('  â€¢ Incident summaries (/incidents-summary)');
                    lines.push('  â€¢ Daily operations reports (/daily-ops)');
                    lines.push('  â€¢ System statistics (/stats)');
                    lines.push('');
                    lines.push('Type /help for full command list.');
                }
                else {
                    lines.push('I understand you\'re asking about: "' + question + '"');
                    lines.push('');
                    lines.push('Current system status:');
                    lines.push('  â€¢ ' + guards.length + ' guards in system');
                    lines.push('  â€¢ ' + sites.length + ' sites configured');
                    lines.push('  â€¢ ' + incidents.length + ' incidents recorded');
                    lines.push('');
                    lines.push('For specific data, try commands like:');
                    lines.push('  /who-can-cover, /incidents-summary, /stats');
                    
                    // Only show API key message if not configured
                    if (!localStorage.getItem('sentinel_api_key')) {
                        lines.push('');
                        lines.push('For full AI responses, configure an API key in Settings.');
                    }
                }

                return lines.join('\n');
            }

            return {
                init: init,
                open: open,
                close: close,
                isOpen: isOpen,
                setContext: setContext,
                appendOutput: appendOutput
            };
        })();


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UTILITY FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const Utils = {
            generateId: (prefix = '') => `${prefix}${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,

            formatPhone: (phone) => {
                if (!phone) return '';
                // Remove all non-digits
                const digits = String(phone).replace(/\D/g, '');
                // Format as (XXX) XXX-XXXX
                if (digits.length === 10) {
                    return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
                } else if (digits.length === 11 && digits[0] === '1') {
                    return `(${digits.slice(1, 4)}) ${digits.slice(4, 7)}-${digits.slice(7)}`;
                } else if (digits.length === 7) {
                    // Local number without area code
                    return `${digits.slice(0, 3)}-${digits.slice(3)}`;
                }
                return String(phone).trim(); // Return original if can't parse
            },

            formatDate: (dateStr) => {
                // Handle date strings without time (add T00:00:00 for local interpretation)
                const date = dateStr.includes('T') ? new Date(dateStr) : new Date(dateStr + 'T00:00:00');
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            },

            formatDateTime: (dateStr) => {
                // If no time component, add T00:00:00 for local interpretation
                const date = dateStr.includes('T') ? new Date(dateStr) : new Date(dateStr + 'T00:00:00');
                return date.toLocaleDateString('en-US', {
                    month: 'short', day: 'numeric', year: 'numeric',
                    hour: 'numeric', minute: '2-digit'
                });
            },

            formatTime: (timeStr) => {
                const [hours, minutes] = timeStr.split(':');
                const h = parseInt(hours);
                const ampm = h >= 12 ? 'P' : 'A';
                const h12 = h % 12 || 12;
                return `${h12}${ampm}`;
            },

            getWeekStart: (date) => {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day;
                return new Date(d.setDate(diff));
            },

            getWeekKey: (date) => {
                const d = new Date(date);
                const year = d.getFullYear();
                const start = new Date(year, 0, 1);
                const days = Math.floor((d - start) / (24 * 60 * 60 * 1000));
                const week = Math.ceil((days + start.getDay() + 1) / 7);
                return `${year}-W${String(week).padStart(2, '0')}`;
            },

            getDaysOfWeek: (weekStart) => {
                const days = [];
                for (let i = 0; i < 7; i++) {
                    const d = new Date(weekStart);
                    d.setDate(d.getDate() + i);
                    days.push(d);
                }
                return days;
            },

            toISODate: (date) => {
                // Use local date components to avoid UTC timezone shift
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },

            escapeHtml: (str) => {
                if (!str) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            },

            timeAgo: (dateStr) => {
                const date = new Date(dateStr);
                const now = new Date();
                const seconds = Math.floor((now - date) / 1000);
                
                if (seconds < 60) return 'Just now';
                if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
                if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
                if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
                
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            },

            downloadFile: (content, filename, type = 'text/plain') => {
                // Add UTF-8 BOM for CSV files to ensure proper encoding in Windows Excel
                let processedContent = content;
                if (type === 'text/csv' || filename.endsWith('.csv')) {
                    const BOM = '\uFEFF';
                    processedContent = BOM + content;
                }
                const blob = new Blob([processedContent], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },

            debounce: (fn, delay) => {
                let timer;
                return (...args) => {
                    clearTimeout(timer);
                    timer = setTimeout(() => fn(...args), delay);
                };
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // HARDENING LAYER â€” Safe storage, validation, migration, health monitoring
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        /**
         * SYSTEM HEALTH TRACKER
         * Records startup issues, data corruption, and operational problems
         */
        const SystemHealth = {
            issues: [],
            startupComplete: false,
            schemaVersion: null,
            
            CURRENT_SCHEMA_VERSION: 6.8, // v6.8: Security hardening release
            
            log: function(level, category, message, details = {}) {
                const entry = {
                    timestamp: new Date().toISOString(),
                    level, // 'info', 'warn', 'error'
                    category, // 'storage', 'validation', 'migration', 'corruption'
                    message,
                    details
                };
                this.issues.push(entry);
                // v6.8: Format details as string if present
                const hasDetails = details && Object.keys(details).length > 0;
                const logFn = level === 'error' ? console.error : level === 'warn' ? console.warn : console.log;
                if (hasDetails) {
                    logFn(`[SENTINEL:${category.toUpperCase()}] ${message}`, JSON.stringify(details));
                } else {
                    logFn(`[SENTINEL:${category.toUpperCase()}] ${message}`);
                }
            },
            
            getIssues: function(level = null) {
                if (!level) return this.issues;
                return this.issues.filter(i => i.level === level);
            },
            
            hasErrors: function() {
                return this.issues.some(i => i.level === 'error');
            },
            
            hasWarnings: function() {
                return this.issues.some(i => i.level === 'warn');
            },
            
            getSummary: function() {
                return {
                    errors: this.issues.filter(i => i.level === 'error').length,
                    warnings: this.issues.filter(i => i.level === 'warn').length,
                    info: this.issues.filter(i => i.level === 'info').length,
                    schemaVersion: this.schemaVersion,
                    startupComplete: this.startupComplete
                };
            }
        };

        /**
         * SAFE STORAGE WRAPPER
         * All localStorage operations wrapped in try/catch with fallbacks
         */
        
        /**
         * SAFE STORAGE WRAPPER (LOCAL-FIRST, IndexedDB-backed)
         *
         * Goals:
         * - Keep existing synchronous SafeStorage.get/set API for the rest of the app
         * - Use IndexedDB (50MB+) as primary persistence
         * - Migrate legacy localStorage keys on first run
         * - Maintain an in-memory cache for fast reads
         *
         * Implementation model:
         * - SafeStorage.init() hydrates _mem from IndexedDB (then optionally migrates localStorage)
         * - get/set/remove operate on _mem synchronously and persist async to IndexedDB
         * - localStorage becomes legacy fallback only (no large writes)
         */
        const SafeStorage = {
            _prefix: 'sentinel_',

            // IndexedDB settings
            _idb: {
                name: 'SentinelOpsDB',
                version: 2, // v6.8: Bumped to match existing databases
                store: 'keyvalue'
            },

            // In-memory cache (source of truth for reads)
            _mem: new Map(),
            _ready: false,
            _initPromise: null,

            // Legacy migration flag (stored in localStorage because it is tiny)
            _legacyMigratedFlag: 'sentinel_idb_migrated_v1',

            // Max bytes we will attempt to mirror into localStorage (legacy compatibility only)
            _localStorageMirrorMaxBytes: 200 * 1024,

            init: function () {
                if (this._initPromise) return this._initPromise;

                this._initPromise = (async () => {
                    try {
                        const db = await this._openDB();
                        await this._hydrateFromIDB(db);

                        // If we have no data in IDB, or migration not done, migrate legacy localStorage keys.
                        const legacyDone = this._getLegacyFlag();
                        if (!legacyDone) {
                            await this._migrateLegacyLocalStorage(db);
                            this._setLegacyFlag();
                        }

                        this._ready = true;
                        console.log('[SENTINEL] IndexedDB storage active âœ“');
                        try {
                            SystemHealth.log('info', 'storage', 'IndexedDB ready (local-first storage enabled)');
                        } catch (e) {}

                        return true;
                    } catch (err) {
                        console.warn('[SENTINEL] IndexedDB init failed; falling back to localStorage only:', err);
                        try {
                            SystemHealth.log('warn', 'storage', 'IndexedDB init failed; using localStorage fallback', { error: err.message });
                        } catch (e) {}
                        this._ready = false;
                        return false;
                    }
                })();

                return this._initPromise;
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // Public API (synchronous reads/writes)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            get: function (key, defaultValue = null) {
                // Prefer in-memory cache if ready
                if (this._ready && this._mem.has(key)) {
                    return this._mem.get(key);
                }

                // Fallback: try localStorage (legacy)
                try {
                    const raw = localStorage.getItem(key);
                    if (raw === null) return defaultValue;
                    const parsed = JSON.parse(raw);

                    // Seed memory + async persist to IDB once ready
                    if (this._ready) {
                        this._mem.set(key, parsed);
                        this._persistAsync(key, parsed);
                    }

                    return parsed;
                } catch (err) {
                    try {
                        SystemHealth.log('warn', 'storage', `Failed to read ${key}`, { error: err.message });
                    } catch (e) {}
                    return defaultValue;
                }
            },

            set: function (key, value) {
                try {
                    // Always update memory immediately
                    this._mem.set(key, value);

                    // Persist async to IndexedDB if available
                    if (this._ready) this._persistAsync(key, value);

                    // Legacy mirror (small payload only)
                    this._maybeMirrorToLocalStorage(key, value);
                    return true;
                } catch (err) {
                    try {
                        SystemHealth.log('warn', 'storage', `Failed to set ${key}`, { error: err.message });
                    } catch (e) {}
                    return false;
                }
            },

            remove: function (key) {
                try {
                    this._mem.delete(key);

                    // Best-effort delete from both stores
                    if (this._ready) this._deleteAsync(key);
                    try { localStorage.removeItem(key); } catch (e) {}
                    return true;
                } catch (err) {
                    try {
                        SystemHealth.log('warn', 'storage', `Failed to remove ${key}`, { error: err.message });
                    } catch (e) {}
                    return false;
                }
            },

            // Get storage usage stats (approximate)
            getStats: function () {
                try {
                    let total = 0;
                    let keys = 0;
                    for (const [k, v] of this._mem.entries()) {
                        keys += 1;
                        try {
                            total += (k.length + JSON.stringify(v).length);
                        } catch (e) {
                            total += k.length;
                        }
                    }

                    // Keep legacy localStorage usage visible for troubleshooting
                    let legacyTotal = 0;
                    try {
                        for (let i = 0; i < localStorage.length; i++) {
                            const k = localStorage.key(i);
                            const v = localStorage.getItem(k);
                            legacyTotal += (k ? k.length : 0) + (v ? v.length : 0);
                        }
                    } catch (e) {}

                    return {
                        backend: this._ready ? 'indexeddb' : 'localstorage',
                        indexeddbApproxBytes: total,
                        indexeddbApproxKB: Math.round(total / 1024),
                        keys,
                        localStorageApproxBytes: legacyTotal,
                        localStorageApproxKB: Math.round(legacyTotal / 1024),
                        localStorageLimitKB: 5120
                    };
                } catch (err) {
                    return { backend: this._ready ? 'indexeddb' : 'localstorage', error: err.message };
                }
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // IndexedDB internals
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            _openDB: function () {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(this._idb.name, this._idb.version);

                    req.onupgradeneeded = () => {
                        const db = req.result;
                        if (!db.objectStoreNames.contains(this._idb.store)) {
                            db.createObjectStore(this._idb.store);
                        }
                    };

                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => {
                        // v6.8: Handle VersionError by opening without specific version
                        if (req.error && req.error.name === 'VersionError') {
                            console.warn('[SENTINEL] IDB version mismatch, opening existing DB...');
                            const retryReq = indexedDB.open(this._idb.name);
                            retryReq.onsuccess = () => resolve(retryReq.result);
                            retryReq.onerror = () => reject(retryReq.error);
                        } else {
                            reject(req.error);
                        }
                    };
                });
            },

            _hydrateFromIDB: async function (db) {
                const all = await new Promise((resolve, reject) => {
                    const tx = db.transaction(this._idb.store, 'readonly');
                    const store = tx.objectStore(this._idb.store);

                    const data = new Map();

                    const req = store.openCursor();
                    req.onsuccess = () => {
                        const cursor = req.result;
                        if (cursor) {
                            data.set(cursor.key, cursor.value);
                            cursor.continue();
                        } else {
                            resolve(data);
                        }
                    };
                    req.onerror = () => reject(req.error);
                });

                this._mem = all;
            },

            _persistAsync: function (key, value) {
                // Fire-and-forget persistence; no await to keep UI snappy
                try {
                    const op = async () => {
                        const db = await this._openDB();
                        await new Promise((resolve, reject) => {
                            const tx = db.transaction(this._idb.store, 'readwrite');
                            tx.oncomplete = () => resolve(true);
                            tx.onerror = () => reject(tx.error);
                            tx.objectStore(this._idb.store).put(value, key);
                        });
                        try { db.close(); } catch (e) {}
                    };
                    op();
                } catch (e) {}
            },

            _deleteAsync: function (key) {
                try {
                    const op = async () => {
                        const db = await this._openDB();
                        await new Promise((resolve, reject) => {
                            const tx = db.transaction(this._idb.store, 'readwrite');
                            tx.oncomplete = () => resolve(true);
                            tx.onerror = () => reject(tx.error);
                            tx.objectStore(this._idb.store).delete(key);
                        });
                        try { db.close(); } catch (e) {}
                    };
                    op();
                } catch (e) {}
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // Legacy migration
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            _getLegacyFlag: function () {
                try { return localStorage.getItem(this._legacyMigratedFlag) === 'true'; } catch (e) { return false; }
            },

            _setLegacyFlag: function () {
                try { localStorage.setItem(this._legacyMigratedFlag, 'true'); } catch (e) {}
            },

            _migrateLegacyLocalStorage: async function (db) {
                // Copy all keys that look like Sentinel keys into IDB, without deleting localStorage
                // (deletes are risky; we keep legacy as fallback)
                let migrated = 0;

                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (!key) continue;

                    // Only migrate Sentinel data keys
                    if (!key.startsWith('sentinel_')) continue;

                    try {
                        const raw = localStorage.getItem(key);
                        if (raw === null) continue;
                        const parsed = JSON.parse(raw);

                        // Write into memory and IDB
                        this._mem.set(key, parsed);

                        await new Promise((resolve, reject) => {
                            const tx = db.transaction(this._idb.store, 'readwrite');
                            tx.oncomplete = () => resolve(true);
                            tx.onerror = () => reject(tx.error);
                            tx.objectStore(this._idb.store).put(parsed, key);
                        });

                        migrated += 1;
                    } catch (e) {
                        // Skip bad keys
                    }
                }

                if (migrated > 0) {
                    console.log(`[SENTINEL] Migrated ${migrated} legacy localStorage key(s) to IndexedDB`);
                    try {
                        SystemHealth.log('info', 'storage', `Migrated ${migrated} legacy localStorage key(s) to IndexedDB`);
                    } catch (e) {}
                }
            },

            _maybeMirrorToLocalStorage: function (key, value) {
                try {
                    const raw = JSON.stringify(value);
                    if (raw.length > this._localStorageMirrorMaxBytes) return;
                    localStorage.setItem(key, raw);
                } catch (e) {
                    // Ignore mirror failures
                }
            }
        };


        /**
         * INTEGRITY CHECKER
         * Validates data structure on bootstrap
         */
        const IntegrityChecker = {
            run: function() {
                SystemHealth.log('info', 'integrity', 'Running startup integrity check');
                
                const fixes = [];
                
                // Check sites
                const sitesRaw = SafeStorage.get('sentinel_sites');
                if (sitesRaw !== null && !Array.isArray(sitesRaw)) {
                    SystemHealth.log('warn', 'corruption', 'Sites data corrupted (not an array), resetting');
                    SafeStorage.set('sentinel_sites', []);
                    fixes.push('sites reset to []');
                }
                
                // Check guards
                const guardsRaw = SafeStorage.get('sentinel_guards');
                if (guardsRaw !== null && !Array.isArray(guardsRaw)) {
                    SystemHealth.log('warn', 'corruption', 'Guards data corrupted (not an array), resetting');
                    SafeStorage.set('sentinel_guards', []);
                    fixes.push('guards reset to []');
                }
                
                // Check schedules
                const schedulesRaw = SafeStorage.get('sentinel_schedules');
                if (schedulesRaw !== null && typeof schedulesRaw !== 'object') {
                    SystemHealth.log('warn', 'corruption', 'Schedules data corrupted (not an object), resetting');
                    SafeStorage.set('sentinel_schedules', {});
                    fixes.push('schedules reset to {}');
                }
                
                // Check incidents
                const incidentsRaw = SafeStorage.get('sentinel_incidents');
                if (incidentsRaw !== null && !Array.isArray(incidentsRaw)) {
                    SystemHealth.log('warn', 'corruption', 'Incidents data corrupted (not an array), resetting');
                    SafeStorage.set('sentinel_incidents', []);
                    fixes.push('incidents reset to []');
                }
                
                // Check inspections
                const inspectionsRaw = SafeStorage.get('sentinel_inspections');
                if (inspectionsRaw !== null && !Array.isArray(inspectionsRaw)) {
                    SystemHealth.log('warn', 'corruption', 'Inspections data corrupted (not an array), resetting');
                    SafeStorage.set('sentinel_inspections', []);
                    fixes.push('inspections reset to []');
                }
                
                // Check calloffs
                const calloffsRaw = SafeStorage.get('sentinel_calloffs');
                if (calloffsRaw !== null && !Array.isArray(calloffsRaw)) {
                    SystemHealth.log('warn', 'corruption', 'Calloffs data corrupted (not an array), resetting');
                    SafeStorage.set('sentinel_calloffs', []);
                    fixes.push('calloffs reset to []');
                }
                
                // Check communications
                const commsRaw = SafeStorage.get('sentinel_communications');
                if (commsRaw !== null && !Array.isArray(commsRaw)) {
                    SystemHealth.log('warn', 'corruption', 'Communications data corrupted (not an array), resetting');
                    SafeStorage.set('sentinel_communications', []);
                    fixes.push('communications reset to []');
                }
                
                if (fixes.length > 0) {
                    SystemHealth.log('warn', 'integrity', `Integrity check fixed ${fixes.length} issue(s)`, { fixes });
                } else {
                    SystemHealth.log('info', 'integrity', 'Integrity check passed - no issues found');
                }
                
                return { passed: fixes.length === 0, fixes };
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MIGRATION MANAGER â€” Schema version management (v6.8)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const MigrationManager = {
            CURRENT_VERSION: 6.8,
            VERSION_KEY: 'sentinel_schema_version',
            
            getVersion: function() {
                const stored = localStorage.getItem(this.VERSION_KEY);
                return stored ? parseFloat(stored) : 0;
            },
            
            setVersion: function(v) {
                localStorage.setItem(this.VERSION_KEY, String(v));
            },
            
            runMigrations: function() {
                const fromVersion = this.getVersion();
                
                // No migration needed if already at current version
                if (fromVersion >= this.CURRENT_VERSION) {
                    return { migrated: false, from: fromVersion, to: fromVersion };
                }
                
                try {
                    // Migration: Pre-6.8 â†’ 6.8 (Security hardening)
                    if (fromVersion < 6.8) {
                        // No data migrations needed for security update
                        // Just bump version
                    }
                    
                    this.setVersion(this.CURRENT_VERSION);
                    SystemHealth.log('info', 'migration', `Schema migrated: v${fromVersion} â†’ v${this.CURRENT_VERSION}`);
                    
                    return { migrated: true, from: fromVersion, to: this.CURRENT_VERSION };
                } catch (err) {
                    SystemHealth.log('error', 'migration', 'Migration failed', { error: err.message });
                    return { migrated: false, from: fromVersion, to: fromVersion, error: err.message };
                }
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DATA STORE â€” Central data management layer
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const DataStore = {
            STORAGE_KEYS: {
                SITES: 'sentinel_sites',
                GUARDS: 'sentinel_guards',
                SCHEDULES: 'sentinel_schedules',
                INCIDENTS: 'sentinel_incidents',
                INSPECTIONS: 'sentinel_inspections',
                DAILY_REPORTS: 'sentinel_reports',
                AVAILABILITY: 'sentinel_availability',
                SUPERVISOR_LOG: 'sentinel_supervisor_log',
                COMMUNICATIONS: 'sentinel_communications',
                CALLOFFS: 'sentinel_calloffs',
                CONTACTS: 'sentinel_contacts',
                SETTINGS: 'sentinel_settings',
                DOCUMENTS: 'sentinel_documents',
                PROTOCOLS: 'sentinel_protocols',
                TASKS: 'sentinel_tasks'
            },

            _cache: {
                sites: null,
                guards: null,
                schedules: null,
                incidents: null,
                inspections: null,
                dailyReports: null,
                availability: null,
                supervisorLog: null,
                communications: null,
                calloffs: null,
                contacts: null,
                settings: null,
                documents: null,
                protocols: null,
                tasks: null
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // FIRESTORE SYNC POLICY
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // 
            // LOCAL-FIRST ARCHITECTURE:
            // - Local (localStorage) is the working cache for immediate UI responsiveness
            // - Firestore is the source of truth when online
            // - All writes go to local first, then async push to Firestore
            // 
            // SYNC DISCIPLINE:
            // - PULL: On initial load OR when user clicks "Sync" button
            // - PUSH: On every local write (debounced, non-blocking)
            // 
            // CONFLICT RESOLUTION (minimal version):
            // - If Firestore record has newer updatedAt â†’ prefer Firestore
            // - If local record is newer â†’ keep local, push to Firestore
            // - For simplicity, we currently push local on write without conflict check
            // - Future: implement last-write-wins with updatedAt comparison
            // 
            // COLLECTIONS SYNCED:
            // - sites, guards, schedules, incidents, inspections, calloffs,
            //   communications, supervisorLog, availability, contacts, documents
            // 
            // OFFLINE BEHAVIOR:
            // - System works fully offline using localStorage
            // - Sync errors are tracked but don't block operations
            // - User sees sync status indicator in header
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            // === FIRESTORE SYNC TRACKING ===
            _pendingSyncs: 0,
            _lastSyncTime: null,
            _syncErrors: [],

            _updateSyncStatus: function () {
                const btn = document.getElementById('sync-btn');
                if (!btn) return;

                btn.classList.remove('syncing', 'error', 'synced');

                if (this._pendingSyncs > 0) {
                    btn.classList.add('syncing');
                    btn.title = `Syncing ${this._pendingSyncs} item(s)...`;
                } else if (this._syncErrors.length > 0) {
                    btn.classList.add('error');
                    btn.title = 'Sync error - click to retry';
                } else if (this._lastSyncTime) {
                    btn.classList.add('synced');
                    btn.title = `Synced: ${new Date(this._lastSyncTime).toLocaleTimeString()}`;
                } else {
                    btn.title = 'Sync to cloud';
                }
            },

            // === FIRESTORE SYNC HELPERS ===
            _syncToFirestore: function (operation, ...args) {
                // Non-blocking sync to Firestore
                if (window.FirestoreDB && window.FirestoreDB.enabled) {
                    this._pendingSyncs++;
                    this._updateSyncStatus();

                    window.FirestoreDB[operation](...args)
                        .then(() => {
                            this._lastSyncTime = Date.now();
                            // Remove from errors if it was there
                            this._syncErrors = this._syncErrors.filter(e => e.operation !== operation);
                        })
                        .catch(err => {
                            console.warn(`Firestore sync (${operation}) failed:`, err);
                            // Track error
                            this._syncErrors.push({ operation, args, error: err.message, time: Date.now() });
                            // Show user-facing warning (throttled to avoid spam)
                            if (!this._lastSyncWarning || Date.now() - this._lastSyncWarning > 30000) {
                                this._lastSyncWarning = Date.now();
                                if (window.UI && window.UI.toast) {
                                    UI.toast('Sync Issue', 'Saved locally. Cloud sync pending.', 'warning');
                                }
                            }
                        })
                        .finally(() => {
                            this._pendingSyncs--;
                            this._updateSyncStatus();
                        });
                }
            },

            // Force sync all data to Firestore
            async syncAllToCloud() {
                const btn = document.getElementById('sync-btn');
                
                // Check if Firebase is configured
                if (!window.FirestoreDB || !window.FirestoreDB.enabled) {
                    UI.toast('Cloud Sync', 'Firebase is not configured. Data is saved locally only.', 'warning');
                    return false;
                }

                // Show syncing state
                if (btn) {
                    btn.classList.remove('synced', 'error');
                    btn.classList.add('syncing');
                    btn.title = 'Syncing...';
                }

                UI.toast('Syncing...', 'Saving all data to cloud...', 'info');

                const results = { success: [], failed: [] };

                try {
                    // Helper to safely sync with timeout
                    const safeSync = async (name, fn) => {
                        try {
                            // 10 second timeout per operation
                            const timeoutPromise = new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('Timeout')), 10000)
                            );
                            await Promise.race([fn(), timeoutPromise]);
                            results.success.push(name);
                        } catch (err) {
                            console.error(`Sync ${name} failed:`, err);
                            results.failed.push({ name, error: err.message });
                        }
                    };

                    // Sync all data types one by one
                    const sites = this.getSites();
                    if (sites && sites.length) {
                        await safeSync('Sites', () => window.FirestoreDB.saveSites(sites));
                    }

                    const guards = this.getGuards();
                    if (guards && guards.length) {
                        await safeSync('Guards', () => window.FirestoreDB.saveGuards(guards));
                    }

                    const incidents = this.getIncidents();
                    if (incidents && incidents.length) {
                        await safeSync('Incidents', () => window.FirestoreDB.saveIncidents(incidents));
                    }

                    const inspections = this.getInspections();
                    if (inspections && inspections.length) {
                        await safeSync('Inspections', () => window.FirestoreDB.saveInspections(inspections));
                    }

                    const calloffs = this.getCalloffs();
                    if (calloffs && calloffs.length) {
                        await safeSync('Call-offs', () => window.FirestoreDB.saveCallOffs(calloffs));
                    }

                    const contacts = this.getContacts();
                    if (contacts && contacts.length) {
                        await safeSync('Contacts', () => window.FirestoreDB.saveContacts(contacts));
                    }

                    const communications = this.getCommunications();
                    if (communications && communications.length) {
                        await safeSync('Communications', () => window.FirestoreDB.saveCommunications(communications));
                    }

                    const documents = this.getDocuments();
                    if (documents && documents.length) {
                        await safeSync('Documents', () => window.FirestoreDB.saveDocuments(documents));
                    }

                    const schedules = this.getSchedules();
                    if (schedules && Object.keys(schedules).length) {
                        for (const [weekKey, shifts] of Object.entries(schedules)) {
                            await safeSync(`Schedule ${weekKey}`, () => window.FirestoreDB.saveScheduleForWeek(weekKey, shifts));
                        }
                    }

                    this._lastSyncTime = Date.now();
                    this._syncErrors = results.failed;

                    if (results.failed.length === 0) {
                        UI.toast('Sync Complete', `${results.success.length} collections synced`, 'success');
                        return true;
                    } else if (results.success.length > 0) {
                        UI.toast('Partial Sync', `${results.success.length} synced, ${results.failed.length} failed`, 'warning');
                        console.log('Failed syncs:', results.failed);
                        return false;
                    } else {
                        UI.toast('Sync Failed', 'Check console for details', 'error');
                        console.log('All syncs failed:', results.failed);
                        return false;
                    }

                } catch (err) {
                    console.error('Sync error:', err);
                    UI.toast('Sync Error', err.message, 'error');
                    return false;

                } finally {
                    // ALWAYS stop the spinner
                    if (btn) {
                        btn.classList.remove('syncing');
                        if (results.failed.length === 0 && results.success.length > 0) {
                            btn.classList.add('synced');
                            btn.title = `Synced: ${new Date().toLocaleTimeString()}`;
                        } else if (results.failed.length > 0) {
                            btn.classList.add('error');
                            btn.title = 'Sync error - click to retry';
                        } else {
                            btn.title = 'Sync to cloud';
                        }
                    }
                }
            },

            // Check if there are pending syncs
            hasPendingSyncs() {
                return this._pendingSyncs > 0;
            },

            // Sites
            getSites: function () {
                if (!this._cache.sites) {
                    const stored = SafeStorage.get(this.STORAGE_KEYS.SITES, null);
                    this._cache.sites = stored ? stored : this._getDefaultSites();
                }
                return this._cache.sites;
            },

            saveSites: function (sites) {
                this._cache.sites = sites;
                SafeStorage.set(this.STORAGE_KEYS.SITES, sites);
                // Sync to Firestore
                this._syncToFirestore('saveSites', sites);
            },

            // Add site with validation
            addSite: function (site) {
                const validation = Validators.site(site);
                if (!validation.valid) {
                    SystemHealth.log('warn', 'validation', 'Invalid site data', { errors: validation.errors, site });
                    // Normalize to fix issues
                    site = Validators.normalizeSite(site);
                }
                const sites = this.getSites();
                sites.unshift(site);
                this.saveSites(sites);
                return site;
            },

            // Update site with validation
            updateSite: function (id, updates) {
                const sites = this.getSites();
                const idx = sites.findIndex(s => s.id === id);
                if (idx !== -1) {
                    const updated = { ...sites[idx], ...updates, updatedAt: new Date().toISOString() };
                    const validation = Validators.site(updated);
                    if (!validation.valid) {
                        SystemHealth.log('warn', 'validation', 'Site update validation failed', { errors: validation.errors });
                    }
                    sites[idx] = updated;
                    this.saveSites(sites);
                    this._syncToFirestore('updateSite', id, updates);
                    return updated;
                }
                return null;
            },

            getSiteById: function (id) {
                return this.getSites().find(s => s.id === id);
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PROTOCOLS - Site-linked SOPs, checklists, and documents
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            getProtocols: function () {
                if (!this._cache.protocols) {
                    const stored = SafeStorage.get(this.STORAGE_KEYS.PROTOCOLS, null);
                    this._cache.protocols = stored ? stored : this._getDefaultProtocols();
                }
                return this._cache.protocols;
            },

            saveProtocols: function (protocols) {
                this._cache.protocols = protocols;
                SafeStorage.set(this.STORAGE_KEYS.PROTOCOLS, protocols);
                this._syncToFirestore('saveProtocols', protocols);
            },

            getProtocolsBySiteId: function (siteId) {
                return this.getProtocols().filter(p => p.siteId === siteId);
            },

            addProtocol: function (protocol) {
                const protocols = this.getProtocols();
                if (!protocol.id) {
                    protocol.id = 'proto-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                }
                protocol.createdAt = protocol.createdAt || new Date().toISOString();
                protocol.updatedAt = new Date().toISOString();
                protocols.unshift(protocol);
                this.saveProtocols(protocols);
                return protocol;
            },

            updateProtocol: function (id, updates) {
                const protocols = this.getProtocols();
                const idx = protocols.findIndex(p => p.id === id);
                if (idx !== -1) {
                    protocols[idx] = { ...protocols[idx], ...updates, updatedAt: new Date().toISOString() };
                    this.saveProtocols(protocols);
                    return protocols[idx];
                }
                return null;
            },

            deleteProtocol: function (id) {
                const protocols = this.getProtocols();
                const idx = protocols.findIndex(p => p.id === id);
                if (idx !== -1) {
                    protocols.splice(idx, 1);
                    this.saveProtocols(protocols);
                    return true;
                }
                return false;
            },

            _getDefaultProtocols: function () {
                return [
                    // â•â•â• ZION TOWERS PROTOCOLS â•â•â•
                    {
                        id: 'proto-zion-elevator',
                        siteId: 'site-zion-towers',
                        category: 'emergency',
                        title: 'Elevator Fire Emergency Protocol',
                        priority: 'critical',
                        steps: [
                            { phase: 'Phase 1 - Initial Response', items: ['When fire alarm activates: All elevators recall to lobby automatically', 'DO NOT attempt manual override', 'Clear elevator area of residents', 'Monitor elevator indicators for trapped passengers'] },
                            { phase: 'Phase 2 - Fire Dept Handoff', items: ['Meet NKFD at main entrance with master keys', 'Provide building master key for elevator access', 'Direct to Fire Command Station (lobby east wall)', 'Relay any reports of trapped persons with locations'] }
                        ],
                        notes: 'CRITICAL: Never attempt elevator rescue without Fire Dept. present. Elevator shafts create chimney effect.',
                        effectiveDate: '2024-01-15',
                        reviewDate: '2025-01-15',
                        createdAt: '2024-01-15T00:00:00Z',
                        updatedAt: '2024-01-15T00:00:00Z'
                    },
                    {
                        id: 'proto-zion-fire',
                        siteId: 'site-zion-towers',
                        category: 'emergency',
                        title: 'Fire Emergency Response',
                        priority: 'critical',
                        steps: [
                            { phase: 'Immediate Actions', items: ['Call 911 immediately', 'Activate building fire alarm if not already sounding', 'Notify building management', 'DO NOT use elevators - direct residents to stairs'] }
                        ],
                        effectiveDate: '2024-01-15',
                        createdAt: '2024-01-15T00:00:00Z',
                        updatedAt: '2024-01-15T00:00:00Z'
                    },
                    {
                        id: 'proto-zion-medical',
                        siteId: 'site-zion-towers',
                        category: 'emergency',
                        title: 'Medical Emergency Response',
                        priority: 'critical',
                        steps: [
                            { phase: 'Response Protocol', items: ['Call 911 for serious medical emergencies', 'Notify front desk to direct EMS', 'Clear elevator path for stretcher access', 'Log incident details: time, location, nature of emergency'] }
                        ],
                        effectiveDate: '2024-01-15',
                        createdAt: '2024-01-15T00:00:00Z',
                        updatedAt: '2024-01-15T00:00:00Z'
                    },
                    {
                        id: 'proto-zion-breach',
                        siteId: 'site-zion-towers',
                        category: 'emergency',
                        title: 'Security Breach Protocol',
                        priority: 'high',
                        steps: [
                            { phase: 'Breach Response', items: ['Call police for active threats', 'Lock down main entrance if safe', 'Direct residents to shelter in place', 'Document intruder description if possible'] }
                        ],
                        effectiveDate: '2024-01-15',
                        createdAt: '2024-01-15T00:00:00Z',
                        updatedAt: '2024-01-15T00:00:00Z'
                    },
                    {
                        id: 'proto-zion-hourly',
                        siteId: 'site-zion-towers',
                        category: 'daily_ops',
                        title: 'Hourly Tour & Checkpoint Procedure',
                        priority: 'standard',
                        steps: [
                            { phase: 'Tour Route', items: ['Scan checkpoint QR codes in sequence (14 total)', 'Check stairwells: floors 1, 5, 10, 15, 20', 'Verify emergency exit doors secured', 'Check parking levels P1, P2 - note any suspicious vehicles'] }
                        ],
                        effectiveDate: '2024-01-15',
                        createdAt: '2024-01-15T00:00:00Z',
                        updatedAt: '2024-01-15T00:00:00Z'
                    },
                    {
                        id: 'proto-zion-surveillance',
                        siteId: 'site-zion-towers',
                        category: 'daily_ops',
                        title: 'Surveillance Monitoring SOP',
                        priority: 'standard',
                        steps: [
                            { phase: 'Monitoring Protocol', items: ['Monitor lobby cameras continuously', 'Cycle through parking garage feeds every 15 min', 'Log any unusual activity with timestamp and camera #', 'Save footage clips for incidents (minimum 30 min before/after)'] }
                        ],
                        effectiveDate: '2024-01-15',
                        createdAt: '2024-01-15T00:00:00Z',
                        updatedAt: '2024-01-15T00:00:00Z'
                    },
                    {
                        id: 'proto-zion-maintenance',
                        siteId: 'site-zion-towers',
                        category: 'daily_ops',
                        title: 'Maintenance Inspection Checklist',
                        priority: 'standard',
                        steps: [
                            { phase: 'Daily Checks', items: ['Test emergency lighting (stairwells)', 'Check fire extinguisher access (not blocked)', 'Verify intercom/call boxes operational', 'Report any maintenance issues to building super'] }
                        ],
                        effectiveDate: '2024-01-15',
                        createdAt: '2024-01-15T00:00:00Z',
                        updatedAt: '2024-01-15T00:00:00Z'
                    },
                    // â•â•â• GEORGIA KING VILLAGE PROTOCOLS â•â•â•
                    {
                        id: 'proto-gkv-armed-checklist',
                        siteId: 'site-gkv',
                        category: 'daily_ops',
                        title: 'Armed Guard Daily Patrol Checklist',
                        priority: 'critical',
                        steps: [
                            { phase: 'Administrative (Start of Shift)', items: ['Review previous shift log for ongoing issues', 'Verify radio is charged and operational', 'Confirm firearm is holstered/secured properly', 'Log start time in duty book'] },
                            { phase: 'Patrol Requirements', items: ['Patrol each building exterior minimum 2x per shift', 'Check all stairwells for loiterers/trespassers', 'Verify all emergency exits are secured', 'Monitor common areas: laundry rooms, community center'] },
                            { phase: 'Equipment Checks', items: ['Body camera recording and functioning', 'Flashlight operational', 'First aid kit accessible in vehicle'] },
                            { phase: 'Documentation (End of Shift)', items: ['Complete incident reports for any events', 'Log patrol times and observations', 'Note any maintenance issues observed', 'Brief incoming guard on active situations'] }
                        ],
                        notes: 'Armed patrol site - follow all Newark PD coordination protocols for any weapon-related incidents.',
                        effectiveDate: '2024-02-01',
                        createdAt: '2024-02-01T00:00:00Z',
                        updatedAt: '2024-02-01T00:00:00Z'
                    },
                    // â•â•â• PENNINGTON COURT PROTOCOLS â•â•â•
                    {
                        id: 'proto-penn-daily',
                        siteId: 'site-pennington',
                        category: 'daily_ops',
                        title: 'Daily Operations Checklist',
                        priority: 'standard',
                        steps: [
                            { phase: 'Start of Shift', items: ['Check in with management office', 'Review any visitor/vendor appointments', 'Verify access control system status'] },
                            { phase: 'Patrol Duties', items: ['Walk property perimeter hourly', 'Check parking lot lighting', 'Monitor package delivery area'] }
                        ],
                        effectiveDate: '2024-03-01',
                        createdAt: '2024-03-01T00:00:00Z',
                        updatedAt: '2024-03-01T00:00:00Z'
                    }
                ];
            },

            // Guards
            // v6.19.4: Now normalizes on retrieval for universal format support
            getGuards: function () {
                if (!this._cache.guards) {
                    const stored = SafeStorage.get(this.STORAGE_KEYS.GUARDS, null);
                    const rawGuards = stored ? stored : this._getDefaultGuards();
                    
                    // Normalize all guards on retrieval
                    this._cache.guards = rawGuards.map(g => {
                        // Skip if already normalized this session
                        if (g._normalized) return g;
                        // Use GuardNormalizer for universal format handling
                        return GuardNormalizer.normalize(g) || g;
                    });
                }
                return this._cache.guards;
            },

            saveGuards: function (guards) {
                // Clear cache so normalization runs on next read
                this._cache.guards = null;
                SafeStorage.set(this.STORAGE_KEYS.GUARDS, guards);
                this._syncToFirestore('saveGuards', guards);
            },

            // Add guard with normalization and validation
            addGuard: function (guard) {
                // Normalize first, then validate
                const normalized = GuardNormalizer.normalize(guard, { generateId: !guard.id });
                const validation = GuardNormalizer.validate(normalized);
                
                if (!validation.valid) {
                    SystemHealth.log('warn', 'validation', 'Invalid guard data', { errors: validation.errors, guard });
                }
                if (validation.warnings.length > 0) {
                    SystemHealth.log('info', 'validation', 'Guard data warnings', { warnings: validation.warnings });
                }
                
                const guards = this.getGuards();
                guards.unshift(normalized);
                this.saveGuards(guards);
                this._syncToFirestore('addGuard', normalized);
                return normalized;
            },

            // Update guard with normalization
            updateGuard: function (id, updates) {
                const guards = this.getGuards();
                const idx = guards.findIndex(g => g.id === id);
                if (idx !== -1) {
                    // Merge and re-normalize
                    const merged = { ...guards[idx], ...updates };
                    const updated = GuardNormalizer.normalize(merged);
                    updated.id = id; // Preserve original ID
                    updated.updatedAt = new Date().toISOString();
                    
                    const validation = GuardNormalizer.validate(updated);
                    if (!validation.valid) {
                        SystemHealth.log('warn', 'validation', 'Guard update validation failed', { errors: validation.errors });
                    }
                    
                    guards[idx] = updated;
                    this.saveGuards(guards);
                    this._syncToFirestore('updateGuard', id, updates);
                    return updated;
                }
                return null;
            },

            getGuardById: function (id) {
                return this.getGuards().find(g => g.id === id);
            },

            getActiveGuards: function () {
                return this.getGuards().filter(g => g.status === 'active');
            },

            // Schedules
            getSchedules: function () {
                if (!this._cache.schedules) {
                    const stored = SafeStorage.get(this.STORAGE_KEYS.SCHEDULES, null);
                    this._cache.schedules = stored ? stored : {};
                }
                return this._cache.schedules;
            },

            // Returns ALL shifts as a flat array (for analytics)
            getAllSchedules: function () {
                const schedules = this.getSchedules();
                const allShifts = [];
                Object.keys(schedules).forEach(weekKey => {
                    const weekShifts = schedules[weekKey];
                    if (Array.isArray(weekShifts)) {
                        allShifts.push(...weekShifts);
                    }
                });
                return allShifts;
            },

            saveSchedules: function (schedules) {
                this._cache.schedules = schedules;
                SafeStorage.set(this.STORAGE_KEYS.SCHEDULES, schedules);
            },

            getScheduleForWeek: function (weekKey) {
                const schedules = this.getSchedules();
                return schedules[weekKey] || [];
            },

            saveScheduleForWeek: function (weekKey, shifts) {
                const schedules = this.getSchedules();
                schedules[weekKey] = shifts;
                this.saveSchedules(schedules);
                this._syncToFirestore('saveScheduleForWeek', weekKey, shifts);
            },

            // Remove duplicate shifts from a week
            deduplicateWeekSchedule: function (weekKey) {
                const shifts = this.getScheduleForWeek(weekKey);
                if (shifts.length === 0) return { removed: 0, remaining: 0 };
                
                const seen = new Set();
                const uniqueShifts = [];
                let removed = 0;
                
                for (const shift of shifts) {
                    // Use shift.id as primary dedup key (stable identifier)
                    // Fallback to composite key only for legacy data without IDs
                    const key = shift.id || `${shift.siteId}|${shift.date}|${shift.startTime || ''}|${shift.shiftLabel || ''}`;
                    
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniqueShifts.push(shift);
                    } else {
                        removed++;
                    }
                }
                
                if (removed > 0) {
                    this.saveScheduleForWeek(weekKey, uniqueShifts);
                }
                
                return { removed, remaining: uniqueShifts.length };
            },

            // Clear all shifts for a specific week
            clearWeekSchedule: function (weekKey) {
                const schedules = this.getSchedules();
                const hadShifts = schedules[weekKey]?.length || 0;
                delete schedules[weekKey];
                this.saveSchedules(schedules);
                return hadShifts;
            },

            // v6.8.6: Clear ALL schedule data
            clearAllSchedules: function () {
                const schedules = this.getSchedules();
                const totalCleared = Object.values(schedules).reduce((sum, arr) => sum + (arr?.length || 0), 0);
                this._cache.schedules = {};
                SafeStorage.set(this.STORAGE_KEYS.SCHEDULES, {});
                console.log(`[DataStore] Cleared ${totalCleared} shifts from all weeks`);
                return totalCleared;
            },

            // Incidents
            getIncidents: function () {
                if (!this._cache.incidents) {
                    const stored = SafeStorage.get(this.STORAGE_KEYS.INCIDENTS, null);
                    this._cache.incidents = stored ? stored : this._getDefaultIncidents();
                }
                return this._cache.incidents;
            },

            saveIncidents: function (incidents) {
                this._cache.incidents = incidents;
                SafeStorage.set(this.STORAGE_KEYS.INCIDENTS, incidents);
                
                // Notify dashboard to refresh if visible
                if (typeof DashboardModule !== 'undefined' && Router.currentRoute === 'dashboard') {
                    setTimeout(() => {
                        DashboardModule.renderRecentIncidents();
                        DashboardModule.renderKPIs();
                        DashboardModule.renderCommandCenter();
                    }, 50);
                }
            },

            addIncident: function (incident) {
                // Validate incident data
                const validation = Validators.incident(incident);
                if (!validation.valid) {
                    SystemHealth.log('warn', 'validation', 'Invalid incident data', { errors: validation.errors, incident });
                    // Ensure required fields have defaults
                    incident = {
                        ...incident,
                        id: incident.id || `INC-${Date.now()}`,
                        status: incident.status || 'Open',
                        severity: incident.severity || 'Medium',
                        createdAt: incident.createdAt || new Date().toISOString()
                    };
                }
                const incidents = this.getIncidents();
                incidents.unshift(incident);
                this.saveIncidents(incidents);
                this._syncToFirestore('addIncident', incident);
                return incident;
            },

            updateIncident: function (id, updates) {
                const incidents = this.getIncidents();
                const idx = incidents.findIndex(i => i.id === id);
                if (idx !== -1) {
                    incidents[idx] = { ...incidents[idx], ...updates, updatedAt: new Date().toISOString() };
                    this.saveIncidents(incidents);
                    this._syncToFirestore('updateIncident', id, updates);
                }
            },

            // Inspections
            getInspections: function () {
                if (!this._cache.inspections) {
                    const stored = SafeStorage.get(this.STORAGE_KEYS.INSPECTIONS, null);
                    this._cache.inspections = stored ? stored : [];
                }
                return this._cache.inspections;
            },

            saveInspections: function (inspections) {
                this._cache.inspections = inspections;
                SafeStorage.set(this.STORAGE_KEYS.INSPECTIONS, inspections);
            },

            addInspection: function (inspection) {
                // Validate inspection data
                const validation = Validators.inspection(inspection);
                if (!validation.valid) {
                    SystemHealth.log('warn', 'validation', 'Invalid inspection data', { errors: validation.errors, inspection });
                    inspection = {
                        ...inspection,
                        id: inspection.id || `INSP-${Date.now()}`,
                        createdAt: inspection.createdAt || new Date().toISOString()
                    };
                }
                const inspections = this.getInspections();
                inspections.unshift(inspection);
                this.saveInspections(inspections);
                this._syncToFirestore('addInspection', inspection);
                return inspection;
            },

            // Daily Reports
            getDailyReports: function () {
                if (!this._cache.dailyReports) {
                    const stored = SafeStorage.get(this.STORAGE_KEYS.DAILY_REPORTS, null);
                    this._cache.dailyReports = stored ? stored : [];
                }
                return this._cache.dailyReports;
            },

            saveDailyReports: function (reports) {
                this._cache.dailyReports = reports;
                SafeStorage.set(this.STORAGE_KEYS.DAILY_REPORTS, reports);
            },

            addDailyReport: function (report) {
                const reports = this.getDailyReports();
                reports.unshift(report);
                this.saveDailyReports(reports);
                this._syncToFirestore('addDailyReport', report);
                return report;
            },

            updateDailyReport: function (id, updates) {
                const reports = this.getDailyReports();
                const idx = reports.findIndex(r => r.id === id);
                if (idx !== -1) {
                    reports[idx] = { ...reports[idx], ...updates, updatedAt: new Date().toISOString() };
                    this.saveDailyReports(reports);
                    this._syncToFirestore('updateDailyReport', id, updates);
                }
            },

            deleteDailyReport: function (id) {
                const reports = this.getDailyReports();
                const filtered = reports.filter(r => r.id !== id);
                this.saveDailyReports(filtered);
                this._syncToFirestore('deleteDailyReport', id);
            },

            // Settings
            getSettings: function () {
                if (!this._cache.settings) {
                    const stored = SafeStorage.get(this.STORAGE_KEYS.SETTINGS, null);
                    this._cache.settings = stored ? stored : { theme: 'dark' };
                }
                return this._cache.settings;
            },

            saveSettings: function (settings) {
                this._cache.settings = settings;
                SafeStorage.set(this.STORAGE_KEYS.SETTINGS, settings);
                this._syncToFirestore('saveSettings', settings);
            },

            // Tasks
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // TASKS â€” v6.8.6
            // Record shape: { id, title, status, priority, category, due, guardId, siteId, 
            //                 owner, waitingOn, notes, proof, recurring, recurringInterval,
            //                 createdAt, updatedAt, completedAt }
            // Status: inbox, next, waiting, done
            // Priority: p0, p1, p2
            // Category: training, meeting, coverage, admin, errand
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            getTasks: function () {
                if (!this._cache.tasks) {
                    const parsed = SafeStorage.get(this.STORAGE_KEYS.TASKS, []);
                    this._cache.tasks = Array.isArray(parsed) ? parsed : [];
                }
                return this._cache.tasks;
            },

            saveTasks: function (tasks) {
                this._cache.tasks = tasks || [];
                SafeStorage.set(this.STORAGE_KEYS.TASKS, tasks || []);
                // Note: Firestore sync not implemented for tasks yet - local storage only
            },

            // Availability
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // AVAILABILITY â€” Canonical Array API
            // Record shape: { id, guardId, date, shiftLabel, status, sitePreference, source, notes, createdAt, updatedAt }
            // Storage key: sentinel_availability
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            getAvailability: function () {
                if (!this._cache.availability) {
                    const parsed = SafeStorage.get(this.STORAGE_KEYS.AVAILABILITY, []);
                    this._cache.availability = Array.isArray(parsed) ? parsed : [];
                }
                return this._cache.availability;
            },

            saveAvailability: function (availabilityArray) {
                this._cache.availability = availabilityArray || [];
                SafeStorage.set(this.STORAGE_KEYS.AVAILABILITY, availabilityArray || []);
                this._syncToFirestore('saveAvailability', availabilityArray);
            },

            generateAvailabilityId: function (dateStr) {
                const records = this.getAvailability();
                const datePrefix = `AV-${dateStr.replace(/-/g, '')}`;
                const sameDate = records.filter(r => r.date === dateStr);
                const seq = String(sameDate.length + 1).padStart(4, '0');
                return `${datePrefix}-${seq}`;
            },

            upsertAvailability: function ({ guardId, date, shiftLabel, status, sitePreference, source, notes }) {
                const availability = this.getAvailability();
                const keyMatch = (r) =>
                    r.guardId === guardId &&
                    r.date === date &&
                    r.shiftLabel === shiftLabel;

                const now = new Date().toISOString();
                const idx = availability.findIndex(keyMatch);

                if (idx === -1) {
                    // Insert new
                    availability.push({
                        id: this.generateAvailabilityId(date),
                        guardId,
                        date,
                        shiftLabel,
                        status,
                        sitePreference: sitePreference || null,
                        source: source || 'supervisor',
                        notes: notes || '',
                        createdAt: now,
                        updatedAt: null
                    });
                } else {
                    // Update existing - preserve id and createdAt
                    availability[idx] = {
                        ...availability[idx],
                        status,
                        sitePreference: sitePreference || availability[idx].sitePreference,
                        source: source || availability[idx].source,
                        notes: notes !== undefined ? notes : availability[idx].notes,
                        updatedAt: now
                    };
                }

                this.saveAvailability(availability);
                return availability;
            },

            deleteAvailability: function (id) {
                const records = this.getAvailability();
                const filtered = records.filter(r => r.id !== id);
                this.saveAvailability(filtered);
                return filtered;
            },

            getAvailabilityByGuard: function (guardId) {
                return this.getAvailability().filter(r => r.guardId === guardId);
            },

            getAvailabilityByDate: function (dateStr) {
                return this.getAvailability().filter(r => r.date === dateStr);
            },

            getAvailabilityByDateRange: function (startDate, endDate) {
                return this.getAvailability().filter(r => 
                    r.date >= startDate && r.date <= endDate
                );
            },

            getAvailabilityForGuardDate: function (guardId, dateStr) {
                const records = this.getAvailability().filter(r => 
                    r.guardId === guardId && r.date === dateStr
                );
                if (records.length === 0) return null;
                
                // Aggregate multiple shift records into one summary
                // Priority: blocked > unavailable > prefers > available
                const statusPriority = { 'blocked': 4, 'unavailable': 3, 'prefers': 2, 'available': 1 };
                let dominantStatus = 'available';
                let dominantPriority = 0;
                
                records.forEach(r => {
                    const p = statusPriority[r.status] || 0;
                    if (p > dominantPriority) {
                        dominantPriority = p;
                        dominantStatus = r.status;
                    }
                });

                return {
                    status: dominantStatus,
                    shifts: records.map(r => r.shiftLabel),
                    notes: records.map(r => r.notes).filter(Boolean).join('; '),
                    records: records
                };
            },

            isGuardAvailable: function (guardId, dateStr) {
                const summary = this.getAvailabilityForGuardDate(guardId, dateStr);
                if (!summary) return true; // No record = assume available
                return summary.status === 'available' || summary.status === 'prefers';
            },

            /**
             * findAvailableGuards â€” Intelligent guard availability engine
             * 
             * @param {string} dateStr - Date in YYYY-MM-DD format
             * @param {string} shiftLabel - Shift label (12A-8A, 8A-4P, 4P-12A) or null for any
             * @param {string|null} siteId - Optional site ID to prefer guards assigned to
             * @returns {Array} Sorted list of guards with metadata:
             *   - guard: Full guard object
             *   - availability: 'available'|'prefers'|'unspecified'|'unavailable'|'scheduled'
             *   - isPrimarySite: Boolean if siteId matches guard's primary site
             *   - priorAssignments: Number of shifts at this site in last 30 days
             *   - weeklyHours: Hours already scheduled this week
             *   - otRisk: Boolean if adding shift would exceed 40 hours
             *   - reason: Human-readable status
             */
            findAvailableGuards: function (dateStr, shiftLabel, siteId = null) {
                const availability = this.getAvailability();
                const guards = this.getActiveGuards();
                const allSchedules = this.getAllSchedules(); // FIXED: Use array, not object
                const sites = this.getSites();

                // Build availability lookup: guardId â†’ status for this date+shift
                const availLookup = {};
                availability.forEach(a => {
                    if (a.date === dateStr) {
                        if (!shiftLabel || a.shiftLabel === shiftLabel) {
                            // If no shiftLabel specified, take most restrictive status
                            if (!availLookup[a.guardId] || 
                                (a.status === 'unavailable') ||
                                (a.status === 'prefers' && availLookup[a.guardId] !== 'unavailable')) {
                                availLookup[a.guardId] = a.status;
                            }
                        }
                    }
                });

                // Get guards already scheduled for this date+shift (any site)
                const scheduledAtTime = new Set();
                // Also get guards scheduled at this site on this date (any shift) for conflict check
                const scheduledAtSite = new Set();
                
                allSchedules.forEach(s => {
                    if (s.date === dateStr && s.guardId) {
                        if (!shiftLabel || s.shiftLabel === shiftLabel) {
                            scheduledAtTime.add(s.guardId);
                        }
                        if (siteId && s.siteId === siteId) {
                            scheduledAtSite.add(s.guardId);
                        }
                    }
                });

                // Calculate weekly hours for OT risk
                const weekStart = this._getWeekStart(dateStr);
                const weekEnd = this._getWeekEnd(dateStr);
                const weeklyHoursByGuard = {};
                
                allSchedules.forEach(s => {
                    if (s.guardId && s.date >= weekStart && s.date <= weekEnd) {
                        weeklyHoursByGuard[s.guardId] = (weeklyHoursByGuard[s.guardId] || 0) + 8;
                    }
                });

                // Calculate prior assignments at this site (last 30 days)
                const thirtyDaysAgo = new Date(dateStr);
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
                
                const priorAssignments = {};
                if (siteId) {
                    allSchedules.forEach(s => {
                        if (s.guardId && s.siteId === siteId && s.date >= thirtyDaysAgoStr && s.date < dateStr) {
                            priorAssignments[s.guardId] = (priorAssignments[s.guardId] || 0) + 1;
                        }
                    });
                }

                // Build results with metadata
                const results = [];
                
                guards.forEach(guard => {
                    const availStatus = availLookup[guard.id];
                    const isScheduled = scheduledAtTime.has(guard.id);
                    const isPrimarySite = siteId && (guard.primarySites || []).includes(siteId);
                    const weekHours = weeklyHoursByGuard[guard.id] || 0;
                    const wouldCauseOT = weekHours + 8 > 40;
                    const priorCount = priorAssignments[guard.id] || 0;

                    // Determine availability category
                    let availability, reason;
                    if (isScheduled) {
                        availability = 'scheduled';
                        reason = 'Already scheduled for this time';
                    } else if (availStatus === 'unavailable' || availStatus === 'blocked') {
                        availability = 'unavailable';
                        reason = 'Marked unavailable';
                    } else if (availStatus === 'prefers') {
                        availability = 'prefers';
                        reason = 'Prefers this shift';
                    } else if (availStatus === 'available') {
                        availability = 'available';
                        reason = 'Available';
                    } else {
                        availability = 'unspecified';
                        reason = 'No availability record';
                    }

                    results.push({
                        guard,
                        availability,
                        isPrimarySite,
                        priorAssignments: priorCount,
                        weeklyHours: weekHours,
                        otRisk: wouldCauseOT,
                        reason
                    });
                });

                // Sort: available/prefers first, then by primary site, then by OT risk, then by name
                results.sort((a, b) => {
                    // 1. Availability priority: prefers > available > unspecified > unavailable > scheduled
                    const availOrder = { 'prefers': 0, 'available': 1, 'unspecified': 2, 'unavailable': 3, 'scheduled': 4 };
                    const availDiff = availOrder[a.availability] - availOrder[b.availability];
                    if (availDiff !== 0) return availDiff;

                    // 2. Primary site preference
                    if (a.isPrimarySite !== b.isPrimarySite) return a.isPrimarySite ? -1 : 1;

                    // 3. OT risk (prefer guards without OT risk)
                    if (a.otRisk !== b.otRisk) return a.otRisk ? 1 : -1;

                    // 4. Prior assignments (prefer guards familiar with site)
                    if (a.priorAssignments !== b.priorAssignments) return b.priorAssignments - a.priorAssignments;

                    // 5. Alphabetical by name
                    return a.guard.name.localeCompare(b.guard.name);
                });

                return results;
            },

            // Helper: Get week start (Monday) for a date
            _getWeekStart: function (dateStr) {
                const d = new Date(dateStr + 'T00:00:00');
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                d.setDate(diff);
                return d.toISOString().split('T')[0];
            },

            // Helper: Get week end (Sunday) for a date
            _getWeekEnd: function (dateStr) {
                const d = new Date(dateStr + 'T00:00:00');
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? 0 : 7);
                d.setDate(diff);
                return d.toISOString().split('T')[0];
            },

            // Migration: Convert legacy week-based format to array format
            migrateLegacyAvailability: function () {
                const legacyKey = 'sentinel_availability_legacy';
                const currentData = localStorage.getItem(this.STORAGE_KEYS.AVAILABILITY);
                
                // Check if current data is already an array
                try {
                    const parsed = currentData ? JSON.parse(currentData) : null;
                    if (Array.isArray(parsed)) return; // Already migrated
                    if (!parsed || typeof parsed !== 'object') return; // Nothing to migrate
                    
                    // It's an object - migrate it
                    const migrated = [];
                    Object.keys(parsed).forEach(key => {
                        // Key format: guardId_weekKey
                        const [guardId, weekKey] = key.split('_');
                        const guardData = parsed[key];
                        
                        if (guardData && guardData.days) {
                            Object.keys(guardData.days).forEach(dateStr => {
                                const dayData = guardData.days[dateStr];
                                const shifts = dayData.shifts || ['any'];
                                const status = dayData.status || 'available';
                                
                                shifts.forEach((shiftLabel, idx) => {
                                    if (shiftLabel === 'any') {
                                        // Expand 'any' to all shifts
                                        ['12A-8A', '8A-4P', '4P-12A'].forEach((sl, i) => {
                                            migrated.push({
                                                id: `AV-${dateStr.replace(/-/g, '')}-${String(migrated.length + 1).padStart(4, '0')}`,
                                                guardId,
                                                date: dateStr,
                                                shiftLabel: sl,
                                                status: status === 'preferred' ? 'prefers' : status,
                                                sitePreference: null,
                                                source: 'legacy',
                                                notes: dayData.notes || '',
                                                createdAt: guardData.updatedAt || new Date().toISOString(),
                                                updatedAt: null
                                            });
                                        });
                                    } else {
                                        migrated.push({
                                            id: `AV-${dateStr.replace(/-/g, '')}-${String(migrated.length + 1).padStart(4, '0')}`,
                                            guardId,
                                            date: dateStr,
                                            shiftLabel,
                                            status: status === 'preferred' ? 'prefers' : status,
                                            sitePreference: null,
                                            source: 'legacy',
                                            notes: dayData.notes || '',
                                            createdAt: guardData.updatedAt || new Date().toISOString(),
                                            updatedAt: null
                                        });
                                    }
                                });
                            });
                        }
                    });
                    
                    // Save migrated data
                    if (migrated.length > 0) {
                        this.saveAvailability(migrated);
                        // Backup legacy data
                        localStorage.setItem(legacyKey, currentData);
                        console.log(`Migrated ${migrated.length} availability records from legacy format`);
                    }
                } catch (e) {
                    console.error('Error migrating legacy availability:', e);
                }
            },

            // Supervisor Log
            getSupervisorLog: function () {
                if (!this._cache.supervisorLog) {
                    const stored = SafeStorage.get(this.STORAGE_KEYS.SUPERVISOR_LOG, []);
                    this._cache.supervisorLog = stored;
                }
                return this._cache.supervisorLog;
            },

            saveSupervisorLog: function (entries) {
                this._cache.supervisorLog = entries;
                SafeStorage.set(this.STORAGE_KEYS.SUPERVISOR_LOG, entries);
            },

            addLogEntry: function (entry) {
                const entries = this.getSupervisorLog();
                entries.unshift(entry);
                this.saveSupervisorLog(entries);
                this._syncToFirestore('addLogEntry', entry);
                return entry;
            },

            updateLogEntry: function (id, updates) {
                const entries = this.getSupervisorLog();
                const idx = entries.findIndex(e => e.id === id);
                if (idx !== -1) {
                    entries[idx] = { ...entries[idx], ...updates };
                    this.saveSupervisorLog(entries);
                    this._syncToFirestore('updateLogEntry', id, updates);
                }
            },

            deleteLogEntry: function (id) {
                const entries = this.getSupervisorLog();
                const filtered = entries.filter(e => e.id !== id);
                this.saveSupervisorLog(filtered);
                this._syncToFirestore('deleteLogEntry', id);
            },

            getOpenLogItems: function () {
                return this.getSupervisorLog().filter(e => e.needsFollowUp && e.status === 'open');
            },

            // Communications Log
            getCommunications: function () {
                if (!this._cache.communications) {
                    const stored = SafeStorage.get(this.STORAGE_KEYS.COMMUNICATIONS, []);
                    this._cache.communications = stored;
                }
                return this._cache.communications;
            },

            saveCommunications: function (comms) {
                this._cache.communications = comms;
                SafeStorage.set(this.STORAGE_KEYS.COMMUNICATIONS, comms);
            },

            addCommunication: function (comm) {
                const comms = this.getCommunications();
                comms.unshift(comm);
                this.saveCommunications(comms);
                this._syncToFirestore('addCommunication', comm);
                return comm;
            },

            updateCommunication: function (id, updates) {
                const comms = this.getCommunications();
                const idx = comms.findIndex(c => c.id === id);
                if (idx !== -1) {
                    comms[idx] = { ...comms[idx], ...updates, updatedAt: new Date().toISOString() };
                    this.saveCommunications(comms);
                    this._syncToFirestore('updateCommunication', id, updates);
                }
            },

            deleteCommunication: function (id) {
                const comms = this.getCommunications();
                const filtered = comms.filter(c => c.id !== id);
                this.saveCommunications(filtered);
                this._syncToFirestore('deleteCommunication', id);
            },

            getFollowUpCommunications: function () {
                const now = new Date();
                return this.getCommunications().filter(c => 
                    c.followUpRequired && 
                    c.followUpStatus !== 'completed' &&
                    (!c.followUpDate || new Date(c.followUpDate) <= new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000))
                );
            },

            getTodayCommunications: function () {
                const today = Utils.toISODate(new Date());
                return this.getCommunications().filter(c => c.dateTime && c.dateTime.startsWith(today));
            },

            // Call-offs
            getCalloffs: function () {
                if (!this._cache.calloffs) {
                    const stored = SafeStorage.get(this.STORAGE_KEYS.CALLOFFS, []);
                    this._cache.calloffs = stored;
                }
                return this._cache.calloffs;
            },

            saveCalloffs: function (calloffs) {
                this._cache.calloffs = calloffs;
                SafeStorage.set(this.STORAGE_KEYS.CALLOFFS, calloffs);
            },

            addCalloff: function (calloff) {
                const calloffs = this.getCalloffs();
                calloffs.unshift(calloff);
                this.saveCalloffs(calloffs);
                this._syncToFirestore('addCalloff', calloff);
                return calloff;
            },

            updateCalloff: function (id, updates) {
                const calloffs = this.getCalloffs();
                const idx = calloffs.findIndex(c => c.id === id);
                if (idx !== -1) {
                    calloffs[idx] = { ...calloffs[idx], ...updates };
                    this.saveCalloffs(calloffs);
                    this._syncToFirestore('updateCalloff', id, updates);
                }
            },

            deleteCalloff: function (id) {
                const calloffs = this.getCalloffs();
                const filtered = calloffs.filter(c => c.id !== id);
                this.saveCalloffs(filtered);
                this._syncToFirestore('deleteCalloff', id);
            },

            getTodayCalloffs: function () {
                const today = Utils.toISODate(new Date());
                return this.getCalloffs().filter(c => c.date === today);
            },

            getPendingCalloffs: function () {
                return this.getCalloffs().filter(c => 
                    c.coverageStatus === 'pending' || c.coverageStatus === 'uncovered'
                );
            },

            // Contacts
            getContacts: function () {
                if (!this._cache.contacts) {
                    const stored = SafeStorage.get(this.STORAGE_KEYS.CONTACTS, []);
                    this._cache.contacts = stored;
                }
                return this._cache.contacts;
            },

            saveContacts: function (contacts) {
                this._cache.contacts = contacts;
                SafeStorage.set(this.STORAGE_KEYS.CONTACTS, contacts);
            },

            getContactById: function (id) {
                return this.getContacts().find(c => c.id === id);
            },

            addContact: function (contact) {
                const contacts = this.getContacts();
                contacts.unshift(contact);
                this.saveContacts(contacts);
                this._syncToFirestore('addContact', contact);
                return contact;
            },

            updateContact: function (id, updates) {
                const contacts = this.getContacts();
                const idx = contacts.findIndex(c => c.id === id);
                if (idx !== -1) {
                    contacts[idx] = { ...contacts[idx], ...updates, updatedAt: new Date().toISOString() };
                    this.saveContacts(contacts);
                    this._syncToFirestore('updateContact', id, updates);
                    return contacts[idx];
                }
                return null;
            },

            deleteContact: function (id) {
                const contacts = this.getContacts();
                const filtered = contacts.filter(c => c.id !== id);
                this.saveContacts(filtered);
                this._syncToFirestore('deleteContact', id);
            },

            getContactsByCategory: function (category) {
                return this.getContacts().filter(c => c.category === category && c.status === 'active');
            },

            getContactsForSite: function (siteId) {
                return this.getContacts().filter(c => c.linkedSites && c.linkedSites.includes(siteId));
            },

            // Documents
            getDocuments: function () {
                if (!this._cache.documents) {
                    const stored = SafeStorage.get(this.STORAGE_KEYS.DOCUMENTS, []);
                    this._cache.documents = stored;
                }
                return this._cache.documents;
            },

            saveDocuments: function (documents) {
                this._cache.documents = documents;
                SafeStorage.set(this.STORAGE_KEYS.DOCUMENTS, documents);
            },

            getDocumentById: function (id) {
                return this.getDocuments().find(d => d.id === id);
            },

            addDocument: function (document) {
                const documents = this.getDocuments();
                documents.unshift(document);
                this.saveDocuments(documents);
                this._syncToFirestore('addDocument', document);
                return document;
            },

            updateDocument: function (id, updates) {
                const documents = this.getDocuments();
                const idx = documents.findIndex(d => d.id === id);
                if (idx !== -1) {
                    documents[idx] = { ...documents[idx], ...updates, updatedAt: new Date().toISOString() };
                    this.saveDocuments(documents);
                    this._syncToFirestore('updateDocument', id, updates);
                    return documents[idx];
                }
                return null;
            },

            deleteDocument: function (id) {
                const documents = this.getDocuments();
                const filtered = documents.filter(d => d.id !== id);
                this.saveDocuments(filtered);
                this._syncToFirestore('deleteDocument', id);
            },

            getDocumentsByCategory: function (category) {
                return this.getDocuments().filter(d => d.category === category);
            },

            getDocumentsForSite: function (siteId) {
                return this.getDocuments().filter(d => d.siteId === siteId || d.siteId === 'company-wide');
            },

            getExpiringDocuments: function (daysAhead = 30) {
                const now = new Date();
                const cutoff = new Date(now.getTime() + (daysAhead * 24 * 60 * 60 * 1000));
                return this.getDocuments().filter(d => {
                    if (!d.expirationDate) return false;
                    const expDate = new Date(d.expirationDate);
                    return expDate <= cutoff && expDate >= now;
                });
            },

            getExpiredDocuments: function () {
                const now = new Date();
                return this.getDocuments().filter(d => {
                    if (!d.expirationDate) return false;
                    return new Date(d.expirationDate) < now;
                });
            },

            // Backup/Restore
            exportAllData: function () {
                return {
                    appVersion: APP_VERSION,
                    exportDate: new Date().toISOString(),
                    sites: this.getSites(),
                    guards: this.getGuards(),
                    schedules: this.getSchedules(),
                    incidents: this.getIncidents(),
                    inspections: this.getInspections(),
                    dailyReports: this.getDailyReports(),
                    availability: this.getAvailability(),
                    supervisorLog: this.getSupervisorLog(),
                    communications: this.getCommunications(),
                    calloffs: this.getCalloffs(),
                    contacts: this.getContacts(),
                    documents: this.getDocuments(),
                    settings: this.getSettings()
                };
            },

            importAllData: function (data) {
                if (!data.appVersion) {
                    throw new Error('Invalid backup file: missing appVersion');
                }
                if (data.sites) this.saveSites(data.sites);
                if (data.guards) this.saveGuards(data.guards);
                if (data.schedules) this.saveSchedules(data.schedules);
                if (data.incidents) this.saveIncidents(data.incidents);
                if (data.inspections) this.saveInspections(data.inspections);
                if (data.dailyReports) this.saveDailyReports(data.dailyReports);
                if (data.availability) this.saveAvailability(data.availability);
                if (data.supervisorLog) this.saveSupervisorLog(data.supervisorLog);
                if (data.communications) this.saveCommunications(data.communications);
                if (data.calloffs) this.saveCalloffs(data.calloffs);
                if (data.contacts) this.saveContacts(data.contacts);
                if (data.documents) this.saveDocuments(data.documents);
                if (data.settings) this.saveSettings(data.settings);
                this.clearCache();
            },

            clearAllData: function () {
                Object.values(this.STORAGE_KEYS).forEach(key => {
                    localStorage.removeItem(key);
                });
                // Also clear API key (not in STORAGE_KEYS but should be cleared)
                localStorage.removeItem('sentinel_api_key');
                this.clearCache();
            },

            clearCache: function () {
                this._cache = {
                    sites: null,
                    guards: null,
                    schedules: null,
                    incidents: null,
                    inspections: null,
                    dailyReports: null,
                    availability: null,
                    supervisorLog: null,
                    calloffs: null,
                    contacts: null,
                    communications: null,
                    documents: null,
                    settings: null,
                    protocols: null,
                    tasks: null
                };
            },

            // Default Data â€” Empty (import your own via CSV)
            _getDefaultSites: function () {
                return [];
            },

            _getDefaultGuards: function () {
                return [];
            },

            _getDefaultIncidents: function () {
                return [];
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ROUTER â€” Single-page navigation
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const Router = {
            currentRoute: 'dashboard',

            routes: {
                'dashboard': { title: 'Dashboard', section: 'section-dashboard' },
                'scheduler': { title: 'Scheduler', section: 'section-scheduler' },
                'tasks': { title: 'Tasks', section: 'section-tasks' },
                'incidents': { title: 'Incidents', section: 'section-incidents' },
                'inspections': { title: 'Inspections', section: 'section-inspections' },
                'supervisorlog': { title: "Supervisor's Log", section: 'section-supervisorlog' },
                'commslog': { title: 'Communications Log', section: 'section-commslog' },
                'exports': { title: 'Export Center', section: 'section-exports' },
                'portal': { title: 'Client Portal', section: 'section-portal' },
                'calloffs': { title: 'Call-off Log', section: 'section-calloffs' },
                'sites': { title: 'Sites', section: 'section-sites' },
                'contacts': { title: 'Contacts', section: 'section-contacts' },
                'roster': { title: 'Guard Roster', section: 'section-roster' },
                'availability': { title: 'Availability', section: 'section-availability' },
                'reports': { title: 'Daily Reports', section: 'section-reports' },
                'analytics': { title: 'Analytics', section: 'section-analytics' },
                'documents': { title: 'Document Vault', section: 'section-documents' },
                'performance': { title: 'Guard Performance', section: 'section-performance' },
                'settings': { title: 'Settings', section: 'section-settings' }
            },

            navigate: function (route) {
                if (!this.routes[route]) return;

                // ROUTE PROTECTION: Block admin routes when in portal mode
                if (typeof RoleContext !== 'undefined' && RoleContext.isPortalMode()) {
                    const adminRoutes = [
                        'dashboard', 'scheduler', 'tasks', 'incidents', 'inspections',
                        'supervisorlog', 'commslog', 'exports', 'calloffs',
                        'sites', 'contacts', 'roster', 'availability',
                        'reports', 'analytics', 'documents', 'performance', 'settings'
                    ];
                    if (adminRoutes.includes(route)) {
                        console.log('[SENTINEL] Blocked admin route in portal mode:', route);
                        route = 'portal';
                    }
                }

                // If leaving portal mode, remove portal-mode class
                if (this.currentRoute === 'portal' && route !== 'portal') {
                    document.body.classList.remove('portal-mode');
                    ClientPortalModule.isAuthenticated = false;
                    ClientPortalModule.currentSiteId = null;
                }

                this.currentRoute = route;
                const config = this.routes[route];

                // Update section indicator in header
                const sectionEl = document.getElementById('current-section');
                if (sectionEl) {
                    sectionEl.textContent = config.title;
                }

                // Update active section
                document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
                document.getElementById(config.section).classList.add('active');

                // Update home button active state
                const homeBtn = document.getElementById('home-btn');
                if (homeBtn) {
                    if (route === 'dashboard') {
                        homeBtn.classList.add('active');
                    } else {
                        homeBtn.classList.remove('active');
                    }
                }

                // Scroll to top when navigating
                const mainBody = document.querySelector('.main-body');
                if (mainBody) mainBody.scrollTop = 0;

                // Trigger module render if needed
                this._onRouteChange(route);
            },

            _onRouteChange: function (route) {
                switch (route) {
                    case 'dashboard': DashboardModule.render(); break;
                    case 'scheduler': SchedulerModule.render(); break;
                    case 'incidents': IncidentsModule.render(); break;
                    case 'inspections': InspectionsModule.render(); break;
                    case 'supervisorlog': SupervisorLogModule.render(); break;
                    case 'commslog': CommsLogModule.render(); break;
                    case 'exports': ExportModule.render(); break;
                    case 'portal': ClientPortalModule.render(); break;
                    case 'calloffs': CalloffsModule.render(); break;
                    case 'sites': SitesModule.render(); break;
                    case 'contacts': ContactsModule.render(); break;
                    case 'roster': RosterModule.render(); break;
                    case 'availability': AvailabilityModule.render(); break;
                    case 'reports': ReportsModule.render(); break;
                    case 'analytics': AnalyticsModule.render(); break;
                    case 'documents': DocumentsModule.render(); break;
                    case 'performance': GuardPerformanceModule.render(); break;
                    case 'settings': SettingsModule.render(); break;
                }
            },

            init: function () {
                // No sidebar nav items to initialize anymore
            },

            refresh: function () {
                this._onRouteChange(this.currentRoute);
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UI â€” Toast notifications, modals, and common UI operations
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const UI = {
            MAX_TOASTS: 3,
            TOAST_DURATION: 4000,

            toast: function (title, message, type = 'info') {
                const container = document.getElementById('toast-container');
                const id = Utils.generateId('toast-');

                // Limit visible toasts - remove oldest if at max
                const existingToasts = container.querySelectorAll('.toast');
                if (existingToasts.length >= this.MAX_TOASTS) {
                    // Dismiss oldest toast immediately
                    const oldest = existingToasts[0];
                    if (oldest) this.dismissToast(oldest.id);
                }

                const icons = {
                    success: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                    error: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                    danger: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                    warning: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
                    info: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
                };

                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.id = id;
                toast.innerHTML = `
                ${icons[type]}
                <div class="toast-content">
                    <div class="toast-title">${Utils.escapeHtml(title)}</div>
                    <div class="toast-message">${Utils.escapeHtml(message)}</div>
                </div>
                <button class="toast-close" onclick="UI.dismissToast('${id}')" aria-label="Dismiss">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            `;

                container.appendChild(toast);
                setTimeout(() => this.dismissToast(id), this.TOAST_DURATION);
            },

            dismissToast: function (id) {
                const toast = document.getElementById(id);
                if (toast) {
                    toast.style.animation = 'none';
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    toast.style.transition = 'all 0.2s ease';
                    setTimeout(() => toast.remove(), 200);
                }
            },

            openModal: function (title, content, footer = '', size = '') {
                const backdrop = document.getElementById('modal-backdrop');
                const modal = document.getElementById('modal');

                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-body').innerHTML = content;
                document.getElementById('modal-footer').innerHTML = footer;

                modal.className = 'modal' + (size ? ` modal-${size}` : '');
                backdrop.classList.add('active');

                // Focus trap
                modal.querySelector('button, input, select, textarea')?.focus();
            },

            closeModal: function () {
                document.getElementById('modal-backdrop').classList.remove('active');
                // Clean up modal action registry
                this._modalActions = {};
                
                // Refresh dashboard if we're on it (data may have changed in modal)
                if (Router.currentRoute === 'dashboard' && typeof DashboardModule !== 'undefined') {
                    // Small delay to let any pending saves complete
                    setTimeout(() => DashboardModule.render(), 100);
                }
            },

            // Modal action registry (preserves function context)
            _modalActions: {},
            _modalActionCounter: 0,

            // Alternative modal API with button array
            modal: function (title, content, buttons = []) {
                const footer = buttons.map(btn => {
                    const btnClass = btn.class || 'btn-secondary';
                    const actionId = `modal_action_${this._modalActionCounter++}`;
                    
                    // Store the action with preserved context
                    this._modalActions[actionId] = btn.action;
                    
                    return `<button class="btn ${btnClass}" onclick="UI._modalActions['${actionId}']()">${btn.text}</button>`;
                }).join('');
                this.openModal(title, content, footer);
            },

            confirm: function (title, message) {
                return new Promise((resolve) => {
                    const content = `<p>${Utils.escapeHtml(message)}</p>`;
                    const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal(); UI._confirmResolve(false)">Cancel</button>
                    <button class="btn btn-primary" onclick="UI.closeModal(); UI._confirmResolve(true)">Confirm</button>
                `;
                    this._confirmResolve = resolve;
                    this.openModal(title, content, footer);
                });
            },

            populateSiteSelect: function (selectId, includeAll = false, activeOnly = true) {
                const select = document.getElementById(selectId);
                if (!select) return;

                let sites = DataStore.getSites();
                
                // Filter by status: activeOnly shows only active sites (for data entry forms)
                // When includeAll is true (filter dropdowns), show all sites regardless of status
                if (activeOnly && !includeAll) {
                    sites = sites.filter(s => (s.status || 'active') === 'active');
                }
                
                // Sort alphabetically by name
                sites = [...sites].sort((a, b) => (a.name || '').localeCompare(b.name || ''));

                select.innerHTML = includeAll ? '<option value="">All Sites</option>' : '<option value="">Select site...</option>';
                sites.forEach(site => {
                    const statusLabel = site.status && site.status !== 'active' ? ` (${site.status})` : '';
                    select.innerHTML += `<option value="${site.id}">${Utils.escapeHtml(site.name)}${statusLabel}</option>`;
                });
            },

            populateGuardSelect: function (selectId, includeAll = false, activeOnly = true) {
                const select = document.getElementById(selectId);
                if (!select) return;

                let guards = activeOnly ? DataStore.getActiveGuards() : DataStore.getGuards();
                
                // Sort alphabetically by name
                guards = [...guards].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                
                select.innerHTML = includeAll ? '<option value="">All Guards</option>' : '<option value="">Select guard...</option>';
                guards.forEach(guard => {
                    const statusLabel = guard.status && guard.status !== 'active' ? ` (${guard.status})` : '';
                    select.innerHTML += `<option value="${guard.id}">${Utils.escapeHtml(guard.name)}${statusLabel}</option>`;
                });
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ATTENTION PANEL MODULE - Surfaces what needs action NOW
        // v6.19.4: Added alert saturation cap (max 5 visible, expandable)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SOP NORMALIZER - Universal format handler (v6.19.4)
        // Accepts ANY reasonable SOP format and outputs consistent internal schema
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const SOPNormalizer = {
            /**
             * Normalize any SOP format to internal schema
             * Handles: sop_master.json format, internal format, legacy formats
             */
            normalize: function(raw, siteId) {
                if (!raw || typeof raw !== 'object') return null;
                
                // If already normalized (has meta.siteName), just ensure completeness
                if (raw.meta?.siteName && raw.postAssignments) {
                    return this._ensureComplete(raw, siteId);
                }
                
                // Otherwise, transform from external format
                return this._transformToInternal(raw, siteId);
            },
            
            /**
             * Transform sop_master.json or similar formats to internal
             */
            _transformToInternal: function(raw, siteId) {
                const now = new Date().toISOString();
                
                // Extract site name from multiple possible locations
                const siteName = raw.siteName || raw.meta?.siteName || raw.name || siteId;
                
                const sop = {
                    siteId: siteId,
                    updatedAt: raw.updatedAt || now,
                    meta: {
                        siteName: siteName,
                        status: raw.meta?.status || raw.status || 'IMPORTED',
                        approvedBy: raw.meta?.approvedBy || raw.approvedBy || null,
                        importedAt: raw.meta?.importedAt || now
                    }
                };
                
                // â”€â”€â”€ COVERAGE â”€â”€â”€
                if (raw.coverage !== undefined || raw.staffing) {
                    sop.coverage = {};
                    
                    // Handle coverage as string or object
                    if (typeof raw.coverage === 'string') {
                        sop.coverage.hours = raw.coverage;
                    } else if (raw.coverage?.hours) {
                        sop.coverage.hours = raw.coverage.hours;
                        if (raw.coverage.staffing) sop.coverage.staffing = raw.coverage.staffing;
                        if (raw.coverage.shifts) sop.coverage.shifts = raw.coverage.shifts;
                    }
                    
                    // Handle separate staffing object (sop_master.json format)
                    if (raw.staffing && typeof raw.staffing === 'object') {
                        const shifts = [];
                        Object.entries(raw.staffing).forEach(([time, staff]) => {
                            shifts.push({ time: time, staffing: staff });
                        });
                        if (shifts.length > 0) {
                            sop.coverage.shifts = shifts;
                        }
                    }
                }
                
                // â”€â”€â”€ POST ASSIGNMENTS â”€â”€â”€
                // Accept: posts: {armed: "...", unarmed: "..."}
                // Or: postAssignments: {armed: {post, duties}, unarmed: {post, duties}}
                if (raw.posts || raw.postAssignments) {
                    sop.postAssignments = {};
                    
                    const src = raw.postAssignments || raw.posts;
                    
                    ['armed', 'unarmed', 'mixed'].forEach(type => {
                        if (!src[type]) return;
                        
                        const val = src[type];
                        const targetType = type === 'mixed' ? 'unarmed' : type;
                        
                        if (typeof val === 'string') {
                            // Simple string format: posts.armed = "description"
                            sop.postAssignments[targetType] = {
                                post: type === 'armed' ? 'Armed Post' : type === 'mixed' ? 'General Post' : 'Unarmed Post',
                                duties: [val]
                            };
                        } else if (typeof val === 'object') {
                            // Object format: postAssignments.armed = {post, duties, rules}
                            sop.postAssignments[targetType] = {
                                post: val.post || (type === 'armed' ? 'Armed Post' : 'Unarmed Post'),
                                duties: Array.isArray(val.duties) ? val.duties : (val.duties ? [val.duties] : []),
                                rules: val.rules || []
                            };
                        }
                    });
                }
                
                // â”€â”€â”€ PATROLS â”€â”€â”€
                if (raw.patrols) {
                    if (typeof raw.patrols === 'string') {
                        sop.patrols = { frequency: raw.patrols };
                    } else {
                        sop.patrols = {
                            frequency: raw.patrols.frequency || null,
                            type: raw.patrols.type || null
                        };
                    }
                }
                
                // â”€â”€â”€ ACCESS CONTROL â”€â”€â”€
                if (raw.accessControl) {
                    if (typeof raw.accessControl === 'object') {
                        sop.accessControl = raw.accessControl;
                        if (raw.accessControl.afterHours) {
                            sop.afterHoursAccess = raw.accessControl.afterHours;
                        }
                    } else {
                        sop.accessControl = { notes: raw.accessControl };
                    }
                }
                if (raw.afterHoursAccess) {
                    sop.afterHoursAccess = raw.afterHoursAccess;
                }
                
                // â”€â”€â”€ SPECIAL INSTRUCTIONS â”€â”€â”€
                if (raw.specialInstructions?.length) {
                    sop.specialInstructions = raw.specialInstructions;
                }
                
                // â”€â”€â”€ COMMON ISSUES / NOTES â”€â”€â”€
                if (raw.commonIssues?.length) {
                    sop.commonIssues = raw.commonIssues;
                } else if (raw.notes?.length) {
                    sop.commonIssues = raw.notes;
                }
                
                // â”€â”€â”€ USE OF FORCE â”€â”€â”€
                if (raw.useOfForce) {
                    sop.useOfForce = raw.useOfForce;
                }
                
                // â”€â”€â”€ ESCALATION â”€â”€â”€
                if (raw.escalation?.length) {
                    sop.escalation = raw.escalation;
                }
                
                // â”€â”€â”€ TOUR SYSTEM â”€â”€â”€
                if (raw.tourSystem) {
                    sop.tourSystem = raw.tourSystem;
                }
                
                // â”€â”€â”€ CAMERAS â”€â”€â”€
                if (raw.cameras) {
                    sop.cameras = raw.cameras;
                }
                
                return sop;
            },
            
            /**
             * Ensure an already-internal format has all expected fields
             */
            _ensureComplete: function(sop, siteId) {
                // Just make sure siteId is set
                if (!sop.siteId) sop.siteId = siteId;
                return sop;
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DATA NORMALIZER - Core utility functions for all entity normalization
        // v6.19.4: Universal format handling
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const DataNormalizer = {
            /**
             * Normalize phone to digits only, with optional formatting
             * Accepts: "(973) 555-1234", "973.555.1234", "9735551234", "+1 973 555 1234"
             * Returns: "9735551234" (10 digits) or original if invalid
             */
            phone: function(val) {
                if (!val) return '';
                const str = String(val).trim();
                if (!str) return '';
                
                // Strip to digits only
                let digits = str.replace(/\D/g, '');
                
                // Handle +1 country code
                if (digits.length === 11 && digits.startsWith('1')) {
                    digits = digits.slice(1);
                }
                
                // Return 10-digit number or empty if invalid
                return digits.length === 10 ? digits : str;
            },
            
            /**
             * Format phone for display: (973) 555-1234
             */
            phoneDisplay: function(val) {
                const digits = this.phone(val);
                if (digits.length !== 10) return val || '';
                return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
            },
            
            /**
             * Normalize date to ISO format YYYY-MM-DD
             * Accepts: "12/24/2025", "2025-12-24", "Dec 24, 2025", Date object
             */
            date: function(val) {
                if (!val) return null;
                if (val instanceof Date) {
                    return isNaN(val.getTime()) ? null : val.toISOString().split('T')[0];
                }
                
                const str = String(val).trim();
                if (!str) return null;
                
                // Already ISO format
                if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
                
                // Try parsing various formats
                const parsed = new Date(str);
                if (!isNaN(parsed.getTime())) {
                    return parsed.toISOString().split('T')[0];
                }
                
                // Handle MM/DD/YYYY
                const mdyMatch = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
                if (mdyMatch) {
                    const [, m, d, y] = mdyMatch;
                    return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
                }
                
                return null;
            },
            
            /**
             * Normalize time to 24h format HH:MM
             * Accepts: "7A", "7:00 AM", "07:00", "0700", "7am", "19:00"
             */
            time: function(val) {
                if (!val) return null;
                const str = String(val).trim().toUpperCase();
                if (!str) return null;
                
                // Already 24h format
                if (/^\d{2}:\d{2}$/.test(str)) return str;
                
                // Handle "7A" or "7P" shorthand
                const shortMatch = str.match(/^(\d{1,2})([AP])$/);
                if (shortMatch) {
                    let [, h, ap] = shortMatch;
                    h = parseInt(h, 10);
                    if (ap === 'P' && h !== 12) h += 12;
                    if (ap === 'A' && h === 12) h = 0;
                    return `${String(h).padStart(2,'0')}:00`;
                }
                
                // Handle "7:00 AM" or "7:00AM"
                const fullMatch = str.match(/^(\d{1,2}):?(\d{2})?\s*([AP]M?)$/);
                if (fullMatch) {
                    let [, h, m, ap] = fullMatch;
                    h = parseInt(h, 10);
                    m = m || '00';
                    if (ap.startsWith('P') && h !== 12) h += 12;
                    if (ap.startsWith('A') && h === 12) h = 0;
                    return `${String(h).padStart(2,'0')}:${m}`;
                }
                
                // Handle "0700" military
                if (/^\d{4}$/.test(str)) {
                    return `${str.slice(0,2)}:${str.slice(2)}`;
                }
                
                return null;
            },
            
            /**
             * Normalize boolean-like values
             * Accepts: true, "true", "True", "yes", "Y", 1, "1", "on"
             */
            boolean: function(val, defaultVal = false) {
                if (val === null || val === undefined) return defaultVal;
                if (typeof val === 'boolean') return val;
                
                const str = String(val).toLowerCase().trim();
                const truthy = ['true', 'yes', 'y', '1', 'on', 'x', 'âœ“', 'âœ”'];
                const falsy = ['false', 'no', 'n', '0', 'off', ''];
                
                if (truthy.includes(str)) return true;
                if (falsy.includes(str)) return false;
                return defaultVal;
            },
            
            /**
             * Normalize status to allowed values (case-insensitive)
             * Returns lowercase, validates against allowed list
             */
            status: function(val, allowed, defaultVal) {
                if (!val) return defaultVal;
                const normalized = String(val).toLowerCase().trim();
                return allowed.includes(normalized) ? normalized : defaultVal;
            },
            
            /**
             * Normalize empty values to null
             * Handles: "", "N/A", "n/a", "-", "None", "TBD", "null", "undefined"
             */
            emptyToNull: function(val) {
                if (val === null || val === undefined) return null;
                if (typeof val !== 'string') return val;
                
                const str = val.trim();
                const emptyPatterns = ['', 'n/a', 'na', '-', 'none', 'tbd', 'null', 'undefined', 'â€”', 'â€“'];
                return emptyPatterns.includes(str.toLowerCase()) ? null : str;
            },
            
            /**
             * Normalize to array (handles string, array, null)
             */
            toArray: function(val, delimiter = /[,;|]/) {
                if (!val) return [];
                if (Array.isArray(val)) return val.filter(v => v != null);
                if (typeof val === 'string') {
                    return val.split(delimiter)
                        .map(s => s.trim())
                        .filter(s => s && !['n/a', 'none', '-'].includes(s.toLowerCase()));
                }
                return [];
            },
            
            /**
             * Title case a string
             */
            titleCase: function(val) {
                if (!val) return '';
                return String(val).trim()
                    .toLowerCase()
                    .replace(/\b\w/g, c => c.toUpperCase());
            },
            
            /**
             * Sanitize string (basic XSS prevention)
             */
            sanitize: function(val) {
                if (!val) return '';
                return String(val)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GUARD NORMALIZER - Universal guard format handling
        // v6.19.4: Handles CSV imports, manual entry, Firestore, any format
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const GuardNormalizer = {
            // Allowed values for enum fields
            ALLOWED_STATUS: ['active', 'inactive', 'suspended', 'terminated'],
            ALLOWED_ROLES: ['guard', 'armed', 'unarmed', 'supervisor', 'floater', 'lead', 'manager'],
            
            // Status aliases (map variations to canonical values)
            STATUS_ALIASES: {
                'hired': 'active',
                'available': 'active',
                'working': 'active',
                'on duty': 'active',
                'off': 'inactive',
                'off duty': 'inactive',
                'not working': 'inactive',
                'leave': 'inactive',
                'on leave': 'inactive',
                'fired': 'terminated',
                'quit': 'terminated',
                'resigned': 'terminated',
                'let go': 'terminated'
            },
            
            // Role aliases
            ROLE_ALIASES: {
                'security': 'guard',
                'officer': 'guard',
                'security officer': 'guard',
                'security guard': 'guard',
                'armed guard': 'armed',
                'armed officer': 'armed',
                'unarmed guard': 'unarmed',
                'unarmed officer': 'unarmed',
                'sup': 'supervisor',
                'supv': 'supervisor',
                'team lead': 'lead',
                'shift lead': 'lead',
                'flex': 'floater',
                'relief': 'floater',
                'fill-in': 'floater',
                'mgr': 'manager',
                'admin': 'manager'
            },
            
            /**
             * Normalize any guard data to canonical format
             * @param {Object} raw - Raw guard data from any source
             * @param {Object} options - Options like { generateId: true }
             * @returns {Object} Normalized guard object
             */
            normalize: function(raw, options = {}) {
                if (!raw || typeof raw !== 'object') return null;
                
                const now = new Date().toISOString();
                
                // â”€â”€â”€ NAME HANDLING â”€â”€â”€
                // Accept: name, firstName+lastName, first_name+last_name, fullName
                let firstName = '', lastName = '', fullName = '';
                
                if (raw.name || raw.fullName) {
                    fullName = String(raw.name || raw.fullName).trim();
                    const parts = fullName.split(/\s+/);
                    firstName = parts[0] || '';
                    lastName = parts.slice(1).join(' ') || '';
                } else {
                    firstName = String(raw.firstName || raw.first_name || raw.first || '').trim();
                    lastName = String(raw.lastName || raw.last_name || raw.last || '').trim();
                    fullName = `${firstName} ${lastName}`.trim();
                }
                
                // â”€â”€â”€ STATUS NORMALIZATION â”€â”€â”€
                let status = String(raw.status || '').toLowerCase().trim();
                // Check aliases first
                if (this.STATUS_ALIASES[status]) {
                    status = this.STATUS_ALIASES[status];
                }
                // Validate or default
                if (!this.ALLOWED_STATUS.includes(status)) {
                    status = 'active';
                }
                
                // â”€â”€â”€ ROLE NORMALIZATION â”€â”€â”€
                let role = String(raw.role || raw.position || raw.type || '').toLowerCase().trim();
                // Check aliases
                if (this.ROLE_ALIASES[role]) {
                    role = this.ROLE_ALIASES[role];
                }
                // Validate or default
                if (!this.ALLOWED_ROLES.includes(role)) {
                    role = 'guard';
                }
                
                // â”€â”€â”€ BUILD NORMALIZED GUARD â”€â”€â”€
                const guard = {
                    id: raw.id || (options.generateId ? this._generateId() : null),
                    firstName: DataNormalizer.emptyToNull(firstName) || fullName.split(' ')[0] || 'Unknown',
                    lastName: DataNormalizer.emptyToNull(lastName) || '',
                    name: fullName || 'Unknown',
                    
                    phone: DataNormalizer.phone(raw.phone || raw.phoneNumber || raw.cell || raw.mobile || ''),
                    email: DataNormalizer.emptyToNull(
                        String(raw.email || raw.emailAddress || '').toLowerCase().trim()
                    ) || '',
                    
                    status: status,
                    role: role,
                    
                    hireDate: DataNormalizer.date(raw.hireDate || raw.hire_date || raw.startDate || raw.start_date),
                    terminationDate: DataNormalizer.date(raw.terminationDate || raw.termination_date || raw.endDate),
                    suspensionEnd: DataNormalizer.date(raw.suspensionEnd || raw.suspension_end),
                    
                    // Arrays
                    certifications: this._normalizeCertifications(raw.certifications || raw.certs),
                    skills: DataNormalizer.toArray(raw.skills),
                    primarySites: DataNormalizer.toArray(raw.primarySites || raw.primary_sites || raw.sites),
                    
                    // Optional fields
                    address: DataNormalizer.emptyToNull(raw.address) || '',
                    emergencyContact: DataNormalizer.emptyToNull(raw.emergencyContact || raw.emergency_contact) || '',
                    emergencyPhone: DataNormalizer.phone(raw.emergencyPhone || raw.emergency_phone || ''),
                    
                    notes: DataNormalizer.emptyToNull(raw.notes || raw.comments || raw.memo) || '',
                    
                    // Metadata
                    createdAt: raw.createdAt || raw.created_at || now,
                    updatedAt: now,
                    
                    // Source tracking (for debugging)
                    _normalized: true,
                    _normalizedAt: now
                };
                
                // Remove null ID if not generated
                if (!guard.id) delete guard.id;
                
                return guard;
            },
            
            /**
             * Normalize certifications array
             * Handles: string, array of strings, array of objects
             */
            _normalizeCertifications: function(raw) {
                if (!raw) return [];
                
                const arr = DataNormalizer.toArray(raw);
                
                return arr.map(cert => {
                    if (typeof cert === 'string') {
                        return { name: cert.trim(), expires: null };
                    }
                    if (typeof cert === 'object' && cert.name) {
                        return {
                            name: String(cert.name).trim(),
                            expires: DataNormalizer.date(cert.expires || cert.expiration || cert.expirationDate)
                        };
                    }
                    return null;
                }).filter(c => c && c.name);
            },
            
            /**
             * Generate guard ID
             */
            _generateId: function() {
                return 'guard-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            },
            
            /**
             * Validate normalized guard
             * @returns {{ valid: boolean, errors: string[], warnings: string[] }}
             */
            validate: function(guard) {
                const errors = [];
                const warnings = [];
                
                if (!guard) {
                    return { valid: false, errors: ['Guard object is required'], warnings: [] };
                }
                
                if (!guard.id) errors.push('Guard ID is required');
                if (!guard.name || guard.name === 'Unknown') errors.push('Guard name is required');
                
                // Phone validation
                if (guard.phone) {
                    const digits = guard.phone.replace(/\D/g, '');
                    if (digits.length !== 10 && digits.length !== 0) {
                        warnings.push(`Phone "${guard.phone}" may be invalid (expected 10 digits)`);
                    }
                }
                
                // Email validation
                if (guard.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(guard.email)) {
                    warnings.push(`Email "${guard.email}" may be invalid`);
                }
                
                // Status suspended but no end date
                if (guard.status === 'suspended' && !guard.suspensionEnd) {
                    warnings.push('Suspended guard has no suspension end date');
                }
                
                return {
                    valid: errors.length === 0,
                    errors,
                    warnings
                };
            },
            
            /**
             * Normalize and validate in one call
             * @returns {{ data: Object|null, valid: boolean, errors: string[], warnings: string[] }}
             */
            normalizeAndValidate: function(raw, options = {}) {
                const data = this.normalize(raw, options);
                const validation = this.validate(data);
                return {
                    data: validation.valid || options.allowInvalid ? data : null,
                    ...validation
                };
            }
        };


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TASKS MODULE - v6.8.6
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const TasksModule = {
            currentView: 'board',
            calendarDate: new Date(),
            owners: ['Mike Howard', 'Supervisor 1', 'Supervisor 2'],
            dueDateFilter: null, // 'today', 'overdue', null

            init: function() {
                // Quick add input
                const quickInput = document.getElementById('tasks-quick-input');
                if (quickInput) {
                    quickInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && quickInput.value.trim()) {
                            this.quickAdd(quickInput.value.trim());
                            quickInput.value = '';
                        }
                    });
                }

                // Populate owner filter
                this.populateOwnerFilter();
                
                // Initial render
                this.render();
            },
            
            // Filter tasks by due date and navigate to tasks
            filterByDueDate: function(filter) {
                this.dueDateFilter = filter;
                Router.navigate('tasks');
                setTimeout(() => this.render(), 100);
            },

            populateOwnerFilter: function() {
                const select = document.getElementById('tasks-filter-owner');
                if (!select) return;
                
                select.innerHTML = '<option value="">All</option>';
                this.owners.forEach(owner => {
                    select.innerHTML += `<option value="${owner}">${owner}</option>`;
                });
            },

            // Quick add - creates task in INBOX
            quickAdd: function(title) {
                const task = {
                    id: Utils.generateId('task-'),
                    title: title,
                    status: 'inbox',
                    priority: 'p1',
                    category: '',
                    due: null,
                    guardId: null,
                    siteId: null,
                    owner: this.owners[0],
                    waitingOn: '',
                    notes: '',
                    proof: '',
                    recurring: false,
                    recurringInterval: null,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    completedAt: null
                };

                const tasks = DataStore.getTasks();
                tasks.push(task);
                DataStore.saveTasks(tasks);
                
                this.render();
                UI.toast('Task Added', `"${title}" added to Inbox`, 'success');
            },

            // View switching
            setView: function(view) {
                this.currentView = view;
                
                // Update buttons
                document.querySelectorAll('.tasks-view-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === view);
                });

                // Show/hide views
                document.getElementById('tasks-view-board').style.display = view === 'board' ? 'grid' : 'none';
                document.getElementById('tasks-view-list').style.display = view === 'list' ? 'block' : 'none';
                document.getElementById('tasks-view-calendar').style.display = view === 'calendar' ? 'block' : 'none';

                this.render();
            },

            // Get filtered tasks
            getFilteredTasks: function() {
                let tasks = DataStore.getTasks();
                const today = Utils.toISODate(new Date());
                
                const priorityFilter = document.getElementById('tasks-filter-priority')?.value;
                const categoryFilter = document.getElementById('tasks-filter-category')?.value;
                const ownerFilter = document.getElementById('tasks-filter-owner')?.value;
                const hideDone = document.getElementById('tasks-filter-hide-done')?.checked;

                // Apply due date filter from dashboard click
                if (this.dueDateFilter === 'today') {
                    tasks = tasks.filter(t => t.due === today || t.dueDate === today);
                } else if (this.dueDateFilter === 'overdue') {
                    tasks = tasks.filter(t => (t.due && t.due < today) || (t.dueDate && t.dueDate < today));
                }

                if (priorityFilter) {
                    tasks = tasks.filter(t => t.priority === priorityFilter);
                }
                if (categoryFilter) {
                    tasks = tasks.filter(t => t.category === categoryFilter);
                }
                if (ownerFilter) {
                    tasks = tasks.filter(t => t.owner === ownerFilter);
                }
                if (hideDone) {
                    tasks = tasks.filter(t => t.status !== 'done');
                }

                return tasks;
            },

            // Main render dispatcher
            render: function() {
                switch (this.currentView) {
                    case 'board': this.renderBoard(); break;
                    case 'list': this.renderList(); break;
                    case 'calendar': this.renderCalendar(); break;
                }
                this.updateDashboardWidget();
            },

            // Board view render
            renderBoard: function() {
                const tasks = this.getFilteredTasks();
                const lanes = { inbox: [], next: [], waiting: [], done: [] };

                tasks.forEach(task => {
                    if (lanes[task.status]) {
                        lanes[task.status].push(task);
                    }
                });

                // Sort: overdue first, then by due date, then by priority
                const sortTasks = (arr) => arr.sort((a, b) => {
                    const aOverdue = a.due && new Date(a.due) < new Date() ? -1 : 0;
                    const bOverdue = b.due && new Date(b.due) < new Date() ? -1 : 0;
                    if (aOverdue !== bOverdue) return aOverdue - bOverdue;
                    if (a.due && b.due) return new Date(a.due) - new Date(b.due);
                    if (a.due) return -1;
                    if (b.due) return 1;
                    const priorityOrder = { p0: 0, p1: 1, p2: 2 };
                    return (priorityOrder[a.priority] || 2) - (priorityOrder[b.priority] || 2);
                });

                Object.keys(lanes).forEach(lane => {
                    sortTasks(lanes[lane]);
                    document.getElementById(`lane-count-${lane}`).textContent = lanes[lane].length;
                    document.getElementById(`lane-items-${lane}`).innerHTML = lanes[lane].map(t => this.renderTaskCard(t)).join('');
                });
            },

            renderTaskCard: function(task) {
                const isDone = task.status === 'done';
                const dueInfo = this.getDueInfo(task);
                const guard = task.guardId ? DataStore.getGuards().find(g => g.id === task.guardId) : null;
                const site = task.siteId ? DataStore.getSites().find(s => s.id === task.siteId) : null;

                return `
                    <div class="task-card priority-${task.priority}" onclick="TasksModule.openTaskModal('${task.id}')">
                        <div class="task-card-title">${Utils.escapeHtml(task.title)}</div>
                        <div class="task-card-meta">
                            ${task.category ? `<span class="task-card-tag">${task.category}</span>` : ''}
                            ${site ? `<span class="task-card-tag">ğŸ“ ${Utils.escapeHtml(site.name)}</span>` : ''}
                            ${guard ? `<span class="task-card-tag sensitive">ğŸ‘¤ ${Utils.escapeHtml(guard.name)}</span>` : ''}
                        </div>
                        ${dueInfo.text ? `
                            <div class="task-card-due ${dueInfo.class}">
                                ${dueInfo.text}
                            </div>
                        ` : ''}
                    </div>
                `;
            },

            // Unified due date/time info
            getDueInfo: function(task) {
                if (task.status === 'done') {
                    if (task.completedAt) {
                        return { 
                            text: `âœ“ ${new Date(task.completedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`,
                            class: 'completed'
                        };
                    }
                    return { text: 'âœ“ Done', class: 'completed' };
                }

                if (!task.due) return { text: '', class: '' };

                const due = new Date(task.due);
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const dueDay = new Date(due.getFullYear(), due.getMonth(), due.getDate());
                const diffDays = Math.floor((dueDay - today) / (1000 * 60 * 60 * 24));

                // Format time if set
                const hasTime = task.dueTime || (due.getHours() !== 23 && due.getMinutes() !== 59);
                const timeStr = hasTime ? due.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '';

                let dateStr = '';
                let className = '';

                if (diffDays < 0) {
                    // Overdue
                    const daysLate = Math.abs(diffDays);
                    dateStr = daysLate === 1 ? 'Yesterday' : `${daysLate}d ago`;
                    className = 'overdue';
                } else if (diffDays === 0) {
                    dateStr = 'Today';
                    className = 'today';
                } else if (diffDays === 1) {
                    dateStr = 'Tomorrow';
                    className = 'upcoming';
                } else if (diffDays < 7) {
                    dateStr = due.toLocaleDateString('en-US', { weekday: 'short' });
                    className = 'upcoming';
                } else {
                    dateStr = due.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }

                const fullText = timeStr ? `ğŸ“… ${dateStr} @ ${timeStr}` : `ğŸ“… ${dateStr}`;
                return { text: fullText, class: className };
            },

            getDueClass: function(due) {
                if (!due) return '';
                const dueDate = new Date(due);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                dueDate.setHours(0, 0, 0, 0);
                
                if (dueDate < today) return 'overdue';
                if (dueDate.getTime() === today.getTime()) return 'today';
                return '';
            },

            formatDue: function(due) {
                if (!due) return '';
                const dueDate = new Date(due);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                dueDate.setHours(0, 0, 0, 0);

                const diff = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                if (diff < 0) return `${Math.abs(diff)}d overdue`;
                if (diff === 0) return 'Today';
                if (diff === 1) return 'Tomorrow';
                if (diff < 7) return dueDate.toLocaleDateString('en-US', { weekday: 'short' });
                return dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            },

            // List view render
            renderList: function() {
                const tasks = this.getFilteredTasks();
                const container = document.getElementById('tasks-list-items');
                if (!container) return;

                // Sort by status, then due date
                const statusOrder = { next: 0, inbox: 1, waiting: 2, done: 3 };
                tasks.sort((a, b) => {
                    if (statusOrder[a.status] !== statusOrder[b.status]) {
                        return statusOrder[a.status] - statusOrder[b.status];
                    }
                    if (a.due && b.due) return new Date(a.due) - new Date(b.due);
                    if (a.due) return -1;
                    return 1;
                });

                container.innerHTML = tasks.map(task => {
                    const dueInfo = this.getDueInfo(task);
                    return `
                        <div class="tasks-list-item ${task.status === 'done' ? 'done' : ''}">
                            <div class="task-checkbox ${task.status === 'done' ? 'checked' : ''}" 
                                 onclick="TasksModule.toggleComplete('${task.id}')">
                                ${task.status === 'done' ? 'âœ“' : ''}
                            </div>
                            <div class="task-list-title" onclick="TasksModule.openTaskModal('${task.id}')">
                                ${Utils.escapeHtml(task.title)}
                            </div>
                            <div><span class="task-card-tag">${task.category || '-'}</span></div>
                            <div><span class="badge badge-${task.priority === 'p0' ? 'danger' : task.priority === 'p1' ? 'warning' : 'secondary'}">${task.priority.toUpperCase()}</span></div>
                            <div class="task-card-due ${dueInfo.class}">${dueInfo.text || '-'}</div>
                            <div><span class="task-card-tag">${task.status}</span></div>
                            <div class="sensitive">${task.owner || '-'}</div>
                            <div>
                                <button class="btn btn-xs btn-ghost" onclick="TasksModule.deleteTask('${task.id}')" title="Delete">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                if (tasks.length === 0) {
                    container.innerHTML = '<div style="padding: var(--space-6); text-align: center; color: var(--color-text-muted);">No tasks match your filters</div>';
                }
            },

            // Calendar view render
            renderCalendar: function() {
                const year = this.calendarDate.getFullYear();
                const month = this.calendarDate.getMonth();
                
                document.getElementById('tasks-calendar-title').textContent = 
                    this.calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());

                const tasks = this.getFilteredTasks().filter(t => t.due);
                const tasksByDate = {};
                tasks.forEach(t => {
                    const dateKey = t.due.split('T')[0];
                    if (!tasksByDate[dateKey]) tasksByDate[dateKey] = [];
                    tasksByDate[dateKey].push(t);
                });

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let html = `
                    <div class="tasks-calendar-day-header">Sun</div>
                    <div class="tasks-calendar-day-header">Mon</div>
                    <div class="tasks-calendar-day-header">Tue</div>
                    <div class="tasks-calendar-day-header">Wed</div>
                    <div class="tasks-calendar-day-header">Thu</div>
                    <div class="tasks-calendar-day-header">Fri</div>
                    <div class="tasks-calendar-day-header">Sat</div>
                `;

                const current = new Date(startDate);
                for (let i = 0; i < 42; i++) {
                    const dateKey = current.toISOString().split('T')[0];
                    const isOtherMonth = current.getMonth() !== month;
                    const isToday = current.getTime() === today.getTime();
                    const dayTasks = tasksByDate[dateKey] || [];

                    html += `
                        <div class="tasks-calendar-day ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}"
                             onclick="TasksModule.openTaskModal(null, '${dateKey}')">
                            <div class="tasks-calendar-date">${current.getDate()}</div>
                            <div class="tasks-calendar-items">
                                ${dayTasks.slice(0, 3).map(t => `
                                    <div class="tasks-calendar-item priority-${t.priority}" 
                                         onclick="event.stopPropagation(); TasksModule.openTaskModal('${t.id}')">
                                        ${Utils.escapeHtml(t.title)}
                                    </div>
                                `).join('')}
                                ${dayTasks.length > 3 ? `<div class="tasks-calendar-more">+${dayTasks.length - 3} more</div>` : ''}
                            </div>
                        </div>
                    `;

                    current.setDate(current.getDate() + 1);
                }

                document.getElementById('tasks-calendar-grid').innerHTML = html;
            },

            calendarPrev: function() {
                this.calendarDate.setMonth(this.calendarDate.getMonth() - 1);
                this.renderCalendar();
            },

            calendarNext: function() {
                this.calendarDate.setMonth(this.calendarDate.getMonth() + 1);
                this.renderCalendar();
            },

            calendarToday: function() {
                this.calendarDate = new Date();
                this.renderCalendar();
            },

            // Dashboard widget
            updateDashboardWidget: function() {
                const widget = document.getElementById('dashboard-tasks-widget');
                if (!widget) return;

                const tasks = DataStore.getTasks().filter(t => t.status !== 'done');
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Get urgent tasks: P0, overdue, or due today
                const urgent = tasks.filter(t => {
                    if (t.priority === 'p0') return true;
                    if (!t.due) return false;
                    const due = new Date(t.due);
                    due.setHours(0, 0, 0, 0);
                    return due <= today;
                }).slice(0, 5);

                const countEl = widget.querySelector('.dashboard-tasks-count');
                const listEl = widget.querySelector('.dashboard-tasks-list');

                if (countEl) {
                    countEl.textContent = urgent.length;
                    countEl.style.display = urgent.length > 0 ? 'inline-block' : 'none';
                }

                if (listEl) {
                    if (urgent.length === 0) {
                        listEl.innerHTML = '<div style="padding: var(--space-3); text-align: center; color: var(--color-text-muted); font-size: var(--font-size-sm);">No urgent tasks</div>';
                    } else {
                        listEl.innerHTML = urgent.map(t => {
                            const dueInfo = this.getDueInfo(t);
                            return `
                            <div class="dashboard-task-item" onclick="Router.navigate('tasks'); setTimeout(() => TasksModule.openTaskModal('${t.id}'), 100);">
                                <div class="dashboard-task-priority ${t.priority}"></div>
                                <div class="dashboard-task-content">
                                    <div class="dashboard-task-title">${Utils.escapeHtml(t.title)}</div>
                                    <div class="dashboard-task-due ${dueInfo.class}">${dueInfo.text || 'No due date'}</div>
                                </div>
                            </div>
                        `}).join('');
                    }
                }
            },

            // Toggle completion
            toggleComplete: function(taskId) {
                const tasks = DataStore.getTasks();
                const task = tasks.find(t => t.id === taskId);
                if (!task) return;

                if (task.status === 'done') {
                    task.status = 'next';
                    task.completedAt = null;
                } else {
                    // Check if recurring
                    if (task.recurring && task.recurringInterval) {
                        this.createNextRecurrence(task);
                    }
                    task.status = 'done';
                    task.completedAt = new Date().toISOString();
                }
                task.updatedAt = new Date().toISOString();

                DataStore.saveTasks(tasks);
                this.render();
            },

            createNextRecurrence: function(task) {
                if (!task.due) return;

                const newDue = new Date(task.due);
                switch (task.recurringInterval) {
                    case 'daily': newDue.setDate(newDue.getDate() + 1); break;
                    case 'weekly': newDue.setDate(newDue.getDate() + 7); break;
                    case 'biweekly': newDue.setDate(newDue.getDate() + 14); break;
                    case 'monthly': newDue.setMonth(newDue.getMonth() + 1); break;
                    case 'yearly': newDue.setFullYear(newDue.getFullYear() + 1); break;
                }

                const newTask = {
                    ...task,
                    id: Utils.generateId('task-'),
                    status: 'next',
                    due: newDue.toISOString(), // Keep full ISO with time
                    completedAt: null,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                const tasks = DataStore.getTasks();
                tasks.push(newTask);
                DataStore.saveTasks(tasks);

                const dateStr = newDue.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                UI.notify(`Recurring task scheduled for ${dateStr}`, 'info');
            },

            // Move task between lanes
            moveTask: function(taskId, newStatus) {
                const tasks = DataStore.getTasks();
                const task = tasks.find(t => t.id === taskId);
                if (!task) return;

                task.status = newStatus;
                task.updatedAt = new Date().toISOString();
                if (newStatus === 'done') {
                    task.completedAt = new Date().toISOString();
                }

                DataStore.saveTasks(tasks);
                this.render();
            },

            // Delete task
            deleteTask: function(taskId) {
                console.log('[TasksModule] deleteTask called with:', taskId);
                
                if (!taskId) {
                    console.error('[TasksModule] deleteTask called without taskId');
                    UI.toast('Error', 'No task ID provided', 'error');
                    return;
                }
                
                try {
                    let tasks = DataStore.getTasks();
                    console.log('[TasksModule] Tasks before delete:', tasks.length);
                    
                    const taskToDelete = tasks.find(t => t.id === taskId);
                    if (!taskToDelete) {
                        console.warn('[TasksModule] Task not found:', taskId);
                        UI.toast('Error', 'Task not found', 'error');
                        return;
                    }
                    
                    tasks = tasks.filter(t => t.id !== taskId);
                    console.log('[TasksModule] Tasks after filter:', tasks.length);
                    
                    DataStore.saveTasks(tasks);
                    console.log('[TasksModule] Tasks saved');
                    
                    this.render();
                    UI.toast('Task Deleted', 'Task has been removed', 'success');
                } catch (err) {
                    console.error('[TasksModule] Error deleting task:', err);
                    UI.toast('Error', 'Failed to delete task: ' + err.message, 'error');
                }
            },

            // Open task modal for create/edit
            openTaskModal: function(taskId = null, prefillDate = null) {
                const task = taskId ? DataStore.getTasks().find(t => t.id === taskId) : null;
                const isEdit = !!task;
                const guards = (DataStore.getGuards() || []).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                const sites = (DataStore.getSites() || []).sort((a, b) => (a.name || '').localeCompare(b.name || ''));

                // Parse existing due date/time
                let dueDate = prefillDate || '';
                let dueTime = '';
                if (task?.due) {
                    const d = new Date(task.due);
                    dueDate = d.toISOString().split('T')[0];
                    // Check if time was set (not midnight)
                    if (d.getHours() !== 0 || d.getMinutes() !== 0) {
                        dueTime = d.toTimeString().slice(0, 5);
                    }
                }

                const content = `
                    <form id="task-form" class="task-form-grid">
                        <div class="form-group task-form-full">
                            <label class="form-label">Task *</label>
                            <input type="text" class="form-input" id="task-title" value="${task ? Utils.escapeHtml(task.title) : ''}" required placeholder="What needs to be done?">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="task-status">
                                <option value="inbox" ${task?.status === 'inbox' ? 'selected' : ''}>ğŸ“¥ Inbox</option>
                                <option value="next" ${task?.status === 'next' || !task ? 'selected' : ''}>âš¡ Next</option>
                                <option value="waiting" ${task?.status === 'waiting' ? 'selected' : ''}>â³ Waiting</option>
                                <option value="done" ${task?.status === 'done' ? 'selected' : ''}>âœ… Done</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Priority</label>
                            <select class="form-select" id="task-priority">
                                <option value="p0" ${task?.priority === 'p0' ? 'selected' : ''}>ğŸ”´ P0 - Critical</option>
                                <option value="p1" ${task?.priority === 'p1' || !task ? 'selected' : ''}>ğŸŸ¡ P1 - High</option>
                                <option value="p2" ${task?.priority === 'p2' ? 'selected' : ''}>âšª P2 - Normal</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="task-category">
                                <option value="">-- Select --</option>
                                <option value="training" ${task?.category === 'training' ? 'selected' : ''}>ğŸ“š Training</option>
                                <option value="meeting" ${task?.category === 'meeting' ? 'selected' : ''}>ğŸ“… Meeting</option>
                                <option value="coverage" ${task?.category === 'coverage' ? 'selected' : ''}>ğŸ‘® Coverage</option>
                                <option value="admin" ${task?.category === 'admin' ? 'selected' : ''}>ğŸ“‹ Admin</option>
                                <option value="errand" ${task?.category === 'errand' ? 'selected' : ''}>ğŸƒ Errand</option>
                                <option value="inspection" ${task?.category === 'inspection' ? 'selected' : ''}>ğŸ” Inspection</option>
                                <option value="followup" ${task?.category === 'followup' ? 'selected' : ''}>ğŸ“ Follow-up</option>
                            </select>
                        </div>

                        <!-- DUE DATE & TIME - Redesigned -->
                        <div class="form-group">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-input" id="task-due-date" value="${dueDate}">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Time <span class="text-muted">(optional)</span></label>
                            <input type="time" class="form-input" id="task-due-time" value="${dueTime}">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Owner</label>
                            <select class="form-select" id="task-owner">
                                ${this.owners.map(o => `<option value="${o}" ${task?.owner === o || (!task && o === this.owners[0]) ? 'selected' : ''}>${o}</option>`).join('')}
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Linked Guard</label>
                            <select class="form-select" id="task-guard">
                                <option value="">-- None --</option>
                                ${guards.map(g => `<option value="${g.id}" ${task?.guardId === g.id ? 'selected' : ''}>${Utils.escapeHtml(g.name)}</option>`).join('')}
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Linked Site</label>
                            <select class="form-select" id="task-site">
                                <option value="">-- None --</option>
                                ${sites.map(s => `<option value="${s.id}" ${task?.siteId === s.id ? 'selected' : ''}>${Utils.escapeHtml(s.name)}</option>`).join('')}
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Waiting On</label>
                            <input type="text" class="form-input" id="task-waiting" value="${task?.waitingOn || ''}" placeholder="Person/vendor blocking this">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Recurring</label>
                            <select class="form-select" id="task-recurring">
                                <option value="">Not recurring</option>
                                <option value="daily" ${task?.recurringInterval === 'daily' ? 'selected' : ''}>Daily</option>
                                <option value="weekly" ${task?.recurringInterval === 'weekly' ? 'selected' : ''}>Weekly</option>
                                <option value="biweekly" ${task?.recurringInterval === 'biweekly' ? 'selected' : ''}>Every 2 Weeks</option>
                                <option value="monthly" ${task?.recurringInterval === 'monthly' ? 'selected' : ''}>Monthly</option>
                                <option value="yearly" ${task?.recurringInterval === 'yearly' ? 'selected' : ''}>Yearly</option>
                            </select>
                        </div>

                        <div class="form-group task-form-full">
                            <label class="form-label">Notes</label>
                            <textarea class="form-textarea" id="task-notes" rows="2" placeholder="Additional details...">${task?.notes || ''}</textarea>
                        </div>

                        <div class="form-group task-form-full">
                            <label class="form-label">Proof/Link</label>
                            <input type="text" class="form-input" id="task-proof" value="${task?.proof || ''}" placeholder="Case #, email subject, document link...">
                        </div>

                        ${isEdit && task?.createdAt ? `
                            <div class="form-group task-form-full" style="padding-top: var(--space-2); border-top: 1px solid var(--color-border); margin-top: var(--space-2);">
                                <div class="text-sm text-muted">
                                    Created: ${new Date(task.createdAt).toLocaleString()}
                                    ${task.completedAt ? ` Â· Completed: ${new Date(task.completedAt).toLocaleString()}` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </form>
                `;

                const footer = `
                    ${isEdit && taskId ? `<button class="btn btn-danger" onclick="event.preventDefault(); UI.closeModal(); TasksModule.deleteTask('${taskId}');" style="margin-right: auto;">Delete</button>` : ''}
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="TasksModule.saveTask('${taskId || ''}')">
                        ${isEdit ? 'Update Task' : 'Create Task'}
                    </button>
                `;

                UI.openModal(isEdit ? 'Edit Task' : 'New Task', content, footer, 'lg');
            },

            saveTask: function(taskId) {
                try {
                    const titleEl = document.getElementById('task-title');
                    if (!titleEl) {
                        console.error('[TasksModule] task-title element not found');
                        UI.notify('Form not found. Please try again.', 'error');
                        return;
                    }
                    
                    const title = titleEl.value.trim();
                    if (!title) {
                        UI.notify('Task title is required', 'error');
                        return;
                    }

                    // Combine date and time properly
                    const dueDate = document.getElementById('task-due-date')?.value || '';
                    const dueTime = document.getElementById('task-due-time')?.value || '';
                    let dueDateTime = null;
                    
                    if (dueDate) {
                        if (dueTime) {
                            // Combine date and time in local timezone
                            dueDateTime = new Date(`${dueDate}T${dueTime}:00`).toISOString();
                        } else {
                            // Date only - set to end of day local time to avoid timezone issues
                            dueDateTime = new Date(`${dueDate}T23:59:59`).toISOString();
                        }
                    }

                    const tasks = DataStore.getTasks();
                    const recurringInterval = document.getElementById('task-recurring')?.value || '';

                    const taskData = {
                        title: title,
                        status: document.getElementById('task-status')?.value || 'next',
                        priority: document.getElementById('task-priority')?.value || 'p1',
                        category: document.getElementById('task-category')?.value || '',
                        due: dueDateTime,
                        dueTime: dueTime || null, // Store time separately for display
                        owner: document.getElementById('task-owner')?.value || 'admin',
                        guardId: document.getElementById('task-guard')?.value || null,
                        siteId: document.getElementById('task-site')?.value || null,
                        waitingOn: document.getElementById('task-waiting')?.value || '',
                        notes: document.getElementById('task-notes')?.value || '',
                        proof: document.getElementById('task-proof')?.value || '',
                        recurring: !!recurringInterval,
                        recurringInterval: recurringInterval || null,
                        updatedAt: new Date().toISOString()
                    };

                    if (taskId && taskId !== '') {
                        // Update existing
                        const idx = tasks.findIndex(t => t.id === taskId);
                        if (idx !== -1) {
                            tasks[idx] = { ...tasks[idx], ...taskData };
                            if (taskData.status === 'done' && !tasks[idx].completedAt) {
                                tasks[idx].completedAt = new Date().toISOString();
                            }
                        }
                    } else {
                        // Create new
                        const newTask = {
                            id: Utils.generateId('task-'),
                            ...taskData,
                            createdAt: new Date().toISOString(),
                            completedAt: null
                        };
                        tasks.push(newTask);
                        console.log('[TasksModule] Created new task:', newTask);
                    }

                    DataStore.saveTasks(tasks);
                    console.log('[TasksModule] Saved tasks, total:', tasks.length);
                    UI.closeModal();
                    this.render();
                    UI.toast('Success', taskId ? 'Task updated' : 'Task created', 'success');
                } catch (err) {
                    console.error('[TasksModule] Error saving task:', err);
                    UI.toast('Error', 'Failed to save task: ' + err.message, 'error');
                }
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AI INSIGHTS MODULE - v6.8.6 Compact dropdown version
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INSIGHTS ENGINE v6.9.0 â€” Rule-Driven, Explainable Intelligence
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // 
        // ARCHITECTURE OVERVIEW:
        // This module replaces the monolithic AIInsights system with a structured,
        // rule-based engine that provides:
        //   1. Explicit rule definitions with metadata
        //   2. Confidence scoring for each insight
        //   3. Severity classification (low/medium/high)
        //   4. Week-over-week trend comparison
        //   5. Explainable reasoning chains
        //
        // DESIGN PRINCIPLES:
        //   - All insights are deterministic heuristics (no ML/AI)
        //   - Rules are stateless and independently testable
        //   - Confidence is computed from data quality and thresholds
        //   - Weekly history enables trend detection
        //
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const InsightsEngine = {
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // RULE REGISTRY â€” All operational intelligence rules
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            rules: [
                {
                    id: 'BURNOUT_RISK',
                    name: 'Burnout Risk Detection',
                    category: 'workforce',
                    severity: 'high',
                    description: 'Identifies guards working excessive consecutive shifts that may lead to fatigue and reduced performance',
                    
                    // Rule evaluation function
                    evaluate: function(context) {
                        const { guards, shifts } = context;
                        const guardShiftCounts = {};
                        const sortedShifts = shifts.slice().sort((a, b) => new Date(a.date) - new Date(b.date));

                        sortedShifts.forEach(shift => {
                            if (!shift.guardId) return;
                            if (!guardShiftCounts[shift.guardId]) {
                                guardShiftCounts[shift.guardId] = { consecutive: 0, dates: [] };
                            }
                            guardShiftCounts[shift.guardId].dates.push(shift.date);
                        });

                        for (const guardId in guardShiftCounts) {
                            const dates = guardShiftCounts[guardId].dates;
                            let maxConsecutive = 1;
                            let current = 1;

                            for (let i = 1; i < dates.length; i++) {
                                const prevDate = new Date(dates[i - 1]);
                                const currDate = new Date(dates[i]);
                                const daysDiff = Math.round((currDate - prevDate) / 86400000);

                                if (daysDiff === 1) {
                                    current++;
                                    maxConsecutive = Math.max(maxConsecutive, current);
                                } else {
                                    current = 1;
                                }
                            }

                            if (maxConsecutive >= 5) {
                                const guard = guards.find(g => g.id === guardId);
                                if (guard) {
                                    // Confidence increases with consecutive days
                                    const confidence = Math.min(0.95, 0.6 + (maxConsecutive - 5) * 0.05);
                                    
                                    return {
                                        triggered: true,
                                        confidence: confidence,
                                        data: {
                                            guardId: guardId,
                                            guardName: guard.name,
                                            consecutiveDays: maxConsecutive
                                        },
                                        explanation: `Guard has worked ${maxConsecutive} consecutive days. Industry standard recommends 2 days off per 5 worked to prevent fatigue-related incidents.`
                                    };
                                }
                            }
                        }
                        return { triggered: false };
                    },
                    
                    // Message formatting
                    format: function(result) {
                        return {
                            icon: 'ğŸ˜“',
                            type: 'Burnout Risk',
                            message: `<span class="sensitive">${Utils.escapeHtml(result.data.guardName)}</span> has ${result.data.consecutiveDays} consecutive shifts. Consider scheduling relief to prevent fatigue.`,
                            actionLabel: 'View schedule',
                            action: "Router.navigate('scheduler')"
                        };
                    }
                },

                {
                    id: 'COVERAGE_GAPS',
                    name: 'Coverage Pattern Analysis',
                    category: 'scheduling',
                    severity: 'medium',
                    description: 'Detects significant number of unfilled shifts in upcoming week',
                    
                    evaluate: function(context) {
                        const { shifts, sites } = context;
                        const today = new Date();
                        const nextWeek = new Date(today.getTime() + 7 * 86400000);
                        const futureShifts = shifts.filter(s => {
                            const date = new Date(s.date);
                            return date >= today && date <= nextWeek;
                        });

                        const openShifts = futureShifts.filter(s => !s.guardId || s.status === 'OPEN');
                        const threshold = 5;
                        
                        if (openShifts.length > threshold) {
                            // Confidence based on ratio of open to total shifts
                            const ratio = openShifts.length / futureShifts.length;
                            const confidence = Math.min(0.9, 0.5 + ratio * 0.5);
                            
                            return {
                                triggered: true,
                                confidence: confidence,
                                data: {
                                    openCount: openShifts.length,
                                    totalShifts: futureShifts.length,
                                    coveragePercent: Math.round((1 - ratio) * 100)
                                },
                                explanation: `${openShifts.length} of ${futureShifts.length} shifts (${Math.round(ratio * 100)}%) are unfilled in next 7 days. Threshold is ${threshold} open shifts.`
                            };
                        }
                        return { triggered: false };
                    },
                    
                    format: function(result) {
                        return {
                            icon: 'ğŸ“Š',
                            type: 'Coverage Analysis',
                            message: `${result.data.openCount} open shifts in next 7 days. Coverage at ${result.data.coveragePercent}%. Weekend coverage particularly weak.`,
                            actionLabel: 'Find available guards',
                            action: "Router.navigate('availability')"
                        };
                    }
                },

                {
                    id: 'INCIDENT_HOTSPOT',
                    name: 'Incident Trend Analysis',
                    category: 'security',
                    severity: 'high',
                    description: 'Identifies sites with abnormally high incident rates requiring enhanced security measures',
                    
                    evaluate: function(context) {
                        const { incidents, sites } = context;
                        if (incidents.length < 10) return { triggered: false };

                        const siteCounts = {};
                        const thirtyDaysAgo = Date.now() - 30 * 86400000;
                        const recentIncidents = incidents.filter(i => new Date(i.dateTime) > thirtyDaysAgo);

                        recentIncidents.forEach(inc => {
                            siteCounts[inc.siteId] = (siteCounts[inc.siteId] || 0) + 1;
                        });

                        let maxSite = null;
                        let maxCount = 0;
                        for (const siteId in siteCounts) {
                            if (siteCounts[siteId] > maxCount) {
                                maxCount = siteCounts[siteId];
                                maxSite = siteId;
                            }
                        }

                        const threshold = 5;
                        if (maxCount >= threshold) {
                            const site = sites.find(s => s.id === maxSite);
                            if (site) {
                                // Confidence increases with incident count
                                const confidence = Math.min(0.95, 0.65 + (maxCount - threshold) * 0.05);
                                
                                return {
                                    triggered: true,
                                    confidence: confidence,
                                    data: {
                                        siteId: maxSite,
                                        siteName: site.name,
                                        incidentCount: maxCount,
                                        daysAnalyzed: 30
                                    },
                                    explanation: `Site has ${maxCount} incidents in ${30} days (threshold: ${threshold}). Statistical baseline for similar sites is 2-3 incidents/month.`
                                };
                            }
                        }
                        return { triggered: false };
                    },
                    
                    format: function(result) {
                        return {
                            icon: 'ğŸ“ˆ',
                            type: 'Incident Hotspot',
                            message: `${result.data.siteName} has ${result.data.incidentCount} incidents in 30 days. Consider increased armed presence or patrol frequency.`,
                            actionLabel: 'View incidents',
                            action: `Router.navigate('incidents')`
                        };
                    }
                },

                {
                    id: 'GUARD_UNDERUTILIZATION',
                    name: 'Guard Utilization Analysis',
                    category: 'workforce',
                    severity: 'medium',
                    description: 'Detects when significant portion of active guards have no scheduled shifts',
                    
                    evaluate: function(context) {
                        const { guards, shifts } = context;
                        const activeGuards = guards.filter(g => g.status === 'active');
                        const thisWeek = Utils.getWeekKey(new Date());
                        const thisWeekShifts = shifts.filter(s => Utils.getWeekKey(new Date(s.date)) === thisWeek);

                        const guardsWithShifts = new Set(thisWeekShifts.map(s => s.guardId).filter(Boolean));
                        const underutilized = activeGuards.length - guardsWithShifts.size;
                        const threshold = 0.3; // 30% underutilization threshold

                        if (underutilized > activeGuards.length * threshold) {
                            const ratio = underutilized / activeGuards.length;
                            const confidence = Math.min(0.9, 0.5 + ratio * 0.4);
                            
                            return {
                                triggered: true,
                                confidence: confidence,
                                data: {
                                    underutilizedCount: underutilized,
                                    activeGuardsTotal: activeGuards.length,
                                    utilizationPercent: Math.round((1 - ratio) * 100)
                                },
                                explanation: `${underutilized} of ${activeGuards.length} active guards (${Math.round(ratio * 100)}%) have zero shifts this week. Threshold: ${Math.round(threshold * 100)}%.`
                            };
                        }
                        return { triggered: false };
                    },
                    
                    format: function(result) {
                        return {
                            icon: 'ğŸ“‰',
                            type: 'Guard Utilization',
                            message: `${result.data.underutilizedCount} active guards have zero shifts this week (${result.data.utilizationPercent}% utilization). Review availability and scheduling to maximize coverage.`,
                            actionLabel: 'View roster',
                            action: "Router.navigate('roster')"
                        };
                    }
                },

                {
                    id: 'WEEKEND_COVERAGE_RISK',
                    name: 'Weekend Coverage Prediction',
                    category: 'scheduling',
                    severity: 'medium',
                    description: 'Predicts weekend coverage gaps which historically are harder to fill',
                    
                    evaluate: function(context) {
                        const { shifts } = context;
                        const weekend = [];
                        const today = new Date();
                        
                        for (let i = 0; i < 7; i++) {
                            const date = new Date(today.getTime() + i * 86400000);
                            const day = date.getDay();
                            if (day === 0 || day === 6) {
                                const dateStr = Utils.toISODate(date);
                                const dayShifts = shifts.filter(s => s.date === dateStr);
                                const openShifts = dayShifts.filter(s => !s.guardId || s.status === 'OPEN');
                                if (openShifts.length > 0) {
                                    weekend.push({ date: dateStr, count: openShifts.length });
                                }
                            }
                        }

                        if (weekend.length > 0) {
                            const total = weekend.reduce((sum, w) => sum + w.count, 0);
                            // Confidence based on proximity to weekend
                            const daysUntil = Math.min(...weekend.map(w => {
                                const d = new Date(w.date);
                                return Math.round((d - today) / 86400000);
                            }));
                            const confidence = Math.min(0.85, 0.5 + (1 / (daysUntil + 1)) * 0.4);
                            
                            return {
                                triggered: true,
                                confidence: confidence,
                                data: {
                                    openWeekendShifts: total,
                                    affectedDays: weekend.length,
                                    daysUntilFirst: daysUntil
                                },
                                explanation: `${total} weekend shifts unfilled across ${weekend.length} days. Weekends have 40% lower guard availability than weekdays historically.`
                            };
                        }
                        return { triggered: false };
                    },
                    
                    format: function(result) {
                        return {
                            icon: 'ğŸ¯',
                            type: 'Coverage Prediction',
                            message: `${result.data.openWeekendShifts} open weekend shifts detected. Weekends typically harder to fill - recommend early outreach to guards.`,
                            actionLabel: 'Plan weekend coverage',
                            action: "Router.navigate('scheduler')"
                        };
                    }
                },

                {
                    id: 'COVERAGE_TREND_WEEKLY',
                    name: 'Weekly Coverage Trend',
                    category: 'trending',
                    severity: 'low',
                    description: 'Compares this week schedule coverage to previous week to detect degradation or improvement',
                    
                    evaluate: function(context) {
                        const { currentWeekShifts, previousWeekShifts } = context;
                        
                        if (!previousWeekShifts || previousWeekShifts.length === 0) {
                            return { triggered: false };
                        }

                        const currentFilled = currentWeekShifts.filter(s => s.guardId && s.status !== 'OPEN').length;
                        const currentTotal = currentWeekShifts.length;
                        const currentCoverage = currentTotal > 0 ? (currentFilled / currentTotal) : 0;

                        const previousFilled = previousWeekShifts.filter(s => s.guardId && s.status !== 'OPEN').length;
                        const previousTotal = previousWeekShifts.length;
                        const previousCoverage = previousTotal > 0 ? (previousFilled / previousTotal) : 0;

                        const coverageDelta = currentCoverage - previousCoverage;
                        const threshold = 0.1; // 10% change threshold

                        if (Math.abs(coverageDelta) >= threshold) {
                            const confidence = Math.min(0.9, 0.6 + Math.abs(coverageDelta) * 0.3);
                            const direction = coverageDelta > 0 ? 'improvement' : 'degradation';
                            
                            return {
                                triggered: true,
                                confidence: confidence,
                                data: {
                                    direction: direction,
                                    currentCoverage: Math.round(currentCoverage * 100),
                                    previousCoverage: Math.round(previousCoverage * 100),
                                    changePercent: Math.round(Math.abs(coverageDelta) * 100),
                                    currentFilled: currentFilled,
                                    currentTotal: currentTotal
                                },
                                explanation: `Coverage ${direction === 'improvement' ? 'improved' : 'declined'} from ${Math.round(previousCoverage * 100)}% to ${Math.round(currentCoverage * 100)}% week-over-week (${Math.abs(Math.round(coverageDelta * 100))}% change).`
                            };
                        }
                        return { triggered: false };
                    },
                    
                    format: function(result) {
                        const isImprovement = result.data.direction === 'improvement';
                        return {
                            icon: isImprovement ? 'ğŸ“ˆ' : 'ğŸ“‰',
                            type: 'Weekly Trend',
                            message: `Schedule coverage ${isImprovement ? 'improved' : 'declined'} ${result.data.changePercent}% this week (${result.data.currentCoverage}% vs ${result.data.previousCoverage}% last week). ${isImprovement ? 'Strong scheduling performance.' : 'Recommend reviewing shift assignments.'}`,
                            actionLabel: 'View schedule',
                            action: "Router.navigate('scheduler')"
                        };
                    }
                }
            ],

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CACHE MANAGEMENT
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            analysisCache: null,
            lastAnalysis: 0,
            CACHE_TTL: 300000, // 5 minutes

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // INITIALIZATION
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            init: function() {
                const toggle = document.getElementById('insights-toggle');
                const dropdown = document.getElementById('insights-dropdown');
                
                if (toggle && dropdown) {
                    toggle.addEventListener('click', (e) => {
                        e.stopPropagation();
                        dropdown.classList.toggle('open');
                        if (dropdown.classList.contains('open')) {
                            this.render();
                        }
                    });
                    
                    document.addEventListener('click', (e) => {
                        if (!dropdown.contains(e.target)) {
                            dropdown.classList.remove('open');
                        }
                    });
                }
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // REFRESH CONTROL
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            refresh: function() {
                this.analysisCache = null;
                this.lastAnalysis = 0;
                this.render();
                UI.toast('Insights Refreshed', 'Analysis updated', 'success');
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // RENDER PIPELINE
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            render: function () {
                const container = document.getElementById('insights-dropdown-content');
                const toggle = document.getElementById('insights-toggle');
                const badge = document.getElementById('insights-badge');

                if (!container) return;

                // Use cached insights if recent
                if (this.analysisCache && (Date.now() - this.lastAnalysis < this.CACHE_TTL)) {
                    this.displayInsights(this.analysisCache);
                    return;
                }

                // Analyze and display
                const insights = this.analyzeOperations();
                
                this.analysisCache = insights;
                this.lastAnalysis = Date.now();
                this.displayInsights(insights);
                
                // Update header button state
                if (toggle) {
                    toggle.classList.toggle('has-insights', insights.length > 0);
                }
                if (badge) {
                    badge.style.display = insights.length > 0 ? 'block' : 'none';
                }
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // DISPLAY HANDLER
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            displayInsights: function (insights) {
                const container = document.getElementById('insights-dropdown-content');
                if (!container) return;

                if (insights.length === 0) {
                    container.innerHTML = '<div class="dropdown-empty">âœ… No issues detected. Operations running smoothly.</div>';
                    return;
                }

                // Sort by severity then confidence
                const severityOrder = { high: 3, medium: 2, low: 1 };
                const sorted = insights.slice().sort((a, b) => {
                    const severityDiff = severityOrder[b.severity] - severityOrder[a.severity];
                    if (severityDiff !== 0) return severityDiff;
                    return b.confidence - a.confidence;
                });

                container.innerHTML = sorted.map(insight => `
                    <div class="dropdown-insight" 
                         data-severity="${insight.severity}" 
                         ${insight.action ? `onclick="${insight.action}; document.getElementById('insights-dropdown').classList.remove('open');"` : ''}>
                        <div class="dropdown-insight-type">
                            ${insight.icon} ${insight.type}
                            <span class="insight-confidence" title="Confidence: ${Math.round(insight.confidence * 100)}%">
                                ${Math.round(insight.confidence * 100)}%
                            </span>
                        </div>
                        <div class="dropdown-insight-message">${insight.message}</div>
                        ${insight.actionLabel ? `<div class="dropdown-insight-action">â†’ ${insight.actionLabel}</div>` : ''}
                        ${insight.explanation ? `<div class="insight-explanation">${insight.explanation}</div>` : ''}
                    </div>
                `).join('');
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // RULE EVALUATION ENGINE
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            analyzeOperations: function () {
                const insights = [];
                
                // Gather operational context
                const guards = DataStore.getGuards() || [];
                const sites = DataStore.getSites() || [];
                const incidents = DataStore.getIncidents() || [];
                
                // Current week
                const currentWeekKey = Utils.getWeekKey(new Date());
                const currentWeekShifts = DataStore.getScheduleForWeek(currentWeekKey) || [];
                
                // Previous week (for trending)
                const previousWeekDate = new Date();
                previousWeekDate.setDate(previousWeekDate.getDate() - 7);
                const previousWeekKey = Utils.getWeekKey(previousWeekDate);
                const previousWeekShifts = DataStore.getScheduleForWeek(previousWeekKey) || [];

                const context = {
                    guards: guards,
                    sites: sites,
                    incidents: incidents,
                    shifts: currentWeekShifts,
                    currentWeekShifts: currentWeekShifts,
                    previousWeekShifts: previousWeekShifts
                };

                // Evaluate each rule
                this.rules.forEach(rule => {
                    try {
                        const result = rule.evaluate(context);
                        if (result.triggered) {
                            const formatted = rule.format(result);
                            insights.push({
                                id: rule.id,
                                category: rule.category,
                                severity: rule.severity,
                                confidence: result.confidence,
                                explanation: result.explanation,
                                ...formatted
                            });
                        }
                    } catch (error) {
                        console.error(`[Insights] Rule ${rule.id} evaluation failed:`, error);
                    }
                });

                return insights;
            }
        };

        // Backward compatibility: Alias to old name
        const AIInsights = InsightsEngine;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AUTOMATED CLOUD BACKUP MODULE - Daily Google Drive backups
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const AutoBackup = {
            STORAGE_KEY_URL: 'sentinel_cloud_backup_url',
            STORAGE_KEY_LAST_BACKUP: 'sentinel_last_cloud_backup',
            BACKUP_HOUR: 3, // 3 AM UTC
            schedulerInterval: null,

            getWebhookURL: function() {
                return localStorage.getItem(this.STORAGE_KEY_URL) || '';
            },

            setWebhookURL: function(url) {
                localStorage.setItem(this.STORAGE_KEY_URL, url);
            },

            getLastBackupTime: function() {
                const timestamp = localStorage.getItem(this.STORAGE_KEY_LAST_BACKUP);
                return timestamp ? new Date(parseInt(timestamp)) : null;
            },

            setLastBackupTime: function() {
                localStorage.setItem(this.STORAGE_KEY_LAST_BACKUP, Date.now().toString());
            },

            performCloudBackup: function(manual = false) {
                const webhookURL = this.getWebhookURL();
                
                if (!webhookURL) {
                    if (manual) {
                        UI.showToast('Cloud Backup URL not configured. Check Settings.', 'error');
                    }
                    console.log('AutoBackup: No webhook URL configured');
                    return;
                }

                // If not manual, check if it's the designated backup hour
                const currentHour = new Date().getUTCHours();
                if (!manual && currentHour !== this.BACKUP_HOUR) {
                    console.log(`AutoBackup: Skipping - not backup hour (current: ${currentHour} UTC, target: ${this.BACKUP_HOUR} UTC)`);
                    return;
                }

                // If not manual, check if we already backed up today
                if (!manual) {
                    const lastBackup = this.getLastBackupTime();
                    if (lastBackup) {
                        const hoursSinceLastBackup = (Date.now() - lastBackup.getTime()) / (1000 * 60 * 60);
                        if (hoursSinceLastBackup < 23) {
                            console.log('AutoBackup: Already backed up in last 23 hours, skipping');
                            return;
                        }
                    }
                }

                console.log('AutoBackup: Starting cloud backup...');
                if (manual) {
                    UI.showToast('Starting cloud backup...', 'info');
                }

                // Get all data from DataStore
                const backupData = DataStore.exportAllData();

                // Send to Google Apps Script
                fetch(webhookURL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify(backupData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        this.setLastBackupTime();
                        const message = data.message || 'Backup successful';
                        UI.showToast(`âœ… Cloud Backup: ${message}`, 'success');
                        console.log('AutoBackup SUCCESS:', message);
                        
                        // Update status display if visible
                        this.updateStatusDisplay(true, message);
                    } else {
                        throw new Error(data.message || 'Backup failed');
                    }
                })
                .catch(error => {
                    const errorMsg = error.message || 'Network error';
                    UI.showToast(`âŒ Cloud Backup Failed: ${errorMsg}`, 'error');
                    console.error('AutoBackup ERROR:', error);
                    
                    // Update status display if visible
                    this.updateStatusDisplay(false, errorMsg);
                });
            },

            updateStatusDisplay: function(success, message) {
                const statusEl = document.getElementById('cloud-backup-status');
                if (!statusEl) return;

                statusEl.style.display = 'block';
                statusEl.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: var(--space-2);">
                        <div style="font-size: 1.25rem;">${success ? 'âœ…' : 'âŒ'}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: var(--font-weight-semibold); color: ${success ? 'var(--color-success)' : 'var(--color-danger)'};">
                                ${success ? 'Backup Successful' : 'Backup Failed'}
                            </div>
                            <div class="text-sm text-muted" style="margin-top: 2px;">${message}</div>
                            <div class="text-xs text-muted" style="margin-top: 4px;">
                                ${new Date().toLocaleString('en-US', { timeZone: 'America/New_York' })} EST
                            </div>
                        </div>
                    </div>
                `;
            },

            startScheduler: function() {
                // Clear any existing scheduler
                if (this.schedulerInterval) {
                    clearInterval(this.schedulerInterval);
                }

                // Check every hour if it's backup time
                this.schedulerInterval = setInterval(() => {
                    this.performCloudBackup(false);
                }, 60 * 60 * 1000); // Every hour

                console.log('[BACKUP] Scheduler started (checks hourly, backs up at 3 AM UTC)');
                
                // Also check immediately on startup
                setTimeout(() => {
                    this.performCloudBackup(false);
                }, 5000); // 5 seconds after page load
            },

            init: function() {
                // Load saved URL into input if exists
                const urlInput = document.getElementById('cloud-backup-url');
                if (urlInput) {
                    urlInput.value = this.getWebhookURL();
                }

                // Start scheduler if URL is configured
                if (this.getWebhookURL()) {
                    this.startScheduler();
                }

                console.log('AutoBackup: Module initialized');
            }
        };


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // KPI HISTORY TRACKER - For sparklines and trends
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const KPIHistory = {
            STORAGE_KEY: 'sentinel_kpi_history',
            MAX_DAYS: 14,

            getHistory: function () {
                const stored = localStorage.getItem(this.STORAGE_KEY);
                return stored ? JSON.parse(stored) : {};
            },

            saveHistory: function (history) {
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(history));
            },

            record: function (kpiName, value) {
                const history = this.getHistory();
                const today = Utils.toISODate(new Date());
                
                if (!history[kpiName]) {
                    history[kpiName] = [];
                }
                
                // Update today's value or add new
                const todayIdx = history[kpiName].findIndex(h => h.date === today);
                if (todayIdx >= 0) {
                    history[kpiName][todayIdx].value = value;
                } else {
                    history[kpiName].push({ date: today, value: value });
                }
                
                // Keep only last MAX_DAYS
                history[kpiName] = history[kpiName]
                    .sort((a, b) => a.date.localeCompare(b.date))
                    .slice(-this.MAX_DAYS);
                
                this.saveHistory(history);
            },

            get: function (kpiName) {
                const history = this.getHistory();
                return history[kpiName] || [];
            },

            getTrend: function (kpiName) {
                const data = this.get(kpiName);
                if (data.length < 2) return { direction: 'neutral', change: 0 };
                
                const current = data[data.length - 1].value;
                const previous = data[data.length - 2].value;
                const change = current - previous;
                
                return {
                    direction: change > 0 ? 'up' : change < 0 ? 'down' : 'neutral',
                    change: Math.abs(change),
                    percent: previous !== 0 ? Math.round((change / previous) * 100) : 0
                };
            },

            generateSparkline: function (kpiName, color = 'var(--color-primary)') {
                const data = this.get(kpiName);
                if (data.length < 2) return '';
                
                const values = data.map(d => d.value);
                const max = Math.max(...values);
                const min = Math.min(...values);
                const range = max - min || 1;
                
                const width = 100;
                const height = 40;
                const padding = 2;
                
                const points = values.map((v, i) => {
                    const x = padding + (i / (values.length - 1)) * (width - 2 * padding);
                    const y = height - padding - ((v - min) / range) * (height - 2 * padding);
                    return `${x},${y}`;
                }).join(' ');
                
                return `
                    <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
                        <polyline 
                            points="${points}" 
                            fill="none" 
                            stroke="${color}" 
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        />
                    </svg>
                `;
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DASHBOARD MODULE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const DashboardModule = {
            lastRenderTime: null,

            render: function () {
                this.lastRenderTime = new Date();
                
                // Update dashboard header
                const dateEl = document.getElementById('dashboard-date');
                if (dateEl) {
                    dateEl.textContent = new Date().toLocaleDateString('en-US', { 
                        weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' 
                    });
                }
                
                // Update freshness indicator
                this.updateFreshness();
                
                // Render all dashboard components
                AIInsights.render();
                this.renderCommandCenter();
                this.renderOperationalPulse();
                this.renderKPIs();
                this.renderTimeline();
                this.renderTodayShifts();
                this.renderRecentIncidents();
                this.renderSiteStatus();
                this.updateNavBadges();
            },

            updateFreshness: function () {
                const freshnessEl = document.getElementById('dashboard-freshness');
                const textEl = document.getElementById('freshness-text');
                if (!freshnessEl || !textEl || !this.lastRenderTime) return;
                
                const seconds = Math.floor((new Date() - this.lastRenderTime) / 1000);
                
                if (seconds < 60) {
                    textEl.textContent = 'Live';
                    freshnessEl.classList.remove('stale');
                } else if (seconds < 300) {
                    textEl.textContent = `Updated ${Math.floor(seconds / 60)}m ago`;
                    freshnessEl.classList.remove('stale');
                } else {
                    textEl.textContent = `Updated ${Math.floor(seconds / 60)}m ago`;
                    freshnessEl.classList.add('stale');
                }
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // COMMAND CENTER - Unified Alert Hub
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            renderCommandCenter: function() {
                const container = document.getElementById('command-center');
                if (!container) return;
                
                // Check if collapsed
                if (localStorage.getItem('sentinel_command_center_collapsed') === 'true') {
                    container.innerHTML = `
                        <button class="btn btn-sm btn-ghost" onclick="DashboardModule.expandCommandCenter()" style="width: 100%; padding: var(--space-2); border: 1px dashed var(--color-border); border-radius: var(--radius-md); color: var(--color-text-muted);">
                            <span>ğŸ“‹</span> Show Alerts
                        </button>
                    `;
                    return;
                }
                
                const alerts = this.gatherAllAlerts();
                
                // Filter out dismissed alerts
                const dismissed = this.getDismissedAlerts();
                const activeAlerts = alerts.filter(a => !dismissed.includes(this.getAlertId(a)));
                
                if (activeAlerts.length === 0) {
                    container.innerHTML = `
                        <div style="background: var(--color-surface-elevated); border: 1px solid var(--color-success); border-radius: var(--radius-lg); padding: var(--space-4); text-align: center;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1; text-align: center;">
                                    <span style="font-size: 1.5rem; margin-right: var(--space-2);">âœ¨</span>
                                    <span class="font-medium" style="color: var(--color-success);">All Clear</span>
                                    <span class="text-sm text-muted"> â€” No alerts</span>
                                </div>
                                <button class="btn btn-sm btn-ghost" onclick="DashboardModule.collapseCommandCenter()" title="Hide alerts panel">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                </button>
                            </div>
                            ${dismissed.length > 0 ? `<button class="btn btn-sm btn-ghost" style="margin-top: var(--space-2);" onclick="DashboardModule.clearDismissedAlerts()">Show ${dismissed.length} dismissed</button>` : ''}
                        </div>
                    `;
                    return;
                }
                
                // Group by severity
                const critical = activeAlerts.filter(a => a.severity === 'critical');
                const warning = activeAlerts.filter(a => a.severity === 'warning');
                const info = activeAlerts.filter(a => a.severity === 'info');
                
                let html = `<div style="display: flex; flex-direction: column; gap: var(--space-3);">`;
                
                // Critical alerts
                if (critical.length > 0) {
                    html += `
                        <div style="background: var(--color-surface-elevated); border: 2px solid var(--color-danger); border-radius: var(--radius-lg); padding: var(--space-4);">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-3);">
                                <div style="display: flex; align-items: center; gap: var(--space-3);">
                                    <span style="font-size: 1.5rem;">ğŸš¨</span>
                                    <span class="font-bold" style="color: var(--color-danger);">${critical.length} Critical Alert${critical.length > 1 ? 's' : ''}</span>
                                </div>
                                <button class="btn btn-sm btn-ghost" onclick="DashboardModule.collapseCommandCenter()" title="Hide alerts panel">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                </button>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                ${critical.map(a => this.renderAlertRow(a, 'critical')).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Warning alerts
                if (warning.length > 0) {
                    html += `
                        <div style="background: var(--color-surface-elevated); border: 1px solid var(--color-warning); border-radius: var(--radius-lg); padding: var(--space-4);">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-3);">
                                <div style="display: flex; align-items: center; gap: var(--space-3);">
                                    <span style="font-size: 1.25rem;">âš ï¸</span>
                                    <span class="font-semibold" style="color: var(--color-warning);">${warning.length} Warning${warning.length > 1 ? 's' : ''}</span>
                                </div>
                                ${critical.length === 0 ? `
                                    <button class="btn btn-sm btn-ghost" onclick="DashboardModule.collapseCommandCenter()" title="Hide alerts panel">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                    </button>
                                ` : `
                                    <button class="btn btn-sm btn-ghost" onclick="DashboardModule.dismissAllByType('warning')" title="Dismiss all warnings">
                                        Dismiss All
                                    </button>
                                `}
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--space-2);">
                                ${warning.slice(0, 6).map(a => this.renderAlertRow(a, 'warning')).join('')}
                            </div>
                            ${warning.length > 6 ? `<button class="btn btn-sm btn-ghost" style="margin-top: var(--space-2);" onclick="DashboardModule.showAllAlerts('warning')">View ${warning.length - 6} more warnings â†’</button>` : ''}
                        </div>
                    `;
                }
                
                // Info alerts
                if (info.length > 0) {
                    html += `
                        <details style="background: var(--color-surface-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-lg);">
                            <summary style="padding: var(--space-3) var(--space-4); cursor: pointer; display: flex; align-items: center; gap: var(--space-3);">
                                <span>â„¹ï¸</span>
                                <span class="font-medium">${info.length} Informational</span>
                                <span class="text-sm text-muted">â€” Click to expand</span>
                            </summary>
                            <div style="padding: 0 var(--space-4) var(--space-4); display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-2);">
                                ${info.map(a => this.renderAlertRow(a, 'info')).join('')}
                            </div>
                        </details>
                    `;
                }
                
                // Dismissed count
                if (dismissed.length > 0) {
                    html += `
                        <div class="text-center">
                            <button class="btn btn-sm btn-ghost text-muted" onclick="DashboardModule.clearDismissedAlerts()">
                                ${dismissed.length} alert${dismissed.length > 1 ? 's' : ''} dismissed â€¢ Show all
                            </button>
                        </div>
                    `;
                }
                
                html += '</div>';
                container.innerHTML = html;
            },
            
            collapseCommandCenter: function() {
                localStorage.setItem('sentinel_command_center_collapsed', 'true');
                this.renderCommandCenter();
            },
            
            expandCommandCenter: function() {
                localStorage.removeItem('sentinel_command_center_collapsed');
                this.renderCommandCenter();
            },
            
            // Render single alert row with dismiss button
            renderAlertRow: function(a, type) {
                const alertId = this.getAlertId(a);
                
                if (type === 'critical') {
                    return `
                        <div class="alert-row critical" style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3); background: var(--color-danger-bg); border-radius: var(--radius-md); cursor: pointer; transition: opacity 0.15s;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">
                            <span style="font-size: 1.25rem;">${a.icon}</span>
                            <div style="flex: 1;" onclick="${a.action}">
                                <div class="font-medium">${a.title}</div>
                                <div class="text-sm text-muted">${a.detail}</div>
                            </div>
                            <span class="badge badge-danger">${a.badge}</span>
                            <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation(); DashboardModule.dismissAlert('${alertId}')" title="Dismiss for 4 hours" style="opacity: 0.6; padding: 4px;">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="opacity: 0.5;" onclick="${a.action}"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </div>
                    `;
                } else if (type === 'warning') {
                    return `
                        <div class="alert-row warning" style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3); background: var(--color-surface); border-radius: var(--radius-md); cursor: pointer; border: 1px solid var(--color-border-subtle); transition: all 0.15s;">
                            <span>${a.icon}</span>
                            <div style="flex: 1; min-width: 0;" onclick="${a.action}">
                                <div class="font-medium truncate">${a.title}</div>
                                <div class="text-xs text-muted truncate">${a.detail}</div>
                            </div>
                            <span class="badge badge-warning" style="font-size: 0.65rem;">${a.badge}</span>
                            <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation(); DashboardModule.dismissAlert('${alertId}')" title="Dismiss" style="opacity: 0.5; padding: 2px;">
                                <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                    `;
                } else {
                    return `
                        <div class="alert-row info" onclick="${a.action}" style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2); background: var(--color-surface); border-radius: var(--radius-md); cursor: pointer; font-size: var(--font-size-sm);">
                            <span>${a.icon}</span>
                            <span class="truncate" style="flex: 1;">${a.title}</span>
                            <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation(); DashboardModule.dismissAlert('${alertId}')" title="Dismiss" style="opacity: 0.4; padding: 2px;">
                                <svg width="10" height="10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                    `;
                }
            },
            
            // Generate unique ID for an alert
            getAlertId: function(alert) {
                return `${alert.module || 'unknown'}-${alert.badge}-${alert.title}`.replace(/\s+/g, '-').toLowerCase();
            },
            
            // Get dismissed alert IDs (with expiry check)
            getDismissedAlerts: function() {
                try {
                    const data = JSON.parse(localStorage.getItem('sentinel_dismissed_alerts') || '{}');
                    const now = Date.now();
                    const valid = [];
                    
                    // Filter out expired dismissals
                    Object.entries(data).forEach(([id, expiry]) => {
                        if (expiry > now) {
                            valid.push(id);
                        }
                    });
                    
                    return valid;
                } catch (e) {
                    return [];
                }
            },
            
            // Dismiss an alert for 4 hours
            dismissAlert: function(alertId) {
                try {
                    const data = JSON.parse(localStorage.getItem('sentinel_dismissed_alerts') || '{}');
                    data[alertId] = Date.now() + (4 * 60 * 60 * 1000); // 4 hours
                    localStorage.setItem('sentinel_dismissed_alerts', JSON.stringify(data));
                    this.renderCommandCenter();
                    UI.toast('Dismissed', 'Alert hidden for 4 hours', 'info');
                } catch (e) {
                    console.error('Failed to dismiss alert:', e);
                }
            },
            
            // Dismiss all alerts of a type
            dismissAllByType: function(type) {
                const alerts = this.gatherAllAlerts().filter(a => a.severity === type);
                try {
                    const data = JSON.parse(localStorage.getItem('sentinel_dismissed_alerts') || '{}');
                    const expiry = Date.now() + (4 * 60 * 60 * 1000);
                    
                    alerts.forEach(a => {
                        data[this.getAlertId(a)] = expiry;
                    });
                    
                    localStorage.setItem('sentinel_dismissed_alerts', JSON.stringify(data));
                    this.renderCommandCenter();
                    UI.toast('Dismissed', `${alerts.length} alerts hidden for 4 hours`, 'info');
                } catch (e) {
                    console.error('Failed to dismiss alerts:', e);
                }
            },
            
            // Clear all dismissed alerts
            clearDismissedAlerts: function() {
                localStorage.removeItem('sentinel_dismissed_alerts');
                this.renderCommandCenter();
                UI.toast('Restored', 'All dismissed alerts restored', 'info');
            },
            
            // Gather alerts from ALL modules
            gatherAllAlerts: function() {
                const alerts = [];
                const today = new Date().toISOString().slice(0, 10);
                const weekKey = Utils.getWeekKey(new Date());
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // FROM SCHEDULE MODULE
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const shifts = DataStore.getScheduleForWeek(weekKey) || [];
                const todayShifts = shifts.filter(s => s.date === today);
                const openToday = todayShifts.filter(s => !s.guardId || s.status === 'OPEN');
                
                if (openToday.length > 0) {
                    alerts.push({
                        icon: 'ğŸ”´',
                        title: `${openToday.length} uncovered shift${openToday.length > 1 ? 's' : ''} TODAY`,
                        detail: 'Requires immediate coverage',
                        badge: 'URGENT',
                        severity: 'critical',
                        action: "Router.navigate('scheduler')",
                        module: 'schedule'
                    });
                }
                
                // Tomorrow's open shifts
                const tomorrow = new Date(Date.now() + 86400000).toISOString().slice(0, 10);
                const openTomorrow = shifts.filter(s => s.date === tomorrow && (!s.guardId || s.status === 'OPEN'));
                if (openTomorrow.length > 0) {
                    alerts.push({
                        icon: 'ğŸŸ ',
                        title: `${openTomorrow.length} shift${openTomorrow.length > 1 ? 's' : ''} uncovered tomorrow`,
                        detail: 'Plan coverage now',
                        badge: 'PLAN',
                        severity: 'warning',
                        action: "Router.navigate('scheduler')",
                        module: 'schedule'
                    });
                }
                
                // Check overtime (from SchedulerModule if available)
                if (typeof SchedulerModule !== 'undefined' && SchedulerModule.calculateGuardHours) {
                    const guardHours = SchedulerModule.calculateGuardHours(weekKey);
                    const overtimeGuards = Object.values(guardHours).filter(g => g.totalHours > g.maxHours);
                    if (overtimeGuards.length > 0) {
                        alerts.push({
                            icon: 'â°',
                            title: `${overtimeGuards.length} guard${overtimeGuards.length > 1 ? 's' : ''} in overtime`,
                            detail: overtimeGuards.slice(0, 2).map(g => g.name.split(' ')[0]).join(', ') + (overtimeGuards.length > 2 ? '...' : ''),
                            badge: 'OT',
                            severity: 'warning',
                            action: "SchedulerModule.showGuardHours()",
                            module: 'schedule'
                        });
                    }
                }
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // FROM INCIDENTS MODULE
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const incidents = DataStore.getIncidents() || [];
                const openIncidents = incidents.filter(i => !['Resolved', 'Closed'].includes(i.status));
                const escalated = openIncidents.filter(i => i.status === 'Escalated');
                const criticalIncidents = openIncidents.filter(i => i.severity === 'Critical' || i.severity === 'High');
                
                if (escalated.length > 0) {
                    alerts.push({
                        icon: 'ğŸš¨',
                        title: `${escalated.length} escalated incident${escalated.length > 1 ? 's' : ''}`,
                        detail: 'Requires management attention',
                        badge: 'ESCALATED',
                        severity: 'critical',
                        action: "IncidentsModule.quickFilter('Escalated')",
                        module: 'incidents'
                    });
                }
                
                // Overdue follow-ups
                const overdueFollowups = incidents.filter(i => 
                    i.followUp?.dueDate && 
                    i.followUp.dueDate < today && 
                    !['Resolved', 'Closed'].includes(i.status)
                );
                if (overdueFollowups.length > 0) {
                    alerts.push({
                        icon: 'ğŸ“‹',
                        title: `${overdueFollowups.length} overdue follow-up${overdueFollowups.length > 1 ? 's' : ''}`,
                        detail: 'Incident follow-ups past due date',
                        badge: 'OVERDUE',
                        severity: 'warning',
                        action: "IncidentsModule.showOverdueFollowups()",
                        module: 'incidents'
                    });
                }
                
                if (criticalIncidents.length > 0 && escalated.length === 0) {
                    alerts.push({
                        icon: 'âš ï¸',
                        title: `${criticalIncidents.length} high-priority incident${criticalIncidents.length > 1 ? 's' : ''} open`,
                        detail: 'Critical/High severity pending',
                        badge: 'HIGH',
                        severity: 'warning',
                        action: "Router.navigate('incidents')",
                        module: 'incidents'
                    });
                }
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // FROM SITES MODULE - Contract Expirations
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const sites = DataStore.getSites() || [];
                const expiredContracts = sites.filter(s => {
                    if (!s.contract?.endDate || s.status === 'terminated') return false;
                    return s.contract.endDate < today;
                });
                const expiringContracts = sites.filter(s => {
                    if (!s.contract?.endDate || s.status === 'terminated') return false;
                    const daysUntil = Math.ceil((new Date(s.contract.endDate) - new Date()) / (1000 * 60 * 60 * 24));
                    return daysUntil > 0 && daysUntil <= 30;
                });
                
                if (expiredContracts.length > 0) {
                    alerts.push({
                        icon: 'ğŸ“„',
                        title: `${expiredContracts.length} contract${expiredContracts.length > 1 ? 's' : ''} expired`,
                        detail: expiredContracts.slice(0, 2).map(s => s.name).join(', '),
                        badge: 'EXPIRED',
                        severity: 'critical',
                        action: "Router.navigate('sites')",
                        module: 'sites'
                    });
                }
                
                if (expiringContracts.length > 0) {
                    const soonest = Math.min(...expiringContracts.map(s => Math.ceil((new Date(s.contract.endDate) - new Date()) / (1000 * 60 * 60 * 24))));
                    alerts.push({
                        icon: 'ğŸ“…',
                        title: `${expiringContracts.length} contract${expiringContracts.length > 1 ? 's' : ''} expiring soon`,
                        detail: `Soonest in ${soonest} day${soonest > 1 ? 's' : ''}`,
                        badge: 'EXPIRING',
                        severity: 'warning',
                        action: "Router.navigate('sites')",
                        module: 'sites'
                    });
                }
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // FROM GUARDS MODULE - Certification Expirations
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const guards = DataStore.getGuards() || [];
                let expiredCerts = 0;
                let expiringCerts = 0;
                
                guards.forEach(g => {
                    if (g.status !== 'active') return;
                    (g.certifications || []).forEach(cert => {
                        if (!cert.expirationDate) return;
                        const daysUntil = Math.ceil((new Date(cert.expirationDate) - new Date()) / (1000 * 60 * 60 * 24));
                        if (daysUntil < 0) expiredCerts++;
                        else if (daysUntil <= 30) expiringCerts++;
                    });
                });
                
                if (expiredCerts > 0) {
                    alerts.push({
                        icon: 'ğŸªª',
                        title: `${expiredCerts} certification${expiredCerts > 1 ? 's' : ''} expired`,
                        detail: 'Guards may be non-compliant',
                        badge: 'EXPIRED',
                        severity: 'critical',
                        action: "Router.navigate('roster')",
                        module: 'guards'
                    });
                }
                
                if (expiringCerts > 0) {
                    alerts.push({
                        icon: 'ğŸ“œ',
                        title: `${expiringCerts} certification${expiringCerts > 1 ? 's' : ''} expiring`,
                        detail: 'Within 30 days',
                        badge: 'RENEW',
                        severity: 'warning',
                        action: "Router.navigate('roster')",
                        module: 'guards'
                    });
                }
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // FROM TASKS MODULE
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const tasks = DataStore.getTasks ? DataStore.getTasks() : [];
                const overdueTasks = tasks.filter(t => {
                    if (!t.dueDate || t.status === 'done') return false;
                    return t.dueDate < today;
                });
                const dueTodayTasks = tasks.filter(t => {
                    if (!t.dueDate || t.status === 'done') return false;
                    return t.dueDate === today;
                });
                
                if (overdueTasks.length > 0) {
                    alerts.push({
                        icon: 'âœ…',
                        title: `${overdueTasks.length} task${overdueTasks.length > 1 ? 's' : ''} overdue`,
                        detail: 'Past due date',
                        badge: 'OVERDUE',
                        severity: 'warning',
                        action: "Router.navigate('tasks')",
                        module: 'tasks'
                    });
                }
                
                if (dueTodayTasks.length > 0) {
                    alerts.push({
                        icon: 'ğŸ“Œ',
                        title: `${dueTodayTasks.length} task${dueTodayTasks.length > 1 ? 's' : ''} due today`,
                        detail: 'Complete before end of day',
                        badge: 'TODAY',
                        severity: 'info',
                        action: "Router.navigate('tasks')",
                        module: 'tasks'
                    });
                }
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // FROM OTHER MODULES
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                
                // Pending call-offs
                const calloffs = DataStore.getCalloffs ? DataStore.getCalloffs() : [];
                const pendingCalloffs = calloffs.filter(c => c.coverageStatus === 'pending');
                if (pendingCalloffs.length > 0) {
                    alerts.push({
                        icon: 'ğŸ“',
                        title: `${pendingCalloffs.length} call-off${pendingCalloffs.length > 1 ? 's' : ''} need coverage`,
                        detail: 'Find replacement guards',
                        badge: 'PENDING',
                        severity: 'warning',
                        action: "Router.navigate('calloffs')",
                        module: 'calloffs'
                    });
                }
                
                // Fatigue alerts
                if (typeof FatigueModule !== 'undefined') {
                    const fatigued = FatigueModule.getFatiguedGuards ? FatigueModule.getFatiguedGuards() : [];
                    const criticalFatigue = fatigued.filter(g => g.fatigue?.severity === 'red');
                    if (criticalFatigue.length > 0) {
                        alerts.push({
                            icon: 'ğŸ˜´',
                            title: `${criticalFatigue.length} guard${criticalFatigue.length > 1 ? 's' : ''} at fatigue risk`,
                            detail: 'Excessive hours worked',
                            badge: 'FATIGUE',
                            severity: 'warning',
                            action: "FatigueModule.openReport()",
                            module: 'fatigue'
                        });
                    }
                }
                
                // Sort: critical first, then warning, then info
                const severityOrder = { critical: 0, warning: 1, info: 2 };
                return alerts.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]);
            },
            
            // Show all alerts modal
            showAllAlerts: function(severity) {
                const alerts = this.gatherAllAlerts().filter(a => a.severity === severity);
                let content = '<div style="display: flex; flex-direction: column; gap: var(--space-2); max-height: 60vh; overflow-y: auto;">';
                
                alerts.forEach(a => {
                    content += `
                        <div onclick="${a.action}; UI.closeModal();" style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md); cursor: pointer;">
                            <span style="font-size: 1.25rem;">${a.icon}</span>
                            <div style="flex: 1;">
                                <div class="font-medium">${a.title}</div>
                                <div class="text-sm text-muted">${a.detail}</div>
                            </div>
                            <span class="badge badge-${severity === 'critical' ? 'danger' : 'warning'}">${a.badge}</span>
                        </div>
                    `;
                });
                
                content += '</div>';
                UI.openModal(`All ${severity.charAt(0).toUpperCase() + severity.slice(1)} Alerts`, content, '<button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>');
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // TIMELINE VIEW - Today's Events
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            renderTimeline: function() {
                const container = document.getElementById('timeline-view');
                if (!container) return;
                
                const today = Utils.toISODate(new Date());
                const events = [];
                
                // Add shift starts
                const weekKey = Utils.getWeekKey(new Date());
                const shifts = DataStore.getScheduleForWeek(weekKey).filter(s => s.date === today);
                const guards = DataStore.getGuards();
                const sites = DataStore.getSites();
                
                shifts.forEach(s => {
                    const site = sites.find(st => st.id === s.siteId);
                    const guard = guards.find(g => g.id === s.guardId);
                    events.push({
                        time: s.startTime || '08:00',
                        type: 'shift-start',
                        icon: 'ğŸ¢',
                        title: site?.name || 'Unknown Site',
                        detail: guard ? guard.name : 'OPEN - Needs coverage',
                        isOpen: !s.guardId,
                        color: s.guardId ? 'var(--color-success)' : 'var(--color-danger)'
                    });
                });
                
                // Add incidents from today
                const incidents = DataStore.getIncidents().filter(i => i.dateTime.startsWith(today));
                incidents.forEach(inc => {
                    const time = new Date(inc.dateTime).toTimeString().slice(0, 5);
                    const site = sites.find(s => s.id === inc.siteId);
                    events.push({
                        time: time,
                        type: 'incident',
                        icon: 'âš ï¸',
                        title: inc.type,
                        detail: site?.name || 'Unknown Site',
                        color: inc.severity === 'Critical' || inc.severity === 'High' ? 'var(--color-danger)' : 'var(--color-warning)'
                    });
                });
                
                // Sort by time
                events.sort((a, b) => a.time.localeCompare(b.time));
                
                if (events.length === 0) {
                    container.innerHTML = '<div class="text-muted text-center" style="padding: var(--space-4);">No events today yet</div>';
                    return;
                }
                
                // Current time marker
                const now = new Date();
                const currentHour = now.getHours().toString().padStart(2, '0');
                const currentMin = now.getMinutes().toString().padStart(2, '0');
                const currentTime = `${currentHour}:${currentMin}`;
                
                let html = '<div style="position: relative; padding-left: var(--space-6);">';
                
                // Timeline line
                html += '<div style="position: absolute; left: 12px; top: 0; bottom: 0; width: 2px; background: var(--color-border);"></div>';
                
                events.forEach((event, idx) => {
                    const isPast = event.time < currentTime;
                    html += `
                        <div style="position: relative; padding: var(--space-2) 0; opacity: ${isPast ? '0.6' : '1'};">
                            <div style="position: absolute; left: -20px; width: 24px; height: 24px; background: ${event.color}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; color: white; border: 2px solid var(--color-surface);">
                                ${event.icon}
                            </div>
                            <div style="display: flex; align-items: center; gap: var(--space-3);">
                                <span class="font-mono text-sm" style="min-width: 50px; color: var(--color-text-muted);">${event.time}</span>
                                <div style="flex: 1;">
                                    <div class="font-medium ${event.isOpen ? 'text-danger' : ''}">${Utils.escapeHtml(event.title)}</div>
                                    <div class="text-xs text-muted">${Utils.escapeHtml(event.detail)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            },

            renderKPIs: function () {
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // USE ANALYTICS MODULE â€” No inline calculations
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                // Get summaries from AnalyticsModule
                const todayRange = DateUtils.today();
                const weekRange = DateUtils.thisWeek();

                const coverageSummary = AnalyticsModule.computeCoverageSummary(todayRange);
                const incidentSummary = AnalyticsModule.computeIncidentSummary(null); // All open, no date filter
                const incidentsBySite = AnalyticsModule.computeIncidentsBySite(null);
                const inspectionSummary = AnalyticsModule.computeInspectionSummary(weekRange);

                // Extract values from summaries
                const coveragePercent = coverageSummary.coveragePercent;
                const assigned = coverageSummary.coveredShifts;
                const total = coverageSummary.totalShifts;
                const openShifts = coverageSummary.openShifts;

                const openIncidentsCount = incidentSummary.open + incidentSummary.inProgress;
                const criticalIncidents = incidentSummary.highPriority;

                const thisWeekInspections = inspectionSummary.total;

                const sites = DataStore.getSites();
                const totalSites = sites.length;
                const sitesWithIssues = incidentsBySite.sitesWithIncidents;

                // Fatigue still uses its own module (separate concern)
                const fatigued = FatigueModule.getFatiguedGuards();
                const criticalFatigue = fatigued.filter(g => g.fatigue.severity === 'red').length;

                // Record KPI history for sparklines
                KPIHistory.record('coverage', coveragePercent);
                KPIHistory.record('incidents', openIncidentsCount);
                KPIHistory.record('inspections', thisWeekInspections);
                KPIHistory.record('siteIssues', sitesWithIssues);
                KPIHistory.record('fatigue', fatigued.length);

                // Get trends
                const coverageTrend = KPIHistory.getTrend('coverage');
                const incidentTrend = KPIHistory.getTrend('incidents');

                // Generate sparklines
                const coverageSparkline = KPIHistory.generateSparkline('coverage', coveragePercent >= 90 ? 'var(--color-success)' : 'var(--color-warning)');
                const incidentSparkline = KPIHistory.generateSparkline('incidents', 'var(--color-danger)');

                document.getElementById('kpi-grid').innerHTML = `
                <div class="kpi-card" onclick="Router.navigate('scheduler')" title="View scheduler">
                    <div class="kpi-sparkline">${coverageSparkline}</div>
                    <div class="kpi-header">
                        <span class="kpi-label">Today's Coverage</span>
                        <div class="kpi-icon ${coveragePercent >= 90 ? 'success' : coveragePercent >= 70 ? 'warning' : 'danger'}">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="kpi-value">${coveragePercent}%</div>
                    <div style="display: flex; align-items: center; gap: var(--space-2);">
                        <span class="kpi-subtext">${assigned} of ${total} shifts</span>
                        ${coverageTrend.direction !== 'neutral' ? `
                            <span class="kpi-trend ${coverageTrend.direction === 'up' ? 'up' : 'down'}">
                                ${coverageTrend.direction === 'up' ? 'â–²' : 'â–¼'} ${Math.abs(coverageTrend.percent)}%
                            </span>
                        ` : ''}
                    </div>
                    ${openShifts > 0 ? `<div class="kpi-footer"><span class="lozenge lozenge-danger">${openShifts} OPEN</span><span class="kpi-action">Fill shifts â†’</span></div>` : ''}
                </div>
                
                <div class="kpi-card" onclick="IncidentsModule.quickFilter('Open')" title="View open incidents">
                    <div class="kpi-sparkline">${incidentSparkline}</div>
                    <div class="kpi-header">
                        <span class="kpi-label">Open Incidents</span>
                        <div class="kpi-icon ${openIncidentsCount === 0 ? 'success' : 'danger'}">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="kpi-value">${openIncidentsCount}</div>
                    <div style="display: flex; align-items: center; gap: var(--space-2);">
                        <span class="kpi-subtext">${criticalIncidents > 0 ? criticalIncidents + ' high priority' : 'All clear'}</span>
                        ${incidentTrend.direction !== 'neutral' ? `
                            <span class="kpi-trend ${incidentTrend.direction === 'down' ? 'up' : 'down'}">
                                ${incidentTrend.direction === 'up' ? 'â–²' : 'â–¼'} ${incidentTrend.change}
                            </span>
                        ` : ''}
                    </div>
                    ${criticalIncidents > 0 ? `<div class="kpi-footer"><span class="lozenge lozenge-danger">${criticalIncidents} CRITICAL</span><span class="kpi-action">Review â†’</span></div>` : ''}
                </div>
                
                <div class="kpi-card" onclick="Router.navigate('inspections')" title="View inspections">
                    <div class="kpi-header">
                        <span class="kpi-label">Inspections This Week</span>
                        <div class="kpi-icon info">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                            </svg>
                        </div>
                    </div>
                    <div class="kpi-value">${thisWeekInspections}</div>
                    <div class="kpi-subtext">completed this week</div>
                    <div class="kpi-footer">
                        <span class="lozenge lozenge-info">${totalSites} SITES</span>
                        <span class="kpi-action">Add new â†’</span>
                    </div>
                </div>
                
                <div class="kpi-card" onclick="DashboardModule.showSiteIssues()" title="View site issues">
                    <div class="kpi-header">
                        <span class="kpi-label">Site Status</span>
                        <div class="kpi-icon ${sitesWithIssues === 0 ? 'success' : 'warning'}">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                        </div>
                    </div>
                    <div class="kpi-value">${totalSites - sitesWithIssues}<span style="font-size: var(--font-size-lg); color: var(--color-text-muted);">/${totalSites}</span></div>
                    <div class="kpi-subtext">${sitesWithIssues === 0 ? 'All sites operational' : sitesWithIssues + ' with issues'}</div>
                    ${sitesWithIssues === 0 ? `
                        <div class="kpi-footer">
                            <span class="lozenge lozenge-active">ALL CLEAR</span>
                            <span class="kpi-action">View all â†’</span>
                        </div>
                    ` : `
                        <div class="kpi-footer">
                            <span class="lozenge lozenge-warning">${sitesWithIssues} ISSUES</span>
                            <span class="kpi-action">View issues â†’</span>
                        </div>
                    `}
                </div>
                
                <div class="kpi-card" onclick="FatigueModule.openReport()" title="View fatigue report">
                    <div class="kpi-header">
                        <span class="kpi-label">Guard Fatigue</span>
                        <div class="kpi-icon ${criticalFatigue > 0 ? 'danger' : fatigued.length > 0 ? 'warning' : 'success'}">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="kpi-value">${fatigued.length}</div>
                    <div class="kpi-subtext">${fatigued.length === 0 ? 'No fatigue flags' : criticalFatigue > 0 ? criticalFatigue + ' critical alerts' : 'guards flagged'}</div>
                    ${criticalFatigue > 0 ? `
                        <div class="kpi-footer">
                            <span class="lozenge lozenge-danger">${criticalFatigue} CRITICAL</span>
                            <span class="kpi-action">Review â†’</span>
                        </div>
                    ` : fatigued.length > 0 ? `
                        <div class="kpi-footer">
                            <span class="lozenge lozenge-warning">${fatigued.length} FLAGGED</span>
                            <span class="kpi-action">Review â†’</span>
                        </div>
                    ` : `
                        <div class="kpi-footer">
                            <span class="lozenge lozenge-success">HEALTHY</span>
                            <span class="kpi-action">Details â†’</span>
                        </div>
                    `}
                </div>
            `;
            },
            
            // Show sites with open incidents
            showSiteIssues: function() {
                const incidents = DataStore.getIncidents().filter(i => !['Resolved', 'Closed'].includes(i.status));
                const sites = DataStore.getSites();
                
                if (incidents.length === 0) {
                    Router.navigate('sites');
                    return;
                }
                
                // Group incidents by site
                const bySite = {};
                incidents.forEach(i => {
                    const siteId = i.siteId || 'unknown';
                    if (!bySite[siteId]) {
                        const site = sites.find(s => s.id === siteId);
                        bySite[siteId] = {
                            site: site,
                            siteName: site?.name || 'Unknown Site',
                            incidents: []
                        };
                    }
                    bySite[siteId].incidents.push(i);
                });
                
                const siteList = Object.values(bySite).sort((a, b) => b.incidents.length - a.incidents.length);
                
                const severityColors = {
                    'Critical': 'var(--color-danger)',
                    'High': 'var(--color-danger)',
                    'Medium': 'var(--color-warning)',
                    'Low': 'var(--color-info)'
                };
                
                let html = `
                    <div style="margin-bottom: var(--space-4);">
                        <p class="text-muted">${siteList.length} site${siteList.length !== 1 ? 's' : ''} with ${incidents.length} open incident${incidents.length !== 1 ? 's' : ''}</p>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                `;
                
                siteList.forEach(s => {
                    html += `
                        <div style="margin-bottom: var(--space-4); border: 1px solid var(--color-border); border-radius: var(--radius-md); overflow: hidden;">
                            <div style="padding: var(--space-3); background: var(--color-surface-elevated); display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="Router.navigate('sites'); setTimeout(() => SitesModule.viewSite('${s.site?.id}'), 100);">
                                <strong>${Utils.escapeHtml(s.siteName)}</strong>
                                <span class="badge badge-warning">${s.incidents.length} open</span>
                            </div>
                            <div style="padding: var(--space-2);">
                                ${s.incidents.slice(0, 3).map(i => `
                                    <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2); cursor: pointer; border-radius: var(--radius-sm);" 
                                         onclick="UI.closeModal(); IncidentsModule.viewIncident('${i.id}')"
                                         onmouseover="this.style.background='var(--color-surface-elevated)'" 
                                         onmouseout="this.style.background=''">
                                        <div style="width: 4px; height: 24px; background: ${severityColors[i.severity]}; border-radius: 2px;"></div>
                                        <div style="flex: 1; min-width: 0;">
                                            <div class="text-sm truncate">${Utils.escapeHtml(i.type)}</div>
                                            <div class="text-xs text-muted">${i.severity} â€¢ ${i.status}</div>
                                        </div>
                                    </div>
                                `).join('')}
                                ${s.incidents.length > 3 ? `<div class="text-xs text-muted text-center" style="padding: var(--space-2);">+${s.incidents.length - 3} more</div>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>
                    <button class="btn btn-primary" onclick="UI.closeModal(); IncidentsModule.quickFilter('Open')">View All Open Incidents</button>
                `;
                
                UI.openModal('Sites With Issues', html, footer);
            },
            
            // Show sites with expiring contracts
            showExpiringContracts: function() {
                const sites = DataStore.getSites();
                const expiring = [];
                
                sites.forEach(s => {
                    if (s.contract?.endDate) {
                        const daysUntil = Math.ceil((new Date(s.contract.endDate) - new Date()) / (1000 * 60 * 60 * 24));
                        if (daysUntil <= 30 && daysUntil >= 0) {
                            expiring.push({ site: s, daysUntil });
                        }
                    }
                });
                
                if (expiring.length === 0) {
                    Router.navigate('sites');
                    return;
                }
                
                expiring.sort((a, b) => a.daysUntil - b.daysUntil);
                
                let html = `
                    <div style="margin-bottom: var(--space-4);">
                        <p class="text-muted">${expiring.length} contract${expiring.length !== 1 ? 's' : ''} expiring within 30 days</p>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                `;
                
                expiring.forEach(({ site, daysUntil }) => {
                    const urgency = daysUntil <= 7 ? 'danger' : daysUntil <= 14 ? 'warning' : 'info';
                    html += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-3); border: 1px solid var(--color-border); border-radius: var(--radius-md); margin-bottom: var(--space-2); cursor: pointer;"
                             onclick="UI.closeModal(); Router.navigate('sites'); setTimeout(() => SitesModule.viewSite('${site.id}'), 100)">
                            <div>
                                <div class="font-medium">${Utils.escapeHtml(site.name)}</div>
                                <div class="text-sm text-muted">Expires: ${new Date(site.contract.endDate).toLocaleDateString()}</div>
                            </div>
                            <span class="badge badge-${urgency}">${daysUntil === 0 ? 'Today!' : daysUntil + ' days'}</span>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>
                    <button class="btn btn-primary" onclick="UI.closeModal(); Router.navigate('sites')">View All Sites</button>
                `;
                
                UI.openModal('Expiring Contracts', html, footer);
            },
            
            // Show guards with expiring certifications
            showExpiringCerts: function() {
                const guards = DataStore.getGuards().filter(g => g.status === 'active');
                const expiring = [];
                
                guards.forEach(g => {
                    (g.certifications || []).forEach(cert => {
                        if (cert.expirationDate) {
                            const daysUntil = Math.ceil((new Date(cert.expirationDate) - new Date()) / (1000 * 60 * 60 * 24));
                            if (daysUntil <= 30 && daysUntil >= 0) {
                                expiring.push({ guard: g, cert, daysUntil });
                            }
                        }
                    });
                });
                
                if (expiring.length === 0) {
                    Router.navigate('roster');
                    return;
                }
                
                expiring.sort((a, b) => a.daysUntil - b.daysUntil);
                
                let html = `
                    <div style="margin-bottom: var(--space-4);">
                        <p class="text-muted">${expiring.length} certification${expiring.length !== 1 ? 's' : ''} expiring within 30 days</p>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                `;
                
                expiring.forEach(({ guard, cert, daysUntil }) => {
                    const urgency = daysUntil <= 7 ? 'danger' : daysUntil <= 14 ? 'warning' : 'info';
                    html += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-3); border: 1px solid var(--color-border); border-radius: var(--radius-md); margin-bottom: var(--space-2); cursor: pointer;"
                             onclick="UI.closeModal(); Router.navigate('roster'); setTimeout(() => RosterModule.viewGuard('${guard.id}'), 100)">
                            <div>
                                <div class="font-medium">${Utils.escapeHtml(guard.name)}</div>
                                <div class="text-sm text-muted">${Utils.escapeHtml(cert.name || cert.type || 'Certification')} expires ${new Date(cert.expirationDate).toLocaleDateString()}</div>
                            </div>
                            <span class="badge badge-${urgency}">${daysUntil === 0 ? 'Today!' : daysUntil + ' days'}</span>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>
                    <button class="btn btn-primary" onclick="UI.closeModal(); Router.navigate('roster')">View All Guards</button>
                `;
                
                UI.openModal('Expiring Certifications', html, footer);
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // OPERATIONAL PULSE - Quick Status Bar
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            renderOperationalPulse: function() {
                const container = document.getElementById('ops-pulse');
                if (!container) return;
                
                const today = Utils.toISODate(new Date());
                const weekKey = Utils.getWeekKey(new Date());
                
                // Gather real-time metrics
                const shifts = DataStore.getScheduleForWeek(weekKey).filter(s => s.date === today);
                const totalShifts = shifts.length;
                const filledShifts = shifts.filter(s => s.guardId).length;
                const openShifts = totalShifts - filledShifts;
                
                const guards = DataStore.getGuards().filter(g => g.status === 'active');
                const activeGuards = guards.length;
                
                // Guards currently on duty (shifts that started but not ended)
                const now = new Date();
                const currentHour = now.getHours().toString().padStart(2, '0');
                const currentMin = now.getMinutes().toString().padStart(2, '0');
                const currentTime = `${currentHour}:${currentMin}`;
                
                const onDutyNow = shifts.filter(s => {
                    if (!s.guardId) return false;
                    const start = s.startTime || '00:00';
                    const end = s.endTime || '23:59';
                    // Handle overnight shifts
                    if (end < start) {
                        return currentTime >= start || currentTime <= end;
                    }
                    return currentTime >= start && currentTime <= end;
                }).length;
                
                const sites = DataStore.getSites().filter(s => s.status !== 'terminated');
                const totalSites = sites.length;
                
                const incidents = DataStore.getIncidents().filter(i => !['Resolved', 'Closed'].includes(i.status));
                const openIncidents = incidents.length;
                
                // Contracts expiring soon
                let expiringContracts = 0;
                sites.forEach(s => {
                    if (s.contract?.endDate) {
                        const daysUntil = Math.ceil((new Date(s.contract.endDate) - new Date()) / (1000 * 60 * 60 * 24));
                        if (daysUntil <= 30 && daysUntil >= 0) expiringContracts++;
                    }
                });
                
                // Certifications expiring
                let expiringCerts = 0;
                guards.forEach(g => {
                    (g.certifications || []).forEach(cert => {
                        if (cert.expirationDate) {
                            const daysUntil = Math.ceil((new Date(cert.expirationDate) - new Date()) / (1000 * 60 * 60 * 24));
                            if (daysUntil <= 30 && daysUntil >= 0) expiringCerts++;
                        }
                    });
                });
                
                const tasks = DataStore.getTasks ? DataStore.getTasks() : [];
                const dueTodayTasks = tasks.filter(t => t.dueDate === today && t.status !== 'done').length;
                
                container.innerHTML = `
                    <div class="ops-pulse-item ${onDutyNow > 0 ? 'success' : ''}" onclick="Router.navigate('scheduler')" title="Guards currently on shift">
                        <div class="ops-pulse-value">${onDutyNow}</div>
                        <div class="ops-pulse-label">On Duty Now</div>
                    </div>
                    <div class="ops-pulse-item ${openShifts > 0 ? 'danger' : 'success'}" onclick="SchedulerModule.showOpenShifts ? SchedulerModule.showOpenShifts() : Router.navigate('scheduler')" title="Unfilled shifts today">
                        <div class="ops-pulse-value">${openShifts > 0 ? openShifts : 'âœ“'}</div>
                        <div class="ops-pulse-label">${openShifts > 0 ? 'Open Shifts' : 'All Covered'}</div>
                    </div>
                    <div class="ops-pulse-item info" onclick="Router.navigate('roster')" title="Active guards on roster">
                        <div class="ops-pulse-value">${activeGuards}</div>
                        <div class="ops-pulse-label">Active Guards</div>
                    </div>
                    <div class="ops-pulse-item ${openIncidents > 0 ? 'warning' : 'success'}" onclick="IncidentsModule.quickFilter('Open')" title="Open incidents">
                        <div class="ops-pulse-value">${openIncidents > 0 ? openIncidents : 'âœ“'}</div>
                        <div class="ops-pulse-label">${openIncidents > 0 ? 'Open Incidents' : 'All Clear'}</div>
                    </div>
                    <div class="ops-pulse-item" onclick="Router.navigate('sites')" title="Active sites">
                        <div class="ops-pulse-value">${totalSites}</div>
                        <div class="ops-pulse-label">Active Sites</div>
                    </div>
                    ${expiringContracts > 0 ? `
                        <div class="ops-pulse-item warning" onclick="DashboardModule.showExpiringContracts()" title="Contracts expiring within 30 days">
                            <div class="ops-pulse-value">${expiringContracts}</div>
                            <div class="ops-pulse-label">Contracts Expiring</div>
                        </div>
                    ` : ''}
                    ${expiringCerts > 0 ? `
                        <div class="ops-pulse-item warning" onclick="DashboardModule.showExpiringCerts()" title="Certifications expiring within 30 days">
                            <div class="ops-pulse-value">${expiringCerts}</div>
                            <div class="ops-pulse-label">Certs Expiring</div>
                        </div>
                    ` : ''}
                    ${dueTodayTasks > 0 ? `
                        <div class="ops-pulse-item danger" onclick="TasksModule.filterByDueDate('today')" title="Tasks due today">
                            <div class="ops-pulse-value">${dueTodayTasks}</div>
                            <div class="ops-pulse-label">Tasks Due Today</div>
                        </div>
                    ` : ''}
                `;
                
                // Update timeline time
                const timeEl = document.getElementById('timeline-time');
                if (timeEl) {
                    timeEl.textContent = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                }
            },

            renderTodayShifts: function () {
                const today = Utils.toISODate(new Date());
                const weekKey = Utils.getWeekKey(new Date());
                const shifts = DataStore.getScheduleForWeek(weekKey).filter(s => s.date === today);
                const sites = DataStore.getSites();
                const guards = DataStore.getGuards();

                const container = document.getElementById('today-shifts-list');

                if (shifts.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <div class="empty-state-title">No shifts today</div>
                            <div class="empty-state-text">Import a schedule or add shifts manually</div>
                            <button class="btn btn-sm btn-primary empty-state-action" onclick="Router.navigate('scheduler')">
                                Open Scheduler
                            </button>
                        </div>
                    `;
                    return;
                }

                // Sort: OPEN shifts first, then by time
                const sortedShifts = [...shifts].sort((a, b) => {
                    if (!a.guardId && b.guardId) return -1;
                    if (a.guardId && !b.guardId) return 1;
                    return (a.startTime || '00:00').localeCompare(b.startTime || '00:00');
                });

                container.innerHTML = sortedShifts.slice(0, 10).map(shift => {
                    const site = sites.find(s => s.id === shift.siteId);
                    const guard = guards.find(g => g.id === shift.guardId);
                    const isOpen = !shift.guardId || shift.status === 'OPEN';

                    return `
                    <div class="list-item" style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-3) var(--space-4); border-bottom: 1px solid var(--color-border-subtle);">
                        <div style="flex: 1; min-width: 0;">
                            <div class="font-medium truncate">${Utils.escapeHtml(site?.name || 'Unknown')}</div>
                            <div class="text-sm text-muted">${shift.shiftLabel || 'Shift'}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                            ${isOpen ? `
                                <span class="lozenge lozenge-danger">OPEN</span>
                            ` : `
                                <span class="text-sm sensitive">${Utils.escapeHtml(guard?.name || 'Assigned')}</span>
                                <span class="lozenge lozenge-success">ON DUTY</span>
                            `}
                            <div class="list-item-actions">
                                ${guard?.phone ? `
                                    <button class="quick-action" onclick="event.stopPropagation(); window.open('tel:${guard.phone}')" title="Call">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                        </svg>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                }).join('');
                
                if (shifts.length > 10) {
                    container.innerHTML += `
                        <div style="padding: var(--space-3) var(--space-4); text-align: center;">
                            <button class="btn btn-sm btn-ghost" onclick="Router.navigate('scheduler')">
                                View all ${shifts.length} shifts â†’
                            </button>
                        </div>
                    `;
                }
            },

            renderRecentIncidents: function () {
                const incidents = DataStore.getIncidents().slice(0, 6);
                const sites = DataStore.getSites();
                const container = document.getElementById('recent-incidents-list');
                const today = new Date().toISOString().slice(0, 10);

                if (incidents.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon success">
                                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <div class="empty-state-title">All clear!</div>
                            <div class="empty-state-text">No incidents recorded yet. Great job keeping things secure.</div>
                        </div>
                    `;
                    return;
                }

                const severityColors = {
                    'Critical': 'var(--color-danger)',
                    'High': 'var(--color-danger)',
                    'Medium': 'var(--color-warning)',
                    'Low': 'var(--color-info)'
                };

                // Use workflow states from IncidentsModule
                const workflowIcons = {
                    'Open': 'ğŸ”´',
                    'In Progress': 'ğŸŸ¡',
                    'Under Investigation': 'ğŸ”',
                    'Pending Review': 'â³',
                    'Escalated': 'âš ï¸',
                    'Resolved': 'âœ…',
                    'Closed': 'ğŸ“'
                };

                container.innerHTML = incidents.map(inc => {
                    const site = sites.find(s => s.id === inc.siteId);
                    const timeAgo = Utils.timeAgo ? Utils.timeAgo(inc.dateTime) : Utils.formatDateTime(inc.dateTime);
                    const isEscalated = inc.status === 'Escalated';
                    const isOverdue = inc.followUp?.dueDate && inc.followUp.dueDate < today && !['Resolved', 'Closed'].includes(inc.status);
                    const statusIcon = workflowIcons[inc.status] || 'ğŸ“‹';
                    
                    // Indicator icons
                    let indicators = '';
                    if (isOverdue) indicators += '<span title="Follow-up overdue">â°</span>';
                    if (inc.clientNotification?.notifiedDate) indicators += '<span title="Client notified">ğŸ“§</span>';
                    
                    return `
                    <div class="list-item" style="display: flex; align-items: flex-start; gap: var(--space-3); padding: var(--space-3) var(--space-4); border-bottom: 1px solid var(--color-border-subtle); cursor: pointer; ${isEscalated ? 'background: var(--color-danger-bg);' : ''}" onclick="IncidentsModule.viewIncident('${inc.id}')">
                        <div style="width: 4px; align-self: stretch; background: ${severityColors[inc.severity]}; border-radius: 2px; flex-shrink: 0;"></div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: 2px;">
                                <span class="font-medium truncate">${Utils.escapeHtml(inc.type)}</span>
                                ${indicators ? `<span style="font-size: 0.75rem;">${indicators}</span>` : ''}
                            </div>
                            <div class="text-sm text-muted truncate">${Utils.escapeHtml(site?.name || 'Unknown')} Â· ${timeAgo}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 2px;">
                            <span class="text-xs" title="${inc.status}">${statusIcon}</span>
                            <span class="text-xs text-muted">${inc.severity}</span>
                        </div>
                    </div>
                `;
                }).join('');
                
                // Add view all link if there are more incidents
                const allIncidents = DataStore.getIncidents();
                const openCount = allIncidents.filter(i => !['Resolved', 'Closed'].includes(i.status)).length;
                if (allIncidents.length > 6) {
                    container.innerHTML += `
                        <div style="padding: var(--space-3) var(--space-4); text-align: center; display: flex; justify-content: space-between; align-items: center;">
                            <span class="text-sm text-muted">${openCount} open of ${allIncidents.length} total</span>
                            <button class="btn btn-sm btn-ghost" onclick="Router.navigate('incidents')">
                                View all â†’
                            </button>
                        </div>
                    `;
                }
            },

            renderSiteStatus: function () {
                const sites = DataStore.getSites().filter(s => s.status !== 'terminated');
                const incidents = DataStore.getIncidents().filter(i => !['Resolved', 'Closed'].includes(i.status));
                const container = document.getElementById('site-status-grid');
                const today = new Date().toISOString().slice(0, 10);

                // Update header badges
                const operationalCount = document.getElementById('sites-operational-count');
                const issuesCount = document.getElementById('sites-issues-count');

                if (sites.length === 0) {
                    container.innerHTML = `
                    <div style="grid-column: 1 / -1;" class="empty-state">
                        <div class="empty-state-icon">
                            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                        </div>
                        <div class="empty-state-title">No sites configured</div>
                        <div class="empty-state-text">Import a CSV schedule to auto-create sites</div>
                        <button class="btn btn-sm btn-primary empty-state-action" onclick="Router.navigate('settings')">
                            Import CSV
                        </button>
                    </div>
                `;
                    if (operationalCount) operationalCount.textContent = '0 Sites';
                    return;
                }

                let issuesSites = 0;

                container.innerHTML = sites.map(site => {
                    const siteIncidents = incidents.filter(i => i.siteId === site.id);
                    const hasIncident = siteIncidents.length > 0;
                    const hasCritical = siteIncidents.some(i => i.severity === 'Critical' || i.severity === 'High');
                    const hasEscalated = siteIncidents.some(i => i.status === 'Escalated');
                    
                    // Check contract status
                    let contractWarning = false;
                    if (site.contract?.endDate) {
                        const daysUntil = Math.ceil((new Date(site.contract.endDate) - new Date()) / (1000 * 60 * 60 * 24));
                        if (daysUntil <= 30) contractWarning = true;
                    }
                    
                    // Determine overall status
                    let statusIcon = 'âœ“';
                    let borderColor = 'var(--color-border)';
                    
                    if (hasEscalated) {
                        statusIcon = 'ğŸš¨';
                        borderColor = 'var(--color-danger)';
                        issuesSites++;
                    } else if (hasCritical) {
                        statusIcon = '!';
                        borderColor = 'var(--color-danger)';
                        issuesSites++;
                    } else if (hasIncident || contractWarning) {
                        statusIcon = 'âš ';
                        borderColor = 'var(--color-warning)';
                        issuesSites++;
                    }
                    
                    // Sites with issues show quick view, others go to site page
                    const clickAction = hasIncident 
                        ? `DashboardModule.showSiteIncidents('${site.id}')`
                        : `DashboardModule.goToSite('${site.id}')`;

                    return `
                    <div onclick="${clickAction}" style="background: var(--color-surface); border: 1px solid ${borderColor}; border-radius: var(--radius-md); padding: var(--space-2); display: flex; align-items: center; gap: var(--space-2); cursor: pointer; transition: all 0.15s; font-size: var(--font-size-sm);" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform=''">
                        <span style="font-size: 0.8rem;">${statusIcon}</span>
                        <span class="truncate" style="flex: 1;">${Utils.escapeHtml(site.name)}</span>
                        ${hasIncident ? `<span class="text-xs text-muted">${siteIncidents.length}</span>` : ''}
                    </div>
                `;
                }).join('');
                
                // Update header badges
                if (operationalCount) {
                    operationalCount.textContent = `${sites.length - issuesSites} OK`;
                }
                if (issuesCount) {
                    if (issuesSites > 0) {
                        issuesCount.style.display = '';
                        issuesCount.textContent = `${issuesSites} âš `;
                    } else {
                        issuesCount.style.display = 'none';
                    }
                }
            },

            goToSite: function (siteId) {
                Router.navigate('sites');
                setTimeout(() => {
                    const card = document.getElementById('site-card-' + siteId);
                    if (card) {
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        card.style.boxShadow = '0 0 0 3px var(--color-primary)';
                        setTimeout(() => { card.style.boxShadow = ''; }, 2000);
                    }
                }, 150);
            },
            
            // Show incidents for a specific site
            showSiteIncidents: function(siteId) {
                const site = DataStore.getSites().find(s => s.id === siteId);
                const incidents = DataStore.getIncidents().filter(i => 
                    i.siteId === siteId && !['Resolved', 'Closed'].includes(i.status)
                );
                
                if (!site || incidents.length === 0) {
                    this.goToSite(siteId);
                    return;
                }
                
                const severityColors = {
                    'Critical': 'var(--color-danger)',
                    'High': 'var(--color-danger)',
                    'Medium': 'var(--color-warning)',
                    'Low': 'var(--color-info)'
                };
                
                let html = `
                    <div style="margin-bottom: var(--space-4);">
                        <p class="text-muted">${incidents.length} open incident${incidents.length !== 1 ? 's' : ''}</p>
                    </div>
                    <div style="max-height: 350px; overflow-y: auto;">
                `;
                
                incidents.forEach(i => {
                    const timeAgo = Utils.timeAgo ? Utils.timeAgo(i.dateTime) : Utils.formatDateTime(i.dateTime);
                    html += `
                        <div style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3); border: 1px solid var(--color-border); border-radius: var(--radius-md); margin-bottom: var(--space-2); cursor: pointer;"
                             onclick="UI.closeModal(); IncidentsModule.viewIncident('${i.id}')"
                             onmouseover="this.style.background='var(--color-surface-elevated)'" 
                             onmouseout="this.style.background=''">
                            <div style="width: 4px; height: 40px; background: ${severityColors[i.severity]}; border-radius: 2px;"></div>
                            <div style="flex: 1; min-width: 0;">
                                <div class="font-medium">${Utils.escapeHtml(i.type)}</div>
                                <div class="text-sm text-muted">${i.severity} â€¢ ${i.status} â€¢ ${timeAgo}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>
                    <button class="btn btn-ghost" onclick="UI.closeModal(); DashboardModule.goToSite('${siteId}')">View Site Details</button>
                    <button class="btn btn-primary" onclick="UI.closeModal(); IncidentsModule.quickFilter('Open')">All Open Incidents</button>
                `;
                
                UI.openModal(`${site.name} â€” Open Incidents`, html, footer);
            },

            updateNavBadges: function () {
                // Badge updates handled by individual modules
                // Notification bell removed in v5.0 UI audit
            },

            init: function () {
                // Quick Log form handler
                document.getElementById('quick-log-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.submitQuickLog();
                });

                // Generate Daily Summary button
                document.getElementById('generate-summary-btn')?.addEventListener('click', () => {
                    this.generateDailySummary();
                });
            },

            submitQuickLog: function () {
                const source = document.getElementById('quick-log-source').value;
                const note = document.getElementById('quick-log-note').value.trim();
                const needsFollowUp = document.getElementById('quick-log-followup').checked;

                if (!note) {
                    UI.toast('Error', 'Please enter a note.', 'error');
                    return;
                }

                const entry = {
                    id: Utils.generateId('log-'),
                    dateTime: new Date().toISOString(),
                    source: source,
                    siteId: null,
                    note: note,
                    needsFollowUp: needsFollowUp,
                    status: 'open',
                    resolvedNote: '',
                    resolvedAt: null
                };

                DataStore.addLogEntry(entry);

                // Reset form
                document.getElementById('quick-log-note').value = '';
                document.getElementById('quick-log-followup').checked = false;

                // Update counts
                SupervisorLogModule.updateOpenCount();

                UI.toast('Entry Added', 'Quick log entry has been saved.', 'success');
            },

            generateDailySummary: function () {
                const today = Utils.toISODate(new Date());
                const weekKey = Utils.getWeekKey(new Date());

                // Gather data
                const sites = DataStore.getSites();
                const guards = DataStore.getGuards();
                const shifts = DataStore.getScheduleForWeek(weekKey).filter(s => s.date === today);
                const incidents = DataStore.getIncidents().filter(i => Utils.toISODate(new Date(i.dateTime)) === today);
                const inspections = DataStore.getInspections().filter(i => Utils.toISODate(new Date(i.dateTime)) === today);
                const calloffs = DataStore.getTodayCalloffs();
                const openLogItems = DataStore.getOpenLogItems();
                const logEntries = DataStore.getSupervisorLog().filter(e => Utils.toISODate(new Date(e.dateTime)) === today);

                // Calculate stats
                const totalShifts = shifts.length;
                const coveredShifts = shifts.filter(s => s.guardId && s.status !== 'OPEN').length;
                const openShifts = totalShifts - coveredShifts;
                const coveragePercent = totalShifts > 0 ? Math.round((coveredShifts / totalShifts) * 100) : 100;

                const coveredCalloffs = calloffs.filter(c => c.coverageStatus === 'covered').length;
                const uncoveredCalloffs = calloffs.filter(c => c.coverageStatus === 'uncovered').length;
                const pendingCalloffs = calloffs.filter(c => c.coverageStatus === 'pending').length;

                const criticalIncidents = incidents.filter(i => i.severity === 'Critical' || i.severity === 'High').length;
                const openIncidents = incidents.filter(i => i.status !== 'Resolved').length;

                // Build summary
                const dateStr = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                let summary = `DAILY OPERATIONS SUMMARY\n`;
                summary += `${dateStr}\n`;
                summary += `Generated: ${new Date().toLocaleTimeString()}\n`;
                summary += `${'='.repeat(50)}\n\n`;

                summary += `SHIFT COVERAGE\n`;
                summary += `-`.repeat(30) + `\n`;
                summary += `Coverage Rate: ${coveragePercent}%\n`;
                summary += `Total Shifts: ${totalShifts}\n`;
                summary += `Covered: ${coveredShifts}\n`;
                summary += `Open: ${openShifts}\n\n`;

                summary += `CALL-OFFS (Today)\n`;
                summary += `-`.repeat(30) + `\n`;
                summary += `Total: ${calloffs.length}\n`;
                summary += `Covered: ${coveredCalloffs}\n`;
                summary += `Uncovered: ${uncoveredCalloffs}\n`;
                summary += `Pending: ${pendingCalloffs}\n`;
                if (calloffs.length > 0) {
                    summary += `\nDetails:\n`;
                    calloffs.forEach(c => {
                        const guard = guards.find(g => g.id === c.guardId);
                        const site = sites.find(s => s.id === c.siteId);
                        const replacement = c.replacementGuardId ? guards.find(g => g.id === c.replacementGuardId) : null;
                        summary += `  â€¢ ${guard?.name || 'Unknown'} - ${site?.name || 'Unknown'} (${c.shift})\n`;
                        summary += `    Reason: ${c.reason}\n`;
                        summary += `    Status: ${c.coverageStatus.toUpperCase()}${replacement ? ' by ' + replacement.name : ''}\n`;
                    });
                }
                summary += `\n`;

                summary += `INCIDENTS (Today)\n`;
                summary += `-`.repeat(30) + `\n`;
                summary += `Total: ${incidents.length}\n`;
                summary += `Critical/High: ${criticalIncidents}\n`;
                summary += `Open: ${openIncidents}\n`;
                if (incidents.length > 0) {
                    summary += `\nDetails:\n`;
                    incidents.forEach(inc => {
                        const site = sites.find(s => s.id === inc.siteId);
                        summary += `  â€¢ [${inc.severity}] ${inc.type} at ${site?.name || 'Unknown'}\n`;
                        summary += `    Status: ${inc.status}\n`;
                    });
                }
                summary += `\n`;

                summary += `INSPECTIONS (Today)\n`;
                summary += `-`.repeat(30) + `\n`;
                summary += `Completed: ${inspections.length}\n`;
                if (inspections.length > 0) {
                    inspections.forEach(insp => {
                        const site = sites.find(s => s.id === insp.siteId);
                        summary += `  â€¢ ${site?.name || 'Unknown'} - ${insp.status}\n`;
                    });
                }
                summary += `\n`;

                summary += `SUPERVISOR LOG (Today)\n`;
                summary += `-`.repeat(30) + `\n`;
                summary += `Entries: ${logEntries.length}\n`;
                if (logEntries.length > 0) {
                    logEntries.forEach(entry => {
                        const site = entry.siteId ? sites.find(s => s.id === entry.siteId)?.name : 'General';
                        summary += `  â€¢ [${entry.source}] ${site}\n`;
                        summary += `    ${entry.note.substring(0, 80)}${entry.note.length > 80 ? '...' : ''}\n`;
                        if (entry.needsFollowUp && entry.status === 'open') {
                            summary += `    âš  NEEDS FOLLOW-UP\n`;
                        }
                    });
                }
                summary += `\n`;

                summary += `OPEN FOLLOW-UP ITEMS\n`;
                summary += `-`.repeat(30) + `\n`;
                summary += `Total Open: ${openLogItems.length}\n`;
                if (openLogItems.length > 0) {
                    openLogItems.slice(0, 5).forEach(item => {
                        const age = SupervisorLogModule.getEntryAge(item.dateTime);
                        summary += `  â€¢ [${age}] ${item.note.substring(0, 60)}${item.note.length > 60 ? '...' : ''}\n`;
                    });
                    if (openLogItems.length > 5) {
                        summary += `  ... and ${openLogItems.length - 5} more\n`;
                    }
                }
                summary += `\n`;

                summary += `${'='.repeat(50)}\n`;
                summary += `End of Report\n`;

                // Show in modal with copy option
                const content = `
                <div style="font-family: var(--font-family-mono); font-size: var(--font-size-sm); white-space: pre-wrap; background: var(--color-bg); padding: var(--space-4); border-radius: var(--radius-md); max-height: 60vh; overflow-y: auto;">${Utils.escapeHtml(summary)}</div>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>
                <button class="btn btn-secondary" onclick="DashboardModule.copySummary()">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                    Copy to Clipboard
                </button>
                <button class="btn btn-primary" onclick="DashboardModule.downloadSummary()">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                    Download
                </button>
            `;

                // Store summary for copy/download
                this._currentSummary = summary;

                UI.openModal('Daily Operations Summary', content, footer, 'lg');
            },

            copySummary: function () {
                if (this._currentSummary) {
                    navigator.clipboard.writeText(this._currentSummary).then(() => {
                        UI.toast('Copied', 'Summary copied to clipboard.', 'success');
                    }).catch(() => {
                        UI.toast('Error', 'Could not copy to clipboard.', 'error');
                    });
                }
            },

            downloadSummary: function () {
                if (this._currentSummary) {
                    const today = Utils.toISODate(new Date());
                    Utils.downloadFile(this._currentSummary, `daily-summary-${today}.txt`, 'text/plain');
                    UI.toast('Downloaded', 'Summary downloaded.', 'success');
                }
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SCHEDULER MODULE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const SchedulerModule = {
            currentWeekStart: null,

            init: function () {
                this.currentWeekStart = Utils.getWeekStart(new Date());

                document.getElementById('prev-week')?.addEventListener('click', () => this.prevWeek());
                document.getElementById('next-week')?.addEventListener('click', () => this.nextWeek());
                document.getElementById('today-btn')?.addEventListener('click', () => this.goToToday());
                document.getElementById('export-schedule-csv')?.addEventListener('click', () => this.exportCSV());
                document.getElementById('print-schedule')?.addEventListener('click', () => this.printSchedule());
            },
            
            printSchedule: function() {
                // Populate print header
                const timestamp = document.getElementById('print-timestamp');
                const printStats = document.getElementById('print-stats');
                
                if (timestamp) {
                    const now = new Date();
                    timestamp.textContent = now.toLocaleString('en-US', { 
                        month: '2-digit', day: '2-digit', year: '2-digit',
                        hour: 'numeric', minute: '2-digit'
                    });
                }
                
                if (printStats) {
                    const weekKey = Utils.getWeekKey(this.currentWeekStart);
                    const shifts = DataStore.getScheduleForWeek(weekKey) || [];
                    const filledShifts = shifts.filter(s => s.guardId).length;
                    const openShifts = shifts.length - filledShifts;
                    const coverage = this.analyzeCoverage(weekKey);
                    const guardHours = this.calculateGuardHours(weekKey);
                    const overtimeGuards = Object.values(guardHours).filter(g => g.totalHours > g.maxHours).length;
                    const conflicts = this.detectConflicts(weekKey);
                    
                    printStats.innerHTML = `
                        <span><strong>${filledShifts}</strong> Filled</span>
                        <span><strong style="color: ${openShifts > 0 ? '#c00' : '#0a0'};">${openShifts}</strong> Open</span>
                        <span><strong>${coverage.gaps.length}</strong> Gaps</span>
                        <span>${overtimeGuards > 0 ? 'âš ï¸' : 'âœ“'} <strong>${overtimeGuards > 0 ? overtimeGuards + ' OT' : 'Hours OK'}</strong></span>
                        <span><strong>${conflicts.length}</strong> Conflicts</span>
                    `;
                }
                
                window.print();
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // COVERAGE ANALYSIS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            // Analyze coverage gaps for a week
            analyzeCoverage: function(weekKey) {
                const shifts = DataStore.getScheduleForWeek(weekKey) || [];
                const sites = DataStore.getSites();
                const days = Utils.getDaysOfWeek(this.currentWeekStart);
                
                const gaps = [];
                const warnings = [];
                
                sites.forEach(site => {
                    if (site.status === 'terminated') return;
                    
                    const patterns = site.shiftPatterns || [];
                    
                    days.forEach(day => {
                        const dateStr = Utils.toISODate(day);
                        
                        patterns.forEach(pattern => {
                            const requiredArmed = pattern.armedCount || 0;
                            const requiredUnarmed = pattern.unarmedCount || 0;
                            const totalRequired = requiredArmed + requiredUnarmed || 1;
                            
                            // Find matching shifts
                            const matchingShifts = shifts.filter(s => 
                                s.siteId === site.id && 
                                s.date === dateStr && 
                                s.shiftLabel === pattern.label
                            );
                            
                            const filledShifts = matchingShifts.filter(s => s.guardId);
                            const guards = DataStore.getGuards();
                            const armedFilled = filledShifts.filter(s => {
                                const g = guards.find(gg => gg.id === s.guardId);
                                return g?.role === 'armed';
                            }).length;
                            const unarmedFilled = filledShifts.length - armedFilled;
                            
                            // Check for gaps
                            if (filledShifts.length < totalRequired) {
                                gaps.push({
                                    siteId: site.id,
                                    siteName: site.name,
                                    date: dateStr,
                                    shift: pattern.label,
                                    required: totalRequired,
                                    filled: filledShifts.length,
                                    shortfall: totalRequired - filledShifts.length
                                });
                            }
                            
                            // Check armed shortfall
                            if (requiredArmed > 0 && armedFilled < requiredArmed) {
                                warnings.push({
                                    type: 'armed_shortage',
                                    siteId: site.id,
                                    siteName: site.name,
                                    date: dateStr,
                                    shift: pattern.label,
                                    message: `Need ${requiredArmed - armedFilled} more armed guard(s)`
                                });
                            }
                        });
                    });
                });
                
                return { gaps, warnings };
            },
            
            // Calculate guard hours for the week
            calculateGuardHours: function(weekKey) {
                const shifts = DataStore.getScheduleForWeek(weekKey) || [];
                const guards = DataStore.getGuards();
                const hoursMap = {};
                
                shifts.forEach(shift => {
                    if (!shift.guardId) return;
                    
                    // Calculate hours from start/end time
                    let hours = 8; // Default
                    if (shift.startTime && shift.endTime) {
                        const [sh, sm] = shift.startTime.split(':').map(Number);
                        const [eh, em] = shift.endTime.split(':').map(Number);
                        let startMins = sh * 60 + sm;
                        let endMins = eh * 60 + em;
                        if (endMins <= startMins) endMins += 24 * 60; // Overnight
                        hours = (endMins - startMins) / 60;
                    }
                    
                    if (!hoursMap[shift.guardId]) {
                        const guard = guards.find(g => g.id === shift.guardId);
                        hoursMap[shift.guardId] = {
                            guardId: shift.guardId,
                            name: guard?.name || 'Unknown',
                            maxHours: guard?.availability?.maxHoursPerWeek || 40,
                            totalHours: 0,
                            shiftCount: 0,
                            shifts: []
                        };
                    }
                    
                    hoursMap[shift.guardId].totalHours += hours;
                    hoursMap[shift.guardId].shiftCount++;
                    hoursMap[shift.guardId].shifts.push({
                        date: shift.date,
                        site: shift.siteId,
                        hours: hours
                    });
                });
                
                return hoursMap;
            },
            
            // Detect scheduling conflicts (double-booked guards)
            detectConflicts: function(weekKey) {
                const shifts = DataStore.getScheduleForWeek(weekKey) || [];
                const conflicts = [];
                
                // Group shifts by guard and date
                const guardDayShifts = {};
                shifts.forEach(shift => {
                    if (!shift.guardId) return;
                    const key = `${shift.guardId}|${shift.date}`;
                    if (!guardDayShifts[key]) guardDayShifts[key] = [];
                    guardDayShifts[key].push(shift);
                });
                
                // Check for overlapping times
                Object.entries(guardDayShifts).forEach(([key, dayShifts]) => {
                    if (dayShifts.length < 2) return;
                    
                    const guard = DataStore.getGuards().find(g => g.id === dayShifts[0].guardId);
                    
                    for (let i = 0; i < dayShifts.length; i++) {
                        for (let j = i + 1; j < dayShifts.length; j++) {
                            const s1 = dayShifts[i];
                            const s2 = dayShifts[j];
                            
                            // Check time overlap
                            const toMins = (t) => {
                                if (!t) return 0;
                                const [h, m] = t.split(':').map(Number);
                                return h * 60 + m;
                            };
                            
                            let s1Start = toMins(s1.startTime);
                            let s1End = toMins(s1.endTime);
                            let s2Start = toMins(s2.startTime);
                            let s2End = toMins(s2.endTime);
                            
                            // Handle overnight
                            if (s1End <= s1Start) s1End += 24 * 60;
                            if (s2End <= s2Start) s2End += 24 * 60;
                            
                            // Check overlap
                            if (s1Start < s2End && s2Start < s1End) {
                                conflicts.push({
                                    guardId: s1.guardId,
                                    guardName: guard?.name || 'Unknown',
                                    date: s1.date,
                                    shift1: s1,
                                    shift2: s2
                                });
                            }
                        }
                    }
                });
                
                return conflicts;
            },

            render: function () {
                this.updateWeekLabel();
                this.renderStats();
                this.renderGrid();
            },
            
            // Render stats panel above grid
            renderStats: function() {
                const weekKey = Utils.getWeekKey(this.currentWeekStart);
                const shifts = DataStore.getScheduleForWeek(weekKey) || [];
                const coverage = this.analyzeCoverage(weekKey);
                const guardHours = this.calculateGuardHours(weekKey);
                const conflicts = this.detectConflicts(weekKey);
                
                // Calculate stats
                const totalShifts = shifts.length;
                const filledShifts = shifts.filter(s => s.guardId).length;
                const openShifts = totalShifts - filledShifts;
                const gapCount = coverage.gaps.length;
                const overtimeGuards = Object.values(guardHours).filter(g => g.totalHours > g.maxHours).length;
                
                const statsContainer = document.getElementById('schedule-stats');
                if (!statsContainer) return;
                
                statsContainer.innerHTML = `
                    <div style="display: flex; gap: var(--space-3); flex-wrap: wrap; margin-bottom: var(--space-4);">
                        <div style="flex: 1; min-width: 120px; background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md); text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-success);">${filledShifts}</div>
                            <div class="text-xs text-muted">Filled</div>
                        </div>
                        <div style="flex: 1; min-width: 120px; background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md); text-align: center; cursor: pointer;" onclick="SchedulerModule.showOpenShifts()" title="Click to view open shifts">
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${openShifts > 0 ? 'var(--color-danger)' : 'var(--color-success)'};">${openShifts}</div>
                            <div class="text-xs text-muted">Open</div>
                        </div>
                        <div style="flex: 1; min-width: 120px; background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md); text-align: center; cursor: pointer;" onclick="SchedulerModule.showGaps()" title="Click to view coverage gaps">
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${gapCount > 0 ? 'var(--color-warning)' : 'var(--color-success)'};">${gapCount}</div>
                            <div class="text-xs text-muted">Gaps</div>
                        </div>
                        <div style="flex: 1; min-width: 120px; background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md); text-align: center; cursor: pointer;" onclick="SchedulerModule.showGuardHours()" title="Click to view guard hours">
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${overtimeGuards > 0 ? 'var(--color-danger)' : 'var(--color-text)'};">${overtimeGuards > 0 ? 'âš ï¸' : 'âœ“'}</div>
                            <div class="text-xs text-muted">${overtimeGuards > 0 ? overtimeGuards + ' OT' : 'Hours OK'}</div>
                        </div>
                        <div style="flex: 1; min-width: 120px; background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md); text-align: center; cursor: pointer;" onclick="SchedulerModule.showConflicts()" title="Click to view conflicts">
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${conflicts.length > 0 ? 'var(--color-danger)' : 'var(--color-success)'};">${conflicts.length}</div>
                            <div class="text-xs text-muted">Conflicts</div>
                        </div>
                    </div>
                `;
            },
            
            // Show open shifts modal
            showOpenShifts: function() {
                const weekKey = Utils.getWeekKey(this.currentWeekStart);
                const shifts = DataStore.getScheduleForWeek(weekKey) || [];
                const openShifts = shifts.filter(s => !s.guardId);
                const sites = DataStore.getSites();
                
                if (openShifts.length === 0) {
                    UI.toast('All shifts are filled!', 'success');
                    return;
                }
                
                // Group by date
                const byDate = {};
                openShifts.forEach(s => {
                    if (!byDate[s.date]) byDate[s.date] = [];
                    byDate[s.date].push(s);
                });
                
                let content = '<div style="max-height: 60vh; overflow-y: auto;">';
                
                Object.keys(byDate).sort().forEach(date => {
                    const dateLabel = new Date(date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    content += `<h4 style="margin: var(--space-3) 0 var(--space-2); color: var(--color-primary);">${dateLabel}</h4>`;
                    
                    byDate[date].forEach(shift => {
                        const site = sites.find(s => s.id === shift.siteId);
                        content += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-2) var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md); margin-bottom: var(--space-2);">
                                <div>
                                    <div class="font-medium">${Utils.escapeHtml(site?.name || 'Unknown')}</div>
                                    <div class="text-sm text-muted">${shift.shiftLabel}</div>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="UI.closeModal(); SchedulerModule.editShift('${shift.id}')">Fill</button>
                            </div>
                        `;
                    });
                });
                
                content += '</div>';
                UI.openModal(`${openShifts.length} Open Shifts`, content, '<button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>', 'md');
            },
            
            // Show coverage gaps modal
            showGaps: function() {
                const weekKey = Utils.getWeekKey(this.currentWeekStart);
                const coverage = this.analyzeCoverage(weekKey);
                
                if (coverage.gaps.length === 0) {
                    UI.toast('No coverage gaps - all requirements met!', 'success');
                    return;
                }
                
                let content = '<div style="max-height: 60vh; overflow-y: auto;">';
                content += `<p class="text-muted" style="margin-bottom: var(--space-3);">Sites where scheduled guards don't meet staffing requirements:</p>`;
                
                coverage.gaps.forEach(gap => {
                    const dateLabel = new Date(gap.date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    content += `
                        <div style="padding: var(--space-3); background: var(--color-warning-bg); border-left: 3px solid var(--color-warning); border-radius: var(--radius-md); margin-bottom: var(--space-2);">
                            <div class="font-medium">${Utils.escapeHtml(gap.siteName)}</div>
                            <div class="text-sm">${dateLabel} Â· ${gap.shift}</div>
                            <div class="text-sm text-danger">Need ${gap.shortfall} more (${gap.filled}/${gap.required} filled)</div>
                        </div>
                    `;
                });
                
                content += '</div>';
                UI.openModal(`${coverage.gaps.length} Coverage Gaps`, content, '<button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>', 'md');
            },
            
            // Show guard hours modal
            showGuardHours: function() {
                const weekKey = Utils.getWeekKey(this.currentWeekStart);
                const guardHours = this.calculateGuardHours(weekKey);
                const sorted = Object.values(guardHours).sort((a, b) => b.totalHours - a.totalHours);
                
                if (sorted.length === 0) {
                    UI.toast('No shifts assigned yet', 'info');
                    return;
                }
                
                let content = '<div style="max-height: 60vh; overflow-y: auto;">';
                content += '<table class="table"><thead><tr><th>Guard</th><th>Hours</th><th>Shifts</th><th>Status</th></tr></thead><tbody>';
                
                sorted.forEach(g => {
                    const isOvertime = g.totalHours > g.maxHours;
                    const statusBadge = isOvertime 
                        ? `<span class="badge badge-danger">OT +${(g.totalHours - g.maxHours).toFixed(1)}h</span>`
                        : `<span class="badge badge-success">OK</span>`;
                    
                    content += `
                        <tr style="${isOvertime ? 'background: var(--color-danger-bg);' : ''}">
                            <td class="font-medium">${Utils.escapeHtml(g.name)}</td>
                            <td>${g.totalHours.toFixed(1)} / ${g.maxHours}h</td>
                            <td>${g.shiftCount}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                });
                
                content += '</tbody></table></div>';
                UI.openModal('Guard Hours This Week', content, '<button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>', 'md');
            },
            
            // Show conflicts modal
            showConflicts: function() {
                const weekKey = Utils.getWeekKey(this.currentWeekStart);
                const conflicts = this.detectConflicts(weekKey);
                const sites = DataStore.getSites();
                
                if (conflicts.length === 0) {
                    UI.toast('No scheduling conflicts detected!', 'success');
                    return;
                }
                
                let content = '<div style="max-height: 60vh; overflow-y: auto;">';
                content += `<p class="text-muted" style="margin-bottom: var(--space-3);">Guards scheduled for overlapping shifts:</p>`;
                
                conflicts.forEach(c => {
                    const site1 = sites.find(s => s.id === c.shift1.siteId);
                    const site2 = sites.find(s => s.id === c.shift2.siteId);
                    const dateLabel = new Date(c.date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    
                    content += `
                        <div style="padding: var(--space-3); background: var(--color-danger-bg); border-left: 3px solid var(--color-danger); border-radius: var(--radius-md); margin-bottom: var(--space-2);">
                            <div class="font-medium">${Utils.escapeHtml(c.guardName)}</div>
                            <div class="text-sm">${dateLabel}</div>
                            <div class="text-sm text-muted">
                                ${Utils.escapeHtml(site1?.name)} (${c.shift1.shiftLabel}) conflicts with
                                ${Utils.escapeHtml(site2?.name)} (${c.shift2.shiftLabel})
                            </div>
                        </div>
                    `;
                });
                
                content += '</div>';
                UI.openModal(`${conflicts.length} Scheduling Conflicts`, content, '<button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>', 'md');
            },

            updateWeekLabel: function () {
                const endDate = new Date(this.currentWeekStart);
                endDate.setDate(endDate.getDate() + 6);

                const startStr = this.currentWeekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const endStr = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                const label = document.getElementById('week-label');
                if (label) {
                    label.textContent = `${startStr} â€“ ${endStr}`;
                }
            },

            renderGrid: function () {
                const sites = DataStore.getSites();
                const guards = DataStore.getGuards();
                const days = Utils.getDaysOfWeek(this.currentWeekStart);
                const weekKey = Utils.getWeekKey(this.currentWeekStart);
                let shifts = DataStore.getScheduleForWeek(weekKey);

                // Generate shifts if none exist
                if (shifts.length === 0) {
                    shifts = this.generateDefaultShifts(sites, days, weekKey);
                    DataStore.saveScheduleForWeek(weekKey, shifts);
                }

                const grid = document.getElementById('scheduler-grid');

                // Header row
                let html = '<div class="scheduler-header-cell">Site</div>';
                days.forEach((d, idx) => {
                    const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                    const dayNum = d.getDate();
                    const isToday = Utils.toISODate(d) === Utils.toISODate(new Date());
                    const dateStr = Utils.toISODate(d);
                    html += `<div class="scheduler-header-cell" style="cursor: pointer; ${isToday ? 'background: var(--color-primary); color: white;' : ''}" onclick="SchedulerModule.showDayDetail('${dateStr}')" title="Click to view ${dayName} details">${dayName} ${dayNum}</div>`;
                });

                // Site rows
                sites.forEach(site => {
                    html += `<div class="scheduler-site-cell">${Utils.escapeHtml(site.name)}</div>`;

                    days.forEach(d => {
                        const dateStr = Utils.toISODate(d);
                        const dayShifts = shifts.filter(s => s.siteId === site.id && s.date === dateStr);

                        // Group shifts by time slot (shiftLabel + startTime)
                        const shiftGroups = {};
                        dayShifts.forEach(shift => {
                            const key = `${shift.shiftLabel}|${shift.startTime}`;
                            if (!shiftGroups[key]) {
                                shiftGroups[key] = {
                                    shiftLabel: shift.shiftLabel,
                                    startTime: shift.startTime,
                                    endTime: shift.endTime,
                                    guards: [],
                                    shiftIds: [],
                                    hasOpen: false
                                };
                            }
                            shiftGroups[key].shiftIds.push(shift.id);
                            if (shift.guardId) {
                                const guard = guards.find(g => g.id === shift.guardId);
                                if (guard) {
                                    shiftGroups[key].guards.push({
                                        ...guard,
                                        shiftId: shift.id,
                                        status: shift.status
                                    });
                                }
                            } else {
                                shiftGroups[key].hasOpen = true;
                            }
                        });

                        html += `<div class="scheduler-shift-cell" onclick="SchedulerModule.handleCellClick(event, '${site.id}', '${dateStr}')" data-site="${site.id}" data-date="${dateStr}">`;

                        // Sort by start time and render grouped shifts
                        const groupValues = Object.values(shiftGroups);
                        
                        if (groupValues.length === 0) {
                            // Empty cell - show add prompt
                            html += `<div class="empty-cell-prompt" title="Click to add shift">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                            </div>`;
                        }
                        
                        groupValues
                            .sort((a, b) => (a.startTime || '00:00').localeCompare(b.startTime || '00:00'))
                            .forEach(group => {
                                const hasGuards = group.guards.length > 0;
                                const allConfirmed = hasGuards && group.guards.every(g => g.status === 'DP_CONF');
                                const statusClass = !hasGuards || group.hasOpen ? 'open' : allConfirmed ? 'confirmed' : 'assigned';
                                const firstShiftId = group.shiftIds[0];

                                // v6.8.6: Normalize time display format
                                const formatShiftTime = (label) => {
                                    if (!label) return 'Day';
                                    // Already friendly format like "8A-4P"
                                    if (/^\d{1,2}[AP]-\d{1,2}[AP]$/i.test(label)) return label.toUpperCase();
                                    // 24-hour format like "00:00-08:00"
                                    const match = label.match(/^(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})$/);
                                    if (match) {
                                        const formatH = (h) => {
                                            const hour = parseInt(h);
                                            if (hour === 0) return '12A';
                                            if (hour === 12) return '12P';
                                            return hour < 12 ? hour + 'A' : (hour - 12) + 'P';
                                        };
                                        return formatH(match[1]) + '-' + formatH(match[3]);
                                    }
                                    return label;
                                };

                                html += `
                                <div class="shift-card ${statusClass}" onclick="event.stopPropagation(); SchedulerModule.editShift('${firstShiftId}')" role="button" tabindex="0">
                                    <div class="shift-time">${formatShiftTime(group.shiftLabel)}</div>
                            `;

                                if (group.guards.length === 0) {
                                    html += `<div class="shift-guard open">OPEN</div>`;
                                } else if (group.guards.length === 1) {
                                    const g = group.guards[0];
                                    const roleIndicator = g.role === 'armed' ? 'ğŸ›¡ï¸' : g.role === 'floater' ? 'ğŸ”„' : '';
                                    html += `<div class="shift-guard"><span class="sensitive">${roleIndicator} ${Utils.escapeHtml(g.name)}</span></div>`;
                                } else {
                                    // Multiple guards - show compact list
                                    html += `<div class="shift-guard multi-guard">`;
                                    group.guards.forEach((g, idx) => {
                                        const roleIndicator = g.role === 'armed' ? 'ğŸ›¡ï¸' : g.role === 'floater' ? 'ğŸ”„' : '';
                                        const shortName = g.name.split(' ').map((n, i) => i === 0 ? n : n[0] + '.').join(' ');
                                        html += `<div class="multi-guard-entry sensitive">${roleIndicator} ${Utils.escapeHtml(shortName)}</div>`;
                                    });
                                    if (group.hasOpen) {
                                        html += `<div class="multi-guard-entry open">+ OPEN</div>`;
                                    }
                                    html += `</div>`;
                                }

                                html += `</div>`;
                            });

                        html += '</div>';
                    });
                });

                grid.innerHTML = html;
                grid.style.gridTemplateColumns = `180px repeat(7, 1fr)`;
            },

            generateDefaultShifts: function (sites, days, weekKey) {
                const shifts = [];
                const guards = DataStore.getActiveGuards();
                let guardIdx = 0;

                sites.forEach(site => {
                    days.forEach(d => {
                        const dateStr = Utils.toISODate(d);
                        site.shiftPatterns.forEach(pattern => {
                            const shift = {
                                id: Utils.generateId('shift-'),
                                date: dateStr,
                                siteId: site.id,
                                shiftLabel: pattern.label,
                                startTime: pattern.startTime,
                                endTime: pattern.endTime,
                                guardId: guards[guardIdx % guards.length]?.id || null,
                                status: guards.length > 0 ? 'ASSIGNED' : 'OPEN',
                                notes: ''
                            };
                            shifts.push(shift);
                            guardIdx++;
                        });
                    });
                });

                return shifts;
            },

            handleCellClick: function (event, siteId, dateStr) {
                // Don't trigger if clicking on a shift card (they have stopPropagation but just in case)
                if (event.target.closest('.shift-card')) {
                    return;
                }
                
                // Open add shift modal with site and date pre-selected
                this.openAddShiftModal(dateStr, siteId);
            },

            openAddShiftModal: function (presetDate = null, presetSiteId = null) {
                const sites = DataStore.getSites().filter(s => s.status !== 'terminated');
                const guards = DataStore.getActiveGuards().sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                const days = Utils.getDaysOfWeek(this.currentWeekStart);
                const weekKey = Utils.getWeekKey(this.currentWeekStart);
                const shifts = DataStore.getScheduleForWeek(weekKey) || [];
                
                // Default to today if within current week, otherwise first day of week
                const today = Utils.toISODate(new Date());
                const weekDates = days.map(d => Utils.toISODate(d));
                const defaultDate = presetDate || (weekDates.includes(today) ? today : weekDates[0]);
                
                // Calculate hours for each guard this week
                const guardHours = this.calculateGuardHours(weekKey);
                
                const content = `
                <form id="add-shift-form">
                    <div class="form-group">
                        <label class="form-label">Site <span style="color: var(--color-danger);">*</span></label>
                        <select class="form-select" id="add-shift-site" required>
                            <option value="">â€” Select Site â€”</option>
                            ${sites.map(s => `<option value="${s.id}" ${s.id === presetSiteId ? 'selected' : ''}>${Utils.escapeHtml(s.name)}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date <span style="color: var(--color-danger);">*</span></label>
                        <select class="form-select" id="add-shift-date" required onchange="SchedulerModule.updateAvailableGuards()">
                            ${days.map(d => {
                                const dateStr = Utils.toISODate(d);
                                const dayLabel = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                                return `<option value="${dateStr}" ${dateStr === defaultDate ? 'selected' : ''}>${dayLabel}</option>`;
                            }).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Shift Type <span style="color: var(--color-danger);">*</span></label>
                        <select class="form-select" id="add-shift-type" onchange="SchedulerModule.toggleCustomTime(this.value); SchedulerModule.updateAvailableGuards();">
                            <option value="8A-4P">Day Shift (8A-4P)</option>
                            <option value="4P-12A">Evening Shift (4P-12A)</option>
                            <option value="12A-8A">Night Shift (12A-8A)</option>
                            <option value="custom">Custom Times...</option>
                        </select>
                    </div>
                    <div class="form-row" id="custom-time-row" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Start Time</label>
                            <input type="time" class="form-input" id="add-shift-start" value="08:00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Time</label>
                            <input type="time" class="form-input" id="add-shift-end" value="16:00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Assign Guard</label>
                        <select class="form-select" id="add-shift-guard">
                            <option value="">â€” Leave OPEN â€”</option>
                            ${guards.map(g => {
                                const hrs = guardHours[g.id];
                                const hoursInfo = hrs ? ` (${hrs.totalHours.toFixed(0)}h this week)` : '';
                                const maxHrs = g.availability?.maxHoursPerWeek || 40;
                                const isOvertime = hrs && hrs.totalHours >= maxHrs;
                                return `<option value="${g.id}" ${isOvertime ? 'style="color: var(--color-warning);"' : ''}>${Utils.escapeHtml(g.name)} ${g.role ? '(' + g.role + ')' : ''}${hoursInfo}</option>`;
                            }).join('')}
                        </select>
                        <div id="guard-availability-hint" class="text-xs text-muted" style="margin-top: 4px;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="add-shift-notes" rows="2" placeholder="Optional notes..."></textarea>
                    </div>
                </form>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="SchedulerModule.saveNewShift()">Add Shift</button>
            `;

                UI.openModal('Add New Shift', content, footer);
                
                // Initial availability check
                setTimeout(() => this.updateAvailableGuards(), 100);
            },
            
            // Update available guards hint based on selected date/time
            updateAvailableGuards: function() {
                const dateEl = document.getElementById('add-shift-date');
                const typeEl = document.getElementById('add-shift-type');
                const hintEl = document.getElementById('guard-availability-hint');
                
                if (!dateEl || !typeEl || !hintEl) return;
                
                const date = dateEl.value;
                const shiftType = typeEl.value;
                const weekKey = Utils.getWeekKey(this.currentWeekStart);
                const shifts = DataStore.getScheduleForWeek(weekKey) || [];
                
                // Find guards already scheduled on this date
                const busyGuards = new Set();
                shifts.filter(s => s.date === date && s.guardId).forEach(s => busyGuards.add(s.guardId));
                
                const totalGuards = DataStore.getActiveGuards().length;
                const availableCount = totalGuards - busyGuards.size;
                
                hintEl.innerHTML = `${availableCount} of ${totalGuards} guards available on this date`;
            },

            toggleCustomTime: function (value) {
                const customRow = document.getElementById('custom-time-row');
                if (customRow) {
                    customRow.style.display = value === 'custom' ? 'flex' : 'none';
                }
            },

            saveNewShift: function () {
                const siteId = document.getElementById('add-shift-site').value;
                const date = document.getElementById('add-shift-date').value;
                const shiftType = document.getElementById('add-shift-type').value;
                const guardId = document.getElementById('add-shift-guard').value || null;
                const notes = document.getElementById('add-shift-notes').value.trim();

                if (!siteId || !date) {
                    UI.toast('Please select a site and date', 'error');
                    return;
                }

                // Determine times based on shift type
                let startTime, endTime, shiftLabel;
                if (shiftType === 'custom') {
                    startTime = document.getElementById('add-shift-start').value;
                    endTime = document.getElementById('add-shift-end').value;
                    // Format to label like "9A-5P"
                    const formatTimeLabel = (t) => {
                        const [h, m] = t.split(':');
                        const hour = parseInt(h);
                        const ampm = hour >= 12 ? 'P' : 'A';
                        const h12 = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                        return h12 + ampm;
                    };
                    shiftLabel = formatTimeLabel(startTime) + '-' + formatTimeLabel(endTime);
                } else {
                    shiftLabel = shiftType;
                    const times = {
                        '8A-4P': ['08:00', '16:00'],
                        '4P-12A': ['16:00', '00:00'],
                        '12A-8A': ['00:00', '08:00']
                    };
                    [startTime, endTime] = times[shiftType] || ['08:00', '16:00'];
                }

                const newShift = {
                    id: Utils.generateId(),
                    siteId: siteId,
                    date: date,
                    shiftLabel: shiftLabel,
                    startTime: startTime,
                    endTime: endTime,
                    guardId: guardId,
                    status: guardId ? 'ASSIGNED' : 'OPEN',
                    notes: notes
                };

                const weekKey = Utils.getWeekKey(this.currentWeekStart);
                const shifts = DataStore.getScheduleForWeek(weekKey);
                shifts.push(newShift);
                DataStore.saveScheduleForWeek(weekKey, shifts);

                UI.closeModal();
                this.render();
                DashboardModule.render();

                const site = DataStore.getSiteById(siteId);
                UI.toast(`Shift added: ${site?.name || 'Unknown'} on ${Utils.formatDate(date)}`, 'success');
            },

            editShift: function (shiftId) {
                const weekKey = Utils.getWeekKey(this.currentWeekStart);
                const shifts = DataStore.getScheduleForWeek(weekKey);
                const shift = shifts.find(s => s.id === shiftId);
                if (!shift) return;

                const site = DataStore.getSiteById(shift.siteId);
                const guards = DataStore.getActiveGuards();

                // Find all shifts at this time slot (same site/date/time)
                const relatedShifts = shifts.filter(s =>
                    s.siteId === shift.siteId &&
                    s.date === shift.date &&
                    s.shiftLabel === shift.shiftLabel
                );

                if (relatedShifts.length > 1) {
                    // Multi-guard shift - show management modal
                    this.editMultiGuardShift(shift, relatedShifts, site, guards);
                } else {
                    // Single guard - show regular edit modal
                    this.editSingleShift(shift, site, guards);
                }
            },

            editSingleShift: function (shift, site, guards) {
                // Sort guards alphabetically by name
                const sortedGuards = [...guards].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                
                const content = `
                <form id="edit-shift-form">
                    <div class="form-group">
                        <label class="form-label">Site</label>
                        <input type="text" class="form-input" value="${Utils.escapeHtml(site?.name || '')}" disabled>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="text" class="form-input" value="${Utils.formatDate(shift.date)}" disabled>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Shift</label>
                            <input type="text" class="form-input" value="${shift.shiftLabel}" disabled>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Assigned Guard</label>
                        <select class="form-select" id="edit-shift-guard">
                            <option value="">â€” OPEN â€”</option>
                            ${sortedGuards.map(g => `<option value="${g.id}" ${g.id === shift.guardId ? 'selected' : ''}>${Utils.escapeHtml(g.name)}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="edit-shift-status">
                            <option value="OPEN" ${shift.status === 'OPEN' ? 'selected' : ''}>OPEN</option>
                            <option value="ASSIGNED" ${shift.status === 'ASSIGNED' ? 'selected' : ''}>ASSIGNED</option>
                            <option value="DP_CONF" ${shift.status === 'DP_CONF' ? 'selected' : ''}>DP CONFIRMED</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="edit-shift-notes" rows="2">${Utils.escapeHtml(shift.notes || '')}</textarea>
                    </div>
                </form>
            `;

                const footer = `
                <button type="button" class="btn btn-secondary" style="color: var(--color-danger); margin-right: auto;" onclick="UI.closeModal(); SchedulerModule.deleteShift('${shift.id}')">ğŸ—‘ï¸ Delete</button>
                <button type="button" class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                <button type="button" class="btn btn-secondary" onclick="SchedulerModule.addAnotherGuard('${shift.id}')">+ Add Guard</button>
                <button type="button" class="btn btn-primary" onclick="SchedulerModule.saveShift('${shift.id}')">Save Changes</button>
            `;

                UI.openModal(`Edit Shift: ${shift.shiftLabel}`, content, footer);
            },

            deleteShift: function (shiftId) {
                if (!confirm('Delete this shift? This cannot be undone.')) {
                    return;
                }
                
                // Get all schedules directly
                const allSchedules = DataStore.getSchedules();
                let found = false;
                let foundWeekKey = null;
                
                // Search through all weeks to find and remove the shift
                for (const weekKey in allSchedules) {
                    const weekShifts = allSchedules[weekKey];
                    if (!weekShifts) continue;
                    
                    const originalLength = weekShifts.length;
                    // Create new array without the deleted shift
                    const filteredShifts = weekShifts.filter(s => s.id !== shiftId);
                    
                    if (filteredShifts.length < originalLength) {
                        // Found and removed
                        allSchedules[weekKey] = filteredShifts;
                        found = true;
                        foundWeekKey = weekKey;
                        console.log('[DELETE] Removed shift from week:', weekKey, 'Before:', originalLength, 'After:', filteredShifts.length);
                        break;
                    }
                }
                
                if (!found) {
                    UI.toast('Shift not found', 'error');
                    return;
                }
                
                // Save to localStorage first, then clear cache for fresh read
                SafeStorage.set(DataStore.STORAGE_KEYS.SCHEDULES, allSchedules);
                DataStore._cache.schedules = null; // Clear cache AFTER saving
                
                // Also sync to Firestore if available
                if (foundWeekKey && DataStore._syncToFirestore) {
                    DataStore._syncToFirestore('saveScheduleForWeek', foundWeekKey, allSchedules[foundWeekKey]);
                }
                
                UI.closeModal();
                this.render();
                UI.toast('Shift deleted', 'success');
            },

            addAnotherGuard: function (shiftId) {
                // First try current week
                let weekKey = Utils.getWeekKey(this.currentWeekStart);
                let shifts = DataStore.getScheduleForWeek(weekKey) || [];
                let originalShift = shifts.find(s => s.id === shiftId);
                
                // If not found, search all schedules
                if (!originalShift) {
                    const allSchedules = DataStore.getSchedules ? DataStore.getSchedules() : {};
                    for (const wk in allSchedules) {
                        const weekShifts = allSchedules[wk] || [];
                        const found = weekShifts.find(s => s.id === shiftId);
                        if (found) {
                            weekKey = wk;
                            shifts = weekShifts;
                            originalShift = found;
                            break;
                        }
                    }
                }
                
                if (!originalShift) {
                    UI.toast('Could not find shift', 'error');
                    return;
                }
                
                // Derive times from shiftLabel if not present
                let startTime = originalShift.startTime;
                let endTime = originalShift.endTime;
                
                if (!startTime) {
                    const times = {
                        '8A-4P': ['08:00', '16:00'],
                        '4P-12A': ['16:00', '00:00'],
                        '12A-8A': ['00:00', '08:00']
                    };
                    [startTime, endTime] = times[originalShift.shiftLabel] || ['08:00', '16:00'];
                }
                
                // Create a new OPEN shift entry for the same time slot
                const newShift = {
                    id: Utils.generateId(),
                    siteId: originalShift.siteId,
                    date: originalShift.date,
                    shiftLabel: originalShift.shiftLabel,
                    startTime: startTime,
                    endTime: endTime,
                    guardId: null,
                    status: 'OPEN',
                    notes: ''
                };

                shifts.push(newShift);
                
                // Save to localStorage first, then clear cache for fresh read
                const allSchedules = DataStore.getSchedules();
                allSchedules[weekKey] = shifts;
                SafeStorage.set(DataStore.STORAGE_KEYS.SCHEDULES, allSchedules);
                DataStore._cache.schedules = null; // Clear cache AFTER saving

                UI.closeModal();
                UI.toast('Added open position - click to assign guard', 'success');
                this.render();

                // Re-open the cell to show multi-guard manager
                setTimeout(() => {
                    this.editShift(newShift.id);
                }, 200);
            },

            editMultiGuardShift: function (primaryShift, relatedShifts, site, allGuards) {
                const roleLabels = { armed: 'ğŸ›¡ï¸ Armed', unarmed: 'Unarmed', floater: 'ğŸ”„ Floater', supervisor: 'â­ Supervisor', guard: 'Guard' };

                // Sort all guards alphabetically
                const sortedAllGuards = [...allGuards].sort((a, b) => (a.name || '').localeCompare(b.name || ''));

                // Build list of current guards in this shift
                let guardsList = '';
                relatedShifts.forEach(s => {
                    const guard = sortedAllGuards.find(g => g.id === s.guardId);
                    if (guard) {
                        const roleLabel = roleLabels[guard.role] || guard.role;
                        const statusBadge = s.status === 'DP_CONF' ? 'success' : s.status === 'ASSIGNED' ? 'info' : 'warning';
                        guardsList += `
                        <div class="multi-guard-row" style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md); margin-bottom: var(--space-2);">
                            <div style="display: flex; align-items: center; gap: var(--space-3);">
                                <div>
                                    <div style="font-weight: var(--font-weight-medium);">${Utils.escapeHtml(guard.name)}</div>
                                    <div class="text-sm text-muted">${roleLabel} ${guard.phone ? 'â€¢ ' + Utils.formatPhone(guard.phone) : ''}</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: var(--space-2);">
                                <span class="badge badge-${statusBadge}">${s.status}</span>
                                <button class="btn btn-sm btn-ghost" style="color: var(--color-danger);" onclick="SchedulerModule.removeFromMultiShift('${s.id}')" title="Remove">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                </button>
                            </div>
                        </div>
                    `;
                    } else {
                        guardsList += `
                        <div class="multi-guard-row" style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-3); background: var(--color-danger-bg); border-radius: var(--radius-md); margin-bottom: var(--space-2);">
                            <div style="color: var(--color-danger); font-weight: var(--font-weight-medium);">OPEN POSITION</div>
                            <button class="btn btn-sm btn-ghost" style="color: var(--color-danger);" onclick="SchedulerModule.removeFromMultiShift('${s.id}')" title="Remove">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                    `;
                    }
                });

                // Get guards not yet assigned to this shift (already sorted)
                const assignedGuardIds = relatedShifts.map(s => s.guardId).filter(Boolean);
                const availableGuards = sortedAllGuards.filter(g => !assignedGuardIds.includes(g.id));

                const content = `
                <div class="form-group">
                    <label class="form-label">Site</label>
                    <input type="text" class="form-input" value="${Utils.escapeHtml(site?.name || '')}" disabled>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="text" class="form-input" value="${Utils.formatDate(primaryShift.date)}" disabled>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Shift</label>
                        <input type="text" class="form-input" value="${primaryShift.shiftLabel}" disabled>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Assigned Guards (${relatedShifts.length} positions)</label>
                    <div id="multi-guard-list" style="margin-top: var(--space-2);">
                        ${guardsList}
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Add Guard to Shift</label>
                    <div style="display: flex; gap: var(--space-2);">
                        <select class="form-select" id="add-guard-select" style="flex: 1;">
                            <option value="">Select guard to add...</option>
                            ${availableGuards.map(g => `<option value="${g.id}">${Utils.escapeHtml(g.name)} (${roleLabels[g.role] || g.role})</option>`).join('')}
                        </select>
                        <button type="button" class="btn btn-primary" onclick="SchedulerModule.addToMultiShift('${primaryShift.siteId}', '${primaryShift.date}', '${primaryShift.shiftLabel}', '${primaryShift.startTime}', '${primaryShift.endTime}')">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            Add
                        </button>
                    </div>
                </div>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>
            `;

                UI.openModal(`Multi-Guard Shift: ${primaryShift.shiftLabel}`, content, footer, 'lg');
            },

            addToMultiShift: function (siteId, date, shiftLabel, startTime, endTime) {
                const guardId = document.getElementById('add-guard-select').value;
                if (!guardId) {
                    UI.toast('Select Guard', 'Please select a guard to add.', 'warning');
                    return;
                }

                const weekKey = Utils.getWeekKey(this.currentWeekStart);
                const shifts = DataStore.getScheduleForWeek(weekKey);

                // Create new shift record
                const newShift = {
                    id: Utils.generateId('shift-'),
                    date: date,
                    siteId: siteId,
                    shiftLabel: shiftLabel,
                    startTime: startTime,
                    endTime: endTime,
                    guardId: guardId,
                    status: 'ASSIGNED',
                    notes: ''
                };

                shifts.push(newShift);
                DataStore.saveScheduleForWeek(weekKey, shifts);

                UI.closeModal();
                this.render();
                UI.toast('Guard Added', 'Guard has been added to the shift.', 'success');
            },

            removeFromMultiShift: function (shiftId) {
                const weekKey = Utils.getWeekKey(this.currentWeekStart);
                let shifts = DataStore.getScheduleForWeek(weekKey);

                shifts = shifts.filter(s => s.id !== shiftId);
                DataStore.saveScheduleForWeek(weekKey, shifts);

                UI.closeModal();
                this.render();
                UI.toast('Guard Removed', 'Guard has been removed from the shift.', 'success');
            },

            saveShift: function (shiftId) {
                const weekKey = Utils.getWeekKey(this.currentWeekStart);
                const shifts = DataStore.getScheduleForWeek(weekKey);
                const idx = shifts.findIndex(s => s.id === shiftId);

                if (idx !== -1) {
                    const guardId = document.getElementById('edit-shift-guard').value;
                    const status = document.getElementById('edit-shift-status').value;
                    const notes = document.getElementById('edit-shift-notes').value;
                    const currentShift = shifts[idx];
                    
                    // Check for guard conflicts (same guard, same day, overlapping time)
                    if (guardId) {
                        const conflictingShift = shifts.find(s => 
                            s.id !== shiftId &&
                            s.guardId === guardId &&
                            s.date === currentShift.date &&
                            s.startTime === currentShift.startTime
                        );
                        
                        if (conflictingShift) {
                            const guard = DataStore.getGuardById(guardId);
                            const site = DataStore.getSites().find(s => s.id === conflictingShift.siteId);
                            UI.toast(
                                'âš ï¸ Scheduling Conflict',
                                `${guard?.name || 'This guard'} is already scheduled at ${site?.name || 'another site'} for ${conflictingShift.shiftLabel} on this day.`,
                                'warning'
                            );
                            // Allow save but warn - don't block in case it's intentional
                        }
                    }

                    shifts[idx].guardId = guardId || null;
                    shifts[idx].status = guardId ? status : 'OPEN';
                    shifts[idx].notes = notes;

                    DataStore.saveScheduleForWeek(weekKey, shifts);
                    UI.closeModal();
                    this.render();
                    DashboardModule.updateNavBadges();
                    UI.toast('Shift Updated', 'Schedule has been saved.', 'success');
                }
            },

            prevWeek: function () {
                this.currentWeekStart.setDate(this.currentWeekStart.getDate() - 7);
                this.render();
            },

            nextWeek: function () {
                this.currentWeekStart.setDate(this.currentWeekStart.getDate() + 7);
                this.render();
            },

            goToToday: function () {
                this.currentWeekStart = Utils.getWeekStart(new Date());
                this.render();
            },

            exportCSV: function () {
                const weekKey = Utils.getWeekKey(this.currentWeekStart);
                const shifts = DataStore.getScheduleForWeek(weekKey);
                const sites = DataStore.getSites();
                const guards = DataStore.getGuards();

                if (shifts.length === 0) {
                    UI.toast('No Data', 'No shifts to export for this week.', 'warning');
                    return;
                }

                // Day name lookup
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

                // Sort by date, then site, then start time
                const sorted = [...shifts].sort((a, b) => {
                    if (a.date !== b.date) return a.date.localeCompare(b.date);
                    const siteA = sites.find(s => s.id === a.siteId)?.name || '';
                    const siteB = sites.find(s => s.id === b.siteId)?.name || '';
                    if (siteA !== siteB) return siteA.localeCompare(siteB);
                    return (a.startTime || '').localeCompare(b.startTime || '');
                });

                // CSV escape helper
                const escapeCSV = (val) => {
                    if (val == null) return '';
                    const str = String(val);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                };

                // Build CSV with all required columns
                let csv = 'Site,Date,Day,Shift,StartTime,EndTime,GuardName,GuardPhone,Role,Status\r\n';
                
                sorted.forEach(shift => {
                    const site = sites.find(s => s.id === shift.siteId);
                    const guard = guards.find(g => g.id === shift.guardId);
                    
                    // Get day of week from date
                    const dateObj = new Date(shift.date + 'T00:00:00');
                    const dayName = dayNames[dateObj.getDay()];
                    
                    const row = [
                        escapeCSV(site?.name || ''),
                        escapeCSV(shift.date),
                        escapeCSV(dayName),
                        escapeCSV(shift.shiftLabel),
                        escapeCSV(shift.startTime || ''),
                        escapeCSV(shift.endTime || ''),
                        escapeCSV(guard?.name || 'OPEN'),
                        escapeCSV(guard?.phone || ''),
                        escapeCSV(guard?.role || ''),
                        escapeCSV(shift.status || '')
                    ];
                    
                    csv += row.join(',') + '\r\n';
                });

                Utils.downloadFile(csv, `schedule_${weekKey}.csv`, 'text/csv');
                UI.toast('Export Complete', `Exported ${sorted.length} shifts to CSV.`, 'success');
            },

            copyLastWeek: function () {
                // Get last week's date
                const lastWeekStart = new Date(this.currentWeekStart);
                lastWeekStart.setDate(lastWeekStart.getDate() - 7);
                
                const lastWeekKey = Utils.getWeekKey(lastWeekStart);
                const currentWeekKey = Utils.getWeekKey(this.currentWeekStart);
                
                const lastWeekShifts = DataStore.getScheduleForWeek(lastWeekKey);
                const currentWeekShifts = DataStore.getScheduleForWeek(currentWeekKey);
                
                if (lastWeekShifts.length === 0) {
                    UI.toast('No Data', 'Last week has no schedule to copy.', 'warning');
                    return;
                }
                
                // Check if current week already has shifts
                const hasAssignments = currentWeekShifts.some(s => s.guardId);
                
                if (hasAssignments) {
                    UI.confirm(
                        'Overwrite Schedule?',
                        `This week already has ${currentWeekShifts.filter(s => s.guardId).length} assigned shifts. Copy last week's assignments anyway?`,
                        () => this._performCopyLastWeek(lastWeekShifts, currentWeekKey)
                    );
                } else {
                    this._performCopyLastWeek(lastWeekShifts, currentWeekKey);
                }
            },
            
            _performCopyLastWeek: function (lastWeekShifts, currentWeekKey) {
                const currentWeekStart = this.currentWeekStart;
                const days = Utils.getDaysOfWeek(currentWeekStart);
                const existingShifts = DataStore.getScheduleForWeek(currentWeekKey);
                
                // Map day of week (0-6) to new dates
                const dayMap = {};
                days.forEach(d => {
                    dayMap[d.getDay()] = Utils.toISODate(d);
                });
                
                // Build set of existing shift keys for duplicate detection
                // Key includes: siteId + date + shiftLabel + guardId
                const existingKeys = new Set();
                existingShifts.forEach(s => {
                    const key = `${s.siteId}|${s.date}|${s.shiftLabel}|${s.guardId || 'OPEN'}`;
                    existingKeys.add(key);
                });
                
                // Create new shifts based on last week, checking for duplicates
                let copied = 0;
                let skipped = 0;
                
                lastWeekShifts.forEach(shift => {
                    const oldDate = new Date(shift.date + 'T00:00:00');
                    const dayOfWeek = oldDate.getDay();
                    const newDate = dayMap[dayOfWeek];
                    
                    // Key includes guardId to allow same shift with different guards
                    const newKey = `${shift.siteId}|${newDate}|${shift.shiftLabel}|${shift.guardId || 'OPEN'}`;
                    
                    // Skip if this exact site/date/shift/guard combo already exists
                    if (existingKeys.has(newKey)) {
                        skipped++;
                        return;
                    }
                    
                    const newShift = {
                        ...shift,
                        id: Utils.generateId('shift-'),
                        date: newDate,
                        status: shift.guardId ? 'ASSIGNED' : 'OPEN',
                        notes: '' // Don't copy notes
                    };
                    
                    existingShifts.push(newShift);
                    existingKeys.add(newKey);
                    copied++;
                });
                
                // Save merged schedule
                DataStore.saveScheduleForWeek(currentWeekKey, existingShifts);
                
                // Re-render
                this.renderGrid();
                
                if (skipped > 0) {
                    UI.toast('Schedule Copied', `${copied} shifts copied, ${skipped} skipped`, 'success');
                } else {
                    UI.toast('Schedule Copied', `${copied} shifts copied`, 'success');
                }
            },

            removeDuplicates: function () {
                const weekKey = Utils.getWeekKey(this.currentWeekStart);
                const result = DataStore.deduplicateWeekSchedule(weekKey);
                
                if (result.removed > 0) {
                    this.renderGrid();
                    UI.toast('Duplicates Removed', `${result.removed} removed, ${result.remaining} remaining`, 'success');
                } else {
                    UI.toast('No Duplicates', 'No duplicate shifts found for this week.', 'info');
                }
            },

            clearWeek: function () {
                const weekKey = Utils.getWeekKey(this.currentWeekStart);
                const shifts = DataStore.getScheduleForWeek(weekKey);
                
                if (shifts.length === 0) {
                    UI.toast('Already Empty', 'This week has no schedule data.', 'info');
                    return;
                }
                
                UI.confirm(
                    'âš ï¸ Clear Week Schedule',
                    `This will delete all ${shifts.length} shifts for this week. This cannot be undone. Continue?`,
                    () => {
                        const removed = DataStore.clearWeekSchedule(weekKey);
                        this.renderGrid();
                        UI.toast('Week Cleared', `${removed} shifts removed`, 'success');
                    }
                );
            },

            showDayDetail: function (dateStr) {
                const weekKey = Utils.getWeekKey(this.currentWeekStart);
                const shifts = DataStore.getScheduleForWeek(weekKey).filter(s => s.date === dateStr);
                const sites = DataStore.getSites();
                const guards = DataStore.getGuards();

                // Parse date without timezone shift (append T00:00:00 for local interpretation)
                const date = new Date(dateStr + 'T00:00:00');
                const dayLabel = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

                // Group shifts by site
                const shiftsBySite = {};
                shifts.forEach(shift => {
                    if (!shiftsBySite[shift.siteId]) {
                        shiftsBySite[shift.siteId] = [];
                    }
                    shiftsBySite[shift.siteId].push(shift);
                });

                const roleLabels = { armed: 'ğŸ›¡ï¸ Armed', unarmed: 'Unarmed', floater: 'ğŸ”„ Floater', supervisor: 'â­ Supervisor', guard: 'Guard' };

                let content = `<div style="max-height: 60vh; overflow-y: auto;">`;

                // Stats
                const totalShifts = shifts.length;
                const filledShifts = shifts.filter(s => s.guardId).length;
                const openShifts = totalShifts - filledShifts;

                content += `
                <div class="csv-import-stats" style="margin-bottom: var(--space-5);">
                    <div class="csv-import-stat">
                        <div class="csv-import-stat-value">${totalShifts}</div>
                        <div class="csv-import-stat-label">Total Shifts</div>
                    </div>
                    <div class="csv-import-stat">
                        <div class="csv-import-stat-value" style="color: var(--color-success);">${filledShifts}</div>
                        <div class="csv-import-stat-label">Filled</div>
                    </div>
                    <div class="csv-import-stat">
                        <div class="csv-import-stat-value" style="color: var(--color-danger);">${openShifts}</div>
                        <div class="csv-import-stat-label">Open</div>
                    </div>
                </div>
            `;

                // Shifts by site
                for (const [siteId, siteShifts] of Object.entries(shiftsBySite)) {
                    const site = sites.find(s => s.id === siteId);
                    content += `
                    <div class="card" style="margin-bottom: var(--space-4);">
                        <div class="card-header" style="padding: var(--space-3) var(--space-4);">
                            <h4 style="font-weight: var(--font-weight-semibold); font-size: var(--font-size-base);">${Utils.escapeHtml(site?.name || 'Unknown Site')}</h4>
                        </div>
                        <div class="card-body" style="padding: var(--space-3) var(--space-4);">
                            <table class="table" style="font-size: var(--font-size-sm);">
                                <thead>
                                    <tr>
                                        <th>Shift</th>
                                        <th>Guard</th>
                                        <th>Role</th>
                                        <th>Phone</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                    siteShifts.sort((a, b) => (a.startTime || '00:00').localeCompare(b.startTime || '00:00'));

                    siteShifts.forEach(shift => {
                        const guard = guards.find(g => g.id === shift.guardId);
                        const statusClass = shift.status === 'OPEN' ? 'danger' : shift.status === 'DP_CONF' ? 'success' : 'info';

                        content += `
                        <tr>
                            <td><strong>${shift.shiftLabel}</strong></td>
                            <td>${guard ? Utils.escapeHtml(guard.name) : '<span class="text-danger">OPEN</span>'}</td>
                            <td>${guard ? roleLabels[guard.role] || guard.role : 'â€”'}</td>
                            <td>${guard?.phone ? `<a href="tel:${guard.phone}">${Utils.formatPhone(guard.phone)}</a>` : 'â€”'}</td>
                            <td><span class="badge badge-${statusClass}">${shift.status}</span></td>
                        </tr>
                    `;
                    });

                    content += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                }

                if (Object.keys(shiftsBySite).length === 0) {
                    content += `<div class="empty-state"><p>No shifts scheduled for this day.</p></div>`;
                }

                content += '</div>';

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>
                <button class="btn btn-primary" onclick="UI.closeModal(); window.print();">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                    Print Day
                </button>
            `;

                UI.openModal(dayLabel, content, footer, 'lg');
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INCIDENTS MODULE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const IncidentsModule = {
            filters: { site: '', severity: '', status: '', search: '' },
            selectedRows: new Set(),

            // Workflow states with metadata
            workflowStates: {
                'Open': { label: 'Open', badge: 'danger', icon: 'ğŸ”´', next: ['In Progress', 'Under Investigation', 'Escalated'] },
                'In Progress': { label: 'In Progress', badge: 'warning', icon: 'ğŸŸ¡', next: ['Under Investigation', 'Pending Review', 'Resolved'] },
                'Under Investigation': { label: 'Under Investigation', badge: 'info', icon: 'ğŸ”', next: ['In Progress', 'Pending Review', 'Escalated'] },
                'Pending Review': { label: 'Pending Client Review', badge: 'warning', icon: 'â³', next: ['In Progress', 'Resolved', 'Closed'] },
                'Escalated': { label: 'Escalated', badge: 'danger', icon: 'âš ï¸', next: ['In Progress', 'Under Investigation', 'Resolved'] },
                'Resolved': { label: 'Resolved', badge: 'success', icon: 'âœ…', next: ['Closed', 'Open'] },
                'Closed': { label: 'Closed', badge: 'neutral', icon: 'ğŸ“', next: ['Open'] }
            },

            // Incident templates for quick logging
            templates: {
                trespass: {
                    type: 'Trespassing',
                    severity: 'Medium',
                    narrative: 'At approximately [TIME], security observed an unauthorized individual [DESCRIPTION] in [LOCATION]. The individual was approached and asked to provide identification. [OUTCOME]. Police were [CALLED/NOT CALLED]. Photos attached: [YES/NO].'
                },
                medical: {
                    type: 'Medical Emergency',
                    severity: 'High',
                    narrative: 'At approximately [TIME], security responded to a medical emergency in [LOCATION]. Patient: [NAME/UNKNOWN], Age: [AGE/UNKNOWN]. Symptoms/Condition: [DESCRIPTION]. First aid administered: [YES/NO - DETAILS]. EMS called at [TIME], arrived at [TIME]. Patient transported to [HOSPITAL/REFUSED TRANSPORT].'
                },
                theft: {
                    type: 'Theft/Larceny',
                    severity: 'High',
                    narrative: 'At approximately [TIME], [VICTIM] reported theft of [ITEMS] from [LOCATION]. Estimated value: $[AMOUNT]. Last seen: [TIME/DATE]. Suspect description: [DESCRIPTION/UNKNOWN]. Witnesses: [NAMES/NONE]. Police report filed: [YES - REPORT #/NO].'
                },
                property: {
                    type: 'Property Damage',
                    severity: 'Medium',
                    narrative: 'At approximately [TIME], security discovered/was notified of damage to [PROPERTY] in [LOCATION]. Description of damage: [DETAILS]. Cause: [KNOWN CAUSE/UNDER INVESTIGATION]. Estimated repair cost: $[AMOUNT/UNKNOWN]. Maintenance notified: [YES/NO]. Photos attached: [YES/NO].'
                },
                disturbance: {
                    type: 'Disturbance/Disorderly Conduct',
                    severity: 'Medium',
                    narrative: 'At approximately [TIME], security responded to a disturbance in [LOCATION]. Parties involved: [NAMES/DESCRIPTIONS]. Nature of disturbance: [DETAILS]. Actions taken: [VERBAL WARNING/ESCORT OUT/POLICE CALLED]. Injuries reported: [YES - DETAILS/NO].'
                },
                fire_alarm: {
                    type: 'Fire Alarm Activation',
                    severity: 'High',
                    narrative: 'At [TIME], fire alarm activated in [BUILDING/ZONE]. Cause: [ACTUAL FIRE/FALSE ALARM/COOKING/DUST/MALFUNCTION]. Evacuation conducted: [YES/NO]. Fire department responded: [YES - ARRIVAL TIME/NO]. Building cleared for re-entry at [TIME]. Alarm reset by [NAME].'
                },
                suspicious: {
                    type: 'Suspicious Activity',
                    severity: 'Low',
                    narrative: 'At approximately [TIME], security observed suspicious activity in [LOCATION]. Description: [PERSON/VEHICLE/BEHAVIOR]. Actions taken: [MONITORED/APPROACHED/REPORTED]. Outcome: [DETAILS]. Follow-up required: [YES/NO].'
                },
                elevator: {
                    type: 'Elevator Entrapment',
                    severity: 'High',
                    narrative: 'At [TIME], received report of elevator entrapment in [ELEVATOR ID/LOCATION]. Occupant(s): [NUMBER] person(s). Communication established: [YES/NO]. Elevator company contacted at [TIME]. Fire department called: [YES/NO]. Occupants freed at [TIME]. Injuries: [YES - DETAILS/NO].'
                }
            },

            init: function () {
                document.getElementById('new-incident-btn')?.addEventListener('click', () => this.openNewIncidentModal());
                document.getElementById('export-incidents-csv')?.addEventListener('click', () => this.exportCSV());

                document.getElementById('incident-search')?.addEventListener('input', Utils.debounce((e) => {
                    this.filters.search = e.target.value.toLowerCase();
                    this.renderTable();
                }, 200));

                document.getElementById('incident-filter-site')?.addEventListener('change', (e) => {
                    this.filters.site = e.target.value;
                    this.renderTable();
                });

                document.getElementById('incident-filter-severity')?.addEventListener('change', (e) => {
                    this.filters.severity = e.target.value;
                    this.renderTable();
                });

                document.getElementById('incident-filter-status')?.addEventListener('change', (e) => {
                    this.filters.status = e.target.value;
                    this.renderTable();
                });
            },

            render: function () {
                UI.populateSiteSelect('incident-filter-site', true);
                this.renderStats();
                this.renderTable();
            },
            
            // Render stats panel
            renderStats: function() {
                const incidents = DataStore.getIncidents();
                const open = incidents.filter(i => i.status === 'Open').length;
                const inProgress = incidents.filter(i => ['In Progress', 'Under Investigation'].includes(i.status)).length;
                const escalated = incidents.filter(i => i.status === 'Escalated').length;
                const pendingReview = incidents.filter(i => i.status === 'Pending Review').length;
                
                // Check for overdue follow-ups
                const today = new Date().toISOString().slice(0, 10);
                const overdue = incidents.filter(i => 
                    i.followUp?.dueDate && 
                    i.followUp.dueDate < today && 
                    !['Resolved', 'Closed'].includes(i.status)
                ).length;
                
                const statsContainer = document.getElementById('incidents-stats');
                if (!statsContainer) return;
                
                statsContainer.innerHTML = `
                    <div style="display: flex; gap: var(--space-3); flex-wrap: wrap; margin-bottom: var(--space-4);">
                        <div style="flex: 1; min-width: 100px; background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md); text-align: center; cursor: pointer;" onclick="IncidentsModule.quickFilter('Open')">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-danger);">${open}</div>
                            <div class="text-xs text-muted">Open</div>
                        </div>
                        <div style="flex: 1; min-width: 100px; background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md); text-align: center; cursor: pointer;" onclick="IncidentsModule.quickFilter('inprogress')">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-warning);">${inProgress}</div>
                            <div class="text-xs text-muted">In Progress</div>
                        </div>
                        <div style="flex: 1; min-width: 100px; background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md); text-align: center; cursor: pointer;" onclick="IncidentsModule.quickFilter('Escalated')">
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${escalated > 0 ? 'var(--color-danger)' : 'var(--color-text-muted)'};">${escalated}</div>
                            <div class="text-xs text-muted">Escalated</div>
                        </div>
                        <div style="flex: 1; min-width: 100px; background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md); text-align: center; cursor: pointer;" onclick="IncidentsModule.quickFilter('Pending Review')">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-info);">${pendingReview}</div>
                            <div class="text-xs text-muted">Pending Review</div>
                        </div>
                        <div style="flex: 1; min-width: 100px; background: ${overdue > 0 ? 'var(--color-danger-bg)' : 'var(--color-surface-elevated)'}; padding: var(--space-3); border-radius: var(--radius-md); text-align: center; cursor: pointer;" onclick="IncidentsModule.showOverdueFollowups()">
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${overdue > 0 ? 'var(--color-danger)' : 'var(--color-success)'};">${overdue > 0 ? overdue : 'âœ“'}</div>
                            <div class="text-xs text-muted">${overdue > 0 ? 'Overdue' : 'Follow-ups OK'}</div>
                        </div>
                    </div>
                `;
            },
            
            // Quick filter helper
            quickFilter: function(status) {
                // Store the filter to apply
                if (status === 'inprogress') {
                    this.filters.status = 'In Progress';
                } else {
                    this.filters.status = status;
                }
                
                // Navigate to incidents page first if not already there
                if (Router.currentRoute !== 'incidents') {
                    Router.navigate('incidents');
                    // Apply filter after navigation completes
                    setTimeout(() => {
                        const filterEl = document.getElementById('incident-filter-status');
                        if (filterEl) filterEl.value = this.filters.status;
                        this.renderTable();
                    }, 100);
                } else {
                    const filterEl = document.getElementById('incident-filter-status');
                    if (filterEl) filterEl.value = this.filters.status;
                    this.renderTable();
                }
            },
            
            // Show overdue follow-ups modal
            showOverdueFollowups: function() {
                const incidents = DataStore.getIncidents();
                const today = new Date().toISOString().slice(0, 10);
                const overdue = incidents.filter(i => 
                    i.followUp?.dueDate && 
                    i.followUp.dueDate < today && 
                    !['Resolved', 'Closed'].includes(i.status)
                );
                const sites = DataStore.getSites();
                
                if (overdue.length === 0) {
                    UI.toast('All follow-ups are on track!', 'success');
                    return;
                }
                
                let content = '<div style="max-height: 60vh; overflow-y: auto;">';
                
                overdue.forEach(inc => {
                    const site = sites.find(s => s.id === inc.siteId);
                    const daysOverdue = Math.ceil((new Date() - new Date(inc.followUp.dueDate)) / (1000 * 60 * 60 * 24));
                    
                    content += `
                        <div style="padding: var(--space-3); background: var(--color-danger-bg); border-left: 3px solid var(--color-danger); border-radius: var(--radius-md); margin-bottom: var(--space-2);">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <div class="font-medium">${inc.id}</div>
                                    <div class="text-sm">${Utils.escapeHtml(site?.name || 'Unknown')} Â· ${Utils.escapeHtml(inc.type)}</div>
                                    <div class="text-sm text-danger">${daysOverdue} day(s) overdue</div>
                                    ${inc.followUp.notes ? `<div class="text-sm text-muted" style="margin-top: 4px;">${Utils.escapeHtml(inc.followUp.notes)}</div>` : ''}
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="UI.closeModal(); IncidentsModule.viewIncident('${inc.id}')">View</button>
                            </div>
                        </div>
                    `;
                });
                
                content += '</div>';
                UI.openModal(`${overdue.length} Overdue Follow-ups`, content, '<button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>', 'md');
            },
            
            // Add activity log entry
            addActivityLog: function(incidentId, action, details = '') {
                const incidents = DataStore.getIncidents();
                const idx = incidents.findIndex(i => i.id === incidentId);
                if (idx === -1) return;
                
                if (!incidents[idx].activityLog) {
                    incidents[idx].activityLog = [];
                }
                
                incidents[idx].activityLog.push({
                    timestamp: new Date().toISOString(),
                    action: action,
                    details: details,
                    user: 'System' // Could be enhanced with actual user tracking
                });
                
                DataStore.saveIncidents(incidents);
            },

            renderTable: function () {
                let incidents = DataStore.getIncidents();
                const sites = DataStore.getSites();
                const today = new Date().toISOString().slice(0, 10);

                // Apply filters
                if (this.filters.site) incidents = incidents.filter(i => i.siteId === this.filters.site);
                if (this.filters.severity) incidents = incidents.filter(i => i.severity === this.filters.severity);
                if (this.filters.status) incidents = incidents.filter(i => i.status === this.filters.status);
                if (this.filters.search) {
                    incidents = incidents.filter(i =>
                        i.type.toLowerCase().includes(this.filters.search) ||
                        i.narrative.toLowerCase().includes(this.filters.search) ||
                        i.id.toLowerCase().includes(this.filters.search)
                    );
                }

                const tbody = document.getElementById('incidents-tbody');
                const severityClass = { 'Critical': 'danger', 'High': 'danger', 'Medium': 'warning', 'Low': 'info' };
                const severityOrder = { 'Critical': 4, 'High': 3, 'Medium': 2, 'Low': 1 };

                // Clear invalid selections (deleted items)
                const validIds = new Set(incidents.map(i => i.id));
                this.selectedRows = new Set([...this.selectedRows].filter(id => validIds.has(id)));
                this.updateBulkBar();

                if (incidents.length === 0) {
                    const hasFilters = this.filters.site || this.filters.severity || this.filters.status || this.filters.search;
                    const message = hasFilters
                        ? 'No incidents match current filters. Try adjusting or clearing filters.'
                        : 'No incidents recorded yet.';
                    tbody.innerHTML = `<tr><td colspan="8" class="text-muted" style="text-align: center; padding: var(--space-8);">${message}</td></tr>`;
                    return;
                }

                tbody.innerHTML = incidents.map(inc => {
                    const site = sites.find(s => s.id === inc.siteId);
                    const isSelected = this.selectedRows.has(inc.id);
                    const ws = this.workflowStates[inc.status] || this.workflowStates['Open'];
                    
                    // Check for overdue follow-up
                    const isOverdue = inc.followUp?.dueDate && inc.followUp.dueDate < today && !['Resolved', 'Closed'].includes(inc.status);
                    const hasFollowUp = inc.followUp?.dueDate;
                    
                    // Indicators
                    let indicators = '';
                    if (isOverdue) indicators += '<span title="Follow-up overdue" style="color: var(--color-danger);">â°</span> ';
                    if (inc.clientNotification?.notifiedDate) indicators += '<span title="Client notified" style="color: var(--color-success);">ğŸ“§</span> ';
                    if ((inc.attachments || []).length > 0) indicators += '<span title="Has attachments">ğŸ“</span> ';
                    if ((inc.activityLog || []).length > 2) indicators += '<span title="Activity logged">ğŸ“</span> ';
                    
                    return `
                    <tr class="${isSelected ? 'selected' : ''} ${isOverdue ? 'overdue-row' : ''}" data-id="${inc.id}" style="${isOverdue ? 'background: var(--color-danger-bg);' : ''}">
                        <td><input type="checkbox" class="row-checkbox" ${isSelected ? 'checked' : ''} onchange="IncidentsModule.toggleRow('${inc.id}', this.checked)"></td>
                        <td data-label="ID">
                            <span class="font-medium">${inc.id}</span>
                            ${indicators ? `<div style="font-size: 0.75rem; margin-top: 2px;">${indicators}</div>` : ''}
                        </td>
                        <td data-label="Site">${Utils.escapeHtml(site?.name || 'Unknown')}</td>
                        <td data-label="Date/Time">${Utils.formatDateTime(inc.dateTime)}</td>
                        <td data-label="Type">${Utils.escapeHtml(inc.type)}</td>
                        <td data-label="Severity" data-sort-value="${severityOrder[inc.severity] || 0}"><span class="badge badge-${severityClass[inc.severity]}">${inc.severity}</span></td>
                        <td data-label="Status"><span class="badge badge-${ws.badge}" title="${ws.label}">${ws.icon} ${inc.status}</span></td>
                        <td data-label="Actions">
                            <div class="flex gap-2">
                                <button class="btn btn-sm btn-ghost" onclick="IncidentsModule.viewIncident('${inc.id}')" title="View">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                                </button>
                                <button class="btn btn-sm btn-ghost" onclick="IncidentsModule.editIncident('${inc.id}')" title="Edit">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                </button>
                                <button class="btn btn-sm btn-ghost" onclick="IncidentsModule.quickStatusChange('${inc.id}')" title="Change Status">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                }).join('');

                // Update select-all checkbox state
                const selectAll = document.getElementById('incidents-select-all');
                if (selectAll) {
                    selectAll.checked = incidents.length > 0 && this.selectedRows.size === incidents.length;
                    selectAll.indeterminate = this.selectedRows.size > 0 && this.selectedRows.size < incidents.length;
                }
            },
            
            // Quick status change modal
            quickStatusChange: function(id) {
                const incident = DataStore.getIncidents().find(i => i.id === id);
                if (!incident) return;
                
                const ws = this.workflowStates[incident.status] || this.workflowStates['Open'];
                const nextStates = ws.next || [];
                
                let content = `
                    <p class="text-muted" style="margin-bottom: var(--space-3);">Current: <strong>${ws.icon} ${incident.status}</strong></p>
                    <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                `;
                
                nextStates.forEach(status => {
                    const nextWs = this.workflowStates[status];
                    content += `
                        <button class="btn btn-secondary" style="justify-content: flex-start;" onclick="IncidentsModule.setStatus('${id}', '${status}')">
                            ${nextWs.icon} ${nextWs.label}
                        </button>
                    `;
                });
                
                content += '</div>';
                
                // Add resolution notes if moving to Resolved/Closed
                content += `
                    <div id="resolution-section" style="display: none; margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--color-border);">
                        <div class="form-group">
                            <label class="form-label">Resolution Notes</label>
                            <textarea class="form-textarea" id="quick-resolution-notes" rows="3" placeholder="Describe how this was resolved..."></textarea>
                        </div>
                    </div>
                `;
                
                UI.openModal(`Update Status: ${incident.id}`, content, '<button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>');
            },
            
            // Set status with activity logging
            setStatus: function(id, newStatus) {
                const incidents = DataStore.getIncidents();
                const idx = incidents.findIndex(i => i.id === id);
                if (idx === -1) return;
                
                const oldStatus = incidents[idx].status;
                incidents[idx].status = newStatus;
                incidents[idx].updatedAt = new Date().toISOString();
                
                // Add resolution data if applicable
                if (['Resolved', 'Closed'].includes(newStatus)) {
                    const notes = document.getElementById('quick-resolution-notes')?.value;
                    if (!incidents[idx].resolution) incidents[idx].resolution = {};
                    incidents[idx].resolution.date = new Date().toISOString();
                    if (notes) incidents[idx].resolution.notes = notes;
                }
                
                // Add activity log
                if (!incidents[idx].activityLog) incidents[idx].activityLog = [];
                incidents[idx].activityLog.push({
                    timestamp: new Date().toISOString(),
                    action: 'Status Changed',
                    details: `${oldStatus} â†’ ${newStatus}`,
                    user: 'System'
                });
                
                DataStore.saveIncidents(incidents);
                UI.closeModal();
                this.render();
                DashboardModule.updateNavBadges();
                UI.notify(`Status updated to ${newStatus}`, 'success');
            },

            // Bulk selection methods
            toggleRow: function (id, checked) {
                if (checked) {
                    this.selectedRows.add(id);
                } else {
                    this.selectedRows.delete(id);
                }

                // Update row visual
                const row = document.querySelector(`tr[data-id="${id}"]`);
                if (row) row.classList.toggle('selected', checked);

                this.updateBulkBar();

                // Update select-all checkbox
                const allIncidents = DataStore.getIncidents();
                const selectAll = document.getElementById('incidents-select-all');
                if (selectAll) {
                    selectAll.checked = this.selectedRows.size === allIncidents.length;
                    selectAll.indeterminate = this.selectedRows.size > 0 && this.selectedRows.size < allIncidents.length;
                }
            },

            toggleSelectAll: function (checked) {
                const incidents = DataStore.getIncidents();

                if (checked) {
                    incidents.forEach(i => this.selectedRows.add(i.id));
                } else {
                    this.selectedRows.clear();
                }

                this.renderTable();
            },

            clearSelection: function () {
                this.selectedRows.clear();
                document.getElementById('incidents-select-all').checked = false;
                this.renderTable();
            },

            updateBulkBar: function () {
                const bar = document.getElementById('incidents-bulk-bar');
                const count = document.getElementById('incidents-selected-count');

                if (this.selectedRows.size > 0) {
                    bar.style.display = 'flex';
                    count.textContent = this.selectedRows.size;
                } else {
                    bar.style.display = 'none';
                }
            },

            bulkUpdateStatus: function (newStatus) {
                if (this.selectedRows.size === 0) return;

                const incidents = DataStore.getIncidents();
                let updated = 0;

                incidents.forEach(inc => {
                    if (this.selectedRows.has(inc.id)) {
                        inc.status = newStatus;
                        updated++;
                    }
                });

                DataStore.saveIncidents(incidents);
                this.selectedRows.clear();
                this.renderTable();
                DashboardModule.updateNavBadges();
                UI.toast('Bulk Update', `${updated} incident(s) marked as ${newStatus}.`, 'success');
            },

            bulkDelete: async function () {
                if (this.selectedRows.size === 0) return;

                const confirmed = await UI.confirm(
                    'Delete Selected Incidents',
                    `Are you sure you want to delete ${this.selectedRows.size} incident(s)? This cannot be undone.`
                );

                if (!confirmed) return;

                let incidents = DataStore.getIncidents();
                const deleteCount = this.selectedRows.size;

                incidents = incidents.filter(i => !this.selectedRows.has(i.id));

                DataStore.saveIncidents(incidents);
                this.selectedRows.clear();
                this.renderTable();
                DashboardModule.updateNavBadges();
                UI.toast('Bulk Delete', `${deleteCount} incident(s) deleted.`, 'success');
            },

            openNewIncidentModal: function () {
                const sites = DataStore.getSites();
                const guards = DataStore.getActiveGuards();
                const now = new Date();
                const nowStr = now.toISOString().slice(0, 16);

                // Build template options
                const templateOptions = Object.entries(this.templates).map(([key, t]) =>
                    `<option value="${key}">${Utils.escapeHtml(t.type)}</option>`
                ).join('');

                const content = `
                <form id="new-incident-form">
                    <div class="form-group" style="margin-bottom: var(--space-4); padding-bottom: var(--space-4); border-bottom: 1px solid var(--color-border);">
                        <label class="form-label">Quick Template</label>
                        <select class="form-select" id="inc-template" onchange="IncidentsModule.applyTemplate(this.value)">
                            <option value="">â€” Start from scratch â€”</option>
                            ${templateOptions}
                        </select>
                        <p class="text-sm text-muted mt-1">Select a template to pre-fill common incident types</p>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Date/Time *</label>
                            <input type="datetime-local" class="form-input" id="inc-datetime" value="${nowStr}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Site *</label>
                            <select class="form-select" id="inc-site" required>
                                <option value="">Select site...</option>
                                ${sites.map(s => `<option value="${s.id}">${Utils.escapeHtml(s.name)}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Type *</label>
                            <input type="text" class="form-input" id="inc-type" placeholder="e.g., DV incident, flooding, elevator outage" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Severity *</label>
                            <select class="form-select" id="inc-severity" required>
                                <option value="Low">Low</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="High">High</option>
                                <option value="Critical">Critical</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Guard(s) Involved</label>
                        <select class="form-select" id="inc-guards">
                            <option value="">None selected</option>
                            ${guards.map(g => `<option value="${g.id}">${Utils.escapeHtml(g.name)}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reported By *</label>
                        <input type="text" class="form-input" id="inc-reported-by" placeholder="Guard name, Client, Resident, etc." required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Narrative *</label>
                        <textarea class="form-textarea" id="inc-narrative" rows="4" placeholder="Describe the incident in detail..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="inc-status">
                            <option value="Open" selected>Open</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Resolved">Resolved</option>
                        </select>
                    </div>
                </form>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="IncidentsModule.saveNewIncident()">Create Incident</button>
            `;

                UI.openModal('New Incident Report', content, footer, 'lg');
            },

            applyTemplate: function (templateKey) {
                if (!templateKey || !this.templates[templateKey]) return;

                const template = this.templates[templateKey];
                document.getElementById('inc-type').value = template.type;
                document.getElementById('inc-severity').value = template.severity;
                document.getElementById('inc-narrative').value = template.narrative;

                // Focus narrative for editing
                document.getElementById('inc-narrative').focus();
            },

            saveNewIncident: function () {
                const form = document.getElementById('new-incident-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const incidents = DataStore.getIncidents();
                
                // Generate ID in format INC-YYYYMMDD-####
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
                const todayPrefix = `INC-${dateStr}`;
                const todayIncidents = incidents.filter(i => i.id && i.id.startsWith(todayPrefix));
                const seq = String(todayIncidents.length + 1).padStart(4, '0');
                const incidentId = `${todayPrefix}-${seq}`;

                const incident = {
                    id: incidentId,
                    siteId: document.getElementById('inc-site').value,
                    dateTime: new Date(document.getElementById('inc-datetime').value).toISOString(),
                    guardIds: document.getElementById('inc-guards').value ? [document.getElementById('inc-guards').value] : [],
                    type: document.getElementById('inc-type').value,
                    severity: document.getElementById('inc-severity').value,
                    narrative: document.getElementById('inc-narrative').value,
                    reportedBy: document.getElementById('inc-reported-by').value,
                    attachments: [],
                    status: document.getElementById('inc-status').value,
                    createdAt: now.toISOString()
                };

                DataStore.addIncident(incident);
                UI.closeModal();
                this.renderTable();
                DashboardModule.updateNavBadges();
                UI.toast('Incident Created', `${incident.id} has been logged.`, 'success');
            },

            viewIncident: function (id) {
                const incident = DataStore.getIncidents().find(i => i.id === id);
                if (!incident) return;

                const site = DataStore.getSiteById(incident.siteId);
                const ws = this.workflowStates[incident.status] || this.workflowStates['Open'];
                const today = new Date().toISOString().slice(0, 10);
                const isOverdue = incident.followUp?.dueDate && incident.followUp.dueDate < today && !['Resolved', 'Closed'].includes(incident.status);
                
                // Build clickable guard links
                const guardLinks = (incident.guardIds || []).map(gid => {
                    const guard = DataStore.getGuardById(gid);
                    if (!guard) return 'Unknown';
                    return `<a class="perf-link" onclick="UI.closeModal(); GuardPerformanceModule.openProfile('${gid}');">${Utils.escapeHtml(guard.name)}</a>`;
                }).join(', ');
                
                // Activity log HTML
                const activityLog = incident.activityLog || [];
                const activityHtml = activityLog.length > 0 
                    ? activityLog.slice().reverse().map(log => `
                        <div style="display: flex; gap: var(--space-3); padding: var(--space-2) 0; border-bottom: 1px solid var(--color-border);">
                            <div class="text-xs text-muted" style="min-width: 120px;">${new Date(log.timestamp).toLocaleString()}</div>
                            <div>
                                <div class="text-sm font-medium">${Utils.escapeHtml(log.action)}</div>
                                ${log.details ? `<div class="text-xs text-muted">${Utils.escapeHtml(log.details)}</div>` : ''}
                            </div>
                        </div>
                    `).join('')
                    : '<div class="text-muted text-center" style="padding: var(--space-4);">No activity recorded</div>';

                const content = `
                <div style="max-height: 70vh; overflow-y: auto;">
                    <!-- Status Header -->
                    <div style="display: flex; gap: var(--space-2); margin-bottom: var(--space-4); flex-wrap: wrap;">
                        <span class="badge badge-${incident.severity === 'Critical' || incident.severity === 'High' ? 'danger' : incident.severity === 'Medium' ? 'warning' : 'info'}">${incident.severity}</span>
                        <span class="badge badge-${ws.badge}">${ws.icon} ${incident.status}</span>
                        ${isOverdue ? '<span class="badge badge-danger">â° Follow-up Overdue</span>' : ''}
                        ${incident.clientNotification?.notifiedDate ? '<span class="badge badge-success">ğŸ“§ Client Notified</span>' : ''}
                    </div>
                    
                    <!-- Tab Navigation -->
                    <div style="display: flex; gap: var(--space-1); margin-bottom: var(--space-4); border-bottom: 1px solid var(--color-border);">
                        <button type="button" class="inc-tab-btn active" data-tab="details" onclick="IncidentsModule.switchViewTab('details')" style="padding: var(--space-2) var(--space-4); background: none; border: none; border-bottom: 2px solid var(--color-primary); color: var(--color-primary); cursor: pointer; font-weight: 500;">
                            Details
                        </button>
                        <button type="button" class="inc-tab-btn" data-tab="followup" onclick="IncidentsModule.switchViewTab('followup')" style="padding: var(--space-2) var(--space-4); background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-text-muted); cursor: pointer;">
                            Follow-up ${incident.followUp?.dueDate ? (isOverdue ? 'âš ï¸' : 'ğŸ“…') : ''}
                        </button>
                        <button type="button" class="inc-tab-btn" data-tab="client" onclick="IncidentsModule.switchViewTab('client')" style="padding: var(--space-2) var(--space-4); background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-text-muted); cursor: pointer;">
                            Client ${incident.clientNotification?.notifiedDate ? 'âœ“' : ''}
                        </button>
                        <button type="button" class="inc-tab-btn" data-tab="activity" onclick="IncidentsModule.switchViewTab('activity')" style="padding: var(--space-2) var(--space-4); background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-text-muted); cursor: pointer;">
                            Activity (${activityLog.length})
                        </button>
                    </div>
                    
                    <!-- Details Tab -->
                    <div class="inc-tab-content" data-tab-content="details">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-4);">
                            <div>
                                <div class="text-sm text-muted">Site</div>
                                <div class="font-medium">${Utils.escapeHtml(site?.name || 'Unknown')}</div>
                            </div>
                            <div>
                                <div class="text-sm text-muted">Date/Time</div>
                                <div class="font-medium">${Utils.formatDateTime(incident.dateTime)}</div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <div class="text-sm text-muted">Type</div>
                            <div class="font-medium">${Utils.escapeHtml(incident.type)}</div>
                        </div>
                        ${guardLinks ? `<div class="mb-4"><div class="text-sm text-muted">Guard(s) Involved</div><div class="font-medium">${guardLinks}</div></div>` : ''}
                        ${incident.reportedBy ? `<div class="mb-4"><div class="text-sm text-muted">Reported By</div><div class="font-medium">${Utils.escapeHtml(incident.reportedBy)}</div></div>` : ''}
                        <div class="mb-4">
                            <div class="text-sm text-muted">Narrative</div>
                            <div style="white-space: pre-wrap; background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md);">${Utils.escapeHtml(incident.narrative)}</div>
                        </div>
                        ${incident.resolution?.notes ? `
                            <div style="background: var(--color-success-bg); padding: var(--space-3); border-radius: var(--radius-md);">
                                <div class="text-sm font-medium" style="color: var(--color-success);">Resolution</div>
                                <div class="text-sm">${Utils.escapeHtml(incident.resolution.notes)}</div>
                                ${incident.resolution.date ? `<div class="text-xs text-muted" style="margin-top: 4px;">Resolved: ${new Date(incident.resolution.date).toLocaleString()}</div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Follow-up Tab -->
                    <div class="inc-tab-content" data-tab-content="followup" style="display: none;">
                        ${incident.followUp?.dueDate ? `
                            <div style="background: ${isOverdue ? 'var(--color-danger-bg)' : 'var(--color-surface-elevated)'}; padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-4);">
                                <div class="text-sm text-muted">Due Date</div>
                                <div class="font-medium ${isOverdue ? 'text-danger' : ''}">${new Date(incident.followUp.dueDate + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</div>
                                ${isOverdue ? `<div class="text-sm text-danger" style="margin-top: 4px;">âš ï¸ ${Math.ceil((new Date() - new Date(incident.followUp.dueDate)) / (1000 * 60 * 60 * 24))} days overdue</div>` : ''}
                            </div>
                            ${incident.followUp.notes ? `
                                <div class="mb-4">
                                    <div class="text-sm text-muted">Follow-up Notes</div>
                                    <div>${Utils.escapeHtml(incident.followUp.notes)}</div>
                                </div>
                            ` : ''}
                            ${incident.followUp.assignedTo ? `
                                <div class="mb-4">
                                    <div class="text-sm text-muted">Assigned To</div>
                                    <div>${Utils.escapeHtml(incident.followUp.assignedTo)}</div>
                                </div>
                            ` : ''}
                        ` : `
                            <div class="text-muted text-center" style="padding: var(--space-6);">
                                No follow-up scheduled
                                <button class="btn btn-sm btn-secondary" style="margin-top: var(--space-3); display: block; margin-left: auto; margin-right: auto;" onclick="UI.closeModal(); IncidentsModule.editIncident('${id}')">Add Follow-up</button>
                            </div>
                        `}
                    </div>
                    
                    <!-- Client Tab -->
                    <div class="inc-tab-content" data-tab-content="client" style="display: none;">
                        ${incident.clientNotification?.notifiedDate ? `
                            <div style="background: var(--color-success-bg); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-4);">
                                <div class="text-sm font-medium" style="color: var(--color-success);">âœ“ Client Notified</div>
                                <div class="text-sm">${new Date(incident.clientNotification.notifiedDate).toLocaleString()}</div>
                            </div>
                            ${incident.clientNotification.contactName ? `
                                <div class="mb-4">
                                    <div class="text-sm text-muted">Contact</div>
                                    <div>${Utils.escapeHtml(incident.clientNotification.contactName)}</div>
                                </div>
                            ` : ''}
                            ${incident.clientNotification.method ? `
                                <div class="mb-4">
                                    <div class="text-sm text-muted">Method</div>
                                    <div>${Utils.escapeHtml(incident.clientNotification.method)}</div>
                                </div>
                            ` : ''}
                            ${incident.clientNotification.response ? `
                                <div class="mb-4">
                                    <div class="text-sm text-muted">Client Response</div>
                                    <div>${Utils.escapeHtml(incident.clientNotification.response)}</div>
                                </div>
                            ` : ''}
                        ` : `
                            <div class="text-muted text-center" style="padding: var(--space-6);">
                                Client not yet notified
                                <button class="btn btn-sm btn-secondary" style="margin-top: var(--space-3); display: block; margin-left: auto; margin-right: auto;" onclick="UI.closeModal(); IncidentsModule.editIncident('${id}')">Record Notification</button>
                            </div>
                        `}
                    </div>
                    
                    <!-- Activity Tab -->
                    <div class="inc-tab-content" data-tab-content="activity" style="display: none;">
                        ${activityHtml}
                    </div>
                </div>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>
                <button class="btn btn-ghost" onclick="UI.closeModal(); IncidentsModule.quickStatusChange('${id}')" title="Change Status">Change Status</button>
                <button class="btn btn-primary" onclick="UI.closeModal(); IncidentsModule.editIncident('${id}')">Edit</button>
            `;

                UI.openModal(`Incident ${incident.id}`, content, footer, 'lg');
            },
            
            // Tab switching for view modal
            switchViewTab: function(tabName) {
                document.querySelectorAll('.inc-tab-content').forEach(el => el.style.display = 'none');
                document.querySelectorAll('[data-tab-content="' + tabName + '"]').forEach(el => el.style.display = 'block');
                
                document.querySelectorAll('.inc-tab-btn').forEach(btn => {
                    btn.style.borderBottomColor = 'transparent';
                    btn.style.color = 'var(--color-text-muted)';
                });
                document.querySelectorAll('.inc-tab-btn[data-tab="' + tabName + '"]').forEach(btn => {
                    btn.style.borderBottomColor = 'var(--color-primary)';
                    btn.style.color = 'var(--color-primary)';
                });
            },

            editIncident: function (id) {
                const incident = DataStore.getIncidents().find(i => i.id === id);
                if (!incident) return;

                const sites = DataStore.getSites();
                const guards = DataStore.getActiveGuards();
                const dtLocal = incident.dateTime.slice(0, 16);
                const followUp = incident.followUp || {};
                const clientNotif = incident.clientNotification || {};
                const resolution = incident.resolution || {};
                
                // Status options based on workflow
                const allStatuses = Object.keys(this.workflowStates);

                const content = `
                <div style="max-height: 70vh; overflow-y: auto;">
                    <!-- Tab Navigation -->
                    <div style="display: flex; gap: var(--space-1); margin-bottom: var(--space-4); border-bottom: 1px solid var(--color-border);">
                        <button type="button" class="edit-inc-tab-btn active" data-tab="basic" onclick="IncidentsModule.switchEditTab('basic')" style="padding: var(--space-2) var(--space-4); background: none; border: none; border-bottom: 2px solid var(--color-primary); color: var(--color-primary); cursor: pointer; font-weight: 500;">
                            Basic Info
                        </button>
                        <button type="button" class="edit-inc-tab-btn" data-tab="followup" onclick="IncidentsModule.switchEditTab('followup')" style="padding: var(--space-2) var(--space-4); background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-text-muted); cursor: pointer;">
                            Follow-up
                        </button>
                        <button type="button" class="edit-inc-tab-btn" data-tab="client" onclick="IncidentsModule.switchEditTab('client')" style="padding: var(--space-2) var(--space-4); background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-text-muted); cursor: pointer;">
                            Client
                        </button>
                        <button type="button" class="edit-inc-tab-btn" data-tab="resolution" onclick="IncidentsModule.switchEditTab('resolution')" style="padding: var(--space-2) var(--space-4); background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-text-muted); cursor: pointer;">
                            Resolution
                        </button>
                    </div>
                    
                    <form id="edit-incident-form">
                        <!-- Basic Info Tab -->
                        <div class="edit-inc-tab-content" data-tab-content="basic">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Date/Time</label>
                                    <input type="datetime-local" class="form-input" id="edit-inc-datetime" value="${dtLocal}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Site</label>
                                    <select class="form-select" id="edit-inc-site" required>
                                        ${sites.map(s => `<option value="${s.id}" ${s.id === incident.siteId ? 'selected' : ''}>${Utils.escapeHtml(s.name)}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Type</label>
                                    <input type="text" class="form-input" id="edit-inc-type" value="${Utils.escapeHtml(incident.type)}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Severity</label>
                                    <select class="form-select" id="edit-inc-severity" required>
                                        ${['Low', 'Medium', 'High', 'Critical'].map(s => `<option value="${s}" ${s === incident.severity ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="edit-inc-status">
                                    ${allStatuses.map(s => {
                                        const ws = this.workflowStates[s];
                                        return `<option value="${s}" ${s === incident.status ? 'selected' : ''}>${ws.icon} ${ws.label}</option>`;
                                    }).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reported By</label>
                                <input type="text" class="form-input" id="edit-inc-reported-by" value="${Utils.escapeHtml(incident.reportedBy || '')}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Guard(s) Involved</label>
                                <select class="form-select" id="edit-inc-guard">
                                    <option value="">None</option>
                                    ${guards.map(g => `<option value="${g.id}" ${(incident.guardIds || []).includes(g.id) ? 'selected' : ''}>${Utils.escapeHtml(g.name)}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Narrative</label>
                                <textarea class="form-textarea" id="edit-inc-narrative" rows="4" required>${Utils.escapeHtml(incident.narrative)}</textarea>
                            </div>
                        </div>
                        
                        <!-- Follow-up Tab -->
                        <div class="edit-inc-tab-content" data-tab-content="followup" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Follow-up Due Date</label>
                                    <input type="date" class="form-input" id="edit-inc-followup-date" value="${followUp.dueDate || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Assigned To</label>
                                    <input type="text" class="form-input" id="edit-inc-followup-assigned" value="${Utils.escapeHtml(followUp.assignedTo || '')}" placeholder="Person responsible">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Follow-up Notes</label>
                                <textarea class="form-textarea" id="edit-inc-followup-notes" rows="3" placeholder="What needs to be done...">${Utils.escapeHtml(followUp.notes || '')}</textarea>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="edit-inc-followup-complete" ${followUp.completed ? 'checked' : ''}>
                                    <span>Follow-up Completed</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Client Tab -->
                        <div class="edit-inc-tab-content" data-tab-content="client" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Client Notified Date</label>
                                    <input type="datetime-local" class="form-input" id="edit-inc-client-date" value="${clientNotif.notifiedDate ? clientNotif.notifiedDate.slice(0, 16) : ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Notification Method</label>
                                    <select class="form-select" id="edit-inc-client-method">
                                        <option value="">Select...</option>
                                        <option value="Phone" ${clientNotif.method === 'Phone' ? 'selected' : ''}>Phone Call</option>
                                        <option value="Email" ${clientNotif.method === 'Email' ? 'selected' : ''}>Email</option>
                                        <option value="Text" ${clientNotif.method === 'Text' ? 'selected' : ''}>Text Message</option>
                                        <option value="In Person" ${clientNotif.method === 'In Person' ? 'selected' : ''}>In Person</option>
                                        <option value="Portal" ${clientNotif.method === 'Portal' ? 'selected' : ''}>Client Portal</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contact Name</label>
                                <input type="text" class="form-input" id="edit-inc-client-contact" value="${Utils.escapeHtml(clientNotif.contactName || '')}" placeholder="Who was notified">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Client Response</label>
                                <textarea class="form-textarea" id="edit-inc-client-response" rows="2" placeholder="Client's response or instructions...">${Utils.escapeHtml(clientNotif.response || '')}</textarea>
                            </div>
                        </div>
                        
                        <!-- Resolution Tab -->
                        <div class="edit-inc-tab-content" data-tab-content="resolution" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Resolution Date</label>
                                <input type="datetime-local" class="form-input" id="edit-inc-resolution-date" value="${resolution.date ? resolution.date.slice(0, 16) : ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Resolution Notes</label>
                                <textarea class="form-textarea" id="edit-inc-resolution-notes" rows="3" placeholder="How was this resolved...">${Utils.escapeHtml(resolution.notes || '')}</textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Root Cause</label>
                                <input type="text" class="form-input" id="edit-inc-resolution-cause" value="${Utils.escapeHtml(resolution.rootCause || '')}" placeholder="What caused this incident">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Preventive Measures</label>
                                <textarea class="form-textarea" id="edit-inc-resolution-prevention" rows="2" placeholder="Steps to prevent recurrence...">${Utils.escapeHtml(resolution.preventiveMeasures || '')}</textarea>
                            </div>
                        </div>
                    </form>
                </div>
            `;

                const footer = `
                <button class="btn btn-secondary" style="color: var(--color-danger); margin-right: auto;" onclick="IncidentsModule.confirmDelete('${id}')">Delete</button>
                <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="IncidentsModule.saveEditedIncident('${id}')">Save Changes</button>
            `;

                UI.openModal(`Edit ${incident.id}`, content, footer, 'lg');
            },
            
            // Tab switching for edit modal
            switchEditTab: function(tabName) {
                document.querySelectorAll('.edit-inc-tab-content').forEach(el => el.style.display = 'none');
                document.querySelectorAll('[data-tab-content="' + tabName + '"]').forEach(el => el.style.display = 'block');
                
                document.querySelectorAll('.edit-inc-tab-btn').forEach(btn => {
                    btn.style.borderBottomColor = 'transparent';
                    btn.style.color = 'var(--color-text-muted)';
                });
                document.querySelectorAll('.edit-inc-tab-btn[data-tab="' + tabName + '"]').forEach(btn => {
                    btn.style.borderBottomColor = 'var(--color-primary)';
                    btn.style.color = 'var(--color-primary)';
                });
            },
            
            // Confirm delete
            confirmDelete: async function(id) {
                const confirmed = await UI.confirm('Delete Incident', 'Are you sure you want to delete this incident? This cannot be undone.');
                if (!confirmed) return;
                
                let incidents = DataStore.getIncidents();
                incidents = incidents.filter(i => i.id !== id);
                DataStore.saveIncidents(incidents);
                
                UI.closeModal();
                this.render();
                DashboardModule.updateNavBadges();
                UI.notify('Incident deleted', 'success');
            },

            saveEditedIncident: function (id) {
                const form = document.getElementById('edit-incident-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const incidents = DataStore.getIncidents();
                const idx = incidents.findIndex(i => i.id === id);
                if (idx === -1) return;
                
                const oldStatus = incidents[idx].status;
                const newStatus = document.getElementById('edit-inc-status').value;

                // Update basic fields
                incidents[idx].siteId = document.getElementById('edit-inc-site').value;
                incidents[idx].dateTime = new Date(document.getElementById('edit-inc-datetime').value).toISOString();
                incidents[idx].type = document.getElementById('edit-inc-type').value;
                incidents[idx].severity = document.getElementById('edit-inc-severity').value;
                incidents[idx].reportedBy = document.getElementById('edit-inc-reported-by').value;
                incidents[idx].narrative = document.getElementById('edit-inc-narrative').value;
                incidents[idx].status = newStatus;
                
                // Update guard
                const guardId = document.getElementById('edit-inc-guard')?.value;
                incidents[idx].guardIds = guardId ? [guardId] : [];
                
                // Update follow-up
                const followUpDate = document.getElementById('edit-inc-followup-date')?.value;
                incidents[idx].followUp = {
                    dueDate: followUpDate || null,
                    assignedTo: document.getElementById('edit-inc-followup-assigned')?.value.trim() || '',
                    notes: document.getElementById('edit-inc-followup-notes')?.value.trim() || '',
                    completed: document.getElementById('edit-inc-followup-complete')?.checked || false
                };
                
                // Update client notification
                const clientDate = document.getElementById('edit-inc-client-date')?.value;
                incidents[idx].clientNotification = {
                    notifiedDate: clientDate ? new Date(clientDate).toISOString() : null,
                    method: document.getElementById('edit-inc-client-method')?.value || '',
                    contactName: document.getElementById('edit-inc-client-contact')?.value.trim() || '',
                    response: document.getElementById('edit-inc-client-response')?.value.trim() || ''
                };
                
                // Update resolution
                const resolutionDate = document.getElementById('edit-inc-resolution-date')?.value;
                incidents[idx].resolution = {
                    date: resolutionDate ? new Date(resolutionDate).toISOString() : null,
                    notes: document.getElementById('edit-inc-resolution-notes')?.value.trim() || '',
                    rootCause: document.getElementById('edit-inc-resolution-cause')?.value.trim() || '',
                    preventiveMeasures: document.getElementById('edit-inc-resolution-prevention')?.value.trim() || ''
                };
                
                incidents[idx].updatedAt = new Date().toISOString();
                
                // Add activity log entry
                if (!incidents[idx].activityLog) incidents[idx].activityLog = [];
                
                if (oldStatus !== newStatus) {
                    incidents[idx].activityLog.push({
                        timestamp: new Date().toISOString(),
                        action: 'Status Changed',
                        details: `${oldStatus} â†’ ${newStatus}`,
                        user: 'System'
                    });
                }
                
                incidents[idx].activityLog.push({
                    timestamp: new Date().toISOString(),
                    action: 'Incident Updated',
                    details: 'Details modified',
                    user: 'System'
                });

                DataStore.saveIncidents(incidents);
                UI.closeModal();
                this.render();
                DashboardModule.updateNavBadges();
                UI.notify('Incident updated', 'success');
            },

            exportCSV: function () {
                let incidents = DataStore.getIncidents();
                const sites = DataStore.getSites();

                // Apply current filters (same as renderTable)
                if (this.filters.site) incidents = incidents.filter(i => i.siteId === this.filters.site);
                if (this.filters.severity) incidents = incidents.filter(i => i.severity === this.filters.severity);
                if (this.filters.status) incidents = incidents.filter(i => i.status === this.filters.status);
                if (this.filters.search) {
                    incidents = incidents.filter(i =>
                        i.type.toLowerCase().includes(this.filters.search) ||
                        (i.narrative || '').toLowerCase().includes(this.filters.search) ||
                        i.id.toLowerCase().includes(this.filters.search)
                    );
                }

                if (incidents.length === 0) {
                    UI.toast('No Data', 'No incidents match current filters to export.', 'warning');
                    return;
                }

                // CSV escape helper
                const escapeCSV = (val) => {
                    if (val == null) return '';
                    const str = String(val);
                    if (str.includes(',') || str.includes('"') || str.includes('\n') || str.includes('\r')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                };

                // Build CSV with ReportedBy column
                let csv = 'ID,Site,DateTime,Type,Severity,Status,ReportedBy,Description\r\n';
                incidents.forEach(inc => {
                    const site = sites.find(s => s.id === inc.siteId);
                    const row = [
                        escapeCSV(inc.id),
                        escapeCSV(site?.name || ''),
                        escapeCSV(inc.dateTime),
                        escapeCSV(inc.type),
                        escapeCSV(inc.severity),
                        escapeCSV(inc.status),
                        escapeCSV(inc.reportedBy || ''),
                        escapeCSV(inc.narrative || '')
                    ];
                    csv += row.join(',') + '\r\n';
                });

                Utils.downloadFile(csv, `incidents_${Utils.toISODate(new Date())}.csv`, 'text/csv');
                
                const filterNote = (this.filters.site || this.filters.severity || this.filters.status || this.filters.search) 
                    ? ' (filtered)' : '';
                UI.toast('Export Complete', `${incidents.length} incident(s)${filterNote} exported to CSV.`, 'success');
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INSPECTIONS MODULE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const InspectionsModule = {
            signaturePads: { inspector: null, client: null },
            checklistData: {},

            checklistTemplate: {
                'Perimeter Security': [
                    'Fencing/barriers intact',
                    'Gates secured properly',
                    'No unauthorized entry points',
                    'Signage visible and legible'
                ],
                'Access Control': [
                    'Entry/exit logs maintained',
                    'ID verification in place',
                    'Visitor management active',
                    'Key control procedures followed'
                ],
                'Lighting': [
                    'Exterior lighting functional',
                    'Interior lighting adequate',
                    'Emergency lighting tested',
                    'No dark spots identified'
                ],
                'CCTV': [
                    'Cameras operational',
                    'Recording properly',
                    'Monitor displays clear',
                    'No blind spots'
                ],
                'Fire/Safety': [
                    'Fire extinguishers accessible',
                    'Exit routes clear',
                    'Emergency numbers posted',
                    'First aid kit stocked'
                ],
                'Guard Performance': [
                    'Guard alert and attentive',
                    'Proper uniform worn',
                    'Equipment in good condition',
                    'Logs properly maintained'
                ]
            },

            init: function () {
                document.getElementById('inspection-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveInspection();
                });

                document.getElementById('insp-site')?.addEventListener('change', (e) => {
                    const site = DataStore.getSiteById(e.target.value);
                    if (site) {
                        document.getElementById('insp-address').value = site.address;
                    }
                });

                // Tab switching
                document.querySelectorAll('#section-inspections .tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('#section-inspections .tab').forEach(t => {
                            t.classList.remove('active');
                            t.setAttribute('aria-selected', 'false');
                        });
                        document.querySelectorAll('#section-inspections .tab-content').forEach(c => c.classList.remove('active'));

                        tab.classList.add('active');
                        tab.setAttribute('aria-selected', 'true');
                        document.getElementById(`tab-${tab.dataset.tab}`)?.classList.add('active');
                    });
                });

                document.getElementById('insp-filter-site')?.addEventListener('change', () => this.renderHistory());
                document.getElementById('insp-filter-status')?.addEventListener('change', () => this.renderHistory());
            },

            render: function () {
                UI.populateSiteSelect('insp-site');
                UI.populateSiteSelect('insp-filter-site', true);
                UI.populateGuardSelect('insp-guard');
                this.generateInspectionId();
                this.setDefaultDateTime();
                this.setDefaultInspectorName();
                this.renderChecklist();
                this.initSignaturePads();
                this.renderHistory();
            },

            generateInspectionId: function () {
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
                const inspections = DataStore.getInspections();
                const todayCount = inspections.filter(i => i.id.includes(dateStr)).length + 1;
                const id = `INS-${dateStr}-${String(todayCount).padStart(4, '0')}`;
                document.getElementById('inspection-id').textContent = id;
                return id;
            },

            setDefaultDateTime: function () {
                const now = new Date();
                const localISO = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                document.getElementById('insp-datetime').value = localISO;
            },

            renderChecklist: function () {
                const container = document.getElementById('inspection-checklist');
                this.checklistData = {};

                let html = '';
                Object.entries(this.checklistTemplate).forEach(([category, items]) => {
                    html += `<div class="checklist-category">
                    <h5 class="checklist-category-title">${category}</h5>`;

                    items.forEach((item, idx) => {
                        const key = `${category}-${idx}`;
                        this.checklistData[key] = { item, value: null, comment: '' };

                        html += `
                        <div class="checklist-item">
                            <span class="checklist-item-label">${item}</span>
                            <div class="checklist-options">
                                <button type="button" class="checklist-option" data-key="${key}" data-value="Yes" onclick="InspectionsModule.setChecklistValue('${key}', 'Yes', this)">Yes</button>
                                <button type="button" class="checklist-option" data-key="${key}" data-value="No" onclick="InspectionsModule.setChecklistValue('${key}', 'No', this)">No</button>
                                <button type="button" class="checklist-option" data-key="${key}" data-value="N/A" onclick="InspectionsModule.setChecklistValue('${key}', 'N/A', this)">N/A</button>
                            </div>
                        </div>
                    `;
                    });

                    html += '</div>';
                });

                container.innerHTML = html;
            },

            setChecklistValue: function (key, value, btn) {
                this.checklistData[key].value = value;

                // Update button states
                const row = btn.parentElement;
                row.querySelectorAll('.checklist-option').forEach(b => {
                    b.classList.remove('selected', 'selected-yes', 'selected-no');
                });
                btn.classList.add('selected');
                if (value === 'Yes') btn.classList.add('selected-yes');
                if (value === 'No') btn.classList.add('selected-no');
            },

            initSignaturePads: function () {
                ['inspector', 'client'].forEach(type => {
                    const canvas = document.getElementById(`sig-${type}`);
                    const ctx = canvas.getContext('2d');

                    ctx.fillStyle = 'var(--color-bg)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    let drawing = false;
                    let lastX = 0, lastY = 0;

                    const getPos = (e) => {
                        const rect = canvas.getBoundingClientRect();
                        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                        return { x: x * (canvas.width / rect.width), y: y * (canvas.height / rect.height) };
                    };

                    const startDraw = (e) => {
                        drawing = true;
                        const pos = getPos(e);
                        lastX = pos.x;
                        lastY = pos.y;
                    };

                    const draw = (e) => {
                        if (!drawing) return;
                        e.preventDefault();
                        const pos = getPos(e);
                        ctx.beginPath();
                        ctx.moveTo(lastX, lastY);
                        ctx.lineTo(pos.x, pos.y);
                        ctx.strokeStyle = '#333';
                        ctx.lineWidth = 2;
                        ctx.lineCap = 'round';
                        ctx.stroke();
                        lastX = pos.x;
                        lastY = pos.y;
                    };

                    const endDraw = () => { drawing = false; };

                    canvas.addEventListener('mousedown', startDraw);
                    canvas.addEventListener('mousemove', draw);
                    canvas.addEventListener('mouseup', endDraw);
                    canvas.addEventListener('mouseleave', endDraw);
                    canvas.addEventListener('touchstart', startDraw);
                    canvas.addEventListener('touchmove', draw);
                    canvas.addEventListener('touchend', endDraw);

                    this.signaturePads[type] = { canvas, ctx };
                });
            },

            clearSignature: function (type) {
                const { canvas, ctx } = this.signaturePads[type];
                ctx.fillStyle = '#f8fafc';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            },

            resetForm: function () {
                document.getElementById('inspection-form').reset();
                this.editingId = null;  // Clear editing mode
                this.generateInspectionId();
                this.setDefaultDateTime();
                this.setDefaultInspectorName();  // Set default inspector
                this.renderChecklist();
                this.clearSignature('inspector');
                this.clearSignature('client');
            },

            setDefaultInspectorName: function () {
                const inspectorInput = document.getElementById('insp-inspector');
                if (!inspectorInput || inspectorInput.value) return;  // Don't override if already set
                
                // Try to get last used inspector name
                const inspections = DataStore.getInspections();
                if (inspections.length > 0) {
                    // Sort by dateTime desc and get most recent
                    const sorted = [...inspections].sort((a, b) => 
                        new Date(b.dateTime) - new Date(a.dateTime)
                    );
                    inspectorInput.value = sorted[0].inspectorName || 'Mike Howard';
                } else {
                    inspectorInput.value = 'Mike Howard';
                }
            },

            saveInspection: function () {
                const form = document.getElementById('inspection-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const status = document.getElementById('insp-status').value;

                // Warn if status is Pass but checklist has failed items
                if (status === 'Pass') {
                    const failedItems = Object.values(this.checklistData).filter(item => item.value === 'No');
                    if (failedItems.length > 0) {
                        const proceed = confirm(
                            `Warning: You're marking this inspection as PASS but ${failedItems.length} checklist item(s) are marked as NO.\n\n` +
                            `Failed items:\n${failedItems.map(i => 'â€¢ ' + i.item).join('\n')}\n\n` +
                            `Are you sure you want to save as Pass?`
                        );
                        if (!proceed) return;
                    }
                }

                const inspection = {
                    id: document.getElementById('inspection-id').textContent,
                    siteId: document.getElementById('insp-site').value,
                    dateTime: new Date(document.getElementById('insp-datetime').value).toISOString(),
                    inspectorName: document.getElementById('insp-inspector').value,
                    guardOnDutyId: document.getElementById('insp-guard').value || null,
                    locationAddress: document.getElementById('insp-address').value,
                    checklist: { ...this.checklistData },
                    status: status,
                    signatures: {
                        inspector: this.signaturePads.inspector?.canvas?.toDataURL() || null,
                        client: this.signaturePads.client?.canvas?.toDataURL() || null
                    },
                    photos: []
                };

                // Check if editing existing or creating new
                if (this.editingId) {
                    // Update existing inspection
                    let inspections = DataStore.getInspections();
                    const index = inspections.findIndex(i => i.id === this.editingId);
                    if (index !== -1) {
                        inspection.updatedAt = new Date().toISOString();
                        inspections[index] = { ...inspections[index], ...inspection };
                        DataStore.saveInspections(inspections);
                        UI.toast('Inspection Updated', `${inspection.id} has been updated.`, 'success');
                    }
                    this.editingId = null;
                } else {
                    // Add new inspection
                    inspection.createdAt = new Date().toISOString();
                    DataStore.addInspection(inspection);
                    UI.toast('Inspection Saved', `${inspection.id} has been recorded.`, 'success');
                }

                this.resetForm();
                this.renderHistory();
            },

            renderHistory: function () {
                let inspections = DataStore.getInspections();
                const sites = DataStore.getSites();

                const siteFilter = document.getElementById('insp-filter-site')?.value;
                const statusFilter = document.getElementById('insp-filter-status')?.value;

                if (siteFilter) inspections = inspections.filter(i => i.siteId === siteFilter);
                if (statusFilter) inspections = inspections.filter(i => i.status === statusFilter);

                const tbody = document.getElementById('inspections-tbody');
                const statusClass = { 'Pass': 'success', 'Fail': 'danger', 'Needs Follow-Up': 'warning' };

                if (inspections.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-muted" style="text-align: center; padding: var(--space-8);">No inspections found</td></tr>';
                    return;
                }

                tbody.innerHTML = inspections.map(insp => {
                    const site = sites.find(s => s.id === insp.siteId);
                    return `
                    <tr>
                        <td data-label="ID"><span class="font-medium">${insp.id}</span></td>
                        <td data-label="Site">${Utils.escapeHtml(site?.name || 'Unknown')}</td>
                        <td data-label="Date">${Utils.formatDate(insp.dateTime)}</td>
                        <td data-label="Inspector">${Utils.escapeHtml(insp.inspectorName)}</td>
                        <td data-label="Status"><span class="badge badge-${statusClass[insp.status]}">${insp.status}</span></td>
                        <td data-label="Actions">
                            <div class="flex gap-2">
                                <button class="btn btn-sm btn-ghost" onclick="InspectionsModule.viewInspection('${insp.id}')" title="View">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                                </button>
                                <button class="btn btn-sm btn-ghost" onclick="InspectionsModule.editInspection('${insp.id}')" title="Edit">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                </button>
                                <button class="btn btn-sm btn-ghost text-danger" onclick="InspectionsModule.deleteInspection('${insp.id}')" title="Delete">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                }).join('');
            },

            viewInspection: function (id) {
                const insp = DataStore.getInspections().find(i => i.id === id);
                if (!insp) return;

                const site = DataStore.getSiteById(insp.siteId);
                const guard = insp.guardOnDutyId ? DataStore.getGuardById(insp.guardOnDutyId) : null;

                let checklistHtml = '';
                Object.entries(insp.checklist).forEach(([key, data]) => {
                    const valueClass = data.value === 'Yes' ? 'success' : data.value === 'No' ? 'danger' : 'neutral';
                    checklistHtml += `<div style="display: flex; justify-content: space-between; padding: var(--space-1) 0; border-bottom: 1px solid var(--color-border-subtle);">
                    <span class="text-sm">${data.item}</span>
                    <span class="badge badge-${valueClass}">${data.value || 'â€”'}</span>
                </div>`;
                });

                const content = `
                <div class="mb-4">
                    <span class="badge badge-${insp.status === 'Pass' ? 'success' : insp.status === 'Fail' ? 'danger' : 'warning'}">${insp.status}</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-4);">
                    <div><div class="text-sm text-muted">Site</div><div class="font-medium">${Utils.escapeHtml(site?.name || 'Unknown')}</div></div>
                    <div><div class="text-sm text-muted">Date/Time</div><div class="font-medium">${Utils.formatDateTime(insp.dateTime)}</div></div>
                    <div><div class="text-sm text-muted">Inspector</div><div class="font-medium">${Utils.escapeHtml(insp.inspectorName)}</div></div>
                    <div><div class="text-sm text-muted">Guard on Duty</div><div class="font-medium">${guard ? Utils.escapeHtml(guard.name) : 'â€”'}</div></div>
                </div>
                <div class="mb-4">
                    <div class="text-sm text-muted mb-2">Checklist Results</div>
                    <div style="max-height: 300px; overflow-y: auto; background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md);">
                        ${checklistHtml}
                    </div>
                </div>
            `;

                const footer = `<button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>`;
                UI.openModal(`Inspection ${insp.id}`, content, footer, 'lg');
            },

            editingId: null,

            editInspection: function (id) {
                const insp = DataStore.getInspections().find(i => i.id === id);
                if (!insp) return;

                // Store editing ID
                this.editingId = id;

                // Populate form fields
                document.getElementById('inspection-id').textContent = insp.id;
                document.getElementById('insp-site').value = insp.siteId;
                
                // Format datetime for input
                const dtLocal = insp.dateTime.slice(0, 16);
                document.getElementById('insp-datetime').value = dtLocal;
                
                document.getElementById('insp-inspector').value = insp.inspectorName || '';
                document.getElementById('insp-guard').value = insp.guardOnDutyId || '';
                document.getElementById('insp-address').value = insp.locationAddress || '';
                document.getElementById('insp-status').value = insp.status || 'Pass';

                // Populate checklist values
                this.checklistData = {};
                if (insp.checklist) {
                    Object.entries(insp.checklist).forEach(([key, data]) => {
                        this.checklistData[key] = { ...data };
                    });
                }
                
                // Update checklist button states
                this.renderChecklist();
                Object.entries(this.checklistData).forEach(([key, data]) => {
                    if (data.value) {
                        const btn = document.querySelector(`.checklist-option[data-key="${key}"][data-value="${data.value}"]`);
                        if (btn) {
                            btn.classList.add('selected');
                            if (data.value === 'Yes') btn.classList.add('selected-yes');
                            if (data.value === 'No') btn.classList.add('selected-no');
                        }
                    }
                });

                // Switch to form tab
                document.querySelectorAll('#section-inspections .tab').forEach(t => {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                });
                document.querySelectorAll('#section-inspections .tab-content').forEach(c => c.classList.remove('active'));
                
                const formTab = document.querySelector('#section-inspections .tab[data-tab="form"]');
                if (formTab) {
                    formTab.classList.add('active');
                    formTab.setAttribute('aria-selected', 'true');
                }
                document.getElementById('tab-form')?.classList.add('active');

                UI.toast('Editing', `Loaded inspection ${id} for editing.`, 'info');
            },

            deleteInspection: async function (id) {
                const confirmed = await UI.confirm(
                    'Delete Inspection',
                    `Are you sure you want to delete inspection ${id}? This cannot be undone.`
                );
                if (!confirmed) return;

                let inspections = DataStore.getInspections();
                inspections = inspections.filter(i => i.id !== id);
                DataStore.saveInspections(inspections);
                
                this.renderHistory();
                UI.toast('Deleted', `Inspection ${id} has been removed.`, 'success');
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SUPERVISOR'S LOG MODULE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const SupervisorLogModule = {
            filters: { source: '', site: '', search: '' },

            // Generate sequential ID: LOG-YYYYMMDD-####
            // Uses the entry's dateTime for the date portion
            generateLogId: function (dateTime) {
                const logDate = dateTime ? new Date(dateTime) : new Date();
                const dateStr = logDate.toISOString().slice(0, 10).replace(/-/g, '');
                const datePrefix = `LOG-${dateStr}`;
                const entries = DataStore.getSupervisorLog();
                const sameDateEntries = entries.filter(e => e.id && e.id.startsWith(datePrefix));
                const seq = String(sameDateEntries.length + 1).padStart(4, '0');
                return `${datePrefix}-${seq}`;
            },

            init: function () {
                document.getElementById('new-log-entry-btn')?.addEventListener('click', () => this.openNewEntryModal());
                document.getElementById('export-log-csv')?.addEventListener('click', () => this.exportCSV());

                document.getElementById('log-search')?.addEventListener('input', Utils.debounce((e) => {
                    this.filters.search = e.target.value.toLowerCase();
                    this.renderEntries();
                }, 200));

                document.getElementById('log-filter-source')?.addEventListener('change', (e) => {
                    this.filters.source = e.target.value;
                    this.renderEntries();
                });

                document.getElementById('log-filter-site')?.addEventListener('change', (e) => {
                    this.filters.site = e.target.value;
                    this.renderEntries();
                });

                // Tab switching
                document.querySelectorAll('#section-supervisorlog .tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('#section-supervisorlog .tab').forEach(t => {
                            t.classList.remove('active');
                            t.setAttribute('aria-selected', 'false');
                        });
                        document.querySelectorAll('#section-supervisorlog .tab-content').forEach(c => c.classList.remove('active'));

                        tab.classList.add('active');
                        tab.setAttribute('aria-selected', 'true');
                        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');

                        if (tab.dataset.tab === 'log-open') {
                            this.renderOpenItems();
                        }
                    });
                });
            },

            render: function () {
                UI.populateSiteSelect('log-filter-site', true);
                this.renderEntries();
                this.updateOpenCount();
            },

            renderEntries: function () {
                let entries = DataStore.getSupervisorLog();
                const sites = DataStore.getSites();

                // Apply filters
                if (this.filters.source) entries = entries.filter(e => e.source === this.filters.source);
                if (this.filters.site) entries = entries.filter(e => e.siteId === this.filters.site);
                if (this.filters.search) {
                    entries = entries.filter(e =>
                        e.note.toLowerCase().includes(this.filters.search) ||
                        e.source.toLowerCase().includes(this.filters.search)
                    );
                }

                // Sort by dateTime descending (newest first)
                entries = [...entries].sort((a, b) => {
                    const dateA = a.dateTime || '';
                    const dateB = b.dateTime || '';
                    return dateB.localeCompare(dateA);
                });

                const container = document.getElementById('log-entries-list');

                if (entries.length === 0) {
                    container.innerHTML = `
                    <div class="empty-state" style="padding: var(--space-12);">
                        <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto var(--space-4); opacity: 0.5;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                        <p class="text-muted">No log entries yet. Click "New Entry" to add one.</p>
                    </div>
                `;
                    return;
                }

                container.innerHTML = entries.map(entry => {
                    const site = sites.find(s => s.id === entry.siteId);
                    const isOpen = entry.needsFollowUp && entry.status === 'open';

                    return `
                    <div class="card" style="margin-bottom: var(--space-3);">
                        <div class="card-body" style="padding: var(--space-4);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-3);">
                                <div>
                                    <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-1);">
                                        <span class="badge badge-neutral">${Utils.escapeHtml(entry.source)}</span>
                                        ${site ? `<span class="badge badge-info">${Utils.escapeHtml(site.name)}</span>` : ''}
                                        ${isOpen ? '<span class="badge badge-warning">Needs Follow-up</span>' : ''}
                                        ${entry.status === 'resolved' ? '<span class="badge badge-success">Resolved</span>' : ''}
                                    </div>
                                    <div class="text-sm text-muted">${Utils.formatDateTime(entry.dateTime)}</div>
                                </div>
                                <div style="display: flex; gap: var(--space-2);">
                                    ${isOpen ? `
                                        <button class="btn btn-sm btn-success" onclick="SupervisorLogModule.resolveEntry('${entry.id}')" title="Mark Resolved">
                                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-sm btn-ghost" onclick="SupervisorLogModule.editEntry('${entry.id}')" title="Edit">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                    </button>
                                    <button class="btn btn-sm btn-ghost" style="color: var(--color-danger);" onclick="SupervisorLogModule.confirmDeleteEntry('${entry.id}')" title="Delete">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div style="white-space: pre-wrap; line-height: 1.6;">${Utils.escapeHtml(entry.note)}</div>
                            ${entry.resolvedNote ? `
                                <div style="margin-top: var(--space-3); padding-top: var(--space-3); border-top: 1px solid var(--color-border-subtle);">
                                    <div class="text-sm text-muted">Resolution note:</div>
                                    <div class="text-sm">${Utils.escapeHtml(entry.resolvedNote)}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                }).join('');
            },

            renderOpenItems: function () {
                const entries = DataStore.getOpenLogItems();
                const sites = DataStore.getSites();
                const container = document.getElementById('log-open-list');

                if (entries.length === 0) {
                    container.innerHTML = `
                    <div class="empty-state" style="padding: var(--space-12);">
                        <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto var(--space-4); opacity: 0.5;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-muted">No open items. You're all caught up!</p>
                    </div>
                `;
                    return;
                }

                container.innerHTML = entries.map(entry => {
                    const site = sites.find(s => s.id === entry.siteId);
                    const age = this.getEntryAge(entry.dateTime);

                    return `
                    <div class="card" style="margin-bottom: var(--space-3); border-left: 3px solid var(--color-warning);">
                        <div class="card-body" style="padding: var(--space-4);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-3);">
                                <div>
                                    <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-1);">
                                        <span class="badge badge-neutral">${Utils.escapeHtml(entry.source)}</span>
                                        ${site ? `<span class="badge badge-info">${Utils.escapeHtml(site.name)}</span>` : ''}
                                        <span class="text-sm text-muted">${age}</span>
                                    </div>
                                    <div class="text-sm text-muted">${Utils.formatDateTime(entry.dateTime)}</div>
                                </div>
                                <button class="btn btn-sm btn-success" onclick="SupervisorLogModule.resolveEntry('${entry.id}')">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    Resolve
                                </button>
                            </div>
                            <div style="white-space: pre-wrap; line-height: 1.6;">${Utils.escapeHtml(entry.note)}</div>
                        </div>
                    </div>
                `;
                }).join('');
            },

            getEntryAge: function (dateTime) {
                const now = new Date();
                const then = new Date(dateTime);
                const diffMs = now - then;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                if (diffDays === 0) return 'Today';
                if (diffDays === 1) return '1 day ago';
                if (diffDays < 7) return `${diffDays} days ago`;
                if (diffDays < 14) return '1 week ago';
                return `${Math.floor(diffDays / 7)} weeks ago`;
            },

            updateOpenCount: function () {
                const count = DataStore.getOpenLogItems().length;

                const navBadge = document.getElementById('nav-open-items');
                if (navBadge) {
                    navBadge.textContent = count;
                    navBadge.style.display = count > 0 ? 'inline' : 'none';
                }

                const tabBadge = document.getElementById('tab-open-count');
                if (tabBadge) {
                    tabBadge.textContent = count;
                    tabBadge.style.display = count > 0 ? 'inline' : 'none';
                }
            },

            openNewEntryModal: function () {
                const sites = DataStore.getSites();
                const now = new Date();
                const nowStr = now.toISOString().slice(0, 16);

                const content = `
                <form id="new-log-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Date/Time</label>
                            <input type="datetime-local" class="form-input" id="log-datetime" value="${nowStr}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Source *</label>
                            <select class="form-select" id="log-source" required>
                                <option value="">Select source...</option>
                                <option value="Day Supervisor">Day Supervisor</option>
                                <option value="Night Supervisor">Night Supervisor</option>
                                <option value="Guard">Guard</option>
                                <option value="Field Visit">Field Visit</option>
                                <option value="Phone Call">Phone Call</option>
                                <option value="Email">Email</option>
                                <option value="Property Manager">Property Manager</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Site (optional)</label>
                        <select class="form-select" id="log-site">
                            <option value="">General / Not site-specific</option>
                            ${sites.map(s => `<option value="${s.id}">${Utils.escapeHtml(s.name)}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Note *</label>
                        <textarea class="form-textarea" id="log-note" rows="5" placeholder="What happened? What was reported? What needs to be done?" required></textarea>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                            <input type="checkbox" id="log-followup" style="width: 18px; height: 18px;">
                            <span>Needs follow-up</span>
                        </label>
                        <p class="form-hint">Check this if you need to take action or check on this later.</p>
                    </div>
                </form>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="SupervisorLogModule.saveNewEntry()">Save Entry</button>
            `;

                UI.openModal('New Log Entry', content, footer, 'lg');
            },

            saveNewEntry: function () {
                const form = document.getElementById('new-log-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const dateTime = new Date(document.getElementById('log-datetime').value).toISOString();
                const entry = {
                    id: this.generateLogId(dateTime),
                    dateTime: dateTime,
                    source: document.getElementById('log-source').value,
                    siteId: document.getElementById('log-site').value || null,
                    note: document.getElementById('log-note').value,
                    needsFollowUp: document.getElementById('log-followup').checked,
                    status: 'open',
                    resolvedNote: '',
                    resolvedAt: null,
                    createdAt: new Date().toISOString(),
                    createdBy: 'Mike Howard'
                };

                DataStore.addLogEntry(entry);
                UI.closeModal();
                this.renderEntries();
                this.updateOpenCount();
                UI.toast('Entry Added', 'Log entry has been saved.', 'success');
            },

            editEntry: function (id) {
                const entry = DataStore.getSupervisorLog().find(e => e.id === id);
                if (!entry) return;

                const sites = DataStore.getSites();
                const dtLocal = entry.dateTime.slice(0, 16);

                const content = `
                <form id="edit-log-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Date/Time</label>
                            <input type="datetime-local" class="form-input" id="edit-log-datetime" value="${dtLocal}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Source</label>
                            <select class="form-select" id="edit-log-source" required>
                                ${['Day Supervisor', 'Night Supervisor', 'Guard', 'Field Visit', 'Phone Call', 'Email', 'Property Manager', 'Other'].map(s =>
                    `<option value="${s}" ${s === entry.source ? 'selected' : ''}>${s}</option>`
                ).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Site (optional)</label>
                        <select class="form-select" id="edit-log-site">
                            <option value="">General / Not site-specific</option>
                            ${sites.map(s => `<option value="${s.id}" ${s.id === entry.siteId ? 'selected' : ''}>${Utils.escapeHtml(s.name)}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Note</label>
                        <textarea class="form-textarea" id="edit-log-note" rows="5" required>${Utils.escapeHtml(entry.note)}</textarea>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                            <input type="checkbox" id="edit-log-followup" style="width: 18px; height: 18px;" ${entry.needsFollowUp ? 'checked' : ''}>
                            <span>Needs follow-up</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="edit-log-status">
                            <option value="open" ${entry.status === 'open' ? 'selected' : ''}>Open</option>
                            <option value="resolved" ${entry.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                        </select>
                    </div>
                </form>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="SupervisorLogModule.saveEditedEntry('${id}')">Save Changes</button>
            `;

                UI.openModal('Edit Log Entry', content, footer, 'lg');
            },

            saveEditedEntry: function (id) {
                const form = document.getElementById('edit-log-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                DataStore.updateLogEntry(id, {
                    dateTime: new Date(document.getElementById('edit-log-datetime').value).toISOString(),
                    source: document.getElementById('edit-log-source').value,
                    siteId: document.getElementById('edit-log-site').value || null,
                    note: document.getElementById('edit-log-note').value,
                    needsFollowUp: document.getElementById('edit-log-followup').checked,
                    status: document.getElementById('edit-log-status').value
                });

                UI.closeModal();
                this.renderEntries();
                this.updateOpenCount();
                UI.toast('Entry Updated', 'Changes have been saved.', 'success');
            },

            resolveEntry: function (id) {
                const content = `
                <form id="resolve-log-form">
                    <div class="form-group">
                        <label class="form-label">Resolution Note (optional)</label>
                        <textarea class="form-textarea" id="resolve-note" rows="3" placeholder="What was done? How was it resolved?"></textarea>
                    </div>
                </form>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                <button class="btn btn-success" onclick="SupervisorLogModule.confirmResolve('${id}')">Mark Resolved</button>
            `;

                UI.openModal('Resolve Item', content, footer);

                // Auto-focus the textarea
                setTimeout(() => document.getElementById('resolve-note')?.focus(), 100);
            },

            confirmResolve: function (id) {
                const resolvedNote = document.getElementById('resolve-note')?.value || '';

                DataStore.updateLogEntry(id, {
                    status: 'resolved',
                    resolvedNote: resolvedNote,
                    resolvedAt: new Date().toISOString()
                });

                UI.closeModal();
                this.renderEntries();
                this.renderOpenItems();
                this.updateOpenCount();
                UI.toast('Item Resolved', 'Entry has been marked as resolved.', 'success');
            },

            confirmDeleteEntry: function (id) {
                const content = `
                <p>Are you sure you want to delete this log entry?</p>
                <p class="text-muted text-sm" style="margin-top: var(--space-2);">This action cannot be undone.</p>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                <button class="btn btn-danger" onclick="SupervisorLogModule.deleteEntry('${id}')">Delete</button>
            `;

                UI.openModal('Delete Entry', content, footer);
            },

            deleteEntry: function (id) {
                DataStore.deleteLogEntry(id);
                UI.closeModal();
                this.renderEntries();
                this.updateOpenCount();
                UI.toast('Entry Deleted', 'Log entry has been removed.', 'success');
            },

            exportCSV: function () {
                let entries = DataStore.getSupervisorLog();
                const sites = DataStore.getSites();

                // Apply same filters as renderEntries
                if (this.filters.source) entries = entries.filter(e => e.source === this.filters.source);
                if (this.filters.site) entries = entries.filter(e => e.siteId === this.filters.site);
                if (this.filters.search) {
                    entries = entries.filter(e =>
                        (e.note && e.note.toLowerCase().includes(this.filters.search)) ||
                        (e.source && e.source.toLowerCase().includes(this.filters.search))
                    );
                }

                // Sort by dateTime descending
                entries = [...entries].sort((a, b) => {
                    const dateA = a.dateTime || '';
                    const dateB = b.dateTime || '';
                    return dateB.localeCompare(dateA);
                });

                // Headers with ID as first column
                const headers = ['ID', 'Date/Time', 'Source', 'Site', 'Note', 'Needs Follow-up', 
                                 'Status', 'Resolved At', 'Resolution Note'];

                const rows = entries.map(e => {
                    const site = e.siteId ? sites.find(s => s.id === e.siteId) : null;
                    return [
                        e.id || '',
                        e.dateTime ? new Date(e.dateTime).toLocaleString() : '',
                        e.source || '',
                        site ? site.name : '',
                        (e.note || '').replace(/\n/g, ' '),
                        e.needsFollowUp ? 'Yes' : 'No',
                        e.status || '',
                        e.resolvedAt ? new Date(e.resolvedAt).toLocaleString() : '',
                        (e.resolvedNote || '').replace(/\n/g, ' ')
                    ];
                });

                // Use \r\n line endings for Excel compatibility
                const csv = [headers, ...rows]
                    .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                    .join('\r\n');

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `supervisor_log_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // COMMUNICATIONS LOG MODULE â€” Supervisor-Grade Communication Tracking
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const CommsLogModule = {
            filters: { type: '', party: '', site: '', search: '' },

            // Communication type configuration
            TYPES: {
                phone_inbound: { label: 'Phone (Inbound)', icon: 'ğŸ“', direction: 'inbound' },
                phone_outbound: { label: 'Phone (Outbound)', icon: 'ğŸ“±', direction: 'outbound' },
                email_inbound: { label: 'Email (Received)', icon: 'ğŸ“¨', direction: 'inbound' },
                email_outbound: { label: 'Email (Sent)', icon: 'ğŸ“§', direction: 'outbound' },
                in_person: { label: 'In-Person', icon: 'ğŸ¤', direction: 'both' },
                text: { label: 'Text/SMS', icon: 'ğŸ’¬', direction: 'both' },
                video: { label: 'Video Call', icon: 'ğŸ–¥ï¸', direction: 'both' },
                radio: { label: 'Radio', icon: 'ğŸ“»', direction: 'both' }
            },

            PARTIES: {
                client: { label: 'Client/Property Manager', color: 'info', icon: 'ğŸ¢' },
                guard: { label: 'Guard/Officer', color: 'success', icon: 'ğŸ‘®' },
                internal: { label: 'Internal Staff', color: 'secondary', icon: 'ğŸ‘”' },
                vendor: { label: 'Vendor/Contractor', color: 'warning', icon: 'ğŸ”§' },
                emergency: { label: 'Emergency Services', color: 'danger', icon: 'ğŸš¨' },
                utility: { label: 'Utility/Maintenance', color: 'info', icon: 'âš¡' },
                government: { label: 'Government/Regulatory', color: 'secondary', icon: 'ğŸ›ï¸' },
                legal: { label: 'Legal/Insurance', color: 'secondary', icon: 'âš–ï¸' },
                resident: { label: 'Resident/Tenant', color: 'success', icon: 'ğŸ ' },
                other: { label: 'Other', color: 'secondary', icon: 'ğŸ“‹' }
            },

            // Generate sequential ID: COMM-YYYYMMDD-####
            // Uses the communication's dateTime for the date portion
            generateCommId: function (dateTime) {
                // Use provided dateTime or fallback to now
                const commDate = dateTime ? new Date(dateTime) : new Date();
                const dateStr = commDate.toISOString().slice(0, 10).replace(/-/g, '');
                const datePrefix = `COMM-${dateStr}`;
                
                // Count existing communications for this date
                const comms = DataStore.getCommunications();
                const sameDateComms = comms.filter(c => c.id && c.id.startsWith(datePrefix));
                const seq = String(sameDateComms.length + 1).padStart(4, '0');
                
                return `${datePrefix}-${seq}`;
            },

            init: function () {
                document.getElementById('new-comm-btn')?.addEventListener('click', () => this.openNewModal());
                document.getElementById('export-comms-csv')?.addEventListener('click', () => this.exportCSV());

                document.getElementById('comms-search')?.addEventListener('input', Utils.debounce((e) => {
                    this.filters.search = e.target.value.toLowerCase();
                    this.renderList();
                }, 200));

                document.getElementById('comms-filter-type')?.addEventListener('change', (e) => {
                    this.filters.type = e.target.value;
                    this.renderList();
                });

                document.getElementById('comms-filter-party')?.addEventListener('change', (e) => {
                    this.filters.party = e.target.value;
                    this.renderList();
                });

                document.getElementById('comms-filter-site')?.addEventListener('change', (e) => {
                    this.filters.site = e.target.value;
                    this.renderList();
                });

                // Tab switching
                document.querySelectorAll('#section-commslog .tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('#section-commslog .tab').forEach(t => {
                            t.classList.remove('active');
                            t.setAttribute('aria-selected', 'false');
                        });
                        document.querySelectorAll('#section-commslog .tab-content').forEach(c => c.classList.remove('active'));

                        tab.classList.add('active');
                        tab.setAttribute('aria-selected', 'true');
                        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');

                        if (tab.dataset.tab === 'comms-followup') {
                            this.renderFollowups();
                        } else if (tab.dataset.tab === 'comms-today') {
                            this.renderToday();
                        }
                    });
                });
            },

            render: function () {
                UI.populateSiteSelect('comms-filter-site', true);
                this.renderStats();
                this.renderList();
                this.updateFollowupCount();
            },

            renderStats: function () {
                const container = document.getElementById('comms-stats');
                if (!container) return;

                const comms = DataStore.getCommunications();
                const today = Utils.toISODate(new Date());
                const todayCount = comms.filter(c => c.dateTime && c.dateTime.startsWith(today)).length;
                const followups = DataStore.getFollowUpCommunications().length;
                const inbound = comms.filter(c => this.TYPES[c.type]?.direction === 'inbound').length;
                const outbound = comms.filter(c => this.TYPES[c.type]?.direction === 'outbound').length;

                container.innerHTML = `
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <span class="kpi-label">Today</span>
                            <div class="kpi-icon info">ğŸ“…</div>
                        </div>
                        <div class="kpi-value">${todayCount}</div>
                    </div>
                    <div class="kpi-card" style="cursor: pointer;" onclick="document.querySelector('#section-commslog .tab[data-tab=comms-followup]').click();">
                        <div class="kpi-header">
                            <span class="kpi-label">Follow-ups Due</span>
                            <div class="kpi-icon ${followups > 0 ? 'warning' : 'success'}">ğŸ“‹</div>
                        </div>
                        <div class="kpi-value" style="color: ${followups > 0 ? 'var(--color-warning)' : 'inherit'};">${followups}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <span class="kpi-label">Inbound</span>
                            <div class="kpi-icon success">ğŸ“</div>
                        </div>
                        <div class="kpi-value">${inbound}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <span class="kpi-label">Outbound</span>
                            <div class="kpi-icon info">ğŸ“±</div>
                        </div>
                        <div class="kpi-value">${outbound}</div>
                    </div>
                `;
            },

            updateFollowupCount: function () {
                const count = DataStore.getFollowUpCommunications().length;
                const badge = document.getElementById('tab-followup-count');
                if (badge) {
                    badge.textContent = count;
                    badge.style.display = count > 0 ? 'inline-flex' : 'none';
                }
            },

            renderList: function () {
                let comms = DataStore.getCommunications();
                const sites = DataStore.getSites();
                const guards = DataStore.getGuards();

                // Apply filters
                if (this.filters.type) comms = comms.filter(c => c.type === this.filters.type);
                if (this.filters.party) comms = comms.filter(c => c.party === this.filters.party);
                if (this.filters.site) comms = comms.filter(c => c.siteId === this.filters.site);
                if (this.filters.search) {
                    comms = comms.filter(c =>
                        (c.subject && c.subject.toLowerCase().includes(this.filters.search)) ||
                        (c.contactName && c.contactName.toLowerCase().includes(this.filters.search)) ||
                        (c.summary && c.summary.toLowerCase().includes(this.filters.search))
                    );
                }

                const container = document.getElementById('comms-list');
                if (!container) return;

                if (comms.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: var(--space-12); text-align: center;">
                            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto var(--space-4); opacity: 0.5;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg>
                            <p class="text-muted">No communications logged yet.</p>
                            <button class="btn btn-primary mt-4" onclick="CommsLogModule.openNewModal()">Log First Communication</button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = comms.map(comm => this.renderCommCard(comm, sites, guards)).join('');
            },

            renderCommCard: function (comm, sites, guards) {
                const typeConfig = this.TYPES[comm.type] || { label: comm.type, icon: 'ğŸ“' };
                const partyConfig = this.PARTIES[comm.party] || { label: comm.party, color: 'secondary' };
                const site = comm.siteId ? sites.find(s => s.id === comm.siteId) : null;
                const isOverdue = comm.followUpRequired && comm.followUpStatus !== 'completed' && 
                                  comm.followUpDate && new Date(comm.followUpDate) < new Date();

                return `
                    <div class="card" style="margin-bottom: var(--space-3); ${isOverdue ? 'border-left: 3px solid var(--color-danger);' : ''}">
                        <div class="card-body" style="padding: var(--space-4);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: var(--space-3);">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: var(--space-2); flex-wrap: wrap; margin-bottom: var(--space-2);">
                                        <span style="font-size: 1.25rem;">${typeConfig.icon}</span>
                                        <span class="badge badge-${partyConfig.color}">${partyConfig.label}</span>
                                        ${site ? `<span class="badge badge-neutral">${Utils.escapeHtml(site.name)}</span>` : ''}
                                        ${comm.followUpRequired && comm.followUpStatus !== 'completed' ? 
                                            `<span class="badge badge-${isOverdue ? 'danger' : 'warning'}">${isOverdue ? 'OVERDUE' : 'Follow-up'}</span>` : ''}
                                        ${comm.followUpStatus === 'completed' ? '<span class="badge badge-success">Completed</span>' : ''}
                                    </div>
                                    
                                    <div style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-1);">
                                        ${Utils.escapeHtml(comm.subject || 'No subject')}
                                    </div>
                                    
                                    <div class="text-sm text-muted" style="margin-bottom: var(--space-2);">
                                        <span>${typeConfig.label}</span>
                                        ${comm.contactName ? ` with <strong class="sensitive">${Utils.escapeHtml(comm.contactName)}</strong>` : ''}
                                        ${comm.contactInfo ? ` (<span class="sensitive">${Utils.escapeHtml(comm.contactInfo)}</span>)` : ''}
                                    </div>
                                    
                                    ${comm.summary ? `
                                        <div style="background: var(--color-surface); padding: var(--space-3); border-radius: var(--radius-md); margin-bottom: var(--space-2);">
                                            <div class="sensitive" style="white-space: pre-wrap; line-height: 1.5;">${Utils.escapeHtml(comm.summary)}</div>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="text-xs text-muted" style="display: flex; gap: var(--space-4); flex-wrap: wrap;">
                                        <span>ğŸ“… ${Utils.formatDateTime(comm.dateTime)}</span>
                                        ${comm.loggedBy ? `<span>ğŸ‘¤ ${Utils.escapeHtml(comm.loggedBy)}</span>` : ''}
                                        ${comm.duration ? `<span>â±ï¸ ${comm.duration} min</span>` : ''}
                                        ${comm.followUpDate ? `<span>ğŸ“‹ Follow-up: ${new Date(comm.followUpDate).toLocaleDateString()}</span>` : ''}
                                    </div>
                                    
                                    ${comm.followUpNotes ? `
                                        <div style="margin-top: var(--space-2); padding-top: var(--space-2); border-top: 1px solid var(--color-border-subtle);">
                                            <div class="text-xs text-muted">Follow-up notes:</div>
                                            <div class="text-sm">${Utils.escapeHtml(comm.followUpNotes)}</div>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <div style="display: flex; gap: var(--space-1); flex-shrink: 0;">
                                    ${comm.followUpRequired && comm.followUpStatus !== 'completed' ? `
                                        <button class="btn btn-sm btn-success" onclick="CommsLogModule.markFollowupComplete('${comm.id}')" title="Mark Complete">
                                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                            </svg>
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-sm btn-ghost" onclick="CommsLogModule.openEditModal('${comm.id}')" title="Edit">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                    </button>
                                    <button class="btn btn-sm btn-ghost" style="color: var(--color-danger);" onclick="CommsLogModule.deleteComm('${comm.id}')" title="Delete">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderFollowups: function () {
                const comms = DataStore.getFollowUpCommunications();
                const sites = DataStore.getSites();
                const guards = DataStore.getGuards();
                const container = document.getElementById('comms-followup-list');

                if (comms.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: var(--space-12); text-align: center;">
                            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto var(--space-4); opacity: 0.5;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p class="text-muted">No pending follow-ups. You're all caught up!</p>
                        </div>
                    `;
                    return;
                }

                // Sort by follow-up date, overdue first
                comms.sort((a, b) => {
                    const dateA = a.followUpDate ? new Date(a.followUpDate) : new Date(9999, 0);
                    const dateB = b.followUpDate ? new Date(b.followUpDate) : new Date(9999, 0);
                    return dateA - dateB;
                });

                container.innerHTML = comms.map(c => this.renderCommCard(c, sites, guards)).join('');
            },

            renderToday: function () {
                const comms = DataStore.getTodayCommunications();
                const sites = DataStore.getSites();
                const guards = DataStore.getGuards();
                const container = document.getElementById('comms-today-list');

                if (comms.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: var(--space-12); text-align: center;">
                            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto var(--space-4); opacity: 0.5;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <p class="text-muted">No communications logged today yet.</p>
                            <button class="btn btn-primary mt-4" onclick="CommsLogModule.openNewModal()">Log Communication</button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = comms.map(c => this.renderCommCard(c, sites, guards)).join('');
            },

            openNewModal: function () {
                const sites = DataStore.getSites();
                const guards = DataStore.getGuards();
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 16);

                const content = `
                    <form id="new-comm-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Communication Type *</label>
                                <select class="form-select" id="comm-type" required>
                                    <option value="">Select type...</option>
                                    ${Object.entries(this.TYPES).map(([key, t]) => `
                                        <option value="${key}">${t.icon} ${t.label}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">With Whom *</label>
                                <select class="form-select" id="comm-party" required>
                                    <option value="">Select party...</option>
                                    ${Object.entries(this.PARTIES).map(([key, p]) => `
                                        <option value="${key}">${p.label}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Contact Name</label>
                                <input type="text" class="form-input" id="comm-contact-name" placeholder="Name of person contacted">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contact Info</label>
                                <input type="text" class="form-input" id="comm-contact-info" placeholder="Phone/email">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Date/Time *</label>
                                <input type="datetime-local" class="form-input" id="comm-datetime" value="${dateStr}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Duration (minutes)</label>
                                <input type="number" class="form-input" id="comm-duration" placeholder="e.g., 15" min="1">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Related Site</label>
                                <select class="form-select" id="comm-site">
                                    <option value="">No specific site</option>
                                    ${sites.map(s => `<option value="${s.id}">${Utils.escapeHtml(s.name)}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Related Guard</label>
                                <select class="form-select" id="comm-guard">
                                    <option value="">No specific guard</option>
                                    ${guards.filter(g => g.status === 'active').map(g => `
                                        <option value="${g.id}">${Utils.escapeHtml(g.name)}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Subject/Purpose *</label>
                            <input type="text" class="form-input" id="comm-subject" placeholder="Brief description of the communication" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Summary/Notes</label>
                            <textarea class="form-input" id="comm-summary" rows="4" placeholder="Key points discussed, decisions made, action items..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Logged By</label>
                            <input type="text" class="form-input" id="comm-logged-by" placeholder="Your name">
                        </div>

                        <div style="background: var(--color-surface); padding: var(--space-4); border-radius: var(--radius-md); margin-top: var(--space-4);">
                            <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer; margin-bottom: var(--space-3);">
                                <input type="checkbox" id="comm-followup-required">
                                <span style="font-weight: var(--font-weight-medium);">ğŸ“‹ Requires Follow-up</span>
                            </label>
                            <div id="followup-fields" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Follow-up Date</label>
                                        <input type="date" class="form-input" id="comm-followup-date">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Follow-up Action</label>
                                        <input type="text" class="form-input" id="comm-followup-action" placeholder="What needs to be done?">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="CommsLogModule.saveNewComm()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Save Communication
                    </button>
                `;

                UI.openModal('Log Communication', content, footer, 'lg');

                // Toggle follow-up fields
                document.getElementById('comm-followup-required')?.addEventListener('change', (e) => {
                    document.getElementById('followup-fields').style.display = e.target.checked ? 'block' : 'none';
                });
            },

            saveNewComm: function () {
                const type = document.getElementById('comm-type').value;
                const party = document.getElementById('comm-party').value;
                const contactName = document.getElementById('comm-contact-name').value.trim();
                const contactInfo = document.getElementById('comm-contact-info').value.trim();
                const dateTime = document.getElementById('comm-datetime').value;
                const duration = document.getElementById('comm-duration').value;
                const siteId = document.getElementById('comm-site').value;
                const guardId = document.getElementById('comm-guard').value;
                const subject = document.getElementById('comm-subject').value.trim();
                const summary = document.getElementById('comm-summary').value.trim();
                const loggedBy = document.getElementById('comm-logged-by').value.trim();
                const followUpRequired = document.getElementById('comm-followup-required').checked;
                const followUpDate = document.getElementById('comm-followup-date').value;
                const followUpAction = document.getElementById('comm-followup-action').value.trim();

                if (!type || !party || !dateTime || !subject) {
                    UI.toast('Missing Fields', 'Type, party, date/time, and subject are required.', 'error');
                    return;
                }

                const comm = {
                    id: this.generateCommId(dateTime),
                    type,
                    party,
                    contactName: contactName || null,
                    contactInfo: contactInfo || null,
                    dateTime: new Date(dateTime).toISOString(),
                    duration: duration ? parseInt(duration) : null,
                    siteId: siteId || null,
                    guardId: guardId || null,
                    subject,
                    summary: summary || null,
                    loggedBy: loggedBy || null,
                    followUpRequired,
                    followUpDate: followUpRequired && followUpDate ? followUpDate : null,
                    followUpAction: followUpRequired && followUpAction ? followUpAction : null,
                    followUpStatus: followUpRequired ? 'pending' : null,
                    followUpNotes: null,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                DataStore.addCommunication(comm);
                UI.closeModal();
                this.render();
                UI.toast('Communication Logged', `${this.TYPES[type].label} with ${this.PARTIES[party].label} recorded.`, 'success');
            },

            openEditModal: function (id) {
                const comm = DataStore.getCommunications().find(c => c.id === id);
                if (!comm) return;

                const sites = DataStore.getSites();
                const guards = DataStore.getGuards();
                const dateStr = comm.dateTime ? new Date(comm.dateTime).toISOString().slice(0, 16) : '';

                const content = `
                    <form id="edit-comm-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Communication Type *</label>
                                <select class="form-select" id="edit-comm-type" required>
                                    ${Object.entries(this.TYPES).map(([key, t]) => `
                                        <option value="${key}" ${comm.type === key ? 'selected' : ''}>${t.icon} ${t.label}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">With Whom *</label>
                                <select class="form-select" id="edit-comm-party" required>
                                    ${Object.entries(this.PARTIES).map(([key, p]) => `
                                        <option value="${key}" ${comm.party === key ? 'selected' : ''}>${p.label}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Contact Name</label>
                                <input type="text" class="form-input" id="edit-comm-contact-name" value="${Utils.escapeHtml(comm.contactName || '')}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contact Info</label>
                                <input type="text" class="form-input" id="edit-comm-contact-info" value="${Utils.escapeHtml(comm.contactInfo || '')}">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Date/Time *</label>
                                <input type="datetime-local" class="form-input" id="edit-comm-datetime" value="${dateStr}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Duration (minutes)</label>
                                <input type="number" class="form-input" id="edit-comm-duration" value="${comm.duration || ''}" min="1">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Related Site</label>
                                <select class="form-select" id="edit-comm-site">
                                    <option value="">No specific site</option>
                                    ${sites.map(s => `<option value="${s.id}" ${comm.siteId === s.id ? 'selected' : ''}>${Utils.escapeHtml(s.name)}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Related Guard</label>
                                <select class="form-select" id="edit-comm-guard">
                                    <option value="">No specific guard</option>
                                    ${guards.filter(g => g.status === 'active').map(g => `
                                        <option value="${g.id}" ${comm.guardId === g.id ? 'selected' : ''}>${Utils.escapeHtml(g.name)}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Subject/Purpose *</label>
                            <input type="text" class="form-input" id="edit-comm-subject" value="${Utils.escapeHtml(comm.subject || '')}" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Summary/Notes</label>
                            <textarea class="form-input" id="edit-comm-summary" rows="4">${Utils.escapeHtml(comm.summary || '')}</textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Logged By</label>
                            <input type="text" class="form-input" id="edit-comm-logged-by" value="${Utils.escapeHtml(comm.loggedBy || '')}">
                        </div>

                        <div style="background: var(--color-surface); padding: var(--space-4); border-radius: var(--radius-md); margin-top: var(--space-4);">
                            <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer; margin-bottom: var(--space-3);">
                                <input type="checkbox" id="edit-comm-followup-required" ${comm.followUpRequired ? 'checked' : ''}>
                                <span style="font-weight: var(--font-weight-medium);">ğŸ“‹ Requires Follow-up</span>
                            </label>
                            <div id="edit-followup-fields" style="display: ${comm.followUpRequired ? 'block' : 'none'};">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Follow-up Date</label>
                                        <input type="date" class="form-input" id="edit-comm-followup-date" value="${comm.followUpDate || ''}">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Follow-up Status</label>
                                        <select class="form-select" id="edit-comm-followup-status">
                                            <option value="pending" ${comm.followUpStatus === 'pending' ? 'selected' : ''}>Pending</option>
                                            <option value="in_progress" ${comm.followUpStatus === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                            <option value="completed" ${comm.followUpStatus === 'completed' ? 'selected' : ''}>Completed</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Follow-up Action/Notes</label>
                                    <textarea class="form-input" id="edit-comm-followup-notes" rows="2">${Utils.escapeHtml(comm.followUpAction || comm.followUpNotes || '')}</textarea>
                                </div>
                            </div>
                        </div>

                        <div class="text-xs text-muted mt-4">
                            Created: ${Utils.formatDateTime(comm.createdAt)}
                            ${comm.updatedAt !== comm.createdAt ? ` â€¢ Updated: ${Utils.formatDateTime(comm.updatedAt)}` : ''}
                        </div>
                    </form>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="CommsLogModule.saveEditComm('${id}')">Save Changes</button>
                `;

                UI.openModal('Edit Communication', content, footer, 'lg');

                // Toggle follow-up fields
                document.getElementById('edit-comm-followup-required')?.addEventListener('change', (e) => {
                    document.getElementById('edit-followup-fields').style.display = e.target.checked ? 'block' : 'none';
                });
            },

            saveEditComm: function (id) {
                const type = document.getElementById('edit-comm-type').value;
                const party = document.getElementById('edit-comm-party').value;
                const contactName = document.getElementById('edit-comm-contact-name').value.trim();
                const contactInfo = document.getElementById('edit-comm-contact-info').value.trim();
                const dateTime = document.getElementById('edit-comm-datetime').value;
                const duration = document.getElementById('edit-comm-duration').value;
                const siteId = document.getElementById('edit-comm-site').value;
                const guardId = document.getElementById('edit-comm-guard').value;
                const subject = document.getElementById('edit-comm-subject').value.trim();
                const summary = document.getElementById('edit-comm-summary').value.trim();
                const loggedBy = document.getElementById('edit-comm-logged-by').value.trim();
                const followUpRequired = document.getElementById('edit-comm-followup-required').checked;
                const followUpDate = document.getElementById('edit-comm-followup-date').value;
                const followUpStatus = document.getElementById('edit-comm-followup-status').value;
                const followUpNotes = document.getElementById('edit-comm-followup-notes').value.trim();

                if (!type || !party || !dateTime || !subject) {
                    UI.toast('Missing Fields', 'Type, party, date/time, and subject are required.', 'error');
                    return;
                }

                DataStore.updateCommunication(id, {
                    type,
                    party,
                    contactName: contactName || null,
                    contactInfo: contactInfo || null,
                    dateTime: new Date(dateTime).toISOString(),
                    duration: duration ? parseInt(duration) : null,
                    siteId: siteId || null,
                    guardId: guardId || null,
                    subject,
                    summary: summary || null,
                    loggedBy: loggedBy || null,
                    followUpRequired,
                    followUpDate: followUpRequired && followUpDate ? followUpDate : null,
                    followUpStatus: followUpRequired ? followUpStatus : null,
                    followUpNotes: followUpRequired && followUpNotes ? followUpNotes : null
                });

                UI.closeModal();
                this.render();
                UI.toast('Communication Updated', 'Changes have been saved.', 'success');
            },

            markFollowupComplete: function (id) {
                const comm = DataStore.getCommunications().find(c => c.id === id);
                if (!comm) return;

                const content = `
                    <div style="margin-bottom: var(--space-4);">
                        <div style="font-weight: var(--font-weight-semibold);">${Utils.escapeHtml(comm.subject)}</div>
                        <div class="text-sm text-muted">${Utils.formatDateTime(comm.dateTime)}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Completion Notes</label>
                        <textarea class="form-input" id="followup-complete-notes" rows="3" placeholder="What was done to complete this follow-up?"></textarea>
                    </div>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                    <button class="btn btn-success" onclick="CommsLogModule.confirmMarkComplete('${id}')">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Mark Complete
                    </button>
                `;

                UI.openModal('Complete Follow-up', content, footer);
            },

            confirmMarkComplete: function (id) {
                const notes = document.getElementById('followup-complete-notes').value.trim();

                DataStore.updateCommunication(id, {
                    followUpStatus: 'completed',
                    followUpNotes: notes || 'Completed',
                    followUpCompletedAt: new Date().toISOString()
                });

                UI.closeModal();
                this.render();
                UI.toast('Follow-up Completed', 'Item has been marked as complete.', 'success');
            },

            deleteComm: async function (id) {
                const comm = DataStore.getCommunications().find(c => c.id === id);
                if (!comm) return;

                const confirmed = await UI.confirm('Delete Communication', `Are you sure you want to delete this communication log?`);
                if (!confirmed) return;

                DataStore.deleteCommunication(id);
                this.render();
                UI.toast('Communication Deleted', 'Log entry has been removed.', 'success');
            },

            // Clean up duplicate communications
            cleanupDuplicates: function() {
                const comms = DataStore.getCommunications();
                const seen = new Map();
                const duplicates = [];
                
                // Find duplicates by comparing key fields
                comms.forEach(comm => {
                    // Create a key from subject + dateTime + contactName + summary
                    const key = `${comm.subject || ''}|${comm.dateTime || ''}|${comm.contactName || ''}|${(comm.summary || '').substring(0, 100)}`;
                    
                    if (seen.has(key)) {
                        // This is a duplicate
                        duplicates.push(comm.id);
                    } else {
                        seen.set(key, comm.id);
                    }
                });
                
                if (duplicates.length === 0) {
                    UI.toast('No Duplicates', 'No duplicate communications found.', 'info');
                    return;
                }
                
                // Remove duplicates
                const filtered = comms.filter(c => !duplicates.includes(c.id));
                DataStore.saveCommunications(filtered);
                
                // Also delete from Firestore
                duplicates.forEach(id => {
                    DataStore._syncToFirestore('deleteCommunication', id);
                });
                
                this.render();
                UI.toast('Duplicates Removed', `Removed ${duplicates.length} duplicate entries.`, 'success');
            },

            exportCSV: function () {
                let comms = DataStore.getCommunications();
                const sites = DataStore.getSites();

                // Apply same filters as renderList
                if (this.filters.type) comms = comms.filter(c => c.type === this.filters.type);
                if (this.filters.party) comms = comms.filter(c => c.party === this.filters.party);
                if (this.filters.site) comms = comms.filter(c => c.siteId === this.filters.site);
                if (this.filters.search) {
                    comms = comms.filter(c =>
                        (c.subject && c.subject.toLowerCase().includes(this.filters.search)) ||
                        (c.contactName && c.contactName.toLowerCase().includes(this.filters.search)) ||
                        (c.summary && c.summary.toLowerCase().includes(this.filters.search))
                    );
                }

                // Headers with ID as first column
                const headers = ['ID', 'Date/Time', 'Type', 'Party', 'Contact Name', 'Contact Info', 'Site', 'Subject', 'Summary', 'Duration (min)', 'Logged By', 'Follow-up Required', 'Follow-up Date', 'Follow-up Status'];
                const rows = comms.map(c => {
                    const site = c.siteId ? sites.find(s => s.id === c.siteId) : null;
                    return [
                        c.id || '',
                        c.dateTime ? new Date(c.dateTime).toLocaleString() : '',
                        this.TYPES[c.type]?.label || c.type,
                        this.PARTIES[c.party]?.label || c.party,
                        c.contactName || '',
                        c.contactInfo || '',
                        site ? site.name : '',
                        c.subject || '',
                        (c.summary || '').replace(/\n/g, ' '),
                        c.duration || '',
                        c.loggedBy || '',
                        c.followUpRequired ? 'Yes' : 'No',
                        c.followUpDate || '',
                        c.followUpStatus || ''
                    ];
                });

                // Use \r\n line endings for Excel compatibility
                const csv = [headers, ...rows].map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\r\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `communications_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);

                UI.toast('Export Complete', `${comms.length} communications exported to CSV.`, 'success');
            },

            // Get items for Attention Panel
            getAttentionItems: function () {
                const overdue = DataStore.getFollowUpCommunications().filter(c => 
                    c.followUpDate && new Date(c.followUpDate) < new Date()
                );
                const pending = DataStore.getFollowUpCommunications().filter(c => 
                    !c.followUpDate || new Date(c.followUpDate) >= new Date()
                );
                const items = [];

                if (overdue.length > 0) {
                    items.push({
                        icon: 'ğŸ“',
                        title: `${overdue.length} overdue follow-up${overdue.length > 1 ? 's' : ''}`,
                        detail: overdue.slice(0, 2).map(c => c.subject).join(', '),
                        badge: 'OVERDUE',
                        severity: 'critical',
                        action: "Router.navigate('commslog')"
                    });
                }

                if (pending.length > 0) {
                    items.push({
                        icon: 'ğŸ“‹',
                        title: `${pending.length} follow-up${pending.length > 1 ? 's' : ''} pending`,
                        detail: 'Communications requiring action',
                        badge: 'ACTION',
                        severity: 'warning',
                        action: "Router.navigate('commslog')"
                    });
                }

                return items;
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EXPORT MODULE â€” Unified Export Center
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const ExportModule = {
            init: function () {
                // Initialize date range handler
                document.getElementById('export-date-range')?.addEventListener('change', () => this.updateDateRange());
            },

            render: function () {
                UI.populateSiteSelect('export-site-filter', true);
                this.updateDateRange();
            },

            updateDateRange: function () {
                const range = document.getElementById('export-date-range')?.value;
                const startField = document.getElementById('custom-date-start');
                const endField = document.getElementById('custom-date-end');
                
                if (range === 'custom') {
                    startField.style.display = 'block';
                    endField.style.display = 'block';
                } else {
                    startField.style.display = 'none';
                    endField.style.display = 'none';
                }
            },

            getDateRange: function () {
                const range = document.getElementById('export-date-range')?.value || 'week';
                const now = new Date();
                let start, end;

                switch (range) {
                    case 'today':
                        start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                        break;
                    case 'yesterday':
                        start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                        end = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, 23, 59, 59);
                        break;
                    case 'week':
                        const dayOfWeek = now.getDay();
                        start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - dayOfWeek);
                        end = now;
                        break;
                    case 'lastweek':
                        const lastWeekDay = now.getDay();
                        start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - lastWeekDay - 7);
                        end = new Date(now.getFullYear(), now.getMonth(), now.getDate() - lastWeekDay - 1, 23, 59, 59);
                        break;
                    case 'month':
                        start = new Date(now.getFullYear(), now.getMonth(), 1);
                        end = now;
                        break;
                    case 'lastmonth':
                        start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        end = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
                        break;
                    case 'custom':
                        const startVal = document.getElementById('export-start-date')?.value;
                        const endVal = document.getElementById('export-end-date')?.value;
                        start = startVal ? new Date(startVal) : new Date(now.getFullYear(), now.getMonth(), 1);
                        end = endVal ? new Date(endVal + 'T23:59:59') : now;
                        break;
                    default:
                        start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
                        end = now;
                }

                return { start, end };
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // QUICK REPORTS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            generateWeeklyReport: function () {
                // Use DateUtils for consistent date handling
                const dateRange = DateUtils.last7Days();
                const startDate = new Date(dateRange.start);
                const endDate = new Date(dateRange.end);

                // Get metrics from AnalyticsModule (single source of truth)
                const coverageSummary = AnalyticsModule.computeCoverageSummary(dateRange);
                const incidentSummary = AnalyticsModule.computeIncidentSummary(dateRange);
                const calloffSummary = AnalyticsModule.computeCalloffSummary(dateRange);
                const inspectionSummary = AnalyticsModule.computeInspectionSummary(dateRange);

                // Get static counts from DataStore
                const sites = DataStore.getSites();
                const guards = DataStore.getGuards();
                const activeSites = sites.filter(s => s.status === 'active').length;
                const activeGuards = guards.filter(g => g.status === 'active').length;

                // Get incident list for detail table (filtered by date)
                const incidents = DataStore.getIncidents().filter(i => 
                    DateUtils.isWithin(i.dateTime || i.date, dateRange)
                );

                const html = `
<!DOCTYPE html>
<html>
<head>
    <title>Weekly Operations Report - Newark Security</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
        h1 { color: #1a1a2e; border-bottom: 3px solid #4361ee; padding-bottom: 10px; }
        h2 { color: #1a1a2e; margin-top: 30px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .period { color: #666; font-size: 14px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
        .stat-box { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 32px; font-weight: bold; color: #1a1a2e; }
        .stat-label { font-size: 12px; color: #666; text-transform: uppercase; margin-top: 5px; }
        .stat-box.danger .stat-value { color: #dc3545; }
        .stat-box.warning .stat-value { color: #ffc107; }
        .stat-box.success .stat-value { color: #28a745; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; font-weight: 600; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .badge-critical { background: #dc3545; color: white; }
        .badge-high { background: #fd7e14; color: white; }
        .badge-medium { background: #ffc107; color: #333; }
        .badge-low { background: #28a745; color: white; }
        @media print { body { margin: 0; } .no-print { display: none; } }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>ğŸ“Š Weekly Operations Report</h1>
            <p class="period">${startDate.toLocaleDateString()} â€” ${endDate.toLocaleDateString()}</p>
        </div>
        <div style="text-align: right;">
            <div style="font-weight: bold;">Newark Security</div>
            <div style="font-size: 12px; color: #666;">Generated: ${new Date().toLocaleString()}</div>
        </div>
    </div>

    <h2>ğŸ“ˆ Overview</h2>
    <div class="stats-grid">
        <div class="stat-box">
            <div class="stat-value">${activeSites}</div>
            <div class="stat-label">Active Sites</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">${activeGuards}</div>
            <div class="stat-label">Active Guards</div>
        </div>
        <div class="stat-box ${incidentSummary.total > 10 ? 'danger' : ''}">
            <div class="stat-value">${incidentSummary.total}</div>
            <div class="stat-label">Incidents</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">${calloffSummary.total}</div>
            <div class="stat-label">Call-offs</div>
        </div>
    </div>

    <h2>ğŸ“‹ Coverage Summary</h2>
    <div class="stats-grid">
        <div class="stat-box">
            <div class="stat-value">${coverageSummary.totalShifts}</div>
            <div class="stat-label">Total Shifts</div>
        </div>
        <div class="stat-box success">
            <div class="stat-value">${coverageSummary.coveredShifts}</div>
            <div class="stat-label">Covered</div>
        </div>
        <div class="stat-box ${coverageSummary.openShifts > 0 ? 'warning' : 'success'}">
            <div class="stat-value">${coverageSummary.openShifts}</div>
            <div class="stat-label">Open</div>
        </div>
        <div class="stat-box ${coverageSummary.coveragePercent < 90 ? 'warning' : 'success'}">
            <div class="stat-value">${coverageSummary.coveragePercent}%</div>
            <div class="stat-label">Coverage Rate</div>
        </div>
    </div>

    <h2>ğŸš¨ Incident Summary</h2>
    <div class="stats-grid">
        <div class="stat-box danger">
            <div class="stat-value">${incidentSummary.bySeverity.critical}</div>
            <div class="stat-label">Critical</div>
        </div>
        <div class="stat-box warning">
            <div class="stat-value">${incidentSummary.bySeverity.high}</div>
            <div class="stat-label">High</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">${incidentSummary.bySeverity.medium}</div>
            <div class="stat-label">Medium</div>
        </div>
        <div class="stat-box success">
            <div class="stat-value">${incidentSummary.bySeverity.low}</div>
            <div class="stat-label">Low</div>
        </div>
    </div>

    ${incidents.length > 0 ? `
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Site</th>
                <th>Type</th>
                <th>Severity</th>
            </tr>
        </thead>
        <tbody>
            ${incidents.slice(0, 20).map(i => {
                const site = sites.find(s => s.id === i.siteId);
                return `
                <tr>
                    <td>${new Date(i.dateTime).toLocaleDateString()}</td>
                    <td>${site ? site.name : 'Unknown'}</td>
                    <td>${i.type}</td>
                    <td><span class="badge badge-${(i.severity || 'medium').toLowerCase()}">${i.severity}</span></td>
                </tr>
                `;
            }).join('')}
        </tbody>
    </table>
    ` : '<p>No incidents during this period.</p>'}

    <h2>âœ… Inspection Summary</h2>
    <div class="stats-grid">
        <div class="stat-box">
            <div class="stat-value">${inspectionSummary.total}</div>
            <div class="stat-label">Total Inspections</div>
        </div>
        <div class="stat-box success">
            <div class="stat-value">${inspectionSummary.passed}</div>
            <div class="stat-label">Passed</div>
        </div>
        <div class="stat-box ${inspectionSummary.failed > 0 ? 'danger' : 'success'}">
            <div class="stat-value">${inspectionSummary.failed}</div>
            <div class="stat-label">Failed</div>
        </div>
        <div class="stat-box ${inspectionSummary.needsFollowUp > 0 ? 'warning' : ''}">
            <div class="stat-value">${inspectionSummary.needsFollowUp}</div>
            <div class="stat-label">Needs Follow-Up</div>
        </div>
    </div>

    <h2>ğŸ“µ Call-off Summary</h2>
    <div class="stats-grid">
        <div class="stat-box">
            <div class="stat-value">${calloffSummary.total}</div>
            <div class="stat-label">Total Call-offs</div>
        </div>
        <div class="stat-box success">
            <div class="stat-value">${calloffSummary.covered}</div>
            <div class="stat-label">Covered</div>
        </div>
        <div class="stat-box ${calloffSummary.uncovered > 0 ? 'warning' : 'success'}">
            <div class="stat-value">${calloffSummary.uncovered}</div>
            <div class="stat-label">Uncovered</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">${calloffSummary.pending}</div>
            <div class="stat-label">Pending</div>
        </div>
    </div>

    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666;">
        <p>This report was automatically generated by Sentinel Ops. For questions, contact your operations manager.</p>
    </div>
</body>
</html>`;

                this.downloadHTML(html, `weekly_ops_report_${Utils.toISODate(new Date())}.html`);
                UI.toast('Report Generated', 'Weekly Operations Report downloaded.', 'success');
            },

            exportGuardRoster: function () {
                const guards = DataStore.getGuards();
                const sites = DataStore.getSites();

                const headers = ['Name', 'Status', 'Role', 'Phone', 'Email', 'Hire Date', 'Hourly Rate', 'Primary Sites', 'Certifications'];
                const rows = guards.map(g => {
                    const primarySites = (g.primarySites || []).map(id => {
                        const site = sites.find(s => s.id === id);
                        return site ? site.name : '';
                    }).filter(Boolean).join('; ');

                    return [
                        g.name || '',
                        g.status,
                        g.role || 'guard',
                        g.phone || '',
                        g.email || '',
                        g.hireDate || '',
                        g.hourlyRate || '',
                        primarySites,
                        (g.certifications || []).join('; ')
                    ];
                });

                this.downloadCSV([headers, ...rows], `guard_roster_${Utils.toISODate(new Date())}.csv`);
                UI.toast('Export Complete', `${guards.length} guards exported.`, 'success');
            },

            openIncidentExport: function () {
                const sites = DataStore.getSites();
                const content = `
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-input" id="incident-export-start" value="${Utils.toISODate(new Date(new Date().setDate(new Date().getDate() - 30)))}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-input" id="incident-export-end" value="${Utils.toISODate(new Date())}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Site</label>
                            <select class="form-select" id="incident-export-site">
                                <option value="">All Sites</option>
                                ${sites.map(s => `<option value="${s.id}">${Utils.escapeHtml(s.name)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Severity</label>
                            <select class="form-select" id="incident-export-severity">
                                <option value="">All Severities</option>
                                <option value="Critical">Critical</option>
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Format</label>
                        <select class="form-select" id="incident-export-format">
                            <option value="csv">CSV</option>
                            <option value="print">Print-Ready Report</option>
                        </select>
                    </div>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="ExportModule.runIncidentExport()">Export</button>
                `;

                UI.openModal('Export Incidents', content, footer);
            },

            runIncidentExport: function () {
                const startDate = new Date(document.getElementById('incident-export-start').value);
                const endDate = new Date(document.getElementById('incident-export-end').value + 'T23:59:59');
                const siteId = document.getElementById('incident-export-site').value;
                const severity = document.getElementById('incident-export-severity').value;
                const format = document.getElementById('incident-export-format').value;

                let incidents = DataStore.getIncidents().filter(i => {
                    const d = new Date(i.dateTime);
                    return d >= startDate && d <= endDate;
                });

                if (siteId) incidents = incidents.filter(i => i.siteId === siteId);
                if (severity) incidents = incidents.filter(i => i.severity === severity);

                const sites = DataStore.getSites();
                const guards = DataStore.getGuards();

                if (format === 'csv') {
                    const headers = ['Date/Time', 'Site', 'Type', 'Severity', 'Status', 'Guards Involved', 'Narrative'];
                    const rows = incidents.map(i => {
                        const site = sites.find(s => s.id === i.siteId);
                        const guardNames = (i.guardIds || []).map(gid => {
                            const g = guards.find(guard => guard.id === gid);
                            return g ? g.name : '';
                        }).filter(Boolean).join('; ');

                        return [
                            new Date(i.dateTime).toLocaleString(),
                            site ? site.name : '',
                            i.type,
                            i.severity,
                            i.status,
                            guardNames,
                            (i.narrative || '').replace(/\n/g, ' ')
                        ];
                    });

                    this.downloadCSV([headers, ...rows], `incidents_${Utils.toISODate(startDate)}_to_${Utils.toISODate(endDate)}.csv`);
                } else {
                    // Generate print-ready HTML
                    const html = this.generateIncidentReportHTML(incidents, sites, guards, startDate, endDate);
                    this.downloadHTML(html, `incident_report_${Utils.toISODate(new Date())}.html`);
                }

                UI.closeModal();
                UI.toast('Export Complete', `${incidents.length} incidents exported.`, 'success');
            },

            generateIncidentReportHTML: function (incidents, sites, guards, startDate, endDate) {
                return `
<!DOCTYPE html>
<html>
<head>
    <title>Incident Report - Newark Security</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
        h1 { color: #1a1a2e; border-bottom: 3px solid #dc3545; padding-bottom: 10px; }
        .incident { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .incident.critical { border-left: 4px solid #dc3545; }
        .incident.high { border-left: 4px solid #fd7e14; }
        .incident.medium { border-left: 4px solid #ffc107; }
        .incident.low { border-left: 4px solid #28a745; }
        .incident-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .incident-type { font-weight: bold; font-size: 16px; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; color: white; }
        .badge-critical { background: #dc3545; }
        .badge-high { background: #fd7e14; }
        .badge-medium { background: #ffc107; color: #333; }
        .badge-low { background: #28a745; }
        .incident-meta { font-size: 13px; color: #666; margin-bottom: 10px; }
        .narrative { background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 14px; line-height: 1.6; }
        @media print { .incident { page-break-inside: avoid; } }
    </style>
</head>
<body>
    <h1>ğŸš¨ Incident Report</h1>
    <p style="color: #666;">${startDate.toLocaleDateString()} â€” ${endDate.toLocaleDateString()} | ${incidents.length} incidents</p>
    
    ${incidents.map(i => {
        const site = sites.find(s => s.id === i.siteId);
        const guardNames = (i.guardIds || []).map(gid => {
            const g = guards.find(guard => guard.id === gid);
            return g ? g.name : '';
        }).filter(Boolean).join(', ');

        return `
        <div class="incident ${i.severity.toLowerCase()}">
            <div class="incident-header">
                <span class="incident-type">${i.type}</span>
                <span class="badge badge-${i.severity.toLowerCase()}">${i.severity}</span>
            </div>
            <div class="incident-meta">
                ğŸ“… ${new Date(i.dateTime).toLocaleString()} | 
                ğŸ¢ ${site ? site.name : 'Unknown'} |
                ğŸ‘¥ ${guardNames || 'N/A'}
            </div>
            <div class="narrative">${(i.narrative || 'No narrative provided.').replace(/\n/g, '<br>')}</div>
        </div>
        `;
    }).join('')}

    <div style="margin-top: 40px; font-size: 12px; color: #666; border-top: 1px solid #ddd; padding-top: 20px;">
        Generated by Sentinel Ops on ${new Date().toLocaleString()}
    </div>
</body>
</html>`;
            },

            openScheduleExport: function () {
                const content = `
                    <div class="form-group">
                        <label class="form-label">Week</label>
                        <input type="week" class="form-input" id="schedule-export-week" value="${Utils.getWeekKey(new Date())}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">View By</label>
                        <select class="form-select" id="schedule-export-view">
                            <option value="site">By Site</option>
                            <option value="guard">By Guard</option>
                        </select>
                    </div>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="ExportModule.runScheduleExport()">Export</button>
                `;

                UI.openModal('Export Schedule', content, footer);
            },

            runScheduleExport: function () {
                const weekKey = document.getElementById('schedule-export-week').value;
                const viewBy = document.getElementById('schedule-export-view').value;
                const schedule = DataStore.getScheduleForWeek(weekKey);
                const sites = DataStore.getSites();
                const guards = DataStore.getGuards();

                if (viewBy === 'site') {
                    const headers = ['Site', 'Day', 'Shift', 'Guard', 'Notes'];
                    const rows = [];

                    sites.forEach(site => {
                        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                        days.forEach(day => {
                            const shifts = (schedule[day] || []).filter(s => s.siteId === site.id);
                            shifts.forEach(s => {
                                const guard = guards.find(g => g.id === s.guardId);
                                rows.push([
                                    site.name,
                                    day,
                                    s.shift || '',
                                    guard ? guard.name : 'OPEN',
                                    s.notes || ''
                                ]);
                            });
                        });
                    });

                    this.downloadCSV([headers, ...rows], `schedule_${weekKey}_by_site.csv`);
                } else {
                    const headers = ['Guard', 'Day', 'Site', 'Shift'];
                    const rows = [];

                    guards.filter(g => g.status === 'active').forEach(guard => {
                        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                        days.forEach(day => {
                            const shifts = (schedule[day] || []).filter(s => s.guardId === guard.id);
                            shifts.forEach(s => {
                                const site = sites.find(st => st.id === s.siteId);
                                rows.push([
                                    guard.name,
                                    day,
                                    site ? site.name : '',
                                    s.shift || ''
                                ]);
                            });
                        });
                    });

                    this.downloadCSV([headers, ...rows], `schedule_${weekKey}_by_guard.csv`);
                }

                UI.closeModal();
                UI.toast('Schedule Exported', `Week ${weekKey} schedule downloaded.`, 'success');
            },

            openPayrollExport: function () {
                const content = `
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-input" id="payroll-start" value="${Utils.toISODate(new Date(new Date().setDate(new Date().getDate() - 14)))}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-input" id="payroll-end" value="${Utils.toISODate(new Date())}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                            <input type="checkbox" id="payroll-include-rate" checked>
                            <span>Include hourly rate and cost calculations</span>
                        </label>
                    </div>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="ExportModule.runPayrollExport()">Export</button>
                `;

                UI.openModal('Payroll/Hours Report', content, footer);
            },

            runPayrollExport: function () {
                const startDate = new Date(document.getElementById('payroll-start').value);
                const endDate = new Date(document.getElementById('payroll-end').value);
                const includeRate = document.getElementById('payroll-include-rate').checked;

                const guards = DataStore.getGuards().filter(g => g.status === 'active');
                const sites = DataStore.getSites();

                // Calculate hours per guard
                const guardHours = {};
                guards.forEach(g => {
                    guardHours[g.id] = { regular: 0, overtime: 0, totalHours: 0 };
                });

                // Iterate through weeks in range
                const current = new Date(startDate);
                while (current <= endDate) {
                    const weekKey = Utils.getWeekKey(current);
                    const schedule = DataStore.getScheduleForWeek(weekKey);
                    
                    Object.values(schedule).forEach(dayShifts => {
                        dayShifts.forEach(shift => {
                            if (guardHours[shift.guardId]) {
                                const hours = OvertimeModule.parseShiftHours(shift.shift);
                                guardHours[shift.guardId].totalHours += hours;
                            }
                        });
                    });

                    current.setDate(current.getDate() + 7);
                }

                // Calculate OT
                Object.keys(guardHours).forEach(gid => {
                    const total = guardHours[gid].totalHours;
                    guardHours[gid].regular = Math.min(total, 40);
                    guardHours[gid].overtime = Math.max(0, total - 40);
                });

                const headers = includeRate 
                    ? ['Guard', 'Regular Hours', 'OT Hours', 'Total Hours', 'Hourly Rate', 'Regular Pay', 'OT Pay (1.5x)', 'Total Pay']
                    : ['Guard', 'Regular Hours', 'OT Hours', 'Total Hours'];

                const rows = guards.map(g => {
                    const h = guardHours[g.id];
                    const rate = parseFloat(g.hourlyRate) || 0;
                    const regularPay = h.regular * rate;
                    const otPay = h.overtime * rate * 1.5;

                    if (includeRate) {
                        return [
                            g.name,
                            h.regular.toFixed(1),
                            h.overtime.toFixed(1),
                            h.totalHours.toFixed(1),
                            rate ? `$${rate.toFixed(2)}` : '',
                            rate ? `$${regularPay.toFixed(2)}` : '',
                            rate ? `$${otPay.toFixed(2)}` : '',
                            rate ? `$${(regularPay + otPay).toFixed(2)}` : ''
                        ];
                    } else {
                        return [
                            g.name,
                            h.regular.toFixed(1),
                            h.overtime.toFixed(1),
                            h.totalHours.toFixed(1)
                        ];
                    }
                });

                this.downloadCSV([headers, ...rows], `payroll_${Utils.toISODate(startDate)}_to_${Utils.toISODate(endDate)}.csv`);
                UI.closeModal();
                UI.toast('Payroll Report Exported', `Hours for ${guards.length} guards calculated.`, 'success');
            },

            openClientReport: function () {
                const sites = DataStore.getSites();
                const content = `
                    <div class="form-group">
                        <label class="form-label">Select Site *</label>
                        <select class="form-select" id="client-report-site" required>
                            <option value="">Choose a site...</option>
                            ${sites.map(s => `<option value="${s.id}">${Utils.escapeHtml(s.name)}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-input" id="client-report-start" value="${Utils.toISODate(new Date(new Date().setDate(new Date().getDate() - 30)))}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-input" id="client-report-end" value="${Utils.toISODate(new Date())}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Include Sections</label>
                        <div style="display: grid; gap: var(--space-2); margin-top: var(--space-2);">
                            <label style="display: flex; align-items: center; gap: var(--space-2);">
                                <input type="checkbox" id="client-inc-coverage" checked> Coverage Summary
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--space-2);">
                                <input type="checkbox" id="client-inc-incidents" checked> Incident Report
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--space-2);">
                                <input type="checkbox" id="client-inc-inspections" checked> Inspections
                            </label>
                        </div>
                    </div>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="ExportModule.runClientReport()">Generate Report</button>
                `;

                UI.openModal('Client Site Report', content, footer);
            },

            runClientReport: function () {
                const siteId = document.getElementById('client-report-site').value;
                if (!siteId) {
                    UI.toast('Select Site', 'Please choose a site for the report.', 'error');
                    return;
                }

                const site = DataStore.getSites().find(s => s.id === siteId);
                const startDate = new Date(document.getElementById('client-report-start').value);
                const endDate = new Date(document.getElementById('client-report-end').value + 'T23:59:59');
                const incCoverage = document.getElementById('client-inc-coverage').checked;
                const incIncidents = document.getElementById('client-inc-incidents').checked;
                const incInspections = document.getElementById('client-inc-inspections').checked;

                const incidents = DataStore.getIncidents().filter(i => 
                    i.siteId === siteId && new Date(i.dateTime) >= startDate && new Date(i.dateTime) <= endDate
                );
                const inspections = DataStore.getInspections().filter(i => 
                    i.siteId === siteId && new Date(i.dateTime) >= startDate && new Date(i.dateTime) <= endDate
                );
                const guards = DataStore.getGuards();

                const html = `
<!DOCTYPE html>
<html>
<head>
    <title>Site Activity Report - ${site.name}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; color: #333; }
        h1 { color: #1a1a2e; }
        h2 { color: #1a1a2e; margin-top: 30px; border-bottom: 2px solid #eee; padding-bottom: 8px; }
        .header-box { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .stats-row { display: flex; gap: 30px; margin: 20px 0; }
        .stat { text-align: center; }
        .stat-value { font-size: 28px; font-weight: bold; color: #4361ee; }
        .stat-label { font-size: 12px; color: #666; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; }
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="header-box">
        <h1>ğŸ¢ ${site.name}</h1>
        <p><strong>Activity Report</strong> | ${startDate.toLocaleDateString()} â€” ${endDate.toLocaleDateString()}</p>
        <p style="font-size: 14px; color: #666; margin-top: 10px;">${site.address || ''}</p>
    </div>

    ${incCoverage ? `
    <h2>ğŸ“Š Coverage Summary</h2>
    <div class="stats-row">
        <div class="stat">
            <div class="stat-value">${Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24))}</div>
            <div class="stat-label">Days Covered</div>
        </div>
        <div class="stat">
            <div class="stat-value">${incidents.length}</div>
            <div class="stat-label">Incidents</div>
        </div>
        <div class="stat">
            <div class="stat-value">${inspections.length}</div>
            <div class="stat-label">Inspections</div>
        </div>
    </div>
    ` : ''}

    ${incIncidents && incidents.length > 0 ? `
    <h2>ğŸš¨ Incidents (${incidents.length})</h2>
    <table>
        <thead><tr><th>Date</th><th>Type</th><th>Severity</th><th>Summary</th></tr></thead>
        <tbody>
            ${incidents.map(i => `
            <tr>
                <td>${new Date(i.dateTime).toLocaleDateString()}</td>
                <td>${i.type}</td>
                <td>${i.severity}</td>
                <td>${(i.narrative || '').substring(0, 100)}...</td>
            </tr>
            `).join('')}
        </tbody>
    </table>
    ` : ''}

    ${incInspections && inspections.length > 0 ? `
    <h2>âœ… Inspections (${inspections.length})</h2>
    <table>
        <thead><tr><th>Date</th><th>Inspector</th><th>Status</th><th>Notes</th></tr></thead>
        <tbody>
            ${inspections.map(i => {
                const inspector = guards.find(g => g.id === i.inspectorId);
                return `
                <tr>
                    <td>${new Date(i.dateTime).toLocaleDateString()}</td>
                    <td>${inspector ? inspector.name : 'N/A'}</td>
                    <td>${i.status || 'Complete'}</td>
                    <td>${(i.notes || '').substring(0, 80)}...</td>
                </tr>
                `;
            }).join('')}
        </tbody>
    </table>
    ` : ''}

    <div class="footer">
        <p>Report generated by Newark Security | ${new Date().toLocaleString()}</p>
        <p>For questions, contact your account manager.</p>
    </div>
</body>
</html>`;

                this.downloadHTML(html, `client_report_${site.name.replace(/\s+/g, '_')}_${Utils.toISODate(new Date())}.html`);
                UI.closeModal();
                UI.toast('Client Report Generated', `Report for ${site.name} downloaded.`, 'success');
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CUSTOM EXPORT
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            runCustomExport: function () {
                const { start, end } = this.getDateRange();
                const siteId = document.getElementById('export-site-filter')?.value;
                const format = document.getElementById('export-format')?.value || 'csv';

                const includeIncidents = document.getElementById('export-inc-incidents')?.checked;
                const includeSchedule = document.getElementById('export-inc-schedule')?.checked;
                const includeCalloffs = document.getElementById('export-inc-calloffs')?.checked;
                const includeInspections = document.getElementById('export-inc-inspections')?.checked;
                const includeSupervisorLog = document.getElementById('export-inc-supervisorlog')?.checked;
                const includeComms = document.getElementById('export-inc-communications')?.checked;
                const includeDailyReports = document.getElementById('export-inc-dailyreports')?.checked;

                const data = {};
                const sites = DataStore.getSites();

                if (includeIncidents) {
                    let incidents = DataStore.getIncidents().filter(i => {
                        const d = new Date(i.dateTime);
                        return d >= start && d <= end;
                    });
                    if (siteId) incidents = incidents.filter(i => i.siteId === siteId);
                    data.incidents = incidents;
                }

                if (includeCalloffs) {
                    let calloffs = DataStore.getCalloffs().filter(c => {
                        const d = new Date(c.date);
                        return d >= start && d <= end;
                    });
                    if (siteId) calloffs = calloffs.filter(c => c.siteId === siteId);
                    data.calloffs = calloffs;
                }

                if (includeInspections) {
                    let inspections = DataStore.getInspections().filter(i => {
                        const d = new Date(i.dateTime);
                        return d >= start && d <= end;
                    });
                    if (siteId) inspections = inspections.filter(i => i.siteId === siteId);
                    data.inspections = inspections;
                }

                if (includeSupervisorLog) {
                    let logs = DataStore.getSupervisorLog().filter(l => {
                        const d = new Date(l.dateTime);
                        return d >= start && d <= end;
                    });
                    if (siteId) logs = logs.filter(l => l.siteId === siteId);
                    data.supervisorLog = logs;
                }

                if (includeComms) {
                    let comms = DataStore.getCommunications().filter(c => {
                        const d = new Date(c.dateTime);
                        return d >= start && d <= end;
                    });
                    if (siteId) comms = comms.filter(c => c.siteId === siteId);
                    data.communications = comms;
                }

                if (includeDailyReports) {
                    let reports = DataStore.getDailyReports().filter(r => {
                        const d = new Date(r.date);
                        return d >= start && d <= end;
                    });
                    if (siteId) reports = reports.filter(r => r.siteId === siteId);
                    data.dailyReports = reports;
                }

                if (format === 'json') {
                    const json = JSON.stringify({ exportDate: new Date().toISOString(), dateRange: { start, end }, ...data }, null, 2);
                    Utils.downloadFile(json, `custom_export_${Utils.toISODate(new Date())}.json`, 'application/json');
                } else if (format === 'print') {
                    // Generate combined HTML report
                    const html = this.generateCombinedHTML(data, sites, start, end);
                    this.downloadHTML(html, `custom_report_${Utils.toISODate(new Date())}.html`);
                } else {
                    // CSV - export each type separately in a zip (or just first selected)
                    if (data.incidents) this.exportArrayAsCSV(data.incidents, 'incidents', ['dateTime', 'type', 'severity', 'status', 'narrative']);
                    else if (data.calloffs) this.exportArrayAsCSV(data.calloffs, 'calloffs', ['date', 'guardId', 'reason', 'coverageStatus']);
                    else if (data.communications) this.exportArrayAsCSV(data.communications, 'communications', ['dateTime', 'type', 'party', 'subject', 'summary']);
                }

                UI.toast('Export Complete', 'Custom export downloaded.', 'success');
            },

            generateCombinedHTML: function (data, sites, start, end) {
                return `
<!DOCTYPE html>
<html>
<head>
    <title>Operations Report - Newark Security</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; }
        h1 { color: #1a1a2e; }
        h2 { margin-top: 30px; color: #1a1a2e; border-bottom: 2px solid #eee; padding-bottom: 8px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 13px; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; }
        .section { margin-bottom: 30px; }
    </style>
</head>
<body>
    <h1>ğŸ“Š Operations Report</h1>
    <p style="color: #666;">${start.toLocaleDateString()} â€” ${end.toLocaleDateString()}</p>

    ${data.incidents ? `
    <div class="section">
        <h2>ğŸš¨ Incidents (${data.incidents.length})</h2>
        <table>
            <thead><tr><th>Date</th><th>Type</th><th>Severity</th><th>Status</th></tr></thead>
            <tbody>${data.incidents.map(i => `<tr><td>${new Date(i.dateTime).toLocaleDateString()}</td><td>${i.type}</td><td>${i.severity}</td><td>${i.status}</td></tr>`).join('')}</tbody>
        </table>
    </div>
    ` : ''}

    ${data.calloffs ? `
    <div class="section">
        <h2>ğŸ“µ Call-offs (${data.calloffs.length})</h2>
        <table>
            <thead><tr><th>Date</th><th>Reason</th><th>Coverage</th></tr></thead>
            <tbody>${data.calloffs.map(c => `<tr><td>${c.date}</td><td>${c.reason}</td><td>${c.coverageStatus}</td></tr>`).join('')}</tbody>
        </table>
    </div>
    ` : ''}

    ${data.communications ? `
    <div class="section">
        <h2>ğŸ“ Communications (${data.communications.length})</h2>
        <table>
            <thead><tr><th>Date</th><th>Type</th><th>Subject</th></tr></thead>
            <tbody>${data.communications.map(c => `<tr><td>${new Date(c.dateTime).toLocaleDateString()}</td><td>${c.type}</td><td>${c.subject}</td></tr>`).join('')}</tbody>
        </table>
    </div>
    ` : ''}

    <div style="margin-top: 40px; font-size: 12px; color: #666;">Generated by Sentinel Ops | ${new Date().toLocaleString()}</div>
</body>
</html>`;
            },

            previewExport: function () {
                UI.toast('Preview', 'Use Export to see the full output. Preview feature coming soon.', 'info');
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // BULK EXPORTS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            exportAllIncidents: function () {
                const incidents = DataStore.getIncidents();
                const sites = DataStore.getSites();
                const guards = DataStore.getGuards();

                const headers = ['ID', 'Date/Time', 'Site', 'Type', 'Severity', 'Status', 'Guards', 'Narrative', 'Created'];
                const rows = incidents.map(i => {
                    const site = sites.find(s => s.id === i.siteId);
                    const guardNames = (i.guardIds || []).map(gid => {
                        const g = guards.find(guard => guard.id === gid);
                        return g ? g.name : '';
                    }).filter(Boolean).join('; ');

                    return [i.id, i.dateTime, site?.name || '', i.type, i.severity, i.status, guardNames, (i.narrative || '').replace(/\n/g, ' '), i.createdAt];
                });

                this.downloadCSV([headers, ...rows], `all_incidents_${Utils.toISODate(new Date())}.csv`);
                UI.toast('Export Complete', `${incidents.length} incidents exported.`, 'success');
            },

            exportAllCalloffs: function () {
                const calloffs = DataStore.getCalloffs();
                const headers = ['ID', 'Date', 'Guard ID', 'Site ID', 'Shift', 'Reason', 'Coverage Status', 'Replacement', 'Notes', 'NCNS', 'Created'];
                const rows = calloffs.map(c => [c.id, c.date, c.guardId, c.siteId, c.shift, c.reason, c.coverageStatus, c.replacementGuardId || '', c.notes || '', c.isNCNS ? 'Yes' : 'No', c.createdAt]);
                this.downloadCSV([headers, ...rows], `all_calloffs_${Utils.toISODate(new Date())}.csv`);
                UI.toast('Export Complete', `${calloffs.length} call-offs exported.`, 'success');
            },

            exportAllInspections: function () {
                const inspections = DataStore.getInspections();
                const headers = ['ID', 'Date/Time', 'Site ID', 'Inspector ID', 'Status', 'Notes', 'Created'];
                const rows = inspections.map(i => [i.id, i.dateTime, i.siteId, i.inspectorId, i.status || '', (i.notes || '').replace(/\n/g, ' '), i.createdAt]);
                this.downloadCSV([headers, ...rows], `all_inspections_${Utils.toISODate(new Date())}.csv`);
                UI.toast('Export Complete', `${inspections.length} inspections exported.`, 'success');
            },

            exportAllContacts: function () {
                const contacts = DataStore.getContacts();
                const headers = ['ID', 'Name', 'Type', 'Company', 'Title', 'Phone', 'Email', 'Site ID', 'Notes'];
                const rows = contacts.map(c => [c.id, c.name, c.type, c.company || '', c.title || '', c.phone || '', c.email || '', c.siteId || '', (c.notes || '').replace(/\n/g, ' ')]);
                this.downloadCSV([headers, ...rows], `all_contacts_${Utils.toISODate(new Date())}.csv`);
                UI.toast('Export Complete', `${contacts.length} contacts exported.`, 'success');
            },

            exportAllSites: function () {
                const sites = DataStore.getSites();
                const headers = ['SiteId', 'Name', 'ShortName', 'Address', 'City', 'State', 'Zip', 'Category', 'Status', 'RiskLevel', 'ClientName'];
                const rows = sites.map(s => [
                    s.id, 
                    s.name, 
                    s.shortName || '', 
                    s.address || '', 
                    s.city || '', 
                    s.state || 'NJ', 
                    s.zip || '', 
                    s.category || s.type || '', 
                    s.status || 'active', 
                    s.riskLevel || 'low', 
                    s.clientName || s.managementCompany || ''
                ]);
                this.downloadCSV([headers, ...rows], `all_sites_${Utils.toISODate(new Date())}.csv`);
                UI.toast('Export Complete', `${sites.length} sites exported.`, 'success');
            },

            exportAllGuards: function () {
                const guards = DataStore.getGuards() || [];
                const sites = DataStore.getSites() || [];
                const headers = ['GuardId', 'Name', 'FirstName', 'LastName', 'Phone', 'Email', 'Role', 'Status', 'PrimarySites', 'HireDate', 'CreatedAt', 'UpdatedAt', 'Notes'];
                const rows = guards.map(g => {
                    // Convert primarySites IDs to names
                    const siteNames = (g.primarySites || [])
                        .map(sid => sites.find(s => s.id === sid)?.name || sid)
                        .join('; ');
                    return [
                        g.id,
                        g.name,
                        g.firstName || '',
                        g.lastName || '',
                        g.phone || '',
                        g.email || '',
                        g.role || '',
                        g.status || 'active',
                        siteNames,
                        g.hireDate || '',
                        g.createdAt || '',
                        g.updatedAt || '',
                        (g.notes || '').replace(/\n/g, ' ')
                    ];
                });
                this.downloadCSV([headers, ...rows], `all_guards_${Utils.toISODate(new Date())}.csv`);
                UI.toast('Export Complete', `${guards.length} guards exported.`, 'success');
            },

            exportAllAvailability: function () {
                const availability = DataStore.getAvailability() || [];
                const guards = DataStore.getGuards() || [];
                const sites = DataStore.getSites() || [];

                if (availability.length === 0) {
                    UI.toast('No Data', 'No availability records to export.', 'info');
                    return;
                }

                const headers = ['AvailabilityId', 'GuardId', 'GuardName', 'Date', 'ShiftLabel', 'Status', 'SitePreference', 'Source', 'Notes', 'CreatedAt', 'UpdatedAt'];
                const rows = availability.map(a => {
                    const guard = guards.find(g => g.id === a.guardId);
                    const site = a.sitePreference ? sites.find(s => s.id === a.sitePreference) : null;
                    return [
                        a.id,
                        a.guardId,
                        guard?.name || 'Unknown',
                        a.date,
                        a.shiftLabel,
                        a.status,
                        site?.name || a.sitePreference || '',
                        a.source || 'supervisor',
                        (a.notes || '').replace(/\n/g, ' '),
                        a.createdAt || '',
                        a.updatedAt || ''
                    ];
                });

                // Sort by date, then guard name
                rows.sort((a, b) => {
                    const dateCompare = (a[3] || '').localeCompare(b[3] || '');
                    if (dateCompare !== 0) return dateCompare;
                    return (a[2] || '').localeCompare(b[2] || '');
                });

                this.downloadCSV([headers, ...rows], `all_availability_${Utils.toISODate(new Date())}.csv`);
                UI.toast('Export Complete', `${availability.length} availability records exported.`, 'success');
            },

            exportAllCommunications: function () {
                const comms = DataStore.getCommunications();
                const headers = ['ID', 'Date/Time', 'Type', 'Party', 'Contact Name', 'Contact Info', 'Site ID', 'Subject', 'Summary', 'Follow-up Required', 'Follow-up Date', 'Follow-up Status'];
                const rows = comms.map(c => [c.id, c.dateTime, c.type, c.party, c.contactName || '', c.contactInfo || '', c.siteId || '', c.subject, (c.summary || '').replace(/\n/g, ' '), c.followUpRequired ? 'Yes' : 'No', c.followUpDate || '', c.followUpStatus || '']);
                this.downloadCSV([headers, ...rows], `all_communications_${Utils.toISODate(new Date())}.csv`);
                UI.toast('Export Complete', `${comms.length} communications exported.`, 'success');
            },

            exportAllDocuments: function () {
                const docs = DataStore.getDocuments();
                const headers = ['ID', 'Name', 'Category', 'Site ID', 'Version', 'Effective Date', 'Expiration Date', 'URL', 'Notes'];
                const rows = docs.map(d => [d.id, d.name, d.category, d.siteId || '', d.version || '', d.effectiveDate || '', d.expirationDate || '', d.url || '', (d.notes || '').replace(/\n/g, ' ')]);
                this.downloadCSV([headers, ...rows], `all_documents_${Utils.toISODate(new Date())}.csv`);
                UI.toast('Export Complete', `${docs.length} documents exported.`, 'success');
            },

            exportFullBackup: function () {
                SettingsModule.exportBackup();
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // UTILITIES
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            downloadCSV: function (rows, filename) {
                const csv = rows.map(row => row.map(cell => `"${String(cell || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`).join(',')).join('\r\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            },

            downloadHTML: function (html, filename) {
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            },

            exportArrayAsCSV: function (arr, name, fields) {
                const headers = fields;
                const rows = arr.map(item => fields.map(f => item[f] || ''));
                this.downloadCSV([headers, ...rows], `${name}_${Utils.toISODate(new Date())}.csv`);
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ROLE CONTEXT â€” Admin vs Client Portal
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const RoleContext = {
            isPortalMode() {
                return document.body.classList.contains('portal-mode');
            },
            isAdmin() {
                return !this.isPortalMode();
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CLIENT PORTAL MODULE â€” Read-Only Access for Property Managers
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const ClientPortalModule = {
            currentSiteId: null,
            portalPins: {},
            isAuthenticated: false,

            init: function () {
                // Load saved portal PINs
                this.portalPins = JSON.parse(localStorage.getItem('sentinel_portal_pins') || '{}');
                
                // PIN input enter key
                document.getElementById('portal-pin-input')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.authenticate();
                });
            },

            render: function () {
                if (!this.isAuthenticated) {
                    // Not authenticated - show login, hide dashboard, disable portal mode
                    document.body.classList.remove('portal-mode');
                    document.getElementById('portal-login').style.display = 'block';
                    document.getElementById('portal-dashboard').style.display = 'none';
                    document.getElementById('portal-pin-input').value = '';
                    document.getElementById('portal-pin-input').focus();
                } else {
                    this.renderDashboard();
                }
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PIN MANAGEMENT (Admin Side)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            savePins: function () {
                localStorage.setItem('sentinel_portal_pins', JSON.stringify(this.portalPins));
            },

            openPinManager: function () {
                const sites = DataStore.getSites();
                
                let content = `
                    <p class="text-sm text-muted mb-4">Assign 6-digit PINs to sites for client access. Leave blank to disable access.</p>
                    <div style="max-height: 400px; overflow-y: auto;">
                `;

                sites.forEach(site => {
                    const currentPin = this.portalPins[site.id] || '';
                    content += `
                        <div class="form-group" style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-2) 0; border-bottom: 1px solid var(--color-border);">
                            <div style="flex: 1;">
                                <div style="font-weight: var(--font-weight-medium);">${Utils.escapeHtml(site.name)}</div>
                                <div class="text-xs text-muted">${Utils.escapeHtml(site.address || 'No address')}</div>
                            </div>
                            <input type="text" class="form-input" id="pin-${site.id}" value="${currentPin}" 
                                   placeholder="6-digit PIN" maxlength="6" pattern="[0-9]*" inputmode="numeric"
                                   style="width: 120px; text-align: center; letter-spacing: 0.3em;">
                            <button class="btn btn-ghost btn-sm" onclick="ClientPortalModule.generatePin('${site.id}')" title="Generate Random PIN">
                                ğŸ²
                            </button>
                        </div>
                    `;
                });

                content += '</div>';

                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="ClientPortalModule.savePinSettings()">Save PINs</button>
                `;

                UI.openModal('Manage Portal Access PINs', content, footer);
            },

            generatePin: function (siteId) {
                const pin = Math.floor(100000 + Math.random() * 900000).toString();
                document.getElementById(`pin-${siteId}`).value = pin;
            },

            savePinSettings: function () {
                const sites = DataStore.getSites();
                sites.forEach(site => {
                    const input = document.getElementById(`pin-${site.id}`);
                    if (input) {
                        const pin = input.value.trim();
                        if (pin && pin.length === 6 && /^\d+$/.test(pin)) {
                            this.portalPins[site.id] = pin;
                        } else if (!pin) {
                            delete this.portalPins[site.id];
                        }
                    }
                });

                this.savePins();
                UI.closeModal();
                UI.toast('PINs Saved', 'Portal access PINs have been updated.', 'success');
                this.updatePinsList();
            },

            updatePinsList: function () {
                const container = document.getElementById('portal-pins-list');
                if (!container) return;

                const sites = DataStore.getSites();
                const activePins = Object.keys(this.portalPins);

                if (activePins.length === 0) {
                    container.innerHTML = '<p class="text-sm text-muted">No portal PINs configured.</p>';
                    return;
                }

                container.innerHTML = activePins.map(siteId => {
                    const site = sites.find(s => s.id === siteId);
                    if (!site) return '';
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-2); background: var(--color-surface-elevated); border-radius: var(--radius-md);">
                            <span class="text-sm">${Utils.escapeHtml(site.name)}</span>
                            <span class="badge badge-success">PIN Active</span>
                        </div>
                    `;
                }).join('');
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PORTAL AUTHENTICATION
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            launchPortal: function () {
                Router.navigate('portal');
            },

            authenticate: function () {
                const pin = document.getElementById('portal-pin-input').value.trim();
                
                if (!pin || pin.length !== 6) {
                    UI.toast('Invalid PIN', 'Please enter a 6-digit PIN.', 'error');
                    return;
                }

                // Find site matching this PIN
                const siteId = Object.keys(this.portalPins).find(id => this.portalPins[id] === pin);

                if (!siteId) {
                    UI.toast('Access Denied', 'Invalid PIN. Please contact your account manager.', 'error');
                    document.getElementById('portal-pin-input').value = '';
                    return;
                }

                this.currentSiteId = siteId;
                this.isAuthenticated = true;
                this.renderDashboard();
                UI.toast('Welcome', 'Portal access granted.', 'success');
            },

            logout: function () {
                this.isAuthenticated = false;
                this.currentSiteId = null;
                document.body.classList.remove('portal-mode');
                // Return to portal login view, not admin dashboard
                Router.navigate('portal');
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PORTAL DASHBOARD
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            renderDashboard: function () {
                if (!this.currentSiteId) return;

                // Enable portal mode - hides sidebar, AI console, admin elements
                document.body.classList.add('portal-mode');

                document.getElementById('portal-login').style.display = 'none';
                document.getElementById('portal-dashboard').style.display = 'block';

                const site = DataStore.getSites().find(s => s.id === this.currentSiteId);
                if (!site) {
                    UI.toast('Error', 'Site not found.', 'error');
                    this.logout();
                    return;
                }

                document.getElementById('portal-site-name').textContent = site.name;
                document.getElementById('portal-last-updated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;

                this.renderStats();
                this.switchTab('overview');
            },

            renderStats: function () {
                const siteId = this.currentSiteId;
                const now = new Date();
                const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

                const incidents = DataStore.getIncidents().filter(i => 
                    i.siteId === siteId && new Date(i.dateTime) >= thirtyDaysAgo
                );
                const inspections = DataStore.getInspections().filter(i => 
                    i.siteId === siteId && new Date(i.dateTime) >= thirtyDaysAgo
                );
                const communications = DataStore.getCommunications().filter(c => 
                    c.siteId === siteId && new Date(c.dateTime) >= thirtyDaysAgo
                );

                const criticalIncidents = incidents.filter(i => i.severity === 'Critical' || i.severity === 'High').length;

                document.getElementById('portal-stats').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${incidents.length}</div>
                        <div class="stat-label">Incidents (30 days)</div>
                    </div>
                    <div class="stat-card ${criticalIncidents > 0 ? 'stat-card-danger' : ''}">
                        <div class="stat-value">${criticalIncidents}</div>
                        <div class="stat-label">Critical/High Severity</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${inspections.length}</div>
                        <div class="stat-label">Inspections</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${communications.length}</div>
                        <div class="stat-label">Communications</div>
                    </div>
                `;
            },

            switchTab: function (tab) {
                // Update tab buttons
                document.querySelectorAll('.portal-tab').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tab);
                });

                const content = document.getElementById('portal-tab-content');

                switch (tab) {
                    case 'overview':
                        content.innerHTML = this.renderOverviewTab();
                        break;
                    case 'incidents':
                        content.innerHTML = this.renderIncidentsTab();
                        break;
                    case 'coverage':
                        content.innerHTML = this.renderCoverageTab();
                        break;
                    case 'inspections':
                        content.innerHTML = this.renderInspectionsTab();
                        break;
                    case 'communications':
                        content.innerHTML = this.renderCommunicationsTab();
                        break;
                }
            },

            renderOverviewTab: function () {
                const site = DataStore.getSites().find(s => s.id === this.currentSiteId);
                const now = new Date();
                const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

                const recentIncidents = DataStore.getIncidents().filter(i => 
                    i.siteId === this.currentSiteId && new Date(i.dateTime) >= sevenDaysAgo
                ).slice(0, 5);

                const recentInspections = DataStore.getInspections().filter(i => 
                    i.siteId === this.currentSiteId && new Date(i.dateTime) >= sevenDaysAgo
                ).slice(0, 3);

                const guards = DataStore.getGuards();

                return `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-5);">
                        <div>
                            <h4 style="margin-bottom: var(--space-3); font-weight: var(--font-weight-semibold);">ğŸ“ Site Information</h4>
                            <div style="background: var(--color-surface-elevated); padding: var(--space-4); border-radius: var(--radius-md);">
                                <p><strong>${Utils.escapeHtml(site.name)}</strong></p>
                                <p class="text-sm text-muted">${Utils.escapeHtml(site.address || 'Address not specified')}</p>
                                ${site.clientName ? `<p class="text-sm mt-2">Client: ${Utils.escapeHtml(site.clientName)}</p>` : ''}
                                ${site.type ? `<p class="text-sm">Type: ${Utils.escapeHtml(site.type)}</p>` : ''}
                            </div>
                        </div>

                        <div>
                            <h4 style="margin-bottom: var(--space-3); font-weight: var(--font-weight-semibold);">ğŸš¨ Recent Incidents (7 days)</h4>
                            ${recentIncidents.length > 0 ? `
                                <div style="display: grid; gap: var(--space-2);">
                                    ${recentIncidents.map(i => `
                                        <div style="background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md); border-left: 3px solid ${this.getSeverityColor(i.severity)};">
                                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                                <span class="text-sm font-medium">${Utils.escapeHtml(i.type)}</span>
                                                <span class="badge ${this.getSeverityBadge(i.severity)}">${i.severity}</span>
                                            </div>
                                            <p class="text-xs text-muted mt-1">${new Date(i.dateTime).toLocaleDateString()}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p class="text-sm text-muted">No incidents in the past 7 days.</p>'}
                        </div>

                        <div>
                            <h4 style="margin-bottom: var(--space-3); font-weight: var(--font-weight-semibold);">âœ… Recent Inspections</h4>
                            ${recentInspections.length > 0 ? `
                                <div style="display: grid; gap: var(--space-2);">
                                    ${recentInspections.map(i => {
                                        const inspector = guards.find(g => g.id === i.inspectorId);
                                        return `
                                            <div style="background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md);">
                                                <div class="text-sm">${new Date(i.dateTime).toLocaleDateString()} at ${new Date(i.dateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                                                <p class="text-xs text-muted mt-1">Inspector: ${inspector ? inspector.name : 'N/A'}</p>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : '<p class="text-sm text-muted">No recent inspections.</p>'}
                        </div>
                    </div>
                `;
            },

            renderIncidentsTab: function () {
                const incidents = DataStore.getIncidents().filter(i => i.siteId === this.currentSiteId)
                    .sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime))
                    .slice(0, 50);
                const guards = DataStore.getGuards();

                if (incidents.length === 0) {
                    return '<p class="text-muted" style="padding: var(--space-4);">No incidents recorded for this site.</p>';
                }

                return `
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date/Time</th>
                                    <th>Type</th>
                                    <th>Severity</th>
                                    <th>Status</th>
                                    <th>Summary</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${incidents.map(i => `
                                    <tr>
                                        <td>${new Date(i.dateTime).toLocaleString()}</td>
                                        <td>${Utils.escapeHtml(i.type)}</td>
                                        <td><span class="badge ${this.getSeverityBadge(i.severity)}">${i.severity}</span></td>
                                        <td><span class="badge badge-${i.status === 'Closed' ? 'success' : 'warning'}">${i.status}</span></td>
                                        <td class="text-sm">${Utils.escapeHtml((i.narrative || '').substring(0, 100))}${(i.narrative || '').length > 100 ? '...' : ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },

            renderCoverageTab: function () {
                const weekKey = Utils.getWeekKey(new Date());
                const schedule = DataStore.getScheduleForWeek(weekKey);
                const guards = DataStore.getGuards();
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

                // Filter to current site
                const siteSchedule = {};
                days.forEach(day => {
                    siteSchedule[day] = (schedule[day] || []).filter(s => s.siteId === this.currentSiteId);
                });

                return `
                    <h4 style="margin-bottom: var(--space-3);">This Week's Coverage</h4>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Day</th>
                                    <th>Shift</th>
                                    <th>Guard</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${days.map(day => {
                                    const shifts = siteSchedule[day];
                                    if (shifts.length === 0) {
                                        return `
                                            <tr>
                                                <td><strong>${day}</strong></td>
                                                <td colspan="3" class="text-muted">No coverage scheduled</td>
                                            </tr>
                                        `;
                                    }
                                    return shifts.map((s, idx) => {
                                        const guard = guards.find(g => g.id === s.guardId);
                                        return `
                                            <tr>
                                                ${idx === 0 ? `<td rowspan="${shifts.length}"><strong>${day}</strong></td>` : ''}
                                                <td>${Utils.escapeHtml(s.shift || 'TBD')}</td>
                                                <td>${guard ? guard.name : '<span class="text-muted">Unassigned</span>'}</td>
                                                <td><span class="badge badge-success">Scheduled</span></td>
                                            </tr>
                                        `;
                                    }).join('');
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },

            renderInspectionsTab: function () {
                const inspections = DataStore.getInspections().filter(i => i.siteId === this.currentSiteId)
                    .sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime))
                    .slice(0, 30);
                const guards = DataStore.getGuards();

                if (inspections.length === 0) {
                    return '<p class="text-muted" style="padding: var(--space-4);">No inspections recorded for this site.</p>';
                }

                return `
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date/Time</th>
                                    <th>Inspector</th>
                                    <th>Status</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${inspections.map(i => {
                                    const inspector = guards.find(g => g.id === i.inspectorId);
                                    return `
                                        <tr>
                                            <td>${new Date(i.dateTime).toLocaleString()}</td>
                                            <td>${inspector ? inspector.name : 'N/A'}</td>
                                            <td><span class="badge badge-${i.status === 'Complete' ? 'success' : 'info'}">${i.status || 'Complete'}</span></td>
                                            <td class="text-sm">${Utils.escapeHtml((i.notes || '').substring(0, 100))}${(i.notes || '').length > 100 ? '...' : ''}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },

            renderCommunicationsTab: function () {
                const comms = DataStore.getCommunications().filter(c => c.siteId === this.currentSiteId)
                    .sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime))
                    .slice(0, 30);

                if (comms.length === 0) {
                    return '<p class="text-muted" style="padding: var(--space-4);">No communications logged for this site.</p>';
                }

                return `
                    <div style="display: grid; gap: var(--space-3);">
                        ${comms.map(c => `
                            <div style="background: var(--color-surface-elevated); padding: var(--space-4); border-radius: var(--radius-md);">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-2);">
                                    <div>
                                        <span style="font-weight: var(--font-weight-medium);">${Utils.escapeHtml(c.subject)}</span>
                                        <span class="badge badge-secondary" style="margin-left: var(--space-2);">${c.type}</span>
                                    </div>
                                    <span class="text-xs text-muted">${new Date(c.dateTime).toLocaleString()}</span>
                                </div>
                                <p class="text-sm text-muted">${c.contactName ? `Contact: ${Utils.escapeHtml(c.contactName)}` : ''}</p>
                                ${c.summary ? `<p class="text-sm mt-2" style="white-space: pre-wrap;">${Utils.escapeHtml(c.summary)}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // UTILITIES
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            getSeverityColor: function (severity) {
                const colors = {
                    'Critical': 'var(--color-danger)',
                    'High': '#fd7e14',
                    'Medium': 'var(--color-warning)',
                    'Low': 'var(--color-success)'
                };
                return colors[severity] || 'var(--color-border)';
            },

            getSeverityBadge: function (severity) {
                const badges = {
                    'Critical': 'badge-danger',
                    'High': 'badge-warning',
                    'Medium': 'badge-info',
                    'Low': 'badge-success'
                };
                return badges[severity] || 'badge-secondary';
            },

            refresh: function () {
                this.renderStats();
                this.switchTab(document.querySelector('.portal-tab.active')?.dataset.tab || 'overview');
                document.getElementById('portal-last-updated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                UI.toast('Refreshed', 'Portal data updated.', 'info');
            },

            exportReport: function () {
                const site = DataStore.getSites().find(s => s.id === this.currentSiteId);
                if (!site) return;

                // Use existing export functionality
                document.getElementById('client-report-site').value = this.currentSiteId;
                ExportModule.runClientReport();
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CALLOFFS MODULE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // OVERTIME MODULE â€” Track and alert on guard hours
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const OvertimeModule = {
            OT_THRESHOLD: 40,       // Hours before overtime starts
            WARNING_THRESHOLD: 36,  // Hours to show warning
            
            // Calculate hours for a guard in the current week
            getGuardWeeklyHours: function (guardId) {
                const schedule = DataStore.getScheduleForWeek(Utils.getWeekKey(new Date()));
                let totalHours = 0;
                
                schedule.forEach(shift => {
                    if (shift.guardId === guardId && shift.status !== 'OPEN') {
                        // Parse shift times to calculate hours
                        const hours = this.parseShiftHours(shift.shift || shift.time);
                        totalHours += hours;
                    }
                });
                
                return totalHours;
            },
            
            // Parse shift string to get hours (e.g., "8A-4P" = 8 hours)
            parseShiftHours: function (shiftStr) {
                if (!shiftStr) return 8; // Default to 8 hours
                
                const shiftMap = {
                    '12A-8A': 8, '12Aâ€“8A': 8, '8A-4P': 8, '8Aâ€“4P': 8,
                    '4P-12A': 8, '4Pâ€“12A': 8, '7P-3A': 8, '7Pâ€“3A': 8,
                    '6P-12A': 6, '6Pâ€“12A': 6, '8A-8P': 12, '8Aâ€“8P': 12,
                    '8P-8A': 12, '8Pâ€“8A': 12
                };
                
                return shiftMap[shiftStr] || 8;
            },
            
            // Get all guards with their weekly hours
            getAllGuardHours: function () {
                const guards = DataStore.getActiveGuards();
                const sites = DataStore.getSites();
                
                return guards.map(guard => {
                    const hours = this.getGuardWeeklyHours(guard.id);
                    const primarySiteNames = (guard.primarySites || [])
                        .map(sid => sites.find(s => s.id === sid)?.name)
                        .filter(Boolean)
                        .slice(0, 2)
                        .join(', ');
                    
                    let status = 'safe';
                    if (hours >= this.OT_THRESHOLD) status = 'danger';
                    else if (hours >= this.WARNING_THRESHOLD) status = 'warning';
                    
                    return {
                        ...guard,
                        weeklyHours: hours,
                        status,
                        primarySiteNames,
                        remaining: Math.max(0, this.OT_THRESHOLD - hours)
                    };
                }).sort((a, b) => b.weeklyHours - a.weeklyHours);
            },
            
            // Render overtime tab content
            renderOvertimeTab: function () {
                const guards = this.getAllGuardHours();
                const inOT = guards.filter(g => g.status === 'danger');
                const nearOT = guards.filter(g => g.status === 'warning');
                const safe = guards.filter(g => g.status === 'safe');
                const totalHours = guards.reduce((sum, g) => sum + g.weeklyHours, 0);
                
                // Summary cards
                const summaryContainer = document.getElementById('overtime-summary');
                if (summaryContainer) {
                    summaryContainer.innerHTML = `
                        <div class="kpi-card" style="cursor: pointer;" onclick="OvertimeModule.filterCards('danger')">
                            <div class="kpi-header">
                                <span class="kpi-label">In Overtime</span>
                                <div class="kpi-icon danger">âš ï¸</div>
                            </div>
                            <div class="kpi-value" style="color: var(--color-danger);">${inOT.length}</div>
                            <div class="kpi-subtext">40+ hours</div>
                        </div>
                        <div class="kpi-card" style="cursor: pointer;" onclick="OvertimeModule.filterCards('warning')">
                            <div class="kpi-header">
                                <span class="kpi-label">Approaching OT</span>
                                <div class="kpi-icon warning">â°</div>
                            </div>
                            <div class="kpi-value" style="color: var(--color-warning);">${nearOT.length}</div>
                            <div class="kpi-subtext">36-40 hours</div>
                        </div>
                        <div class="kpi-card" style="cursor: pointer;" onclick="OvertimeModule.filterCards('safe')">
                            <div class="kpi-header">
                                <span class="kpi-label">Available</span>
                                <div class="kpi-icon success">âœ…</div>
                            </div>
                            <div class="kpi-value" style="color: var(--color-success);">${safe.length}</div>
                            <div class="kpi-subtext">Under 36 hours</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <span class="kpi-label">Total Hours</span>
                                <div class="kpi-icon">ğŸ“Š</div>
                            </div>
                            <div class="kpi-value">${totalHours}</div>
                            <div class="kpi-subtext">This week</div>
                        </div>
                    `;
                }
                
                // Guard cards
                const gridContainer = document.getElementById('overtime-grid');
                if (gridContainer) {
                    if (guards.length === 0) {
                        gridContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: var(--space-8);"><p class="text-muted">No guards scheduled this week</p></div>';
                        return;
                    }
                    
                    gridContainer.innerHTML = guards.map(g => {
                        const percentage = Math.min(100, (g.weeklyHours / this.OT_THRESHOLD) * 100);
                        const barClass = g.status === 'danger' ? 'danger' : g.status === 'warning' ? 'warning' : 'safe';
                        
                        return `
                            <div class="ot-card ${g.status === 'safe' ? '' : g.status}" data-status="${g.status}">
                                <div class="ot-header">
                                    <div>
                                        <div class="ot-name">${Utils.escapeHtml(g.name)}</div>
                                        <div class="ot-site">${g.primarySiteNames || 'No primary site'}</div>
                                    </div>
                                    <div class="ot-hours">
                                        <div class="ot-hours-value" style="color: ${g.status === 'danger' ? 'var(--color-danger)' : g.status === 'warning' ? 'var(--color-warning)' : 'inherit'};">
                                            ${g.weeklyHours}h
                                        </div>
                                        <div class="ot-hours-label">
                                            ${g.status === 'danger' ? 'IN OT' : g.remaining + 'h to OT'}
                                        </div>
                                    </div>
                                </div>
                                <div class="ot-bar">
                                    <div class="ot-bar-fill ${barClass}" style="width: ${percentage}%;"></div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                // Update badge
                const badge = document.getElementById('tab-overtime-count');
                if (badge) {
                    if (inOT.length > 0) {
                        badge.textContent = inOT.length;
                        badge.style.display = 'inline-flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            },
            
            // Filter cards by status
            filterCards: function (status) {
                const cards = document.querySelectorAll('#overtime-grid .ot-card');
                cards.forEach(card => {
                    if (status === 'all' || card.dataset.status === status) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
            },
            
            // Open full overtime tracker modal
            openTracker: function () {
                const guards = this.getAllGuardHours();
                const inOT = guards.filter(g => g.status === 'danger');
                const nearOT = guards.filter(g => g.status === 'warning');
                
                const content = `
                    <div style="margin-bottom: var(--space-4);">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-3); text-align: center;">
                            <div style="padding: var(--space-3); background: var(--color-danger-bg); border-radius: var(--radius-md);">
                                <div style="font-size: var(--font-size-2xl); font-weight: bold; color: var(--color-danger);">${inOT.length}</div>
                                <div class="text-sm text-muted">In Overtime (40+)</div>
                            </div>
                            <div style="padding: var(--space-3); background: var(--color-warning-bg); border-radius: var(--radius-md);">
                                <div style="font-size: var(--font-size-2xl); font-weight: bold; color: var(--color-warning);">${nearOT.length}</div>
                                <div class="text-sm text-muted">Approaching (36-40)</div>
                            </div>
                            <div style="padding: var(--space-3); background: var(--color-success-bg); border-radius: var(--radius-md);">
                                <div style="font-size: var(--font-size-2xl); font-weight: bold; color: var(--color-success);">${guards.length - inOT.length - nearOT.length}</div>
                                <div class="text-sm text-muted">Available (<36)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="table" style="margin: 0;">
                            <thead>
                                <tr>
                                    <th>Guard</th>
                                    <th>Primary Site</th>
                                    <th style="text-align: right;">Hours</th>
                                    <th style="text-align: right;">Remaining</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${guards.map(g => `
                                    <tr style="${g.status === 'danger' ? 'background: var(--color-danger-bg);' : g.status === 'warning' ? 'background: var(--color-warning-bg);' : ''}">
                                        <td class="font-medium">${Utils.escapeHtml(g.name)}</td>
                                        <td class="text-sm">${g.primarySiteNames || 'â€”'}</td>
                                        <td style="text-align: right; font-weight: 600;">${g.weeklyHours}h</td>
                                        <td style="text-align: right;">${g.remaining}h</td>
                                        <td>
                                            <span class="badge badge-${g.status === 'danger' ? 'danger' : g.status === 'warning' ? 'warning' : 'success'}">
                                                ${g.status === 'danger' ? 'IN OT' : g.status === 'warning' ? 'NEAR OT' : 'OK'}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>
                    <button class="btn btn-primary" onclick="UI.closeModal(); Router.navigate('calloffs'); document.querySelector('[data-tab=calloff-overtime]')?.click();">View Full Tab</button>
                `;
                
                UI.openModal('Overtime Tracker â€” This Week', content, footer, 'lg');
            },
            
            // Get guards over or near OT for attention panel
            getAttentionItems: function () {
                const guards = this.getAllGuardHours();
                const inOT = guards.filter(g => g.status === 'danger');
                const nearOT = guards.filter(g => g.status === 'warning');
                const items = [];
                
                if (inOT.length > 0) {
                    items.push({
                        icon: 'â°',
                        title: `${inOT.length} guard${inOT.length > 1 ? 's' : ''} in overtime`,
                        detail: inOT.slice(0, 2).map(g => g.name.split(' ')[0]).join(', ') +
                               (inOT.length > 2 ? ` +${inOT.length - 2}` : ''),
                        badge: 'OT',
                        severity: 'critical',
                        action: "OvertimeModule.openTracker()"
                    });
                }
                
                if (nearOT.length > 0) {
                    items.push({
                        icon: 'âš ï¸',
                        title: `${nearOT.length} guard${nearOT.length > 1 ? 's' : ''} approaching OT`,
                        detail: nearOT.slice(0, 2).map(g => `${g.name.split(' ')[0]} (${g.weeklyHours}h)`).join(', '),
                        badge: 'MONITOR',
                        severity: 'warning',
                        action: "OvertimeModule.openTracker()"
                    });
                }
                
                return items;
            }
        };
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // REPLACEMENT WIZARD â€” Smart guard suggestions for coverage
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const ReplacementWizard = {
            selectedGuardId: null,
            
            // Get best replacement candidates for a call-off
            getCandidates: function (siteId, shiftStr, dateStr) {
                const guards = DataStore.getActiveGuards();
                const sites = DataStore.getSites();
                const schedule = DataStore.getScheduleForWeek(Utils.getWeekKey(new Date(dateStr + 'T00:00:00')));
                const site = sites.find(s => s.id === siteId);
                
                const candidates = [];
                
                guards.forEach(guard => {
                    // Check if already scheduled for this date/shift
                    const hasConflict = schedule.some(s => 
                        s.guardId === guard.id && 
                        s.date === dateStr &&
                        s.shift === shiftStr
                    );
                    
                    if (hasConflict) return;
                    
                    // Calculate score
                    let score = 50; // Base score
                    const tags = [];
                    
                    // Bonus for knowing the site
                    if (guard.primarySites && guard.primarySites.includes(siteId)) {
                        score += 30;
                        tags.push({ label: 'Knows site', type: 'positive' });
                    }
                    
                    // Check hours/OT status
                    const weeklyHours = OvertimeModule.getGuardWeeklyHours(guard.id);
                    const shiftHours = OvertimeModule.parseShiftHours(shiftStr);
                    const projectedHours = weeklyHours + shiftHours;
                    
                    if (projectedHours > 40) {
                        score -= 20;
                        tags.push({ label: `${projectedHours}h â†’ OT`, type: 'danger' });
                    } else if (projectedHours > 36) {
                        score -= 10;
                        tags.push({ label: `${projectedHours}h total`, type: 'warning' });
                    } else if (weeklyHours < 32) {
                        score += 15;
                        tags.push({ label: `${weeklyHours}h this week`, type: 'positive' });
                    } else {
                        tags.push({ label: `${weeklyHours}h`, type: '' });
                    }
                    
                    // Check availability
                    const isAvailable = DataStore.isGuardAvailable(guard.id, dateStr);
                    if (isAvailable === true) {
                        score += 20;
                        tags.push({ label: 'Available', type: 'positive' });
                    } else if (isAvailable === false) {
                        score -= 30;
                        tags.push({ label: 'Unavailable', type: 'danger' });
                    }
                    
                    // Role bonus (floaters are ideal for coverage)
                    if (guard.role === 'floater') {
                        score += 10;
                        tags.push({ label: 'Floater', type: 'positive' });
                    }
                    
                    // Clamp score
                    score = Math.max(0, Math.min(100, score));
                    
                    candidates.push({
                        guard,
                        score,
                        tags,
                        weeklyHours,
                        projectedHours,
                        otStatus: projectedHours > 40 ? 'danger' : projectedHours > 36 ? 'warning' : 'safe'
                    });
                });
                
                // Sort by score descending
                return candidates.sort((a, b) => b.score - a.score);
            },
            
            // Open wizard modal
            open: function (calloffId) {
                const calloffs = DataStore.getCalloffs();
                const calloff = calloffs.find(c => c.id === calloffId);
                if (!calloff) return;
                
                const site = DataStore.getSiteById(calloff.siteId);
                const originalGuard = DataStore.getGuardById(calloff.guardId);
                const candidates = this.getCandidates(calloff.siteId, calloff.shift, calloff.date);
                
                this.selectedGuardId = null;
                
                const content = `
                    <div style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md);">
                        <div class="text-sm text-muted">Finding coverage for:</div>
                        <div class="font-medium" style="font-size: var(--font-size-lg);">${Utils.escapeHtml(site?.name || 'Unknown')}</div>
                        <div class="text-sm">${Utils.formatDate(calloff.date)} Â· ${calloff.shift || 'Shift TBD'}</div>
                        <div class="text-sm text-muted">Originally: ${Utils.escapeHtml(originalGuard?.name || 'Unknown')}</div>
                    </div>
                    
                    <div class="text-sm font-medium mb-2">Recommended Replacements</div>
                    <div class="replacement-wizard" id="replacement-wizard-list">
                        ${candidates.length === 0 ? `
                            <div style="text-align: center; padding: var(--space-6); color: var(--color-text-muted);">
                                <p>No available guards found</p>
                                <p class="text-sm">All guards may be scheduled or unavailable</p>
                            </div>
                        ` : candidates.map(c => {
                            const scoreClass = c.score >= 70 ? 'excellent' : c.score >= 50 ? 'good' : 'fair';
                            const otClass = c.otStatus === 'danger' ? 'ot-danger' : c.otStatus === 'warning' ? 'ot-warning' : '';
                            
                            return `
                                <div class="replacement-option ${otClass}" data-guard-id="${c.guard.id}" onclick="ReplacementWizard.selectGuard('${c.guard.id}', this)">
                                    <div class="replacement-score ${scoreClass}">${c.score}</div>
                                    <div class="replacement-info">
                                        <div class="replacement-name">${Utils.escapeHtml(c.guard.name)}</div>
                                        <div class="replacement-tags">
                                            ${c.tags.map(t => `<span class="replacement-tag ${t.type}">${t.label}</span>`).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--color-border);">
                        <div class="form-group">
                            <label class="form-label">Coverage Notes</label>
                            <input type="text" class="form-input" id="wizard-coverage-notes" placeholder="Optional: How was this arranged?">
                        </div>
                    </div>
                `;
                
                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                    <button class="btn btn-success" id="wizard-assign-btn" onclick="ReplacementWizard.assign('${calloffId}')" disabled>Assign Selected Guard</button>
                `;
                
                UI.openModal('Find Replacement', content, footer, 'lg');
            },
            
            // Select a guard
            selectGuard: function (guardId, element) {
                this.selectedGuardId = guardId;
                
                // Update UI
                document.querySelectorAll('.replacement-option').forEach(opt => opt.classList.remove('selected'));
                element.classList.add('selected');
                
                // Enable assign button
                const btn = document.getElementById('wizard-assign-btn');
                if (btn) btn.disabled = false;
            },
            
            // Assign selected guard
            assign: function (calloffId) {
                if (!this.selectedGuardId) {
                    UI.toast('No Selection', 'Please select a replacement guard.', 'warning');
                    return;
                }
                
                const calloffs = DataStore.getCalloffs();
                const idx = calloffs.findIndex(c => c.id === calloffId);
                
                if (idx !== -1) {
                    const notes = document.getElementById('wizard-coverage-notes')?.value || '';
                    
                    calloffs[idx].coverageStatus = 'covered';
                    calloffs[idx].replacementGuardId = this.selectedGuardId;
                    calloffs[idx].coverageNotes = notes;
                    calloffs[idx].coveredAt = new Date().toISOString();
                    
                    DataStore.saveCalloffs(calloffs);
                    
                    const guard = DataStore.getGuardById(this.selectedGuardId);
                    UI.closeModal();
                    CalloffsModule.render();
                    DashboardModule.render();
                    
                    UI.toast('Coverage Assigned', `${guard?.name || 'Guard'} assigned as replacement.`, 'success');
                }
            }
        };

        const CalloffsModule = {
            filters: { site: '', status: '', search: '' },

            generateCalloffId: function () {
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
                const todayPrefix = `CO-${dateStr}`;
                const calloffs = DataStore.getCalloffs();
                const todayCalloffs = calloffs.filter(c => c.id && c.id.startsWith(todayPrefix));
                const seq = String(todayCalloffs.length + 1).padStart(4, '0');
                return `${todayPrefix}-${seq}`;
            },

            init: function () {
                document.getElementById('new-calloff-btn')?.addEventListener('click', () => this.openNewCalloffModal());
                document.getElementById('export-calloffs-csv')?.addEventListener('click', () => this.exportCSV());

                document.getElementById('calloff-search')?.addEventListener('input', Utils.debounce((e) => {
                    this.filters.search = e.target.value.toLowerCase();
                    this.renderTable();
                }, 200));

                document.getElementById('calloff-filter-site')?.addEventListener('change', (e) => {
                    this.filters.site = e.target.value;
                    this.renderTable();
                });

                document.getElementById('calloff-filter-status')?.addEventListener('change', (e) => {
                    this.filters.status = e.target.value;
                    this.renderTable();
                });

                // Tab switching
                document.querySelectorAll('#section-calloffs .tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('#section-calloffs .tab').forEach(t => {
                            t.classList.remove('active');
                            t.setAttribute('aria-selected', 'false');
                        });
                        document.querySelectorAll('#section-calloffs .tab-content').forEach(c => c.classList.remove('active'));

                        tab.classList.add('active');
                        tab.setAttribute('aria-selected', 'true');
                        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');

                        if (tab.dataset.tab === 'calloff-pending') {
                            this.renderPending();
                        } else if (tab.dataset.tab === 'calloff-today') {
                            this.renderToday();
                        } else if (tab.dataset.tab === 'calloff-overtime') {
                            OvertimeModule.renderOvertimeTab();
                        }
                    });
                });
            },

            render: function () {
                UI.populateSiteSelect('calloff-filter-site', true);
                this.renderTable();
                this.renderPending();
                this.renderToday();
                this.updatePendingCount();
                OvertimeModule.renderOvertimeTab();
            },

            renderTable: function () {
                let calloffs = DataStore.getCalloffs();
                const guards = DataStore.getGuards();
                const sites = DataStore.getSites();

                // Apply filters
                if (this.filters.site) calloffs = calloffs.filter(c => c.siteId === this.filters.site);
                if (this.filters.status) calloffs = calloffs.filter(c => c.coverageStatus === this.filters.status);
                if (this.filters.search) {
                    calloffs = calloffs.filter(c => {
                        const guard = guards.find(g => g.id === c.guardId);
                        const site = sites.find(s => s.id === c.siteId);
                        return (guard?.name?.toLowerCase().includes(this.filters.search) ||
                            site?.name?.toLowerCase().includes(this.filters.search) ||
                            c.reason?.toLowerCase().includes(this.filters.search));
                    });
                }

                const tbody = document.getElementById('calloffs-tbody');
                const statusClass = { covered: 'success', uncovered: 'danger', pending: 'warning' };
                const statusLabel = { covered: 'Covered', uncovered: 'Uncovered', pending: 'Pending' };

                if (calloffs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-muted" style="text-align: center; padding: var(--space-8);">No call-offs recorded</td></tr>';
                    return;
                }

                tbody.innerHTML = calloffs.map(c => {
                    const guard = guards.find(g => g.id === c.guardId);
                    const site = sites.find(s => s.id === c.siteId);
                    const replacement = c.replacementGuardId ? guards.find(g => g.id === c.replacementGuardId) : null;

                    let coverageInfo = statusLabel[c.coverageStatus];
                    if (replacement) {
                        coverageInfo = `${replacement.name}`;
                    }

                    return `
                    <tr>
                        <td data-label="Date"><span class="font-medium">${Utils.formatDate(c.date)}</span></td>
                        <td data-label="Guard">${Utils.escapeHtml(guard?.name || 'Unknown')}</td>
                        <td data-label="Site">${Utils.escapeHtml(site?.name || 'Unknown')}</td>
                        <td data-label="Shift"><span class="badge badge-neutral">${Utils.escapeHtml(c.shift || 'â€”')}</span></td>
                        <td data-label="Reason" class="text-sm">${Utils.escapeHtml(c.reason || 'â€”')}</td>
                        <td data-label="Coverage"><span class="badge badge-${statusClass[c.coverageStatus]}">${coverageInfo}</span></td>
                        <td data-label="Actions">
                            <div class="flex gap-2">
                                ${(c.coverageStatus === 'pending' || c.coverageStatus === 'uncovered') ? `
                                    <button class="btn btn-sm btn-success" onclick="CalloffsModule.markCovered('${c.id}')" title="Mark Covered">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm btn-ghost" onclick="CalloffsModule.editCalloff('${c.id}')" title="Edit">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                </button>
                                <button class="btn btn-sm btn-ghost" style="color: var(--color-danger);" onclick="CalloffsModule.confirmDelete('${c.id}')" title="Delete">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                }).join('');
            },

            renderPending: function () {
                const pending = DataStore.getPendingCalloffs();
                const guards = DataStore.getGuards();
                const sites = DataStore.getSites();
                const container = document.getElementById('calloff-pending-list');

                if (pending.length === 0) {
                    container.innerHTML = `
                    <div class="empty-state" style="padding: var(--space-8); text-align: center;">
                        <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto var(--space-4); opacity: 0.5; color: var(--color-success);">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-muted">All call-offs are covered!</p>
                    </div>
                `;
                    return;
                }

                container.innerHTML = pending.map(c => {
                    const guard = guards.find(g => g.id === c.guardId);
                    const site = sites.find(s => s.id === c.siteId);

                    return `
                    <div style="background: var(--color-warning-bg); border: 1px solid var(--color-warning); border-radius: var(--radius-lg); padding: var(--space-4); margin-bottom: var(--space-3);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-2);">
                            <div>
                                <div class="font-medium">${Utils.escapeHtml(guard?.name || 'Unknown')} â€” ${Utils.escapeHtml(site?.name || 'Unknown')}</div>
                                <div class="text-sm text-muted">${Utils.formatDate(c.date)} Â· ${c.shift || 'No shift specified'}${c.timeOfCall ? ' Â· Called at ' + c.timeOfCall : ''}</div>
                                ${c.reason ? `<div class="text-sm" style="margin-top: var(--space-1);">Reason: ${Utils.escapeHtml(c.reason)}${c.isNCNS ? ' <span class="badge badge-danger" style="font-size: 10px;">NCNS</span>' : ''}</div>` : ''}
                                ${c.documentedBy ? `<div class="text-xs text-muted" style="margin-top: var(--space-1);">Documented by: ${Utils.escapeHtml(c.documentedBy)}</div>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: var(--space-2);">
                            <button class="btn btn-sm btn-primary" onclick="CalloffsModule.markCovered('${c.id}')">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                Find Replacement
                            </button>
                            <button class="btn btn-sm btn-success" onclick="CalloffsModule.quickMarkCovered('${c.id}')">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                Quick Cover
                            </button>
                        </div>
                    </div>
                `;
                }).join('');
            },

            renderToday: function () {
                const todayCalloffs = DataStore.getTodayCalloffs();
                const guards = DataStore.getGuards();
                const sites = DataStore.getSites();
                const container = document.getElementById('calloff-today-list');

                if (todayCalloffs.length === 0) {
                    container.innerHTML = `
                    <div class="empty-state" style="padding: var(--space-8); text-align: center;">
                        <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto var(--space-4); opacity: 0.5; color: var(--color-success);">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-muted">No call-offs today!</p>
                    </div>
                `;
                    return;
                }

                const statusClass = { covered: 'success', uncovered: 'danger', pending: 'warning' };

                container.innerHTML = todayCalloffs.map(c => {
                    const guard = guards.find(g => g.id === c.guardId);
                    const site = sites.find(s => s.id === c.siteId);
                    const replacement = c.replacementGuardId ? guards.find(g => g.id === c.replacementGuardId) : null;

                    return `
                    <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: var(--space-4); margin-bottom: var(--space-3); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="font-medium">${Utils.escapeHtml(guard?.name || 'Unknown')} â€” ${Utils.escapeHtml(site?.name || 'Unknown')}</div>
                            <div class="text-sm text-muted">${c.shift || 'No shift specified'} ${c.reason ? `Â· ${c.reason}` : ''}</div>
                            ${replacement ? `<div class="text-sm" style="color: var(--color-success); margin-top: var(--space-1);">Covered by: ${Utils.escapeHtml(replacement.name)}</div>` : ''}
                        </div>
                        <span class="badge badge-${statusClass[c.coverageStatus]}">${c.coverageStatus}</span>
                    </div>
                `;
                }).join('');
            },

            updatePendingCount: function () {
                const count = DataStore.getPendingCalloffs().length;
                const navBadge = document.getElementById('nav-pending-calloffs');
                const tabBadge = document.getElementById('tab-pending-count');

                if (navBadge) {
                    navBadge.textContent = count;
                    navBadge.style.display = count > 0 ? 'inline' : 'none';
                }
                if (tabBadge) {
                    tabBadge.textContent = count;
                    tabBadge.style.display = count > 0 ? 'inline' : 'none';
                }
            },

            openNewCalloffModal: function () {
                const guards = DataStore.getActiveGuards();
                const sites = DataStore.getSites();
                const today = Utils.toISODate(new Date());
                const now = new Date();
                const timeNow = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

                const shiftOptions = ['12Aâ€“8A', '8Aâ€“4P', '4Pâ€“12A', '7Pâ€“3A', '6Pâ€“12A', 'Other'];
                const reasonPresets = [
                    { value: 'sick', label: 'Sick' },
                    { value: 'personal', label: 'Personal' },
                    { value: 'family', label: 'Family Emergency' },
                    { value: 'ncns', label: 'No Call / No Show' },
                    { value: 'transport', label: 'Transportation Issue' },
                    { value: 'other', label: 'Other' }
                ];

                const content = `
                <form id="new-calloff-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Date *</label>
                            <input type="date" class="form-input" id="calloff-date" value="${today}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Shift</label>
                            <select class="form-select" id="calloff-shift">
                                <option value="">Select shift...</option>
                                ${shiftOptions.map(s => `<option value="${s}">${s}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Guard Who Called Off *</label>
                            <select class="form-select" id="calloff-guard" required>
                                <option value="">Select guard...</option>
                                ${guards.map(g => `<option value="${g.id}">${Utils.escapeHtml(g.name)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Site *</label>
                            <select class="form-select" id="calloff-site" required>
                                <option value="">Select site...</option>
                                ${sites.map(s => `<option value="${s.id}">${Utils.escapeHtml(s.name)}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Time of Call</label>
                            <input type="time" class="form-input" id="calloff-time" value="${timeNow}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Reason</label>
                            <select class="form-select" id="calloff-reason-select" onchange="document.getElementById('calloff-reason').value = this.value === 'other' ? '' : this.options[this.selectedIndex].text; document.getElementById('calloff-reason').style.display = this.value === 'other' ? 'block' : 'none';">
                                <option value="">Select reason...</option>
                                ${reasonPresets.map(r => `<option value="${r.value}">${r.label}</option>`).join('')}
                            </select>
                            <input type="text" class="form-input" id="calloff-reason" placeholder="Enter reason..." style="display: none; margin-top: var(--space-2);">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Documented By</label>
                        <input type="text" class="form-input" id="calloff-documented-by" placeholder="Supervisor name who took the call">
                    </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Coverage Status *</label>
                            <select class="form-select" id="calloff-status" required>
                                <option value="pending">Pending</option>
                                <option value="covered">Covered</option>
                                <option value="uncovered">Uncovered</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Replacement Guard</label>
                            <select class="form-select" id="calloff-replacement">
                                <option value="">None assigned</option>
                                ${guards.map(g => `<option value="${g.id}">${Utils.escapeHtml(g.name)}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="calloff-notes" rows="2" placeholder="Additional notes..."></textarea>
                    </div>
                </form>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="CalloffsModule.saveNewCalloff()">Log Call-off</button>
            `;

                UI.openModal('Log Call-off', content, footer, 'lg');
            },

            saveNewCalloff: function () {
                const form = document.getElementById('new-calloff-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const replacementId = document.getElementById('calloff-replacement').value;
                const status = document.getElementById('calloff-status').value;
                const reasonSelect = document.getElementById('calloff-reason-select').value;
                const reasonText = document.getElementById('calloff-reason').value;
                const reason = reasonSelect === 'other' ? reasonText : 
                               (reasonSelect ? document.getElementById('calloff-reason-select').options[document.getElementById('calloff-reason-select').selectedIndex].text : reasonText);

                const calloff = {
                    id: this.generateCalloffId(),
                    date: document.getElementById('calloff-date').value,
                    timeOfCall: document.getElementById('calloff-time').value,
                    guardId: document.getElementById('calloff-guard').value,
                    siteId: document.getElementById('calloff-site').value,
                    shift: document.getElementById('calloff-shift').value,
                    reason: reason,
                    documentedBy: document.getElementById('calloff-documented-by').value,
                    coverageStatus: replacementId ? 'covered' : status,
                    replacementGuardId: replacementId || null,
                    notes: document.getElementById('calloff-notes').value,
                    createdAt: new Date().toISOString()
                };

                // Auto-detect NCNS
                if (reason.toLowerCase().includes('no call') || reason.toLowerCase().includes('ncns')) {
                    calloff.isNCNS = true;
                }

                DataStore.addCalloff(calloff);
                UI.closeModal();
                this.render();
                DashboardModule.render(); // Refresh dashboard
                UI.toast('Call-off Logged', 'Call-off has been recorded.', 'success');
            },

            markCovered: function (id) {
                // Use the smart Replacement Wizard
                ReplacementWizard.open(id);
            },

            // Legacy simple covered (for quick mark without wizard)
            quickMarkCovered: function (id) {
                const guards = DataStore.getActiveGuards();

                const content = `
                <form id="mark-covered-form">
                    <div class="form-group">
                        <label class="form-label">Replacement Guard</label>
                        <select class="form-select" id="covered-replacement">
                            <option value="">No specific replacement</option>
                            ${guards.map(g => `<option value="${g.id}">${Utils.escapeHtml(g.name)}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <input type="text" class="form-input" id="covered-notes" placeholder="How was this covered?">
                    </div>
                </form>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                <button class="btn btn-success" onclick="CalloffsModule.confirmCovered('${id}')">Mark Covered</button>
            `;

                UI.openModal('Mark as Covered', content, footer);
            },

            confirmCovered: function (id) {
                const replacementId = document.getElementById('covered-replacement').value;
                const notes = document.getElementById('covered-notes').value;

                const calloffs = DataStore.getCalloffs();
                const calloff = calloffs.find(c => c.id === id);

                DataStore.updateCalloff(id, {
                    coverageStatus: 'covered',
                    replacementGuardId: replacementId || null,
                    notes: calloff?.notes ? `${calloff.notes} | Covered: ${notes}` : notes
                });

                UI.closeModal();
                this.render();
                UI.toast('Marked Covered', 'Call-off has been marked as covered.', 'success');
            },

            editCalloff: function (id) {
                const calloff = DataStore.getCalloffs().find(c => c.id === id);
                if (!calloff) return;

                const guards = DataStore.getActiveGuards();
                const sites = DataStore.getSites();
                const shiftOptions = ['12Aâ€“8A', '8Aâ€“4P', '4Pâ€“12A', '7Pâ€“3A', '6Pâ€“12A', 'Other'];

                const content = `
                <form id="edit-calloff-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-input" id="edit-calloff-date" value="${calloff.date}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Shift</label>
                            <select class="form-select" id="edit-calloff-shift">
                                <option value="">Select shift...</option>
                                ${shiftOptions.map(s => `<option value="${s}" ${s === calloff.shift ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Guard</label>
                            <select class="form-select" id="edit-calloff-guard" required>
                                ${guards.map(g => `<option value="${g.id}" ${g.id === calloff.guardId ? 'selected' : ''}>${Utils.escapeHtml(g.name)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Site</label>
                            <select class="form-select" id="edit-calloff-site" required>
                                ${sites.map(s => `<option value="${s.id}" ${s.id === calloff.siteId ? 'selected' : ''}>${Utils.escapeHtml(s.name)}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reason</label>
                        <input type="text" class="form-input" id="edit-calloff-reason" value="${Utils.escapeHtml(calloff.reason || '')}">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Coverage Status</label>
                            <select class="form-select" id="edit-calloff-status">
                                ${['pending', 'covered', 'uncovered'].map(s => `<option value="${s}" ${s === calloff.coverageStatus ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Replacement Guard</label>
                            <select class="form-select" id="edit-calloff-replacement">
                                <option value="">None</option>
                                ${guards.map(g => `<option value="${g.id}" ${g.id === calloff.replacementGuardId ? 'selected' : ''}>${Utils.escapeHtml(g.name)}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="edit-calloff-notes" rows="2">${Utils.escapeHtml(calloff.notes || '')}</textarea>
                    </div>
                </form>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="CalloffsModule.saveEditedCalloff('${id}')">Save Changes</button>
            `;

                UI.openModal('Edit Call-off', content, footer, 'lg');
            },

            saveEditedCalloff: function (id) {
                const form = document.getElementById('edit-calloff-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const replacementId = document.getElementById('edit-calloff-replacement').value;

                DataStore.updateCalloff(id, {
                    date: document.getElementById('edit-calloff-date').value,
                    guardId: document.getElementById('edit-calloff-guard').value,
                    siteId: document.getElementById('edit-calloff-site').value,
                    shift: document.getElementById('edit-calloff-shift').value,
                    reason: document.getElementById('edit-calloff-reason').value,
                    coverageStatus: document.getElementById('edit-calloff-status').value,
                    replacementGuardId: replacementId || null,
                    notes: document.getElementById('edit-calloff-notes').value
                });

                UI.closeModal();
                this.render();
                UI.toast('Call-off Updated', 'Changes have been saved.', 'success');
            },

            confirmDelete: function (id) {
                const content = `<p>Are you sure you want to delete this call-off record?</p><p class="text-sm text-muted" style="margin-top: var(--space-2);">This action cannot be undone.</p>`;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                <button class="btn btn-danger" onclick="CalloffsModule.deleteCalloff('${id}')">Delete</button>
            `;

                UI.openModal('Delete Call-off', content, footer);
            },

            deleteCalloff: function (id) {
                DataStore.deleteCalloff(id);
                UI.closeModal();
                this.render();
                UI.toast('Call-off Deleted', 'Record has been removed.', 'success');
            },

            exportCSV: function () {
                let calloffs = DataStore.getCalloffs();
                const guards = DataStore.getGuards();
                const sites = DataStore.getSites();

                // Apply same filters as renderTable
                if (this.filters.site) {
                    calloffs = calloffs.filter(c => c.siteId === this.filters.site);
                }
                if (this.filters.status) {
                    calloffs = calloffs.filter(c => c.coverageStatus === this.filters.status);
                }
                if (this.filters.search) {
                    calloffs = calloffs.filter(c => {
                        const guard = guards.find(g => g.id === c.guardId);
                        const site = sites.find(s => s.id === c.siteId);
                        return (guard?.name?.toLowerCase().includes(this.filters.search) ||
                            site?.name?.toLowerCase().includes(this.filters.search) ||
                            c.reason?.toLowerCase().includes(this.filters.search));
                    });
                }

                // CSV with ID column and \r\n line endings
                let csv = 'ID,Date,Guard,Site,Shift,Reason,CoverageStatus,ReplacementGuard,Notes\r\n';
                calloffs.forEach(c => {
                    const guard = guards.find(g => g.id === c.guardId);
                    const site = sites.find(s => s.id === c.siteId);
                    const replacement = c.replacementGuardId ? guards.find(g => g.id === c.replacementGuardId) : null;

                    csv += `"${c.id || ''}","${c.date}","${guard?.name || ''}","${site?.name || ''}","${c.shift || ''}","${(c.reason || '').replace(/"/g, '""')}","${c.coverageStatus}","${replacement?.name || ''}","${(c.notes || '').replace(/"/g, '""')}"\r\n`;
                });

                Utils.downloadFile(csv, `calloffs-${Utils.toISODate(new Date())}.csv`, 'text/csv');
                UI.toast('Export Complete', `${calloffs.length} call-off(s) exported to CSV.`, 'success');
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SITES MODULE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const SitesModule = {
            filters: { search: '', status: '', category: '' },

            init: function () {
                document.getElementById('site-search')?.addEventListener('input', Utils.debounce((e) => {
                    this.filters.search = e.target.value.toLowerCase();
                    this.render();
                }, 200));

                document.getElementById('site-filter-status')?.addEventListener('change', (e) => {
                    this.filters.status = e.target.value;
                    this.render();
                });

                document.getElementById('site-filter-category')?.addEventListener('change', (e) => {
                    this.filters.category = e.target.value;
                    this.render();
                });

                document.getElementById('new-site-btn')?.addEventListener('click', () => this.openNewSiteModal());
            },

            render: function () {
                let sites = DataStore.getSites();

                // Apply filters
                if (this.filters.search) {
                    sites = sites.filter(s =>
                        s.name.toLowerCase().includes(this.filters.search) ||
                        (s.address || '').toLowerCase().includes(this.filters.search) ||
                        (s.clientName || s.managementCompany || '').toLowerCase().includes(this.filters.search) ||
                        (s.city || '').toLowerCase().includes(this.filters.search)
                    );
                }

                if (this.filters.status) {
                    sites = sites.filter(s => (s.status || 'active') === this.filters.status);
                }

                if (this.filters.category) {
                    sites = sites.filter(s => (s.category || s.type || 'other') === this.filters.category);
                }

                // Sort alphabetically by name
                sites = [...sites].sort((a, b) => (a.name || '').localeCompare(b.name || ''));

                const container = document.getElementById('sites-grid');
                const incidents = DataStore.getIncidents().filter(i => i.status !== 'Resolved');

                const categoryLabels = { 
                    residential: 'Residential', commercial: 'Commercial', warehouse: 'Warehouse',
                    office: 'Office', parking: 'Parking', industrial: 'Industrial', 
                    mixed: 'Mixed Use', other: 'Other' 
                };
                const statusBadges = {
                    active: '<span class="badge badge-success">Active</span>',
                    on_hold: '<span class="badge badge-warning">On Hold</span>',
                    terminated: '<span class="badge badge-danger">Terminated</span>'
                };
                const riskBadges = {
                    high: '<span class="badge badge-danger" title="High Risk">âš ï¸ High Risk</span>',
                    medium: '<span class="badge badge-warning" title="Medium Risk">âš¡ Medium Risk</span>'
                };

                container.innerHTML = sites.map(site => {
                    const siteIncidents = incidents.filter(i => i.siteId === site.id).length;
                    const siteCategory = site.category || site.type || 'other';
                    const siteStatus = site.status || 'active';
                    const siteRisk = site.riskLevel || 'low';
                    const shiftPatterns = site.shiftPatterns || [];
                    const primaryContacts = site.primaryContacts || [];
                    const contract = site.contract || {};
                    const access = site.access || {};

                    // Calculate total staffing requirements
                    const totalArmed = shiftPatterns.reduce((sum, p) => sum + (p.armedCount || 0), 0);
                    const totalUnarmed = shiftPatterns.reduce((sum, p) => sum + (p.unarmedCount || 0), 0);
                    
                    // Check contract expiration
                    let contractWarning = '';
                    if (contract.endDate) {
                        const daysUntilEnd = Math.ceil((new Date(contract.endDate) - new Date()) / (1000 * 60 * 60 * 24));
                        if (daysUntilEnd < 0) {
                            contractWarning = '<span class="badge badge-danger" title="Contract expired" style="font-size: 0.7rem;">Contract Expired</span>';
                        } else if (daysUntilEnd <= 30) {
                            contractWarning = `<span class="badge badge-warning" title="Contract ends in ${daysUntilEnd} days" style="font-size: 0.7rem;">Expires ${daysUntilEnd}d</span>`;
                        }
                    }

                    return `
                    <div class="card" id="site-card-${site.id}" style="${siteStatus === 'terminated' ? 'opacity: 0.6;' : ''}">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">${Utils.escapeHtml(site.name)}</h3>
                                <div class="flex gap-2" style="flex-wrap: wrap; margin-top: var(--space-1);">
                                    <span class="text-sm text-muted">${categoryLabels[siteCategory] || siteCategory}</span>
                                    ${statusBadges[siteStatus] || ''}
                                    ${contractWarning}
                                </div>
                            </div>
                            <div class="flex flex-col gap-1" style="align-items: flex-end;">
                                ${siteIncidents > 0 ? `<span class="badge badge-danger">${siteIncidents} issue${siteIncidents > 1 ? 's' : ''}</span>` : '<span class="badge badge-success">OK</span>'}
                                ${riskBadges[siteRisk] || ''}
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <div class="text-sm text-muted">Address</div>
                                <div class="sensitive">${Utils.escapeHtml(site.address || '')}</div>
                            </div>
                            ${site.clientName || site.managementCompany ? `
                                <div class="mb-4">
                                    <div class="text-sm text-muted">Client</div>
                                    <div>${Utils.escapeHtml(site.clientName || site.managementCompany)}</div>
                                </div>
                            ` : ''}
                            ${shiftPatterns.length > 0 ? `
                                <div class="mb-4">
                                    <div class="text-sm text-muted">Coverage</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: var(--space-1); margin-top: var(--space-1);">
                                        ${shiftPatterns.map(p => {
                                            const staffing = [];
                                            if (p.armedCount) staffing.push(`${p.armedCount}A`);
                                            if (p.unarmedCount) staffing.push(`${p.unarmedCount}U`);
                                            return `<span class="badge badge-neutral" title="${p.startTime}â€“${p.endTime}">${p.label}${staffing.length ? ' (' + staffing.join('+') + ')' : ''}</span>`;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            ${primaryContacts.length > 0 ? `
                                <div class="mb-4">
                                    <div class="text-sm text-muted">Primary Contact</div>
                                    <div class="sensitive">${Utils.escapeHtml(primaryContacts[0].name)}${primaryContacts[0].phone ? ' Â· ' + Utils.formatPhone(primaryContacts[0].phone) : ''}</div>
                                </div>
                            ` : ''}
                            ${access.gateCode ? `
                                <div style="display: inline-block; background: var(--color-surface-elevated); padding: 2px 8px; border-radius: var(--radius-sm); font-size: var(--font-size-xs);">
                                    ğŸ”‘ <span class="sensitive">${Utils.escapeHtml(access.gateCode)}</span>
                                </div>
                            ` : ''}
                            ${site.riskNotes ? `
                                <div style="background: var(--color-warning-bg); padding: var(--space-2) var(--space-3); border-radius: var(--radius-md); margin-top: var(--space-2);">
                                    <div class="text-sm" style="color: var(--color-warning);">âš ï¸ ${Utils.escapeHtml(site.riskNotes)}</div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-sm btn-ghost" onclick="SitesModule.viewSite('${site.id}')">View Details</button>
                            <button class="btn btn-sm btn-ghost" onclick="SitesModule.editSite('${site.id}')">Edit</button>
                            <button class="btn btn-sm btn-ghost" style="color: var(--color-danger);" onclick="SitesModule.confirmDeleteSite('${site.id}')">Delete</button>
                        </div>
                    </div>
                `;
                }).join('');

                if (sites.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p class="text-muted">No sites found</p></div>';
                }
            },

            viewSite: function (id) {
                const site = DataStore.getSiteById(id);
                if (!site) return;

                const protocolCount = DataStore.getProtocolsBySiteId(id).length;
                const hasSOP = SOPModule.hasSOP(id);
                const contract = site.contract || {};
                const access = site.access || {};
                const equipment = site.equipment || [];

                // Calculate total staffing
                const shiftPatterns = site.shiftPatterns || [];
                const totalArmed = shiftPatterns.reduce((sum, p) => sum + (p.armedCount || 0), 0);
                const totalUnarmed = shiftPatterns.reduce((sum, p) => sum + (p.unarmedCount || 0), 0);

                const content = `
                <div class="site-detail-tabs">
                    <div class="tab-nav" style="display: flex; gap: var(--space-1); margin-bottom: var(--space-4); border-bottom: 1px solid var(--color-border);">
                        <button class="tab-btn active" data-tab="info" onclick="SitesModule.switchTab('info')" style="padding: var(--space-2) var(--space-4); background: none; border: none; border-bottom: 2px solid var(--color-primary); color: var(--color-primary); cursor: pointer; font-weight: 500;">
                            Overview
                        </button>
                        <button class="tab-btn" data-tab="access" onclick="SitesModule.switchTab('access')" style="padding: var(--space-2) var(--space-4); background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-text-muted); cursor: pointer;">
                            Access Info
                        </button>
                        <button class="tab-btn" data-tab="sop" onclick="SitesModule.switchTab('sop')" style="padding: var(--space-2) var(--space-4); background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-text-muted); cursor: pointer;">
                            SOP ${hasSOP ? '<span class="badge badge-success" style="font-size: 0.65rem; margin-left: 4px;">âœ“</span>' : ''}
                        </button>
                        <button class="tab-btn" data-tab="protocols" onclick="SitesModule.switchTab('protocols')" style="padding: var(--space-2) var(--space-4); background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-text-muted); cursor: pointer;">
                            Protocols ${protocolCount > 0 ? `<span class="badge badge-info" style="font-size: 0.65rem; margin-left: 4px;">${protocolCount}</span>` : ''}
                        </button>
                    </div>
                    
                    <!-- OVERVIEW TAB -->
                    <div class="tab-content" data-tab-content="info">
                        <!-- Quick Stats -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-3); margin-bottom: var(--space-4);">
                            <div style="background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md); text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-primary);">${shiftPatterns.length}</div>
                                <div class="text-xs text-muted">Shifts</div>
                            </div>
                            <div style="background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md); text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-danger);">${totalArmed}</div>
                                <div class="text-xs text-muted">Armed/Day</div>
                            </div>
                            <div style="background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md); text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-info);">${totalUnarmed}</div>
                                <div class="text-xs text-muted">Unarmed/Day</div>
                            </div>
                            <div style="background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md); text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700;">${contract.billingRate ? '$' + contract.billingRate : 'â€”'}</div>
                                <div class="text-xs text-muted">$/Hour</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-4);">
                            <div><div class="text-sm text-muted">Category</div><div class="font-medium">${(site.category || site.type || 'Other').charAt(0).toUpperCase() + (site.category || site.type || 'other').slice(1)}</div></div>
                            <div><div class="text-sm text-muted">Client</div><div class="font-medium">${Utils.escapeHtml(site.clientName || site.managementCompany || 'â€”')}</div></div>
                        </div>
                        <div class="mb-4">
                            <div class="text-sm text-muted">Address</div>
                            <div class="sensitive">${Utils.escapeHtml(site.address)}</div>
                        </div>
                        
                        <!-- Shift Coverage -->
                        ${shiftPatterns.length > 0 ? `
                            <div class="mb-4">
                                <div class="text-sm text-muted mb-2">Shift Coverage</div>
                                <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                    ${shiftPatterns.map(p => {
                                        const staffing = [];
                                        if (p.armedCount) staffing.push(`<span style="color: var(--color-danger);">${p.armedCount} Armed</span>`);
                                        if (p.unarmedCount) staffing.push(`<span style="color: var(--color-info);">${p.unarmedCount} Unarmed</span>`);
                                        return `
                                            <div style="display: flex; justify-content: space-between; align-items: center; background: var(--color-surface-elevated); padding: var(--space-2) var(--space-3); border-radius: var(--radius-md);">
                                                <span class="font-medium">${Utils.escapeHtml(p.label)}</span>
                                                <span class="text-sm text-muted">${p.startTime} â€“ ${p.endTime}</span>
                                                <span class="text-sm">${staffing.join(' + ') || '1 Guard'}</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Contacts -->
                        ${(site.primaryContacts || []).length > 0 ? `
                            <div class="mb-4">
                                <div class="text-sm text-muted mb-2">Contacts</div>
                                ${site.primaryContacts.map(c => `
                                    <div style="background: var(--color-surface-elevated); padding: var(--space-2) var(--space-3); border-radius: var(--radius-md); margin-bottom: var(--space-2);">
                                        <div class="font-medium sensitive">${Utils.escapeHtml(c.name)}</div>
                                        <div class="text-sm text-muted">${Utils.escapeHtml(c.role || 'Contact')}${c.phone ? ' Â· <span class="sensitive">' + Utils.formatPhone(c.phone) + '</span>' : ''}${c.email ? ' Â· ' + Utils.escapeHtml(c.email) : ''}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <!-- Contract Info -->
                        ${contract.startDate || contract.endDate ? `
                            <div class="mb-4">
                                <div class="text-sm text-muted mb-2">Contract</div>
                                <div style="background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md);">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-2);">
                                        ${contract.startDate ? `<div><span class="text-sm text-muted">Start:</span> ${new Date(contract.startDate).toLocaleDateString()}</div>` : ''}
                                        ${contract.endDate ? `<div><span class="text-sm text-muted">End:</span> ${new Date(contract.endDate).toLocaleDateString()}</div>` : ''}
                                    </div>
                                    ${contract.invoiceFrequency ? `<div class="text-sm" style="margin-top: var(--space-2);"><span class="text-muted">Billing:</span> ${contract.invoiceFrequency.charAt(0).toUpperCase() + contract.invoiceFrequency.slice(1)}</div>` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${site.sopHighlights ? `<div class="mb-4"><div class="text-sm text-muted">SOP Notes</div><div>${Utils.escapeHtml(site.sopHighlights)}</div></div>` : ''}
                        ${site.riskNotes ? `<div class="mb-4"><div class="text-sm text-muted">Risk Notes</div><div style="color: var(--color-warning);">âš ï¸ ${Utils.escapeHtml(site.riskNotes)}</div></div>` : ''}
                    </div>
                    
                    <!-- ACCESS INFO TAB -->
                    <div class="tab-content" data-tab-content="access" style="display: none;">
                        ${access.gateCode || access.keyBoxLocation || access.parkingInstructions || access.accessNotes || equipment.length > 0 ? `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-4);">
                                ${access.gateCode ? `
                                    <div style="background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md);">
                                        <div class="text-sm text-muted">ğŸ”‘ Gate Code</div>
                                        <div class="font-medium sensitive" style="font-size: 1.25rem;">${Utils.escapeHtml(access.gateCode)}</div>
                                    </div>
                                ` : ''}
                                ${access.keyBoxLocation ? `
                                    <div style="background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md);">
                                        <div class="text-sm text-muted">ğŸ“¦ Key Box</div>
                                        <div class="sensitive">${Utils.escapeHtml(access.keyBoxLocation)}</div>
                                    </div>
                                ` : ''}
                            </div>
                            ${access.parkingInstructions ? `
                                <div class="mb-4">
                                    <div class="text-sm text-muted">ğŸš— Parking</div>
                                    <div>${Utils.escapeHtml(access.parkingInstructions)}</div>
                                </div>
                            ` : ''}
                            ${access.accessNotes ? `
                                <div class="mb-4">
                                    <div class="text-sm text-muted">ğŸ“ Access Notes</div>
                                    <div>${Utils.escapeHtml(access.accessNotes)}</div>
                                </div>
                            ` : ''}
                            ${equipment.length > 0 ? `
                                <div class="mb-4">
                                    <div class="text-sm text-muted mb-2">ğŸ“¦ Equipment On-Site</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: var(--space-2);">
                                        ${equipment.map(eq => `<span class="badge badge-neutral">${eq.charAt(0).toUpperCase() + eq.slice(1)}</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        ` : '<div class="text-muted text-center" style="padding: var(--space-6);">No access information configured</div>'}
                    </div>
                    
                    <!-- SOP TAB -->
                    <div class="tab-content" data-tab-content="sop" style="display: none;">
                        ${SOPModule.renderSOP(id)}
                    </div>
                    
                    <!-- PROTOCOLS TAB -->
                    <div class="tab-content" data-tab-content="protocols" style="display: none;">
                        ${ProtocolsModule.renderForSite(id)}
                    </div>
                </div>
            `;

                const footer = `<button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>`;
                UI.openModal(site.name, content, footer, 'lg');
            },

            switchTab: function (tabName) {
                // Update tab buttons
                document.querySelectorAll('.site-detail-tabs .tab-btn').forEach(btn => {
                    if (btn.dataset.tab === tabName) {
                        btn.classList.add('active');
                        btn.style.borderBottomColor = 'var(--color-primary)';
                        btn.style.color = 'var(--color-primary)';
                    } else {
                        btn.classList.remove('active');
                        btn.style.borderBottomColor = 'transparent';
                        btn.style.color = 'var(--color-text-muted)';
                    }
                });

                // Update tab content
                document.querySelectorAll('.site-detail-tabs .tab-content').forEach(content => {
                    content.style.display = content.dataset.tabContent === tabName ? 'block' : 'none';
                });
            },

            editSite: function (id) {
                const site = DataStore.getSiteById(id);
                if (!site) return;

                const categoryOptions = ['residential', 'commercial', 'warehouse', 'office', 'parking', 'industrial', 'mixed', 'other'];
                const statusOptions = [
                    { value: 'active', label: 'Active' },
                    { value: 'pending', label: 'Pending Start' },
                    { value: 'on_hold', label: 'On Hold' },
                    { value: 'terminated', label: 'Terminated' }
                ];
                const riskOptions = [
                    { value: 'low', label: 'Low' },
                    { value: 'medium', label: 'Medium' },
                    { value: 'high', label: 'High' }
                ];
                const currentCategory = site.category || site.type || 'other';
                const currentStatus = site.status || 'active';
                const currentRisk = site.riskLevel || 'low';
                const contract = site.contract || {};
                const access = site.access || {};
                const equipment = site.equipment || [];

                // Build shift rows
                const shiftRows = (site.shiftPatterns || []).map((p, idx) => `
                    <div class="shift-pattern-row" style="display: grid; grid-template-columns: 1fr 100px 30px 100px 60px 60px auto; gap: var(--space-2); align-items: center; background: var(--color-surface); padding: var(--space-2); border-radius: var(--radius-md);">
                        <input type="text" class="form-input" placeholder="Shift name" value="${Utils.escapeHtml(p.label)}" data-shift-label="${idx}">
                        <input type="time" class="form-input" value="${p.startTime}" data-shift-start="${idx}">
                        <span class="text-muted text-center">to</span>
                        <input type="time" class="form-input" value="${p.endTime}" data-shift-end="${idx}">
                        <input type="number" class="form-input" min="0" value="${p.armedCount || 1}" data-shift-armed="${idx}" title="Armed">
                        <input type="number" class="form-input" min="0" value="${p.unarmedCount || 0}" data-shift-unarmed="${idx}" title="Unarmed">
                        <button type="button" class="btn btn-sm btn-ghost" style="color: var(--color-danger);" onclick="SitesModule.removeShiftRow(this)">âœ•</button>
                    </div>
                `).join('');

                // Build contacts list
                const contactRows = (site.primaryContacts || []).map((c, idx) => `
                    <div class="contact-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: var(--space-2); align-items: center; background: var(--color-surface); padding: var(--space-2); border-radius: var(--radius-md);">
                        <input type="text" class="form-input" placeholder="Name" value="${Utils.escapeHtml(c.name || '')}" data-contact-name="${idx}">
                        <input type="text" class="form-input" placeholder="Role" value="${Utils.escapeHtml(c.role || '')}" data-contact-role="${idx}">
                        <input type="tel" class="form-input" placeholder="Phone" value="${Utils.escapeHtml(c.phone || '')}" data-contact-phone="${idx}">
                        <input type="email" class="form-input" placeholder="Email" value="${Utils.escapeHtml(c.email || '')}" data-contact-email="${idx}">
                        <button type="button" class="btn btn-sm btn-ghost" style="color: var(--color-danger);" onclick="SitesModule.removeContactRow(this)">âœ•</button>
                    </div>
                `).join('');

                const content = `
                <div style="max-height: 70vh; overflow-y: auto;">
                    <!-- TAB NAVIGATION -->
                    <div style="display: flex; gap: var(--space-1); margin-bottom: var(--space-4); border-bottom: 1px solid var(--color-border);">
                        <button type="button" class="site-tab-btn active" data-tab="basic" onclick="SitesModule.switchEditTab('basic')" style="padding: var(--space-2) var(--space-4); background: none; border: none; border-bottom: 2px solid var(--color-primary); color: var(--color-primary); cursor: pointer; font-weight: 500;">
                            Basic Info
                        </button>
                        <button type="button" class="site-tab-btn" data-tab="client" onclick="SitesModule.switchEditTab('client')" style="padding: var(--space-2) var(--space-4); background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-text-muted); cursor: pointer;">
                            Client
                        </button>
                        <button type="button" class="site-tab-btn" data-tab="coverage" onclick="SitesModule.switchEditTab('coverage')" style="padding: var(--space-2) var(--space-4); background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-text-muted); cursor: pointer;">
                            Coverage
                        </button>
                        <button type="button" class="site-tab-btn" data-tab="access" onclick="SitesModule.switchEditTab('access')" style="padding: var(--space-2) var(--space-4); background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-text-muted); cursor: pointer;">
                            Access
                        </button>
                    </div>
                    
                    <form id="edit-site-form">
                        <!-- BASIC INFO TAB -->
                        <div class="site-tab-content" data-tab-content="basic">
                            <div class="form-group">
                                <label class="form-label">Site Name</label>
                                <input type="text" class="form-input" id="edit-site-name" value="${Utils.escapeHtml(site.name)}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Address</label>
                                <input type="text" class="form-input" id="edit-site-address" value="${Utils.escapeHtml(site.address)}" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Category</label>
                                    <select class="form-select" id="edit-site-type">
                                        ${categoryOptions.map(t => `<option value="${t}" ${t === currentCategory ? 'selected' : ''}>${t.charAt(0).toUpperCase() + t.slice(1)}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Site Code</label>
                                    <input type="text" class="form-input" id="edit-site-code" value="${Utils.escapeHtml(site.siteCode || '')}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="edit-site-status">
                                        ${statusOptions.map(s => `<option value="${s.value}" ${s.value === currentStatus ? 'selected' : ''}>${s.label}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Risk Level</label>
                                    <select class="form-select" id="edit-site-risklevel">
                                        ${riskOptions.map(r => `<option value="${r.value}" ${r.value === currentRisk ? 'selected' : ''}>${r.label}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Risk Notes</label>
                                <textarea class="form-textarea" id="edit-site-risk" rows="2">${Utils.escapeHtml(site.riskNotes || '')}</textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">SOP Notes</label>
                                <textarea class="form-textarea" id="edit-site-sop" rows="2">${Utils.escapeHtml(site.sopHighlights || '')}</textarea>
                            </div>
                        </div>
                        
                        <!-- CLIENT TAB -->
                        <div class="site-tab-content" data-tab-content="client" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Client/Property Management</label>
                                <input type="text" class="form-input" id="edit-site-client" value="${Utils.escapeHtml(site.clientName || site.managementCompany || '')}">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Contract Start</label>
                                    <input type="date" class="form-input" id="edit-site-contract-start" value="${contract.startDate || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Contract End</label>
                                    <input type="date" class="form-input" id="edit-site-contract-end" value="${contract.endDate || ''}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Billing Rate ($/hr)</label>
                                    <input type="number" class="form-input" id="edit-site-billing-rate" step="0.50" min="0" value="${contract.billingRate || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Invoice Frequency</label>
                                    <select class="form-select" id="edit-site-invoice-freq">
                                        <option value="weekly" ${contract.invoiceFrequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                                        <option value="biweekly" ${contract.invoiceFrequency === 'biweekly' || !contract.invoiceFrequency ? 'selected' : ''}>Bi-Weekly</option>
                                        <option value="monthly" ${contract.invoiceFrequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="margin-top: var(--space-4);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2);">
                                    <label class="form-label" style="margin: 0;">Contacts</label>
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="SitesModule.addContactRow()">+ Add Contact</button>
                                </div>
                                <div id="edit-site-contacts" style="display: flex; flex-direction: column; gap: var(--space-2);">
                                    ${contactRows || '<div class="text-sm text-muted">No contacts added</div>'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- COVERAGE TAB -->
                        <div class="site-tab-content" data-tab-content="coverage" style="display: none;">
                            <div style="margin-bottom: var(--space-2);">
                                <label class="form-label">Shift Coverage Requirements</label>
                                <div class="text-xs text-muted" style="margin-bottom: var(--space-2);">A = Armed guards, U = Unarmed guards required per shift</div>
                            </div>
                            <div id="edit-site-shifts" style="display: flex; flex-direction: column; gap: var(--space-2); margin-bottom: var(--space-2);">
                                ${shiftRows || '<div class="text-sm text-muted">No shifts defined</div>'}
                            </div>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="SitesModule.addShiftRowEdit()">+ Add Shift</button>
                            
                            <div style="margin-top: var(--space-4); padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md);">
                                <label class="form-label">Equipment On-Site</label>
                                <div style="display: flex; flex-wrap: wrap; gap: var(--space-2);">
                                    ${['radio', 'flashlight', 'keys', 'vehicle', 'wand', 'camera', 'cctv'].map(eq => `
                                        <label style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--color-surface); border-radius: var(--radius-sm);">
                                            <input type="checkbox" name="edit-site-equipment" value="${eq}" ${equipment.includes(eq) ? 'checked' : ''}> ${eq.charAt(0).toUpperCase() + eq.slice(1)}
                                        </label>
                                    `).join('')}
                                </div>
                                <div class="form-group" style="margin-top: var(--space-2);">
                                    <input type="text" class="form-input" id="edit-site-equipment-other" placeholder="Other equipment..." value="${Utils.escapeHtml(equipment.filter(e => !['radio', 'flashlight', 'keys', 'vehicle', 'wand', 'camera', 'cctv'].includes(e)).join(', '))}">
                                </div>
                            </div>
                        </div>
                        
                        <!-- ACCESS TAB -->
                        <div class="site-tab-content" data-tab-content="access" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Gate Code</label>
                                    <input type="text" class="form-input" id="edit-site-gate-code" value="${Utils.escapeHtml(access.gateCode || '')}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Key Box Location</label>
                                    <input type="text" class="form-input" id="edit-site-keybox" value="${Utils.escapeHtml(access.keyBoxLocation || '')}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Parking Instructions</label>
                                <input type="text" class="form-input" id="edit-site-parking" value="${Utils.escapeHtml(access.parkingInstructions || '')}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Access Notes</label>
                                <textarea class="form-textarea" id="edit-site-access-notes" rows="3">${Utils.escapeHtml(access.accessNotes || '')}</textarea>
                            </div>
                            
                            ${site.createdAt ? `
                                <div style="margin-top: var(--space-4); padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md);">
                                    <div class="text-sm text-muted">Record Created</div>
                                    <div class="text-sm">${new Date(site.createdAt).toLocaleString()}</div>
                                    ${site.updatedAt ? `
                                        <div class="text-sm text-muted" style="margin-top: var(--space-2);">Last Updated</div>
                                        <div class="text-sm">${new Date(site.updatedAt).toLocaleString()}</div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </form>
                </div>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="SitesModule.saveSite('${id}')">Save Changes</button>
            `;

                UI.openModal(`Edit ${site.name}`, content, footer, 'lg');
            },

            // Tab switching for edit modal
            switchEditTab: function(tabName) {
                document.querySelectorAll('.site-tab-content').forEach(el => el.style.display = 'none');
                document.querySelectorAll('[data-tab-content="' + tabName + '"]').forEach(el => el.style.display = 'block');
                
                document.querySelectorAll('.site-tab-btn').forEach(btn => {
                    btn.style.borderBottomColor = 'transparent';
                    btn.style.color = 'var(--color-text-muted)';
                });
                document.querySelectorAll('.site-tab-btn[data-tab="' + tabName + '"]').forEach(btn => {
                    btn.style.borderBottomColor = 'var(--color-primary)';
                    btn.style.color = 'var(--color-primary)';
                });
            },

            // Add shift row for edit form
            addShiftRowEdit: function() {
                const container = document.getElementById('edit-site-shifts');
                // Remove "no shifts" message if present
                const noShiftsMsg = container.querySelector('.text-muted');
                if (noShiftsMsg) noShiftsMsg.remove();
                
                const idx = container.querySelectorAll('.shift-pattern-row').length;
                const row = document.createElement('div');
                row.className = 'shift-pattern-row';
                row.style.cssText = 'display: grid; grid-template-columns: 1fr 100px 30px 100px 60px 60px auto; gap: var(--space-2); align-items: center; background: var(--color-surface); padding: var(--space-2); border-radius: var(--radius-md);';
                row.innerHTML = `
                    <input type="text" class="form-input" placeholder="Shift name" data-shift-label="${idx}">
                    <input type="time" class="form-input" value="16:00" data-shift-start="${idx}">
                    <span class="text-muted text-center">to</span>
                    <input type="time" class="form-input" value="00:00" data-shift-end="${idx}">
                    <input type="number" class="form-input" min="0" value="1" data-shift-armed="${idx}" title="Armed">
                    <input type="number" class="form-input" min="0" value="0" data-shift-unarmed="${idx}" title="Unarmed">
                    <button type="button" class="btn btn-sm btn-ghost" style="color: var(--color-danger);" onclick="SitesModule.removeShiftRow(this)">âœ•</button>
                `;
                container.appendChild(row);
            },

            // Add contact row
            addContactRow: function() {
                const container = document.getElementById('edit-site-contacts');
                // Remove "no contacts" message if present
                const noContactsMsg = container.querySelector('.text-muted');
                if (noContactsMsg) noContactsMsg.remove();
                
                const idx = container.querySelectorAll('.contact-row').length;
                const row = document.createElement('div');
                row.className = 'contact-row';
                row.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: var(--space-2); align-items: center; background: var(--color-surface); padding: var(--space-2); border-radius: var(--radius-md);';
                row.innerHTML = `
                    <input type="text" class="form-input" placeholder="Name" data-contact-name="${idx}">
                    <input type="text" class="form-input" placeholder="Role" data-contact-role="${idx}">
                    <input type="tel" class="form-input" placeholder="Phone" data-contact-phone="${idx}">
                    <input type="email" class="form-input" placeholder="Email" data-contact-email="${idx}">
                    <button type="button" class="btn btn-sm btn-ghost" style="color: var(--color-danger);" onclick="SitesModule.removeContactRow(this)">âœ•</button>
                `;
                container.appendChild(row);
            },

            removeContactRow: function(btn) {
                btn.closest('.contact-row').remove();
            },

            saveSite: function (id) {
                const sites = DataStore.getSites();
                const idx = sites.findIndex(s => s.id === id);

                if (idx !== -1) {
                    // Basic info
                    sites[idx].name = document.getElementById('edit-site-name').value.trim();
                    sites[idx].address = document.getElementById('edit-site-address').value.trim();
                    sites[idx].type = document.getElementById('edit-site-type').value;
                    sites[idx].category = document.getElementById('edit-site-type').value;
                    sites[idx].siteCode = document.getElementById('edit-site-code')?.value.trim() || '';
                    sites[idx].status = document.getElementById('edit-site-status')?.value || 'active';
                    sites[idx].riskLevel = document.getElementById('edit-site-risklevel')?.value || 'low';
                    sites[idx].sopHighlights = document.getElementById('edit-site-sop')?.value.trim() || '';
                    sites[idx].riskNotes = document.getElementById('edit-site-risk')?.value.trim() || '';

                    // Client info
                    const clientName = document.getElementById('edit-site-client')?.value.trim() || '';
                    sites[idx].clientName = clientName;
                    sites[idx].managementCompany = clientName;
                    sites[idx].contract = {
                        startDate: document.getElementById('edit-site-contract-start')?.value || null,
                        endDate: document.getElementById('edit-site-contract-end')?.value || null,
                        billingRate: parseFloat(document.getElementById('edit-site-billing-rate')?.value) || null,
                        invoiceFrequency: document.getElementById('edit-site-invoice-freq')?.value || 'biweekly'
                    };

                    // Collect contacts
                    const contactRows = document.querySelectorAll('#edit-site-contacts .contact-row');
                    const contacts = [];
                    contactRows.forEach(row => {
                        const name = row.querySelector('[data-contact-name]')?.value.trim();
                        if (name) {
                            contacts.push({
                                name: name,
                                role: row.querySelector('[data-contact-role]')?.value.trim() || '',
                                phone: row.querySelector('[data-contact-phone]')?.value.replace(/\D/g, '') || '',
                                email: row.querySelector('[data-contact-email]')?.value.trim() || ''
                            });
                        }
                    });
                    sites[idx].primaryContacts = contacts;

                    // Collect shift patterns with staffing
                    const shiftRows = document.querySelectorAll('#edit-site-shifts .shift-pattern-row');
                    const shiftPatterns = [];
                    shiftRows.forEach(row => {
                        const label = row.querySelector('[data-shift-label]')?.value.trim();
                        const startTime = row.querySelector('[data-shift-start]')?.value;
                        const endTime = row.querySelector('[data-shift-end]')?.value;
                        const armedCount = parseInt(row.querySelector('[data-shift-armed]')?.value) || 0;
                        const unarmedCount = parseInt(row.querySelector('[data-shift-unarmed]')?.value) || 0;
                        if (label && startTime && endTime) {
                            shiftPatterns.push({ label, startTime, endTime, armedCount, unarmedCount });
                        }
                    });
                    sites[idx].shiftPatterns = shiftPatterns;

                    // Collect equipment
                    const equipmentChecks = document.querySelectorAll('input[name="edit-site-equipment"]:checked');
                    const equipment = Array.from(equipmentChecks).map(cb => cb.value);
                    const otherEquipment = document.getElementById('edit-site-equipment-other')?.value.trim();
                    if (otherEquipment) {
                        otherEquipment.split(',').forEach(e => {
                            const trimmed = e.trim();
                            if (trimmed && !equipment.includes(trimmed)) equipment.push(trimmed);
                        });
                    }
                    sites[idx].equipment = equipment;

                    // Access info
                    sites[idx].access = {
                        gateCode: document.getElementById('edit-site-gate-code')?.value.trim() || '',
                        keyBoxLocation: document.getElementById('edit-site-keybox')?.value.trim() || '',
                        parkingInstructions: document.getElementById('edit-site-parking')?.value.trim() || '',
                        accessNotes: document.getElementById('edit-site-access-notes')?.value.trim() || ''
                    };

                    sites[idx].updatedAt = new Date().toISOString();

                    DataStore.saveSites(sites);
                    UI.closeModal();
                    this.render();
                    UI.notify('Site updated successfully', 'success');
                }
            },

            addShiftRow: function (containerId) {
                const container = document.getElementById(containerId);
                const idx = container.querySelectorAll('.shift-pattern-row').length;
                const row = document.createElement('div');
                row.className = 'shift-pattern-row';
                row.style.cssText = 'display: flex; gap: var(--space-2); align-items: center; background: var(--color-surface-elevated); padding: var(--space-2); border-radius: var(--radius-md);';
                row.innerHTML = `
                <input type="text" class="form-input" placeholder="Label (e.g. Day)" data-shift-label="${idx}" style="flex: 1;">
                <input type="time" class="form-input" value="07:00" data-shift-start="${idx}" style="width: 120px;">
                <span class="text-muted">to</span>
                <input type="time" class="form-input" value="15:00" data-shift-end="${idx}" style="width: 120px;">
                <button type="button" class="btn btn-sm btn-ghost" style="color: var(--color-danger);" onclick="SitesModule.removeShiftRow(this)" title="Remove shift" aria-label="Remove shift">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            `;
                container.appendChild(row);
            },

            removeShiftRow: function (btn) {
                btn.closest('.shift-pattern-row').remove();
            },

            openNewSiteModal: function () {
                const content = `
                <form id="new-site-form" style="max-height: 70vh; overflow-y: auto;">
                    <!-- BASIC INFO -->
                    <div style="margin-bottom: var(--space-4);">
                        <h4 style="margin: 0 0 var(--space-3); color: var(--color-primary); font-size: var(--font-size-sm); text-transform: uppercase; letter-spacing: 0.5px;">ğŸ“ Basic Information</h4>
                        
                        <div class="form-group">
                            <label class="form-label">Site Name *</label>
                            <input type="text" class="form-input" id="new-site-name" required placeholder="e.g., Georgia King Village">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address *</label>
                            <input type="text" class="form-input" id="new-site-address" required placeholder="123 Main St, Newark, NJ">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="new-site-type">
                                    <option value="residential">Residential</option>
                                    <option value="commercial">Commercial</option>
                                    <option value="warehouse">Warehouse</option>
                                    <option value="office">Office Building</option>
                                    <option value="parking">Parking Facility</option>
                                    <option value="industrial">Industrial</option>
                                    <option value="mixed">Mixed Use</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="new-site-status">
                                    <option value="active" selected>Active</option>
                                    <option value="pending">Pending Start</option>
                                    <option value="on_hold">On Hold</option>
                                    <option value="terminated">Terminated</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Risk Level</label>
                                <select class="form-select" id="new-site-risklevel">
                                    <option value="low" selected>Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Site Code</label>
                                <input type="text" class="form-input" id="new-site-code" placeholder="GKV, ZT, etc.">
                            </div>
                        </div>
                    </div>
                    
                    <!-- CLIENT INFO -->
                    <div style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md);">
                        <h4 style="margin: 0 0 var(--space-3); color: var(--color-primary); font-size: var(--font-size-sm); text-transform: uppercase; letter-spacing: 0.5px;">ğŸ¢ Client Information</h4>
                        
                        <div class="form-group">
                            <label class="form-label">Client/Property Management</label>
                            <input type="text" class="form-input" id="new-site-client" placeholder="Management company name">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Contract Start</label>
                                <input type="date" class="form-input" id="new-site-contract-start">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contract End</label>
                                <input type="date" class="form-input" id="new-site-contract-end">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Billing Rate ($/hr)</label>
                                <input type="number" class="form-input" id="new-site-billing-rate" step="0.50" min="0" placeholder="25.00">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Invoice Frequency</label>
                                <select class="form-select" id="new-site-invoice-freq">
                                    <option value="weekly">Weekly</option>
                                    <option value="biweekly" selected>Bi-Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PRIMARY CONTACT -->
                    <div style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md);">
                        <h4 style="margin: 0 0 var(--space-3); color: var(--color-primary); font-size: var(--font-size-sm); text-transform: uppercase; letter-spacing: 0.5px;">ğŸ‘¤ Primary Contact</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Contact Name</label>
                                <input type="text" class="form-input" id="new-site-contact-name" placeholder="John Smith">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Role/Title</label>
                                <input type="text" class="form-input" id="new-site-contact-role" placeholder="Property Manager">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-input" id="new-site-contact-phone" placeholder="(973) 555-0100">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="new-site-contact-email" placeholder="manager@property.com">
                            </div>
                        </div>
                    </div>
                    
                    <!-- SHIFT COVERAGE -->
                    <div style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md);">
                        <h4 style="margin: 0 0 var(--space-3); color: var(--color-primary); font-size: var(--font-size-sm); text-transform: uppercase; letter-spacing: 0.5px;">â° Shift Coverage Requirements</h4>
                        
                        <div id="new-site-shifts" style="display: flex; flex-direction: column; gap: var(--space-2); margin-bottom: var(--space-2);">
                            <div class="shift-pattern-row" style="display: grid; grid-template-columns: 1fr 100px 30px 100px 60px 60px auto; gap: var(--space-2); align-items: center; background: var(--color-surface); padding: var(--space-2); border-radius: var(--radius-md);">
                                <input type="text" class="form-input" placeholder="Shift name" value="Day" data-shift-label="0">
                                <input type="time" class="form-input" value="08:00" data-shift-start="0">
                                <span class="text-muted text-center">to</span>
                                <input type="time" class="form-input" value="16:00" data-shift-end="0">
                                <input type="number" class="form-input" min="0" value="1" data-shift-armed="0" title="Armed" placeholder="A">
                                <input type="number" class="form-input" min="0" value="0" data-shift-unarmed="0" title="Unarmed" placeholder="U">
                                <button type="button" class="btn btn-sm btn-ghost" style="color: var(--color-danger);" onclick="SitesModule.removeShiftRow(this)">âœ•</button>
                            </div>
                        </div>
                        <div style="display: flex; gap: var(--space-2); align-items: center;">
                            <button type="button" class="btn btn-sm btn-secondary" onclick="SitesModule.addShiftRowNew()">+ Add Shift</button>
                            <span class="text-xs text-muted">A = Armed guards, U = Unarmed guards per shift</span>
                        </div>
                    </div>
                    
                    <!-- ACCESS INFO -->
                    <div style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md);">
                        <h4 style="margin: 0 0 var(--space-3); color: var(--color-primary); font-size: var(--font-size-sm); text-transform: uppercase; letter-spacing: 0.5px;">ğŸ”‘ Access Information</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Gate Code</label>
                                <input type="text" class="form-input" id="new-site-gate-code" placeholder="1234#">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Key Box Location</label>
                                <input type="text" class="form-input" id="new-site-keybox" placeholder="Front entrance, left side">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Parking Instructions</label>
                            <input type="text" class="form-input" id="new-site-parking" placeholder="Park in visitor lot, display placard">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Access Notes</label>
                            <textarea class="form-textarea" id="new-site-access-notes" rows="2" placeholder="Special access instructions, after-hours entry, etc."></textarea>
                        </div>
                    </div>
                    
                    <!-- EQUIPMENT -->
                    <div style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md);">
                        <h4 style="margin: 0 0 var(--space-3); color: var(--color-primary); font-size: var(--font-size-sm); text-transform: uppercase; letter-spacing: 0.5px;">ğŸ“¦ Equipment On-Site</h4>
                        
                        <div style="display: flex; flex-wrap: wrap; gap: var(--space-2);">
                            <label style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--color-surface); border-radius: var(--radius-sm);">
                                <input type="checkbox" name="new-site-equipment" value="radio"> Radio
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--color-surface); border-radius: var(--radius-sm);">
                                <input type="checkbox" name="new-site-equipment" value="flashlight"> Flashlight
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--color-surface); border-radius: var(--radius-sm);">
                                <input type="checkbox" name="new-site-equipment" value="keys"> Keys
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--color-surface); border-radius: var(--radius-sm);">
                                <input type="checkbox" name="new-site-equipment" value="vehicle"> Patrol Vehicle
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--color-surface); border-radius: var(--radius-sm);">
                                <input type="checkbox" name="new-site-equipment" value="wand"> Tour Wand/Deggy
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--color-surface); border-radius: var(--radius-sm);">
                                <input type="checkbox" name="new-site-equipment" value="camera"> Body Camera
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--color-surface); border-radius: var(--radius-sm);">
                                <input type="checkbox" name="new-site-equipment" value="cctv"> CCTV Access
                            </label>
                        </div>
                        <div class="form-group" style="margin-top: var(--space-2);">
                            <label class="form-label">Other Equipment</label>
                            <input type="text" class="form-input" id="new-site-equipment-other" placeholder="TrackTik, specific items...">
                        </div>
                    </div>
                    
                    <!-- NOTES -->
                    <div class="form-group">
                        <label class="form-label">ğŸ“ Risk Notes</label>
                        <textarea class="form-textarea" id="new-site-risk-notes" rows="2" placeholder="Safety concerns, high-crime area, etc."></textarea>
                    </div>
                </form>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="SitesModule.createSite()">Add Site</button>
            `;

                UI.openModal('Add New Site', content, footer, 'lg');
            },

            // Add shift row for new site form
            addShiftRowNew: function() {
                const container = document.getElementById('new-site-shifts');
                const idx = container.querySelectorAll('.shift-pattern-row').length;
                const row = document.createElement('div');
                row.className = 'shift-pattern-row';
                row.style.cssText = 'display: grid; grid-template-columns: 1fr 100px 30px 100px 60px 60px auto; gap: var(--space-2); align-items: center; background: var(--color-surface); padding: var(--space-2); border-radius: var(--radius-md);';
                row.innerHTML = `
                    <input type="text" class="form-input" placeholder="Shift name" data-shift-label="${idx}">
                    <input type="time" class="form-input" value="16:00" data-shift-start="${idx}">
                    <span class="text-muted text-center">to</span>
                    <input type="time" class="form-input" value="00:00" data-shift-end="${idx}">
                    <input type="number" class="form-input" min="0" value="1" data-shift-armed="${idx}" title="Armed">
                    <input type="number" class="form-input" min="0" value="0" data-shift-unarmed="${idx}" title="Unarmed">
                    <button type="button" class="btn btn-sm btn-ghost" style="color: var(--color-danger);" onclick="SitesModule.removeShiftRow(this)">âœ•</button>
                `;
                container.appendChild(row);
            },

            // Generate sequential site ID: site-001, site-002, etc.
            generateSiteId: function () {
                const sites = DataStore.getSites();
                const maxNum = sites.reduce((max, s) => {
                    const match = s.id?.match(/^site-(\d+)$/);
                    return match ? Math.max(max, parseInt(match[1])) : max;
                }, 0);
                return `site-${String(maxNum + 1).padStart(3, '0')}`;
            },

            createSite: function () {
                const form = document.getElementById('new-site-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                // Collect shift patterns with staffing requirements
                const shiftRows = document.querySelectorAll('#new-site-shifts .shift-pattern-row');
                const shiftPatterns = [];
                shiftRows.forEach(row => {
                    const label = row.querySelector('[data-shift-label]')?.value.trim();
                    const startTime = row.querySelector('[data-shift-start]')?.value;
                    const endTime = row.querySelector('[data-shift-end]')?.value;
                    const armedCount = parseInt(row.querySelector('[data-shift-armed]')?.value) || 0;
                    const unarmedCount = parseInt(row.querySelector('[data-shift-unarmed]')?.value) || 0;
                    if (label && startTime && endTime) {
                        shiftPatterns.push({ label, startTime, endTime, armedCount, unarmedCount });
                    }
                });

                // Collect equipment
                const equipmentChecks = document.querySelectorAll('input[name="new-site-equipment"]:checked');
                const equipment = Array.from(equipmentChecks).map(cb => cb.value);
                const otherEquipment = document.getElementById('new-site-equipment-other')?.value.trim();
                if (otherEquipment) equipment.push(otherEquipment);

                // Build primary contact if provided
                const contactName = document.getElementById('new-site-contact-name')?.value.trim();
                const primaryContacts = [];
                if (contactName) {
                    primaryContacts.push({
                        name: contactName,
                        role: document.getElementById('new-site-contact-role')?.value.trim() || 'Contact',
                        phone: document.getElementById('new-site-contact-phone')?.value.replace(/\D/g, '') || '',
                        email: document.getElementById('new-site-contact-email')?.value.trim() || '',
                        isPrimary: true
                    });
                }

                const sites = DataStore.getSites();
                const newSite = {
                    id: this.generateSiteId(),
                    name: document.getElementById('new-site-name').value.trim(),
                    address: document.getElementById('new-site-address').value.trim(),
                    type: document.getElementById('new-site-type').value,
                    category: document.getElementById('new-site-type').value,
                    status: document.getElementById('new-site-status')?.value || 'active',
                    riskLevel: document.getElementById('new-site-risklevel')?.value || 'low',
                    siteCode: document.getElementById('new-site-code')?.value.trim() || '',
                    
                    // Client info
                    clientName: document.getElementById('new-site-client')?.value.trim() || '',
                    managementCompany: document.getElementById('new-site-client')?.value.trim() || '',
                    contract: {
                        startDate: document.getElementById('new-site-contract-start')?.value || null,
                        endDate: document.getElementById('new-site-contract-end')?.value || null,
                        billingRate: parseFloat(document.getElementById('new-site-billing-rate')?.value) || null,
                        invoiceFrequency: document.getElementById('new-site-invoice-freq')?.value || 'biweekly'
                    },
                    
                    // Contacts
                    primaryContacts: primaryContacts,
                    
                    // Shift patterns with staffing
                    shiftPatterns: shiftPatterns.length > 0 ? shiftPatterns : [{ label: 'Day', startTime: '08:00', endTime: '16:00', armedCount: 1, unarmedCount: 0 }],
                    
                    // Access info
                    access: {
                        gateCode: document.getElementById('new-site-gate-code')?.value.trim() || '',
                        keyBoxLocation: document.getElementById('new-site-keybox')?.value.trim() || '',
                        parkingInstructions: document.getElementById('new-site-parking')?.value.trim() || '',
                        accessNotes: document.getElementById('new-site-access-notes')?.value.trim() || ''
                    },
                    
                    // Equipment
                    equipment: equipment,
                    
                    // Notes
                    sopHighlights: '',
                    riskNotes: document.getElementById('new-site-risk-notes')?.value.trim() || '',
                    
                    // Metadata
                    createdAt: new Date().toISOString(),
                    updatedAt: null
                };

                sites.push(newSite);
                DataStore.saveSites(sites);
                UI.closeModal();
                this.render();
                UI.notify(`${newSite.name} has been added`, 'success');
            },

            confirmDeleteSite: function (id) {
                const site = DataStore.getSiteById(id);
                if (!site) return;

                const siteStatus = site.status || 'active';

                // Block deletion of active sites
                if (siteStatus === 'active') {
                    const content = `
                        <div style="background: var(--color-danger-bg, #fef2f2); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-4);">
                            <div style="color: var(--color-danger); font-size: var(--font-size-sm);">
                                <strong>Cannot Delete Active Site</strong>
                                <p style="margin-top: var(--space-2);">
                                    Active sites cannot be deleted because they may have guards assigned, scheduled shifts, or ongoing operations.
                                </p>
                                <p style="margin-top: var(--space-2);">
                                    To delete this site, first change its status to <strong>Terminated</strong> using the Edit button.
                                </p>
                            </div>
                        </div>
                        <p><strong>${Utils.escapeHtml(site.name)}</strong> is currently <span class="badge badge-success">Active</span></p>
                    `;
                    const footer = `<button class="btn btn-secondary" onclick="UI.closeModal()">Understood</button>`;
                    UI.openModal('Cannot Delete Site', content, footer);
                    return;
                }

                // Check for dependencies
                const schedules = DataStore.getSchedules();
                const incidents = DataStore.getIncidents().filter(i => i.siteId === id);
                const inspections = DataStore.getInspections().filter(i => i.siteId === id);
                const calloffs = (DataStore.getCalloffs ? DataStore.getCalloffs() : []).filter(c => c.siteId === id);
                const comms = (DataStore.getCommunications ? DataStore.getCommunications() : []).filter(c => c.siteId === id);

                let warnings = '';
                const totalDeps = incidents.length + inspections.length + calloffs.length + comms.length;
                if (totalDeps > 0) {
                    warnings = `
                    <div style="background: var(--color-warning-bg); padding: var(--space-3); border-radius: var(--radius-md); margin-bottom: var(--space-4);">
                        <div style="color: var(--color-warning); font-size: var(--font-size-sm);">
                            <strong>Warning:</strong> This site has linked data:
                            <ul style="margin: var(--space-2) 0 0 var(--space-4);">
                                ${incidents.length > 0 ? `<li>${incidents.length} incident(s)</li>` : ''}
                                ${inspections.length > 0 ? `<li>${inspections.length} inspection(s)</li>` : ''}
                                ${calloffs.length > 0 ? `<li>${calloffs.length} call-off(s)</li>` : ''}
                                ${comms.length > 0 ? `<li>${comms.length} communication(s)</li>` : ''}
                            </ul>
                            Deleting this site will NOT delete linked records, but they will reference an unknown site.
                        </div>
                    </div>
                `;
                }

                const statusLabel = siteStatus === 'terminated' ? 'Terminated' : 'On Hold';
                const content = `
                ${warnings}
                <p>Are you sure you want to delete <strong>${Utils.escapeHtml(site.name)}</strong>?</p>
                <p class="text-sm" style="margin-top: var(--space-2);">Status: <span class="badge badge-${siteStatus === 'terminated' ? 'danger' : 'warning'}">${statusLabel}</span></p>
                <p class="text-muted text-sm" style="margin-top: var(--space-2);">This action cannot be undone.</p>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                <button class="btn" style="background: var(--color-danger); color: white;" onclick="SitesModule.deleteSite('${id}')">Delete Site</button>
            `;

                UI.openModal('Delete Site', content, footer);
            },

            deleteSite: function (id) {
                const sites = DataStore.getSites();
                const site = sites.find(s => s.id === id);
                const siteName = site?.name || 'Site';

                const filtered = sites.filter(s => s.id !== id);
                DataStore.saveSites(filtered);

                UI.closeModal();
                this.render();
                DashboardModule.renderSiteStatus(); // Refresh dashboard site status
                UI.toast('Site Deleted', `${siteName} has been removed.`, 'success');
            }
        };



        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SOP DATA â€” SUPERVISOR ONLY (VERIFIED v6.11.0)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Keyed by site.id ONLY. No aliases. No fuzzy matching.
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const SOP_DATA = {
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // GEORGIA KING VILLAGE (VERIFIED)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            "site-001": {
                meta: {
                    siteName: "Georgia King Village",
                    approvedBy: "VPS Supervisor",
                    status: "VERIFIED"
                },
                coverage: {
                    hours: "24/7",
                    shifts: ["12Aâ€“8A", "8Aâ€“4P", "4Pâ€“12A"]
                },
                postAssignments: {
                    unarmed: {
                        post: "Main entry booth",
                        duties: [
                            "Stop vehicles",
                            "Log vehicle and visitor information",
                            "Verify destination"
                        ]
                    },
                    armed: {
                        post: "Mobile patrol",
                        duties: [
                            "Foot patrols",
                            "Emergency response",
                            "Lockouts",
                            "De-escalation support"
                        ]
                    }
                },
                patrols: {
                    frequency: "TrackTik tours"
                },
                accessControl: {
                    vehicleBased: true
                },
                commonIssues: ["Loitering", "Smoking", "Fire lane parking"],
                useOfForce: "Self-defense only",
                escalation: ["Emergency Services", "VPS Supervisor"],
                tourSystem: "TrackTik"
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // ZION TOWERS (VERIFIED)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            "site-002": {
                meta: {
                    siteName: "Zion Towers",
                    approvedBy: "VPS Supervisor",
                    status: "VERIFIED"
                },
                coverage: {
                    hours: "24/7",
                    shifts: [
                        { time: "12Aâ€“8A", staffing: "2 unarmed" },
                        { time: "8Aâ€“4P", staffing: "2 unarmed" },
                        { time: "4Pâ€“12A", staffing: "1 armed, 1 unarmed" }
                    ]
                },
                postAssignments: {
                    armed: {
                        post: "Lobby desk",
                        rules: ["Remain at post except emergencies"]
                    },
                    unarmed: {
                        post: "Mobile patrol",
                        duties: ["Interior patrols", "Elevators", "Exterior rounds"]
                    }
                },
                afterHoursAccess: "Resident confirmation 2200â€“0600",
                specialInstructions: [
                    "VIP units 1501 / 1502",
                    "Maintenance Mâ€“F 0800â€“1700",
                    "Fire panel in lobby",
                    "Elevator entrapment procedure",
                    "Manager on-site Tu/Th 1000â€“1400"
                ],
                useOfForce: "Self-defense / defense of others",
                cameras: "Live monitored",
                tourSystem: "TrackTik"
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // 244 CHADWICK AVE (MOUNT CALVARY) (VERIFIED)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            "site-003": {
                meta: {
                    siteName: "244 Chadwick Ave (Mount Calvary)",
                    status: "VERIFIED"
                },
                coverage: {
                    hours: "24/7",
                    staffing: "1 unarmed per shift"
                },
                postAssignments: {
                    unarmed: {
                        post: "Interior before lobby",
                        duties: ["ID checks", "Visitor logging", "Door access"]
                    }
                },
                patrols: {
                    frequency: "Every 2 hours",
                    type: "Foot + elevator"
                },
                commonIssues: ["Smoking", "Loitering"],
                escalation: ["Police", "VPS Supervisor"]
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // 100 CHADWICK AVE (VERIFIED)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            "site-004": {
                meta: {
                    siteName: "100 Chadwick Ave",
                    status: "VERIFIED"
                },
                coverage: {
                    hours: "24/7",
                    staffing: "1 unarmed per shift"
                },
                postAssignments: {
                    unarmed: {
                        post: "Interior before lobby",
                        duties: ["ID checks", "Visitor logging", "Door access"]
                    }
                },
                patrols: {
                    frequency: "Every 2 hours",
                    type: "Foot + elevator"
                },
                escalation: ["Police", "VPS Supervisor"]
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // HAHNE & CO (VERIFIED)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            "site-006": {
                meta: {
                    siteName: "Hahne & Co",
                    status: "VERIFIED"
                },
                coverage: {
                    hours: "Evenings / weekends"
                },
                patrols: {
                    type: "Interior foot patrols"
                },
                tourSystem: "Deggy Wand (client-owned)",
                commonIssues: ["Unauthorized access"],
                escalation: ["Police", "VPS Supervisor"],
                specialInstructions: [
                    "âš ï¸ SITE USES ITS OWN DEGGY WAND SYSTEM (NOT COMPANY-PROVIDED)",
                    "Deggy wand must be used for ALL patrols â€” no exceptions",
                    "Wand data is audited by building management"
                ]
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // GLORIA ROBINSON COURT HOMES (SKELETON)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            "site-007": {
                meta: {
                    siteName: "Gloria Robinson Court Homes",
                    status: "SKELETON"
                },
                coverage: {
                    hours: "TBD"
                },
                postAssignments: {
                    unarmed: {
                        post: "TBD",
                        duties: []
                    }
                },
                escalation: ["Police", "VPS Supervisor"],
                specialInstructions: [
                    "âš ï¸ SOP DETAILS PENDING â€” Contact Operations Director"
                ]
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // MONTGOMERY HEIGHTS (VERIFIED)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            "site-008": {
                meta: {
                    siteName: "Montgomery Heights",
                    status: "VERIFIED"
                },
                coverage: {
                    hours: "24/7",
                    shifts: ["7Pâ€“3A primary"]
                },
                postAssignments: {
                    unarmed: {
                        post: "Lobby desk",
                        duties: ["Observe only"]
                    }
                },
                patrols: {
                    type: "Foot patrols"
                },
                escalation: ["Police", "VPS Supervisor"],
                specialInstructions: [
                    "Site contact: Ayesha Robinson (862) 658-0200"
                ]
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // PREFERRED FREEZER (SKELETON)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            "site-009": {
                meta: {
                    siteName: "Preferred Freezer",
                    status: "SKELETON"
                },
                coverage: {
                    hours: "Varies"
                },
                postAssignments: {
                    unarmed: {
                        post: "Exterior booth",
                        duties: ["Trailer checks", "Report malfunctions"]
                    }
                },
                commonIssues: ["Theft"],
                specialInstructions: [
                    "Notify monitoring company before patrol"
                ],
                escalation: ["Police", "VPS Supervisor"]
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // PARKING SPOT HAYNES (SKELETON)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            "site-012": {
                meta: {
                    siteName: "Parking Spot Haynes",
                    status: "SKELETON"
                },
                coverage: {
                    hours: "TBD"
                },
                postAssignments: {
                    unarmed: {
                        post: "Lot patrol",
                        duties: []
                    }
                },
                specialInstructions: [
                    "Non-residential location"
                ],
                escalation: ["Police", "VPS Supervisor"]
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // LINEAGE LOGISTICS (SKELETON)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            "site-1764741289556-fs5km7lbr": {
                meta: {
                    siteName: "Lineage Logistics â€“ Ave P",
                    status: "SKELETON"
                },
                coverage: {
                    hours: "TBD"
                },
                postAssignments: {
                    unarmed: {
                        post: "Warehouse exterior",
                        duties: []
                    }
                },
                commonIssues: ["Theft"],
                escalation: ["Police", "VPS Supervisor"]
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // PENNINGTON COURT (SKELETON)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            "site-1764741289559-hkqto87c2": {
                meta: {
                    siteName: "Pennington Court",
                    status: "SKELETON"
                },
                coverage: {
                    hours: "TBD"
                },
                postAssignments: {
                    unarmed: {
                        post: "Lobby desk",
                        duties: []
                    }
                },
                escalation: ["Police", "VPS Supervisor"]
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // HERITAGE AT ALEXANDER HAMILTON (SKELETON)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            "site-1764741289560-36zegp5n3": {
                meta: {
                    siteName: "Heritage at Alexander Hamilton",
                    status: "SKELETON"
                },
                coverage: {
                    hours: "TBD"
                },
                postAssignments: {
                    unarmed: {
                        post: "Lobby desk",
                        duties: []
                    }
                },
                escalation: ["Police", "VPS Supervisor"]
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // WGS-VP SECURITY OFFICE NJ
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            "site-1764741289560-dokbbg8wo": {
                meta: {
                    siteName: "WGS-VP Security Office NJ",
                    status: "VERIFIED"
                },
                coverage: {
                    hours: "Business hours"
                },
                postAssignments: {
                    unarmed: {
                        post: "Office reception",
                        duties: []
                    }
                },
                specialInstructions: [
                    "This is the company office â€” not a guard post",
                    "Administrative location only"
                ]
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // PENNROSE PATERSON (SKELETON)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            "site-1765836450829-xwop8n9ai": {
                meta: {
                    siteName: "Pennrose â€“ Paterson",
                    status: "SKELETON"
                },
                coverage: {
                    hours: "TBD"
                },
                postAssignments: {
                    unarmed: {
                        post: "Lobby desk",
                        duties: []
                    }
                },
                escalation: ["Police", "VPS Supervisor"]
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SOP MODULE â€” Supervisor Only (v6.11.0)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const SOPModule = {
            // Cache for SOPs (Firestore + localStorage)
            _cache: {},
            _cacheLoaded: false,
            STORAGE_KEY: 'sentinel_sops',

            // Initialize - load SOPs from localStorage, then Firestore
            async init() {
                // 1. Load from localStorage first
                this._loadFromLocalStorage();
                
                // 2. Then try Firestore (which takes priority)
                if (!window.FirestoreDB?.enabled) {
                    console.log('[SOP] Firestore not enabled, using local + hardcoded data');
                    return;
                }
                try {
                    const sops = await FirestoreDB.getAll('sops');
                    sops.forEach(sop => {
                        if (sop.siteId) {
                            this._cache[sop.siteId] = sop;
                        }
                    });
                    this._cacheLoaded = true;
                    console.log(`[SOP] Loaded ${sops.length} SOPs from Firestore`);
                } catch (error) {
                    console.error('[SOP] Failed to load from Firestore:', error);
                }
            },
            
            _loadFromLocalStorage: function() {
                try {
                    const stored = localStorage.getItem(this.STORAGE_KEY);
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        Object.keys(parsed).forEach(siteId => {
                            this._cache[siteId] = parsed[siteId];
                        });
                        console.log(`[SOP] Loaded ${Object.keys(parsed).length} SOPs from localStorage`);
                    }
                } catch (e) {
                    console.error('[SOP] Failed to load from localStorage:', e);
                }
            },
            
            _saveToLocalStorage: function() {
                try {
                    // Only save non-Firestore entries (local imports)
                    const toSave = {};
                    Object.keys(this._cache).forEach(siteId => {
                        if (this._cache[siteId]._source === 'import') {
                            toSave[siteId] = this._cache[siteId];
                        }
                    });
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(toSave));
                } catch (e) {
                    console.error('[SOP] Failed to save to localStorage:', e);
                }
            },

            // Get SOP - check cache first, then hardcoded
            // v6.19.4: Now normalizes on retrieval for universal format support
            getSOP: function(siteId) {
                let raw = null;
                
                // Cache (Firestore + localStorage) takes priority
                if (this._cache[siteId]) {
                    raw = this._cache[siteId];
                } else if (SOP_DATA[siteId]) {
                    // Fall back to hardcoded
                    raw = SOP_DATA[siteId];
                }
                
                if (!raw) return null;
                
                // Always normalize to ensure consistent format
                return SOPNormalizer.normalize(raw, siteId);
            },

            hasSOP: function(siteId) {
                return this._cache[siteId] || SOP_DATA.hasOwnProperty(siteId);
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // SOP IMPORT â€” Transform sop_master.json format to internal format
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            importFromJSON: function(jsonData) {
                const results = { imported: 0, skipped: 0, errors: [] };
                const sites = DataStore.getSites() || [];
                
                // Build lookup maps for site matching
                const siteByName = {};
                const siteById = {};
                sites.forEach(s => {
                    siteById[s.id] = s;
                    siteByName[this._slugify(s.name)] = s;
                });
                
                Object.keys(jsonData).forEach(key => {
                    const raw = jsonData[key];
                    if (!raw || typeof raw !== 'object') return;
                    
                    // Resolve site ID
                    let resolvedSiteId = null;
                    let resolvedSiteName = raw.siteName || key;
                    
                    // Try direct key match first
                    if (siteById[key]) {
                        resolvedSiteId = key;
                        resolvedSiteName = siteById[key].name;
                    } 
                    // Try matching by siteName
                    else if (raw.siteName) {
                        const slug = this._slugify(raw.siteName);
                        if (siteByName[slug]) {
                            resolvedSiteId = siteByName[slug].id;
                            resolvedSiteName = siteByName[slug].name;
                        }
                    }
                    
                    // If no match, use the key as-is (site might not exist yet)
                    if (!resolvedSiteId) {
                        resolvedSiteId = key;
                        console.warn(`[SOP Import] No matching site for "${key}" (${raw.siteName || 'unnamed'})`);
                    }
                    
                    // Transform to internal format using universal normalizer
                    const transformed = SOPNormalizer.normalize(raw, resolvedSiteId);
                    if (transformed) {
                        // Mark as imported and add source tracking
                        transformed._source = 'import';
                        transformed.meta.siteName = resolvedSiteName || transformed.meta.siteName;
                        
                        // Store in cache
                        this._cache[resolvedSiteId] = transformed;
                        results.imported++;
                    }
                });
                
                // Persist to localStorage
                this._saveToLocalStorage();
                
                console.log(`[SOP Import] Imported ${results.imported} SOPs`);
                return results;
            },
            
            _slugify: function(str) {
                return (str || '').toLowerCase().trim()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-|-$/g, '');
            },
            
            _transformToInternalFormat: function(raw, siteId, siteName) {
                const now = new Date().toISOString();
                
                // Build the internal SOP structure
                const sop = {
                    _source: 'import',
                    siteId: siteId,
                    updatedAt: now,
                    meta: {
                        siteName: siteName,
                        status: 'IMPORTED',
                        importedAt: now
                    }
                };
                
                // Coverage
                if (raw.coverage || raw.staffing) {
                    sop.coverage = {
                        hours: raw.coverage || 'As scheduled'
                    };
                    if (raw.staffing) {
                        // Convert staffing object to shifts array
                        const shifts = [];
                        Object.entries(raw.staffing).forEach(([time, staff]) => {
                            shifts.push({ time: time, staffing: staff });
                        });
                        if (shifts.length > 0) {
                            sop.coverage.shifts = shifts;
                        }
                    }
                }
                
                // Post Assignments - transform from {armed: "...", unarmed: "..."} to internal format
                if (raw.posts) {
                    sop.postAssignments = {};
                    
                    if (raw.posts.armed) {
                        sop.postAssignments.armed = {
                            post: 'Armed Post',
                            duties: [raw.posts.armed]
                        };
                    }
                    if (raw.posts.unarmed) {
                        sop.postAssignments.unarmed = {
                            post: 'Unarmed Post',
                            duties: [raw.posts.unarmed]
                        };
                    }
                    if (raw.posts.mixed) {
                        sop.postAssignments.unarmed = {
                            post: 'General Post',
                            duties: [raw.posts.mixed]
                        };
                    }
                }
                
                // Patrols
                if (raw.patrols) {
                    sop.patrols = {
                        frequency: raw.patrols
                    };
                }
                
                // Access Control
                if (raw.accessControl) {
                    if (typeof raw.accessControl === 'object') {
                        sop.accessControl = raw.accessControl;
                        if (raw.accessControl.afterHours) {
                            sop.afterHoursAccess = raw.accessControl.afterHours;
                        }
                    } else {
                        sop.accessControl = { notes: raw.accessControl };
                    }
                }
                
                // Special Instructions
                if (raw.specialInstructions && raw.specialInstructions.length > 0) {
                    sop.specialInstructions = raw.specialInstructions;
                }
                
                // Common Issues / Notes
                if (raw.notes && raw.notes.length > 0) {
                    sop.commonIssues = raw.notes;
                }
                
                // Use of Force
                if (raw.useOfForce) {
                    sop.useOfForce = raw.useOfForce;
                }
                
                // Escalation
                if (raw.escalation && raw.escalation.length > 0) {
                    sop.escalation = raw.escalation;
                }
                
                return sop;
            },
            
            // Get count of imported SOPs
            getImportedCount: function() {
                return Object.values(this._cache).filter(s => s._source === 'import').length;
            },
            
            // Clear imported SOPs
            clearImported: function() {
                Object.keys(this._cache).forEach(key => {
                    if (this._cache[key]._source === 'import') {
                        delete this._cache[key];
                    }
                });
                localStorage.removeItem(this.STORAGE_KEY);
                console.log('[SOP] Cleared imported SOPs');
            },

            // Save SOP to Firestore and update cache
            async saveSOP(siteId, sopData) {
                if (!window.FirestoreDB?.enabled) {
                    UI.notify('Firestore not enabled. Changes not saved to cloud.', 'warning');
                    return false;
                }
                try {
                    const dataToSave = {
                        ...sopData,
                        siteId: siteId,
                        updatedAt: new Date().toISOString()
                    };
                    await FirestoreDB.save('sops', siteId, dataToSave);
                    this._cache[siteId] = dataToSave;
                    console.log(`[SOP] Saved SOP for ${siteId}`);
                    return true;
                } catch (error) {
                    console.error('[SOP] Save failed:', error);
                    return false;
                }
            },

            // Open editor modal
            openEditor: function(siteId) {
                const site = DataStore.getSiteById(siteId);
                const sop = this.getSOP(siteId) || this._getEmptySOP(siteId, site?.name || siteId);
                
                const content = `
                    <form id="sop-editor-form" style="max-height: 70vh; overflow-y: auto;">
                        <input type="hidden" id="sop-site-id" value="${Utils.escapeHtml(siteId)}">
                        
                        <!-- META -->
                        <div class="form-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2); color: var(--color-primary);">ğŸ“‹ Site Info</h3>
                            <div class="form-group" style="margin-bottom: var(--space-3);">
                                <label class="form-label">Site Name</label>
                                <input type="text" class="form-control" id="sop-siteName" value="${Utils.escapeHtml(sop.meta?.siteName || '')}" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text);">
                            </div>
                            <div class="form-group" style="margin-bottom: var(--space-3);">
                                <label class="form-label">Approved By</label>
                                <input type="text" class="form-control" id="sop-approvedBy" value="${Utils.escapeHtml(sop.meta?.approvedBy || '')}" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text);">
                            </div>
                            <div class="form-group" style="margin-bottom: var(--space-3);">
                                <label class="form-label">Status</label>
                                <select id="sop-status" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text);">
                                    <option value="VERIFIED" ${sop.meta?.status === 'VERIFIED' ? 'selected' : ''}>VERIFIED</option>
                                    <option value="SKELETON" ${sop.meta?.status === 'SKELETON' ? 'selected' : ''}>SKELETON</option>
                                    <option value="DRAFT" ${sop.meta?.status === 'DRAFT' ? 'selected' : ''}>DRAFT</option>
                                </select>
                            </div>
                        </div>

                        <!-- COVERAGE -->
                        <div class="form-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2); color: var(--color-primary);">ğŸ“… Coverage</h3>
                            <div class="form-group" style="margin-bottom: var(--space-3);">
                                <label class="form-label">Hours</label>
                                <input type="text" class="form-control" id="sop-hours" value="${Utils.escapeHtml(sop.coverage?.hours || '')}" placeholder="e.g., 24/7, 7P-3A" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text);">
                            </div>
                            <div class="form-group" style="margin-bottom: var(--space-3);">
                                <label class="form-label">Staffing</label>
                                <input type="text" class="form-control" id="sop-staffing" value="${Utils.escapeHtml(sop.coverage?.staffing || '')}" placeholder="e.g., 1 unarmed per shift" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text);">
                            </div>
                            <div class="form-group" style="margin-bottom: var(--space-3);">
                                <label class="form-label">Shifts (one per line: time | staffing)</label>
                                <textarea id="sop-shifts" rows="3" placeholder="12A-8A | 2 unarmed&#10;8A-4P | 2 unarmed&#10;4P-12A | 1 armed, 1 unarmed" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text); font-family: inherit;">${this._shiftsToText(sop.coverage?.shifts)}</textarea>
                            </div>
                        </div>

                        <!-- POST ASSIGNMENTS -->
                        <div class="form-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2); color: var(--color-primary);">ğŸ“ Post Assignments</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                                <div>
                                    <label class="form-label">Armed Post</label>
                                    <input type="text" class="form-control" id="sop-armed-post" value="${Utils.escapeHtml(sop.postAssignments?.armed?.post || '')}" placeholder="e.g., Lobby desk" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text);">
                                </div>
                                <div>
                                    <label class="form-label">Unarmed Post</label>
                                    <input type="text" class="form-control" id="sop-unarmed-post" value="${Utils.escapeHtml(sop.postAssignments?.unarmed?.post || '')}" placeholder="e.g., Mobile patrol" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text);">
                                </div>
                            </div>
                            <div class="form-group" style="margin-top: var(--space-3);">
                                <label class="form-label">Armed Duties (one per line)</label>
                                <textarea id="sop-armed-duties" rows="2" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text); font-family: inherit;">${(sop.postAssignments?.armed?.duties || []).join('\n')}</textarea>
                            </div>
                            <div class="form-group" style="margin-top: var(--space-3);">
                                <label class="form-label">Armed Rules (one per line)</label>
                                <textarea id="sop-armed-rules" rows="2" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text); font-family: inherit;">${(sop.postAssignments?.armed?.rules || []).join('\n')}</textarea>
                            </div>
                            <div class="form-group" style="margin-top: var(--space-3);">
                                <label class="form-label">Unarmed Duties (one per line)</label>
                                <textarea id="sop-unarmed-duties" rows="2" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text); font-family: inherit;">${(sop.postAssignments?.unarmed?.duties || []).join('\n')}</textarea>
                            </div>
                        </div>

                        <!-- PATROLS -->
                        <div class="form-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2); color: var(--color-primary);">ğŸš¶ Patrols</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                                <div class="form-group">
                                    <label class="form-label">Frequency</label>
                                    <input type="text" class="form-control" id="sop-patrol-frequency" value="${Utils.escapeHtml(sop.patrols?.frequency || '')}" placeholder="e.g., Every 2 hours" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text);">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Type</label>
                                    <input type="text" class="form-control" id="sop-patrol-type" value="${Utils.escapeHtml(sop.patrols?.type || '')}" placeholder="e.g., Foot + elevator" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text);">
                                </div>
                            </div>
                        </div>

                        <!-- TOUR SYSTEM -->
                        <div class="form-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2); color: var(--color-primary);">ğŸ“± Tour System</h3>
                            <input type="text" class="form-control" id="sop-tour-system" value="${Utils.escapeHtml(sop.tourSystem || '')}" placeholder="e.g., TrackTik, Deggy Wand" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text);">
                        </div>

                        <!-- ACCESS CONTROL -->
                        <div class="form-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2); color: var(--color-primary);">ğŸ” Access Control</h3>
                            <div class="form-group" style="margin-bottom: var(--space-3);">
                                <label class="form-label">After Hours Access</label>
                                <input type="text" class="form-control" id="sop-after-hours" value="${Utils.escapeHtml(sop.afterHoursAccess || '')}" placeholder="e.g., Resident confirmation 2200-0600" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text);">
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                                    <input type="checkbox" id="sop-vehicle-based" ${sop.accessControl?.vehicleBased ? 'checked' : ''}>
                                    <span>Vehicle-based access control</span>
                                </label>
                            </div>
                        </div>

                        <!-- COMMON ISSUES -->
                        <div class="form-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2); color: var(--color-primary);">âš ï¸ Common Issues</h3>
                            <textarea id="sop-common-issues" rows="3" placeholder="One issue per line" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text); font-family: inherit;">${(sop.commonIssues || []).join('\n')}</textarea>
                        </div>

                        <!-- USE OF FORCE -->
                        <div class="form-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2); color: var(--color-primary);">ğŸ›¡ï¸ Use of Force</h3>
                            <input type="text" class="form-control" id="sop-use-of-force" value="${Utils.escapeHtml(sop.useOfForce || '')}" placeholder="e.g., Self-defense only" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text);">
                        </div>

                        <!-- ESCALATION -->
                        <div class="form-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2); color: var(--color-primary);">ğŸ“ Escalation Chain</h3>
                            <textarea id="sop-escalation" rows="3" placeholder="One contact per line (in order)" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text); font-family: inherit;">${(sop.escalation || []).join('\n')}</textarea>
                        </div>

                        <!-- CAMERAS -->
                        <div class="form-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2); color: var(--color-primary);">ğŸ“¹ Cameras</h3>
                            <input type="text" class="form-control" id="sop-cameras" value="${Utils.escapeHtml(sop.cameras || '')}" placeholder="e.g., Live monitored" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text);">
                        </div>

                        <!-- SPECIAL INSTRUCTIONS -->
                        <div class="form-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2); color: var(--color-primary);">ğŸ“Œ Special Instructions</h3>
                            <textarea id="sop-special-instructions" rows="4" placeholder="One instruction per line" style="width: 100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-text); font-family: inherit;">${(sop.specialInstructions || []).join('\n')}</textarea>
                        </div>
                    </form>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="SOPModule.saveFromEditor()">
                        ğŸ’¾ Save SOP
                    </button>
                `;

                UI.openModal(`Edit SOP: ${site?.name || siteId}`, content, footer, 'lg');
            },

            // Save from editor form
            async saveFromEditor() {
                const siteId = document.getElementById('sop-site-id').value;
                
                const sopData = {
                    meta: {
                        siteName: document.getElementById('sop-siteName').value.trim(),
                        approvedBy: document.getElementById('sop-approvedBy').value.trim(),
                        status: document.getElementById('sop-status').value
                    },
                    coverage: {
                        hours: document.getElementById('sop-hours').value.trim(),
                        staffing: document.getElementById('sop-staffing').value.trim(),
                        shifts: this._textToShifts(document.getElementById('sop-shifts').value)
                    },
                    postAssignments: {
                        armed: {
                            post: document.getElementById('sop-armed-post').value.trim(),
                            duties: this._textToArray(document.getElementById('sop-armed-duties').value),
                            rules: this._textToArray(document.getElementById('sop-armed-rules').value)
                        },
                        unarmed: {
                            post: document.getElementById('sop-unarmed-post').value.trim(),
                            duties: this._textToArray(document.getElementById('sop-unarmed-duties').value)
                        }
                    },
                    patrols: {
                        frequency: document.getElementById('sop-patrol-frequency').value.trim(),
                        type: document.getElementById('sop-patrol-type').value.trim()
                    },
                    tourSystem: document.getElementById('sop-tour-system').value.trim(),
                    afterHoursAccess: document.getElementById('sop-after-hours').value.trim(),
                    accessControl: {
                        vehicleBased: document.getElementById('sop-vehicle-based').checked
                    },
                    commonIssues: this._textToArray(document.getElementById('sop-common-issues').value),
                    useOfForce: document.getElementById('sop-use-of-force').value.trim(),
                    escalation: this._textToArray(document.getElementById('sop-escalation').value),
                    cameras: document.getElementById('sop-cameras').value.trim(),
                    specialInstructions: this._textToArray(document.getElementById('sop-special-instructions').value)
                };

                // Clean up empty values
                if (!sopData.postAssignments.armed.post) delete sopData.postAssignments.armed;
                if (!sopData.postAssignments.unarmed.post) delete sopData.postAssignments.unarmed;
                if (!sopData.coverage.shifts?.length) delete sopData.coverage.shifts;

                const success = await this.saveSOP(siteId, sopData);
                
                if (success) {
                    UI.notify('SOP saved successfully!', 'success');
                    UI.closeModal();
                    // Refresh the site view
                    SitesModule.viewSite(siteId);
                } else {
                    UI.notify('Failed to save SOP. Check console for details.', 'error');
                }
            },

            // Helper: Convert text lines to array
            _textToArray(text) {
                return (text || '').split('\n').map(s => s.trim()).filter(s => s);
            },

            // Helper: Convert shifts text to array
            _textToShifts(text) {
                const lines = this._textToArray(text);
                return lines.map(line => {
                    const parts = line.split('|').map(s => s.trim());
                    if (parts.length >= 2) {
                        return { time: parts[0], staffing: parts[1] };
                    }
                    return line; // Return as string if not formatted
                });
            },

            // Helper: Convert shifts array to text
            _shiftsToText(shifts) {
                if (!shifts?.length) return '';
                return shifts.map(s => {
                    if (typeof s === 'string') return s;
                    return `${s.time} | ${s.staffing}`;
                }).join('\n');
            },

            // Get empty SOP template
            _getEmptySOP(siteId, siteName) {
                return {
                    meta: {
                        siteName: siteName || siteId,
                        approvedBy: '',
                        status: 'DRAFT'
                    },
                    coverage: { hours: '', staffing: '', shifts: [] },
                    postAssignments: {},
                    patrols: {},
                    tourSystem: '',
                    afterHoursAccess: '',
                    accessControl: {},
                    commonIssues: [],
                    useOfForce: '',
                    escalation: [],
                    cameras: '',
                    specialInstructions: []
                };
            },

            renderSOP: function(siteId) {
                const sop = this.getSOP(siteId);

                if (!sop) {
                    return `
                        <div class="empty-state" style="padding: var(--space-6); text-align: center;">
                            <div style="font-size: 2.5rem; margin-bottom: var(--space-3);">ğŸ“‹</div>
                            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: var(--space-2);">No SOP on file</div>
                            <div class="text-sm text-muted">Site ID: ${Utils.escapeHtml(siteId)}</div>
                            <div class="text-sm text-muted" style="margin-top: var(--space-2);">Contact Operations Director to add SOP for this site.</div>
                            <button class="btn btn-primary" style="margin-top: var(--space-4);" onclick="SOPModule.openEditor('${Utils.escapeHtml(siteId)}')">
                                â• Create SOP
                            </button>
                        </div>
                    `;
                }

                return this._renderFullSOP(sop, siteId);
            },

            _renderFullSOP: function(sop, siteId) {
                const esc = (s) => Utils.escapeHtml(s || '');
                const isSkeleton = sop.meta?.status === 'SKELETON';
                const isDraft = sop.meta?.status === 'DRAFT';
                
                let html = `<div class="sop-document" style="padding: var(--space-2); max-height: 70vh; overflow-y: auto;">`;

                // HEADER with Edit button
                html += `
                    <div class="sop-header" style="border-bottom: 2px solid var(--color-primary); padding-bottom: var(--space-3); margin-bottom: var(--space-4);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: var(--space-2);">
                                <h2 style="margin: 0; color: var(--color-primary);">${esc(sop.meta?.siteName)}</h2>
                                ${isSkeleton ? '<span class="badge badge-warning">SKELETON</span>' : 
                                  isDraft ? '<span class="badge badge-neutral">DRAFT</span>' : 
                                  '<span class="badge badge-success">VERIFIED</span>'}
                            </div>
                            <button class="btn btn-sm btn-secondary" onclick="SOPModule.openEditor('${esc(siteId)}')" style="display: flex; align-items: center; gap: 4px;">
                                âœï¸ Edit
                            </button>
                        </div>
                        ${sop.meta?.approvedBy ? `<div class="text-sm text-muted" style="margin-top: var(--space-1);">Approved by: ${esc(sop.meta.approvedBy)}</div>` : ''}
                        ${sop.updatedAt ? `<div class="text-sm text-muted">Last updated: ${new Date(sop.updatedAt).toLocaleDateString()}</div>` : ''}
                    </div>
                `;

                // COVERAGE
                if (sop.coverage) {
                    html += `
                        <div class="sop-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2);">ğŸ“… Coverage</h3>
                            <div style="background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md);">
                                <div><strong>Hours:</strong> ${esc(sop.coverage.hours)}</div>
                                ${sop.coverage.staffing ? `<div><strong>Staffing:</strong> ${esc(sop.coverage.staffing)}</div>` : ''}
                                ${sop.coverage.shifts ? `
                                    <div style="margin-top: var(--space-2);">
                                        <strong>Shifts:</strong>
                                        <div style="display: flex; gap: var(--space-2); flex-wrap: wrap; margin-top: var(--space-1);">
                                            ${Array.isArray(sop.coverage.shifts) ? sop.coverage.shifts.map(s => {
                                                if (typeof s === 'string') {
                                                    return `<span class="badge badge-info">${esc(s)}</span>`;
                                                } else {
                                                    return `<span class="badge badge-info">${esc(s.time)} â€” ${esc(s.staffing)}</span>`;
                                                }
                                            }).join('') : ''}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }

                // POST ASSIGNMENTS
                if (sop.postAssignments) {
                    html += `
                        <div class="sop-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2);">ğŸ“ Post Assignments</h3>
                            <div style="background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md);">
                    `;

                    if (sop.postAssignments.armed) {
                        const armed = sop.postAssignments.armed;
                        html += `
                            <div style="margin-bottom: var(--space-3); padding-bottom: var(--space-3); border-bottom: 1px solid var(--color-border);">
                                <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-1);">
                                    <span class="badge badge-danger">Armed</span>
                                    <strong>${esc(armed.post)}</strong>
                                </div>
                                ${armed.duties?.length ? `
                                    <ul style="margin: var(--space-1) 0 0 var(--space-4); padding: 0;">
                                        ${armed.duties.map(d => `<li>${esc(d)}</li>`).join('')}
                                    </ul>
                                ` : ''}
                                ${armed.rules?.length ? `
                                    <div style="margin-top: var(--space-2); color: var(--color-warning);">
                                        <strong>Rules:</strong>
                                        <ul style="margin: var(--space-1) 0 0 var(--space-4); padding: 0;">
                                            ${armed.rules.map(r => `<li>${esc(r)}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }

                    if (sop.postAssignments.unarmed) {
                        const unarmed = sop.postAssignments.unarmed;
                        html += `
                            <div>
                                <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-1);">
                                    <span class="badge badge-info">Unarmed</span>
                                    <strong>${esc(unarmed.post)}</strong>
                                </div>
                                ${unarmed.duties?.length ? `
                                    <ul style="margin: var(--space-1) 0 0 var(--space-4); padding: 0;">
                                        ${unarmed.duties.map(d => `<li>${esc(d)}</li>`).join('')}
                                    </ul>
                                ` : ''}
                            </div>
                        `;
                    }

                    html += `</div></div>`;
                }

                // PATROLS
                if (sop.patrols && (sop.patrols.frequency || sop.patrols.type)) {
                    html += `
                        <div class="sop-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2);">ğŸš¶ Patrols</h3>
                            <div style="background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md);">
                                ${sop.patrols.frequency ? `<div><strong>Frequency:</strong> ${esc(sop.patrols.frequency)}</div>` : ''}
                                ${sop.patrols.type ? `<div><strong>Type:</strong> ${esc(sop.patrols.type)}</div>` : ''}
                            </div>
                        </div>
                    `;
                }

                // TOUR SYSTEM
                if (sop.tourSystem) {
                    html += `
                        <div class="sop-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2);">ğŸ“± Tour System</h3>
                            <div style="background: var(--color-info-bg, rgba(56,189,248,0.1)); padding: var(--space-3); border-radius: var(--radius-md); border-left: 3px solid var(--color-info);">
                                <strong>${esc(sop.tourSystem)}</strong>
                            </div>
                        </div>
                    `;
                }

                // ACCESS CONTROL / AFTER HOURS
                if (sop.accessControl?.vehicleBased || sop.afterHoursAccess) {
                    html += `
                        <div class="sop-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2);">ğŸ” Access Control</h3>
                            <div style="background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md);">
                                ${sop.accessControl?.vehicleBased ? '<div><strong>Vehicle-based access control</strong></div>' : ''}
                                ${sop.afterHoursAccess ? `<div><strong>After Hours:</strong> ${esc(sop.afterHoursAccess)}</div>` : ''}
                            </div>
                        </div>
                    `;
                }

                // COMMON ISSUES
                if (sop.commonIssues?.length) {
                    html += `
                        <div class="sop-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2);">âš ï¸ Common Issues</h3>
                            <div style="background: var(--color-warning-bg); padding: var(--space-3); border-radius: var(--radius-md); border-left: 3px solid var(--color-warning);">
                                <div style="display: flex; gap: var(--space-2); flex-wrap: wrap;">
                                    ${sop.commonIssues.map(i => `<span class="badge badge-warning">${esc(i)}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }

                // USE OF FORCE
                if (sop.useOfForce) {
                    html += `
                        <div class="sop-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2);">ğŸ›¡ï¸ Use of Force</h3>
                            <div style="background: rgba(239,68,68,0.1); padding: var(--space-3); border-radius: var(--radius-md); border-left: 3px solid var(--color-danger);">
                                <strong>${esc(sop.useOfForce)}</strong>
                            </div>
                        </div>
                    `;
                }

                // ESCALATION
                if (sop.escalation?.length) {
                    html += `
                        <div class="sop-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2);">ğŸ“ Escalation Chain</h3>
                            <div style="background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md);">
                                ${sop.escalation.map((e, i) => `
                                    <div style="display: flex; align-items: center; gap: var(--space-2); ${i > 0 ? 'margin-top: var(--space-2);' : ''}">
                                        <span class="badge badge-primary">${i + 1}</span>
                                        <strong>${esc(e)}</strong>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                // CAMERAS
                if (sop.cameras) {
                    html += `
                        <div class="sop-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2);">ğŸ“¹ Cameras</h3>
                            <div style="background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md);">
                                ${esc(sop.cameras)}
                            </div>
                        </div>
                    `;
                }

                // SPECIAL INSTRUCTIONS
                if (sop.specialInstructions?.length) {
                    html += `
                        <div class="sop-section" style="margin-bottom: var(--space-4);">
                            <h3 style="font-size: 1rem; margin-bottom: var(--space-2);">ğŸ“Œ Special Instructions</h3>
                            <div style="background: var(--color-info-bg, rgba(56,189,248,0.1)); padding: var(--space-3); border-radius: var(--radius-md); border-left: 3px solid var(--color-info);">
                                <ul style="margin: 0; padding-left: var(--space-4);">
                                    ${sop.specialInstructions.map(s => `<li style="margin-bottom: var(--space-1);">${esc(s)}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }

                html += `</div>`;
                return html;
            }
        };

        // Initialize SOPModule when app loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => SOPModule.init(), 1000);
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PROTOCOLS MODULE - Site SOPs, Checklists, Emergency Procedures
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const ProtocolsModule = {
            CATEGORIES: {
                emergency: { label: 'Emergency', icon: 'ğŸš¨', color: 'danger' },
                daily_ops: { label: 'Daily Operations', icon: 'ğŸ“‹', color: 'info' },
                safety: { label: 'Safety', icon: 'âš ï¸', color: 'warning' },
                access: { label: 'Access Control', icon: 'ğŸ”', color: 'success' },
                communication: { label: 'Communication', icon: 'ğŸ“', color: 'primary' },
                documentation: { label: 'Documentation', icon: 'ğŸ“', color: 'secondary' }
            },

            PRIORITIES: {
                critical: { label: 'Critical', color: 'danger' },
                high: { label: 'High', color: 'warning' },
                standard: { label: 'Standard', color: 'info' }
            },

            // Render protocols for a specific site (used in site detail view)
            renderForSite: function (siteId) {
                const protocols = DataStore.getProtocolsBySiteId(siteId);
                
                if (!protocols || protocols.length === 0) {
                    return `
                        <div class="empty-state" style="padding: var(--space-6); text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: var(--space-2);">ğŸ“‹</div>
                            <div class="text-muted">No protocols defined for this site</div>
                            <button class="btn btn-sm btn-primary" style="margin-top: var(--space-3);" onclick="ProtocolsModule.showAddForm('${siteId}')">
                                + Add Protocol
                            </button>
                        </div>
                    `;
                }

                // Group by category
                const grouped = {};
                protocols.forEach(p => {
                    const cat = p.category || 'daily_ops';
                    if (!grouped[cat]) grouped[cat] = [];
                    grouped[cat].push(p);
                });

                // Render category order: emergency first, then daily_ops, then rest
                const categoryOrder = ['emergency', 'daily_ops', 'safety', 'access', 'communication', 'documentation'];
                const sortedCategories = Object.keys(grouped).sort((a, b) => {
                    return categoryOrder.indexOf(a) - categoryOrder.indexOf(b);
                });

                let html = `
                    <div class="protocols-container">
                        <div class="flex justify-between items-center mb-4">
                            <div class="text-sm text-muted">${protocols.length} protocol${protocols.length !== 1 ? 's' : ''}</div>
                            <button class="btn btn-sm btn-secondary" onclick="ProtocolsModule.showAddForm('${siteId}')">+ Add Protocol</button>
                        </div>
                `;

                sortedCategories.forEach(catKey => {
                    const catInfo = this.CATEGORIES[catKey] || { label: catKey, icon: 'ğŸ“‹', color: 'info' };
                    const catProtocols = grouped[catKey];

                    html += `
                        <div class="protocol-category mb-4">
                            <div class="protocol-category-header" style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                <span style="font-size: 1.1rem;">${catInfo.icon}</span>
                                <span class="font-medium">${catInfo.label}</span>
                                <span class="badge badge-${catInfo.color}" style="font-size: 0.7rem;">${catProtocols.length}</span>
                            </div>
                    `;

                    catProtocols.forEach(protocol => {
                        const priorityInfo = this.PRIORITIES[protocol.priority] || this.PRIORITIES.standard;
                        html += this._renderProtocolCard(protocol, priorityInfo);
                    });

                    html += `</div>`;
                });

                html += `</div>`;
                return html;
            },

            _renderProtocolCard: function (protocol, priorityInfo) {
                const hasSteps = protocol.steps && protocol.steps.length > 0;
                
                return `
                    <div class="protocol-card" data-protocol-id="${protocol.id}" style="background: var(--color-surface-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-lg); margin-bottom: var(--space-2); overflow: hidden;">
                        <div class="protocol-header" onclick="ProtocolsModule.toggleProtocol('${protocol.id}')" style="padding: var(--space-3); cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: var(--space-2);">
                                <span class="protocol-expand-icon" style="color: var(--color-text-muted); transition: transform 0.2s;">â–¶</span>
                                <span class="font-medium">${Utils.escapeHtml(protocol.title)}</span>
                                ${protocol.priority === 'critical' ? `<span class="badge badge-danger" style="font-size: 0.65rem;">CRITICAL</span>` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation(); ProtocolsModule.editProtocol('${protocol.id}')" title="Edit">âœï¸</button>
                                <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation(); ProtocolsModule.deleteProtocol('${protocol.id}')" title="Delete" style="color: var(--color-danger);">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <div class="protocol-body" style="display: none; padding: 0 var(--space-3) var(--space-3); border-top: 1px solid var(--color-border);">
                            ${hasSteps ? this._renderSteps(protocol.steps) : '<div class="text-muted text-sm">No steps defined</div>'}
                            ${protocol.notes ? `
                                <div class="protocol-notes" style="margin-top: var(--space-3); padding: var(--space-2); background: var(--color-warning-bg); border-radius: var(--radius-md); font-size: var(--font-size-sm);">
                                    <strong>âš ï¸ Note:</strong> ${Utils.escapeHtml(protocol.notes)}
                                </div>
                            ` : ''}
                            ${protocol.effectiveDate ? `<div class="text-xs text-muted" style="margin-top: var(--space-2);">Effective: ${protocol.effectiveDate}</div>` : ''}
                        </div>
                    </div>
                `;
            },

            _renderSteps: function (steps) {
                return steps.map(phase => `
                    <div class="protocol-phase" style="margin-top: var(--space-3);">
                        <div class="font-medium text-sm" style="color: var(--color-primary); margin-bottom: var(--space-1);">${Utils.escapeHtml(phase.phase)}</div>
                        <ul style="margin: 0; padding-left: var(--space-4); list-style: disc;">
                            ${phase.items.map(item => `<li style="margin-bottom: var(--space-1); font-size: var(--font-size-sm);">${Utils.escapeHtml(item)}</li>`).join('')}
                        </ul>
                    </div>
                `).join('');
            },

            toggleProtocol: function (id) {
                const card = document.querySelector(`[data-protocol-id="${id}"]`);
                if (!card) return;
                
                const body = card.querySelector('.protocol-body');
                const icon = card.querySelector('.protocol-expand-icon');
                
                if (body.style.display === 'none') {
                    body.style.display = 'block';
                    icon.style.transform = 'rotate(90deg)';
                } else {
                    body.style.display = 'none';
                    icon.style.transform = 'rotate(0deg)';
                }
            },

            showAddForm: function (siteId) {
                const site = DataStore.getSiteById(siteId);
                const siteName = site?.name || 'Site';

                const categoryOptions = Object.entries(this.CATEGORIES)
                    .map(([key, val]) => `<option value="${key}">${val.icon} ${val.label}</option>`)
                    .join('');

                const priorityOptions = Object.entries(this.PRIORITIES)
                    .map(([key, val]) => `<option value="${key}">${val.label}</option>`)
                    .join('');

                const content = `
                    <form id="add-protocol-form">
                        <input type="hidden" id="protocol-site-id" value="${siteId}">
                        
                        <div class="form-group">
                            <label class="form-label">Protocol Title</label>
                            <input type="text" class="form-input" id="protocol-title" placeholder="e.g., Fire Emergency Response" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="protocol-category">${categoryOptions}</select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Priority</label>
                                <select class="form-select" id="protocol-priority">${priorityOptions}</select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Steps (one per line, use "---" to separate phases)</label>
                            <textarea class="form-textarea" id="protocol-steps" rows="8" placeholder="Phase 1 - Initial Response
- Step one
- Step two
---
Phase 2 - Follow-up
- Next step"></textarea>
                            <div class="text-xs text-muted mt-1">Format: Phase name on its own line, then steps starting with "-". Use "---" to start a new phase.</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Important Notes (optional)</label>
                            <textarea class="form-textarea" id="protocol-notes" rows="2" placeholder="Any critical warnings or additional information"></textarea>
                        </div>
                    </form>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="ProtocolsModule.saveNewProtocol()">Save Protocol</button>
                `;

                UI.openModal(`Add Protocol - ${siteName}`, content, footer, 'lg');
            },

            parseStepsText: function (text) {
                if (!text.trim()) return [];
                
                const phases = text.split('---').map(s => s.trim()).filter(s => s);
                const result = [];

                phases.forEach(phaseText => {
                    const lines = phaseText.split('\n').map(l => l.trim()).filter(l => l);
                    if (lines.length === 0) return;

                    let phaseName = 'Procedure';
                    let items = [];

                    lines.forEach(line => {
                        if (line.startsWith('-')) {
                            items.push(line.substring(1).trim());
                        } else if (items.length === 0) {
                            // First non-dash line is the phase name
                            phaseName = line;
                        } else {
                            // Additional non-dash line after items - treat as item
                            items.push(line);
                        }
                    });

                    if (items.length > 0) {
                        result.push({ phase: phaseName, items });
                    }
                });

                return result;
            },

            saveNewProtocol: function () {
                const siteId = document.getElementById('protocol-site-id').value;
                const title = document.getElementById('protocol-title').value.trim();
                const category = document.getElementById('protocol-category').value;
                const priority = document.getElementById('protocol-priority').value;
                const stepsText = document.getElementById('protocol-steps').value;
                const notes = document.getElementById('protocol-notes').value.trim();

                if (!title) {
                    UI.toast('Error', 'Protocol title is required', 'danger');
                    return;
                }

                const steps = this.parseStepsText(stepsText);

                const protocol = {
                    siteId,
                    title,
                    category,
                    priority,
                    steps,
                    notes: notes || null,
                    effectiveDate: new Date().toISOString().split('T')[0]
                };

                DataStore.addProtocol(protocol);
                UI.closeModal();
                
                // Refresh the site view
                SitesModule.viewSite(siteId);
                UI.toast('Protocol Added', `"${title}" has been saved.`, 'success');
            },

            editProtocol: function (id) {
                const protocol = DataStore.getProtocols().find(p => p.id === id);
                if (!protocol) return;

                const site = DataStore.getSiteById(protocol.siteId);
                const siteName = site?.name || 'Site';

                const categoryOptions = Object.entries(this.CATEGORIES)
                    .map(([key, val]) => `<option value="${key}" ${key === protocol.category ? 'selected' : ''}>${val.icon} ${val.label}</option>`)
                    .join('');

                const priorityOptions = Object.entries(this.PRIORITIES)
                    .map(([key, val]) => `<option value="${key}" ${key === protocol.priority ? 'selected' : ''}>${val.label}</option>`)
                    .join('');

                // Convert steps back to text format
                const stepsText = (protocol.steps || []).map(phase => {
                    return phase.phase + '\n' + phase.items.map(i => '- ' + i).join('\n');
                }).join('\n---\n');

                const content = `
                    <form id="edit-protocol-form">
                        <input type="hidden" id="edit-protocol-id" value="${protocol.id}">
                        <input type="hidden" id="edit-protocol-site-id" value="${protocol.siteId}">
                        
                        <div class="form-group">
                            <label class="form-label">Protocol Title</label>
                            <input type="text" class="form-input" id="edit-protocol-title" value="${Utils.escapeHtml(protocol.title)}" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="edit-protocol-category">${categoryOptions}</select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Priority</label>
                                <select class="form-select" id="edit-protocol-priority">${priorityOptions}</select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Steps</label>
                            <textarea class="form-textarea" id="edit-protocol-steps" rows="8">${Utils.escapeHtml(stepsText)}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Important Notes</label>
                            <textarea class="form-textarea" id="edit-protocol-notes" rows="2">${Utils.escapeHtml(protocol.notes || '')}</textarea>
                        </div>
                    </form>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="ProtocolsModule.saveEditedProtocol()">Save Changes</button>
                `;

                UI.openModal(`Edit Protocol - ${siteName}`, content, footer, 'lg');
            },

            saveEditedProtocol: function () {
                const id = document.getElementById('edit-protocol-id').value;
                const siteId = document.getElementById('edit-protocol-site-id').value;
                const title = document.getElementById('edit-protocol-title').value.trim();
                const category = document.getElementById('edit-protocol-category').value;
                const priority = document.getElementById('edit-protocol-priority').value;
                const stepsText = document.getElementById('edit-protocol-steps').value;
                const notes = document.getElementById('edit-protocol-notes').value.trim();

                if (!title) {
                    UI.toast('Error', 'Protocol title is required', 'danger');
                    return;
                }

                const steps = this.parseStepsText(stepsText);

                DataStore.updateProtocol(id, {
                    title,
                    category,
                    priority,
                    steps,
                    notes: notes || null
                });

                UI.closeModal();
                SitesModule.viewSite(siteId);
                UI.toast('Protocol Updated', `"${title}" has been saved.`, 'success');
            },

            deleteProtocol: function (id) {
                const protocol = DataStore.getProtocols().find(p => p.id === id);
                if (!protocol) return;

                const content = `
                    <p>Are you sure you want to delete the protocol "<strong>${Utils.escapeHtml(protocol.title)}</strong>"?</p>
                    <p class="text-muted text-sm">This action cannot be undone.</p>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                    <button class="btn" style="background: var(--color-danger); color: white;" onclick="ProtocolsModule.confirmDelete('${id}', '${protocol.siteId}')">Delete Protocol</button>
                `;

                UI.openModal('Delete Protocol', content, footer);
            },

            confirmDelete: function (id, siteId) {
                DataStore.deleteProtocol(id);
                UI.closeModal();
                SitesModule.viewSite(siteId);
                UI.toast('Protocol Deleted', 'The protocol has been removed.', 'success');
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONTACTS MODULE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const ContactsModule = {
            filters: { category: '', search: '' },

            ROLE_PRESETS: {
                internal: ['Dispatch', 'Supervisor', 'Field Supervisor', 'Manager', 'HR', 'Operations', 'Training', 'Admin', 'Scheduler', 'Payroll'],
                client: ['Property Manager', 'Site Manager', 'Facility Director', 'Security Director', 'Building Manager', 'POC', 'Executive', 'Regional Manager', 'Asset Manager'],
                vendor: ['Account Rep', 'Sales', 'Service Tech', 'Manager', 'Support', 'Driver', 'Installer'],
                emergency: ['Police - Precinct', 'Police - Detective', 'Fire Department', 'EMS', 'Hospital Security', 'Crisis Hotline', 'Poison Control'],
                government: ['Building Inspector', 'Code Enforcement', 'Licensing', 'City Official', 'Housing Authority', 'Health Department'],
                utility: ['Electric Company', 'Gas Company', 'Water Company', 'Elevator Service', 'HVAC Service', 'Plumber', 'Electrician', 'Locksmith'],
                legal: ['Attorney', 'Insurance Adjuster', 'Claims Rep', 'Risk Manager', 'Compliance Officer'],
                resident: ['Building President', 'HOA Board', 'Key Tenant', 'Superintendent', 'Doorman', 'Maintenance Staff']
            },

            CATEGORY_INFO: {
                internal: { label: 'Internal Staff', icon: 'ğŸ‘”', color: 'info' },
                client: { label: 'Client/Property', icon: 'ğŸ¢', color: 'success' },
                vendor: { label: 'Vendor/Contractor', icon: 'ğŸ”§', color: 'warning' },
                emergency: { label: 'Emergency Services', icon: 'ğŸš¨', color: 'danger' },
                government: { label: 'Government/Regulatory', icon: 'ğŸ›ï¸', color: 'secondary' },
                utility: { label: 'Utility/Maintenance', icon: 'âš¡', color: 'info' },
                legal: { label: 'Legal/Insurance', icon: 'âš–ï¸', color: 'secondary' },
                resident: { label: 'Resident/On-Site', icon: 'ğŸ ', color: 'success' }
            },

            init: function () {
                document.getElementById('contact-search')?.addEventListener('input', Utils.debounce((e) => {
                    this.filters.search = e.target.value.toLowerCase();
                    this.renderContacts();
                }, 200));

                document.getElementById('contact-filter-category')?.addEventListener('change', (e) => {
                    this.filters.category = e.target.value;
                    this.renderContacts();
                });

                document.getElementById('new-contact-btn')?.addEventListener('click', () => this.openNewContactModal());
            },

            render: function () {
                this.renderContacts();
            },

            renderContacts: function () {
                const contacts = DataStore.getContacts();
                const container = document.getElementById('contacts-container');
                const sites = DataStore.getSites();

                if (!container) return;

                // Apply filters
                let filtered = contacts.filter(c => {
                    if (this.filters.category && c.category !== this.filters.category) return false;
                    if (this.filters.search) {
                        const searchStr = `${c.name} ${c.company} ${c.role} ${c.phone} ${c.email}`.toLowerCase();
                        if (!searchStr.includes(this.filters.search)) return false;
                    }
                    return true;
                });

                if (filtered.length === 0) {
                    container.innerHTML = `
                    <div class="empty-state" style="padding: var(--space-12); text-align: center;">
                        <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="opacity: 0.3; margin-bottom: var(--space-4);">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        <p style="font-weight: var(--font-weight-medium); margin-bottom: var(--space-2);">No contacts found</p>
                        <p class="text-sm text-muted">${this.filters.search || this.filters.category ? 'Try adjusting your filters' : 'Add your first contact to get started'}</p>
                    </div>
                `;
                    return;
                }

                // Group by category
                const grouped = {
                    internal: filtered.filter(c => c.category === 'internal'),
                    client: filtered.filter(c => c.category === 'client'),
                    vendor: filtered.filter(c => c.category === 'vendor'),
                    emergency: filtered.filter(c => c.category === 'emergency'),
                    government: filtered.filter(c => c.category === 'government'),
                    utility: filtered.filter(c => c.category === 'utility'),
                    legal: filtered.filter(c => c.category === 'legal'),
                    resident: filtered.filter(c => c.category === 'resident')
                };

                const categoryLabels = {
                    internal: 'Internal Staff',
                    client: 'Client Contacts',
                    vendor: 'Vendors',
                    emergency: 'Emergency Services',
                    government: 'Government/Regulatory',
                    utility: 'Utility/Maintenance',
                    legal: 'Legal/Insurance',
                    resident: 'Resident/On-Site'
                };

                const categoryIcons = {
                    internal: 'ğŸ‘”',
                    client: 'ğŸ¢',
                    vendor: 'ğŸ”§',
                    emergency: 'ğŸš¨',
                    government: 'ğŸ›ï¸',
                    utility: 'âš¡',
                    legal: 'âš–ï¸',
                    resident: 'ğŸ '
                };

                let html = '';

                ['emergency', 'client', 'internal', 'vendor', 'utility', 'government', 'legal', 'resident'].forEach(cat => {
                    if (grouped[cat].length === 0) return;

                    html += `
                    <div style="margin-bottom: var(--space-6);">
                        <h3 style="font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-3); display: flex; align-items: center; gap: var(--space-2);">
                            <span>${categoryIcons[cat]}</span>
                            ${categoryLabels[cat]} 
                            <span style="font-weight: var(--font-weight-normal); opacity: 0.7;">(${grouped[cat].length})</span>
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: var(--space-3);">
                `;

                    grouped[cat].forEach(contact => {
                        const linkedSiteNames = (contact.linkedSites || [])
                            .map(sId => sites.find(s => s.id === sId)?.name)
                            .filter(Boolean);

                        html += `
                        <div class="card" style="padding: var(--space-4);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-3);">
                                <div style="display: flex; gap: var(--space-3); align-items: flex-start;">
                                    <div style="width: 40px; height: 40px; border-radius: var(--radius-full); background: var(--color-surface-elevated); display: flex; align-items: center; justify-content: center; font-weight: var(--font-weight-semibold); color: var(--color-text-muted); flex-shrink: 0;">
                                        ${contact.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()}
                                    </div>
                                    <div>
                                        <div style="font-weight: var(--font-weight-semibold);" class="sensitive">${Utils.escapeHtml(contact.name)}</div>
                                        <div class="text-sm text-muted">${Utils.escapeHtml(contact.role || '')}${contact.role && contact.company ? ' Â· ' : ''}${Utils.escapeHtml(contact.company || '')}</div>
                                    </div>
                                </div>
                                <div class="status-dot ${contact.status === 'active' ? 'active' : 'inactive'}" title="${contact.status}"></div>
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: var(--space-2); margin-bottom: var(--space-3);">
                                ${contact.phone ? `
                                    <a href="tel:${contact.phone}" class="sensitive" style="display: flex; align-items: center; gap: var(--space-2); color: var(--color-text-secondary); text-decoration: none; font-size: var(--font-size-sm);">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                        </svg>
                                        ${Utils.formatPhone(contact.phone)}
                                    </a>
                                ` : ''}
                                ${contact.email ? `
                                    <a href="mailto:${contact.email}" class="sensitive" style="display: flex; align-items: center; gap: var(--space-2); color: var(--color-text-secondary); text-decoration: none; font-size: var(--font-size-sm);">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                        </svg>
                                        ${Utils.escapeHtml(contact.email)}
                                    </a>
                                ` : ''}
                            </div>
                            
                            ${linkedSiteNames.length > 0 ? `
                                <div style="display: flex; align-items: flex-start; gap: var(--space-2); margin-bottom: var(--space-3);">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--color-text-muted); flex-shrink: 0; margin-top: 2px;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    </svg>
                                    <div class="text-sm text-muted">${linkedSiteNames.map(n => Utils.escapeHtml(n)).join(', ')}</div>
                                </div>
                            ` : ''}
                            
                            ${contact.notes ? `
                                <div class="text-sm text-muted" style="padding: var(--space-2); background: var(--color-surface-elevated); border-radius: var(--radius-sm); margin-bottom: var(--space-3);">
                                    ${Utils.escapeHtml(contact.notes)}
                                </div>
                            ` : ''}
                            
                            <div style="display: flex; gap: var(--space-2); border-top: 1px solid var(--color-border-subtle); padding-top: var(--space-3);">
                                <button class="btn btn-sm btn-ghost" onclick="ContactsModule.editContact('${contact.id}')">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                    Edit
                                </button>
                                <button class="btn btn-sm btn-ghost" onclick="ContactsModule.deleteContact('${contact.id}')" style="color: var(--color-danger);">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                    });

                    html += '</div></div>';
                });

                container.innerHTML = html;
            },

            openNewContactModal: function () {
                const sites = DataStore.getSites();

                const content = `
                <form id="new-contact-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Name *</label>
                            <input type="text" class="form-input" id="contact-name" required placeholder="Full name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Role/Title</label>
                            <input type="text" class="form-input" id="contact-role" placeholder="e.g., Dispatch, Property Manager, Technician" oninput="ContactsModule.autoDetectCategory(this.value)">
                            <div id="category-hint" class="text-xs text-muted" style="margin-top: 4px;"></div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="contact-category">
                                <option value="internal">ğŸ‘” Internal Staff</option>
                                <option value="client">ğŸ¢ Client/Property</option>
                                <option value="vendor">ğŸ”§ Vendor/Contractor</option>
                                <option value="emergency">ğŸš¨ Emergency Services</option>
                                <option value="utility">âš¡ Utility/Maintenance</option>
                                <option value="government">ğŸ›ï¸ Government/Regulatory</option>
                                <option value="legal">âš–ï¸ Legal/Insurance</option>
                                <option value="resident">ğŸ  Resident/On-Site</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Company</label>
                            <input type="text" class="form-input" id="contact-company" placeholder="Company name" oninput="ContactsModule.autoDetectCategory(document.getElementById('contact-role').value + ' ' + this.value)">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-input" id="contact-phone" placeholder="(973) 555-1234">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Alt Phone</label>
                            <input type="tel" class="form-input" id="contact-phone-alt" placeholder="Optional">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="contact-email" placeholder="email@example.com">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Linked Sites</label>
                        <div style="max-height: 120px; overflow-y: auto; background: var(--color-surface-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-2);">
                            ${sites.length > 0 ? sites.map(site => `
                                <label class="checkbox-label" style="padding: var(--space-1) var(--space-2);">
                                    <input type="checkbox" name="contact-sites" value="${site.id}">
                                    <span class="text-sm">${Utils.escapeHtml(site.name)}</span>
                                </label>
                            `).join('') : '<span class="text-sm text-muted">No sites available</span>'}
                        </div>
                        <span class="text-xs text-muted" style="margin-top: var(--space-1); display: block;">Select sites this contact is associated with</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="contact-notes" rows="2" placeholder="Contact preferences, availability, etc."></textarea>
                    </div>
                </form>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="ContactsModule.createContact()">Add Contact</button>
            `;

                UI.openModal('New Contact', content, footer, 'lg');
            },

            updateRoleOptions: function (selectId, category) {
                // Legacy function - kept for compatibility
            },
            
            autoDetectCategory: function (text) {
                if (!text) return;
                
                const lower = text.toLowerCase();
                const categorySelect = document.getElementById('contact-category');
                const hintEl = document.getElementById('category-hint');
                if (!categorySelect) return;
                
                const rolePresets = {
                    internal: ['dispatch', 'supervisor', 'manager', 'hr', 'operations', 'training', 'admin', 'coordinator', 'director', 'owner', 'ceo', 'coo', 'office', 'scheduler', 'payroll', 'accounting'],
                    client: ['property manager', 'site manager', 'facility director', 'security director', 'building manager', 'poc', 'executive', 'superintendent', 'super', 'resident manager', 'leasing', 'tenant liaison', 'hoa', 'board member', 'association'],
                    vendor: ['account rep', 'sales', 'service tech', 'technician', 'driver', 'supplier', 'contractor', 'rep', 'representative', 'installer', 'maintenance', 'repair'],
                    emergency: ['police', 'fire', 'ems', 'ambulance', 'hospital', '911', 'emergency', 'detective', 'officer', 'marshal', 'sheriff', 'paramedic', 'first responder'],
                    utility: ['electric', 'gas', 'water', 'elevator', 'hvac', 'plumber', 'plumbing', 'electrician', 'utility', 'power', 'cable', 'internet', 'telecom'],
                    government: ['inspector', 'code enforcement', 'city', 'county', 'state', 'federal', 'health department', 'fire marshal', 'osha', 'compliance', 'regulator'],
                    legal: ['attorney', 'lawyer', 'insurance', 'adjuster', 'claims', 'legal', 'counsel', 'risk management'],
                    resident: ['tenant', 'resident', 'concierge', 'doorman', 'front desk', 'building staff', 'porter', 'custodian', 'janitor']
                };
                
                const categoryLabels = {
                    internal: 'ğŸ‘” Internal Staff',
                    client: 'ğŸ¢ Client/Property',
                    vendor: 'ğŸ”§ Vendor/Contractor',
                    emergency: 'ğŸš¨ Emergency Services',
                    utility: 'âš¡ Utility/Maintenance',
                    government: 'ğŸ›ï¸ Government/Regulatory',
                    legal: 'âš–ï¸ Legal/Insurance',
                    resident: 'ğŸ  Resident/On-Site'
                };
                
                let detectedCategory = null;
                let matchedKeyword = null;
                
                for (const [cat, keywords] of Object.entries(rolePresets)) {
                    for (const kw of keywords) {
                        if (lower.includes(kw)) {
                            detectedCategory = cat;
                            matchedKeyword = kw;
                            break;
                        }
                    }
                    if (detectedCategory) break;
                }
                
                if (detectedCategory) {
                    categorySelect.value = detectedCategory;
                    if (hintEl) {
                        hintEl.innerHTML = `<span style="color: var(--color-success);">âœ“ Auto-detected: ${categoryLabels[detectedCategory]}</span>`;
                    }
                } else if (hintEl && text.length > 2) {
                    hintEl.innerHTML = `<span style="color: var(--color-text-muted);">Category: Select manually or keep typing</span>`;
                } else if (hintEl) {
                    hintEl.innerHTML = '';
                }
            },
            
            autoDetectCategoryEdit: function (text) {
                if (!text) return;
                
                const lower = text.toLowerCase();
                const categorySelect = document.getElementById('edit-contact-category');
                const hintEl = document.getElementById('edit-category-hint');
                if (!categorySelect) return;
                
                const rolePresets = {
                    internal: ['dispatch', 'supervisor', 'manager', 'hr', 'operations', 'training', 'admin', 'coordinator', 'director', 'owner', 'ceo', 'coo', 'office', 'scheduler', 'payroll', 'accounting'],
                    client: ['property manager', 'site manager', 'facility director', 'security director', 'building manager', 'poc', 'executive', 'superintendent', 'super', 'resident manager', 'leasing', 'tenant liaison', 'hoa', 'board member', 'association'],
                    vendor: ['account rep', 'sales', 'service tech', 'technician', 'driver', 'supplier', 'contractor', 'rep', 'representative', 'installer', 'maintenance', 'repair'],
                    emergency: ['police', 'fire', 'ems', 'ambulance', 'hospital', '911', 'emergency', 'detective', 'officer', 'marshal', 'sheriff', 'paramedic', 'first responder'],
                    utility: ['electric', 'gas', 'water', 'elevator', 'hvac', 'plumber', 'plumbing', 'electrician', 'utility', 'power', 'cable', 'internet', 'telecom'],
                    government: ['inspector', 'code enforcement', 'city', 'county', 'state', 'federal', 'health department', 'fire marshal', 'osha', 'compliance', 'regulator'],
                    legal: ['attorney', 'lawyer', 'insurance', 'adjuster', 'claims', 'legal', 'counsel', 'risk management'],
                    resident: ['tenant', 'resident', 'concierge', 'doorman', 'front desk', 'building staff', 'porter', 'custodian', 'janitor']
                };
                
                const categoryLabels = {
                    internal: 'ğŸ‘” Internal Staff',
                    client: 'ğŸ¢ Client/Property',
                    vendor: 'ğŸ”§ Vendor/Contractor',
                    emergency: 'ğŸš¨ Emergency Services',
                    utility: 'âš¡ Utility/Maintenance',
                    government: 'ğŸ›ï¸ Government/Regulatory',
                    legal: 'âš–ï¸ Legal/Insurance',
                    resident: 'ğŸ  Resident/On-Site'
                };
                
                let detectedCategory = null;
                
                for (const [cat, keywords] of Object.entries(rolePresets)) {
                    for (const kw of keywords) {
                        if (lower.includes(kw)) {
                            detectedCategory = cat;
                            break;
                        }
                    }
                    if (detectedCategory) break;
                }
                
                if (detectedCategory) {
                    categorySelect.value = detectedCategory;
                    if (hintEl) {
                        hintEl.innerHTML = `<span style="color: var(--color-success);">âœ“ ${categoryLabels[detectedCategory]}</span>`;
                    }
                } else if (hintEl) {
                    hintEl.innerHTML = '';
                }
            },

            createContact: function () {
                const name = document.getElementById('contact-name').value.trim();
                const category = document.getElementById('contact-category').value || 'internal';

                if (!name) {
                    UI.toast('Error', 'Name is required.', 'error');
                    return;
                }

                const linkedSites = Array.from(document.querySelectorAll('input[name="contact-sites"]:checked'))
                    .map(cb => cb.value);

                const contact = {
                    id: Utils.generateId('contact-'),
                    name: name,
                    category: category,
                    role: document.getElementById('contact-role').value.trim(),
                    company: document.getElementById('contact-company').value.trim(),
                    phone: Utils.formatPhone(document.getElementById('contact-phone').value.trim()),
                    phoneAlt: Utils.formatPhone(document.getElementById('contact-phone-alt').value.trim()),
                    email: document.getElementById('contact-email').value.trim(),
                    linkedSites: linkedSites,
                    notes: document.getElementById('contact-notes').value.trim(),
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                const categoryLabels = {
                    internal: 'ğŸ‘” Internal', client: 'ğŸ¢ Client', vendor: 'ğŸ”§ Vendor',
                    emergency: 'ğŸš¨ Emergency', utility: 'âš¡ Utility', government: 'ğŸ›ï¸ Government',
                    legal: 'âš–ï¸ Legal', resident: 'ğŸ  Resident'
                };

                DataStore.addContact(contact);
                UI.closeModal();
                this.render();
                UI.toast('Contact Added', `${name} added as ${categoryLabels[category] || category}`, 'success');
            },

            editContact: function (id) {
                const contact = DataStore.getContactById(id);
                if (!contact) return;

                const sites = DataStore.getSites();

                const content = `
                <form id="edit-contact-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Name *</label>
                            <input type="text" class="form-input" id="edit-contact-name" value="${Utils.escapeHtml(contact.name)}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Role/Title</label>
                            <input type="text" class="form-input" id="edit-contact-role" value="${Utils.escapeHtml(contact.role || '')}" placeholder="e.g., Dispatch, Property Manager" oninput="ContactsModule.autoDetectCategoryEdit(this.value)">
                            <div id="edit-category-hint" class="text-xs text-muted" style="margin-top: 4px;"></div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="edit-contact-category">
                                <option value="internal" ${contact.category === 'internal' ? 'selected' : ''}>ğŸ‘” Internal Staff</option>
                                <option value="client" ${contact.category === 'client' ? 'selected' : ''}>ğŸ¢ Client/Property</option>
                                <option value="vendor" ${contact.category === 'vendor' ? 'selected' : ''}>ğŸ”§ Vendor/Contractor</option>
                                <option value="emergency" ${contact.category === 'emergency' ? 'selected' : ''}>ğŸš¨ Emergency Services</option>
                                <option value="utility" ${contact.category === 'utility' ? 'selected' : ''}>âš¡ Utility/Maintenance</option>
                                <option value="government" ${contact.category === 'government' ? 'selected' : ''}>ğŸ›ï¸ Government/Regulatory</option>
                                <option value="legal" ${contact.category === 'legal' ? 'selected' : ''}>âš–ï¸ Legal/Insurance</option>
                                <option value="resident" ${contact.category === 'resident' ? 'selected' : ''}>ğŸ  Resident/On-Site</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Company</label>
                            <input type="text" class="form-input" id="edit-contact-company" value="${Utils.escapeHtml(contact.company || '')}">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-input" id="edit-contact-phone" value="${Utils.escapeHtml(contact.phone || '')}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Alt Phone</label>
                            <input type="tel" class="form-input" id="edit-contact-phone-alt" value="${Utils.escapeHtml(contact.phoneAlt || '')}">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="edit-contact-email" value="${Utils.escapeHtml(contact.email || '')}">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Linked Sites</label>
                        <div style="max-height: 120px; overflow-y: auto; background: var(--color-surface-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-2);">
                            ${sites.length > 0 ? sites.map(site => `
                                <label class="checkbox-label" style="padding: var(--space-1) var(--space-2);">
                                    <input type="checkbox" name="edit-contact-sites" value="${site.id}" ${(contact.linkedSites || []).includes(site.id) ? 'checked' : ''}>
                                    <span class="text-sm">${Utils.escapeHtml(site.name)}</span>
                                </label>
                            `).join('') : '<span class="text-sm text-muted">No sites available</span>'}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="edit-contact-notes" rows="2">${Utils.escapeHtml(contact.notes || '')}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="edit-contact-status">
                            <option value="active" ${contact.status === 'active' ? 'selected' : ''}>Active</option>
                            <option value="inactive" ${contact.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                        </select>
                    </div>
                </form>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="ContactsModule.saveContact('${id}')">Save Changes</button>
            `;

                UI.openModal('Edit Contact', content, footer, 'lg');
            },

            saveContact: function (id) {
                const name = document.getElementById('edit-contact-name').value.trim();
                const category = document.getElementById('edit-contact-category').value || 'internal';

                if (!name) {
                    UI.toast('Error', 'Name is required.', 'error');
                    return;
                }

                const linkedSites = Array.from(document.querySelectorAll('input[name="edit-contact-sites"]:checked'))
                    .map(cb => cb.value);

                const updates = {
                    name: name,
                    category: category,
                    role: document.getElementById('edit-contact-role').value.trim(),
                    company: document.getElementById('edit-contact-company').value.trim(),
                    phone: Utils.formatPhone(document.getElementById('edit-contact-phone').value.trim()),
                    phoneAlt: Utils.formatPhone(document.getElementById('edit-contact-phone-alt').value.trim()),
                    email: document.getElementById('edit-contact-email').value.trim(),
                    linkedSites: linkedSites,
                    notes: document.getElementById('edit-contact-notes').value.trim(),
                    status: document.getElementById('edit-contact-status').value
                };

                DataStore.updateContact(id, updates);
                UI.closeModal();
                this.render();
                UI.toast('Contact Updated', `${name} has been updated.`, 'success');
            },

            deleteContact: function (id) {
                const contact = DataStore.getContactById(id);
                if (!contact) return;

                if (!confirm(`Are you sure you want to delete ${contact.name}? This cannot be undone.`)) {
                    return;
                }

                DataStore.deleteContact(id);
                this.render();
                UI.toast('Contact Deleted', `${contact.name} has been removed.`, 'success');
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DOCUMENTS MODULE â€” Document Vault
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const DocumentsModule = {
            filters: { category: '', site: '', status: '', search: '' },

            // Category configuration - Enhanced for SOP Library
            CATEGORIES: {
                post_orders: { label: 'Post Orders', icon: 'ğŸ“‹', color: 'danger', isSOP: true },
                sop: { label: 'SOP', icon: 'ğŸ“–', color: 'warning', isSOP: true },
                memo: { label: 'Memo / Notice', icon: 'ğŸ“', color: 'info', isSOP: true },
                emergency: { label: 'Emergency Proc.', icon: 'ğŸš¨', color: 'danger', isSOP: true },
                training: { label: 'Training Material', icon: 'ğŸ“š', color: 'success', isSOP: true },
                rollout: { label: 'Rollout Notice', icon: 'ğŸ“¢', color: 'warning', isSOP: true },
                contract: { label: 'Contract', icon: 'ğŸ“„', color: 'info', isSOP: false },
                insurance: { label: 'Insurance Cert', icon: 'ğŸ›¡ï¸', color: 'success', isSOP: false },
                license: { label: 'License', icon: 'ğŸ“œ', color: 'warning', isSOP: false },
                site_map: { label: 'Site Map', icon: 'ğŸ—ºï¸', color: 'info', isSOP: false },
                other: { label: 'Other', icon: 'ğŸ“', color: 'secondary', isSOP: false }
            },

            init: function () {
                // Search
                document.getElementById('doc-search')?.addEventListener('input', Utils.debounce((e) => {
                    this.filters.search = e.target.value.toLowerCase();
                    this.renderTable();
                }, 200));

                // Category filter
                document.getElementById('doc-filter-category')?.addEventListener('change', (e) => {
                    this.filters.category = e.target.value;
                    this.renderTable();
                });

                // Site filter
                document.getElementById('doc-filter-site')?.addEventListener('change', (e) => {
                    this.filters.site = e.target.value;
                    this.renderTable();
                });

                // Status filter
                document.getElementById('doc-filter-status')?.addEventListener('change', (e) => {
                    this.filters.status = e.target.value;
                    this.renderTable();
                });

                // New document button
                document.getElementById('new-document-btn')?.addEventListener('click', () => this.openNewModal());

                // Populate site filter
                this.populateSiteFilter();
            },

            populateSiteFilter: function () {
                const select = document.getElementById('doc-filter-site');
                if (!select) return;

                const sites = DataStore.getSites();
                select.innerHTML = `
                    <option value="">All Sites</option>
                    <option value="company-wide">Company-Wide</option>
                    ${sites.map(s => `<option value="${s.id}">${Utils.escapeHtml(s.name)}</option>`).join('')}
                `;
            },

            render: function () {
                this.populateSiteFilter();
                this.renderStats();
                this.renderExpiringAlert();
                this.renderTable();
            },

            renderStats: function () {
                const container = document.getElementById('doc-stats');
                if (!container) return;

                const documents = DataStore.getDocuments();
                const sopCategories = ['post_orders', 'sop', 'memo', 'emergency', 'training', 'rollout'];
                
                const sops = documents.filter(d => sopCategories.includes(d.category)).length;
                const compliance = documents.filter(d => !sopCategories.includes(d.category)).length;
                const expired = DataStore.getExpiredDocuments().length;
                const expiring = DataStore.getExpiringDocuments(30).length;

                container.innerHTML = `
                    <div class="kpi-card" style="cursor: pointer;" onclick="DocumentsModule.filterByType('sop')">
                        <div class="kpi-header">
                            <span class="kpi-label">SOPs & Procedures</span>
                            <div class="kpi-icon warning">ğŸ“‹</div>
                        </div>
                        <div class="kpi-value">${sops}</div>
                    </div>
                    <div class="kpi-card" style="cursor: pointer;" onclick="DocumentsModule.filterByType('compliance')">
                        <div class="kpi-header">
                            <span class="kpi-label">Compliance Docs</span>
                            <div class="kpi-icon info">ğŸ“„</div>
                        </div>
                        <div class="kpi-value">${compliance}</div>
                    </div>
                    <div class="kpi-card" style="cursor: pointer;" onclick="document.getElementById('doc-filter-status').value='expired'; DocumentsModule.filters.status='expired'; DocumentsModule.renderTable();">
                        <div class="kpi-header">
                            <span class="kpi-label">Expired</span>
                            <div class="kpi-icon danger">âš ï¸</div>
                        </div>
                        <div class="kpi-value" style="color: ${expired > 0 ? 'var(--color-danger)' : 'inherit'};">${expired}</div>
                    </div>
                    <div class="kpi-card" style="cursor: pointer;" onclick="document.getElementById('doc-filter-status').value='expiring'; DocumentsModule.filters.status='expiring'; DocumentsModule.renderTable();">
                        <div class="kpi-header">
                            <span class="kpi-label">Expiring Soon</span>
                            <div class="kpi-icon warning">ğŸ“…</div>
                        </div>
                        <div class="kpi-value" style="color: ${expiring > 0 ? 'var(--color-warning)' : 'inherit'};">${expiring}</div>
                    </div>
                `;
            },

            filterByType: function (type) {
                const sopCategories = ['post_orders', 'sop', 'memo', 'emergency', 'training', 'rollout'];
                // Clear category filter and use custom filtering
                this.filters.category = '';
                this.filters.docType = type;
                document.getElementById('doc-filter-category').value = '';
                this.renderTable();
            },

            renderExpiringAlert: function () {
                const container = document.getElementById('doc-expiring-alert');
                if (!container) return;

                const expired = DataStore.getExpiredDocuments();
                const expiring = DataStore.getExpiringDocuments(30);

                if (expired.length === 0 && expiring.length === 0) {
                    container.style.display = 'none';
                    return;
                }

                container.style.display = 'block';
                container.innerHTML = `
                    <div style="background: var(--color-${expired.length > 0 ? 'danger' : 'warning'}-bg); 
                                border: 1px solid var(--color-${expired.length > 0 ? 'danger' : 'warning'}); 
                                border-radius: var(--radius-lg); 
                                padding: var(--space-4); 
                                margin-bottom: var(--space-4);
                                display: flex;
                                align-items: center;
                                justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: var(--space-3);">
                            <span style="font-size: 1.5rem;">${expired.length > 0 ? 'âš ï¸' : 'ğŸ“…'}</span>
                            <div>
                                <div style="font-weight: var(--font-weight-semibold); color: var(--color-${expired.length > 0 ? 'danger' : 'warning'});">
                                    ${expired.length > 0 ? `${expired.length} Expired Document${expired.length > 1 ? 's' : ''}` : ''}
                                    ${expired.length > 0 && expiring.length > 0 ? ' â€¢ ' : ''}
                                    ${expiring.length > 0 ? `${expiring.length} Expiring Soon` : ''}
                                </div>
                                <div class="text-sm text-muted">
                                    ${expired.slice(0, 2).map(d => d.name).join(', ')}${expired.length > 2 ? ` +${expired.length - 2} more` : ''}
                                    ${expiring.length > 0 && expired.length === 0 ? expiring.slice(0, 2).map(d => d.name).join(', ') : ''}
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-${expired.length > 0 ? 'danger' : 'warning'}" 
                                onclick="DocumentsModule.filters.status = '${expired.length > 0 ? 'expired' : 'expiring'}'; document.getElementById('doc-filter-status').value = '${expired.length > 0 ? 'expired' : 'expiring'}'; DocumentsModule.renderTable();">
                            View
                        </button>
                    </div>
                `;
            },

            getDocumentStatus: function (doc) {
                if (!doc.expirationDate) return { status: 'active', label: 'Active', class: 'success' };
                
                const now = new Date();
                const expDate = new Date(doc.expirationDate);
                const daysUntil = Math.ceil((expDate - now) / (1000 * 60 * 60 * 24));

                if (daysUntil < 0) {
                    return { status: 'expired', label: 'Expired', class: 'danger', days: Math.abs(daysUntil) };
                } else if (daysUntil <= 30) {
                    return { status: 'expiring', label: `${daysUntil}d`, class: 'warning', days: daysUntil };
                } else if (daysUntil <= 90) {
                    return { status: 'active', label: `${daysUntil}d`, class: 'info', days: daysUntil };
                } else {
                    return { status: 'active', label: 'Active', class: 'success', days: daysUntil };
                }
            },

            renderTable: function () {
                const tbody = document.getElementById('documents-tbody');
                if (!tbody) return;

                let documents = DataStore.getDocuments();
                const sites = DataStore.getSites();
                const sopCategories = ['post_orders', 'sop', 'memo', 'emergency', 'training', 'rollout'];

                // Apply filters
                if (this.filters.category) {
                    documents = documents.filter(d => d.category === this.filters.category);
                }
                // Doc type filter (SOP vs Compliance)
                if (this.filters.docType === 'sop') {
                    documents = documents.filter(d => sopCategories.includes(d.category));
                } else if (this.filters.docType === 'compliance') {
                    documents = documents.filter(d => !sopCategories.includes(d.category));
                }
                if (this.filters.site) {
                    documents = documents.filter(d => d.siteId === this.filters.site);
                }
                if (this.filters.status) {
                    documents = documents.filter(d => {
                        const status = this.getDocumentStatus(d);
                        return status.status === this.filters.status;
                    });
                }
                if (this.filters.search) {
                    documents = documents.filter(d =>
                        d.name.toLowerCase().includes(this.filters.search) ||
                        (d.notes && d.notes.toLowerCase().includes(this.filters.search)) ||
                        (d.version && d.version.toLowerCase().includes(this.filters.search))
                    );
                }

                // Sort: expired first, then by expiration date, then by name
                documents.sort((a, b) => {
                    const statusA = this.getDocumentStatus(a);
                    const statusB = this.getDocumentStatus(b);
                    
                    // Expired first
                    if (statusA.status === 'expired' && statusB.status !== 'expired') return -1;
                    if (statusB.status === 'expired' && statusA.status !== 'expired') return 1;
                    
                    // Then expiring
                    if (statusA.status === 'expiring' && statusB.status !== 'expiring') return -1;
                    if (statusB.status === 'expiring' && statusA.status !== 'expiring') return 1;
                    
                    // Then by date
                    if (a.expirationDate && b.expirationDate) {
                        return new Date(a.expirationDate) - new Date(b.expirationDate);
                    }
                    
                    return a.name.localeCompare(b.name);
                });

                if (documents.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state" style="text-align: center; padding: var(--space-8);">
                                <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto var(--space-4); opacity: 0.5;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <p class="text-muted">No documents found</p>
                                <button class="btn btn-primary mt-4" onclick="DocumentsModule.openNewModal()">Add First Document</button>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = documents.map(doc => {
                    const category = this.CATEGORIES[doc.category] || this.CATEGORIES.other;
                    const site = doc.siteId === 'company-wide' 
                        ? { name: 'Company-Wide' }
                        : sites.find(s => s.id === doc.siteId);
                    const status = this.getDocumentStatus(doc);
                    const isSOP = sopCategories.includes(doc.category);
                    
                    const effectiveDisplay = doc.effectiveDate 
                        ? new Date(doc.effectiveDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                        : 'â€”';
                    
                    const versionCount = (doc.versionHistory || []).length;

                    return `
                        <tr class="${status.status === 'expired' ? 'expired-row' : ''}" style="${status.status === 'expired' ? 'opacity: 0.7;' : ''}">
                            <td data-label="Document">
                                <div style="display: flex; align-items: center; gap: var(--space-3);">
                                    <div class="doc-icon ${doc.category}" style="width: 36px; height: 36px; font-size: 1.1rem;">
                                        ${category.icon}
                                    </div>
                                    <div>
                                        <div style="font-weight: var(--font-weight-medium);">
                                            ${doc.url ? `<a href="${Utils.escapeHtml(doc.url)}" target="_blank" rel="noopener">${Utils.escapeHtml(doc.name)}</a>` : Utils.escapeHtml(doc.name)}
                                        </div>
                                        ${doc.notes ? `<div class="text-xs text-muted">${Utils.escapeHtml(doc.notes.substring(0, 50))}${doc.notes.length > 50 ? '...' : ''}</div>` : ''}
                                    </div>
                                </div>
                            </td>
                            <td data-label="Category">
                                <span class="doc-category-badge">${category.icon} ${category.label}</span>
                                ${isSOP ? '<span class="sop-tag" style="margin-left: 4px;">SOP</span>' : ''}
                            </td>
                            <td data-label="Site">
                                ${site ? Utils.escapeHtml(site.name) : '<span class="text-muted">â€”</span>'}
                            </td>
                            <td data-label="Version">
                                <span class="font-medium">${doc.version || 'v1'}</span>
                                ${versionCount > 0 ? `<button class="btn btn-sm btn-ghost" onclick="DocumentsModule.viewVersionHistory('${doc.id}')" title="View history" style="margin-left: 4px; padding: 2px 4px;">
                                    <span class="text-xs text-muted">(${versionCount + 1})</span>
                                </button>` : ''}
                            </td>
                            <td data-label="Effective">
                                ${effectiveDisplay}
                            </td>
                            <td data-label="Status">
                                <span class="badge badge-${status.class}">${status.status === 'expired' ? 'Expired' : status.status === 'expiring' ? 'Expiring' : 'Active'}</span>
                            </td>
                            <td data-label="Actions">
                                <div style="display: flex; gap: var(--space-1);">
                                    ${doc.url ? `
                                        <a href="${Utils.escapeHtml(doc.url)}" target="_blank" rel="noopener" class="btn btn-sm btn-ghost" title="Open">
                                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                            </svg>
                                        </a>
                                    ` : ''}
                                    ${isSOP ? `
                                        <button class="btn btn-sm btn-ghost" onclick="DocumentsModule.createNewVersion('${doc.id}')" title="Create New Version">
                                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                            </svg>
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-sm btn-ghost" onclick="DocumentsModule.openEditModal('${doc.id}')" title="Edit">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                    </button>
                                    <button class="btn btn-sm btn-ghost" onclick="DocumentsModule.deleteDocument('${doc.id}')" title="Delete" style="color: var(--color-danger);">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            openNewModal: function () {
                const sites = DataStore.getSites();

                const content = `
                    <form id="new-document-form">
                        <div class="form-group">
                            <label class="form-label">Document Name *</label>
                            <input type="text" class="form-input" id="doc-name" placeholder="e.g., Zion Towers Insurance Certificate 2025" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Category *</label>
                                <select class="form-select" id="doc-category" required>
                                    <option value="">Select category...</option>
                                    ${Object.entries(this.CATEGORIES).map(([key, cat]) => `
                                        <option value="${key}">${cat.icon} ${cat.label}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Site</label>
                                <select class="form-select" id="doc-site">
                                    <option value="company-wide">Company-Wide</option>
                                    ${sites.map(s => `<option value="${s.id}">${Utils.escapeHtml(s.name)}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">URL / Link (Google Drive, Dropbox, etc.)</label>
                            <input type="url" class="form-input" id="doc-url" placeholder="https://drive.google.com/file/d/...">
                            <p class="text-xs text-muted mt-1">Paste a link to the document stored in cloud storage</p>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Expiration Date</label>
                                <input type="date" class="form-input" id="doc-expiration">
                                <p class="text-xs text-muted mt-1">Leave blank if no expiration</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Effective Date</label>
                                <input type="date" class="form-input" id="doc-effective" value="${new Date().toISOString().split('T')[0]}">
                                <p class="text-xs text-muted mt-1">When this version takes effect</p>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Version</label>
                                <input type="text" class="form-input" id="doc-version" placeholder="e.g., v1, 2024-12" value="v1">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-input" id="doc-notes" rows="2" placeholder="Additional details about this document..."></textarea>
                        </div>
                    </form>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="DocumentsModule.saveNewDocument()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Save Document
                    </button>
                `;

                UI.openModal('Add Document', content, footer);
            },

            saveNewDocument: function () {
                const name = document.getElementById('doc-name').value.trim();
                const category = document.getElementById('doc-category').value;
                const siteId = document.getElementById('doc-site').value;
                const url = document.getElementById('doc-url').value.trim();
                const expirationDate = document.getElementById('doc-expiration').value;
                const effectiveDate = document.getElementById('doc-effective').value;
                const version = document.getElementById('doc-version').value.trim();
                const notes = document.getElementById('doc-notes').value.trim();

                if (!name) {
                    UI.toast('Missing Name', 'Please enter a document name.', 'error');
                    return;
                }

                if (!category) {
                    UI.toast('Missing Category', 'Please select a category.', 'error');
                    return;
                }

                const document = {
                    id: Utils.generateId('doc-'),
                    name,
                    category,
                    siteId: siteId || 'company-wide',
                    url: url || null,
                    expirationDate: expirationDate || null,
                    effectiveDate: effectiveDate || null,
                    version: version || 'v1',
                    notes: notes || null,
                    versionHistory: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                DataStore.addDocument(document);
                UI.closeModal();
                this.render();
                UI.toast('Document Added', `"${name}" has been saved to the vault.`, 'success');
            },

            openEditModal: function (id) {
                const doc = DataStore.getDocumentById(id);
                if (!doc) return;

                const sites = DataStore.getSites();

                const content = `
                    <form id="edit-document-form">
                        <div class="form-group">
                            <label class="form-label">Document Name *</label>
                            <input type="text" class="form-input" id="edit-doc-name" value="${Utils.escapeHtml(doc.name)}" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Category *</label>
                                <select class="form-select" id="edit-doc-category" required>
                                    ${Object.entries(this.CATEGORIES).map(([key, cat]) => `
                                        <option value="${key}" ${doc.category === key ? 'selected' : ''}>${cat.icon} ${cat.label}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Site</label>
                                <select class="form-select" id="edit-doc-site">
                                    <option value="company-wide" ${doc.siteId === 'company-wide' ? 'selected' : ''}>Company-Wide</option>
                                    ${sites.map(s => `<option value="${s.id}" ${doc.siteId === s.id ? 'selected' : ''}>${Utils.escapeHtml(s.name)}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">URL / Link</label>
                            <input type="url" class="form-input" id="edit-doc-url" value="${Utils.escapeHtml(doc.url || '')}">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Expiration Date</label>
                                <input type="date" class="form-input" id="edit-doc-expiration" value="${doc.expirationDate || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Effective Date</label>
                                <input type="date" class="form-input" id="edit-doc-effective" value="${doc.effectiveDate || ''}">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Version</label>
                                <input type="text" class="form-input" id="edit-doc-version" value="${Utils.escapeHtml(doc.version || 'v1')}">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-input" id="edit-doc-notes" rows="2">${Utils.escapeHtml(doc.notes || '')}</textarea>
                        </div>

                        <div class="text-xs text-muted mt-4">
                            Created: ${Utils.formatDateTime(doc.createdAt)}
                            ${doc.updatedAt !== doc.createdAt ? ` â€¢ Updated: ${Utils.formatDateTime(doc.updatedAt)}` : ''}
                        </div>
                    </form>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="DocumentsModule.saveEditDocument('${id}')">Save Changes</button>
                `;

                UI.openModal('Edit Document', content, footer);
            },

            saveEditDocument: function (id) {
                const name = document.getElementById('edit-doc-name').value.trim();
                const category = document.getElementById('edit-doc-category').value;
                const siteId = document.getElementById('edit-doc-site').value;
                const url = document.getElementById('edit-doc-url').value.trim();
                const expirationDate = document.getElementById('edit-doc-expiration').value;
                const effectiveDate = document.getElementById('edit-doc-effective').value;
                const version = document.getElementById('edit-doc-version').value.trim();
                const notes = document.getElementById('edit-doc-notes').value.trim();

                if (!name) {
                    UI.toast('Missing Name', 'Please enter a document name.', 'error');
                    return;
                }

                DataStore.updateDocument(id, {
                    name,
                    category,
                    siteId: siteId || 'company-wide',
                    url: url || null,
                    expirationDate: expirationDate || null,
                    effectiveDate: effectiveDate || null,
                    version: version || 'v1',
                    notes: notes || null
                });

                UI.closeModal();
                this.render();
                UI.toast('Document Updated', 'Changes have been saved.', 'success');
            },

            deleteDocument: async function (id) {
                const doc = DataStore.getDocumentById(id);
                if (!doc) return;

                const confirmed = await UI.confirm('Delete Document', `Are you sure you want to delete "${doc.name}"?`);
                if (!confirmed) return;

                DataStore.deleteDocument(id);
                this.render();
                UI.toast('Document Deleted', `"${doc.name}" has been removed.`, 'success');
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // VERSION CONTROL FUNCTIONS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            viewVersionHistory: function (id) {
                const doc = DataStore.getDocumentById(id);
                if (!doc) return;

                const history = doc.versionHistory || [];
                const allVersions = [
                    { 
                        version: doc.version || 'v1', 
                        url: doc.url, 
                        effectiveDate: doc.effectiveDate,
                        notes: doc.notes,
                        updatedAt: doc.updatedAt,
                        isCurrent: true 
                    },
                    ...history.map(v => ({ ...v, isCurrent: false }))
                ].sort((a, b) => {
                    // Sort by effective date descending, current first
                    if (a.isCurrent) return -1;
                    if (b.isCurrent) return 1;
                    return new Date(b.effectiveDate || b.updatedAt) - new Date(a.effectiveDate || a.updatedAt);
                });

                const content = `
                    <div style="margin-bottom: var(--space-4);">
                        <div style="font-size: 1.1rem; font-weight: var(--font-weight-semibold);">${Utils.escapeHtml(doc.name)}</div>
                        <div class="text-sm text-muted">${allVersions.length} version${allVersions.length !== 1 ? 's' : ''}</div>
                    </div>

                    <div class="version-history">
                        ${allVersions.map(v => `
                            <div class="version-item ${v.isCurrent ? 'current' : 'superseded'}">
                                <div class="version-badge ${v.isCurrent ? 'current' : ''}">${Utils.escapeHtml(v.version || 'v1')}</div>
                                <div class="version-info">
                                    <div style="font-weight: var(--font-weight-medium);">
                                        ${v.isCurrent ? '<span class="badge badge-success" style="margin-right: 6px;">CURRENT</span>' : ''}
                                        ${v.supersededReason ? `<span class="text-muted">${Utils.escapeHtml(v.supersededReason)}</span>` : ''}
                                    </div>
                                    ${v.notes ? `<div class="text-sm text-muted" style="margin-top: 2px;">${Utils.escapeHtml(v.notes.substring(0, 100))}${v.notes.length > 100 ? '...' : ''}</div>` : ''}
                                    <div class="version-dates">
                                        ${v.effectiveDate ? `<span>Effective: ${new Date(v.effectiveDate).toLocaleDateString()}</span>` : ''}
                                        <span>Updated: ${Utils.formatDateTime(v.updatedAt)}</span>
                                    </div>
                                </div>
                                ${v.url ? `
                                    <a href="${Utils.escapeHtml(v.url)}" target="_blank" rel="noopener" class="btn btn-sm btn-ghost" title="Open document">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                        </svg>
                                    </a>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>

                    <div style="margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--color-border);">
                        <button class="btn btn-primary" onclick="UI.closeModal(); DocumentsModule.createNewVersion('${id}');">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            Create New Version
                        </button>
                    </div>
                `;

                UI.openModal('Version History', content, `<button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>`);
            },

            createNewVersion: function (id) {
                const doc = DataStore.getDocumentById(id);
                if (!doc) return;

                const currentVersion = doc.version || 'v1';
                const suggestedVersion = this.incrementVersion(currentVersion);

                const content = `
                    <form id="new-version-form">
                        <div style="background: var(--color-info-bg); border: 1px solid var(--color-info); border-radius: var(--radius-md); padding: var(--space-3); margin-bottom: var(--space-4);">
                            <div style="display: flex; align-items: center; gap: var(--space-2);">
                                <span>ğŸ“‹</span>
                                <div>
                                    <div style="font-weight: var(--font-weight-medium);">Creating new version of:</div>
                                    <div class="text-sm">${Utils.escapeHtml(doc.name)}</div>
                                    <div class="text-xs text-muted">Current version: ${Utils.escapeHtml(currentVersion)}</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">New Version Number *</label>
                                <input type="text" class="form-input" id="new-version-number" value="${suggestedVersion}" required>
                                <p class="text-xs text-muted mt-1">e.g., v2, v1.1, 2024-12</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Effective Date *</label>
                                <input type="date" class="form-input" id="new-version-effective" value="${new Date().toISOString().split('T')[0]}" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">New Document URL *</label>
                            <input type="url" class="form-input" id="new-version-url" placeholder="https://drive.google.com/..." required>
                            <p class="text-xs text-muted mt-1">Link to the new version</p>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Change Summary</label>
                            <textarea class="form-input" id="new-version-notes" rows="3" placeholder="What changed in this version?"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Reason for Superseding Previous Version</label>
                            <select class="form-select" id="new-version-reason">
                                <option value="Updated policy">Updated policy</option>
                                <option value="Regulatory change">Regulatory change</option>
                                <option value="Client request">Client request</option>
                                <option value="Annual review">Annual review</option>
                                <option value="Correction">Correction</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="form-group" style="background: var(--color-warning-bg); padding: var(--space-3); border-radius: var(--radius-md);">
                            <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                                <input type="checkbox" id="new-version-notify" checked>
                                <span class="text-sm">ğŸ“¢ Mark for rollout notification (guards will see this as a new SOP)</span>
                            </label>
                        </div>
                    </form>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="DocumentsModule.saveNewVersion('${id}')">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Save New Version
                    </button>
                `;

                UI.openModal('Create New Version', content, footer);
            },

            incrementVersion: function (version) {
                // Try to intelligently increment version
                const match = version.match(/v?(\d+)(?:\.(\d+))?/i);
                if (match) {
                    const major = parseInt(match[1]);
                    const minor = match[2] ? parseInt(match[2]) : null;
                    if (minor !== null) {
                        return `v${major}.${minor + 1}`;
                    }
                    return `v${major + 1}`;
                }
                return version + '.1';
            },

            saveNewVersion: function (docId) {
                const versionNumber = document.getElementById('new-version-number').value.trim();
                const effectiveDate = document.getElementById('new-version-effective').value;
                const url = document.getElementById('new-version-url').value.trim();
                const notes = document.getElementById('new-version-notes').value.trim();
                const reason = document.getElementById('new-version-reason').value;
                const notify = document.getElementById('new-version-notify').checked;

                if (!versionNumber || !effectiveDate || !url) {
                    UI.toast('Missing Fields', 'Version number, effective date, and URL are required.', 'error');
                    return;
                }

                const doc = DataStore.getDocumentById(docId);
                if (!doc) return;

                // Archive current version to history
                const history = doc.versionHistory || [];
                history.unshift({
                    version: doc.version || 'v1',
                    url: doc.url,
                    effectiveDate: doc.effectiveDate,
                    notes: doc.notes,
                    updatedAt: doc.updatedAt,
                    supersededAt: new Date().toISOString(),
                    supersededReason: reason
                });

                // Update document with new version
                DataStore.updateDocument(docId, {
                    version: versionNumber,
                    url: url,
                    effectiveDate: effectiveDate,
                    notes: notes || null,
                    versionHistory: history,
                    isNewRollout: notify
                });

                UI.closeModal();
                this.render();
                UI.toast('New Version Created', `${doc.name} updated to ${versionNumber}`, 'success');

                // Add to attention panel if notify is checked
                if (notify) {
                    UI.toast('Rollout Flagged', 'This SOP will appear in rollout notifications.', 'info');
                }
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // DATE LOOKUP - Find what was active on a specific date
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            openLookupModal: function () {
                const sites = DataStore.getSites();
                const today = Utils.toISODate(new Date());

                const content = `
                    <div style="margin-bottom: var(--space-4);">
                        <p class="text-muted">Find which SOPs and documents were in effect on a specific date. Useful for incident investigations or audits.</p>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Lookup Date *</label>
                            <input type="date" class="form-input" id="lookup-date" value="${today}" max="${today}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Site (Optional)</label>
                            <select class="form-select" id="lookup-site">
                                <option value="">All Sites</option>
                                <option value="company-wide">Company-Wide</option>
                                ${sites.map(s => `<option value="${s.id}">${Utils.escapeHtml(s.name)}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Category (Optional)</label>
                        <select class="form-select" id="lookup-category">
                            <option value="">All Categories</option>
                            <option value="post_orders">ğŸ“‹ Post Orders</option>
                            <option value="sop">ğŸ“– SOP</option>
                            <option value="emergency">ğŸš¨ Emergency Procedures</option>
                        </select>
                    </div>

                    <div id="lookup-results" style="margin-top: var(--space-4); display: none;">
                        <!-- Results will be rendered here -->
                    </div>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>
                    <button class="btn btn-primary" onclick="DocumentsModule.performDateLookup()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        Search
                    </button>
                `;

                UI.openModal('Date Lookup', content, footer);
            },

            performDateLookup: function () {
                const lookupDate = new Date(document.getElementById('lookup-date').value);
                const siteId = document.getElementById('lookup-site').value;
                const category = document.getElementById('lookup-category').value;
                const resultsContainer = document.getElementById('lookup-results');

                if (!lookupDate || isNaN(lookupDate.getTime())) {
                    UI.toast('Invalid Date', 'Please select a valid date.', 'error');
                    return;
                }

                let documents = DataStore.getDocuments();
                const sites = DataStore.getSites();
                const sopCategories = ['post_orders', 'sop', 'memo', 'emergency', 'training', 'rollout'];

                // Filter by site
                if (siteId) {
                    documents = documents.filter(d => d.siteId === siteId || d.siteId === 'company-wide');
                }

                // Filter by category
                if (category) {
                    documents = documents.filter(d => d.category === category);
                }

                // For each document, find which version was active on the lookup date
                const results = [];

                documents.forEach(doc => {
                    const history = doc.versionHistory || [];
                    const allVersions = [
                        {
                            version: doc.version || 'v1',
                            url: doc.url,
                            effectiveDate: doc.effectiveDate,
                            notes: doc.notes,
                            isCurrent: true
                        },
                        ...history
                    ];

                    // Sort by effective date descending
                    allVersions.sort((a, b) => {
                        const dateA = a.effectiveDate ? new Date(a.effectiveDate) : new Date(0);
                        const dateB = b.effectiveDate ? new Date(b.effectiveDate) : new Date(0);
                        return dateB - dateA;
                    });

                    // Find the version that was active on the lookup date
                    // (the most recent version with effectiveDate <= lookupDate)
                    let activeVersion = null;
                    for (const v of allVersions) {
                        const effectiveDate = v.effectiveDate ? new Date(v.effectiveDate) : new Date(0);
                        if (effectiveDate <= lookupDate) {
                            activeVersion = v;
                            break;
                        }
                    }

                    // If no version found with effectiveDate, use the oldest one
                    if (!activeVersion && allVersions.length > 0) {
                        activeVersion = allVersions[allVersions.length - 1];
                    }

                    if (activeVersion) {
                        results.push({
                            doc,
                            activeVersion,
                            site: doc.siteId === 'company-wide' ? { name: 'Company-Wide' } : sites.find(s => s.id === doc.siteId)
                        });
                    }
                });

                // Render results
                if (results.length === 0) {
                    resultsContainer.innerHTML = `
                        <div style="text-align: center; padding: var(--space-4); color: var(--color-text-muted);">
                            <p>No documents found for the specified criteria.</p>
                        </div>
                    `;
                } else {
                    resultsContainer.innerHTML = `
                        <div style="margin-bottom: var(--space-3);">
                            <span class="badge badge-info">${results.length} document${results.length !== 1 ? 's' : ''}</span>
                            <span class="text-sm text-muted" style="margin-left: var(--space-2);">active on ${lookupDate.toLocaleDateString()}</span>
                        </div>
                        <div class="version-history" style="max-height: 350px;">
                            ${results.map(r => {
                                const cat = this.CATEGORIES[r.doc.category] || this.CATEGORIES.other;
                                return `
                                    <div class="version-item">
                                        <div style="font-size: 1.2rem;">${cat.icon}</div>
                                        <div class="version-info">
                                            <div style="font-weight: var(--font-weight-medium);">
                                                ${Utils.escapeHtml(r.doc.name)}
                                                ${!r.activeVersion.isCurrent ? '<span class="badge badge-warning" style="margin-left: 6px;">SUPERSEDED</span>' : ''}
                                            </div>
                                            <div class="text-sm text-muted">
                                                ${r.site ? Utils.escapeHtml(r.site.name) : ''} 
                                                â€¢ Version: ${Utils.escapeHtml(r.activeVersion.version || 'v1')}
                                                ${r.activeVersion.effectiveDate ? ` â€¢ Effective: ${new Date(r.activeVersion.effectiveDate).toLocaleDateString()}` : ''}
                                            </div>
                                        </div>
                                        ${r.activeVersion.url ? `
                                            <a href="${Utils.escapeHtml(r.activeVersion.url)}" target="_blank" rel="noopener" class="btn btn-sm btn-ghost" title="Open document">
                                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                                </svg>
                                            </a>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }

                resultsContainer.style.display = 'block';
            },

            // Get expiring documents for Command Center alerts
            getAttentionItems: function () {
                const expired = DataStore.getExpiredDocuments();
                const expiring = DataStore.getExpiringDocuments(30);
                const documents = DataStore.getDocuments();
                const newRollouts = documents.filter(d => d.isNewRollout);
                const items = [];

                // New SOP rollouts need attention
                if (newRollouts.length > 0) {
                    items.push({
                        icon: 'ğŸ“¢',
                        title: `${newRollouts.length} new SOP${newRollouts.length > 1 ? 's' : ''} pending rollout`,
                        detail: newRollouts.slice(0, 2).map(d => d.name).join(', ') + (newRollouts.length > 2 ? ` +${newRollouts.length - 2}` : ''),
                        badge: 'ROLLOUT',
                        severity: 'warning',
                        action: "Router.navigate('documents')"
                    });
                }

                if (expired.length > 0) {
                    items.push({
                        icon: 'ğŸ“„',
                        title: `${expired.length} document${expired.length > 1 ? 's' : ''} expired`,
                        detail: expired.slice(0, 2).map(d => d.name).join(', ') + (expired.length > 2 ? ` +${expired.length - 2}` : ''),
                        badge: 'EXPIRED',
                        severity: 'critical',
                        action: "Router.navigate('documents')"
                    });
                }

                if (expiring.length > 0) {
                    const soonest = expiring.reduce((min, d) => {
                        const days = Math.ceil((new Date(d.expirationDate) - new Date()) / (1000 * 60 * 60 * 24));
                        return days < min ? days : min;
                    }, 30);

                    items.push({
                        icon: 'ğŸ“…',
                        title: `${expiring.length} document${expiring.length > 1 ? 's' : ''} expiring soon`,
                        detail: `Soonest in ${soonest} day${soonest !== 1 ? 's' : ''}`,
                        badge: 'RENEW',
                        severity: 'warning',
                        action: "Router.navigate('documents')"
                    });
                }

                return items;
            },

            // Clear rollout flag after guards have been notified
            clearRolloutFlag: function (id) {
                const doc = DataStore.getDocumentById(id);
                if (doc) {
                    DataStore.updateDocument(id, { isNewRollout: false });
                    this.render();
                    UI.toast('Rollout Cleared', 'SOP marked as rolled out.', 'success');
                }
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ROSTER MODULE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const RosterModule = {
            filters: { status: '', role: '', search: '' },

            init: function () {
                document.getElementById('guard-search')?.addEventListener('input', Utils.debounce((e) => {
                    this.filters.search = e.target.value.toLowerCase();
                    this.renderTable();
                }, 200));

                document.getElementById('guard-filter-status')?.addEventListener('change', (e) => {
                    this.filters.status = e.target.value;
                    this.renderTable();
                });

                document.getElementById('guard-filter-role')?.addEventListener('change', (e) => {
                    this.filters.role = e.target.value;
                    this.renderTable();
                });

                document.getElementById('new-guard-btn')?.addEventListener('click', () => this.openNewGuardModal());
            },

            render: function () {
                this.renderTable();
            },

            renderTable: function () {
                let guards = DataStore.getGuards() || [];
                const sites = DataStore.getSites() || [];

                if (this.filters.status) guards = guards.filter(g => g.status === this.filters.status);
                if (this.filters.role) guards = guards.filter(g => g.role === this.filters.role);
                if (this.filters.search) {
                    guards = guards.filter(g =>
                        g.name.toLowerCase().includes(this.filters.search) ||
                        (g.phone || '').includes(this.filters.search) ||
                        (g.email || '').toLowerCase().includes(this.filters.search)
                    );
                }

                // Sort guards alphabetically by name
                guards = [...guards].sort((a, b) => (a.name || '').localeCompare(b.name || ''));

                const tbody = document.getElementById('roster-tbody');
                if (!tbody) return;

                const statusLabels = { active: 'Active', on_leave: 'On Leave', training: 'Training', suspended: 'Suspended', terminated: 'Terminated' };
                const statusClass = { active: 'success', on_leave: 'warning', training: 'info', suspended: 'danger', terminated: 'danger' };
                const roleLabels = { armed: 'Armed', unarmed: 'Unarmed', floater: 'Floater', supervisor: 'Supervisor', guard: 'Guard' };
                const roleClass = { armed: 'danger', unarmed: 'neutral', floater: 'info', supervisor: 'warning', guard: 'neutral' };

                if (guards.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-muted" style="text-align: center; padding: var(--space-8);">No guards found</td></tr>';
                    return;
                }

                tbody.innerHTML = guards.map(guard => {
                    const primarySiteNames = guard.primarySites.map(sid => sites.find(s => s.id === sid)?.name || 'Unknown').join(', ');

                    // Certification status indicators
                    const certWarnings = this.getCertificationWarnings(guard);
                    const hasCertIssues = certWarnings.length > 0;
                    const hasExpired = certWarnings.some(w => w.includes('EXPIRED'));

                    // Build suspension tooltip if guard is suspended
                    let suspensionInfo = '';
                    if (guard.status === 'suspended') {
                        const startDate = guard.suspensionStart ? new Date(guard.suspensionStart).toLocaleDateString() : 'Not specified';
                        const endDate = guard.suspensionEnd ? new Date(guard.suspensionEnd).toLocaleDateString() : 'Not specified';
                        suspensionInfo = `title="Suspended: ${startDate} to ${endDate}"`;
                    }

                    // Disciplinary indicator
                    const discCount = (guard.disciplinaryHistory || []).filter(d => d.type !== 'commendation').length;
                    const hasCommendations = (guard.disciplinaryHistory || []).some(d => d.type === 'commendation');
                    let discIndicator = '';
                    if (discCount > 0) {
                        discIndicator = `<span title="${discCount} disciplinary record${discCount > 1 ? 's' : ''}" style="color: var(--color-warning); font-size: 0.85em; margin-left: 4px; cursor: help;">ğŸ“‹${discCount > 1 ? '<sup style="font-size: 0.7em;">' + discCount + '</sup>' : ''}</span>`;
                    }
                    if (hasCommendations) {
                        discIndicator += `<span title="Has commendations" style="font-size: 0.85em; margin-left: 2px;">â­</span>`;
                    }

                    // Cert indicator
                    let certIndicator = '';
                    if (hasExpired) {
                        certIndicator = `<span title="${certWarnings.join('\n')}" style="color: var(--color-danger); font-size: 0.85em; margin-left: 4px; cursor: help;">ğŸš«</span>`;
                    } else if (hasCertIssues) {
                        certIndicator = `<span title="${certWarnings.join('\n')}" style="color: var(--color-warning); font-size: 0.85em; margin-left: 4px; cursor: help;">âš ï¸</span>`;
                    }

                    // Tenure display
                    const tenure = guard.hireDate ? this.calculateTenureShort(guard.hireDate) : '';

                    return `
                    <tr ${guard.status === 'suspended' ? 'style="background: rgba(239, 68, 68, 0.05);"' : ''}>
                        <td data-label="Name">
                            <div style="display: flex; align-items: center; gap: var(--space-2);">
                                <span class="font-medium sensitive">${Utils.escapeHtml(guard.name)}</span>
                                ${certIndicator}
                                ${discIndicator}
                            </div>
                            ${tenure ? `<div class="text-xs text-muted">${tenure}</div>` : ''}
                        </td>
                        <td data-label="Phone"><span class="sensitive">${Utils.formatPhone(guard.phone)}</span></td>
                        <td data-label="Primary Sites" class="text-sm">${Utils.escapeHtml(primarySiteNames) || 'â€”'}</td>
                        <td data-label="Role"><span class="badge badge-${roleClass[guard.role] || 'neutral'}">${roleLabels[guard.role] || guard.role}</span></td>
                        <td data-label="Status">
                            <span class="badge badge-${statusClass[guard.status]}" ${suspensionInfo} style="cursor: ${guard.status === 'suspended' ? 'help' : 'default'};">
                                ${statusLabels[guard.status] || guard.status}
                                ${guard.status === 'suspended' && guard.suspensionEnd ? '<br><small style="font-size: 0.75em; opacity: 0.9;">Until ' + new Date(guard.suspensionEnd).toLocaleDateString() + '</small>' : ''}
                            </span>
                        </td>
                        <td data-label="Actions">
                            <button class="btn btn-sm btn-ghost" onclick="GuardPerformanceModule.openProfile('${guard.id}')" title="Performance">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                            </button>
                            <button class="btn btn-sm btn-ghost" onclick="RosterModule.editGuard('${guard.id}')" title="Edit">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                            </button>
                            <button class="btn btn-sm btn-ghost" onclick="RosterModule.deleteGuard('${guard.id}')" title="Delete" style="color: var(--color-danger);">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                            </button>
                        </td>
                    </tr>
                `;
                }).join('');
            },

            // Short tenure format for table
            calculateTenureShort: function(hireDate) {
                if (!hireDate) return '';
                const hire = new Date(hireDate);
                const now = new Date();
                const years = Math.floor((now - hire) / (365.25 * 24 * 60 * 60 * 1000));
                const months = Math.floor(((now - hire) % (365.25 * 24 * 60 * 60 * 1000)) / (30.44 * 24 * 60 * 60 * 1000));
                
                if (years > 0) return `${years}y ${months}m`;
                if (months > 0) return `${months}m`;
                return 'New';
            },

            // Show certification alerts modal
            showCertAlerts: function() {
                const guards = DataStore.getGuards() || [];
                const activeGuards = guards.filter(g => g.status === 'active' || g.status === 'training');
                
                const allAlerts = [];
                activeGuards.forEach(guard => {
                    const warnings = this.getCertificationWarnings(guard);
                    warnings.forEach(warning => {
                        allAlerts.push({
                            guardId: guard.id,
                            guardName: guard.name,
                            warning: warning,
                            isExpired: warning.includes('EXPIRED'),
                            isExpiring: warning.includes('expires in')
                        });
                    });
                });

                // Sort: expired first, then by guard name
                allAlerts.sort((a, b) => {
                    if (a.isExpired && !b.isExpired) return -1;
                    if (!a.isExpired && b.isExpired) return 1;
                    return a.guardName.localeCompare(b.guardName);
                });

                if (allAlerts.length === 0) {
                    UI.openModal('Certification Alerts', `
                        <div style="text-align: center; padding: var(--space-6);">
                            <div style="font-size: 3rem; margin-bottom: var(--space-4);">âœ…</div>
                            <h3 style="margin: 0 0 var(--space-2);">All Clear!</h3>
                            <p class="text-muted">No certification alerts at this time.</p>
                        </div>
                    `, '<button class="btn btn-primary" onclick="UI.closeModal()">Close</button>');
                    return;
                }

                const expiredCount = allAlerts.filter(a => a.isExpired).length;
                const expiringCount = allAlerts.filter(a => a.isExpiring).length;

                const content = `
                    <div style="margin-bottom: var(--space-4);">
                        <div style="display: flex; gap: var(--space-4); margin-bottom: var(--space-4);">
                            ${expiredCount > 0 ? `<div style="padding: var(--space-3); background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-md); flex: 1; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-danger);">${expiredCount}</div>
                                <div class="text-sm text-muted">Expired</div>
                            </div>` : ''}
                            ${expiringCount > 0 ? `<div style="padding: var(--space-3); background: rgba(245, 158, 11, 0.1); border-radius: var(--radius-md); flex: 1; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-warning);">${expiringCount}</div>
                                <div class="text-sm text-muted">Expiring Soon</div>
                            </div>` : ''}
                        </div>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${allAlerts.map(alert => `
                            <div style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3); border-bottom: 1px solid var(--color-border); cursor: pointer;" onclick="UI.closeModal(); RosterModule.editGuard('${alert.guardId}'); setTimeout(() => RosterModule.switchEditTab('certs'), 100);">
                                <div style="flex: 1;">
                                    <div class="font-medium sensitive">${Utils.escapeHtml(alert.guardName)}</div>
                                    <div class="text-sm" style="color: ${alert.isExpired ? 'var(--color-danger)' : 'var(--color-warning)'};">${alert.warning}</div>
                                </div>
                                <div style="color: var(--color-text-muted);">â†’</div>
                            </div>
                        `).join('')}
                    </div>
                `;

                UI.openModal(`âš ï¸ Certification Alerts (${allAlerts.length})`, content, '<button class="btn btn-primary" onclick="UI.closeModal()">Close</button>', 'lg');
            },

            editGuard: function (id) {
                const guard = DataStore.getGuardById(id);
                if (!guard) return;

                // Get all sites (don't filter - show all for assignment)
                const allSites = DataStore.getSites() || [];
                const sites = allSites.filter(s => s.status !== 'terminated');
                const guardPrimarySites = guard.primarySites || [];
                const certs = guard.certifications || {};
                const emContact = guard.emergencyContact || {};
                const avail = guard.availability || {};

                const siteCheckboxes = sites.length > 0 ? sites.map(site => `
                <label class="checkbox-label" style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-1) 0;">
                    <input type="checkbox" name="edit-guard-sites" value="${site.id}" ${guardPrimarySites.includes(site.id) ? 'checked' : ''}>
                    <span class="text-sm">${Utils.escapeHtml(site.name)}</span>
                </label>
            `).join('') : '<span class="text-muted text-sm">No sites available - import a schedule first</span>';

                // Check for expiring certifications
                const certWarnings = this.getCertificationWarnings(guard);

                const content = `
                <div style="max-height: 70vh; overflow-y: auto;">
                    <!-- CERTIFICATION ALERTS -->
                    ${certWarnings.length > 0 ? `
                        <div style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-warning-bg); border: 1px solid var(--color-warning); border-radius: var(--radius-md);">
                            <div style="font-weight: 600; color: var(--color-warning); margin-bottom: var(--space-2);">âš ï¸ Certification Alerts</div>
                            ${certWarnings.map(w => `<div class="text-sm">${w}</div>`).join('')}
                        </div>
                    ` : ''}
                    
                    <!-- TAB NAVIGATION -->
                    <div style="display: flex; gap: var(--space-1); margin-bottom: var(--space-4); border-bottom: 1px solid var(--color-border);">
                        <button type="button" class="tab-btn active" data-tab="basic" onclick="RosterModule.switchEditTab('basic')" style="padding: var(--space-2) var(--space-4); background: none; border: none; border-bottom: 2px solid var(--color-primary); color: var(--color-primary); cursor: pointer; font-weight: 500;">
                            Basic Info
                        </button>
                        <button type="button" class="tab-btn" data-tab="certs" onclick="RosterModule.switchEditTab('certs')" style="padding: var(--space-2) var(--space-4); background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-text-muted); cursor: pointer;">
                            Certifications
                        </button>
                        <button type="button" class="tab-btn" data-tab="availability" onclick="RosterModule.switchEditTab('availability')" style="padding: var(--space-2) var(--space-4); background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-text-muted); cursor: pointer;">
                            Availability
                        </button>
                        <button type="button" class="tab-btn" data-tab="history" onclick="RosterModule.switchEditTab('history')" style="padding: var(--space-2) var(--space-4); background: none; border: none; border-bottom: 2px solid transparent; color: var(--color-text-muted); cursor: pointer;">
                            History
                        </button>
                    </div>
                    
                    <form id="edit-guard-form">
                        <!-- BASIC INFO TAB -->
                        <div class="edit-tab-content" data-tab-content="basic">
                            <div class="form-group">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-input" id="edit-guard-name" value="${Utils.escapeHtml(guard.name)}" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" class="form-input" id="edit-guard-phone" value="${Utils.escapeHtml(guard.phone)}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-input" id="edit-guard-email" value="${Utils.escapeHtml(guard.email || '')}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Role</label>
                                    <select class="form-select" id="edit-guard-role">
                                        <option value="armed" ${guard.role === 'armed' ? 'selected' : ''}>Armed</option>
                                        <option value="unarmed" ${guard.role === 'unarmed' ? 'selected' : ''}>Unarmed</option>
                                        <option value="floater" ${guard.role === 'floater' ? 'selected' : ''}>Floater</option>
                                        <option value="supervisor" ${guard.role === 'supervisor' ? 'selected' : ''}>Supervisor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="edit-guard-status" onchange="RosterModule.toggleSuspensionFields('edit')">
                                        <option value="active" ${guard.status === 'active' ? 'selected' : ''}>Active</option>
                                        <option value="on_leave" ${guard.status === 'on_leave' ? 'selected' : ''}>On Leave</option>
                                        <option value="training" ${guard.status === 'training' ? 'selected' : ''}>In Training</option>
                                        <option value="suspended" ${guard.status === 'suspended' ? 'selected' : ''}>Suspended</option>
                                        <option value="terminated" ${guard.status === 'terminated' ? 'selected' : ''}>Terminated</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Hire Date</label>
                                    <input type="date" class="form-input" id="edit-guard-hire-date" value="${guard.hireDate || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Hourly Rate</label>
                                    <input type="number" class="form-input" id="edit-guard-rate" value="${guard.hourlyRate || ''}" step="0.25" min="0">
                                </div>
                            </div>
                            
                            <!-- Primary Sites -->
                            <div class="form-group">
                                <label class="form-label">Primary Sites</label>
                                <div style="max-height: 150px; overflow-y: auto; padding: var(--space-2); background: var(--color-surface-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                                    ${siteCheckboxes}
                                </div>
                            </div>
                            
                            <!-- Emergency Contact -->
                            <div style="margin-top: var(--space-4); padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md);">
                                <h4 style="margin: 0 0 var(--space-3); color: var(--color-danger); font-size: var(--font-size-sm); text-transform: uppercase;">ğŸš¨ Emergency Contact</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Contact Name</label>
                                        <input type="text" class="form-input" id="edit-guard-emergency-name" value="${Utils.escapeHtml(emContact.name || '')}">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Relationship</label>
                                        <select class="form-select" id="edit-guard-emergency-relation">
                                            <option value="">-- Select --</option>
                                            <option value="spouse" ${emContact.relationship === 'spouse' ? 'selected' : ''}>Spouse</option>
                                            <option value="parent" ${emContact.relationship === 'parent' ? 'selected' : ''}>Parent</option>
                                            <option value="sibling" ${emContact.relationship === 'sibling' ? 'selected' : ''}>Sibling</option>
                                            <option value="child" ${emContact.relationship === 'child' ? 'selected' : ''}>Child</option>
                                            <option value="friend" ${emContact.relationship === 'friend' ? 'selected' : ''}>Friend</option>
                                            <option value="other" ${emContact.relationship === 'other' ? 'selected' : ''}>Other</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Contact Phone</label>
                                    <input type="tel" class="form-input" id="edit-guard-emergency-phone" value="${Utils.escapeHtml(emContact.phone || '')}">
                                </div>
                            </div>
                            
                            <!-- Suspension Details -->
                            <div id="edit-suspension-fields" style="display: ${guard.status === 'suspended' ? 'block' : 'none'}; margin-top: var(--space-4); padding: var(--space-4); background: var(--color-warning-bg); border: 1px solid var(--color-warning); border-radius: var(--radius-md);">
                                <h4 style="margin: 0 0 var(--space-3) 0; color: var(--color-warning);">âš ï¸ Suspension Details</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Suspension Start</label>
                                        <input type="date" class="form-input" id="edit-suspension-start" value="${guard.suspensionStart || ''}">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Suspension End</label>
                                        <input type="date" class="form-input" id="edit-suspension-end" value="${guard.suspensionEnd || ''}">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Reason / Notes</label>
                                    <textarea class="form-input" id="edit-suspension-notes" rows="2">${guard.suspensionNotes || ''}</textarea>
                                </div>
                            </div>
                            
                            <!-- Notes -->
                            <div class="form-group" style="margin-top: var(--space-4);">
                                <label class="form-label">ğŸ“ General Notes</label>
                                <textarea class="form-input" id="edit-guard-notes" rows="2">${Utils.escapeHtml(guard.notes || '')}</textarea>
                            </div>
                        </div>
                        
                        <!-- CERTIFICATIONS TAB -->
                        <div class="edit-tab-content" data-tab-content="certs" style="display: none;">
                            <div style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md);">
                                <h4 style="margin: 0 0 var(--space-3); font-size: var(--font-size-sm); text-transform: uppercase;">ğŸ“œ SORA Card</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">SORA Number</label>
                                        <input type="text" class="form-input" id="edit-guard-sora" value="${Utils.escapeHtml(certs.sora?.number || '')}">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Expiration Date</label>
                                        <input type="date" class="form-input" id="edit-guard-sora-exp" value="${certs.sora?.expiration || ''}">
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md);">
                                <h4 style="margin: 0 0 var(--space-3); font-size: var(--font-size-sm); text-transform: uppercase;">ğŸ”« Armed License</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">License Number</label>
                                        <input type="text" class="form-input" id="edit-guard-armed-license" value="${Utils.escapeHtml(certs.armedLicense?.number || '')}">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Expiration Date</label>
                                        <input type="date" class="form-input" id="edit-guard-armed-exp" value="${certs.armedLicense?.expiration || ''}">
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md);">
                                <h4 style="margin: 0 0 var(--space-3); font-size: var(--font-size-sm); text-transform: uppercase;">ğŸš— Driver's License</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">License Number</label>
                                        <input type="text" class="form-input" id="edit-guard-dl" value="${Utils.escapeHtml(certs.driversLicense?.number || '')}">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Expiration Date</label>
                                        <input type="date" class="form-input" id="edit-guard-dl-exp" value="${certs.driversLicense?.expiration || ''}">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AVAILABILITY TAB -->
                        <div class="edit-tab-content" data-tab-content="availability" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Preferred Shifts</label>
                                <div style="display: flex; flex-wrap: wrap; gap: var(--space-3);">
                                    <label style="display: flex; align-items: center; gap: 4px;">
                                        <input type="checkbox" name="edit-guard-shifts" value="day" ${(avail.preferredShifts || []).includes('day') ? 'checked' : ''}> Day (8A-4P)
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 4px;">
                                        <input type="checkbox" name="edit-guard-shifts" value="evening" ${(avail.preferredShifts || []).includes('evening') ? 'checked' : ''}> Evening (4P-12A)
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 4px;">
                                        <input type="checkbox" name="edit-guard-shifts" value="overnight" ${(avail.preferredShifts || []).includes('overnight') ? 'checked' : ''}> Overnight (12A-8A)
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Max Hours/Week</label>
                                    <input type="number" class="form-input" id="edit-guard-max-hours" value="${avail.maxHoursPerWeek || 40}" min="0" max="84">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Has Own Vehicle?</label>
                                    <select class="form-select" id="edit-guard-vehicle">
                                        <option value="yes" ${avail.hasVehicle ? 'selected' : ''}>Yes</option>
                                        <option value="no" ${!avail.hasVehicle ? 'selected' : ''}>No</option>
                                    </select>
                                </div>
                            </div>
                            
                            ${guard.hireDate ? `
                                <div style="margin-top: var(--space-4); padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md);">
                                    <div class="text-sm text-muted">Tenure</div>
                                    <div class="font-medium">${this.calculateTenure(guard.hireDate)}</div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- HISTORY TAB -->
                        <div class="edit-tab-content" data-tab-content="history" style="display: none;">
                            <div style="padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-3);">
                                    <h4 style="margin: 0; font-size: var(--font-size-base);">ğŸ“‹ Disciplinary History</h4>
                                    <div style="display: flex; gap: var(--space-2);">
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="RosterModule.showAddDisciplinaryForm('${id}')">+ Quick Add</button>
                                        <button type="button" class="btn btn-sm btn-warning" onclick="WarningNoticeModule.openForGuard('${id}')" style="background: var(--color-warning); color: var(--color-text-inverse);">
                                            Formal Notice
                                        </button>
                                    </div>
                                </div>
                                <div id="disciplinary-list">
                                    ${this.renderDisciplinaryHistory(guard.disciplinaryHistory || [])}
                                </div>
                                
                                <!-- Add Disciplinary Form (hidden by default) -->
                                <div id="add-disciplinary-form" style="display: none; margin-top: var(--space-3); padding: var(--space-3); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Date</label>
                                            <input type="date" class="form-input" id="new-disciplinary-date" value="${new Date().toISOString().split('T')[0]}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Type</label>
                                            <select class="form-select" id="new-disciplinary-type">
                                                <option value="verbal_warning">Verbal Warning</option>
                                                <option value="written_warning">Written Warning</option>
                                                <option value="final_warning">Final Warning</option>
                                                <option value="suspension">Suspension</option>
                                                <option value="coaching">Coaching/Counseling</option>
                                                <option value="commendation">Commendation â­</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-input" id="new-disciplinary-desc" rows="2"></textarea>
                                    </div>
                                    <div style="display: flex; gap: var(--space-2); justify-content: flex-end;">
                                        <button type="button" class="btn btn-sm btn-ghost" onclick="document.getElementById('add-disciplinary-form').style.display='none'">Cancel</button>
                                        <button type="button" class="btn btn-sm btn-primary" onclick="RosterModule.addDisciplinaryRecord('${id}')">Add Record</button>
                                    </div>
                                </div>
                            </div>
                            
                            ${guard.createdAt ? `
                                <div style="margin-top: var(--space-4); padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md);">
                                    <div class="text-sm text-muted">Record Created</div>
                                    <div class="text-sm">${new Date(guard.createdAt).toLocaleString()}</div>
                                    ${guard.updatedAt ? `
                                        <div class="text-sm text-muted" style="margin-top: var(--space-2);">Last Updated</div>
                                        <div class="text-sm">${new Date(guard.updatedAt).toLocaleString()}</div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </form>
                </div>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="RosterModule.saveGuard('${id}')">Save Changes</button>
            `;

                UI.openModal(`Edit ${guard.name}`, content, footer, 'lg');
            },

            // Tab switching for edit modal
            switchEditTab: function(tabName) {
                document.querySelectorAll('.edit-tab-content').forEach(el => el.style.display = 'none');
                document.querySelectorAll('[data-tab-content="' + tabName + '"]').forEach(el => el.style.display = 'block');
                
                document.querySelectorAll('.tab-btn[data-tab]').forEach(btn => {
                    btn.style.borderBottomColor = 'transparent';
                    btn.style.color = 'var(--color-text-muted)';
                });
                document.querySelectorAll('.tab-btn[data-tab="' + tabName + '"]').forEach(btn => {
                    btn.style.borderBottomColor = 'var(--color-primary)';
                    btn.style.color = 'var(--color-primary)';
                });
            },

            // Get certification warnings
            getCertificationWarnings: function(guard) {
                const warnings = [];
                const today = new Date();
                const thirtyDays = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
                const certs = guard.certifications || {};

                const checkCert = (cert, name) => {
                    if (cert?.expiration) {
                        const exp = new Date(cert.expiration);
                        if (exp < today) {
                            warnings.push(`âŒ ${name} EXPIRED on ${exp.toLocaleDateString()}`);
                        } else if (exp < thirtyDays) {
                            const days = Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
                            warnings.push(`âš ï¸ ${name} expires in ${days} days (${exp.toLocaleDateString()})`);
                        }
                    }
                };

                checkCert(certs.sora, 'SORA Card');
                checkCert(certs.armedLicense, 'Armed License');
                checkCert(certs.driversLicense, "Driver's License");

                return warnings;
            },

            // Calculate tenure
            calculateTenure: function(hireDate) {
                if (!hireDate) return 'Unknown';
                const hire = new Date(hireDate);
                const now = new Date();
                const years = Math.floor((now - hire) / (365.25 * 24 * 60 * 60 * 1000));
                const months = Math.floor(((now - hire) % (365.25 * 24 * 60 * 60 * 1000)) / (30.44 * 24 * 60 * 60 * 1000));
                
                if (years > 0) {
                    return `${years} year${years > 1 ? 's' : ''}, ${months} month${months !== 1 ? 's' : ''}`;
                }
                return `${months} month${months !== 1 ? 's' : ''}`;
            },

            saveGuard: function (id) {
                const guards = DataStore.getGuards();
                const idx = guards.findIndex(g => g.id === id);

                if (idx !== -1) {
                    const newName = document.getElementById('edit-guard-name').value.trim();
                    guards[idx].name = newName;
                    // Also update firstName/lastName for backwards compatibility
                    const nameParts = newName.split(' ');
                    guards[idx].firstName = nameParts[0] || '';
                    guards[idx].lastName = nameParts.slice(1).join(' ') || '';
                    
                    // Basic info
                    const phoneInput = document.getElementById('edit-guard-phone');
                    guards[idx].phone = phoneInput.value.replace(/\D/g, '');
                    guards[idx].email = document.getElementById('edit-guard-email').value;
                    guards[idx].role = document.getElementById('edit-guard-role').value;
                    guards[idx].status = document.getElementById('edit-guard-status').value;

                    // Employment info
                    guards[idx].hireDate = document.getElementById('edit-guard-hire-date')?.value || null;
                    guards[idx].hourlyRate = parseFloat(document.getElementById('edit-guard-rate')?.value) || null;

                    // Save primary sites
                    const siteCheckboxes = document.querySelectorAll('input[name="edit-guard-sites"]:checked');
                    guards[idx].primarySites = Array.from(siteCheckboxes).map(cb => cb.value);

                    // Save certifications
                    guards[idx].certifications = {
                        sora: {
                            number: document.getElementById('edit-guard-sora')?.value.trim() || null,
                            expiration: document.getElementById('edit-guard-sora-exp')?.value || null
                        },
                        armedLicense: {
                            number: document.getElementById('edit-guard-armed-license')?.value.trim() || null,
                            expiration: document.getElementById('edit-guard-armed-exp')?.value || null
                        },
                        driversLicense: {
                            number: document.getElementById('edit-guard-dl')?.value.trim() || null,
                            expiration: document.getElementById('edit-guard-dl-exp')?.value || null
                        }
                    };

                    // Save emergency contact
                    guards[idx].emergencyContact = {
                        name: document.getElementById('edit-guard-emergency-name')?.value.trim() || null,
                        relationship: document.getElementById('edit-guard-emergency-relation')?.value || null,
                        phone: document.getElementById('edit-guard-emergency-phone')?.value.replace(/\D/g, '') || null
                    };

                    // Save availability
                    const shiftCheckboxes = document.querySelectorAll('input[name="edit-guard-shifts"]:checked');
                    guards[idx].availability = {
                        preferredShifts: Array.from(shiftCheckboxes).map(cb => cb.value),
                        maxHoursPerWeek: parseInt(document.getElementById('edit-guard-max-hours')?.value) || 40,
                        hasVehicle: document.getElementById('edit-guard-vehicle')?.value === 'yes'
                    };

                    // Save suspension data if status is suspended
                    if (guards[idx].status === 'suspended') {
                        const startDate = document.getElementById('edit-suspension-start')?.value;
                        const endDate = document.getElementById('edit-suspension-end')?.value;

                        // Validate suspension end >= start
                        if (startDate && endDate && new Date(endDate) < new Date(startDate)) {
                            UI.notify('Suspension end date cannot be before start date.', 'error');
                            return;
                        }

                        guards[idx].suspensionStart = startDate;
                        guards[idx].suspensionEnd = endDate;
                        guards[idx].suspensionNotes = document.getElementById('edit-suspension-notes')?.value;
                    } else {
                        // Clear suspension data if status changed from suspended
                        delete guards[idx].suspensionStart;
                        delete guards[idx].suspensionEnd;
                        delete guards[idx].suspensionNotes;
                    }

                    // Save general notes
                    guards[idx].notes = document.getElementById('edit-guard-notes')?.value || '';

                    // Set updatedAt timestamp
                    guards[idx].updatedAt = new Date().toISOString();

                    DataStore.saveGuards(guards);
                    UI.closeModal();
                    this.renderTable();
                    UI.notify('Guard updated successfully', 'success');
                }
            },

            // Render disciplinary history list
            renderDisciplinaryHistory: function (history) {
                if (!history || history.length === 0) {
                    return '<p class="text-muted text-sm" style="margin: 0;">No disciplinary records.</p>';
                }

                const typeLabels = {
                    verbal_warning: { label: 'Verbal Warning', color: 'warning', icon: 'ğŸ—£ï¸' },
                    written_warning: { label: 'Written Warning', color: 'warning', icon: 'ğŸ“' },
                    final_warning: { label: 'Final Warning', color: 'error', icon: 'âš ï¸' },
                    suspension: { label: 'Suspension', color: 'error', icon: 'ğŸš«' },
                    coaching: { label: 'Coaching', color: 'info', icon: 'ğŸ’¬' },
                    commendation: { label: 'Commendation', color: 'success', icon: 'â­' }
                };

                // Sort by date descending (most recent first)
                const sorted = [...history].sort((a, b) => new Date(b.date) - new Date(a.date));

                return sorted.map((record, idx) => {
                    const typeInfo = typeLabels[record.type] || { label: record.type, color: 'secondary', icon: 'ğŸ“‹' };
                    const date = new Date(record.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                    return `
                    <div class="disciplinary-record" style="display: flex; gap: var(--space-3); padding: var(--space-2) 0; border-bottom: 1px solid var(--color-border); align-items: flex-start;">
                        <div style="flex-shrink: 0; font-size: 1.2rem;">${typeInfo.icon}</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; gap: var(--space-2);">
                                <span class="badge badge-${typeInfo.color}" style="font-size: var(--font-size-xs);">${typeInfo.label}</span>
                                <span class="text-xs text-muted">${date}</span>
                            </div>
                            <p class="text-sm" style="margin: var(--space-1) 0 0 0; color: var(--color-text-secondary);">${Utils.escapeHtml(record.description || 'No description')}</p>
                        </div>
                        <button type="button" class="btn btn-sm btn-ghost" onclick="RosterModule.removeDisciplinaryRecord(${history.indexOf(record)})" title="Delete record" style="flex-shrink: 0; padding: var(--space-1);">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                `;
                }).join('');
            },

            // Show add disciplinary form
            showAddDisciplinaryForm: function (guardId) {
                const form = document.getElementById('add-disciplinary-form');
                if (form) {
                    form.style.display = 'block';
                    document.getElementById('new-disciplinary-desc').focus();
                }
            },

            // Add a disciplinary record
            addDisciplinaryRecord: function (guardId) {
                const date = document.getElementById('new-disciplinary-date').value;
                const type = document.getElementById('new-disciplinary-type').value;
                const description = document.getElementById('new-disciplinary-desc').value.trim();

                if (!date) {
                    UI.toast('Missing Date', 'Please select a date for this record.', 'error');
                    return;
                }

                if (!description) {
                    UI.toast('Missing Description', 'Please enter a description.', 'error');
                    return;
                }

                const guards = DataStore.getGuards();
                const guard = guards.find(g => g.id === guardId);

                if (guard) {
                    if (!guard.disciplinaryHistory) {
                        guard.disciplinaryHistory = [];
                    }

                    guard.disciplinaryHistory.push({
                        id: Utils.generateId('disc-'),
                        date: date,
                        type: type,
                        description: description,
                        createdAt: new Date().toISOString()
                    });

                    DataStore.saveGuards(guards);

                    // Re-render the list
                    document.getElementById('disciplinary-list').innerHTML = this.renderDisciplinaryHistory(guard.disciplinaryHistory);

                    // Clear and hide form
                    document.getElementById('new-disciplinary-desc').value = '';
                    document.getElementById('add-disciplinary-form').style.display = 'none';

                    const typeLabel = type.replace('_', ' ');
                    UI.toast('Record Added', `${typeLabel} added to ${guard.name}'s record.`, 'success');
                }
            },

            // Remove a disciplinary record
            removeDisciplinaryRecord: function (index) {
                // Get the guard ID from the modal (parse from save button)
                const saveBtn = document.querySelector('.modal-footer .btn-primary');
                if (!saveBtn) return;

                const guardIdMatch = saveBtn.onclick.toString().match(/saveGuard\('([^']+)'\)/);
                if (!guardIdMatch) return;

                const guardId = guardIdMatch[1];
                const guards = DataStore.getGuards();
                const guard = guards.find(g => g.id === guardId);

                if (guard && guard.disciplinaryHistory && guard.disciplinaryHistory[index]) {
                    const record = guard.disciplinaryHistory[index];

                    if (confirm(`Remove this ${record.type.replace('_', ' ')} record from ${record.date}?`)) {
                        guard.disciplinaryHistory.splice(index, 1);
                        DataStore.saveGuards(guards);

                        // Re-render the list
                        document.getElementById('disciplinary-list').innerHTML = this.renderDisciplinaryHistory(guard.disciplinaryHistory);
                        UI.toast('Record Removed', 'Disciplinary record has been deleted.', 'info');
                    }
                }
            },

            openNewGuardModal: function () {
                const sites = DataStore.getSites() || [];

                const siteCheckboxes = sites.map(site => `
                <label class="checkbox-label" style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-1) 0;">
                    <input type="checkbox" name="new-guard-sites" value="${site.id}">
                    <span class="text-sm">${Utils.escapeHtml(site.name)}</span>
                </label>
            `).join('');

                const content = `
                <form id="new-guard-form" style="max-height: 70vh; overflow-y: auto;">
                    <!-- BASIC INFO -->
                    <div style="margin-bottom: var(--space-4);">
                        <h4 style="margin: 0 0 var(--space-3); color: var(--color-primary); font-size: var(--font-size-sm); text-transform: uppercase; letter-spacing: 0.5px;">ğŸ‘¤ Basic Information</h4>
                        
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-input" id="new-guard-name" required placeholder="First Last">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Phone *</label>
                                <input type="tel" class="form-input" id="new-guard-phone" required placeholder="(973) 555-0100">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="new-guard-email" placeholder="guard@email.com">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Role *</label>
                                <select class="form-select" id="new-guard-role">
                                    <option value="unarmed">Unarmed Guard</option>
                                    <option value="armed">Armed Guard</option>
                                    <option value="floater">Floater</option>
                                    <option value="supervisor">Supervisor</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="new-guard-status" onchange="RosterModule.toggleSuspensionFields('new')">
                                    <option value="active" selected>Active</option>
                                    <option value="on_leave">On Leave</option>
                                    <option value="training">In Training</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Hire Date</label>
                                <input type="date" class="form-input" id="new-guard-hire-date" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Hourly Rate</label>
                                <input type="number" class="form-input" id="new-guard-rate" placeholder="18.00" step="0.25" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <!-- CERTIFICATIONS -->
                    <div style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md);">
                        <h4 style="margin: 0 0 var(--space-3); color: var(--color-primary); font-size: var(--font-size-sm); text-transform: uppercase; letter-spacing: 0.5px;">ğŸ“œ Certifications & Licenses</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">SORA Card #</label>
                                <input type="text" class="form-input" id="new-guard-sora" placeholder="SORA123456">
                            </div>
                            <div class="form-group">
                                <label class="form-label">SORA Expiration</label>
                                <input type="date" class="form-input" id="new-guard-sora-exp">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Armed License #</label>
                                <input type="text" class="form-input" id="new-guard-armed-license" placeholder="Leave blank if unarmed">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Armed License Exp</label>
                                <input type="date" class="form-input" id="new-guard-armed-exp">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Driver's License #</label>
                                <input type="text" class="form-input" id="new-guard-dl" placeholder="Optional">
                            </div>
                            <div class="form-group">
                                <label class="form-label">DL Expiration</label>
                                <input type="date" class="form-input" id="new-guard-dl-exp">
                            </div>
                        </div>
                    </div>
                    
                    <!-- EMERGENCY CONTACT -->
                    <div style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md);">
                        <h4 style="margin: 0 0 var(--space-3); color: var(--color-danger); font-size: var(--font-size-sm); text-transform: uppercase; letter-spacing: 0.5px;">ğŸš¨ Emergency Contact</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Contact Name</label>
                                <input type="text" class="form-input" id="new-guard-emergency-name" placeholder="Emergency contact name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Relationship</label>
                                <select class="form-select" id="new-guard-emergency-relation">
                                    <option value="">-- Select --</option>
                                    <option value="spouse">Spouse</option>
                                    <option value="parent">Parent</option>
                                    <option value="sibling">Sibling</option>
                                    <option value="child">Child</option>
                                    <option value="friend">Friend</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact Phone</label>
                            <input type="tel" class="form-input" id="new-guard-emergency-phone" placeholder="(973) 555-0100">
                        </div>
                    </div>
                    
                    <!-- PRIMARY SITES -->
                    <div style="margin-bottom: var(--space-4);">
                        <h4 style="margin: 0 0 var(--space-3); color: var(--color-primary); font-size: var(--font-size-sm); text-transform: uppercase; letter-spacing: 0.5px;">ğŸ“ Primary Sites</h4>
                        <div style="max-height: 150px; overflow-y: auto; padding: var(--space-2); background: var(--color-surface-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                            ${siteCheckboxes || '<span class="text-muted text-sm">No sites available</span>'}
                        </div>
                        <span class="text-xs text-muted" style="margin-top: var(--space-1); display: block;">Select all sites this guard can work at</span>
                    </div>
                    
                    <!-- AVAILABILITY -->
                    <div style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-surface-elevated); border-radius: var(--radius-md);">
                        <h4 style="margin: 0 0 var(--space-3); color: var(--color-primary); font-size: var(--font-size-sm); text-transform: uppercase; letter-spacing: 0.5px;">ğŸ“… Availability Preferences</h4>
                        
                        <div class="form-group">
                            <label class="form-label">Preferred Shifts</label>
                            <div style="display: flex; flex-wrap: wrap; gap: var(--space-2);">
                                <label style="display: flex; align-items: center; gap: 4px;">
                                    <input type="checkbox" name="new-guard-shifts" value="day"> Day (8A-4P)
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px;">
                                    <input type="checkbox" name="new-guard-shifts" value="evening"> Evening (4P-12A)
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px;">
                                    <input type="checkbox" name="new-guard-shifts" value="overnight"> Overnight (12A-8A)
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Max Hours/Week</label>
                                <input type="number" class="form-input" id="new-guard-max-hours" placeholder="40" min="0" max="84">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Has Own Vehicle?</label>
                                <select class="form-select" id="new-guard-vehicle">
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NOTES -->
                    <div class="form-group">
                        <label class="form-label">ğŸ“ Notes</label>
                        <textarea class="form-input" id="new-guard-notes" rows="2" placeholder="Any special notes, skills, languages spoken, etc."></textarea>
                    </div>
                    
                    <!-- Suspension Details (shown only when status = suspended) -->
                    <div id="new-suspension-fields" style="display: none; margin-top: var(--space-4); padding: var(--space-4); background: var(--color-warning-bg); border: 1px solid var(--color-warning); border-radius: var(--radius-md);">
                        <h4 style="margin: 0 0 var(--space-3) 0; color: var(--color-warning); font-size: var(--font-size-base); font-weight: var(--font-weight-semibold);">âš ï¸ Suspension Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Suspension Start Date</label>
                                <input type="date" class="form-input" id="new-suspension-start">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Suspension End Date</label>
                                <input type="date" class="form-input" id="new-suspension-end">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Suspension Reason / Notes</label>
                            <textarea class="form-input" id="new-suspension-notes" rows="3" placeholder="Enter reason for suspension and any relevant notes..."></textarea>
                        </div>
                    </div>
                </form>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="RosterModule.createGuard()">Add Guard</button>
            `;

                UI.openModal('Add New Guard', content, footer, 'lg');
            },

            // Generate sequential guard ID: guard-001, guard-002, etc.
            generateGuardId: function () {
                const guards = DataStore.getGuards() || [];
                const maxNum = guards.reduce((max, g) => {
                    const match = g.id?.match(/^guard-(\d+)$/);
                    return match ? Math.max(max, parseInt(match[1])) : max;
                }, 0);
                return `guard-${String(maxNum + 1).padStart(3, '0')}`;
            },

            createGuard: function () {
                const form = document.getElementById('new-guard-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const guards = DataStore.getGuards();
                const status = document.getElementById('new-guard-status').value;

                // Get selected primary sites
                const siteCheckboxes = document.querySelectorAll('input[name="new-guard-sites"]:checked');
                const primarySites = Array.from(siteCheckboxes).map(cb => cb.value);

                // Get preferred shifts
                const shiftCheckboxes = document.querySelectorAll('input[name="new-guard-shifts"]:checked');
                const preferredShifts = Array.from(shiftCheckboxes).map(cb => cb.value);

                const fullName = document.getElementById('new-guard-name').value.trim();
                const nameParts = fullName.split(' ');
                
                const newGuard = {
                    id: this.generateGuardId(),
                    name: fullName,
                    firstName: nameParts[0] || '',
                    lastName: nameParts.slice(1).join(' ') || '',
                    phone: document.getElementById('new-guard-phone').value.replace(/\D/g, ''),
                    email: document.getElementById('new-guard-email').value,
                    primarySites: primarySites,
                    role: document.getElementById('new-guard-role').value,
                    status: status,
                    
                    // Employment
                    hireDate: document.getElementById('new-guard-hire-date').value || null,
                    hourlyRate: parseFloat(document.getElementById('new-guard-rate').value) || null,
                    
                    // Certifications
                    certifications: {
                        sora: {
                            number: document.getElementById('new-guard-sora').value.trim() || null,
                            expiration: document.getElementById('new-guard-sora-exp').value || null
                        },
                        armedLicense: {
                            number: document.getElementById('new-guard-armed-license').value.trim() || null,
                            expiration: document.getElementById('new-guard-armed-exp').value || null
                        },
                        driversLicense: {
                            number: document.getElementById('new-guard-dl').value.trim() || null,
                            expiration: document.getElementById('new-guard-dl-exp').value || null
                        }
                    },
                    
                    // Emergency contact
                    emergencyContact: {
                        name: document.getElementById('new-guard-emergency-name').value.trim() || null,
                        relationship: document.getElementById('new-guard-emergency-relation').value || null,
                        phone: document.getElementById('new-guard-emergency-phone').value.replace(/\D/g, '') || null
                    },
                    
                    // Availability
                    availability: {
                        preferredShifts: preferredShifts,
                        maxHoursPerWeek: parseInt(document.getElementById('new-guard-max-hours').value) || 40,
                        hasVehicle: document.getElementById('new-guard-vehicle').value === 'yes'
                    },
                    
                    // Notes
                    notes: document.getElementById('new-guard-notes').value.trim() || '',
                    
                    // History
                    disciplinaryHistory: [],
                    trainingHistory: [],
                    
                    // Metadata
                    createdAt: new Date().toISOString(),
                    updatedAt: null
                };

                // Add suspension data if status is suspended
                if (status === 'suspended') {
                    newGuard.suspensionStart = document.getElementById('new-suspension-start').value;
                    newGuard.suspensionEnd = document.getElementById('new-suspension-end').value;
                    newGuard.suspensionNotes = document.getElementById('new-suspension-notes').value;
                }

                guards.push(newGuard);
                DataStore.saveGuards(guards);
                UI.closeModal();
                this.renderTable();
                UI.toast('Guard Added', `${newGuard.name} has been added to the roster.`, 'success');
            },

            toggleSuspensionFields: function (prefix) {
                const statusSelect = document.getElementById(`${prefix}-guard-status`);
                const suspensionFields = document.getElementById(`${prefix}-suspension-fields`);

                if (statusSelect && suspensionFields) {
                    suspensionFields.style.display = statusSelect.value === 'suspended' ? 'block' : 'none';
                }
            },

            deleteGuard: async function (id) {
                const guard = DataStore.getGuardById(id);
                if (!guard) return;

                const confirmed = await UI.confirm(
                    'Delete Guard',
                    `Are you sure you want to delete "${guard.name}"? This will remove them from the roster but will NOT remove them from existing schedules.`
                );

                if (!confirmed) return;

                const guards = DataStore.getGuards();
                const idx = guards.findIndex(g => g.id === id);

                if (idx !== -1) {
                    guards.splice(idx, 1);
                    DataStore.saveGuards(guards);
                    this.renderTable();
                    UI.toast('Guard Deleted', `${guard.name} has been removed from the roster.`, 'success');
                }
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // REPORTS MODULE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const ReportsModule = {
            editingReportId: null, // Track if we're editing an existing report

            // Generate sequential ID: DOR-YYYYMMDD-####
            generateReportId: function (reportDate) {
                const dateStr = reportDate.replace(/-/g, '');
                const datePrefix = `DOR-${dateStr}`;
                const reports = DataStore.getDailyReports();
                const sameDateReports = reports.filter(r => r.id && r.id.startsWith(datePrefix));
                const seq = String(sameDateReports.length + 1).padStart(4, '0');
                return `${datePrefix}-${seq}`;
            },

            init: function () {
                document.getElementById('daily-report-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveReport();
                });

                document.getElementById('export-report-pdf')?.addEventListener('click', () => window.print());

                // Tab switching
                document.querySelectorAll('#section-reports .tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('#section-reports .tab').forEach(t => {
                            t.classList.remove('active');
                            t.setAttribute('aria-selected', 'false');
                        });
                        document.querySelectorAll('#section-reports .tab-content').forEach(c => c.classList.remove('active'));

                        tab.classList.add('active');
                        tab.setAttribute('aria-selected', 'true');
                        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
                    });
                });
            },

            render: function () {
                this.setDefaultDate();
                this.renderHistory();
            },

            setDefaultDate: function () {
                document.getElementById('report-date').value = Utils.toISODate(new Date());
            },

            clearForm: function () {
                document.getElementById('daily-report-form').reset();
                this.setDefaultDate();
                this.editingReportId = null;
            },

            saveReport: function () {
                const reportDate = document.getElementById('report-date').value;
                if (!reportDate) {
                    UI.toast('Missing Date', 'Please select a report date.', 'error');
                    return;
                }

                const reportData = {
                    date: reportDate,
                    sitesCovered: parseInt(document.getElementById('report-sites-covered').value) || 0,
                    callOffs: document.getElementById('report-calloffs').value.trim(),
                    incidents: document.getElementById('report-incidents').value.trim(),
                    extraGuards: document.getElementById('report-extra-guards').value.trim(),
                    suppliesNeeded: document.getElementById('report-supplies').value.trim(),
                    training: document.getElementById('report-training').value.trim(),
                    notes: document.getElementById('report-notes').value.trim()
                };

                // Check if we're editing an existing report or if one exists for this date
                const existingById = this.editingReportId ? 
                    DataStore.getDailyReports().find(r => r.id === this.editingReportId) : null;
                const existingByDate = DataStore.getDailyReports().find(r => r.date === reportDate);

                if (existingById) {
                    // Updating via edit mode
                    DataStore.updateDailyReport(existingById.id, reportData);
                    UI.toast('Report Updated', `Daily report for ${Utils.formatDate(reportDate)} has been updated.`, 'success');
                } else if (existingByDate) {
                    // Report for this date already exists - update it
                    DataStore.updateDailyReport(existingByDate.id, reportData);
                    UI.toast('Report Updated', `Daily report for ${Utils.formatDate(reportDate)} has been updated.`, 'success');
                } else {
                    // Create new report
                    const report = {
                        id: this.generateReportId(reportDate),
                        ...reportData,
                        createdAt: new Date().toISOString(),
                        createdBy: 'Mike Howard'
                    };
                    DataStore.addDailyReport(report);
                    UI.toast('Report Saved', `Daily report for ${Utils.formatDate(reportDate)} has been saved.`, 'success');
                }

                this.clearForm();
                this.renderHistory();
            },

            renderHistory: function () {
                let reports = DataStore.getDailyReports();
                const tbody = document.getElementById('reports-tbody');

                if (reports.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-muted" style="text-align: center; padding: var(--space-8);">No reports found</td></tr>';
                    return;
                }

                // Sort by date descending (newest first)
                reports = [...reports].sort((a, b) => {
                    const dateA = a.date || '';
                    const dateB = b.date || '';
                    return dateB.localeCompare(dateA);
                });

                tbody.innerHTML = reports.map(rpt => {
                    const calloffCount = rpt.callOffs ? rpt.callOffs.split('\n').filter(l => l.trim()).length : 0;
                    const incidentMentions = rpt.incidents ? 'Yes' : 'None';

                    return `
                    <tr>
                        <td data-label="Date"><span class="font-medium">${Utils.formatDate(rpt.date)}</span></td>
                        <td data-label="Sites Covered">${rpt.sitesCovered}</td>
                        <td data-label="Call-offs">${calloffCount}</td>
                        <td data-label="Incidents">${incidentMentions}</td>
                        <td data-label="Actions">
                            <button class="btn btn-sm btn-ghost" onclick="ReportsModule.viewReport('${rpt.id}')" title="View">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                            </button>
                            <button class="btn btn-sm btn-ghost" onclick="ReportsModule.editReport('${rpt.id}')" title="Edit">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                            </button>
                            <button class="btn btn-sm btn-ghost" style="color: var(--color-danger);" onclick="ReportsModule.deleteReport('${rpt.id}')" title="Delete">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                            </button>
                        </td>
                    </tr>
                `;
                }).join('');
            },

            viewReport: function (id) {
                const rpt = DataStore.getDailyReports().find(r => r.id === id);
                if (!rpt) return;

                const content = `
                <div class="mb-4">
                    <div class="text-sm text-muted">Date</div>
                    <div class="font-medium">${Utils.formatDate(rpt.date)}</div>
                </div>
                <div class="mb-4">
                    <div class="text-sm text-muted">Sites Covered</div>
                    <div>${rpt.sitesCovered}</div>
                </div>
                ${rpt.callOffs ? `<div class="mb-4"><div class="text-sm text-muted">Call-offs & Replacements</div><div style="white-space: pre-wrap;">${Utils.escapeHtml(rpt.callOffs)}</div></div>` : ''}
                ${rpt.incidents ? `<div class="mb-4"><div class="text-sm text-muted">Incidents</div><div style="white-space: pre-wrap;">${Utils.escapeHtml(rpt.incidents)}</div></div>` : ''}
                ${rpt.extraGuards ? `<div class="mb-4"><div class="text-sm text-muted">Extra Guards</div><div style="white-space: pre-wrap;">${Utils.escapeHtml(rpt.extraGuards)}</div></div>` : ''}
                ${rpt.suppliesNeeded ? `<div class="mb-4"><div class="text-sm text-muted">Supplies Needed</div><div style="white-space: pre-wrap;">${Utils.escapeHtml(rpt.suppliesNeeded)}</div></div>` : ''}
                ${rpt.training ? `<div class="mb-4"><div class="text-sm text-muted">Training</div><div style="white-space: pre-wrap;">${Utils.escapeHtml(rpt.training)}</div></div>` : ''}
                ${rpt.notes ? `<div class="mb-4"><div class="text-sm text-muted">Notes</div><div style="white-space: pre-wrap;">${Utils.escapeHtml(rpt.notes)}</div></div>` : ''}
                ${rpt.createdAt ? `<div class="mb-4"><div class="text-sm text-muted">Created</div><div>${Utils.formatDateTime(rpt.createdAt)}${rpt.createdBy ? ` by ${rpt.createdBy}` : ''}</div></div>` : ''}
            `;

                const footer = `<button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>`;
                UI.openModal(`Daily Report - ${Utils.formatDate(rpt.date)}`, content, footer, 'lg');
            },

            editReport: function (id) {
                const rpt = DataStore.getDailyReports().find(r => r.id === id);
                if (!rpt) return;

                // Set editing state
                this.editingReportId = id;

                // Populate form with report data
                document.getElementById('report-date').value = rpt.date || '';
                document.getElementById('report-sites-covered').value = rpt.sitesCovered || 13;
                document.getElementById('report-calloffs').value = rpt.callOffs || '';
                document.getElementById('report-incidents').value = rpt.incidents || '';
                document.getElementById('report-extra-guards').value = rpt.extraGuards || '';
                document.getElementById('report-supplies').value = rpt.suppliesNeeded || '';
                document.getElementById('report-training').value = rpt.training || '';
                document.getElementById('report-notes').value = rpt.notes || '';

                // Switch to New Report tab
                document.querySelectorAll('#section-reports .tab').forEach(t => {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                });
                document.querySelectorAll('#section-reports .tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector('#section-reports .tab[data-tab="report-new"]').classList.add('active');
                document.querySelector('#section-reports .tab[data-tab="report-new"]').setAttribute('aria-selected', 'true');
                document.getElementById('tab-report-new').classList.add('active');

                UI.toast('Editing Report', `Editing report for ${Utils.formatDate(rpt.date)}. Make changes and click Save.`, 'info');
            },

            deleteReport: function (id) {
                const rpt = DataStore.getDailyReports().find(r => r.id === id);
                if (!rpt) return;

                UI.confirm(
                    'Delete Report',
                    `Are you sure you want to delete the report for ${Utils.formatDate(rpt.date)}? This cannot be undone.`,
                    () => {
                        DataStore.deleteDailyReport(id);
                        this.renderHistory();
                        UI.toast('Report Deleted', `Daily report for ${Utils.formatDate(rpt.date)} has been deleted.`, 'success');
                    }
                );
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ANALYTICS MODULE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DATE UTILS â€” Centralized date filtering
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const DateUtils = {
            isWithin: function (dateStr, range) {
                if (!range) return true;
                if (!dateStr) return false;
                const d = (dateStr || '').slice(0, 10); // 'YYYY-MM-DD'
                const inStart = !range.start || d >= range.start;
                const inEnd = !range.end || d <= range.end;
                return inStart && inEnd;
            },

            getDateField: function (record) {
                return record.date || record.incidentDate || record.inspectionDate ||
                    record.dateTime?.slice(0, 10) || record.createdAt?.slice(0, 10) || null;
            },

            // Preset date ranges
            today: function () {
                const today = Utils.toISODate(new Date());
                return { start: today, end: today };
            },

            thisWeek: function () {
                const today = new Date();
                const dayOfWeek = today.getDay();
                const start = new Date(today);
                start.setDate(today.getDate() - dayOfWeek); // Sunday
                return { start: Utils.toISODate(start), end: Utils.toISODate(today) };
            },

            last7Days: function () {
                const today = new Date();
                const start = new Date(today);
                start.setDate(today.getDate() - 6);
                return { start: Utils.toISODate(start), end: Utils.toISODate(today) };
            },

            last30Days: function () {
                const today = new Date();
                const start = new Date(today);
                start.setDate(today.getDate() - 29);
                return { start: Utils.toISODate(start), end: Utils.toISODate(today) };
            },

            last90Days: function () {
                const today = new Date();
                const start = new Date(today);
                start.setDate(today.getDate() - 89);
                return { start: Utils.toISODate(start), end: Utils.toISODate(today) };
            },

            thisMonth: function () {
                const today = new Date();
                const start = new Date(today.getFullYear(), today.getMonth(), 1);
                return { start: Utils.toISODate(start), end: Utils.toISODate(today) };
            },

            fromDays: function (days) {
                const today = new Date();
                const start = new Date(today);
                start.setDate(today.getDate() - (days - 1));
                return { start: Utils.toISODate(start), end: Utils.toISODate(today) };
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ANALYTICS MODULE â€” Canonical KPI Computation
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const AnalyticsModule = {
            init: function () {
                document.getElementById('analytics-range')?.addEventListener('change', () => this.render());
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // COMPUTE FUNCTIONS â€” Return data objects, no DOM manipulation
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            /**
             * Compute coverage summary from schedules and call-offs
             * @param {Object} dateRange - { start: 'YYYY-MM-DD', end: 'YYYY-MM-DD' }
             * @returns {Object} Coverage metrics
             */
            computeCoverageSummary: function (dateRange) {
                const schedules = DataStore.getAllSchedules();
                const calloffs = DataStore.getCalloffs();

                // Filter schedules by date range
                const filteredSchedules = schedules.filter(s =>
                    DateUtils.isWithin(s.date, dateRange)
                );

                const totalShifts = filteredSchedules.length;
                const coveredShifts = filteredSchedules.filter(s => s.guardId && s.status !== 'OPEN').length;
                const openShifts = totalShifts - coveredShifts;
                const coverageRate = totalShifts === 0 ? 1.0 : coveredShifts / totalShifts;

                // Filter call-offs by date range
                const filteredCalloffs = (calloffs || []).filter(c =>
                    DateUtils.isWithin(c.date, dateRange)
                );

                const calloffCount = filteredCalloffs.length;
                const coveredCalloffs = filteredCalloffs.filter(c =>
                    c.status === 'covered' || c.replacementGuardId
                ).length;
                const uncoveredCalloffs = calloffCount - coveredCalloffs;
                const pendingCalloffs = filteredCalloffs.filter(c =>
                    c.status === 'pending' || (!c.replacementGuardId && c.status !== 'covered')
                ).length;

                return {
                    totalShifts,
                    coveredShifts,
                    openShifts,
                    coverageRate,
                    coveragePercent: Math.round(coverageRate * 100),
                    calloffCount,
                    coveredCalloffs,
                    uncoveredCalloffs,
                    pendingCalloffs
                };
            },

            /**
             * Compute incident summary with status and severity breakdown
             * @param {Object} dateRange - { start: 'YYYY-MM-DD', end: 'YYYY-MM-DD' }
             * @returns {Object} Incident metrics
             */
            computeIncidentSummary: function (dateRange) {
                const incidents = DataStore.getIncidents();

                // Filter by date range
                const filtered = incidents.filter(i => {
                    const dateStr = DateUtils.getDateField(i);
                    return DateUtils.isWithin(dateStr, dateRange);
                });

                const normalizeStatus = (s) => (s || '').toLowerCase().trim();
                const normalizeSeverity = (s) => (s || 'medium').toLowerCase().trim();
                
                // Helper to check if incident is open (not resolved/closed)
                const isOpen = (i) => !['resolved', 'closed'].includes(normalizeStatus(i.status));

                const total = filtered.length;
                const open = filtered.filter(i => normalizeStatus(i.status) === 'open').length;
                const inProgress = filtered.filter(i =>
                    normalizeStatus(i.status) === 'in progress' ||
                    normalizeStatus(i.status) === 'under investigation'
                ).length;
                const resolved = filtered.filter(i =>
                    normalizeStatus(i.status) === 'resolved' ||
                    normalizeStatus(i.status) === 'closed'
                ).length;

                const bySeverity = {
                    critical: filtered.filter(i => normalizeSeverity(i.severity) === 'critical').length,
                    high: filtered.filter(i => normalizeSeverity(i.severity) === 'high').length,
                    medium: filtered.filter(i => normalizeSeverity(i.severity) === 'medium').length,
                    low: filtered.filter(i => normalizeSeverity(i.severity) === 'low').length
                };

                // High priority = only OPEN critical + high incidents
                const highPriority = filtered.filter(i => 
                    isOpen(i) && 
                    (normalizeSeverity(i.severity) === 'critical' || normalizeSeverity(i.severity) === 'high')
                ).length;

                return {
                    total,
                    open,
                    inProgress,
                    resolved,
                    bySeverity,
                    highPriority,
                    // For backward compatibility with UI
                    Critical: bySeverity.critical,
                    High: bySeverity.high,
                    Medium: bySeverity.medium,
                    Low: bySeverity.low
                };
            },

            /**
             * Compute incidents grouped by site
             * @param {Object} dateRange - { start: 'YYYY-MM-DD', end: 'YYYY-MM-DD' }
             * @returns {Object} Site incident breakdown
             */
            computeIncidentsBySite: function (dateRange) {
                const incidents = DataStore.getIncidents();
                const sites = DataStore.getSites();

                // Only count OPEN incidents as "issues"
                const filtered = incidents.filter(i => {
                    // Exclude resolved/closed - they're not active issues
                    if (['Resolved', 'Closed'].includes(i.status)) return false;
                    
                    const dateStr = DateUtils.getDateField(i);
                    return DateUtils.isWithin(dateStr, dateRange);
                });

                // Group by siteId
                const counts = {};
                filtered.forEach(i => {
                    const siteId = i.siteId || 'unknown';
                    counts[siteId] = (counts[siteId] || 0) + 1;
                });

                // Build array with site names
                const bySite = Object.entries(counts)
                    .map(([siteId, count]) => {
                        const site = sites.find(s => s.id === siteId);
                        return {
                            siteId,
                            siteName: site?.name || 'Unknown Site',
                            count
                        };
                    })
                    .sort((a, b) => b.count - a.count);

                const topSite = bySite.length > 0 ? bySite[0] : null;

                return {
                    bySite,
                    topSite,
                    sitesWithIncidents: bySite.length
                };
            },

            /**
             * Compute inspection summary with pass/fail and follow-up tracking
             * @param {Object} dateRange - { start: 'YYYY-MM-DD', end: 'YYYY-MM-DD' }
             * @returns {Object} Inspection metrics
             */
            computeInspectionSummary: function (dateRange) {
                const inspections = DataStore.getInspections();

                const filtered = inspections.filter(i => {
                    const dateStr = DateUtils.getDateField(i);
                    return DateUtils.isWithin(dateStr, dateRange);
                });

                const normalizeStatus = (s) => (s || '').toLowerCase().trim();

                const total = filtered.length;
                const passed = filtered.filter(i =>
                    normalizeStatus(i.status) === 'pass' ||
                    normalizeStatus(i.status) === 'passed' ||
                    normalizeStatus(i.status) === 'satisfactory'
                ).length;
                const failed = filtered.filter(i =>
                    normalizeStatus(i.status) === 'fail' ||
                    normalizeStatus(i.status) === 'failed' ||
                    normalizeStatus(i.status) === 'unsatisfactory'
                ).length;
                const needsFollowUp = filtered.filter(i =>
                    i.followUpRequired === true ||
                    normalizeStatus(i.status) === 'needs follow-up'
                ).length;

                const completedFollowUps = filtered.filter(i =>
                    i.followUpRequired && i.followUpStatus === 'complete'
                ).length;
                const pendingFollowUps = needsFollowUp - completedFollowUps;
                const passRate = total === 0 ? 1.0 : passed / total;

                return {
                    total,
                    passed,
                    failed,
                    needsFollowUp,
                    completedFollowUps,
                    pendingFollowUps,
                    passRate,
                    passPercent: Math.round(passRate * 100),
                    // For backward compatibility
                    Pass: passed,
                    Fail: failed,
                    'Needs Follow-Up': needsFollowUp
                };
            },

            /**
             * Compute call-off summary with breakdown by site and reason
             * @param {Object} dateRange - { start: 'YYYY-MM-DD', end: 'YYYY-MM-DD' }
             * @returns {Object} Call-off metrics
             */
            computeCalloffSummary: function (dateRange) {
                const calloffs = DataStore.getCalloffs();
                const sites = DataStore.getSites();
                const guards = DataStore.getGuards();

                const filtered = calloffs.filter(c =>
                    DateUtils.isWithin(c.date, dateRange)
                );

                const total = filtered.length;
                const covered = filtered.filter(c =>
                    c.status === 'covered' || c.replacementGuardId
                ).length;
                const uncovered = total - covered;
                const pending = filtered.filter(c =>
                    c.status === 'pending' || (!c.replacementGuardId && c.status !== 'covered')
                ).length;

                // By site
                const siteCounts = {};
                filtered.forEach(c => {
                    const siteId = c.siteId || 'unknown';
                    siteCounts[siteId] = (siteCounts[siteId] || 0) + 1;
                });
                const bySite = Object.entries(siteCounts)
                    .map(([siteId, count]) => {
                        const site = sites.find(s => s.id === siteId);
                        return { siteId, siteName: site?.name || 'Unknown', count };
                    })
                    .sort((a, b) => b.count - a.count);

                // By reason
                const byReason = { sick: 0, emergency: 0, noShow: 0, personal: 0, other: 0 };
                filtered.forEach(c => {
                    const reason = (c.reason || 'other').toLowerCase();
                    if (reason.includes('sick') || reason.includes('illness')) byReason.sick++;
                    else if (reason.includes('emergency') || reason.includes('family')) byReason.emergency++;
                    else if (reason.includes('no show') || reason.includes('noshow') || reason.includes('ncns')) byReason.noShow++;
                    else if (reason.includes('personal')) byReason.personal++;
                    else byReason.other++;
                });

                // Repeat offenders (guards with 2+ call-offs)
                const guardCounts = {};
                filtered.forEach(c => {
                    if (c.guardId) {
                        guardCounts[c.guardId] = (guardCounts[c.guardId] || 0) + 1;
                    }
                });
                const repeatOffenders = Object.entries(guardCounts)
                    .filter(([, count]) => count >= 2)
                    .map(([guardId, count]) => {
                        const guard = guards.find(g => g.id === guardId);
                        return { guardId, guardName: guard?.name || 'Unknown', count };
                    })
                    .sort((a, b) => b.count - a.count);

                return {
                    total,
                    covered,
                    uncovered,
                    pending,
                    bySite,
                    byReason,
                    repeatOffenders
                };
            },

            /**
             * Compute communications summary with follow-up tracking
             * @param {Object} dateRange - { start: 'YYYY-MM-DD', end: 'YYYY-MM-DD' }
             * @returns {Object} Communications metrics
             */
            computeCommunicationsSummary: function (dateRange) {
                const comms = DataStore.getCommunications();

                const filtered = comms.filter(c => {
                    const dateStr = DateUtils.getDateField(c);
                    return DateUtils.isWithin(dateStr, dateRange);
                });

                const total = filtered.length;

                // By type
                const byType = { email: 0, phone: 0, inPerson: 0, text: 0, other: 0 };
                filtered.forEach(c => {
                    const type = (c.type || 'other').toLowerCase();
                    if (type.includes('email')) byType.email++;
                    else if (type.includes('phone') || type.includes('call')) byType.phone++;
                    else if (type.includes('person') || type.includes('face')) byType.inPerson++;
                    else if (type.includes('text') || type.includes('sms')) byType.text++;
                    else byType.other++;
                });

                // By party
                const byParty = { client: 0, guard: 0, vendor: 0, internal: 0, other: 0 };
                filtered.forEach(c => {
                    const party = (c.party || 'other').toLowerCase();
                    if (party.includes('client')) byParty.client++;
                    else if (party.includes('guard') || party.includes('officer')) byParty.guard++;
                    else if (party.includes('vendor')) byParty.vendor++;
                    else if (party.includes('internal') || party.includes('team')) byParty.internal++;
                    else byParty.other++;
                });

                // Follow-ups
                const followUpRequired = filtered.filter(c => c.followUpRequired).length;
                const followUpComplete = filtered.filter(c =>
                    c.followUpRequired && c.followUpStatus === 'complete'
                ).length;
                const followUpPending = followUpRequired - followUpComplete;

                return {
                    total,
                    byType,
                    byParty,
                    followUpRequired,
                    followUpComplete,
                    followUpPending
                };
            },

            /**
             * Compute guard metrics
             * @param {Object} dateRange - { start: 'YYYY-MM-DD', end: 'YYYY-MM-DD' }
             * @returns {Object} Guard metrics
             */
            computeGuardMetrics: function (dateRange) {
                const guards = DataStore.getGuards();
                const schedules = DataStore.getAllSchedules();

                const totalGuards = guards.length;
                const activeGuards = guards.filter(g => g.status === 'active').length;
                const inactiveGuards = totalGuards - activeGuards;

                // Guards scheduled in date range
                const filteredSchedules = schedules.filter(s =>
                    DateUtils.isWithin(s.date, dateRange) && s.guardId
                );
                const scheduledGuardIds = new Set(filteredSchedules.map(s => s.guardId));
                const scheduledCount = scheduledGuardIds.size;

                // Simple hours calculation (8 hours per shift assumption)
                const hoursByGuard = {};
                filteredSchedules.forEach(s => {
                    if (s.guardId) {
                        hoursByGuard[s.guardId] = (hoursByGuard[s.guardId] || 0) + 8;
                    }
                });

                const hoursValues = Object.values(hoursByGuard);
                const totalHours = hoursValues.reduce((sum, h) => sum + h, 0);
                const avgHours = scheduledCount > 0 ? Math.round(totalHours / scheduledCount) : 0;
                const atRisk = hoursValues.filter(h => h >= 40).length;

                return {
                    totalGuards,
                    activeGuards,
                    inactiveGuards,
                    scheduledThisRange: scheduledCount,
                    hoursThisRange: {
                        total: totalHours,
                        average: avgHours,
                        atRisk
                    }
                };
            },

            /**
             * Compute daily coverage for a range (for line charts)
             * @param {Object} dateRange - { start: 'YYYY-MM-DD', end: 'YYYY-MM-DD' }
             * @returns {Array} Daily coverage data points
             */
            computeDailyCoverage: function (dateRange) {
                const schedules = DataStore.getAllSchedules();
                const data = [];

                // Get all dates in range
                const start = new Date(dateRange.start + 'T00:00:00');
                const end = new Date(dateRange.end + 'T00:00:00');

                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const dateStr = Utils.toISODate(d);
                    const daySchedules = schedules.filter(s => s.date === dateStr);
                    const total = daySchedules.length;
                    const covered = daySchedules.filter(s => s.guardId && s.status !== 'OPEN').length;
                    const rate = total === 0 ? 100 : Math.round((covered / total) * 100);

                    data.push({
                        date: dateStr,
                        label: new Date(dateStr + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                        total,
                        covered,
                        rate
                    });
                }

                return data;
            },

            /**
             * Aggregated dashboard summary
             * @param {Object} dateRange - { start: 'YYYY-MM-DD', end: 'YYYY-MM-DD' }
             * @returns {Object} All metrics combined
             */
            computeDashboardSummary: function (dateRange) {
                return {
                    coverage: this.computeCoverageSummary(dateRange),
                    incidents: this.computeIncidentSummary(dateRange),
                    incidentsBySite: this.computeIncidentsBySite(dateRange),
                    inspections: this.computeInspectionSummary(dateRange),
                    calloffs: this.computeCalloffSummary(dateRange),
                    communications: this.computeCommunicationsSummary(dateRange),
                    guards: this.computeGuardMetrics(dateRange)
                };
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // RENDER FUNCTIONS â€” Use compute functions, then draw
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            render: function () {
                const days = parseInt(document.getElementById('analytics-range')?.value || 30);
                const dateRange = DateUtils.fromDays(days);

                this.renderIncidentsBySeverity(dateRange);
                this.renderCoverageRate(dateRange);
                this.renderIncidentsBySite(dateRange);
                this.renderInspectionResults(dateRange);
            },

            renderIncidentsBySeverity: function (dateRange) {
                const canvas = document.getElementById('canvas-incidents-severity');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');

                // Use compute function
                const summary = this.computeIncidentSummary(dateRange);
                const labels = ['Critical', 'High', 'Medium', 'Low'];
                const data = [summary.Critical, summary.High, summary.Medium, summary.Low];
                const colors = ['#ef4444', '#f59e0b', '#3b82f6', '#10b981'];

                this.drawBarChart(ctx, canvas, labels, data, colors);
            },

            renderCoverageRate: function (dateRange) {
                const canvas = document.getElementById('canvas-coverage');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');

                // Use compute function - REAL DATA, not random
                const dailyData = this.computeDailyCoverage(dateRange);

                // Sample to ~7 points for readability
                const step = Math.max(1, Math.ceil(dailyData.length / 7));
                const sampled = dailyData.filter((_, i) => i % step === 0 || i === dailyData.length - 1);

                const labels = sampled.map(d => d.label);
                const data = sampled.map(d => d.rate);

                this.drawLineChart(ctx, canvas, labels, data);
            },

            renderIncidentsBySite: function (dateRange) {
                const canvas = document.getElementById('canvas-incidents-site');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');

                // Use compute function
                const summary = this.computeIncidentsBySite(dateRange);
                const top5 = summary.bySite.slice(0, 5);

                const labels = top5.map(s => s.siteName.split(' ')[0]); // First word only
                const data = top5.map(s => s.count);

                this.drawBarChart(ctx, canvas, labels, data, ['#3b82f6']);
            },

            renderInspectionResults: function (dateRange) {
                const canvas = document.getElementById('canvas-inspections');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');

                // Use compute function
                const summary = this.computeInspectionSummary(dateRange);
                const labels = ['Pass', 'Fail', 'Needs Follow-Up'];
                const data = [summary.Pass, summary.Fail, summary['Needs Follow-Up']];
                const colors = ['#10b981', '#ef4444', '#f59e0b'];

                this.drawBarChart(ctx, canvas, labels, data, colors);
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CHART DRAWING HELPERS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            drawBarChart: function (ctx, canvas, labels, data, colors) {
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (labels.length === 0 || data.every(d => d === 0)) {
                    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--color-text-muted');
                    ctx.font = '12px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('No data for selected range', canvas.width / 2, canvas.height / 2);
                    return;
                }

                const padding = 40;
                const chartWidth = canvas.width - padding * 2;
                const chartHeight = canvas.height - padding * 2;
                const maxVal = Math.max(...data, 1);
                const barWidth = chartWidth / (labels.length * 2);

                labels.forEach((label, i) => {
                    const x = padding + (i * 2 + 0.5) * barWidth;
                    const barHeight = (data[i] / maxVal) * chartHeight;
                    const y = padding + chartHeight - barHeight;

                    ctx.fillStyle = colors[i % colors.length];
                    ctx.fillRect(x, y, barWidth, barHeight);

                    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--color-text-muted');
                    ctx.font = '11px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(label, x + barWidth / 2, canvas.height - 10);

                    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--color-text');
                    ctx.fillText(data[i], x + barWidth / 2, y - 5);
                });
            },

            drawLineChart: function (ctx, canvas, labels, data) {
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (labels.length === 0) {
                    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--color-text-muted');
                    ctx.font = '12px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('No data for selected range', canvas.width / 2, canvas.height / 2);
                    return;
                }

                const padding = 40;
                const chartWidth = canvas.width - padding * 2;
                const chartHeight = canvas.height - padding * 2;
                const maxVal = Math.max(...data, 100);
                const minVal = Math.min(...data, 0);
                const range = maxVal - minVal || 1;

                // Draw line
                ctx.beginPath();
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 2;

                labels.forEach((label, i) => {
                    const x = padding + (labels.length === 1 ? chartWidth / 2 : (i / (labels.length - 1)) * chartWidth);
                    const y = padding + chartHeight - ((data[i] - minVal) / range) * chartHeight;

                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();

                // Draw points and labels
                labels.forEach((label, i) => {
                    const x = padding + (labels.length === 1 ? chartWidth / 2 : (i / (labels.length - 1)) * chartWidth);
                    const y = padding + chartHeight - ((data[i] - minVal) / range) * chartHeight;

                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fillStyle = '#3b82f6';
                    ctx.fill();

                    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--color-text-muted');
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(label, x, canvas.height - 10);

                    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--color-text');
                    ctx.fillText(data[i] + '%', x, y - 10);
                });
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AVAILABILITY MODULE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const AvailabilityModule = {
            currentWeekStart: null,
            selectedGuardId: null,

            init: function () {
                const now = new Date();
                const dayOfWeek = now.getDay();
                const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                this.currentWeekStart = new Date(now.setDate(diff));
                this.currentWeekStart.setHours(0, 0, 0, 0);

                document.getElementById('avail-prev-week')?.addEventListener('click', () => this.changeWeek(-1));
                document.getElementById('avail-next-week')?.addEventListener('click', () => this.changeWeek(1));
                document.getElementById('avail-guard-select')?.addEventListener('change', (e) => {
                    this.selectedGuardId = e.target.value;
                    this.renderGuardAvailability();
                });
                document.getElementById('save-availability')?.addEventListener('click', () => this.saveAvailability());

                document.querySelectorAll('#section-availability .tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('#section-availability .tab').forEach(t => {
                            t.classList.remove('active');
                            t.setAttribute('aria-selected', 'false');
                        });
                        tab.classList.add('active');
                        tab.setAttribute('aria-selected', 'true');

                        document.querySelectorAll('#section-availability .tab-content').forEach(c => c.classList.remove('active'));
                        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');

                        if (tab.dataset.tab === 'avail-records') {
                            this.renderRecords();
                        } else if (tab.dataset.tab === 'avail-overview') {
                            this.renderOverview();
                        } else if (tab.dataset.tab === 'avail-calendar') {
                            this.renderCalendar();
                        }
                    });
                });

                // Records tab filters
                document.getElementById('avail-records-guard-filter')?.addEventListener('change', () => this.renderRecords());
                document.getElementById('avail-records-status-filter')?.addEventListener('change', () => this.renderRecords());
                document.getElementById('avail-records-date-filter')?.addEventListener('change', () => this.renderRecords());

                // Initialize calendar variables
                this.initCalendar();
            },

            changeWeek: function (delta) {
                this.currentWeekStart.setDate(this.currentWeekStart.getDate() + (delta * 7));
                this.render();
            },

            render: function () {
                this.updateWeekLabel();
                this.populateGuardSelect();
                this.populateSiteFilter();
                this.renderGuardAvailability();
                this.renderOverview();
                this.renderCalendar();
                this.populateRecordsFilters();
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // RECORDS TAB â€” Individual availability records view
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            populateRecordsFilters: function () {
                const guardFilter = document.getElementById('avail-records-guard-filter');
                if (guardFilter && guardFilter.options.length <= 1) {
                    const guards = DataStore.getActiveGuards();
                    guardFilter.innerHTML = `
                        <option value="">All Guards</option>
                        ${guards.map(g => `<option value="${g.id}">${Utils.escapeHtml(g.name)}</option>`).join('')}
                    `;
                }
            },

            renderRecords: function () {
                const container = document.getElementById('availability-records-table');
                if (!container) return;

                const guardFilter = document.getElementById('avail-records-guard-filter')?.value || '';
                const statusFilter = document.getElementById('avail-records-status-filter')?.value || '';
                const dateFilter = document.getElementById('avail-records-date-filter')?.value || '';

                // Populate guard filter if needed
                this.populateRecordsFilters();

                // Get records from DataStore
                let records = DataStore.getAvailability() || [];
                const guards = DataStore.getGuards();
                const sites = DataStore.getSites();

                // Apply filters
                if (guardFilter) {
                    records = records.filter(r => r.guardId === guardFilter);
                }
                if (statusFilter) {
                    records = records.filter(r => r.status === statusFilter);
                }
                if (dateFilter) {
                    records = records.filter(r => r.date === dateFilter);
                }

                // Sort by date (newest first), then by guard name
                records.sort((a, b) => {
                    const dateCompare = (b.date || '').localeCompare(a.date || '');
                    if (dateCompare !== 0) return dateCompare;
                    const guardA = guards.find(g => g.id === a.guardId);
                    const guardB = guards.find(g => g.id === b.guardId);
                    return (guardA?.name || '').localeCompare(guardB?.name || '');
                });

                if (records.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: var(--space-8); text-align: center;">
                            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto var(--space-4); opacity: 0.5;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <p class="text-muted">No availability records found</p>
                            <p class="text-muted" style="font-size: var(--font-size-sm);">Submit availability using the "Submit Availability" tab</p>
                        </div>
                    `;
                    return;
                }

                // Status badge styling
                const getStatusBadge = (status) => {
                    const styles = {
                        'available': 'background: var(--color-success-bg); color: var(--color-success);',
                        'prefers': 'background: var(--color-warning-bg); color: var(--color-warning);',
                        'unavailable': 'background: var(--color-danger-bg); color: var(--color-danger);',
                        'blocked': 'background: var(--color-surface-elevated); color: var(--color-text-muted);'
                    };
                    const icons = {
                        'available': 'âœ“',
                        'prefers': 'â˜…',
                        'unavailable': 'âœ—',
                        'blocked': 'â›”'
                    };
                    return `<span class="badge" style="${styles[status] || ''}; padding: var(--space-1) var(--space-2); border-radius: var(--radius-sm); font-size: var(--font-size-xs);">${icons[status] || ''} ${status}</span>`;
                };

                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Guard</th>
                                <th>Date</th>
                                <th>Shift</th>
                                <th>Status</th>
                                <th>Site Pref</th>
                                <th>Source</th>
                                <th>Notes</th>
                                <th style="width: 80px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                records.forEach(record => {
                    const guard = guards.find(g => g.id === record.guardId);
                    const site = record.sitePreference ? sites.find(s => s.id === record.sitePreference) : null;
                    const dateFormatted = new Date(record.date + 'T00:00:00').toLocaleDateString('en-US', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric'
                    });

                    html += `
                        <tr>
                            <td style="font-family: var(--font-mono); font-size: var(--font-size-xs);">${Utils.escapeHtml(record.id || '')}</td>
                            <td>${Utils.escapeHtml(guard?.name || 'Unknown')}</td>
                            <td>${dateFormatted}</td>
                            <td>${Utils.escapeHtml(record.shiftLabel)}</td>
                            <td>${getStatusBadge(record.status)}</td>
                            <td>${Utils.escapeHtml(site?.name || '-')}</td>
                            <td>${Utils.escapeHtml(record.source || 'supervisor')}</td>
                            <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${Utils.escapeHtml(record.notes || '')}">${Utils.escapeHtml(record.notes || '-')}</td>
                            <td>
                                <button class="btn btn-sm btn-ghost" onclick="AvailabilityModule.deleteRecord('${record.id}')" title="Delete">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                    <div style="padding: var(--space-3); text-align: right; border-top: 1px solid var(--color-border);">
                        <span class="text-muted" style="font-size: var(--font-size-sm);">Showing ${records.length} record${records.length !== 1 ? 's' : ''}</span>
                    </div>
                `;

                container.innerHTML = html;
            },

            deleteRecord: function (recordId) {
                if (!confirm(`Delete availability record ${recordId}?`)) return;

                DataStore.deleteAvailability(recordId);
                UI.toast('Record Deleted', 'Availability record has been removed.', 'success');
                this.renderRecords();
            },

            updateWeekLabel: function () {
                const endDate = new Date(this.currentWeekStart);
                endDate.setDate(endDate.getDate() + 6);

                const startStr = this.currentWeekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const endStr = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                const label = document.getElementById('avail-week-label');
                if (label) label.textContent = `${startStr} â€“ ${endStr}`;
            },

            populateGuardSelect: function () {
                const select = document.getElementById('avail-guard-select');
                if (!select) return;

                const guards = DataStore.getActiveGuards();

                select.innerHTML = `
                <option value="">Select a guard...</option>
                ${guards.map(g => `<option value="${g.id}" ${g.id === this.selectedGuardId ? 'selected' : ''}>${Utils.escapeHtml(g.name)}</option>`).join('')}
            `;
            },

            renderGuardAvailability: function () {
                const container = document.getElementById('guard-availability-grid');
                if (!container) return;

                if (!this.selectedGuardId) {
                    container.innerHTML = `
                    <div class="empty-state" style="padding: var(--space-8); text-align: center;">
                        <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto var(--space-4); opacity: 0.5;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <p class="text-muted">Select a guard to view or edit their availability</p>
                    </div>
                `;
                    return;
                }

                const days = Utils.getDaysOfWeek(this.currentWeekStart);
                
                // Get availability for this guard for the week from array
                const startDate = Utils.toISODate(days[0]);
                const endDate = Utils.toISODate(days[6]);
                const guardAvailability = DataStore.getAvailabilityByGuard(this.selectedGuardId)
                    .filter(r => r.date >= startDate && r.date <= endDate);

                // Build a lookup: dateStr â†’ { status, shifts, notes }
                const availByDate = {};
                guardAvailability.forEach(r => {
                    if (!availByDate[r.date]) {
                        availByDate[r.date] = { 
                            status: r.status === 'prefers' ? 'preferred' : r.status, 
                            shifts: [], 
                            notes: r.notes || '' 
                        };
                    }
                    availByDate[r.date].shifts.push(r.shiftLabel);
                });

                let html = '<div class="availability-grid">';

                days.forEach(d => {
                    const dateStr = Utils.toISODate(d);
                    const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                    const dayNum = d.getDate();
                    const monthName = d.toLocaleDateString('en-US', { month: 'short' });
                    const isToday = dateStr === Utils.toISODate(new Date());
                    const isPast = d < new Date().setHours(0, 0, 0, 0);

                    const dayAvail = availByDate[dateStr] || { status: 'available', shifts: [], notes: '' };
                    const hasAllShifts = dayAvail.shifts.length === 0 || 
                        (dayAvail.shifts.includes('12A-8A') && dayAvail.shifts.includes('8A-4P') && dayAvail.shifts.includes('4P-12A'));

                    html += `
                    <div class="availability-day ${isToday ? 'today' : ''} ${isPast ? 'past' : ''}" data-date="${dateStr}">
                        <div class="availability-day-header">
                            <span class="day-name">${dayName}</span>
                            <span class="day-date">${monthName} ${dayNum}</span>
                        </div>
                        <div class="availability-day-body">
                            <div class="form-group" style="margin-bottom: var(--space-3);">
                                <label class="form-label" style="font-size: var(--font-size-xs);">Status</label>
                                <select class="form-select avail-status" data-date="${dateStr}" ${isPast ? 'disabled' : ''}>
                                    <option value="available" ${dayAvail.status === 'available' ? 'selected' : ''}>âœ“ Available</option>
                                    <option value="preferred" ${dayAvail.status === 'preferred' || dayAvail.status === 'prefers' ? 'selected' : ''}>â˜… Preferred</option>
                                    <option value="unavailable" ${dayAvail.status === 'unavailable' ? 'selected' : ''}>âœ— Unavailable</option>
                                    <option value="partial" ${dayAvail.status === 'partial' ? 'selected' : ''}>â— Partial</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: var(--space-3);">
                                <label class="form-label" style="font-size: var(--font-size-xs);">Shifts</label>
                                <div class="shift-checkboxes">
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="avail-shift" data-date="${dateStr}" value="12A-8A" ${dayAvail.shifts.includes('12A-8A') || hasAllShifts ? 'checked' : ''} ${isPast ? 'disabled' : ''}>
                                        <span>12A-8A</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="avail-shift" data-date="${dateStr}" value="8A-4P" ${dayAvail.shifts.includes('8A-4P') || hasAllShifts ? 'checked' : ''} ${isPast ? 'disabled' : ''}>
                                        <span>8A-4P</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="avail-shift" data-date="${dateStr}" value="4P-12A" ${dayAvail.shifts.includes('4P-12A') || hasAllShifts ? 'checked' : ''} ${isPast ? 'disabled' : ''}>
                                        <span>4P-12A</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label" style="font-size: var(--font-size-xs);">Notes</label>
                                <input type="text" class="form-input avail-notes" data-date="${dateStr}" 
                                       placeholder="Optional..." value="${Utils.escapeHtml(dayAvail.notes || '')}" 
                                       style="font-size: var(--font-size-sm);" ${isPast ? 'disabled' : ''}>
                            </div>
                        </div>
                    </div>
                `;
                });

                html += '</div>';

                // Show last updated time if any records exist
                const latestRecord = guardAvailability.sort((a, b) => 
                    (b.updatedAt || b.createdAt || '').localeCompare(a.updatedAt || a.createdAt || '')
                )[0];
                if (latestRecord?.updatedAt || latestRecord?.createdAt) {
                    html += `<p class="text-sm text-muted mt-3">Last updated: ${Utils.formatDateTime(latestRecord.updatedAt || latestRecord.createdAt)}</p>`;
                }

                container.innerHTML = html;
            },

            saveAvailability: function () {
                if (!this.selectedGuardId) {
                    UI.toast('Error', 'Please select a guard first.', 'error');
                    return;
                }

                let recordsCreated = 0;
                let recordsUpdated = 0;
                const availability = DataStore.getAvailability();

                document.querySelectorAll('.availability-day').forEach(dayEl => {
                    const dateStr = dayEl.dataset.date;
                    const status = dayEl.querySelector('.avail-status')?.value || 'available';
                    const notes = dayEl.querySelector('.avail-notes')?.value || '';

                    // Get selected shifts
                    const selectedShifts = [];
                    dayEl.querySelectorAll('.avail-shift:checked').forEach(cb => {
                        selectedShifts.push(cb.value);
                    });

                    // If no shifts selected, default to all shifts for the selected status
                    const shiftsToSave = selectedShifts.length > 0 ? selectedShifts : ['12A-8A', '8A-4P', '4P-12A'];

                    // Create/update a record for each shift
                    shiftsToSave.forEach(shiftLabel => {
                        const existingIdx = availability.findIndex(r =>
                            r.guardId === this.selectedGuardId &&
                            r.date === dateStr &&
                            r.shiftLabel === shiftLabel
                        );

                        DataStore.upsertAvailability({
                            guardId: this.selectedGuardId,
                            date: dateStr,
                            shiftLabel: shiftLabel,
                            status: this.mapStatusToSpec(status),
                            sitePreference: null,
                            source: 'supervisor',
                            notes: notes
                        });

                        if (existingIdx >= 0) {
                            recordsUpdated++;
                        } else {
                            recordsCreated++;
                        }
                    });
                });

                const guard = DataStore.getGuardById(this.selectedGuardId);
                const msg = recordsUpdated > 0
                    ? `${guard?.name}'s availability updated (${recordsCreated} new, ${recordsUpdated} updated).`
                    : `${guard?.name}'s availability for this week has been saved.`;
                UI.toast('Availability Saved', msg, 'success');

                this.renderOverview();
                this.renderRecords();
            },

            // Map UI status values to spec-compliant values
            mapStatusToSpec: function (uiStatus) {
                const mapping = {
                    'available': 'available',
                    'preferred': 'prefers',
                    'unavailable': 'unavailable',
                    'partial': 'available', // partial availability = available for specific shifts
                    'blocked': 'blocked'
                };
                return mapping[uiStatus] || 'available';
            },

            // Map spec status values to UI values
            mapStatusFromSpec: function (specStatus) {
                const mapping = {
                    'available': 'available',
                    'prefers': 'preferred',
                    'unavailable': 'unavailable',
                    'blocked': 'unavailable' // treat blocked as unavailable in UI
                };
                return mapping[specStatus] || 'available';
            },

            renderOverview: function () {
                const container = document.getElementById('availability-overview-grid');
                if (!container) return;

                const guards = DataStore.getActiveGuards();
                const days = Utils.getDaysOfWeek(this.currentWeekStart);
                
                // Get availability for the week from array
                const startDate = Utils.toISODate(days[0]);
                const endDate = Utils.toISODate(days[6]);
                const weekAvailability = DataStore.getAvailabilityByDateRange(startDate, endDate);
                
                // Build lookup: guardId â†’ date â†’ { status, shifts, notes }
                const availLookup = {};
                weekAvailability.forEach(r => {
                    if (!availLookup[r.guardId]) availLookup[r.guardId] = {};
                    if (!availLookup[r.guardId][r.date]) {
                        availLookup[r.guardId][r.date] = { 
                            status: r.status === 'prefers' ? 'preferred' : r.status, 
                            shifts: [], 
                            notes: r.notes || '' 
                        };
                    }
                    availLookup[r.guardId][r.date].shifts.push(r.shiftLabel);
                    // If any record has notes, append
                    if (r.notes && !availLookup[r.guardId][r.date].notes.includes(r.notes)) {
                        availLookup[r.guardId][r.date].notes = r.notes;
                    }
                });

                let html = `
                <div class="overview-grid" style="display: grid; grid-template-columns: 180px repeat(7, 1fr); gap: 1px; background: var(--color-border); border-radius: var(--radius-lg); overflow: hidden;">
                    <div class="overview-header-cell" style="background: var(--color-surface-elevated); padding: var(--space-3); font-weight: var(--font-weight-semibold);">Guard</div>
            `;

                days.forEach(d => {
                    const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                    const dayNum = d.getDate();
                    const isToday = Utils.toISODate(d) === Utils.toISODate(new Date());
                    html += `<div class="overview-header-cell" style="background: ${isToday ? 'var(--color-primary)' : 'var(--color-surface-elevated)'}; color: ${isToday ? 'white' : 'var(--color-text)'}; padding: var(--space-3); text-align: center; font-weight: var(--font-weight-medium);">${dayName} ${dayNum}</div>`;
                });

                guards.forEach(guard => {
                    const guardAvail = availLookup[guard.id] || {};

                    html += `<div class="overview-guard-cell" style="background: var(--color-surface); padding: var(--space-3); font-size: var(--font-size-sm);">${Utils.escapeHtml(guard.name)}</div>`;

                    days.forEach(d => {
                        const dateStr = Utils.toISODate(d);
                        const dayAvail = guardAvail[dateStr];

                        let statusClass = 'neutral';
                        let statusIcon = 'â€”';
                        let statusTitle = 'No availability submitted';

                        if (dayAvail) {
                            switch (dayAvail.status) {
                                case 'available':
                                    statusClass = 'success';
                                    statusIcon = 'âœ“';
                                    statusTitle = 'Available';
                                    break;
                                case 'preferred':
                                case 'prefers':
                                    statusClass = 'info';
                                    statusIcon = 'â˜…';
                                    statusTitle = 'Preferred';
                                    break;
                                case 'unavailable':
                                case 'blocked':
                                    statusClass = 'danger';
                                    statusIcon = 'âœ—';
                                    statusTitle = 'Unavailable';
                                    break;
                                case 'partial':
                                    statusClass = 'warning';
                                    statusIcon = 'â—';
                                    statusTitle = `Partial: ${dayAvail.shifts?.join(', ') || 'See notes'}`;
                                    break;
                            }
                            if (dayAvail.notes) {
                                statusTitle += ` - ${dayAvail.notes}`;
                            }
                        }

                        html += `
                        <div class="overview-status-cell" 
                             style="background: var(--color-${statusClass}-bg, var(--color-surface)); 
                                    padding: var(--space-2); 
                                    text-align: center; 
                                    cursor: pointer;"
                             title="${Utils.escapeHtml(statusTitle)}"
                             onclick="AvailabilityModule.quickView('${guard.id}', '${dateStr}')">
                            <span style="color: var(--color-${statusClass}, var(--color-text-muted));">${statusIcon}</span>
                        </div>
                    `;
                    });
                });

                html += '</div>';

                html += `
                <div class="availability-legend" style="display: flex; gap: var(--space-6); margin-top: var(--space-4); font-size: var(--font-size-sm); flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: var(--space-2);">
                        <span style="color: var(--color-success);">âœ“</span> Available
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--space-2);">
                        <span style="color: var(--color-info);">â˜…</span> Preferred
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--space-2);">
                        <span style="color: var(--color-warning);">â—</span> Partial
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--space-2);">
                        <span style="color: var(--color-danger);">âœ—</span> Unavailable
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--space-2);">
                        <span style="color: var(--color-text-muted);">â€”</span> Not submitted
                    </div>
                </div>
            `;

                container.innerHTML = html;
            },

            quickView: function (guardId, dateStr) {
                const guard = DataStore.getGuardById(guardId);
                const dayAvail = DataStore.getAvailabilityForGuardDate(guardId, dateStr);

                const dateFormatted = new Date(dateStr + 'T00:00:00').toLocaleDateString('en-US', {
                    weekday: 'long',
                    month: 'long',
                    day: 'numeric'
                });

                let content = `
                <div style="text-align: center;">
                    <h4 style="margin-bottom: var(--space-2);">${Utils.escapeHtml(guard?.name || 'Unknown')}</h4>
                    <p class="text-muted" style="margin-bottom: var(--space-4);">${dateFormatted}</p>
            `;

                if (!dayAvail) {
                    content += `<p>No availability submitted for this date.</p>`;
                } else {
                    const statusLabels = {
                        'available': 'âœ“ Available',
                        'preferred': 'â˜… Preferred',
                        'unavailable': 'âœ— Unavailable',
                        'partial': 'â— Partial Availability'
                    };

                    content += `
                    <p style="font-size: var(--font-size-lg); margin-bottom: var(--space-3);">${statusLabels[dayAvail.status] || dayAvail.status}</p>
                `;

                    if (dayAvail.shifts && dayAvail.shifts.length > 0) {
                        content += `<p class="text-muted">Shifts: ${dayAvail.shifts.join(', ')}</p>`;
                    }

                    if (dayAvail.notes) {
                        content += `<p class="text-muted" style="margin-top: var(--space-3);"><em>"${Utils.escapeHtml(dayAvail.notes)}"</em></p>`;
                    }
                }

                content += '</div>';

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>
                <button class="btn btn-primary" onclick="AvailabilityModule.editFromOverview('${guardId}')">Edit Availability</button>
            `;

                UI.openModal('Guard Availability', content, footer);
            },

            editFromOverview: function (guardId) {
                UI.closeModal();

                document.querySelector('#section-availability .tab[data-tab="avail-submit"]')?.click();

                this.selectedGuardId = guardId;
                const select = document.getElementById('avail-guard-select');
                if (select) select.value = guardId;

                this.renderGuardAvailability();
            },

            getAvailabilityIndicator: function (guardId, dateStr) {
                const dayAvail = DataStore.getAvailabilityForGuardDate(guardId, dateStr);

                if (!dayAvail) return { class: '', icon: '', title: 'No availability submitted' };

                switch (dayAvail.status) {
                    case 'available':
                        return { class: 'avail-yes', icon: 'âœ“', title: 'Available' };
                    case 'preferred':
                        return { class: 'avail-preferred', icon: 'â˜…', title: 'Preferred' };
                    case 'unavailable':
                        return { class: 'avail-no', icon: 'âœ—', title: 'Unavailable' + (dayAvail.notes ? `: ${dayAvail.notes}` : '') };
                    case 'partial':
                        return { class: 'avail-partial', icon: 'â—', title: `Partial: ${dayAvail.shifts?.join(', ') || ''}` };
                    default:
                        return { class: '', icon: '', title: '' };
                }
            },

            checkConflict: function (guardId, dateStr, shiftLabel) {
                const dayAvail = DataStore.getAvailabilityForGuardDate(guardId, dateStr);

                if (!dayAvail) return null;

                if (dayAvail.status === 'unavailable') {
                    return {
                        type: 'unavailable',
                        message: `This guard marked themselves unavailable for ${new Date(dateStr + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}.`,
                        notes: dayAvail.notes
                    };
                }

                if (dayAvail.status === 'partial') {
                    if (dayAvail.shifts && !dayAvail.shifts.includes(shiftLabel) && !dayAvail.shifts.includes('any')) {
                        return {
                            type: 'partial',
                            message: `This guard is only available for: ${dayAvail.shifts.join(', ')}`,
                            notes: dayAvail.notes
                        };
                    }
                }

                return null;
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // MONTH CALENDAR VIEW
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            currentMonth: null,
            currentYear: null,
            searchTerm: '',
            siteFilter: '',

            initCalendar: function () {
                const now = new Date();
                this.currentMonth = now.getMonth();
                this.currentYear = now.getFullYear();

                // Populate site filter
                this.populateSiteFilter();

                // Setup search and filter listeners
                document.getElementById('avail-search')?.addEventListener('input', Utils.debounce((e) => {
                    this.searchTerm = e.target.value.toLowerCase();
                    this.renderOverview();
                    this.renderCalendar();
                }, 200));

                document.getElementById('avail-site-filter')?.addEventListener('change', (e) => {
                    this.siteFilter = e.target.value;
                    this.renderOverview();
                    this.renderCalendar();
                });

                document.getElementById('avail-calendar-guard')?.addEventListener('change', () => this.renderCalendar());
                document.getElementById('avail-calendar-shift')?.addEventListener('change', () => this.renderCalendar());
            },

            populateSiteFilter: function () {
                const select = document.getElementById('avail-site-filter');
                if (!select) return;

                const sites = DataStore.getSites();
                select.innerHTML = `
                    <option value="">All Sites</option>
                    ${sites.map(s => `<option value="${s.id}">${Utils.escapeHtml(s.name)}</option>`).join('')}
                `;
            },

            changeMonth: function (delta) {
                this.currentMonth += delta;
                if (this.currentMonth > 11) {
                    this.currentMonth = 0;
                    this.currentYear++;
                } else if (this.currentMonth < 0) {
                    this.currentMonth = 11;
                    this.currentYear--;
                }
                this.renderCalendar();
            },

            goToToday: function () {
                const now = new Date();
                this.currentMonth = now.getMonth();
                this.currentYear = now.getFullYear();
                this.renderCalendar();
            },

            getFilteredGuards: function () {
                let guards = DataStore.getActiveGuards();

                // Apply search filter
                if (this.searchTerm) {
                    guards = guards.filter(g => 
                        g.name.toLowerCase().includes(this.searchTerm)
                    );
                }

                // Apply site filter
                if (this.siteFilter) {
                    guards = guards.filter(g => 
                        g.primarySites && g.primarySites.includes(this.siteFilter)
                    );
                }

                return guards;
            },

            renderCalendar: function () {
                const container = document.getElementById('availability-calendar-grid');
                if (!container) return;

                // Initialize if needed
                if (this.currentMonth === null) {
                    this.initCalendar();
                }

                // Update month label
                const monthLabel = document.getElementById('avail-month-label');
                if (monthLabel) {
                    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'];
                    monthLabel.textContent = `${monthNames[this.currentMonth]} ${this.currentYear}`;
                }

                // Populate guard filter dropdown
                const guardSelect = document.getElementById('avail-calendar-guard');
                if (guardSelect && guardSelect.options.length <= 1) {
                    const guards = DataStore.getActiveGuards();
                    guardSelect.innerHTML = `
                        <option value="">All Guards</option>
                        ${guards.map(g => `<option value="${g.id}">${Utils.escapeHtml(g.name)}</option>`).join('')}
                    `;
                }

                const selectedGuardId = document.getElementById('avail-calendar-guard')?.value || '';
                const selectedShift = document.getElementById('avail-calendar-shift')?.value || '';

                // Get days in month
                const firstDay = new Date(this.currentYear, this.currentMonth, 1);
                const lastDay = new Date(this.currentYear, this.currentMonth + 1, 0);
                const startDayOfWeek = firstDay.getDay(); // 0 = Sunday
                const daysInMonth = lastDay.getDate();

                const today = new Date();
                const todayStr = Utils.toISODate(today);

                // Get filtered guards
                const guards = selectedGuardId 
                    ? DataStore.getActiveGuards().filter(g => g.id === selectedGuardId)
                    : this.getFilteredGuards();

                let html = '<div class="month-calendar">';

                // Header row (day names)
                html += '<div class="month-calendar-header">';
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                dayNames.forEach(name => {
                    html += `<div class="month-calendar-header-cell">${name}</div>`;
                });
                html += '</div>';

                // Calendar body
                html += '<div class="month-calendar-body">';

                // Previous month days
                const prevMonthLastDay = new Date(this.currentYear, this.currentMonth, 0).getDate();
                for (let i = startDayOfWeek - 1; i >= 0; i--) {
                    const day = prevMonthLastDay - i;
                    html += `<div class="month-calendar-day other-month">
                        <div class="month-calendar-day-number">${day}</div>
                    </div>`;
                }

                // Current month days
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${this.currentYear}-${String(this.currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const isToday = dateStr === todayStr;

                    // Count availability for this day
                    let availableCount = 0;
                    let partialCount = 0;
                    let unavailableCount = 0;

                    guards.forEach(guard => {
                        const dayAvail = DataStore.getAvailabilityForGuardDate(guard.id, dateStr);
                        if (dayAvail) {
                            // Check shift filter
                            if (selectedShift && dayAvail.status === 'partial') {
                                if (dayAvail.shifts && !dayAvail.shifts.includes(selectedShift)) {
                                    unavailableCount++;
                                    return;
                                }
                            }

                            switch (dayAvail.status) {
                                case 'available':
                                case 'preferred':
                                    availableCount++;
                                    break;
                                case 'partial':
                                    partialCount++;
                                    break;
                                case 'unavailable':
                                    unavailableCount++;
                                    break;
                            }
                        }
                    });

                    html += `
                        <div class="month-calendar-day ${isToday ? 'today' : ''}" 
                             onclick="AvailabilityModule.showDayDetail('${dateStr}')"
                             data-date="${dateStr}">
                            <div class="month-calendar-day-number">${day}</div>
                            <div class="month-calendar-day-content">
                                ${availableCount > 0 ? `<div class="avail-count available">âœ“ ${availableCount}</div>` : ''}
                                ${partialCount > 0 ? `<div class="avail-count partial">â— ${partialCount}</div>` : ''}
                                ${unavailableCount > 0 ? `<div class="avail-count unavailable">âœ— ${unavailableCount}</div>` : ''}
                            </div>
                        </div>
                    `;
                }

                // Next month days
                const totalCells = startDayOfWeek + daysInMonth;
                const remainingCells = (7 - (totalCells % 7)) % 7;
                for (let i = 1; i <= remainingCells; i++) {
                    html += `<div class="month-calendar-day other-month">
                        <div class="month-calendar-day-number">${i}</div>
                    </div>`;
                }

                html += '</div></div>';

                // Legend
                html += `
                    <div class="availability-legend" style="display: flex; gap: var(--space-6); margin-top: var(--space-4); font-size: var(--font-size-sm); flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                            <span style="color: var(--color-success);">âœ“</span> Available
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                            <span style="color: var(--color-warning);">â—</span> Partial
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                            <span style="color: var(--color-danger);">âœ—</span> Unavailable
                        </div>
                        <span class="text-muted" style="margin-left: auto;">Click any day for details</span>
                    </div>
                `;

                container.innerHTML = html;
            },

            showDayDetail: function (dateStr) {
                const selectedGuardId = document.getElementById('avail-calendar-guard')?.value || '';
                const selectedShift = document.getElementById('avail-calendar-shift')?.value || '';
                
                const guards = selectedGuardId 
                    ? DataStore.getActiveGuards().filter(g => g.id === selectedGuardId)
                    : this.getFilteredGuards();
                const sites = DataStore.getSites();

                const dateFormatted = new Date(dateStr + 'T00:00:00').toLocaleDateString('en-US', {
                    weekday: 'long',
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                });

                // Categorize guards
                const available = [];
                const partial = [];
                const unavailable = [];
                const notSubmitted = [];

                guards.forEach(guard => {
                    const dayAvail = DataStore.getAvailabilityForGuardDate(guard.id, dateStr);
                    const guardInfo = {
                        ...guard,
                        avail: dayAvail,
                        siteNames: (guard.primarySites || []).map(sid => sites.find(s => s.id === sid)?.name || 'Unknown').join(', ')
                    };

                    if (!dayAvail) {
                        notSubmitted.push(guardInfo);
                    } else {
                        switch (dayAvail.status) {
                            case 'available':
                            case 'preferred':
                                // Check shift filter
                                if (selectedShift && dayAvail.shifts && !dayAvail.shifts.includes(selectedShift) && !dayAvail.shifts.includes('any')) {
                                    partial.push(guardInfo);
                                } else {
                                    available.push(guardInfo);
                                }
                                break;
                            case 'partial':
                                if (selectedShift && dayAvail.shifts && !dayAvail.shifts.includes(selectedShift)) {
                                    unavailable.push(guardInfo);
                                } else {
                                    partial.push(guardInfo);
                                }
                                break;
                            case 'unavailable':
                                unavailable.push(guardInfo);
                                break;
                        }
                    }
                });

                const renderGuardList = (list, statusIcon, statusLabel) => {
                    if (list.length === 0) return '';
                    return list.map(g => `
                        <div class="find-avail-guard">
                            <div class="find-avail-guard-info">
                                <div class="find-avail-guard-avatar">${g.name.charAt(0).toUpperCase()}</div>
                                <div>
                                    <div class="find-avail-guard-name">${Utils.escapeHtml(g.name)}</div>
                                    <div class="find-avail-guard-sites">${Utils.escapeHtml(g.siteNames) || 'No primary sites'}</div>
                                </div>
                            </div>
                            <div class="find-avail-guard-status">
                                ${g.avail?.shifts ? `<span class="text-xs text-muted">${g.avail.shifts.join(', ')}</span>` : ''}
                                <span>${statusIcon}</span>
                            </div>
                        </div>
                    `).join('');
                };

                const content = `
                    <div style="margin-bottom: var(--space-4);">
                        <h4 style="margin: 0 0 var(--space-1) 0;">${dateFormatted}</h4>
                        ${selectedShift ? `<p class="text-muted text-sm">Filtered by shift: ${selectedShift}</p>` : ''}
                    </div>

                    ${available.length > 0 ? `
                        <div style="margin-bottom: var(--space-4);">
                            <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                <span style="color: var(--color-success); font-size: 1.2em;">âœ“</span>
                                <strong>Available (${available.length})</strong>
                            </div>
                            <div class="find-avail-results" style="border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                                ${renderGuardList(available, 'âœ“', 'Available')}
                            </div>
                        </div>
                    ` : ''}

                    ${partial.length > 0 ? `
                        <div style="margin-bottom: var(--space-4);">
                            <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                <span style="color: var(--color-warning); font-size: 1.2em;">â—</span>
                                <strong>Partial Availability (${partial.length})</strong>
                            </div>
                            <div class="find-avail-results" style="border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                                ${renderGuardList(partial, 'â—', 'Partial')}
                            </div>
                        </div>
                    ` : ''}

                    ${unavailable.length > 0 ? `
                        <div style="margin-bottom: var(--space-4);">
                            <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                <span style="color: var(--color-danger); font-size: 1.2em;">âœ—</span>
                                <strong>Unavailable (${unavailable.length})</strong>
                            </div>
                            <div class="find-avail-results" style="border: 1px solid var(--color-border); border-radius: var(--radius-md); max-height: 150px;">
                                ${renderGuardList(unavailable, 'âœ—', 'Unavailable')}
                            </div>
                        </div>
                    ` : ''}

                    ${notSubmitted.length > 0 ? `
                        <div>
                            <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                                <span style="color: var(--color-text-muted); font-size: 1.2em;">â€”</span>
                                <strong class="text-muted">Not Submitted (${notSubmitted.length})</strong>
                            </div>
                            <p class="text-sm text-muted">${notSubmitted.map(g => g.name).join(', ')}</p>
                        </div>
                    ` : ''}

                    ${available.length === 0 && partial.length === 0 && unavailable.length === 0 && notSubmitted.length === 0 ? `
                        <p class="text-muted text-center">No guards match current filters.</p>
                    ` : ''}
                `;

                const footer = `<button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>`;
                UI.openModal('Day Availability', content, footer);
            },

            // Legacy redirect - now uses CoverageSuggestionEngine
            openFindAvailable: function () {
                CoverageSuggestionEngine.openQuickSuggest();
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GUARD SEARCH â€” Predictive Text Guard Selection Component
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const GuardSearch = {
            instances: {},
            
            // Create a searchable guard input
            create: function(containerId, options = {}) {
                const container = document.getElementById(containerId);
                if (!container) return null;
                
                const guards = DataStore.getGuards().filter(g => g.status === 'active');
                const instanceId = containerId + '-' + Date.now();
                
                // Create HTML structure
                container.innerHTML = `
                    <div class="guard-search-container" id="${instanceId}">
                        <input type="text" 
                               class="guard-search-input" 
                               id="${instanceId}-input"
                               placeholder="${options.placeholder || 'Type guard name...'}"
                               autocomplete="off">
                        <button type="button" class="guard-search-clear" id="${instanceId}-clear">Ã—</button>
                        <div class="guard-search-results" id="${instanceId}-results"></div>
                        <input type="hidden" id="${instanceId}-value">
                    </div>
                `;
                
                const input = document.getElementById(`${instanceId}-input`);
                const results = document.getElementById(`${instanceId}-results`);
                const clearBtn = document.getElementById(`${instanceId}-clear`);
                const hiddenInput = document.getElementById(`${instanceId}-value`);
                const wrapper = document.getElementById(instanceId);
                
                let highlightedIndex = -1;
                
                // Store instance data
                this.instances[instanceId] = {
                    guards: guards,
                    selectedGuard: null,
                    onSelect: options.onSelect || (() => {}),
                    input: input,
                    hiddenInput: hiddenInput,
                    wrapper: wrapper
                };
                
                // Filter and display results
                const showResults = (query) => {
                    const filtered = query.length > 0 
                        ? guards.filter(g => g.name.toLowerCase().includes(query.toLowerCase()))
                        : guards.slice(0, 10); // Show first 10 if no query
                    
                    if (filtered.length === 0) {
                        results.innerHTML = '<div class="guard-search-empty">No guards found</div>';
                    } else {
                        results.innerHTML = filtered.slice(0, 15).map((g, idx) => {
                            const name = this.highlightMatch(g.name, query);
                            const roleLabels = { armed: 'ğŸ›¡ï¸ Armed', unarmed: 'Unarmed', floater: 'ğŸ”„ Floater', supervisor: 'â­ Supervisor' };
                            const role = roleLabels[g.role] || g.role || '';
                            return `
                                <div class="guard-search-item ${idx === highlightedIndex ? 'highlighted' : ''}" 
                                     data-id="${g.id}" data-name="${Utils.escapeHtml(g.name)}" data-idx="${idx}">
                                    <span class="guard-search-item-name">${name}</span>
                                    ${role ? `<span class="guard-search-item-role">${role}</span>` : ''}
                                </div>
                            `;
                        }).join('');
                        
                        if (filtered.length > 15) {
                            results.innerHTML += `<div class="guard-search-empty">+ ${filtered.length - 15} more...</div>`;
                        }
                    }
                    
                    wrapper.classList.add('active');
                };
                
                // Select a guard
                const selectGuard = (id, name) => {
                    const guard = guards.find(g => g.id === id);
                    if (guard) {
                        input.value = name;
                        hiddenInput.value = id;
                        this.instances[instanceId].selectedGuard = guard;
                        wrapper.classList.remove('active');
                        wrapper.classList.add('has-value');
                        this.instances[instanceId].onSelect(guard);
                    }
                };
                
                // Event listeners
                input.addEventListener('focus', () => {
                    showResults(input.value);
                });
                
                input.addEventListener('input', () => {
                    highlightedIndex = -1;
                    showResults(input.value);
                    
                    // Clear selection if input changed
                    if (hiddenInput.value) {
                        const selectedGuard = guards.find(g => g.id === hiddenInput.value);
                        if (selectedGuard && input.value !== selectedGuard.name) {
                            hiddenInput.value = '';
                            this.instances[instanceId].selectedGuard = null;
                            wrapper.classList.remove('has-value');
                        }
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    const items = results.querySelectorAll('.guard-search-item');
                    
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
                        updateHighlight(items);
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        highlightedIndex = Math.max(highlightedIndex - 1, 0);
                        updateHighlight(items);
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (highlightedIndex >= 0 && items[highlightedIndex]) {
                            const item = items[highlightedIndex];
                            selectGuard(item.dataset.id, item.dataset.name);
                        }
                    } else if (e.key === 'Escape') {
                        wrapper.classList.remove('active');
                    }
                });
                
                const updateHighlight = (items) => {
                    items.forEach((item, idx) => {
                        item.classList.toggle('highlighted', idx === highlightedIndex);
                    });
                    if (items[highlightedIndex]) {
                        items[highlightedIndex].scrollIntoView({ block: 'nearest' });
                    }
                };
                
                results.addEventListener('click', (e) => {
                    const item = e.target.closest('.guard-search-item');
                    if (item) {
                        selectGuard(item.dataset.id, item.dataset.name);
                    }
                });
                
                clearBtn.addEventListener('click', () => {
                    input.value = '';
                    hiddenInput.value = '';
                    this.instances[instanceId].selectedGuard = null;
                    wrapper.classList.remove('has-value');
                    wrapper.classList.remove('active');
                    input.focus();
                    this.instances[instanceId].onSelect(null);
                });
                
                // Close on outside click
                document.addEventListener('click', (e) => {
                    if (!wrapper.contains(e.target)) {
                        wrapper.classList.remove('active');
                    }
                });
                
                return instanceId;
            },
            
            // Highlight matching text
            highlightMatch: function(text, query) {
                if (!query) return Utils.escapeHtml(text);
                const regex = new RegExp(`(${Utils.escapeHtml(query)})`, 'gi');
                return Utils.escapeHtml(text).replace(regex, '<span class="guard-search-match">$1</span>');
            },
            
            // Get selected guard ID
            getValue: function(instanceId) {
                const instance = this.instances[instanceId];
                return instance?.hiddenInput?.value || null;
            },
            
            // Get selected guard object
            getGuard: function(instanceId) {
                const instance = this.instances[instanceId];
                return instance?.selectedGuard || null;
            },
            
            // Clear the input
            clear: function(instanceId) {
                const instance = this.instances[instanceId];
                if (instance) {
                    instance.input.value = '';
                    instance.hiddenInput.value = '';
                    instance.selectedGuard = null;
                    instance.wrapper.classList.remove('has-value');
                }
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // QUICK OPS MODULE â€” Rapid Response Operations Panel
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const QuickOps = {
            // Store for guards who've said they're available
            availableGuards: [],

            init: function() {
                // Load available guards from localStorage
                const saved = localStorage.getItem('sentinel_available_guards');
                if (saved) {
                    try {
                        this.availableGuards = JSON.parse(saved);
                        // Clean up expired entries
                        this.cleanExpired();
                    } catch (e) {
                        this.availableGuards = [];
                    }
                }
                this.updateBadge();
            },

            save: function() {
                localStorage.setItem('sentinel_available_guards', JSON.stringify(this.availableGuards));
                this.updateBadge();
            },

            cleanExpired: function() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                this.availableGuards = this.availableGuards.filter(entry => {
                    if (entry.expiresAt) {
                        return new Date(entry.expiresAt) >= today;
                    }
                    // Check if any days are still in the future
                    if (entry.days && entry.days.length > 0) {
                        return entry.days.some(d => new Date(d + 'T00:00:00') >= today);
                    }
                    return true;
                });
                this.save();
            },

            updateBadge: function() {
                const count = this.availableGuards.length;
                const badge = document.getElementById('avail-count-badge');
                const hint = document.getElementById('avail-count-hint');
                if (badge && hint) {
                    if (count > 0) {
                        badge.innerHTML = `<span style="position:relative;">ğŸ“‹<span style="position:absolute;top:-8px;right:-8px;background:var(--color-success);color:white;font-size:10px;padding:2px 5px;border-radius:10px;">${count}</span></span>`;
                        hint.textContent = `${count} guard${count > 1 ? 's' : ''} available`;
                    } else {
                        badge.textContent = 'ğŸ“‹';
                        hint.textContent = 'Who can work?';
                    }
                }
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // RELIEF LOOKUP
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            openRelief: function() {
                const sites = DataStore.getSites();
                
                const siteOptions = sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                
                const html = `
                    <div class="quick-ops-modal-body">
                        <div class="relief-site-select">
                            <label class="form-label">Select Site</label>
                            <select class="form-select" id="relief-site-select" onchange="QuickOps.renderReliefChain()">
                                <option value="">Choose a site...</option>
                                ${siteOptions}
                            </select>
                        </div>
                        <div id="relief-chain-container"></div>
                    </div>
                `;
                
                UI.modal('ğŸ”„ Relief Lookup', html, [
                    { text: 'Close', class: 'btn-secondary', action: () => UI.closeModal() }
                ]);
            },

            renderReliefChain: function() {
                const siteId = document.getElementById('relief-site-select').value;
                const container = document.getElementById('relief-chain-container');
                
                if (!siteId) {
                    container.innerHTML = '<p class="text-muted">Select a site to see today\'s relief chain.</p>';
                    return;
                }
                
                const today = new Date();
                const weekKey = Utils.getWeekKey(today);
                const schedule = DataStore.getScheduleForWeek(weekKey) || [];
                const guards = DataStore.getGuards();
                const todayStr = Utils.toISODate(today);
                
                // Get ALL shifts for this site (not just today)
                const siteShifts = schedule.filter(s => s.siteId === siteId);
                
                // Get today's shifts for this site
                const todayShifts = schedule.filter(s => 
                    s.siteId === siteId && s.date === todayStr
                ).sort((a, b) => {
                    // Sort by start time
                    const timeA = a.startTime || a.shiftStart || '00:00';
                    const timeB = b.startTime || b.shiftStart || '00:00';
                    return timeA.localeCompare(timeB);
                });
                
                if (todayShifts.length === 0) {
                    // Check if there are shifts for other dates at this site
                    const otherDates = [...new Set(siteShifts.map(s => s.date))].sort();
                    
                    container.innerHTML = `
                        <div class="empty-state" style="padding: var(--space-6); text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: var(--space-2);">ğŸ“…</div>
                            <p class="text-muted">No shifts scheduled for today (${todayStr}) at this site.</p>
                            ${otherDates.length > 0 ? `
                                <p class="text-sm text-muted" style="margin-top: var(--space-2);">
                                    Shifts exist for: ${otherDates.slice(0, 5).join(', ')}${otherDates.length > 5 ? '...' : ''}
                                </p>
                            ` : `
                                <p class="text-sm text-muted" style="margin-top: var(--space-2);">
                                    No shifts found for this site in week ${weekKey}
                                </p>
                            `}
                        </div>
                    `;
                    return;
                }
                
                // Group shifts by time slot to handle multiple guards at same time
                const shiftsByTime = new Map();
                todayShifts.forEach(shift => {
                    const startTime = shift.startTime || shift.shiftStart || '00:00';
                    const endTime = shift.endTime || shift.shiftEnd || '23:59';
                    const key = `${startTime}-${endTime}`;
                    
                    if (!shiftsByTime.has(key)) {
                        shiftsByTime.set(key, {
                            startTime,
                            endTime,
                            guards: []
                        });
                    }
                    
                    const guard = guards.find(g => g.id === shift.guardId);
                    shiftsByTime.get(key).guards.push({
                        id: shift.guardId,
                        name: guard ? guard.name : 'Unassigned',
                        phone: guard?.phone || ''
                    });
                });
                
                // Convert to sorted array
                const timeSlots = Array.from(shiftsByTime.values()).sort((a, b) => 
                    (a.startTime || '00:00').localeCompare(b.startTime || '00:00')
                );
                
                // Find current time to highlight current shift
                const now = new Date();
                const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                
                let html = '<div class="relief-chain">';
                
                timeSlots.forEach((slot, index) => {
                    const nextSlot = timeSlots[index + 1];
                    
                    // Check if this is the current shift
                    const isCurrent = currentTime >= slot.startTime && currentTime < slot.endTime;
                    
                    // Build guard list
                    const guardList = slot.guards.map(g => `
                        <div class="relief-guard-item">
                            <strong>${g.name}</strong>
                            ${g.phone ? `<a href="tel:${g.phone}" class="text-sm" style="margin-left: var(--space-2);">ğŸ“ ${Utils.formatPhone(g.phone)}</a>` : ''}
                        </div>
                    `).join('');
                    
                    // Build relieved by list
                    const relievedByList = nextSlot ? nextSlot.guards.map(g => g.name).join(', ') : null;
                    
                    html += `
                        <div class="relief-shift ${isCurrent ? 'current' : ''}">
                            <div class="relief-time">${Utils.formatTime(slot.startTime)} - ${Utils.formatTime(slot.endTime)}</div>
                            <div class="relief-guards">
                                ${guardList}
                                ${slot.guards.length > 1 ? `<div class="text-sm text-muted">(${slot.guards.length} guards)</div>` : ''}
                            </div>
                            <div class="relief-arrow">â†’</div>
                            <div class="relief-relieved-by">
                                ${relievedByList ? `Relieved by: <strong>${relievedByList}</strong>` : '<span class="text-muted">End of day</span>'}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // Add summary
                const totalGuards = todayShifts.length;
                const uniqueGuards = [...new Set(todayShifts.map(s => s.guardId))].length;
                html += `
                    <div class="text-sm text-muted" style="margin-top: var(--space-3); padding-top: var(--space-2); border-top: 1px solid var(--color-border);">
                        ${timeSlots.length} shift${timeSlots.length !== 1 ? 's' : ''} Â· ${uniqueGuards} guard${uniqueGuards !== 1 ? 's' : ''} scheduled today
                    </div>
                `;
                
                container.innerHTML = html;
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // QUICK CALL-OFF
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            openCallOff: function() {
                const html = `
                    <div class="quick-ops-modal-body">
                        <div class="form-group">
                            <label class="form-label">Who is calling off?</label>
                            <div id="calloff-guard-search"></div>
                        </div>
                        
                        <div id="calloff-shift-container" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Which shift?</label>
                                <select class="form-select" id="calloff-shift">
                                    <option value="">Select shift...</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Reason (optional)</label>
                                <input type="text" class="form-input" id="calloff-reason" placeholder="Sick, emergency, etc.">
                            </div>
                        </div>
                        
                        <div id="calloff-candidates-container"></div>
                    </div>
                `;
                
                UI.modal('ğŸ“µ Quick Call-off', html, [
                    { text: 'Cancel', class: 'btn-secondary', action: () => UI.closeModal() },
                    { text: 'Log Call-off & Find Coverage', class: 'btn-primary', action: this.processCallOff.bind(this) }
                ]);
                
                // Initialize searchable guard input after modal renders
                setTimeout(() => {
                    this.calloffGuardSearchId = GuardSearch.create('calloff-guard-search', {
                        placeholder: 'Type guard name...',
                        onSelect: (guard) => {
                            if (guard) {
                                this.loadGuardShifts(guard.id);
                            } else {
                                document.getElementById('calloff-shift-container').style.display = 'none';
                                document.getElementById('calloff-candidates-container').innerHTML = '';
                            }
                        }
                    });
                }, 100);
            },

            loadGuardShifts: function(guardId) {
                // If called without argument, try to get from search
                if (!guardId && this.calloffGuardSearchId) {
                    guardId = GuardSearch.getValue(this.calloffGuardSearchId);
                }
                
                const shiftContainer = document.getElementById('calloff-shift-container');
                const shiftSelect = document.getElementById('calloff-shift');
                
                if (!guardId) {
                    shiftContainer.style.display = 'none';
                    return;
                }
                
                // Get schedules from current week and next week
                const today = new Date();
                const nextWeek = new Date(today);
                nextWeek.setDate(nextWeek.getDate() + 7);
                
                const currentWeekKey = Utils.getWeekKey(today);
                const nextWeekKey = Utils.getWeekKey(nextWeek);
                
                let schedule = [...(DataStore.getScheduleForWeek(currentWeekKey) || [])];
                if (nextWeekKey !== currentWeekKey) {
                    schedule = schedule.concat(DataStore.getScheduleForWeek(nextWeekKey) || []);
                }
                
                const sites = DataStore.getSites();
                
                // DEBUG: Log what we're looking for
                console.log('Loading shifts for guardId:', guardId);
                console.log('Total schedule entries:', schedule.length);
                
                // Get upcoming shifts for THIS GUARD ONLY
                const upcomingShifts = schedule.filter(s => {
                    // STRICT: guardId must exactly match
                    if (s.guardId !== guardId) return false;
                    
                    const shiftDate = new Date(s.date + 'T00:00:00');
                    const todayStart = new Date(today);
                    todayStart.setHours(0, 0, 0, 0);
                    const daysDiff = (shiftDate - todayStart) / (1000 * 60 * 60 * 24);
                    return daysDiff >= 0 && daysDiff <= 7;
                }).sort((a, b) => a.date.localeCompare(b.date));
                
                console.log('Found shifts for guard:', upcomingShifts.length);
                upcomingShifts.forEach(s => console.log(' -', s.date, s.siteId, s.guardId));
                
                if (upcomingShifts.length === 0) {
                    shiftSelect.innerHTML = '<option value="">No upcoming shifts</option>';
                } else {
                    shiftSelect.innerHTML = '<option value="">Select shift...</option>' + 
                        upcomingShifts.map(s => {
                            const site = sites.find(st => st.id === s.siteId);
                            const siteName = site?.name || 'Unknown Site';
                            const dateStr = new Date(s.date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                            const timeStr = `${Utils.formatTime(s.startTime || s.shiftStart)} - ${Utils.formatTime(s.endTime || s.shiftEnd)}`;
                            return `<option value="${s.id}" data-site="${s.siteId}" data-date="${s.date}">${dateStr} | ${siteName} | ${timeStr}</option>`;
                        }).join('');
                }
                
                shiftContainer.style.display = 'block';
                
                // Add change listener to show candidates
                shiftSelect.onchange = () => this.showCandidates();
            },

            showCandidates: function() {
                const shiftSelect = document.getElementById('calloff-shift');
                const container = document.getElementById('calloff-candidates-container');
                
                const selectedOption = shiftSelect.selectedOptions[0];
                if (!selectedOption || !selectedOption.value) {
                    container.innerHTML = '';
                    return;
                }
                
                const siteId = selectedOption.dataset.site;
                const date = selectedOption.dataset.date;
                const shiftId = selectedOption.value;
                
                // Get candidates from multiple sources
                const guards = DataStore.getGuards().filter(g => g.status === 'active');
                const callingOffGuardId = this.calloffGuardSearchId ? GuardSearch.getValue(this.calloffGuardSearchId) : null;
                const calloffs = DataStore.getCalloffs();
                
                // Calculate weekly hours for OT check
                const weekKey = Utils.getWeekKey(new Date(date + 'T00:00:00'));
                const weekSchedule = DataStore.getScheduleForWeek(weekKey) || [];
                
                const getWeeklyHours = (guardId) => {
                    const guardShifts = weekSchedule.filter(s => s.guardId === guardId);
                    let hours = 0;
                    guardShifts.forEach(s => {
                        const start = s.startTime || s.shiftStart || '08:00';
                        const end = s.endTime || s.shiftEnd || '16:00';
                        const [sh, sm] = start.split(':').map(Number);
                        const [eh, em] = end.split(':').map(Number);
                        let diff = (eh + em/60) - (sh + sm/60);
                        if (diff < 0) diff += 24; // overnight
                        hours += diff;
                    });
                    return Math.round(hours);
                };
                
                // Calculate reliability score based on call-offs
                const getReliability = (guardId) => {
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    const recentCalloffs = calloffs.filter(c => 
                        c.guardId === guardId && new Date(c.date) >= thirtyDaysAgo
                    ).length;
                    if (recentCalloffs === 0) return { score: 'reliable', label: 'âœ“ Reliable', class: 'good' };
                    if (recentCalloffs <= 1) return { score: 'ok', label: '1 call-off', class: 'fair' };
                    return { score: 'risk', label: `${recentCalloffs} call-offs`, class: 'poor' };
                };
                
                const candidates = [];
                
                // 1. Check Quick Ops available guards first
                this.availableGuards.forEach(avail => {
                    if (avail.guardId === callingOffGuardId) return;
                    
                    const guard = guards.find(g => g.id === avail.guardId);
                    if (!guard) return;
                    
                    const isDateMatch = avail.days?.includes(date) || !avail.days || avail.days.length === 0;
                    
                    if (isDateMatch) {
                        candidates.push({
                            guard: guard,
                            reason: 'Said they\'re available',
                            score: 'excellent',
                            weeklyHours: getWeeklyHours(guard.id),
                            reliability: getReliability(guard.id),
                            shifts: avail.shifts,
                            notes: avail.notes
                        });
                    }
                });
                
                // 2. Check regular availability system (array-based)
                const dateAvailability = DataStore.getAvailabilityByDate(date);
                guards.forEach(g => {
                    if (g.id === callingOffGuardId) return;
                    if (candidates.some(c => c.guard.id === g.id)) return;
                    
                    // Get all availability records for this guard on this date
                    const guardRecords = dateAvailability.filter(r => r.guardId === g.id);
                    if (guardRecords.length > 0) {
                        // Use the first record's status (or could aggregate by priority)
                        const dayStatus = guardRecords[0].status;
                        if (dayStatus === 'available' || dayStatus === 'prefers') {
                            candidates.push({
                                guard: g,
                                reason: dayStatus === 'prefers' ? 'Prefers this day' : 'Marked available',
                                score: dayStatus === 'prefers' ? 'excellent' : 'good',
                                weeklyHours: getWeeklyHours(g.id),
                                reliability: getReliability(g.id)
                            });
                        }
                    }
                });
                
                // 3. Add guards who've worked this site before
                const allSchedules = DataStore.getSchedules();
                const siteVeterans = new Set();
                Object.values(allSchedules).flat().forEach(s => {
                    if (s.siteId === siteId && s.guardId && s.guardId !== callingOffGuardId) {
                        siteVeterans.add(s.guardId);
                    }
                });
                
                siteVeterans.forEach(gid => {
                    if (candidates.some(c => c.guard.id === gid)) return;
                    const guard = guards.find(g => g.id === gid);
                    if (guard) {
                        candidates.push({
                            guard: guard,
                            reason: 'Has worked this site',
                            score: 'fair',
                            weeklyHours: getWeeklyHours(gid),
                            reliability: getReliability(gid)
                        });
                    }
                });
                
                if (candidates.length === 0) {
                    container.innerHTML = `
                        <div class="calloff-candidates" style="margin-top: var(--space-4);">
                            <h4 style="margin-bottom: var(--space-2);">Replacement Candidates</h4>
                            <p class="text-muted">No candidates found. Try adding available guards first.</p>
                        </div>
                    `;
                    return;
                }
                
                // Sort: excellent first, then by OT risk (lower hours first)
                const scoreOrder = { excellent: 0, good: 1, fair: 2 };
                candidates.sort((a, b) => {
                    if (scoreOrder[a.score] !== scoreOrder[b.score]) {
                        return scoreOrder[a.score] - scoreOrder[b.score];
                    }
                    return a.weeklyHours - b.weeklyHours; // Less hours = preferred
                });
                
                container.innerHTML = `
                    <div class="calloff-candidates">
                        <h4 style="margin-bottom: var(--space-3);">Replacement Candidates (${candidates.length})</h4>
                        ${candidates.slice(0, 10).map(c => {
                            const otWarning = c.weeklyHours >= 35 ? `<span class="ot-warning">âš ï¸ ${c.weeklyHours}h this week</span>` : `<span class="hours-ok">${c.weeklyHours}h</span>`;
                            return `
                            <div class="calloff-candidate">
                                <div class="calloff-candidate-info">
                                    <div class="calloff-candidate-name">
                                        ${c.guard.name}
                                        <span class="reliability-badge ${c.reliability.class}">${c.reliability.label}</span>
                                    </div>
                                    <div class="calloff-candidate-reason">
                                        ${c.reason} â€¢ ${otWarning}
                                        ${c.notes ? ` â€¢ ${c.notes}` : ''}
                                    </div>
                                    ${c.guard.phone ? `<a href="tel:${c.guard.phone}" class="text-sm" onclick="event.stopPropagation();">ğŸ“ ${Utils.formatPhone(c.guard.phone)}</a>` : ''}
                                </div>
                                <div class="calloff-candidate-actions">
                                    <button class="btn btn-sm btn-primary" onclick="QuickOps.assignCoverage('${shiftId}', '${c.guard.id}'); event.stopPropagation();">
                                        Assign
                                    </button>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                `;
            },

            assignCoverage: function(shiftId, guardId) {
                const weekKey = Utils.getWeekKey(this.currentWeekStart || new Date());
                const allSchedules = DataStore.getSchedules();
                const guards = DataStore.getGuards();
                
                // Find the shift
                let targetShift = null;
                let targetWeekKey = null;
                
                for (const [wk, shifts] of Object.entries(allSchedules)) {
                    const found = shifts.find(s => s.id === shiftId);
                    if (found) {
                        targetShift = found;
                        targetWeekKey = wk;
                        break;
                    }
                }
                
                if (!targetShift) {
                    UI.toast('Error', 'Shift not found', 'error');
                    return;
                }
                
                const guard = guards.find(g => g.id === guardId);
                
                // Update the shift
                targetShift.guardId = guardId;
                targetShift.status = 'confirmed';
                targetShift.notes = (targetShift.notes || '') + ` [Coverage assigned ${new Date().toLocaleDateString()}]`;
                
                // Save
                DataStore.saveScheduleForWeek(targetWeekKey, allSchedules[targetWeekKey]);
                
                UI.toast('Coverage Assigned', `${guard?.name || 'Guard'} assigned`, 'success');
                UI.closeModal();
                
                // Refresh dashboard
                DashboardModule.render();
            },

            selectCandidate: function(guardId) {
                const guard = DataStore.getGuards().find(g => g.id === guardId);
                if (guard && guard.phone) {
                    window.location.href = `tel:${guard.phone}`;
                }
            },

            processCallOff: function() {
                const guardId = this.calloffGuardSearchId ? GuardSearch.getValue(this.calloffGuardSearchId) : null;
                const shiftId = document.getElementById('calloff-shift').value;
                const reason = document.getElementById('calloff-reason').value;
                
                if (!guardId || !shiftId) {
                    UI.toast('Missing Info', 'Please select guard and shift', 'warning');
                    return;
                }
                
                // Log the call-off
                const calloffs = DataStore.getCalloffs();
                const guards = DataStore.getGuards();
                const allSchedules = DataStore.getSchedules();
                const schedule = Object.values(allSchedules).flat();
                
                const guard = guards.find(g => g.id === guardId);
                const shift = schedule.find(s => s.id === shiftId);
                
                const newCallOff = {
                    id: 'CO-' + Date.now(),
                    guardId: guardId,
                    guardName: guard ? guard.name : 'Unknown',
                    siteId: shift?.siteId,
                    shiftId: shiftId,
                    date: shift?.date,
                    reason: reason || 'Not specified',
                    status: 'pending',
                    reportedAt: new Date().toISOString(),
                    reportedBy: 'Quick Ops'
                };
                
                calloffs.push(newCallOff);
                DataStore.saveCalloffs(calloffs);
                
                UI.toast('Call-off Logged', `${guard?.name || 'Guard'}'s call-off recorded`, 'success');
                UI.closeModal();
                
                // Refresh command center
                if (typeof DashboardModule !== 'undefined') {
                    DashboardModule.renderCommandCenter();
                }
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // AVAILABLE GUARDS TRACKER
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            openAvailable: function() {
                const html = `
                    <div class="quick-ops-modal-body">
                        <!-- Add New Entry -->
                        <div class="card mb-4" style="border-color: var(--color-primary);">
                            <div class="card-header">
                                <h4 class="card-title">â• Add Available Guard</h4>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Guard</label>
                                    <div id="avail-guard-search"></div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Available Days</label>
                                    <div class="day-picker" id="avail-days">
                                        ${this.renderDayPicker()}
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Shifts They'll Take</label>
                                    <div class="shift-picker" id="avail-shifts">
                                        <button type="button" class="shift-picker-btn" data-shift="day" onclick="this.classList.toggle('selected')">â˜€ï¸ Day</button>
                                        <button type="button" class="shift-picker-btn" data-shift="evening" onclick="this.classList.toggle('selected')">ğŸŒ† Evening</button>
                                        <button type="button" class="shift-picker-btn" data-shift="overnight" onclick="this.classList.toggle('selected')">ğŸŒ™ Overnight</button>
                                        <button type="button" class="shift-picker-btn selected" data-shift="any" onclick="QuickOps.selectAllShifts(this)">Any Shift</button>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Notes (optional)</label>
                                    <input type="text" class="form-input" id="avail-notes" placeholder="e.g., prefers Site A, no overnights at warehouse">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Expires</label>
                                    <select class="form-select" id="avail-expires">
                                        <option value="week">End of this week</option>
                                        <option value="2weeks">2 weeks</option>
                                        <option value="month">End of month</option>
                                        <option value="ongoing">Ongoing (no expiration)</option>
                                    </select>
                                </div>
                                
                                <button class="btn btn-primary w-full" onclick="QuickOps.addAvailableGuard()">
                                    Add to Available List
                                </button>
                            </div>
                        </div>
                        
                        <!-- Current Available List -->
                        <h4 style="margin-bottom: var(--space-3);">ğŸ“‹ Currently Available (${this.availableGuards.length})</h4>
                        <div class="avail-list" id="avail-list">
                            ${this.renderAvailableList()}
                        </div>
                    </div>
                `;
                
                UI.modal('ğŸ“‹ Available Guards', html, [
                    { text: 'Close', class: 'btn-secondary', action: () => UI.closeModal() }
                ]);
                
                // Initialize searchable guard input after modal renders
                setTimeout(() => {
                    this.availGuardSearchId = GuardSearch.create('avail-guard-search', {
                        placeholder: 'Type guard name...'
                    });
                }, 100);
            },

            renderDayPicker: function() {
                const days = [];
                const today = new Date();
                
                for (let i = 0; i < 14; i++) {
                    const d = new Date(today);
                    d.setDate(d.getDate() + i);
                    const dateStr = Utils.toISODate(d);
                    const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                    const dayNum = d.getDate();
                    
                    days.push(`
                        <button type="button" class="day-picker-btn" data-date="${dateStr}" onclick="this.classList.toggle('selected')" title="${d.toLocaleDateString()}">
                            <div style="font-size: 10px; color: var(--color-text-muted);">${dayName}</div>
                            <div>${dayNum}</div>
                        </button>
                    `);
                }
                
                return days.join('');
            },

            selectAllShifts: function(btn) {
                const allBtns = document.querySelectorAll('.shift-picker-btn');
                const isSelecting = !btn.classList.contains('selected');
                
                allBtns.forEach(b => {
                    if (b.dataset.shift === 'any') {
                        b.classList.toggle('selected', isSelecting);
                    } else {
                        b.classList.remove('selected');
                    }
                });
            },

            addAvailableGuard: function() {
                const guardId = this.availGuardSearchId ? GuardSearch.getValue(this.availGuardSearchId) : null;
                const notes = document.getElementById('avail-notes').value;
                const expiresType = document.getElementById('avail-expires').value;
                
                if (!guardId) {
                    UI.toast('Select Guard', 'Please type and select a guard', 'warning');
                    return;
                }
                
                // Get selected days
                const selectedDays = [];
                document.querySelectorAll('.day-picker-btn.selected').forEach(btn => {
                    selectedDays.push(btn.dataset.date);
                });
                
                // Get selected shifts
                const selectedShifts = [];
                document.querySelectorAll('.shift-picker-btn.selected').forEach(btn => {
                    selectedShifts.push(btn.dataset.shift);
                });
                
                // Calculate expiration
                let expiresAt = null;
                const today = new Date();
                switch (expiresType) {
                    case 'week':
                        const endOfWeek = new Date(today);
                        endOfWeek.setDate(endOfWeek.getDate() + (7 - endOfWeek.getDay()));
                        expiresAt = Utils.toISODate(endOfWeek);
                        break;
                    case '2weeks':
                        const twoWeeks = new Date(today);
                        twoWeeks.setDate(twoWeeks.getDate() + 14);
                        expiresAt = Utils.toISODate(twoWeeks);
                        break;
                    case 'month':
                        const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                        expiresAt = Utils.toISODate(endOfMonth);
                        break;
                    // 'ongoing' = null
                }
                
                const guard = DataStore.getGuards().find(g => g.id === guardId);
                
                // Remove existing entry for this guard if any
                this.availableGuards = this.availableGuards.filter(a => a.guardId !== guardId);
                
                // Add new entry
                this.availableGuards.push({
                    guardId: guardId,
                    guardName: guard ? guard.name : 'Unknown',
                    days: selectedDays,
                    shifts: selectedShifts,
                    notes: notes,
                    expiresAt: expiresAt,
                    addedAt: new Date().toISOString()
                });
                
                this.save();
                
                // Refresh the list
                document.getElementById('avail-list').innerHTML = this.renderAvailableList();
                
                // Reset form
                document.getElementById('avail-guard').value = '';
                document.getElementById('avail-notes').value = '';
                document.querySelectorAll('.day-picker-btn.selected').forEach(b => b.classList.remove('selected'));
                document.querySelectorAll('.shift-picker-btn').forEach(b => {
                    b.classList.toggle('selected', b.dataset.shift === 'any');
                });
                
                UI.toast('Added', `${guard?.name || 'Guard'} added to available list`, 'success');
            },

            renderAvailableList: function() {
                if (this.availableGuards.length === 0) {
                    return `
                        <div class="empty-state" style="padding: var(--space-6); text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: var(--space-2);">ğŸ“­</div>
                            <p class="text-muted">No guards have been marked as available.</p>
                            <p class="text-sm text-muted">When guards call in saying they can pick up shifts, add them here.</p>
                        </div>
                    `;
                }
                
                const guards = DataStore.getGuards();
                
                return this.availableGuards.map(entry => {
                    const guard = guards.find(g => g.id === entry.guardId);
                    const phone = guard?.phone;
                    
                    // Format days
                    let daysDisplay = 'Any day';
                    if (entry.days && entry.days.length > 0) {
                        if (entry.days.length <= 4) {
                            daysDisplay = entry.days.map(d => {
                                const date = new Date(d + 'T00:00:00');
                                return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                            }).join(', ');
                        } else {
                            daysDisplay = `${entry.days.length} days selected`;
                        }
                    }
                    
                    // Format shifts
                    let shiftsDisplay = 'Any shift';
                    if (entry.shifts && entry.shifts.length > 0 && !entry.shifts.includes('any')) {
                        shiftsDisplay = entry.shifts.map(s => {
                            const labels = { day: 'â˜€ï¸ Day', evening: 'ğŸŒ† Eve', overnight: 'ğŸŒ™ Night' };
                            return labels[s] || s;
                        }).join(', ');
                    }
                    
                    return `
                        <div class="avail-entry">
                            <div class="avail-guard-info">
                                <div class="avail-guard-name">${entry.guardName}</div>
                                <div class="avail-details">
                                    <div>${daysDisplay}</div>
                                    <div>${shiftsDisplay}</div>
                                    ${entry.notes ? `<div style="font-style: italic;">"${entry.notes}"</div>` : ''}
                                    ${entry.expiresAt ? `<div class="text-muted">Expires: ${new Date(entry.expiresAt + 'T00:00:00').toLocaleDateString()}</div>` : ''}
                                </div>
                            </div>
                            <div class="avail-actions">
                                ${phone ? `<a href="tel:${phone}" class="btn btn-sm btn-secondary" title="Call">ğŸ“</a>` : ''}
                                <button class="btn btn-sm btn-ghost" onclick="QuickOps.removeAvailable('${entry.guardId}')" title="Remove">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            removeAvailable: function(guardId) {
                this.availableGuards = this.availableGuards.filter(a => a.guardId !== guardId);
                this.save();
                document.getElementById('avail-list').innerHTML = this.renderAvailableList();
                UI.toast('Removed', 'Guard removed from available list', 'info');
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // SITE QUICK VIEW
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            openSiteView: function() {
                const sites = DataStore.getSites();
                const siteOptions = sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                
                const html = `
                    <div class="quick-ops-modal-body">
                        <div class="form-group">
                            <label class="form-label">Select Site</label>
                            <select class="form-select" id="siteview-select" onchange="QuickOps.renderSiteView()">
                                <option value="">Choose a site...</option>
                                ${siteOptions}
                            </select>
                        </div>
                        <div id="siteview-container"></div>
                    </div>
                `;
                
                UI.modal('ğŸ¢ Site Quick View', html, [
                    { text: 'Close', class: 'btn-secondary', action: () => UI.closeModal() }
                ]);
            },

            renderSiteView: function() {
                const siteId = document.getElementById('siteview-select').value;
                const container = document.getElementById('siteview-container');
                
                if (!siteId) {
                    container.innerHTML = '<p class="text-muted">Select a site to view details.</p>';
                    return;
                }
                
                const sites = DataStore.getSites();
                const contacts = DataStore.getContacts();
                const incidents = DataStore.getIncidents();
                const inspections = DataStore.getInspections();
                const weekKey = Utils.getWeekKey(new Date());
                const schedule = DataStore.getScheduleForWeek(weekKey) || [];
                const guards = DataStore.getGuards();
                
                const site = sites.find(s => s.id === siteId);
                if (!site) {
                    container.innerHTML = '<p class="text-muted">Site not found.</p>';
                    return;
                }
                
                // Get site contacts
                const siteContacts = contacts.filter(c => c.siteId === siteId || c.company === site.name);
                
                // Get recent incidents (last 30 days)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const recentIncidents = incidents.filter(i => 
                    i.siteId === siteId && new Date(i.dateTime) >= thirtyDaysAgo
                ).sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime)).slice(0, 3);
                
                // Get last inspection
                const siteInspections = inspections.filter(i => i.siteId === siteId)
                    .sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));
                const lastInspection = siteInspections[0];
                
                // Get who's on duty now
                const today = Utils.toISODate(new Date());
                const now = new Date();
                const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                
                // Sort today's shifts by start time
                const todayShifts = schedule.filter(s => s.siteId === siteId && s.date === today)
                    .sort((a, b) => {
                        const timeA = a.startTime || a.shiftStart || '00:00';
                        const timeB = b.startTime || b.shiftStart || '00:00';
                        return timeA.localeCompare(timeB);
                    });
                
                const currentShift = todayShifts.find(s => {
                    const start = s.startTime || s.shiftStart || '00:00';
                    const end = s.endTime || s.shiftEnd || '23:59';
                    return currentTime >= start && currentTime < end;
                });
                
                const currentGuard = currentShift ? guards.find(g => g.id === currentShift.guardId) : null;
                
                // Find next shift (after current time)
                const nextShift = todayShifts.find(s => {
                    const start = s.startTime || s.shiftStart || '00:00';
                    return start > currentTime;
                });
                const nextGuard = nextShift ? guards.find(g => g.id === nextShift.guardId) : null;
                
                let html = `
                    <div class="site-quick-header">
                        <div style="font-size: 2.5rem;">ğŸ¢</div>
                        <div>
                            <div class="site-quick-name">${site.name}</div>
                            <div class="text-muted">${site.address || 'No address on file'}</div>
                        </div>
                    </div>
                    
                    <!-- On Duty Now -->
                    <div class="site-quick-section">
                        <h4>ğŸ‘¤ On Duty Now</h4>
                        ${currentGuard ? `
                            <div class="site-contact-row">
                                <div>
                                    <div class="site-contact-name">${currentGuard.name}</div>
                                    <div class="site-contact-role">${Utils.formatTime(currentShift.startTime || currentShift.shiftStart)} - ${Utils.formatTime(currentShift.endTime || currentShift.shiftEnd)}</div>
                                </div>
                                ${currentGuard.phone ? `<a href="tel:${currentGuard.phone}" class="btn btn-sm btn-secondary">ğŸ“</a>` : ''}
                            </div>
                        ` : `
                            <div class="site-contact-row">
                                <div class="text-muted">No guard currently on duty</div>
                            </div>
                        `}
                        
                        ${nextShift ? `
                            <div class="site-contact-row" style="margin-top: var(--space-2); opacity: 0.8;">
                                <div>
                                    <div class="site-contact-name" style="font-size: var(--font-size-sm);">â­ï¸ Up Next: ${nextGuard ? nextGuard.name : 'Unassigned'}</div>
                                    <div class="site-contact-role">${Utils.formatTime(nextShift.startTime || nextShift.shiftStart)} - ${Utils.formatTime(nextShift.endTime || nextShift.shiftEnd)}</div>
                                </div>
                                ${nextGuard?.phone ? `<a href="tel:${nextGuard.phone}" style="color: var(--color-text-muted); text-decoration: none;">ğŸ“</a>` : ''}
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Site Contacts -->
                    <div class="site-quick-section">
                        <h4>ğŸ“‡ Site Contacts</h4>
                        ${siteContacts.length > 0 ? siteContacts.map(c => `
                            <div class="site-contact-row">
                                <div>
                                    <div class="site-contact-name">${c.name}</div>
                                    <div class="site-contact-role">${c.role || c.category || ''}</div>
                                </div>
                                ${c.phone ? `<a href="tel:${c.phone}" class="btn btn-sm btn-secondary">ğŸ“</a>` : ''}
                            </div>
                        `).join('') : '<p class="text-muted">No contacts on file for this site.</p>'}
                    </div>
                    
                    <!-- Last Inspection -->
                    <div class="site-quick-section">
                        <h4>ğŸ“‹ Last Inspection</h4>
                        ${lastInspection ? `
                            <div class="site-contact-row">
                                <div>
                                    <div class="site-contact-name">${lastInspection.status}</div>
                                    <div class="site-contact-role">${new Date(lastInspection.dateTime).toLocaleDateString()}</div>
                                </div>
                                <span class="badge ${lastInspection.status === 'Pass' ? 'badge-success' : lastInspection.status === 'Fail' ? 'badge-danger' : 'badge-warning'}">${lastInspection.status}</span>
                            </div>
                            ${lastInspection.notes ? `<p class="text-sm text-muted" style="margin-top: var(--space-2);">${lastInspection.notes}</p>` : ''}
                        ` : '<p class="text-muted">No inspections on record.</p>'}
                    </div>
                    
                    <!-- Recent Incidents -->
                    <div class="site-quick-section">
                        <h4>âš ï¸ Recent Incidents (30 days)</h4>
                        ${recentIncidents.length > 0 ? recentIncidents.map(i => `
                            <div class="site-contact-row">
                                <div>
                                    <div class="site-contact-name">${i.type || i.incidentType}</div>
                                    <div class="site-contact-role">${new Date(i.dateTime).toLocaleDateString()}</div>
                                </div>
                                <span class="badge ${i.severity === 'Critical' || i.severity === 'High' ? 'badge-danger' : i.severity === 'Medium' ? 'badge-warning' : 'badge-info'}">${i.severity}</span>
                            </div>
                        `).join('') : '<p class="text-muted" style="color: var(--color-success);">âœ“ No incidents in the last 30 days</p>'}
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="site-quick-section">
                        <h4>âš¡ Quick Actions</h4>
                        <div style="display: flex; gap: var(--space-2); flex-wrap: wrap;">
                            <button class="btn btn-sm btn-secondary" onclick="UI.closeModal(); Router.navigate('incidents'); setTimeout(() => document.getElementById('incident-site')?.value === '${siteId}', 200);">Log Incident</button>
                            <button class="btn btn-sm btn-secondary" onclick="UI.closeModal(); Router.navigate('inspections'); setTimeout(() => document.getElementById('insp-site')?.value === '${siteId}', 200);">New Inspection</button>
                            <button class="btn btn-sm btn-secondary" onclick="UI.closeModal(); Router.navigate('scheduler');">View Schedule</button>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CSV IMPORT MODULE â€” Universal Data Import Engine
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const CSVImportModule = {
            // Field mapping configurations for different data types
            fieldMaps: {
                schedule: {
                    patterns: ['site', 'date', 'time', 'shift', 'employee', 'week'],
                    fields: {
                        'site': ['site', 'site_name', 'sitename', 'location'],
                        'employee': ['employee', 'guard', 'officer', 'name', 'guard_name', 'officer_name'],
                        'phone': ['phone', 'cell', 'mobile', 'telephone', 'contact'],
                        'position': ['position', 'role', 'title', 'type', 'officer_type'],
                        'date': ['date', 'date_label', 'day', 'shift_date'],
                        'time': ['time', 'time_label', 'shift', 'shift_time', 'hours'],
                        'start_time': ['start_time', 'starttime', 'start', 'time_start', 'begin'],
                        'end_time': ['end_time', 'endtime', 'end', 'time_end', 'finish'],
                        'week_start': ['week_start', 'weekstart', 'week_of', 'week_beginning'],
                        'week_end': ['week_end', 'weekend', 'week_ending']
                    }
                },
                guards: {
                    patterns: ['name', 'phone', 'email', 'status'],
                    fields: {
                        'name': ['name', 'employee', 'guard', 'officer', 'full_name', 'fullname'],
                        'phone': ['phone', 'cell', 'mobile', 'telephone', 'contact', 'phone_number'],
                        'email': ['email', 'e-mail', 'email_address'],
                        'role': ['role', 'position', 'title', 'type'],
                        'status': ['status', 'active', 'employment_status']
                    }
                },
                sites: {
                    patterns: ['address', 'type', 'management'],
                    fields: {
                        'name': ['name', 'site', 'site_name', 'location', 'property'],
                        'address': ['address', 'street', 'location_address'],
                        'type': ['type', 'site_type', 'property_type', 'category'],
                        'management': ['management', 'management_company', 'manager', 'company']
                    }
                },
                contacts: {
                    patterns: ['contact', 'vendor', 'client', 'company', 'organization'],
                    fields: {
                        'name': ['name', 'contact', 'contact_name', 'full_name', 'fullname', 'person'],
                        'phone': ['phone', 'cell', 'mobile', 'telephone', 'phone_number', 'work_phone'],
                        'email': ['email', 'e-mail', 'email_address', 'work_email'],
                        'company': ['company', 'organization', 'org', 'business', 'employer'],
                        'title': ['title', 'job_title', 'position', 'role'],
                        'category': ['category', 'type', 'contact_type', 'group'],
                        'notes': ['notes', 'note', 'comments', 'description']
                    }
                }
            },

            parsedData: null,
            detectedType: null,
            fieldMapping: null,

            init: function () {
                const dropZone = document.getElementById('csv-drop-zone');
                const fileInput = document.getElementById('csv-file-input');

                if (!dropZone || !fileInput) return;

                // Click to browse
                dropZone.addEventListener('click', () => fileInput.click());

                // File selection
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFile(e.target.files[0]);
                    }
                });

                // Drag and drop
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('drag-over');
                });

                dropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');
                });

                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');

                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleFile(files[0]);
                    }
                });
            },

            handleFile: async function (file) {
                const dropZone = document.getElementById('csv-drop-zone');

                // Validate file type
                if (!file.name.match(/\.(csv|txt)$/i)) {
                    UI.toast('Invalid File', 'Please upload a CSV file.', 'error');
                    return;
                }

                dropZone.classList.add('processing');

                try {
                    const text = await file.text();
                    this.parsedData = this.parseCSV(text);

                    if (this.parsedData.length === 0) {
                        throw new Error('No data found in file');
                    }

                    // Auto-detect data type
                    this.detectedType = this.detectDataType(this.parsedData);
                    this.fieldMapping = this.mapFields(this.parsedData[0], this.detectedType);

                    // Show preview modal
                    this.showPreview(file.name);

                } catch (err) {
                    UI.toast('Parse Error', err.message || 'Failed to parse CSV file.', 'error');
                } finally {
                    dropZone.classList.remove('processing');
                    document.getElementById('csv-file-input').value = '';
                }
            },

            parseCSV: function (text) {
                const lines = text.trim().split(/\r?\n/);
                if (lines.length < 2) return [];

                // Parse header
                const headers = this.parseCSVLine(lines[0]);

                // Parse rows
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;

                    const values = this.parseCSVLine(lines[i]);
                    const row = {};

                    headers.forEach((header, idx) => {
                        row[header] = values[idx] || '';
                    });

                    data.push(row);
                }

                return data;
            },

            parseCSVLine: function (line) {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];

                    if (inQuotes) {
                        if (char === '"' && nextChar === '"') {
                            current += '"';
                            i++;
                        } else if (char === '"') {
                            inQuotes = false;
                        } else {
                            current += char;
                        }
                    } else {
                        if (char === '"') {
                            inQuotes = true;
                        } else if (char === ',') {
                            result.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                }

                result.push(current.trim());
                return result;
            },

            detectDataType: function (data) {
                if (data.length === 0) return 'unknown';

                const headers = Object.keys(data[0]).map(h => h.toLowerCase().replace(/[^a-z0-9]/g, '_'));

                // Score each type
                const scores = {};

                for (const [type, config] of Object.entries(this.fieldMaps)) {
                    scores[type] = 0;
                    for (const pattern of config.patterns) {
                        if (headers.some(h => h.includes(pattern))) {
                            scores[type]++;
                        }
                    }
                }

                // Special boost for schedule if we see both site AND employee/time
                if (headers.some(h => h.includes('site')) &&
                    (headers.some(h => h.includes('employee') || h.includes('time') || h.includes('shift')))) {
                    scores.schedule += 3;
                }

                // Find highest score
                let maxType = 'schedule'; // default
                let maxScore = 0;

                for (const [type, score] of Object.entries(scores)) {
                    if (score > maxScore) {
                        maxScore = score;
                        maxType = type;
                    }
                }

                return maxType;
            },

            mapFields: function (sampleRow, dataType) {
                const config = this.fieldMaps[dataType];
                if (!config) return {};

                const mapping = {};
                const headers = Object.keys(sampleRow);

                for (const [targetField, sourcePatterns] of Object.entries(config.fields)) {
                    for (const header of headers) {
                        const normalized = header.toLowerCase().replace(/[^a-z0-9]/g, '_');

                        if (sourcePatterns.some(p => normalized.includes(p) || normalized === p)) {
                            mapping[header] = targetField;
                            break;
                        }
                    }
                }

                return mapping;
            },

            showPreview: function (fileName) {
                const typeLabels = {
                    schedule: { label: 'Schedule Data', color: 'success', icon: 'ğŸ“…' },
                    guards: { label: 'Guard Roster', color: 'info', icon: 'ğŸ‘¤' },
                    sites: { label: 'Site Data', color: 'warning', icon: 'ğŸ¢' },
                    contacts: { label: 'Contacts', color: 'info', icon: 'ğŸ“‡' }
                };

                const typeInfo = typeLabels[this.detectedType] || { label: 'Unknown', color: 'secondary', icon: 'ğŸ“„' };

                // Calculate stats based on data type
                let statsHtml = '';
                if (this.detectedType === 'schedule') {
                    const stats = this.calculateScheduleStats();
                    statsHtml = `
                    <div class="csv-import-stats">
                        <div class="csv-import-stat">
                            <div class="csv-import-stat-value">${stats.totalShifts}</div>
                            <div class="csv-import-stat-label">Total Shifts</div>
                        </div>
                        <div class="csv-import-stat">
                            <div class="csv-import-stat-value">${stats.uniqueGuards}</div>
                            <div class="csv-import-stat-label">Guards</div>
                        </div>
                        <div class="csv-import-stat">
                            <div class="csv-import-stat-value">${stats.uniqueSites}</div>
                            <div class="csv-import-stat-label">Sites</div>
                        </div>
                        <div class="csv-import-stat">
                            <div class="csv-import-stat-value">${stats.weekRange}</div>
                            <div class="csv-import-stat-label">Week</div>
                        </div>
                    </div>
                `;
                } else if (this.detectedType === 'guards') {
                    statsHtml = `
                    <div class="csv-import-stats">
                        <div class="csv-import-stat">
                            <div class="csv-import-stat-value">${this.parsedData.length}</div>
                            <div class="csv-import-stat-label">Guards</div>
                        </div>
                    </div>
                `;
                } else if (this.detectedType === 'contacts') {
                    // Count by category if available
                    const categoryField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'category');
                    let categoryBreakdown = '';
                    if (categoryField) {
                        const categories = {};
                        this.parsedData.forEach(row => {
                            const cat = row[categoryField] || 'Uncategorized';
                            categories[cat] = (categories[cat] || 0) + 1;
                        });
                        categoryBreakdown = Object.entries(categories).map(([cat, count]) =>
                            `<div class="csv-import-stat"><div class="csv-import-stat-value">${count}</div><div class="csv-import-stat-label">${Utils.escapeHtml(cat)}</div></div>`
                        ).join('');
                    }

                    statsHtml = `
                    <div class="csv-import-stats">
                        <div class="csv-import-stat">
                            <div class="csv-import-stat-value">${this.parsedData.length}</div>
                            <div class="csv-import-stat-label">Contacts</div>
                        </div>
                        ${categoryBreakdown}
                    </div>
                `;
                }

                // Field mapping display
                let mappingHtml = '<div style="margin-bottom: var(--space-4);"><h4 style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-3);">Field Mapping</h4>';
                const headers = Object.keys(this.parsedData[0]);

                for (const header of headers) {
                    const target = this.fieldMapping[header];
                    mappingHtml += `
                    <div class="field-mapping-row">
                        <span class="field-mapping-source">${Utils.escapeHtml(header)}</span>
                        <span class="field-mapping-arrow">â†’</span>
                        <span class="field-mapping-target ${target ? 'mapped' : 'unmapped'}">${target || 'ignored'}</span>
                    </div>
                `;
                }
                mappingHtml += '</div>';

                // Preview table
                const previewRows = this.parsedData.slice(0, 5);
                let tableHtml = '<div style="overflow-x: auto; margin-bottom: var(--space-4);"><h4 style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-3);">Data Preview</h4>';
                tableHtml += '<table class="csv-preview-table"><thead><tr>';

                for (const header of headers.slice(0, 6)) {
                    tableHtml += `<th>${Utils.escapeHtml(header)}</th>`;
                }
                if (headers.length > 6) tableHtml += '<th>...</th>';
                tableHtml += '</tr></thead><tbody>';

                for (const row of previewRows) {
                    tableHtml += '<tr>';
                    for (const header of headers.slice(0, 6)) {
                        tableHtml += `<td>${Utils.escapeHtml(row[header] || '')}</td>`;
                    }
                    if (headers.length > 6) tableHtml += '<td>...</td>';
                    tableHtml += '</tr>';
                }

                if (this.parsedData.length > 5) {
                    tableHtml += `<tr><td colspan="${Math.min(headers.length, 7)}" style="text-align: center; color: var(--color-text-muted);">... and ${this.parsedData.length - 5} more rows</td></tr>`;
                }

                tableHtml += '</tbody></table></div>';

                const content = `
                <div style="margin-bottom: var(--space-4);">
                    <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-4);">
                        <span style="font-size: 1.5rem;">${typeInfo.icon}</span>
                        <div>
                            <div style="font-weight: var(--font-weight-semibold);">${Utils.escapeHtml(fileName)}</div>
                            <span class="badge badge-${typeInfo.color}">${typeInfo.label}</span>
                            ${this.parsedData.length > 500 ? '<span class="badge badge-warning" style="margin-left: var(--space-2);">Large File</span>' : ''}
                        </div>
                    </div>
                    ${statsHtml}
                </div>
                ${mappingHtml}
                ${tableHtml}
                ${this.detectedType === 'schedule' ? `
                    <div class="form-group" style="background: var(--color-warning-bg); padding: var(--space-3); border-radius: var(--radius-md); border-left: 3px solid var(--color-warning);">
                        <div style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-1);">âš ï¸ Schedule Import</div>
                        <p class="text-sm" style="margin: 0;">This will <strong>replace</strong> any existing shifts for the imported week(s). Old shifts will be removed and replaced with the new data.</p>
                    </div>
                    <input type="hidden" id="csv-import-mode" value="replace">
                ` : `
                <div class="form-group">
                    <label class="form-label">Import Mode</label>
                    <select class="form-select" id="csv-import-mode">
                        <option value="merge">Merge (update existing, add new)</option>
                        <option value="replace">Replace (clear existing data first)</option>
                    </select>
                    <p class="text-sm text-muted mt-2">Merge is recommended â€” it preserves existing data while adding new records.</p>
                </div>
                `}
                <!-- Progress indicator (hidden initially) -->
                <div id="csv-import-progress" style="display: none; margin-top: var(--space-4);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-2);">
                        <span class="text-sm font-medium">Importing...</span>
                        <span class="text-sm text-muted" id="csv-progress-text">0 / ${this.parsedData.length} rows</span>
                    </div>
                    <div style="height: 8px; background: var(--color-surface-elevated); border-radius: var(--radius-full); overflow: hidden;">
                        <div id="csv-progress-bar" style="height: 100%; width: 0%; background: var(--color-primary); transition: width 0.2s ease;"></div>
                    </div>
                </div>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()" id="csv-cancel-btn">Cancel</button>
                <button class="btn btn-primary" onclick="CSVImportModule.executeImport()" id="csv-import-btn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                    </svg>
                    Import Data
                </button>
            `;

                UI.openModal('Import Preview', content, footer, 'lg');
            },

            calculateScheduleStats: function () {
                const employeeField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'employee');
                const siteField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'site');
                const weekStartField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'week_start');

                const guards = new Set();
                const sites = new Set();
                let weekStart = '';

                for (const row of this.parsedData) {
                    if (employeeField && row[employeeField]) guards.add(row[employeeField]);
                    if (siteField && row[siteField]) sites.add(row[siteField]);
                    if (weekStartField && row[weekStartField] && !weekStart) {
                        weekStart = row[weekStartField];
                    }
                }

                // Format week range
                let weekRange = 'N/A';
                if (weekStart) {
                    try {
                        const date = new Date(weekStart);
                        weekRange = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    } catch (e) {
                        weekRange = weekStart;
                    }
                }

                return {
                    totalShifts: this.parsedData.length,
                    uniqueGuards: guards.size,
                    uniqueSites: sites.size,
                    weekRange: weekRange
                };
            },

            // Map role/position strings to standardized values
            mapRole: function (roleStr) {
                if (!roleStr) return 'unarmed';
                const role = roleStr.toLowerCase().trim();

                if (role.includes('super') || role.includes('lead') || role.includes('sgt') || role.includes('sergeant')) {
                    return 'supervisor';
                }
                if (role.includes('arm') || role.includes('gun') || role.includes('weapon')) {
                    return 'armed';
                }
                if (role.includes('float') || role.includes('relief') || role.includes('rover')) {
                    return 'floater';
                }
                return 'unarmed';
            },

            executeImport: async function () {
                const mode = document.getElementById('csv-import-mode').value;
                const CHUNK_SIZE = 500;
                const totalRows = this.parsedData.length;
                const useChunking = totalRows > CHUNK_SIZE;

                // UI elements for progress
                const progressContainer = document.getElementById('csv-import-progress');
                const progressBar = document.getElementById('csv-progress-bar');
                const progressText = document.getElementById('csv-progress-text');
                const importBtn = document.getElementById('csv-import-btn');
                const cancelBtn = document.getElementById('csv-cancel-btn');

                // Show progress for large imports
                if (useChunking && progressContainer) {
                    progressContainer.style.display = 'block';
                    importBtn.disabled = true;
                    importBtn.innerHTML = '<span class="spinner"></span> Importing...';
                    cancelBtn.disabled = true;
                }

                // Helper to update progress
                const updateProgress = (processed) => {
                    if (!useChunking) return;
                    const percent = Math.round((processed / totalRows) * 100);
                    if (progressBar) progressBar.style.width = `${percent}%`;
                    if (progressText) progressText.textContent = `${processed} / ${totalRows} rows`;
                };

                // Helper to yield to UI thread
                const yieldToUI = () => new Promise(resolve => setTimeout(resolve, 0));

                try {
                    let result;

                    switch (this.detectedType) {
                        case 'schedule':
                            result = await this.importScheduleDataChunked(mode, CHUNK_SIZE, updateProgress, yieldToUI);
                            break;
                        case 'guards':
                            result = await this.importGuardDataChunked(mode, CHUNK_SIZE, updateProgress, yieldToUI);
                            break;
                        case 'sites':
                            result = this.importSiteData(mode);
                            break;
                        case 'contacts':
                            result = await this.importContactDataChunked(mode, CHUNK_SIZE, updateProgress, yieldToUI);
                            break;
                        default:
                            throw new Error('Unknown data type');
                    }

                    UI.closeModal();
                    UI.toast('Import Complete', result.message, 'success');

                    // Refresh relevant views
                    if (this.detectedType === 'schedule') {
                        SchedulerModule.render();
                        SitesModule.render();
                    } else if (this.detectedType === 'guards') {
                        RosterModule.render();
                    } else if (this.detectedType === 'sites') {
                        SitesModule.render();
                    } else if (this.detectedType === 'contacts') {
                        ContactsModule.render();
                    }

                    DashboardModule.render();

                } catch (err) {
                    // Reset UI on error
                    if (progressContainer) progressContainer.style.display = 'none';
                    if (importBtn) {
                        importBtn.disabled = false;
                        importBtn.innerHTML = '<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg> Import Data';
                    }
                    if (cancelBtn) cancelBtn.disabled = false;

                    UI.toast('Import Failed', err.message || 'An error occurred during import.', 'error');
                }
            },

            // Chunked version of importScheduleData
            importScheduleDataChunked: async function (mode, chunkSize, updateProgress, yieldToUI) {
                // Get field mappings
                const siteField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'site');
                const employeeField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'employee');
                const phoneField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'phone');
                const positionField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'position');
                const dateField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'date');
                const timeField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'time');
                const startTimeField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'start_time');
                const endTimeField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'end_time');
                const weekStartField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'week_start');

                // Get existing data
                let sites = DataStore.getSites();
                let guards = DataStore.getGuards();
                const schedules = mode === 'replace' ? {} : { ...DataStore.getSchedules() };

                // Track new entities
                const newSites = new Map();
                const newGuards = new Map();
                
                // Group shifts by week
                const shiftsByWeek = {};

                // Process in chunks
                for (let i = 0; i < this.parsedData.length; i++) {
                    const row = this.parsedData[i];

                    // Get or create site
                    const siteName = siteField ? (row[siteField] || '').trim() : '';
                    if (!siteName) continue; // Skip rows without site
                    
                    let site = sites.find(s => s.name.toLowerCase() === siteName.toLowerCase());

                    if (!site) {
                        if (!newSites.has(siteName.toLowerCase())) {
                            site = {
                                id: Utils.generateId('site-'),
                                name: siteName,
                                address: `${siteName}, Newark, NJ`,
                                type: 'residential',
                                managementCompany: '',
                                primaryContacts: [],
                                shiftPatterns: [],
                                sopHighlights: '',
                                riskNotes: ''
                            };
                            newSites.set(siteName.toLowerCase(), site);
                        } else {
                            site = newSites.get(siteName.toLowerCase());
                        }
                    }

                    // Get or create guard (skip if VACANT or empty)
                    const guardName = employeeField ? (row[employeeField] || '').trim() : '';
                    const isVacant = !guardName || 
                                     guardName.toUpperCase() === 'VACANT' || 
                                     guardName.toUpperCase().includes('VACANT') ||
                                     guardName.toUpperCase() === 'OPEN' ||
                                     guardName.toUpperCase() === 'TBD' ||
                                     guardName.toUpperCase() === 'UNFILLED';
                    
                    let guard = null;
                    
                    if (!isVacant) {
                        guard = guards.find(g => g.name.toLowerCase() === guardName.toLowerCase());

                        if (!guard) {
                            if (!newGuards.has(guardName.toLowerCase())) {
                                guard = {
                                    id: Utils.generateId('guard-'),
                                    name: guardName,
                                    phone: phoneField ? (row[phoneField] || '').replace(/\D/g, '') : '',
                                    email: '',
                                    role: positionField ? this.mapRole(row[positionField]) : 'unarmed',
                                    status: 'active',
                                    primarySites: site ? [site.id] : [],
                                    startDate: new Date().toISOString().split('T')[0]
                                };
                                newGuards.set(guardName.toLowerCase(), guard);
                            } else {
                                guard = newGuards.get(guardName.toLowerCase());
                                if (site && !guard.primarySites.includes(site.id)) {
                                    guard.primarySites.push(site.id);
                                }
                            }
                        }
                    }

                    // Parse date
                    let shiftDate = null;
                    if (dateField && row[dateField]) {
                        shiftDate = new Date(row[dateField]);
                    } else if (weekStartField && row[weekStartField]) {
                        shiftDate = new Date(row[weekStartField]);
                    }
                    
                    // Skip if no valid date
                    if (!shiftDate || isNaN(shiftDate.getTime())) continue;

                    const dateStr = Utils.toISODate(shiftDate);
                    const weekKey = Utils.getWeekKey(shiftDate);
                    
                    // Get start and end times
                    let startTime = startTimeField && row[startTimeField] ? row[startTimeField].trim() : null;
                    let endTime = endTimeField && row[endTimeField] ? row[endTimeField].trim() : null;
                    
                    // Build shift label
                    let shiftLabel = null;
                    const rawTimeValue = timeField && row[timeField] ? row[timeField].trim() : null;
                    
                    // v6.8.6: Parse combined time formats like "00:00-08:00" or "8:00am-4:00pm"
                    if (rawTimeValue && rawTimeValue.includes('-')) {
                        const timeParts = rawTimeValue.split('-').map(t => t.trim());
                        if (timeParts.length === 2) {
                            // Parse each time part to extract hours
                            const parseTimePart = (t) => {
                                // Handle formats: "00:00", "8:00", "8:00am", "16:00", "4:00pm", "12A", "8A"
                                const normalized = t.toLowerCase().replace(/\s+/g, '');
                                
                                // Already in friendly format like "8A", "12P"
                                if (/^\d{1,2}[ap]$/i.test(normalized)) {
                                    return { friendly: t.toUpperCase(), time24: null };
                                }
                                
                                let hours = 0;
                                let isPM = normalized.includes('p');
                                let isAM = normalized.includes('a');
                                
                                // Extract numeric part
                                const match = normalized.match(/^(\d{1,2}):?(\d{2})?/);
                                if (match) {
                                    hours = parseInt(match[1], 10);
                                    
                                    // Handle am/pm
                                    if (isPM && hours < 12) hours += 12;
                                    if (isAM && hours === 12) hours = 0;
                                }
                                
                                // Convert to 24-hour format string
                                const time24 = String(hours).padStart(2, '0') + ':00';
                                
                                // Convert to friendly format
                                let friendly;
                                if (hours === 0) friendly = '12A';
                                else if (hours === 12) friendly = '12P';
                                else if (hours < 12) friendly = hours + 'A';
                                else friendly = (hours - 12) + 'P';
                                
                                return { friendly, time24 };
                            };
                            
                            const startParsed = parseTimePart(timeParts[0]);
                            const endParsed = parseTimePart(timeParts[1]);
                            
                            shiftLabel = `${startParsed.friendly}-${endParsed.friendly}`;
                            if (!startTime) startTime = startParsed.time24;
                            if (!endTime) endTime = endParsed.time24;
                        }
                    }
                    
                    // Fallback: use separate start/end time fields
                    if (!shiftLabel && startTime && endTime) {
                        // Format times for label (e.g., "8A-4P")
                        const formatTimeLabel = (t) => {
                            if (!t) return '';
                            const [h, m] = t.split(':').map(Number);
                            if (h === 0) return '12A';
                            if (h === 12) return '12P';
                            return h < 12 ? `${h}A` : `${h - 12}P`;
                        };
                        shiftLabel = `${formatTimeLabel(startTime)}-${formatTimeLabel(endTime)}`;
                    }
                    if (!shiftLabel) shiftLabel = 'Day';

                    // Initialize week bucket if needed
                    if (!shiftsByWeek[weekKey]) {
                        shiftsByWeek[weekKey] = [];
                    }

                    // Create shift (guard is optional - null for VACANT)
                    shiftsByWeek[weekKey].push({
                        id: Utils.generateId('shift-'),
                        siteId: site.id,
                        guardId: guard ? guard.id : null,
                        date: dateStr,
                        shiftLabel: shiftLabel,
                        startTime: startTime,
                        endTime: endTime,
                        status: guard ? 'confirmed' : 'OPEN'
                    });

                    // Update progress and yield every chunk
                    if ((i + 1) % chunkSize === 0 || i === this.parsedData.length - 1) {
                        updateProgress(i + 1);
                        await yieldToUI();
                    }
                }

                // Save all new sites
                if (newSites.size > 0) {
                    sites = [...sites, ...newSites.values()];
                    DataStore.saveSites(sites);
                }

                // Save all new guards
                if (newGuards.size > 0) {
                    guards = [...guards, ...newGuards.values()];
                    DataStore.saveGuards(guards);
                }

                // v6.8.6: ALWAYS REPLACE schedule weeks - no merge confusion
                // When you import a new schedule for a week, it completely replaces old data
                let totalShifts = 0;
                let weeksCleared = [];
                
                for (const [weekKey, weekShifts] of Object.entries(shiftsByWeek)) {
                    // Check if we're replacing existing data
                    if (schedules[weekKey] && schedules[weekKey].length > 0) {
                        weeksCleared.push({ week: weekKey, oldCount: schedules[weekKey].length });
                    }
                    
                    // Replace the entire week's schedule
                    schedules[weekKey] = weekShifts;
                    totalShifts += weekShifts.length;
                }
                DataStore.saveSchedules(schedules);

                // Build result message
                // v6.8.6: Updated result message
                let message = `Imported ${totalShifts} shifts`;
                if (newGuards.size > 0) message += `, ${newGuards.size} new guards`;
                if (newSites.size > 0) message += `, ${newSites.size} new sites`;
                message += '.';
                
                if (weeksCleared.length > 0) {
                    const totalOld = weeksCleared.reduce((sum, w) => sum + w.oldCount, 0);
                    message += ` Replaced ${totalOld} old shifts.`;
                }
                
                return { message };
            },

            // Chunked version of importGuardData
            importGuardDataChunked: async function (mode, chunkSize, updateProgress, yieldToUI) {
                const nameField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'name');
                const phoneField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'phone');
                const emailField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'email');
                const roleField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'role');

                let guards = mode === 'replace' ? [] : DataStore.getGuards();
                const existingNames = new Set(guards.map(g => g.name.toLowerCase()));
                let newCount = 0;
                let updatedCount = 0;

                for (let i = 0; i < this.parsedData.length; i++) {
                    const row = this.parsedData[i];
                    const name = nameField ? row[nameField]?.trim() : '';

                    if (!name) continue;

                    const existingIdx = guards.findIndex(g => g.name.toLowerCase() === name.toLowerCase());

                    const guardData = {
                        name: name,
                        phone: phoneField ? row[phoneField]?.replace(/\D/g, '') : '',
                        email: emailField ? row[emailField]?.trim() : '',
                        role: roleField ? this.mapRole(row[roleField]) : 'unarmed',
                        status: 'active',
                        primarySites: [],
                        startDate: new Date().toISOString().split('T')[0]
                    };

                    if (existingIdx !== -1) {
                        // Update existing
                        Object.assign(guards[existingIdx], guardData);
                        updatedCount++;
                    } else {
                        // Add new
                        guards.push({
                            id: Utils.generateId('guard-'),
                            ...guardData
                        });
                        newCount++;
                    }

                    // Update progress and yield every chunk
                    if ((i + 1) % chunkSize === 0 || i === this.parsedData.length - 1) {
                        updateProgress(i + 1);
                        await yieldToUI();
                    }
                }

                DataStore.saveGuards(guards);

                return {
                    message: `Added ${newCount} new guards, updated ${updatedCount} existing.`
                };
            },

            // Chunked version of importContactData
            importContactDataChunked: async function (mode, chunkSize, updateProgress, yieldToUI) {
                const nameField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'name');
                const phoneField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'phone');
                const emailField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'email');
                const companyField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'company');
                const titleField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'title');
                const categoryField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'category');
                const notesField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'notes');

                let contacts = mode === 'replace' ? [] : DataStore.getContacts();
                let newCount = 0;
                let updatedCount = 0;

                for (let i = 0; i < this.parsedData.length; i++) {
                    const row = this.parsedData[i];
                    const name = nameField ? row[nameField]?.trim() : '';

                    if (!name) continue;

                    // Try to find existing contact by name + company
                    const company = companyField ? row[companyField]?.trim() : '';
                    const existingIdx = contacts.findIndex(c =>
                        c.name.toLowerCase() === name.toLowerCase() &&
                        (!company || (c.company || '').toLowerCase() === company.toLowerCase())
                    );

                    // Map category to our types
                    let category = 'staff';
                    if (categoryField && row[categoryField]) {
                        const rawCat = row[categoryField].toLowerCase();
                        if (rawCat.includes('vendor') || rawCat.includes('supplier')) {
                            category = 'vendor';
                        } else if (rawCat.includes('client') || rawCat.includes('customer') || rawCat.includes('property')) {
                            category = 'client';
                        } else if (rawCat.includes('emergency') || rawCat.includes('fire') || rawCat.includes('police')) {
                            category = 'emergency';
                        }
                    }

                    const contactData = {
                        name: name,
                        phone: phoneField ? row[phoneField]?.replace(/\D/g, '') : '',
                        email: emailField ? row[emailField]?.trim() : '',
                        company: company,
                        title: titleField ? row[titleField]?.trim() : '',
                        category: category,
                        notes: notesField ? row[notesField]?.trim() : '',
                        siteId: null
                    };

                    if (existingIdx !== -1) {
                        // Update existing
                        Object.assign(contacts[existingIdx], contactData, { updatedAt: new Date().toISOString() });
                        updatedCount++;
                    } else {
                        // Add new
                        contacts.push({
                            id: Utils.generateId('contact-'),
                            ...contactData,
                            createdAt: new Date().toISOString()
                        });
                        newCount++;
                    }

                    // Update progress and yield every chunk
                    if ((i + 1) % chunkSize === 0 || i === this.parsedData.length - 1) {
                        updateProgress(i + 1);
                        await yieldToUI();
                    }
                }

                DataStore.saveContacts(contacts);

                return {
                    message: `Added ${newCount} new contacts, updated ${updatedCount} existing.`
                };
            },

            importScheduleData: function (mode) {
                // Get field mappings
                const siteField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'site');
                const employeeField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'employee');
                const phoneField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'phone');
                const positionField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'position');
                const dateField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'date');
                const timeField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'time');
                const weekStartField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'week_start');

                // Get existing data
                let sites = DataStore.getSites();
                let guards = DataStore.getGuards();
                const schedules = mode === 'replace' ? {} : DataStore.getSchedules();

                // Track new entities
                const newSites = new Map();
                const newGuards = new Map();
                const processedShifts = [];

                // Determine week key from first row
                let weekKey = null;
                if (weekStartField && this.parsedData[0][weekStartField]) {
                    const weekStart = new Date(this.parsedData[0][weekStartField]);
                    weekKey = Utils.getWeekKey(weekStart);
                }

                // Process each row
                for (const row of this.parsedData) {
                    // Get or create site
                    const siteName = siteField ? row[siteField]?.trim() : '';
                    let site = sites.find(s => s.name.toLowerCase() === siteName.toLowerCase());

                    if (!site && siteName) {
                        if (!newSites.has(siteName)) {
                            site = {
                                id: Utils.generateId('site-'),
                                name: siteName,
                                address: `${siteName}, Newark, NJ`,
                                type: 'residential',
                                managementCompany: '',
                                primaryContacts: [],
                                shiftPatterns: [],
                                sopHighlights: '',
                                riskNotes: ''
                            };
                            newSites.set(siteName, site);
                        } else {
                            site = newSites.get(siteName);
                        }
                    }

                    // Get or create guard
                    const guardName = employeeField ? row[employeeField]?.trim() : '';
                    const guardPhone = phoneField ? this.normalizePhone(row[phoneField]) : '';
                    const guardRole = positionField ? this.normalizeRole(row[positionField]) : 'guard';

                    let guard = guards.find(g =>
                        g.name.toLowerCase() === guardName.toLowerCase() ||
                        (guardPhone && g.phone === guardPhone)
                    );

                    if (!guard && guardName) {
                        if (!newGuards.has(guardName)) {
                            guard = {
                                id: Utils.generateId('guard-'),
                                name: this.normalizeName(guardName),
                                phone: guardPhone,
                                email: '',
                                primarySites: site ? [site.id] : [],
                                role: guardRole,
                                status: 'active'
                            };
                            newGuards.set(guardName, guard);
                        } else {
                            guard = newGuards.get(guardName);
                            // Update phone if we have it now
                            if (guardPhone && !guard.phone) {
                                guard.phone = guardPhone;
                            }
                            // Add site to primary sites
                            if (site && !guard.primarySites.includes(site.id)) {
                                guard.primarySites.push(site.id);
                            }
                        }
                    }

                    // Parse date
                    let shiftDate = null;
                    if (dateField && row[dateField]) {
                        shiftDate = this.parseDateLabel(row[dateField], weekStartField ? row[weekStartField] : null);
                    }

                    // Parse time/shift
                    const timeLabel = timeField ? row[timeField] : '';
                    const { startTime, endTime, shiftLabel } = this.parseTimeLabel(timeLabel);

                    // Create shift record
                    if (site && shiftDate) {
                        const shift = {
                            id: Utils.generateId('shift-'),
                            date: shiftDate,
                            siteId: site.id,
                            shiftLabel: shiftLabel || timeLabel,
                            startTime: startTime,
                            endTime: endTime,
                            guardId: guard ? guard.id : null,
                            status: guard ? 'ASSIGNED' : 'OPEN',
                            notes: ''
                        };
                        processedShifts.push(shift);
                    }
                }

                // Save new sites
                if (newSites.size > 0) {
                    sites = [...sites, ...newSites.values()];
                    DataStore.saveSites(sites);
                }

                // Save new guards
                if (newGuards.size > 0) {
                    guards = [...guards, ...newGuards.values()];
                    DataStore.saveGuards(guards);
                }

                // v6.8.6: ALWAYS REPLACE the week's schedule - no merge confusion
                let replacedCount = 0;
                if (weekKey && processedShifts.length > 0) {
                    if (schedules[weekKey]) {
                        replacedCount = schedules[weekKey].length;
                    }
                    schedules[weekKey] = processedShifts;
                    DataStore.saveSchedules(schedules);
                }

                let message = `Imported ${processedShifts.length} shifts`;
                if (newGuards.size > 0) message += `, ${newGuards.size} new guards`;
                if (newSites.size > 0) message += `, ${newSites.size} new sites`;
                if (replacedCount > 0) message += `. Replaced ${replacedCount} old shifts`;
                message += '.';

                return {
                    message: message,
                    shiftsImported: processedShifts.length,
                    guardsAdded: newGuards.size,
                    sitesAdded: newSites.size
                };
            },

            importGuardData: function (mode) {
                const nameField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'name');
                const phoneField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'phone');
                const emailField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'email');
                const roleField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'role');
                const statusField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'status');

                let guards = mode === 'replace' ? [] : DataStore.getGuards();
                let added = 0, updated = 0;

                for (const row of this.parsedData) {
                    const name = nameField ? this.normalizeName(row[nameField]) : '';
                    if (!name) continue;

                    const phone = phoneField ? this.normalizePhone(row[phoneField]) : '';
                    const email = emailField ? row[emailField]?.trim() : '';
                    const role = roleField ? this.normalizeRole(row[roleField]) : 'guard';
                    const status = statusField ? this.normalizeStatus(row[statusField]) : 'active';

                    // Check for existing guard
                    const existingIdx = guards.findIndex(g =>
                        g.name.toLowerCase() === name.toLowerCase() ||
                        (phone && g.phone === phone)
                    );

                    if (existingIdx >= 0) {
                        // Update existing
                        guards[existingIdx] = {
                            ...guards[existingIdx],
                            name: name,
                            phone: phone || guards[existingIdx].phone,
                            email: email || guards[existingIdx].email,
                            role: role,
                            status: status
                        };
                        updated++;
                    } else {
                        // Add new
                        guards.push({
                            id: Utils.generateId('guard-'),
                            name: name,
                            phone: phone,
                            email: email,
                            primarySites: [],
                            role: role,
                            status: status
                        });
                        added++;
                    }
                }

                DataStore.saveGuards(guards);

                return {
                    message: `Added ${added} new guards, updated ${updated} existing.`,
                    added: added,
                    updated: updated
                };
            },

            importSiteData: function (mode) {
                const nameField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'name');
                const addressField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'address');
                const typeField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'type');
                const mgmtField = Object.keys(this.fieldMapping).find(k => this.fieldMapping[k] === 'management');

                let sites = mode === 'replace' ? [] : DataStore.getSites();
                let added = 0, updated = 0;

                for (const row of this.parsedData) {
                    const name = nameField ? row[nameField]?.trim() : '';
                    if (!name) continue;

                    const address = addressField ? row[addressField]?.trim() : `${name}, Newark, NJ`;
                    const type = typeField ? row[typeField]?.toLowerCase() : 'residential';
                    const management = mgmtField ? row[mgmtField]?.trim() : '';

                    // Check for existing site
                    const existingIdx = sites.findIndex(s =>
                        s.name.toLowerCase() === name.toLowerCase()
                    );

                    if (existingIdx >= 0) {
                        sites[existingIdx] = {
                            ...sites[existingIdx],
                            name: name,
                            address: address || sites[existingIdx].address,
                            type: type || sites[existingIdx].type,
                            managementCompany: management || sites[existingIdx].managementCompany
                        };
                        updated++;
                    } else {
                        sites.push({
                            id: Utils.generateId('site-'),
                            name: name,
                            address: address,
                            type: type,
                            managementCompany: management,
                            primaryContacts: [],
                            shiftPatterns: [
                                { label: '12Aâ€“8A', startTime: '00:00', endTime: '08:00' },
                                { label: '8Aâ€“4P', startTime: '08:00', endTime: '16:00' },
                                { label: '4Pâ€“12A', startTime: '16:00', endTime: '00:00' }
                            ],
                            sopHighlights: '',
                            riskNotes: ''
                        });
                        added++;
                    }
                }

                DataStore.saveSites(sites);

                return {
                    message: `Added ${added} new sites, updated ${updated} existing.`,
                    added: added,
                    updated: updated
                };
            },

            // Utility functions for normalization
            normalizePhone: function (phone) {
                if (!phone) return '';
                // Remove all non-digits
                const digits = String(phone).replace(/\D/g, '');
                if (digits.length === 10) {
                    return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
                } else if (digits.length === 11 && digits[0] === '1') {
                    return `(${digits.slice(1, 4)}) ${digits.slice(4, 7)}-${digits.slice(7)}`;
                } else if (digits.length === 7) {
                    // Local number without area code
                    return `${digits.slice(0, 3)}-${digits.slice(3)}`;
                }
                return String(phone).trim();
            },

            normalizeName: function (name) {
                if (!name) return '';
                return name.trim()
                    .split(/\s+/)
                    .map(part => part.charAt(0).toUpperCase() + part.slice(1).toLowerCase())
                    .join(' ');
            },

            normalizeRole: function (role) {
                if (!role) return 'unarmed';
                const lower = role.toLowerCase();
                if (lower.includes('super') || lower.includes('lead')) return 'supervisor';
                if (lower.includes('float')) return 'floater';
                if (lower.includes('armed') && !lower.includes('unarmed')) return 'armed';
                if (lower.includes('unarmed')) return 'unarmed';
                return 'unarmed';
            },

            normalizeStatus: function (status) {
                if (!status) return 'active';
                const lower = status.toLowerCase();
                if (lower.includes('active') || lower.includes('yes') || lower === '1') return 'active';
                if (lower.includes('leave') || lower.includes('off')) return 'on_leave';
                if (lower.includes('term') || lower.includes('inactive') || lower === '0') return 'terminated';
                return 'active';
            },

            parseDateLabel: function (dateLabel, weekStart) {
                // Try parsing "Mon Dec 1st" format
                const monthDayMatch = dateLabel.match(/\w+\s+(\w+)\s+(\d+)/);
                if (monthDayMatch && weekStart) {
                    const monthNames = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                    const monthIdx = monthNames.findIndex(m => monthDayMatch[1].toLowerCase().startsWith(m));
                    const day = parseInt(monthDayMatch[2]);

                    if (monthIdx >= 0 && day > 0) {
                        const wsDate = new Date(weekStart);
                        const year = wsDate.getFullYear();
                        const date = new Date(year, monthIdx, day);
                        return Utils.toISODate(date);
                    }
                }

                // Try direct date parsing
                try {
                    const date = new Date(dateLabel);
                    if (!isNaN(date.getTime())) {
                        return Utils.toISODate(date);
                    }
                } catch (e) { }

                return null;
            },

            parseTimeLabel: function (timeLabel) {
                if (!timeLabel) return { startTime: '00:00', endTime: '08:00', shiftLabel: '12A-8A' };

                // v6.8.6: Handle multiple formats
                // Format 1: "12:00am-8:00am" or "8:00am-4:00pm" 
                // Format 2: "00:00-08:00" (24-hour)
                // Format 3: "8A-4P" (already friendly)
                
                const formatHour = (h) => {
                    const h12 = h % 12 || 12;
                    const ampm = h >= 12 ? 'P' : 'A';
                    return `${h12}${ampm}`;
                };
                
                // Check for already-friendly format like "8A-4P"
                const friendlyMatch = timeLabel.match(/^(\d{1,2})([AP])\s*[-â€“]\s*(\d{1,2})([AP])$/i);
                if (friendlyMatch) {
                    let startH = parseInt(friendlyMatch[1]);
                    let endH = parseInt(friendlyMatch[3]);
                    const startIsPM = friendlyMatch[2].toUpperCase() === 'P';
                    const endIsPM = friendlyMatch[4].toUpperCase() === 'P';
                    
                    if (startIsPM && startH !== 12) startH += 12;
                    if (!startIsPM && startH === 12) startH = 0;
                    if (endIsPM && endH !== 12) endH += 12;
                    if (!endIsPM && endH === 12) endH = 0;
                    
                    return {
                        startTime: `${String(startH).padStart(2, '0')}:00`,
                        endTime: `${String(endH).padStart(2, '0')}:00`,
                        shiftLabel: timeLabel.toUpperCase()
                    };
                }
                
                // Check for 24-hour format like "00:00-08:00" or "16:00-00:00"
                const time24Match = timeLabel.match(/^(\d{1,2}):(\d{2})\s*[-â€“]\s*(\d{1,2}):(\d{2})$/);
                if (time24Match) {
                    const startH = parseInt(time24Match[1]);
                    const startM = time24Match[2];
                    const endH = parseInt(time24Match[3]);
                    const endM = time24Match[4];
                    
                    const startTime = `${String(startH).padStart(2, '0')}:${startM}`;
                    const endTime = `${String(endH).padStart(2, '0')}:${endM}`;
                    const shiftLabel = `${formatHour(startH)}-${formatHour(endH)}`;
                    
                    return { startTime, endTime, shiftLabel };
                }

                // Parse "12:00am-8:00am" or "8:00am-4:00pm" format
                const ampmMatch = timeLabel.match(/(\d{1,2}):?(\d{2})?\s*(am|pm)\s*[-â€“]\s*(\d{1,2}):?(\d{2})?\s*(am|pm)/i);

                if (ampmMatch) {
                    const startHour = parseInt(ampmMatch[1]);
                    const startMin = ampmMatch[2] || '00';
                    const startAmPm = ampmMatch[3].toLowerCase();
                    const endHour = parseInt(ampmMatch[4]);
                    const endMin = ampmMatch[5] || '00';
                    const endAmPm = ampmMatch[6].toLowerCase();

                    let startH = startHour;
                    let endH = endHour;

                    if (startAmPm === 'pm' && startHour !== 12) startH += 12;
                    if (startAmPm === 'am' && startHour === 12) startH = 0;
                    if (endAmPm === 'pm' && endHour !== 12) endH += 12;
                    if (endAmPm === 'am' && endHour === 12) endH = 0;

                    const startTime = `${String(startH).padStart(2, '0')}:${startMin}`;
                    const endTime = `${String(endH).padStart(2, '0')}:${endMin}`;
                    const shiftLabel = `${formatHour(startH)}-${formatHour(endH)}`;

                    return { startTime, endTime, shiftLabel };
                }

                // Return defaults with original label preserved
                return { startTime: '00:00', endTime: '08:00', shiftLabel: timeLabel };
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SETTINGS MODULE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const SettingsModule = {
            init: function () {
                document.getElementById('settings-theme')?.addEventListener('change', (e) => {
                    this.setTheme(e.target.value);
                });

                document.getElementById('export-backup')?.addEventListener('click', () => this.exportBackup());
                document.getElementById('import-backup')?.addEventListener('click', () => {
                    document.getElementById('import-backup-file').click();
                });
                document.getElementById('import-backup-file')?.addEventListener('change', (e) => this.importBackup(e));
                document.getElementById('clear-data')?.addEventListener('click', () => this.clearData());

                // API Key management
                document.getElementById('save-api-key')?.addEventListener('click', () => this.saveApiKey());
                document.getElementById('test-api-key')?.addEventListener('click', () => this.testApiKey());
                document.getElementById('clear-api-key')?.addEventListener('click', () => this.clearApiKey());
                document.getElementById('toggle-api-key-visibility')?.addEventListener('click', () => this.toggleApiKeyVisibility());

                // Cloud Backup management
                document.getElementById('save-cloud-backup-url')?.addEventListener('click', () => this.saveCloudBackupURL());
                document.getElementById('test-cloud-backup')?.addEventListener('click', () => this.testCloudBackup());
                document.getElementById('view-backup-instructions')?.addEventListener('click', () => this.showBackupInstructions());
            

                // SOP Master import
                document.getElementById('import-sop-master-btn')?.addEventListener('click', () => {
                    document.getElementById('import-sop-master-file')?.click();
                });
                document.getElementById('import-sop-master-file')?.addEventListener('change', (e) => this.importSOPMaster(e));
                document.getElementById('clear-sop-imports-btn')?.addEventListener('click', () => this.clearSOPImports());

                // Protocol import/export (SOP integration)
                document.getElementById('export-protocols-btn')?.addEventListener('click', () => this.exportProtocols());
                document.getElementById('import-protocols-btn')?.addEventListener('click', () => {
                    document.getElementById('import-protocols-file')?.click();
                });
                document.getElementById('import-protocols-file')?.addEventListener('change', (e) => this.importProtocols(e));
},

            render: function () {
                const settings = DataStore.getSettings();
                document.getElementById('settings-theme').value = settings.theme || 'dark';

                // Load API key status
                const apiKey = localStorage.getItem('sentinel_api_key');
                const apiKeyInput = document.getElementById('settings-api-key');
                const statusDiv = document.getElementById('api-key-status');

                if (apiKey) {
                    apiKeyInput.value = apiKey;
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) var(--space-3); background: var(--color-success-bg); border: 1px solid var(--color-success); border-radius: var(--radius-md);">
                        <svg width="16" height="16" fill="none" stroke="var(--color-success)" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span class="text-sm" style="color: var(--color-success);">API key configured</span>
                    </div>
                `;
                } else {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) var(--space-3); background: var(--color-warning-bg); border: 1px solid var(--color-warning); border-radius: var(--radius-md);">
                        <svg width="16" height="16" fill="none" stroke="var(--color-warning)" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <span class="text-sm" style="color: var(--color-warning);">No API key configured â€” AI Assistant disabled</span>
                    </div>
                `;
                }

                this.renderProtocolManager();
            },

            saveApiKey: function () {
                const apiKeyInput = document.getElementById('settings-api-key');
                const apiKey = apiKeyInput.value.trim();

                if (!apiKey) {
                    UI.toast('Error', 'Please enter an API key.', 'error');
                    return;
                }

                if (!apiKey.startsWith('sk-ant-')) {
                    UI.toast('Warning', 'This doesn\'t look like a valid Anthropic API key. Keys usually start with sk-ant-', 'warning');
                }

                localStorage.setItem('sentinel_api_key', apiKey);
                this.render();
                UI.toast('API Key Saved', 'Your API key has been saved locally in this browser.', 'success');
            },

            testApiKey: async function () {
                const apiKey = localStorage.getItem('sentinel_api_key');

                if (!apiKey) {
                    UI.toast('No API Key', 'Please save an API key first.', 'warning');
                    return;
                }

                const statusDiv = document.getElementById('api-key-status');
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) var(--space-3); background: var(--color-info-bg); border: 1px solid var(--color-info); border-radius: var(--radius-md);">
                    <svg width="16" height="16" fill="none" stroke="var(--color-info)" viewBox="0 0 24 24" style="animation: spin 1s linear infinite;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    <span class="text-sm" style="color: var(--color-info);">Testing connection...</span>
                </div>
            `;

                try {
                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "x-api-key": apiKey,
                            "anthropic-version": "2023-06-01",
                            "anthropic-dangerous-direct-browser-access": "true"
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 10,
                            messages: [{ role: "user", content: "Hi" }]
                        })
                    });

                    if (response.ok) {
                        statusDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) var(--space-3); background: var(--color-success-bg); border: 1px solid var(--color-success); border-radius: var(--radius-md);">
                            <svg width="16" height="16" fill="none" stroke="var(--color-success)" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span class="text-sm" style="color: var(--color-success);">âœ“ Connection successful! AI Assistant is ready.</span>
                        </div>
                    `;
                        UI.toast('Success', 'API key is valid and working!', 'success');
                    } else {
                        const error = await response.json();
                        throw new Error(error.error?.message || 'Invalid API key');
                    }
                } catch (error) {
                    statusDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) var(--space-3); background: var(--color-danger-bg); border: 1px solid var(--color-danger); border-radius: var(--radius-md);">
                        <svg width="16" height="16" fill="none" stroke="var(--color-danger)" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span class="text-sm" style="color: var(--color-danger);">âœ— Connection failed: ${Utils.escapeHtml(error.message)}</span>
                    </div>
                `;
                    UI.toast('Connection Failed', error.message, 'error');
                }
            },

            clearApiKey: function () {
                localStorage.removeItem('sentinel_api_key');
                document.getElementById('settings-api-key').value = '';
                this.render();
                UI.toast('API Key Removed', 'Your API key has been deleted.', 'success');
            },

            toggleApiKeyVisibility: function () {
                const input = document.getElementById('settings-api-key');
                const btn = document.getElementById('toggle-api-key-visibility');

                if (input.type === 'password') {
                    input.type = 'text';
                    btn.textContent = 'Hide';
                } else {
                    input.type = 'password';
                    btn.textContent = 'Show';
                }
            },

            saveCloudBackupURL: function () {
                const urlInput = document.getElementById('cloud-backup-url');
                const url = urlInput.value.trim();

                if (!url) {
                    UI.toast('Error', 'Please enter a Google Apps Script URL.', 'error');
                    return;
                }

                if (!url.includes('script.google.com') || !url.includes('/exec')) {
                    UI.toast('Warning', 'This doesn\'t look like a valid Google Apps Script deployment URL. It should contain "script.google.com" and end with "/exec".', 'warning');
                }

                AutoBackup.setWebhookURL(url);
                AutoBackup.startScheduler(); // Start scheduler with new URL
                UI.toast('URL Saved', 'Cloud backup URL saved. Automated backups will run daily at 3 AM UTC.', 'success');
                
                const statusDiv = document.getElementById('cloud-backup-status');
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: var(--space-2);">
                        <div style="font-size: 1.25rem;">âœ…</div>
                        <div style="flex: 1;">
                            <div style="font-weight: var(--font-weight-semibold); color: var(--color-success);">
                                Automated Backup Enabled
                            </div>
                            <div class="text-sm text-muted" style="margin-top: 2px;">
                                Next backup: Daily at 3:00 AM UTC
                            </div>
                            <div class="text-xs text-muted" style="margin-top: 4px;">
                                Backups saved to: Sentinel_Ops_Backups folder in Google Drive
                            </div>
                        </div>
                    </div>
                `;
            },

            testCloudBackup: function () {
                const url = document.getElementById('cloud-backup-url').value.trim();
                
                if (!url) {
                    UI.toast('Error', 'Please save a URL first.', 'error');
                    return;
                }

                UI.toast('Testing backup...', 'Sending test backup to Google Drive.', 'info');
                AutoBackup.performCloudBackup(true); // Manual backup
            },

            showBackupInstructions: function () {
                const instructions = `
                    <div style="max-height: 60vh; overflow-y: auto; padding-right: var(--space-2);">
                        <h3 style="margin-bottom: var(--space-4); color: var(--color-primary);">
                            Google Drive Auto-Backup Setup
                        </h3>

                        <div style="margin-bottom: var(--space-5);">
                            <h4 style="margin-bottom: var(--space-2); font-weight: var(--font-weight-semibold);">
                                Step 1: Create Google Apps Script
                            </h4>
                            <ol style="margin-left: var(--space-4); line-height: 1.8;">
                                <li>Go to <a href="https://script.google.com" target="_blank" style="color: var(--color-primary);">script.google.com</a></li>
                                <li>Click <strong>+ New project</strong></li>
                                <li>Replace default code with the script below</li>
                                <li>Save the project (File â†’ Save or Ctrl+S)</li>
                            </ol>
                        </div>

                        <div style="margin-bottom: var(--space-5);">
                            <h4 style="margin-bottom: var(--space-2); font-weight: var(--font-weight-semibold);">
                                Google Apps Script Code
                            </h4>
                            <div style="position: relative;">
                                <pre style="background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md); overflow-x: auto; font-size: 0.75rem; line-height: 1.4;"><code>function doPost(e) {
  const FOLDER_NAME = 'Sentinel_Ops_Backups';
  
  let data;
  try {
    data = JSON.parse(e.postData.contents);
  } catch (err) {
    return ContentService.createTextOutput(
      JSON.stringify({ status: 'error', message: 'Invalid JSON' })
    ).setMimeType(ContentService.MimeType.JSON);
  }

  let folder;
  const folders = DriveApp.getFoldersByName(FOLDER_NAME);
  if (folders.hasNext()) {
    folder = folders.next();
  } else {
    folder = DriveApp.createFolder(FOLDER_NAME);
  }

  const timestamp = new Date().toISOString().replace(/:/g, '-');
  const fileName = 'Sentinel_Backup_' + timestamp + '.json';
  const fileContent = JSON.stringify(data, null, 2);

  folder.createFile(fileName, fileContent, MimeType.JSON);

  return ContentService.createTextOutput(
    JSON.stringify({ 
      status: 'success', 
      message: 'Backup saved: ' + fileName 
    })
  ).setMimeType(ContentService.MimeType.JSON);
}</code></pre>
                                <button onclick="navigator.clipboard.writeText(this.previousElementSibling.textContent)" 
                                    class="btn btn-sm btn-ghost" 
                                    style="position: absolute; top: var(--space-2); right: var(--space-2);">
                                    Copy Code
                                </button>
                            </div>
                        </div>

                        <div style="margin-bottom: var(--space-5);">
                            <h4 style="margin-bottom: var(--space-2); font-weight: var(--font-weight-semibold);">
                                Step 2: Deploy as Web App
                            </h4>
                            <ol style="margin-left: var(--space-4); line-height: 1.8;">
                                <li>Click <strong>Deploy</strong> â†’ <strong>New deployment</strong></li>
                                <li>Click gear icon â†’ Select <strong>Web app</strong></li>
                                <li>Set "Execute as" to <strong>Me</strong></li>
                                <li>Set "Who has access" to <strong>Anyone</strong></li>
                                <li>Click <strong>Deploy</strong></li>
                                <li>Click <strong>Authorize access</strong> and grant permissions</li>
                                <li><strong>Copy the Web App URL</strong> (starts with https://script.google.com/...)</li>
                            </ol>
                        </div>

                        <div style="margin-bottom: var(--space-5);">
                            <h4 style="margin-bottom: var(--space-2); font-weight: var(--font-weight-semibold);">
                                Step 3: Configure Sentinel Ops
                            </h4>
                            <ol style="margin-left: var(--space-4); line-height: 1.8;">
                                <li>Paste the Web App URL into the field above</li>
                                <li>Click <strong>Save URL</strong></li>
                                <li>Click <strong>Test Backup Now</strong> to verify</li>
                                <li>Check your Google Drive for "Sentinel_Ops_Backups" folder</li>
                            </ol>
                        </div>

                        <div style="padding: var(--space-3); background: var(--color-info-bg); border-left: 3px solid var(--color-info); border-radius: var(--radius-md);">
                            <div style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-1);">
                                ğŸ“… Backup Schedule
                            </div>
                            <div class="text-sm" style="color: var(--color-text-secondary);">
                                Once configured, backups run automatically every day at 3:00 AM UTC.
                                You can also trigger manual backups anytime with the "Test Backup Now" button.
                            </div>
                        </div>
                    </div>
                `;

                UI.showModal('Setup Instructions', instructions, {
                    buttons: [
                        {
                            text: 'Close',
                            style: 'primary',
                            action: () => {} // Just closes
                        }
                    ]
                });
            },

            setTheme: function (theme) {
                document.documentElement.setAttribute('data-theme', theme);
                const settings = DataStore.getSettings();
                settings.theme = theme;
                DataStore.saveSettings(settings);
            },

            exportBackup: function () {
                const data = DataStore.exportAllData();
                const json = JSON.stringify(data, null, 2);
                Utils.downloadFile(json, `sentinel-backup-${Utils.toISODate(new Date())}.json`, 'application/json');
                UI.toast('Backup Exported', 'Your data has been downloaded.', 'success');
            },

            importBackup: async function (e) {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const data = JSON.parse(text);

                    const confirmed = await UI.confirm('Import Backup', 'This will replace all current data. Are you sure?');
                    if (!confirmed) return;

                    DataStore.importAllData(data);
                    UI.toast('Backup Imported', 'Data has been restored successfully.', 'success');

                    // Refresh current view
                    Router._onRouteChange(Router.currentRoute);
                } catch (err) {
                    UI.toast('Import Failed', 'Invalid backup file format.', 'error');
                }

                e.target.value = '';
            },

            clearData: async function () {
                const content = `
                <p class="mb-4">This will permanently delete ALL data including sites, guards, schedules, incidents, inspections, and reports.</p>
                <p class="mb-4"><strong>This action cannot be undone.</strong></p>
                <div class="form-group">
                    <label class="form-label">Type CLEAR to confirm:</label>
                    <input type="text" class="form-input" id="clear-confirm-input" placeholder="CLEAR">
                </div>
            `;

                const footer = `
                <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                <button class="btn btn-danger" onclick="SettingsModule.confirmClear()">Delete All Data</button>
            `;

                UI.openModal('Clear All Data', content, footer);
            },

            confirmClear: function () {
                const input = document.getElementById('clear-confirm-input');
                if (input.value !== 'CLEAR') {
                    UI.toast('Confirmation Required', 'Please type CLEAR to confirm.', 'warning');
                    return;
                }

                DataStore.clearAllData();
                UI.closeModal();
                UI.toast('Data Cleared', 'All data has been deleted.', 'success');

                // Reinitialize with defaults
                DataStore.getSites();
                DataStore.getGuards();
                Router._onRouteChange(Router.currentRoute);
            },


            // ===========================
            // SOP / Protocol Importer
            // ===========================
            renderProtocolManager: function () {
                const sites = DataStore.getSites() || [];
                const select = document.getElementById('protocol-import-site');
                if (select) {
                    const current = select.value || '';
                    const options = ['<option value="">Auto-match from JSON</option>']
                        .concat(sites.map(s => `<option value="${Utils.escapeHtml(s.id)}">${Utils.escapeHtml(s.name)}</option>`));
                    select.innerHTML = options.join('');
                    select.value = current;
                }

                const label = document.getElementById('protocols-count-label');
                if (label) {
                    const protocols = DataStore.getProtocols() || [];
                    label.textContent = `${protocols.length} total`;
                }
                
                // Update SOP import count
                this._updateSOPImportCount();
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // SOP MASTER IMPORT
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            importSOPMaster: function(e) {
                const file = e?.target?.files?.[0];
                if (!file) return;
                
                const inputEl = e.target;
                const statusEl = document.getElementById('sop-import-status');
                const showStatus = (html) => {
                    if (!statusEl) return;
                    statusEl.style.display = 'block';
                    statusEl.innerHTML = html;
                };
                
                const reader = new FileReader();
                
                reader.onload = (evt) => {
                    inputEl.value = '';
                    
                    try {
                        const jsonData = JSON.parse(evt.target.result);
                        
                        // Validate it looks like SOP master format
                        const keys = Object.keys(jsonData);
                        const hasSiteKeys = keys.some(k => k.startsWith('site-') || jsonData[k]?.siteName);
                        
                        if (!hasSiteKeys) {
                            showStatus('<div class="text-danger">Invalid format. Expected site-keyed object with siteName fields.</div>');
                            UI.toast('Invalid Format', 'This does not appear to be an SOP master file.', 'warning');
                            return;
                        }
                        
                        // Do the import
                        const results = SOPModule.importFromJSON(jsonData);
                        
                        // Update count display
                        this._updateSOPImportCount();
                        
                        showStatus(`
                            <div style="display: flex; align-items: center; gap: var(--space-2); color: var(--color-success);">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span>Imported ${results.imported} site SOPs</span>
                            </div>
                        `);
                        
                        UI.toast('SOP Import Complete', `Imported ${results.imported} site SOPs. View them in Site Details â†’ SOP tab.`, 'success');
                        
                    } catch (err) {
                        console.error('SOP import error:', err);
                        showStatus(`<div class="text-danger">Import failed: ${Utils.escapeHtml(err.message)}</div>`);
                        UI.toast('Import Failed', err.message, 'warning');
                    }
                };
                
                reader.onerror = () => {
                    inputEl.value = '';
                    showStatus('<div class="text-danger">Could not read file</div>');
                    UI.toast('Read Error', 'Could not read the selected file.', 'warning');
                };
                
                reader.readAsText(file);
            },
            
            clearSOPImports: async function() {
                const count = SOPModule.getImportedCount();
                if (count === 0) {
                    UI.toast('No Imports', 'No imported SOPs to clear.', 'info');
                    return;
                }
                
                const confirmed = await UI.confirm(
                    'Clear Imported SOPs',
                    `This will remove ${count} imported SOPs. Hardcoded SOPs will remain. Continue?`
                );
                
                if (!confirmed) return;
                
                SOPModule.clearImported();
                this._updateSOPImportCount();
                
                const statusEl = document.getElementById('sop-import-status');
                if (statusEl) {
                    statusEl.style.display = 'none';
                }
                
                UI.toast('Cleared', 'Imported SOPs have been removed.', 'success');
            },
            
            _updateSOPImportCount: function() {
                const countEl = document.getElementById('sop-import-count');
                if (countEl) {
                    const count = SOPModule.getImportedCount();
                    countEl.textContent = count > 0 ? `${count} imported` : '';
                }
            },

            exportProtocols: function () {
                const sites = DataStore.getSites() || [];
                const protocols = DataStore.getProtocols() || [];
                const payload = {
                    exportedAt: new Date().toISOString(),
                    version: 'sop-protocol-export-1',
                    sites: sites.map(s => ({ id: s.id, name: s.name })),
                    protocols: protocols
                };
                const json = JSON.stringify(payload, null, 2);
                Utils.downloadFile(json, `sentinel-protocols-${new Date().toISOString().slice(0,10)}.json`, 'application/json');
                UI.toast('Protocols Exported', 'Protocol library downloaded.', 'success');
            },

            importProtocols: function (e) {
                const file = e?.target?.files?.[0];
                if (!file) return;
                
                const inputEl = e.target;
                const self = this;
                
                // Use pure callback - no async/await which can cause timing issues
                const reader = new FileReader();
                
                reader.onload = function(evt) {
                    // Clear input immediately
                    inputEl.value = '';
                    
                    // Process the content
                    self._processProtocolImport(evt.target.result);
                };
                
                reader.onerror = function() {
                    inputEl.value = '';
                    const errMsg = reader.error?.message || 'Unknown error reading file';
                    console.error('FileReader error:', reader.error);
                    alert('Could not read file: ' + errMsg + '\n\nIf opening from file://, try using a local web server instead.');
                };
                
                // Start reading immediately - no delays
                reader.readAsText(file);
            },
            
            _processProtocolImport: async function(fileContent) {
                const statusEl = document.getElementById('protocols-import-status');
                const showStatus = (html) => {
                    if (!statusEl) return;
                    statusEl.style.display = 'block';
                    statusEl.innerHTML = html;
                };
                
                try {
                    let payload;
                    try {
                        payload = JSON.parse(fileContent);
                    } catch (jsonErr) {
                        showStatus('<div class="text-danger">Invalid JSON file</div>');
                        UI.toast('Invalid JSON', 'The selected file is not valid JSON.', 'warning');
                        return;
                    }

                    const mode = document.getElementById('protocol-import-mode')?.value || 'merge';
                    const forcedSiteId = document.getElementById('protocol-import-site')?.value || '';

                    const sites = DataStore.getSites() || [];
                    const inferredSiteId = this.resolveSiteIdFromPayload(payload, sites);
                    const targetSiteId = forcedSiteId || inferredSiteId || '';

                    showStatus('<div class="text-muted">Processing protocols...</div>');
                    
                    const normalized = this.normalizeProtocolsPayload(payload, sites, targetSiteId);
                    
                    console.log('[Protocol Import] Payload keys:', Object.keys(payload));
                    console.log('[Protocol Import] Normalized count:', normalized.protocols.length);
                    if (normalized.protocols.length > 0) {
                        console.log('[Protocol Import] Sample:', normalized.protocols[0]);
                    }
                    
                    if (normalized.protocols.length === 0) {
                        const keys = Object.keys(payload || {});
                        const keyList = keys.slice(0, 5).join(', ') + (keys.length > 5 ? '...' : '');
                        const isArray = Array.isArray(payload);
                        const isSiteKeyed = keys.some(k => k.startsWith('site-'));
                        
                        let hint = '';
                        if (isArray) {
                            hint = `Found array with ${payload.length} items but none were valid protocols.`;
                        } else if (isSiteKeyed) {
                            hint = `Found ${keys.length} site entries. Check browser console (F12) for details.`;
                        } else {
                            hint = `Found keys: ${keyList}. Expected 'protocols' array or site-keyed object.`;
                        }
                        showStatus(`<div class="text-muted">No protocols found. ${hint}</div>`);
                        UI.toast('Import Failed', 'No valid protocols found.', 'warning');
                        return;
                    }

                    const confirmed = await UI.confirm(
                        'Import Protocols',
                        `Found ${normalized.protocols.length} protocols. Mode: ${mode.replace('-', ' ')}. Continue?`
                    );
                    if (!confirmed) {
                        statusEl.style.display = 'none';
                        return;
                    }

                    const existing = (DataStore.getProtocols() || []).slice();
                    const result = this.applyProtocolImport(existing, normalized.protocols, mode);

                    DataStore.saveProtocols(result.protocols);
                    Router._onRouteChange(Router.currentRoute);

                    showStatus(`
                        <div style="display:grid; gap: var(--space-1);">
                            <div><strong>Import complete</strong></div>
                            <div class="text-sm text-muted">Added: ${result.added} Â· Updated: ${result.updated} Â· Skipped: ${result.skipped}</div>
                        </div>
                    `);

                    UI.toast('Protocols Imported', `Added ${result.added}, updated ${result.updated}, skipped ${result.skipped}.`, 'success');
                } catch (err) {
                    console.error('Protocol import failed:', err);
                    UI.toast('Import Failed', err?.message || 'Could not import protocols.', 'warning');
                    showStatus(`<div class="text-danger">Import failed: ${Utils.escapeHtml(err?.message || 'Unknown error')}</div>`);
                }
            },

            resolveSiteIdFromPayload: function (payload, sites) {
                if (!payload || !Array.isArray(sites) || sites.length === 0) return '';
                const siteObj = payload.site || payload.Site || null;

                const siteId = (siteObj?.id || siteObj?.siteId || payload.siteId || '').trim();
                if (siteId && sites.some(s => s.id === siteId)) return siteId;

                const siteName = (siteObj?.name || payload.siteName || '').trim();
                if (siteName) {
                    const norm = this.normalizeSiteName(siteName);
                    const match = sites.find(s => this.normalizeSiteName(s.name) === norm);
                    if (match) return match.id;
                }
                return '';
            },

            normalizeProtocolsPayload: function (payload, sites, fallbackSiteId) {
                // Handle multiple possible JSON formats
                let protocolsRaw = [];
                
                // Check for common keys
                if (payload?.protocols) protocolsRaw = payload.protocols;
                else if (payload?.Protocols) protocolsRaw = payload.Protocols;
                else if (payload?.protocol) protocolsRaw = payload.protocol;
                else if (payload?.Protocol) protocolsRaw = payload.Protocol;
                else if (payload?.sop) protocolsRaw = payload.sop;
                else if (payload?.SOP) protocolsRaw = payload.SOP;
                else if (payload?.procedures) protocolsRaw = payload.procedures;
                else if (payload?.items) protocolsRaw = payload.items;
                else if (payload?.data) protocolsRaw = payload.data;
                // If payload itself is an array, use it directly
                else if (Array.isArray(payload)) protocolsRaw = payload;
                // If payload is a single protocol object (has title/name), wrap it
                else if (payload?.title || payload?.name || payload?.section) protocolsRaw = [payload];
                // Check if payload is keyed by site IDs (e.g., {"site-001": {...}, "site-002": {...}})
                else if (payload && typeof payload === 'object') {
                    const keys = Object.keys(payload);
                    const looksLikeSiteKeys = keys.some(k => k.startsWith('site-') || k.match(/^site\d+$/i));
                    
                    if (looksLikeSiteKeys) {
                        // Check if this is SOP master format (sites have siteName, posts, etc.)
                        const firstSite = payload[keys[0]];
                        const isSopMasterFormat = firstSite && (firstSite.siteName || firstSite.posts || firstSite.coverage);
                        
                        if (isSopMasterFormat) {
                            // Convert SOP master format to protocols
                            protocolsRaw = this.convertSopMasterToProtocols(payload, sites);
                        } else {
                            // Standard site-keyed protocol format
                            keys.forEach(siteKey => {
                                const siteData = payload[siteKey];
                                if (!siteData || typeof siteData !== 'object') return;
                                
                                let siteProtocols = [];
                                if (Array.isArray(siteData)) {
                                    siteProtocols = siteData;
                                } else if (siteData.protocols) {
                                    siteProtocols = Array.isArray(siteData.protocols) ? siteData.protocols : [siteData.protocols];
                                } else if (siteData.sop) {
                                    siteProtocols = Array.isArray(siteData.sop) ? siteData.sop : [siteData.sop];
                                } else if (siteData.procedures) {
                                    siteProtocols = Array.isArray(siteData.procedures) ? siteData.procedures : [siteData.procedures];
                                } else if (siteData.title || siteData.name) {
                                    siteProtocols = [siteData];
                                }
                                
                                siteProtocols.forEach(p => {
                                    if (p && typeof p === 'object' && !p.siteId) {
                                        p.siteId = siteKey;
                                    }
                                });
                                
                                protocolsRaw = protocolsRaw.concat(siteProtocols);
                            });
                        }
                    }
                }
                
                // Ensure it's an array
                const list = Array.isArray(protocolsRaw) ? protocolsRaw : (protocolsRaw ? [protocolsRaw] : []);

                const siteObj = payload?.site || payload?.Site || null;
                const siteFromPayload = String(siteObj?.id || '').trim();
                const siteNameFromPayload = String(siteObj?.name || '').trim();

                let finalSiteId = '';
                if (fallbackSiteId && sites.some(s => s.id === fallbackSiteId)) finalSiteId = fallbackSiteId;
                else if (siteFromPayload && sites.some(s => s.id === siteFromPayload)) finalSiteId = siteFromPayload;
                else if (siteNameFromPayload) {
                    const match = sites.find(s => this.normalizeSiteName(s.name) === this.normalizeSiteName(siteNameFromPayload));
                    if (match) finalSiteId = match.id;
                }

                const normalized = list.map(p => this.convertIncomingProtocol(p, finalSiteId, sites)).filter(Boolean);
                return { protocols: normalized };
            },
            
            convertSopMasterToProtocols: function (payload, existingSites) {
                const protocols = [];
                const siteKeys = Object.keys(payload);
                
                // Helper to create structured steps from array of strings
                const makeSteps = (items, phaseName) => {
                    if (!items || items.length === 0) return [];
                    const itemList = Array.isArray(items) ? items : [items];
                    return [{ phase: phaseName || 'Procedure', items: itemList.map(i => String(i)) }];
                };
                
                siteKeys.forEach(siteKey => {
                    const siteData = payload[siteKey];
                    if (!siteData || typeof siteData !== 'object') return;
                    
                    const siteName = siteData.siteName || siteKey;
                    
                    // Try to match to existing site
                    let matchedSiteId = siteKey;
                    if (existingSites && existingSites.length > 0) {
                        const match = existingSites.find(s => 
                            s.id === siteKey || 
                            this.normalizeSiteName(s.name) === this.normalizeSiteName(siteName)
                        );
                        if (match) matchedSiteId = match.id;
                    }
                    
                    const now = new Date().toISOString();
                    const baseId = siteKey.replace(/[^a-z0-9]/gi, '').slice(0, 12);
                    
                    // Create Site Overview protocol
                    if (siteData.coverage || siteData.staffing) {
                        const items = [`Coverage: ${siteData.coverage || 'As scheduled'}`];
                        if (siteData.staffing) {
                            Object.entries(siteData.staffing).forEach(([shift, staff]) => {
                                items.push(`${shift}: ${staff}`);
                            });
                        }
                        protocols.push({
                            id: `proto-${baseId}-overview`,
                            title: `${siteName} - Site Overview`,
                            siteId: matchedSiteId,
                            category: 'general',
                            priority: 'standard',
                            steps: [{ phase: 'Coverage & Staffing', items }],
                            notes: '',
                            tags: ['site-overview'],
                            source: 'sop-import',
                            version: '1.0',
                            createdAt: now,
                            updatedAt: now
                        });
                    }
                    
                    // Create Post Duties protocol
                    if (siteData.posts) {
                        const items = [];
                        Object.entries(siteData.posts).forEach(([postType, duties]) => {
                            items.push(`${postType.toUpperCase()}: ${duties}`);
                        });
                        if (items.length > 0) {
                            protocols.push({
                                id: `proto-${baseId}-posts`,
                                title: `${siteName} - Post Duties`,
                                siteId: matchedSiteId,
                                category: 'operations',
                                priority: 'standard',
                                steps: [{ phase: 'Post Assignments', items }],
                                notes: '',
                                tags: ['post-duties'],
                                source: 'sop-import',
                                version: '1.0',
                                createdAt: now,
                                updatedAt: now
                            });
                        }
                    }
                    
                    // Create Patrol protocol
                    if (siteData.patrols) {
                        protocols.push({
                            id: `proto-${baseId}-patrols`,
                            title: `${siteName} - Patrol Requirements`,
                            siteId: matchedSiteId,
                            category: 'patrol',
                            priority: 'standard',
                            steps: [{ phase: 'Patrol Schedule', items: [String(siteData.patrols)] }],
                            notes: '',
                            tags: ['patrols'],
                            source: 'sop-import',
                            version: '1.0',
                            createdAt: now,
                            updatedAt: now
                        });
                    }
                    
                    // Create Access Control protocol
                    if (siteData.accessControl) {
                        const items = [];
                        if (typeof siteData.accessControl === 'object') {
                            Object.entries(siteData.accessControl).forEach(([key, val]) => {
                                items.push(`${key}: ${val}`);
                            });
                        } else {
                            items.push(String(siteData.accessControl));
                        }
                        if (items.length > 0) {
                            protocols.push({
                                id: `proto-${baseId}-access`,
                                title: `${siteName} - Access Control`,
                                siteId: matchedSiteId,
                                category: 'access-control',
                                priority: 'standard',
                                steps: [{ phase: 'Access Procedures', items }],
                                notes: '',
                                tags: ['access-control'],
                                source: 'sop-import',
                                version: '1.0',
                                createdAt: now,
                                updatedAt: now
                            });
                        }
                    }
                    
                    // Create Special Instructions protocol
                    if (siteData.specialInstructions && siteData.specialInstructions.length > 0) {
                        protocols.push({
                            id: `proto-${baseId}-special`,
                            title: `${siteName} - Special Instructions`,
                            siteId: matchedSiteId,
                            category: 'operations',
                            priority: 'high',
                            steps: [{ phase: 'Special Instructions', items: siteData.specialInstructions.map(s => String(s)) }],
                            notes: '',
                            tags: ['special-instructions'],
                            source: 'sop-import',
                            version: '1.0',
                            createdAt: now,
                            updatedAt: now
                        });
                    }
                    
                    // Create Use of Force protocol
                    if (siteData.useOfForce) {
                        protocols.push({
                            id: `proto-${baseId}-uof`,
                            title: `${siteName} - Use of Force Policy`,
                            siteId: matchedSiteId,
                            category: 'emergency',
                            priority: 'critical',
                            steps: [{ phase: 'Use of Force', items: [String(siteData.useOfForce)] }],
                            notes: '',
                            tags: ['use-of-force', 'policy'],
                            source: 'sop-import',
                            version: '1.0',
                            createdAt: now,
                            updatedAt: now
                        });
                    }
                    
                    // Create Escalation protocol
                    if (siteData.escalation && siteData.escalation.length > 0) {
                        const items = siteData.escalation.map((e, i) => `${i + 1}. ${e}`);
                        protocols.push({
                            id: `proto-${baseId}-escalation`,
                            title: `${siteName} - Escalation Chain`,
                            siteId: matchedSiteId,
                            category: 'emergency',
                            priority: 'high',
                            steps: [{ phase: 'Escalation Order', items }],
                            notes: '',
                            tags: ['escalation'],
                            source: 'sop-import',
                            version: '1.0',
                            createdAt: now,
                            updatedAt: now
                        });
                    }
                    
                    // Create Notes protocol if exists
                    if (siteData.notes && siteData.notes.length > 0) {
                        protocols.push({
                            id: `proto-${baseId}-notes`,
                            title: `${siteName} - Notes`,
                            siteId: matchedSiteId,
                            category: 'general',
                            priority: 'standard',
                            steps: [{ phase: 'Site Notes', items: siteData.notes.map(s => String(s)) }],
                            notes: '',
                            tags: ['notes'],
                            source: 'sop-import',
                            version: '1.0',
                            createdAt: now,
                            updatedAt: now
                        });
                    }
                });
                
                return protocols;
            },

            convertIncomingProtocol: function (p, fallbackSiteId, sites) {
                if (!p || typeof p !== 'object') return null;

                let siteId = String(p.siteId || p.site || '').trim();
                if (!siteId) siteId = String(fallbackSiteId || '').trim();

                // If siteId is unknown but siteName exists, try match by name
                if (siteId && Array.isArray(sites) && !sites.some(s => s.id === siteId) && p.siteName) {
                    const match = sites.find(s => this.normalizeSiteName(s.name) === this.normalizeSiteName(p.siteName));
                    if (match) siteId = match.id;
                }

                const title = String(p.title || p.name || p.section || '').trim();
                if (!title) return null;

                const stepsRaw = (p.steps !== undefined ? p.steps : (p.content !== undefined ? p.content : (p.body !== undefined ? p.body : '')));
                const category = String(p.category || p.type || this.inferProtocolCategory(title, stepsRaw)).toLowerCase().trim();
                const priority = String(p.priority || this.inferProtocolPriority(title, category, stepsRaw)).toLowerCase().trim();
                const steps = this.toStructuredSteps(stepsRaw);

                const now = new Date().toISOString();

                let id = String(p.id || '').trim();
                if (!id) {
                    const base = `${siteId || 'site'}:${title}`.toLowerCase();
                    id = `proto-${this.simpleHash(base)}`;
                }

                return {
                    id,
                    siteId: siteId || '',
                    title,
                    category: category || 'general',
                    priority: priority || 'standard',
                    steps,
                    notes: String(p.notes || '').trim(),
                    tags: Array.isArray(p.tags) ? p.tags.slice(0, 25) : [],
                    source: String(p.source || 'sop-import').trim(),
                    version: String(p.version || '').trim(),
                    createdAt: String(p.createdAt || now),
                    updatedAt: now
                };
            },

            toStructuredSteps: function (stepsRaw) {
                if (Array.isArray(stepsRaw)) {
                    const ok = stepsRaw.every(s => typeof s === 'object' && s.phase && Array.isArray(s.items));
                    if (ok) return stepsRaw.map(s => ({ phase: String(s.phase), items: s.items.map(i => String(i)) }));
                }

                let text = '';
                if (typeof stepsRaw === 'string') text = stepsRaw;
                else if (stepsRaw == null) text = '';
                else text = String(stepsRaw);

                text = text.trim();
                if (!text) return [];

                try {
                    if (typeof ProtocolsModule !== 'undefined' && typeof ProtocolsModule.parseStepsText === 'function') {
                        const structured = ProtocolsModule.parseStepsText(text);
                        if (Array.isArray(structured) && structured.length) return structured;
                    }
                } catch (_) {}

                const blocks = text.split(/\n\s*---\s*\n/);
                const parsed = [];
                for (const block of blocks) {
                    const lines = block.split('\n').map(l => l.trim()).filter(Boolean);
                    if (lines.length === 0) continue;
                    const phase = lines[0].replace(/:$/, '').trim() || 'Protocol';
                    const items = lines.slice(1).map(l => l.replace(/^[-â€¢]\s*/, '').trim()).filter(Boolean);
                    parsed.push({ phase, items });
                }
                return parsed;
            },

            inferProtocolCategory: function (title, text) {
                const t = `${title} ${typeof text === 'string' ? text : ''}`.toLowerCase();

                const map = {
                    emergency: ['emergency', 'fire', 'evac', 'evacuation', 'medical', 'active shooter', 'assault', 'threat', 'alarm', 'bomb'],
                    communication: ['radio', 'call', 'phone', 'dispatch', 'notify', 'chain of command', 'report to'],
                    documentation: ['report', 'log', 'documentation', 'incident', 'forms', 'time records'],
                    uniform: ['uniform', 'appearance', 'groom', 'badge', 'equipment', 'vest'],
                    attendance: ['attendance', 'lateness', 'call-off', 'call off', 'schedule', 'timekeeping'],
                    daily_ops: ['daily', 'post orders', 'patrol', 'tour', 'checklist', 'rounds', 'visitors', 'front desk'],
                    safety: ['safety', 'hazard', 'injury', 'ppe', 'work as a team', 'professionalism']
                };

                for (const [cat, keys] of Object.entries(map)) {
                    if (keys.some(k => t.includes(k))) return cat;
                }
                return 'general';
            },

            inferProtocolPriority: function (title, category, text) {
                const t = `${title} ${typeof text === 'string' ? text : ''}`.toLowerCase();
                if (category === 'emergency') return 'critical';
                if (t.includes('must') || t.includes('required') || t.includes('immediately')) return 'high';
                if (t.includes('never') || t.includes('prohibited')) return 'high';
                return 'standard';
            },

            applyProtocolImport: function (existingProtocols, incoming, mode) {
                const existing = Array.isArray(existingProtocols) ? existingProtocols.slice() : [];
                const inc = Array.isArray(incoming) ? incoming.slice() : [];

                const normTitle = (s) => (s || '').trim().toLowerCase().replace(/[^a-z0-9]+/g, ' ').trim();
                const keyOf = (p) => `${p.siteId || ''}::${normTitle(p.title)}`;

                let out = existing.slice();
                let added = 0, updated = 0, skipped = 0;

                if (mode === 'replace-all') out = [];

                if (mode === 'replace-site') {
                    const siteIds = Array.from(new Set(inc.map(p => p.siteId).filter(Boolean)));
                    if (siteIds.length === 0) throw new Error('Replace-site requires a target site.');
                    out = out.filter(p => !siteIds.includes(p.siteId));
                }

                const byId = new Map(out.map(p => [p.id, p]));
                const byKey = new Map(out.map(p => [keyOf(p), p]));

                for (const p of inc) {
                    const match = (p.id ? byId.get(p.id) : null) || byKey.get(keyOf(p)) || null;

                    if (mode === 'merge') {
                        if (match) { skipped++; continue; }
                        out.push(p);
                        byId.set(p.id, p);
                        byKey.set(keyOf(p), p);
                        added++;
                        continue;
                    }

                    if (mode === 'upsert') {
                        if (match) {
                            const merged = {
                                ...match,
                                ...p,
                                id: match.id,
                                createdAt: match.createdAt || p.createdAt
                            };
                            const idx = out.findIndex(x => x.id === match.id);
                            if (idx >= 0) out[idx] = merged;
                            else out.push(merged);
                            byId.set(merged.id, merged);
                            byKey.set(keyOf(merged), merged);
                            updated++;
                        } else {
                            out.push(p);
                            byId.set(p.id, p);
                            byKey.set(keyOf(p), p);
                            added++;
                        }
                        continue;
                    }

                    // replace-all / replace-site: match already removed; treat as add
                    out.push(p);
                    byId.set(p.id, p);
                    byKey.set(keyOf(p), p);
                    added++;
                }

                return { protocols: out, added, updated, skipped };
            },

            normalizeSiteName: function (name) {
                return String(name || '')
                    .toLowerCase()
                    .replace(/&/g, 'and')
                    .replace(/[^a-z0-9]+/g, ' ')
                    .trim();
            },

            simpleHash: function (str) {
                // Deterministic small hash for IDs (not crypto)
                let h = 2166136261;
                for (let i = 0; i < str.length; i++) {
                    h ^= str.charCodeAt(i);
                    h = Math.imul(h, 16777619);
                }
                return (h >>> 0).toString(16);
            },
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // WARNING NOTICE MODULE â€” Employee Write-Up Generator
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const WarningNoticeModule = {
            currentGuardId: null,

            // Infraction types matching the template
            INFRACTION_TYPES: [
                { id: 'tardiness', label: 'Tardiness' },
                { id: 'absenteeism', label: 'Absenteeism' },
                { id: 'safety_violation', label: 'Safety Violation' },
                { id: 'poor_performance', label: 'Poor Performance' },
                { id: 'policy_violation', label: 'Policy Violation' },
                { id: 'ncns', label: 'No Call No Show' }
            ],

            // Action types matching the template
            ACTION_TYPES: [
                { id: 'verbal_counseling', label: 'Verbal Counseling' },
                { id: 'abandoned_post', label: 'Abandoned Post' },
                { id: 'written_warning', label: 'Written Warning' },
                { id: 'final_warning', label: 'Final Warning' },
                { id: 'suspension', label: 'Suspension' },
                { id: 'termination', label: 'Termination' }
            ],

            // Open the warning notice form
            open: function (guardId = null) {
                this.currentGuardId = guardId;
                const guards = DataStore.getGuards();
                const sites = DataStore.getSites();
                const selectedGuard = guardId ? guards.find(g => g.id === guardId) : null;

                const content = `
                    <div class="warning-notice-form">
                        <!-- Employee Information Section -->
                        <div class="form-section">
                            <div class="section-title">
                                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                Employee Information
                            </div>
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <label class="form-label">Employee Name *</label>
                                    <select class="form-select" id="wn-employee" onchange="WarningNoticeModule.onEmployeeChange()">
                                        <option value="">-- Select Employee --</option>
                                        ${guards.filter(g => g.status !== 'terminated').map(g => `
                                            <option value="${g.id}" ${guardId === g.id ? 'selected' : ''}>${Utils.escapeHtml(g.name)}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Incident Date *</label>
                                    <input type="date" class="form-input" id="wn-date" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Site</label>
                                <select class="form-select" id="wn-site">
                                    <option value="">-- Select Site --</option>
                                    ${sites.map(s => `
                                        <option value="${s.id}">${Utils.escapeHtml(s.name)}${s.address ? ' - ' + Utils.escapeHtml(s.address) : ''}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>

                        <!-- Type of Infraction Section -->
                        <div class="form-section">
                            <div class="section-title">
                                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                Type of Infraction (Check all that apply)
                            </div>
                            <div class="checkbox-grid">
                                ${this.INFRACTION_TYPES.map(type => `
                                    <label class="checkbox-item" onclick="this.classList.toggle('checked')">
                                        <input type="checkbox" name="wn-infraction" value="${type.id}">
                                        <span>${type.label}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Action Taken Section -->
                        <div class="form-section">
                            <div class="section-title">
                                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Action Taken *
                            </div>
                            <div class="radio-grid">
                                ${this.ACTION_TYPES.map((type, idx) => `
                                    <label class="radio-item" onclick="WarningNoticeModule.selectAction('${type.id}', this)">
                                        <input type="radio" name="wn-action" value="${type.id}" ${idx === 2 ? 'checked' : ''}>
                                        <span>${type.label}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Notes Section -->
                        <div class="form-section">
                            <div class="section-title">
                                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                                Notes / Incident Details *
                            </div>
                            <textarea class="form-input" id="wn-notes" rows="4" placeholder="Describe the incident or action taken in detail..."></textarea>
                        </div>

                        <!-- Preview Toggle -->
                        <div style="margin-top: var(--space-4);">
                            <button type="button" class="btn btn-secondary" onclick="WarningNoticeModule.togglePreview()" style="width: 100%;">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                Preview Document
                            </button>
                        </div>

                        <!-- Preview Container (hidden by default) -->
                        <div id="wn-preview-container" style="display: none; margin-top: var(--space-4);"></div>
                    </div>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="WarningNoticeModule.saveAndPrint()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                        </svg>
                        Save & Print
                    </button>
                `;

                UI.openModal('Employee Warning Notice', content, footer);

                // Auto-select default action (Written Warning)
                setTimeout(() => {
                    const defaultRadio = document.querySelector('.radio-item:nth-child(3)');
                    if (defaultRadio) defaultRadio.classList.add('selected');
                }, 50);
            },

            // Handle action radio button selection
            selectAction: function (actionId, element) {
                document.querySelectorAll('.radio-item').forEach(el => el.classList.remove('selected'));
                element.classList.add('selected');
            },

            // Handle employee selection change
            onEmployeeChange: function () {
                const guardId = document.getElementById('wn-employee').value;
                if (guardId) {
                    const guards = DataStore.getGuards();
                    const guard = guards.find(g => g.id === guardId);
                    if (guard && guard.primarySites && guard.primarySites.length > 0) {
                        document.getElementById('wn-site').value = guard.primarySites[0];
                    }
                }
            },

            // Toggle preview visibility
            togglePreview: function () {
                const container = document.getElementById('wn-preview-container');
                if (container.style.display === 'none') {
                    container.style.display = 'block';
                    this.updatePreview();
                } else {
                    container.style.display = 'none';
                }
            },

            // Generate preview HTML
            updatePreview: function () {
                const data = this.collectFormData();
                if (!data) return;

                const guards = DataStore.getGuards();
                const sites = DataStore.getSites();
                const guard = guards.find(g => g.id === data.employeeId);
                const site = sites.find(s => s.id === data.siteId);

                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    const d = new Date(dateStr + 'T00:00:00');
                    return d.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' });
                };

                const previewHtml = `
                    <div class="warning-notice-preview" id="wn-printable">
                        <div class="notice-header">
                            <div class="company-name">NEWARK SECURITY</div>
                            <h1>Employee Warning Notice</h1>
                        </div>

                        <div class="info-section">
                            <div class="info-row">
                                <span class="info-label">Employee Name:</span>
                                <span class="info-value">${guard ? Utils.escapeHtml(guard.name) : ''}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Incident Date:</span>
                                <span class="info-value">${formatDate(data.incidentDate)}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Site:</span>
                                <span class="info-value">${site ? Utils.escapeHtml(site.name) + (site.address ? ' - ' + Utils.escapeHtml(site.address) : '') : ''}</span>
                            </div>
                        </div>

                        <div class="checkbox-section">
                            <h3>Type of Infraction (Check all that apply):</h3>
                            <div class="checkbox-list">
                                ${this.INFRACTION_TYPES.map(type => `
                                    <div class="checkbox-list-item">
                                        <span class="check-box">${data.infractions.includes(type.id) ? 'âœ“' : ''}</span>
                                        <span>${type.label}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="checkbox-section">
                            <h3>Action Taken:</h3>
                            <div class="checkbox-list">
                                ${this.ACTION_TYPES.map(type => `
                                    <div class="checkbox-list-item">
                                        <span class="check-box">${data.action === type.id ? 'âœ“' : ''}</span>
                                        <span>${type.label}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="notes-section">
                            <h3>NOTES:</h3>
                            <div class="notes-content">${Utils.escapeHtml(data.notes)}</div>
                        </div>

                        <div class="signature-section">
                            <div class="signature-row">
                                <div class="signature-block">
                                    <div class="signature-line"></div>
                                    <div class="signature-label">Employee Signature</div>
                                </div>
                                <div class="signature-block date-line">
                                    <div class="signature-line"></div>
                                    <div class="signature-label">Date</div>
                                </div>
                            </div>
                            <div class="signature-row">
                                <div class="signature-block">
                                    <div class="signature-line"></div>
                                    <div class="signature-label">Supervisor/Manager Signature â€” VP Management</div>
                                </div>
                                <div class="signature-block date-line">
                                    <div class="signature-line"></div>
                                    <div class="signature-label">Date</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('wn-preview-container').innerHTML = previewHtml;
            },

            // Collect form data
            collectFormData: function () {
                const employeeId = document.getElementById('wn-employee').value;
                const incidentDate = document.getElementById('wn-date').value;
                const siteId = document.getElementById('wn-site').value;
                const notes = document.getElementById('wn-notes').value.trim();

                // Get selected infractions
                const infractions = [];
                document.querySelectorAll('input[name="wn-infraction"]:checked').forEach(cb => {
                    infractions.push(cb.value);
                });

                // Get selected action
                const actionRadio = document.querySelector('input[name="wn-action"]:checked');
                const action = actionRadio ? actionRadio.value : null;

                return {
                    employeeId,
                    incidentDate,
                    siteId,
                    infractions,
                    action,
                    notes
                };
            },

            // Validate form
            validate: function (data) {
                if (!data.employeeId) {
                    UI.toast('Missing Employee', 'Please select an employee.', 'error');
                    return false;
                }
                if (!data.incidentDate) {
                    UI.toast('Missing Date', 'Please enter the incident date.', 'error');
                    return false;
                }
                if (!data.action) {
                    UI.toast('Missing Action', 'Please select an action taken.', 'error');
                    return false;
                }
                if (!data.notes) {
                    UI.toast('Missing Notes', 'Please describe the incident.', 'error');
                    return false;
                }
                return true;
            },

            // Map action type to disciplinary type for history
            mapActionToDiscType: function (action) {
                const map = {
                    'verbal_counseling': 'verbal_warning',
                    'abandoned_post': 'written_warning',
                    'written_warning': 'written_warning',
                    'final_warning': 'final_warning',
                    'suspension': 'suspension',
                    'termination': 'final_warning'
                };
                return map[action] || 'written_warning';
            },

            // Save to disciplinary history and print
            saveAndPrint: function () {
                const data = this.collectFormData();
                if (!this.validate(data)) return;

                // Update preview first
                this.updatePreview();

                // Save to disciplinary history
                const guards = DataStore.getGuards();
                const guardIdx = guards.findIndex(g => g.id === data.employeeId);

                if (guardIdx !== -1) {
                    if (!guards[guardIdx].disciplinaryHistory) {
                        guards[guardIdx].disciplinaryHistory = [];
                    }

                    // Get human-readable labels
                    const infractionLabels = data.infractions.map(id => {
                        const type = this.INFRACTION_TYPES.find(t => t.id === id);
                        return type ? type.label : id;
                    }).join(', ');

                    const actionLabel = this.ACTION_TYPES.find(t => t.id === data.action)?.label || data.action;
                    const sites = DataStore.getSites();
                    const site = sites.find(s => s.id === data.siteId);
                    const siteLabel = site ? site.name : '';

                    // Build description
                    let description = `${actionLabel}`;
                    if (infractionLabels) description += ` for ${infractionLabels}`;
                    if (siteLabel) description += ` at ${siteLabel}`;
                    description += `. ${data.notes}`;

                    guards[guardIdx].disciplinaryHistory.push({
                        id: Utils.generateId('disc-'),
                        date: data.incidentDate,
                        type: this.mapActionToDiscType(data.action),
                        description: description,
                        infractions: data.infractions,
                        action: data.action,
                        siteId: data.siteId,
                        createdAt: new Date().toISOString()
                    });

                    DataStore.saveGuards(guards);
                    UI.toast('Record Saved', 'Disciplinary record added to guard history.', 'success');
                }

                // Print the document
                this.print();
            },

            // Print the warning notice
            print: function () {
                const printContent = document.getElementById('wn-printable');
                if (!printContent) {
                    UI.toast('Preview Required', 'Please preview the document first.', 'warning');
                    return;
                }

                const printWindow = window.open('', '_blank', 'width=800,height=900');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Employee Warning Notice</title>
                        <style>
                            * { box-sizing: border-box; margin: 0; padding: 0; }
                            body { font-family: 'Times New Roman', Times, serif; font-size: 12pt; line-height: 1.4; padding: 0.5in; }
                            .notice-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 12pt; margin-bottom: 16pt; }
                            .notice-header h1 { font-size: 18pt; font-weight: bold; margin: 0 0 4pt 0; text-transform: uppercase; letter-spacing: 1px; }
                            .notice-header .company-name { font-size: 14pt; font-weight: bold; margin-bottom: 2pt; }
                            .info-section { margin-bottom: 16pt; }
                            .info-row { display: flex; margin-bottom: 8pt; }
                            .info-label { font-weight: bold; width: 120pt; flex-shrink: 0; }
                            .info-value { flex: 1; border-bottom: 1px solid #000; padding-bottom: 2pt; min-height: 16pt; }
                            .checkbox-section { margin-bottom: 16pt; }
                            .checkbox-section h3 { font-size: 11pt; font-weight: bold; margin-bottom: 8pt; text-decoration: underline; }
                            .checkbox-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4pt 16pt; }
                            .checkbox-list-item { display: flex; align-items: center; gap: 6pt; font-size: 11pt; }
                            .check-box { width: 12pt; height: 12pt; border: 1px solid #000; display: inline-flex; align-items: center; justify-content: center; font-size: 10pt; flex-shrink: 0; }
                            .notes-section { margin-bottom: 20pt; }
                            .notes-section h3 { font-size: 11pt; font-weight: bold; margin-bottom: 6pt; }
                            .notes-content { border: 1px solid #000; min-height: 80pt; padding: 8pt; white-space: pre-wrap; }
                            .signature-section { margin-top: 24pt; }
                            .signature-row { display: flex; gap: 40pt; margin-bottom: 20pt; }
                            .signature-block { flex: 1; }
                            .signature-line { border-bottom: 1px solid #000; height: 30pt; margin-bottom: 4pt; }
                            .signature-label { font-size: 10pt; }
                            .date-line { width: 120pt; flex: none; }
                            @media print {
                                body { padding: 0; }
                                @page { margin: 0.5in; }
                            }
                        </style>
                    </head>
                    <body>
                        ${printContent.innerHTML}
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                }, 250);
            },

            // Quick access from guard edit modal
            openForGuard: function (guardId) {
                UI.closeModal();
                setTimeout(() => {
                    this.open(guardId);
                }, 200);
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GUARD PERFORMANCE MODULE â€” Scorecards, Metrics, Discipline Tracking
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const GuardPerformanceModule = {
            filters: { search: '', status: '', site: '' },
            period: 30, // days

            init: function () {
                // Search
                document.getElementById('perf-search')?.addEventListener('input', Utils.debounce((e) => {
                    this.filters.search = e.target.value.toLowerCase();
                    this.renderScorecard();
                }, 200));

                // Status filter
                document.getElementById('perf-filter-status')?.addEventListener('change', (e) => {
                    this.filters.status = e.target.value;
                    this.renderScorecard();
                });

                // Site filter
                document.getElementById('perf-filter-site')?.addEventListener('change', (e) => {
                    this.filters.site = e.target.value;
                    this.renderScorecard();
                });

                // Period filter
                document.getElementById('perf-period')?.addEventListener('change', (e) => {
                    this.period = parseInt(e.target.value);
                    this.renderScorecard();
                });

                // Export button
                document.getElementById('export-perf-btn')?.addEventListener('click', () => this.exportReport());
            },

            render: function () {
                this.populateSiteFilter();
                this.renderSummary();
                this.renderScorecard();
            },

            populateSiteFilter: function () {
                const select = document.getElementById('perf-filter-site');
                if (!select) return;

                const sites = DataStore.getSites();
                select.innerHTML = `
                    <option value="">All Sites</option>
                    ${sites.map(s => `<option value="${s.id}">${Utils.escapeHtml(s.name)}</option>`).join('')}
                `;
            },

            // Calculate performance metrics for a guard
            calculateMetrics: function (guard) {
                const now = new Date();
                const cutoff = new Date(now.getTime() - (this.period * 24 * 60 * 60 * 1000));
                
                // Get related data
                const incidents = DataStore.getIncidents() || [];
                const calloffs = DataStore.getCalloffs() || [];
                const disciplinary = guard.disciplinaryHistory || [];

                // Filter by period
                const recentIncidents = incidents.filter(i => {
                    const date = new Date(i.dateTime);
                    return date >= cutoff && i.guardIds && i.guardIds.includes(guard.id);
                });

                const recentCalloffs = calloffs.filter(c => {
                    const date = new Date(c.date);
                    return date >= cutoff && c.guardId === guard.id;
                });

                const recentDisciplinary = disciplinary.filter(d => {
                    const date = new Date(d.date);
                    return date >= cutoff;
                });

                // Count metrics
                const incidentCount = recentIncidents.length;
                const calloffCount = recentCalloffs.length;
                const noCallNoShow = recentCalloffs.filter(c => c.reason?.toLowerCase().includes('no call') || c.reason?.toLowerCase().includes('ncns')).length;
                
                const writeUps = recentDisciplinary.filter(d => 
                    d.type !== 'commendation' && d.type !== 'coaching'
                ).length;
                
                const commendations = recentDisciplinary.filter(d => 
                    d.type === 'commendation'
                ).length;

                const warnings = recentDisciplinary.filter(d =>
                    d.type === 'verbal_warning' || d.type === 'written_warning' || d.type === 'final_warning'
                ).length;

                // Calculate score (100 base, deductions for issues, bonuses for commendations)
                let score = 100;
                score -= (incidentCount * 5);      // -5 per incident involved
                score -= (calloffCount * 3);       // -3 per call-off
                score -= (noCallNoShow * 15);      // -15 per NCNS
                score -= (warnings * 10);          // -10 per warning
                score -= (writeUps * 8);           // -8 per write-up
                score += (commendations * 10);     // +10 per commendation
                
                // Clamp to 0-100
                score = Math.max(0, Math.min(100, score));

                // Determine risk level
                let riskLevel = 'good';
                const flags = [];

                if (score < 50 || noCallNoShow >= 2 || warnings >= 2) {
                    riskLevel = 'high-risk';
                } else if (score < 70 || calloffCount >= 3 || writeUps >= 1) {
                    riskLevel = 'watch';
                }

                // Generate flags
                if (noCallNoShow > 0) flags.push({ type: 'risk', label: `${noCallNoShow} NCNS` });
                if (warnings >= 2) flags.push({ type: 'risk', label: `${warnings} warnings` });
                if (calloffCount >= 3) flags.push({ type: 'warning', label: `${calloffCount} call-offs` });
                if (incidentCount >= 3) flags.push({ type: 'warning', label: `${incidentCount} incidents` });
                if (commendations > 0) flags.push({ type: 'positive', label: `${commendations} commendation${commendations > 1 ? 's' : ''}` });

                return {
                    score: Math.round(score),
                    riskLevel,
                    flags,
                    metrics: {
                        incidents: incidentCount,
                        calloffs: calloffCount,
                        writeUps,
                        commendations
                    },
                    recentIncidents,
                    recentCalloffs,
                    recentDisciplinary
                };
            },

            // Get all guards with performance data
            getAllGuardPerformance: function () {
                const guards = DataStore.getActiveGuards();
                return guards.map(guard => ({
                    ...guard,
                    performance: this.calculateMetrics(guard)
                })).sort((a, b) => {
                    // Sort by risk level first, then by score
                    const riskOrder = { 'high-risk': 0, 'watch': 1, 'good': 2 };
                    const riskDiff = riskOrder[a.performance.riskLevel] - riskOrder[b.performance.riskLevel];
                    if (riskDiff !== 0) return riskDiff;
                    return a.performance.score - b.performance.score;
                });
            },

            renderSummary: function () {
                const container = document.getElementById('perf-summary');
                if (!container) return;

                const allGuards = this.getAllGuardPerformance();
                const highRisk = allGuards.filter(g => g.performance.riskLevel === 'high-risk').length;
                const watch = allGuards.filter(g => g.performance.riskLevel === 'watch').length;
                const good = allGuards.filter(g => g.performance.riskLevel === 'good').length;
                const avgScore = allGuards.length > 0 
                    ? Math.round(allGuards.reduce((sum, g) => sum + g.performance.score, 0) / allGuards.length)
                    : 0;

                container.innerHTML = `
                    <div class="kpi-card" style="cursor: pointer;" onclick="document.getElementById('perf-filter-status').value='high-risk'; GuardPerformanceModule.filters.status='high-risk'; GuardPerformanceModule.renderScorecard();">
                        <div class="kpi-header">
                            <span class="kpi-label">High Risk</span>
                            <div class="kpi-icon danger">ğŸ”´</div>
                        </div>
                        <div class="kpi-value" style="color: var(--color-danger);">${highRisk}</div>
                        <div class="kpi-subtext">Needs attention</div>
                    </div>
                    <div class="kpi-card" style="cursor: pointer;" onclick="document.getElementById('perf-filter-status').value='watch'; GuardPerformanceModule.filters.status='watch'; GuardPerformanceModule.renderScorecard();">
                        <div class="kpi-header">
                            <span class="kpi-label">Watch List</span>
                            <div class="kpi-icon warning">ğŸŸ¡</div>
                        </div>
                        <div class="kpi-value" style="color: var(--color-warning);">${watch}</div>
                        <div class="kpi-subtext">Monitor closely</div>
                    </div>
                    <div class="kpi-card" style="cursor: pointer;" onclick="document.getElementById('perf-filter-status').value='good'; GuardPerformanceModule.filters.status='good'; GuardPerformanceModule.renderScorecard();">
                        <div class="kpi-header">
                            <span class="kpi-label">Good Standing</span>
                            <div class="kpi-icon success">ğŸŸ¢</div>
                        </div>
                        <div class="kpi-value" style="color: var(--color-success);">${good}</div>
                        <div class="kpi-subtext">Performing well</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <span class="kpi-label">Avg Score</span>
                            <div class="kpi-icon ${avgScore >= 80 ? 'success' : avgScore >= 60 ? 'warning' : 'danger'}">ğŸ“Š</div>
                        </div>
                        <div class="kpi-value">${avgScore}</div>
                        <div class="kpi-subtext">Team average</div>
                    </div>
                `;
            },

            renderScorecard: function () {
                const container = document.getElementById('perf-scorecard');
                if (!container) return;

                let guards = this.getAllGuardPerformance();
                const sites = DataStore.getSites();

                // Apply filters
                if (this.filters.search) {
                    guards = guards.filter(g => g.name.toLowerCase().includes(this.filters.search));
                }
                if (this.filters.status) {
                    guards = guards.filter(g => g.performance.riskLevel === this.filters.status);
                }
                if (this.filters.site) {
                    guards = guards.filter(g => g.primarySites && g.primarySites.includes(this.filters.site));
                }

                if (guards.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: var(--space-8);">
                            <p class="text-muted">No guards match current filters</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = guards.map(guard => {
                    const p = guard.performance;
                    const primarySiteNames = (guard.primarySites || []).map(sid => 
                        sites.find(s => s.id === sid)?.name || ''
                    ).filter(Boolean).slice(0, 2).join(', ');

                    const scoreClass = p.score >= 80 ? 'excellent' : p.score >= 60 ? 'good' : p.score >= 40 ? 'fair' : 'poor';

                    return `
                        <div class="perf-card ${p.riskLevel}" onclick="GuardPerformanceModule.openProfile('${guard.id}')">
                            <div class="perf-card-header">
                                <div>
                                    <div class="perf-card-name">${Utils.escapeHtml(guard.name)}</div>
                                    <div class="perf-card-role">${primarySiteNames || 'No primary site'}</div>
                                </div>
                                <div class="perf-score ${scoreClass}">${p.score}</div>
                            </div>
                            <div class="perf-metrics">
                                <div class="perf-metric">
                                    <div class="perf-metric-value ${p.metrics.incidents > 0 ? 'negative' : 'neutral'}">${p.metrics.incidents}</div>
                                    <div class="perf-metric-label">Incidents</div>
                                </div>
                                <div class="perf-metric">
                                    <div class="perf-metric-value ${p.metrics.calloffs >= 3 ? 'negative' : p.metrics.calloffs > 0 ? 'neutral' : 'neutral'}">${p.metrics.calloffs}</div>
                                    <div class="perf-metric-label">Call-offs</div>
                                </div>
                                <div class="perf-metric">
                                    <div class="perf-metric-value ${p.metrics.writeUps > 0 ? 'negative' : 'neutral'}">${p.metrics.writeUps}</div>
                                    <div class="perf-metric-label">Write-ups</div>
                                </div>
                                <div class="perf-metric">
                                    <div class="perf-metric-value ${p.metrics.commendations > 0 ? 'positive' : 'neutral'}">${p.metrics.commendations}</div>
                                    <div class="perf-metric-label">Kudos</div>
                                </div>
                            </div>
                            ${p.flags.length > 0 ? `
                                <div class="perf-flags">
                                    ${p.flags.map(f => `<span class="perf-flag ${f.type}">${f.label}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            },

            // Open detailed guard profile
            openProfile: function (guardId) {
                const guard = DataStore.getGuardById(guardId);
                if (!guard) return;

                const performance = this.calculateMetrics(guard);
                const sites = DataStore.getSites();
                const primarySiteNames = (guard.primarySites || []).map(sid =>
                    sites.find(s => s.id === sid)?.name || ''
                ).filter(Boolean).join(', ');

                // Build timeline of events
                const timeline = [];

                // Add incidents
                performance.recentIncidents.forEach(inc => {
                    const site = DataStore.getSiteById(inc.siteId);
                    timeline.push({
                        type: 'incident',
                        date: new Date(inc.dateTime),
                        title: inc.type,
                        detail: `${site?.name || 'Unknown'} - ${inc.severity}`,
                        link: `IncidentsModule.viewIncident('${inc.id}')`,
                        id: inc.id
                    });
                });

                // Add call-offs
                performance.recentCalloffs.forEach(c => {
                    const site = DataStore.getSiteById(c.siteId);
                    timeline.push({
                        type: 'calloff',
                        date: new Date(c.date),
                        title: 'Call-off',
                        detail: `${site?.name || 'Unknown'} - ${c.reason || 'No reason'}`,
                        link: `Router.navigate('calloffs')`,
                        id: c.id
                    });
                });

                // Add disciplinary
                performance.recentDisciplinary.forEach(d => {
                    const typeLabels = {
                        'verbal_warning': 'Verbal Warning',
                        'written_warning': 'Written Warning',
                        'final_warning': 'Final Warning',
                        'suspension': 'Suspension',
                        'coaching': 'Coaching',
                        'commendation': 'Commendation â­'
                    };
                    timeline.push({
                        type: d.type === 'commendation' ? 'commendation' : 'discipline',
                        date: new Date(d.date),
                        title: typeLabels[d.type] || d.type,
                        detail: d.description || 'No details',
                        link: `RosterModule.editGuard('${guardId}')`,
                        id: d.id
                    });
                });

                // Sort by date descending
                timeline.sort((a, b) => b.date - a.date);

                const scoreClass = performance.score >= 80 ? 'excellent' : performance.score >= 60 ? 'good' : performance.score >= 40 ? 'fair' : 'poor';
                const riskLabel = { 'high-risk': 'ğŸ”´ High Risk', 'watch': 'ğŸŸ¡ Watch List', 'good': 'ğŸŸ¢ Good Standing' };

                const content = `
                    <div style="display: flex; gap: var(--space-5); flex-wrap: wrap;">
                        <!-- Left Column: Profile Summary -->
                        <div style="flex: 1; min-width: 280px;">
                            <div style="display: flex; align-items: center; gap: var(--space-4); margin-bottom: var(--space-4);">
                                <div class="perf-score ${scoreClass}" style="width: 64px; height: 64px; font-size: var(--font-size-2xl);">${performance.score}</div>
                                <div>
                                    <h3 style="margin: 0 0 var(--space-1) 0;">${Utils.escapeHtml(guard.name)}</h3>
                                    <div class="text-sm text-muted">${primarySiteNames || 'No primary site'}</div>
                                    <div style="margin-top: var(--space-1);">${riskLabel[performance.riskLevel]}</div>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3); margin-bottom: var(--space-4);">
                                <div class="perf-metric" style="padding: var(--space-3);">
                                    <div class="perf-metric-value ${performance.metrics.incidents > 0 ? 'negative' : ''}" style="font-size: var(--font-size-xl);">${performance.metrics.incidents}</div>
                                    <div class="perf-metric-label">Incidents</div>
                                </div>
                                <div class="perf-metric" style="padding: var(--space-3);">
                                    <div class="perf-metric-value ${performance.metrics.calloffs >= 3 ? 'negative' : ''}" style="font-size: var(--font-size-xl);">${performance.metrics.calloffs}</div>
                                    <div class="perf-metric-label">Call-offs</div>
                                </div>
                                <div class="perf-metric" style="padding: var(--space-3);">
                                    <div class="perf-metric-value ${performance.metrics.writeUps > 0 ? 'negative' : ''}" style="font-size: var(--font-size-xl);">${performance.metrics.writeUps}</div>
                                    <div class="perf-metric-label">Write-ups</div>
                                </div>
                                <div class="perf-metric" style="padding: var(--space-3);">
                                    <div class="perf-metric-value ${performance.metrics.commendations > 0 ? 'positive' : ''}" style="font-size: var(--font-size-xl);">${performance.metrics.commendations}</div>
                                    <div class="perf-metric-label">Commendations</div>
                                </div>
                            </div>

                            ${performance.flags.length > 0 ? `
                                <div style="margin-bottom: var(--space-4);">
                                    <div class="text-sm text-muted mb-2">Active Flags</div>
                                    <div class="perf-flags">
                                        ${performance.flags.map(f => `<span class="perf-flag ${f.type}">${f.label}</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            <div style="display: flex; gap: var(--space-2); flex-wrap: wrap;">
                                <button class="btn btn-secondary btn-sm" onclick="UI.closeModal(); RosterModule.editGuard('${guardId}');">
                                    Edit Profile
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="UI.closeModal(); WarningNoticeModule.openForGuard('${guardId}');">
                                    Issue Warning
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="GuardPerformanceModule.addCommendation('${guardId}');">
                                    Add Commendation
                                </button>
                            </div>
                        </div>

                        <!-- Right Column: Timeline -->
                        <div style="flex: 1.5; min-width: 320px;">
                            <div class="text-sm text-muted mb-2">Activity Timeline (Last ${this.period} Days)</div>
                            <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                                ${timeline.length === 0 ? `
                                    <div style="padding: var(--space-6); text-align: center; color: var(--color-text-muted);">
                                        No activity in this period âœ…
                                    </div>
                                ` : `
                                    <div class="perf-timeline">
                                        ${timeline.map(item => `
                                            <div class="perf-timeline-item" style="cursor: pointer;" onclick="${item.link}">
                                                <div class="perf-timeline-icon ${item.type}">
                                                    ${item.type === 'incident' ? 'âš ï¸' : item.type === 'calloff' ? 'ğŸ“µ' : item.type === 'commendation' ? 'â­' : 'ğŸ“‹'}
                                                </div>
                                                <div class="perf-timeline-content">
                                                    <div class="perf-timeline-title">${Utils.escapeHtml(item.title)}</div>
                                                    <div class="perf-timeline-detail">${Utils.escapeHtml(item.detail)}</div>
                                                </div>
                                                <div class="perf-timeline-date">${item.date.toLocaleDateString()}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;

                const footer = `<button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>`;
                UI.openModal(`Guard Performance: ${guard.name}`, content, footer, 'lg');
            },

            // Quick add commendation
            addCommendation: function (guardId) {
                const description = prompt('Enter commendation details:');
                if (!description || !description.trim()) return;

                const guards = DataStore.getGuards();
                const guard = guards.find(g => g.id === guardId);
                if (!guard) return;

                if (!guard.disciplinaryHistory) guard.disciplinaryHistory = [];
                
                guard.disciplinaryHistory.unshift({
                    id: Utils.generateId('disc-'),
                    type: 'commendation',
                    date: Utils.toISODate(new Date()),
                    description: description.trim(),
                    addedBy: 'Supervisor'
                });

                DataStore.saveGuards(guards);
                UI.closeModal();
                this.render();
                UI.toast('Commendation Added', `${guard.name} has been recognized.`, 'success');
            },

            // Export performance report
            exportReport: function () {
                const guards = this.getAllGuardPerformance();
                
                const headers = ['Name', 'Score', 'Risk Level', 'Incidents', 'Call-offs', 'Write-ups', 'Commendations', 'Primary Sites'];
                const sites = DataStore.getSites();
                
                const rows = guards.map(g => {
                    const siteNames = (g.primarySites || []).map(sid => 
                        sites.find(s => s.id === sid)?.name || ''
                    ).filter(Boolean).join('; ');
                    
                    return [
                        g.name,
                        g.performance.score,
                        g.performance.riskLevel,
                        g.performance.metrics.incidents,
                        g.performance.metrics.calloffs,
                        g.performance.metrics.writeUps,
                        g.performance.metrics.commendations,
                        siteNames
                    ];
                });

                const csv = [headers, ...rows].map(row => 
                    row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
                ).join('\n');

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `guard_performance_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);

                UI.toast('Export Complete', 'Performance report downloaded.', 'success');
            },

            // Get high-risk guards for Attention Panel
            getAttentionItems: function () {
                const guards = this.getAllGuardPerformance();
                const highRisk = guards.filter(g => g.performance.riskLevel === 'high-risk');
                const items = [];

                if (highRisk.length > 0) {
                    items.push({
                        icon: 'ğŸ“Š',
                        title: `${highRisk.length} guard${highRisk.length > 1 ? 's' : ''} high risk`,
                        detail: highRisk.slice(0, 2).map(g => g.name.split(' ')[0]).join(', ') + 
                               (highRisk.length > 2 ? ` +${highRisk.length - 2}` : ''),
                        badge: 'REVIEW',
                        severity: 'warning',
                        action: "Router.navigate('performance')"
                    });
                }

                return items;
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FATIGUE MANAGEMENT MODULE â€” Guard Workload Monitoring
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const FatigueModule = {
            // Thresholds for fatigue detection
            THRESHOLDS: {
                CONSECUTIVE_DAYS_WARNING: 5,
                CONSECUTIVE_DAYS_CRITICAL: 6,
                WEEKLY_HOURS_WARNING: 40,
                WEEKLY_HOURS_CRITICAL: 50,
                MIN_REST_HOURS: 8,
                NO_DAY_OFF_WINDOW: 7
            },

            // Standard shift durations in hours
            SHIFT_HOURS: {
                '12A-8A': 8,
                '8A-4P': 8,
                '4P-12A': 8,
                'default': 8
            },

            // Get all shifts for a guard across multiple weeks
            getGuardShifts: function (guardId, weeksBack = 2, weeksForward = 1) {
                const shifts = [];
                const now = new Date();
                
                for (let w = -weeksBack; w <= weeksForward; w++) {
                    const weekDate = new Date(now);
                    weekDate.setDate(weekDate.getDate() + (w * 7));
                    const weekKey = Utils.getWeekKey(weekDate);
                    const weekShifts = DataStore.getScheduleForWeek(weekKey) || [];
                    
                    weekShifts.forEach(shift => {
                        if (shift.guardId === guardId && shift.status !== 'OPEN') {
                            shifts.push(shift);
                        }
                    });
                }
                
                return shifts.sort((a, b) => new Date(a.date) - new Date(b.date));
            },

            // Calculate consecutive days worked
            getConsecutiveDays: function (guardId) {
                const shifts = this.getGuardShifts(guardId);
                if (shifts.length === 0) return 0;

                const today = Utils.toISODate(new Date());
                const workDays = [...new Set(shifts.map(s => s.date))].sort();
                
                // Find current streak ending today or yesterday
                let streak = 0;
                let checkDate = new Date();
                
                for (let i = 0; i < 14; i++) {
                    const dateStr = Utils.toISODate(checkDate);
                    if (workDays.includes(dateStr)) {
                        streak++;
                        checkDate.setDate(checkDate.getDate() - 1);
                    } else if (streak > 0) {
                        break;
                    } else {
                        checkDate.setDate(checkDate.getDate() - 1);
                    }
                }
                
                return streak;
            },

            // Calculate hours worked in current week
            getWeeklyHours: function (guardId) {
                const weekKey = Utils.getWeekKey(new Date());
                const weekShifts = DataStore.getScheduleForWeek(weekKey) || [];
                const guardShifts = weekShifts.filter(s => s.guardId === guardId && s.status !== 'OPEN');
                
                let totalHours = 0;
                guardShifts.forEach(shift => {
                    const hours = this.SHIFT_HOURS[shift.shiftTime] || this.SHIFT_HOURS.default;
                    totalHours += hours;
                });
                
                return totalHours;
            },

            // Check for back-to-back shifts (less than 8 hours rest)
            hasBackToBackShifts: function (guardId) {
                const shifts = this.getGuardShifts(guardId, 1, 1);
                if (shifts.length < 2) return false;

                // Parse shift times to check gaps
                const shiftEnds = {
                    '12A-8A': 8,   // Ends at 8am
                    '8A-4P': 16,   // Ends at 4pm
                    '4P-12A': 24   // Ends at midnight
                };
                
                const shiftStarts = {
                    '12A-8A': 0,   // Starts at midnight
                    '8A-4P': 8,    // Starts at 8am
                    '4P-12A': 16   // Starts at 4pm
                };

                for (let i = 0; i < shifts.length - 1; i++) {
                    const current = shifts[i];
                    const next = shifts[i + 1];
                    
                    const currentDate = new Date(current.date);
                    const nextDate = new Date(next.date);
                    const daysDiff = (nextDate - currentDate) / (1000 * 60 * 60 * 24);
                    
                    if (daysDiff === 0) {
                        // Same day - check shift order
                        const endHour = shiftEnds[current.shiftTime] || 16;
                        const startHour = shiftStarts[next.shiftTime] || 8;
                        if (startHour - endHour < this.THRESHOLDS.MIN_REST_HOURS && startHour > endHour) {
                            return true;
                        }
                    } else if (daysDiff === 1) {
                        // Consecutive days - check overnight rest
                        const endHour = shiftEnds[current.shiftTime] || 16;
                        const startHour = shiftStarts[next.shiftTime] || 8;
                        const restHours = (24 - endHour) + startHour;
                        if (restHours < this.THRESHOLDS.MIN_REST_HOURS) {
                            return true;
                        }
                    }
                }
                
                return false;
            },

            // Check if guard has had a day off in the last 7 days
            hasRecentDayOff: function (guardId) {
                const shifts = this.getGuardShifts(guardId, 1, 0);
                const workDays = new Set(shifts.map(s => s.date));
                
                // Check last 7 days
                for (let i = 0; i < this.THRESHOLDS.NO_DAY_OFF_WINDOW; i++) {
                    const checkDate = new Date();
                    checkDate.setDate(checkDate.getDate() - i);
                    const dateStr = Utils.toISODate(checkDate);
                    if (!workDays.has(dateStr)) {
                        return true;
                    }
                }
                
                return false;
            },

            // Get fatigue score for a guard
            getGuardFatigueScore: function (guardId) {
                const consecutiveDays = this.getConsecutiveDays(guardId);
                const weeklyHours = this.getWeeklyHours(guardId);
                const hasBackToBack = this.hasBackToBackShifts(guardId);
                const hasDayOff = this.hasRecentDayOff(guardId);
                
                const flags = [];
                let severity = 'green';

                // Check consecutive days
                if (consecutiveDays >= this.THRESHOLDS.CONSECUTIVE_DAYS_CRITICAL) {
                    flags.push({ type: 'consecutive', label: `${consecutiveDays} days straight`, severity: 'critical' });
                    severity = 'red';
                } else if (consecutiveDays >= this.THRESHOLDS.CONSECUTIVE_DAYS_WARNING) {
                    flags.push({ type: 'consecutive', label: `${consecutiveDays} days straight`, severity: 'warning' });
                    if (severity !== 'red') severity = 'yellow';
                }

                // Check weekly hours
                if (weeklyHours >= this.THRESHOLDS.WEEKLY_HOURS_CRITICAL) {
                    flags.push({ type: 'overtime', label: `${weeklyHours}hrs this week`, severity: 'critical' });
                    severity = 'red';
                } else if (weeklyHours >= this.THRESHOLDS.WEEKLY_HOURS_WARNING) {
                    flags.push({ type: 'overtime', label: `${weeklyHours}hrs this week`, severity: 'warning' });
                    if (severity !== 'red') severity = 'yellow';
                }

                // Check back-to-back
                if (hasBackToBack) {
                    flags.push({ type: 'back-to-back', label: '<8hr rest', severity: 'warning' });
                    if (severity !== 'red') severity = 'yellow';
                }

                // Check no day off
                if (!hasDayOff) {
                    flags.push({ type: 'no-rest', label: 'No day off in 7 days', severity: 'critical' });
                    severity = 'red';
                }

                return {
                    guardId,
                    consecutiveDays,
                    weeklyHours,
                    hasBackToBack,
                    hasDayOff,
                    flags,
                    severity
                };
            },

            // Get all guards with fatigue flags
            getFatiguedGuards: function () {
                const guards = DataStore.getActiveGuards();
                const fatigued = [];
                
                guards.forEach(guard => {
                    const score = this.getGuardFatigueScore(guard.id);
                    if (score.flags.length > 0) {
                        fatigued.push({
                            ...guard,
                            fatigue: score
                        });
                    }
                });
                
                // Sort by severity (red first, then yellow)
                return fatigued.sort((a, b) => {
                    const severityOrder = { red: 0, yellow: 1, green: 2 };
                    return severityOrder[a.fatigue.severity] - severityOrder[b.fatigue.severity];
                });
            },

            // Get fatigue summary for attention panel
            getAttentionItems: function () {
                const fatigued = this.getFatiguedGuards();
                const critical = fatigued.filter(g => g.fatigue.severity === 'red');
                const warning = fatigued.filter(g => g.fatigue.severity === 'yellow');
                
                const items = [];
                
                if (critical.length > 0) {
                    items.push({
                        icon: 'ğŸ˜°',
                        title: `${critical.length} guard${critical.length > 1 ? 's' : ''} at fatigue risk`,
                        detail: critical.slice(0, 2).map(g => g.name.split(' ')[0]).join(', ') + 
                               (critical.length > 2 ? ` +${critical.length - 2} more` : ''),
                        badge: 'FATIGUE',
                        severity: 'critical',
                        action: "FatigueModule.openReport()"
                    });
                } else if (warning.length > 0) {
                    items.push({
                        icon: 'â°',
                        title: `${warning.length} guard${warning.length > 1 ? 's' : ''} approaching limits`,
                        detail: 'Review workload distribution',
                        badge: 'MONITOR',
                        severity: 'warning',
                        action: "FatigueModule.openReport()"
                    });
                }
                
                return items;
            },

            // Open fatigue report modal
            openReport: function () {
                const fatigued = this.getFatiguedGuards();
                const allGuards = DataStore.getActiveGuards();
                
                const critical = fatigued.filter(g => g.fatigue.severity === 'red');
                const warning = fatigued.filter(g => g.fatigue.severity === 'yellow');
                const healthy = allGuards.length - fatigued.length;

                const renderGuardRow = (guard) => {
                    const f = guard.fatigue;
                    return `
                        <div class="fatigue-guard-row" onclick="FatigueModule.showGuardDetail('${guard.id}')">
                            <div class="fatigue-guard-info">
                                <div class="fatigue-guard-avatar" style="background: var(--color-${f.severity === 'red' ? 'danger' : 'warning'}-bg); color: var(--color-${f.severity === 'red' ? 'danger' : 'warning'});">
                                    ${guard.name.charAt(0).toUpperCase()}
                                </div>
                                <div class="fatigue-guard-details">
                                    <div class="fatigue-guard-name">${Utils.escapeHtml(guard.name)}</div>
                                    <div class="fatigue-guard-flags">
                                        ${f.flags.map(flag => `
                                            <span class="fatigue-flag ${flag.type}">${flag.label}</span>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            <div class="fatigue-indicator ${f.severity}">
                                ${f.severity === 'red' ? 'ğŸ”´ Critical' : 'ğŸŸ¡ Warning'}
                            </div>
                        </div>
                    `;
                };

                const content = `
                    <div style="margin-bottom: var(--space-5);">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-3); margin-bottom: var(--space-4);">
                            <div class="fatigue-card" style="text-align: center; border-left: 4px solid var(--color-danger);">
                                <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-danger);">${critical.length}</div>
                                <div class="text-sm text-muted">Critical</div>
                            </div>
                            <div class="fatigue-card" style="text-align: center; border-left: 4px solid var(--color-warning);">
                                <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-warning);">${warning.length}</div>
                                <div class="text-sm text-muted">Warning</div>
                            </div>
                            <div class="fatigue-card" style="text-align: center; border-left: 4px solid var(--color-success);">
                                <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-success);">${healthy}</div>
                                <div class="text-sm text-muted">Healthy</div>
                            </div>
                        </div>
                    </div>

                    ${fatigued.length === 0 ? `
                        <div class="empty-state" style="text-align: center; padding: var(--space-8);">
                            <div style="font-size: 48px; margin-bottom: var(--space-3);">âœ…</div>
                            <h4 style="margin-bottom: var(--space-2);">All Guards Within Safe Limits</h4>
                            <p class="text-muted">No fatigue warnings detected based on current schedules.</p>
                        </div>
                    ` : `
                        <div style="margin-bottom: var(--space-3);">
                            <div class="text-sm text-muted" style="margin-bottom: var(--space-2);">Thresholds: ${this.THRESHOLDS.CONSECUTIVE_DAYS_WARNING}+ consecutive days, ${this.THRESHOLDS.WEEKLY_HOURS_WARNING}+ hours/week, <${this.THRESHOLDS.MIN_REST_HOURS}hr rest</div>
                        </div>

                        ${critical.length > 0 ? `
                            <div style="margin-bottom: var(--space-4);">
                                <h4 style="color: var(--color-danger); margin-bottom: var(--space-2); display: flex; align-items: center; gap: var(--space-2);">
                                    ğŸ”´ Critical (${critical.length})
                                </h4>
                                <div style="border: 1px solid var(--color-border); border-radius: var(--radius-md); overflow: hidden;">
                                    ${critical.map(renderGuardRow).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${warning.length > 0 ? `
                            <div>
                                <h4 style="color: var(--color-warning); margin-bottom: var(--space-2); display: flex; align-items: center; gap: var(--space-2);">
                                    ğŸŸ¡ Warning (${warning.length})
                                </h4>
                                <div style="border: 1px solid var(--color-border); border-radius: var(--radius-md); overflow: hidden;">
                                    ${warning.map(renderGuardRow).join('')}
                                </div>
                            </div>
                        ` : ''}
                    `}
                `;

                const footer = `<button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>`;
                UI.openModal('Fatigue Report', content, footer);
            },

            // Show detailed fatigue info for a guard
            showGuardDetail: function (guardId) {
                const guard = DataStore.getGuardById(guardId);
                const score = this.getGuardFatigueScore(guardId);
                const shifts = this.getGuardShifts(guardId, 2, 1);
                const sites = DataStore.getSites();

                // Group shifts by date for display
                const shiftsByDate = {};
                shifts.forEach(s => {
                    if (!shiftsByDate[s.date]) shiftsByDate[s.date] = [];
                    const site = sites.find(st => st.id === s.siteId);
                    shiftsByDate[s.date].push({
                        ...s,
                        siteName: site?.name || 'Unknown'
                    });
                });

                const sortedDates = Object.keys(shiftsByDate).sort();
                const today = Utils.toISODate(new Date());

                const content = `
                    <div style="margin-bottom: var(--space-4);">
                        <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-4);">
                            <div class="fatigue-guard-avatar" style="width: 48px; height: 48px; font-size: var(--font-size-lg); background: var(--color-${score.severity === 'red' ? 'danger' : score.severity === 'yellow' ? 'warning' : 'success'}-bg); color: var(--color-${score.severity === 'red' ? 'danger' : score.severity === 'yellow' ? 'warning' : 'success'});">
                                ${guard.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <h3 style="margin: 0 0 var(--space-1) 0;">${Utils.escapeHtml(guard.name)}</h3>
                                <div class="fatigue-indicator ${score.severity}">
                                    ${score.severity === 'red' ? 'ğŸ”´ Critical Fatigue' : score.severity === 'yellow' ? 'ğŸŸ¡ Warning' : 'ğŸŸ¢ Healthy'}
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3); margin-bottom: var(--space-4);">
                            <div class="fatigue-metric">
                                <div class="fatigue-metric-icon ${score.consecutiveDays >= this.THRESHOLDS.CONSECUTIVE_DAYS_WARNING ? 'warning' : ''}">ğŸ“…</div>
                                <div>
                                    <div class="fatigue-metric-value">${score.consecutiveDays} days</div>
                                    <div class="fatigue-metric-label">Consecutive</div>
                                </div>
                            </div>
                            <div class="fatigue-metric">
                                <div class="fatigue-metric-icon ${score.weeklyHours >= this.THRESHOLDS.WEEKLY_HOURS_WARNING ? 'warning' : ''}">â±ï¸</div>
                                <div>
                                    <div class="fatigue-metric-value">${score.weeklyHours} hrs</div>
                                    <div class="fatigue-metric-label">This Week</div>
                                </div>
                            </div>
                            <div class="fatigue-metric">
                                <div class="fatigue-metric-icon ${score.hasBackToBack ? 'danger' : ''}">ğŸ”„</div>
                                <div>
                                    <div class="fatigue-metric-value">${score.hasBackToBack ? 'Yes' : 'No'}</div>
                                    <div class="fatigue-metric-label">Back-to-Back</div>
                                </div>
                            </div>
                            <div class="fatigue-metric">
                                <div class="fatigue-metric-icon ${!score.hasDayOff ? 'danger' : ''}">ğŸ˜´</div>
                                <div>
                                    <div class="fatigue-metric-value">${score.hasDayOff ? 'Yes' : 'No'}</div>
                                    <div class="fatigue-metric-label">Day Off (7d)</div>
                                </div>
                            </div>
                        </div>

                        ${score.flags.length > 0 ? `
                            <div style="background: var(--color-${score.severity === 'red' ? 'danger' : 'warning'}-bg); padding: var(--space-3); border-radius: var(--radius-md); margin-bottom: var(--space-4);">
                                <strong style="color: var(--color-${score.severity === 'red' ? 'danger' : 'warning'});">Active Flags:</strong>
                                <div style="margin-top: var(--space-2); display: flex; gap: var(--space-2); flex-wrap: wrap;">
                                    ${score.flags.map(f => `<span class="fatigue-flag ${f.type}">${f.label}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <h4 style="margin-bottom: var(--space-2);">Recent & Upcoming Shifts</h4>
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                            ${sortedDates.map(date => {
                                const isToday = date === today;
                                const isPast = date < today;
                                const dayShifts = shiftsByDate[date];
                                const dateLabel = new Date(date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                                
                                return `
                                    <div style="padding: var(--space-2) var(--space-3); border-bottom: 1px solid var(--color-border); ${isToday ? 'background: var(--color-info-bg);' : ''} ${isPast ? 'opacity: 0.6;' : ''}">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span class="text-sm ${isToday ? 'font-semibold' : ''}">${dateLabel}${isToday ? ' (Today)' : ''}</span>
                                            <span class="text-xs text-muted">${dayShifts.map(s => s.shiftTime).join(', ')}</span>
                                        </div>
                                        <div class="text-xs text-muted">${dayShifts.map(s => s.siteName).join(', ')}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="FatigueModule.openReport()">Back to Report</button>
                    <button class="btn btn-primary" onclick="UI.closeModal(); Router.navigate('scheduler');">View Schedule</button>
                `;

                UI.openModal('Guard Workload', content, footer);
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // COVERAGE SUGGESTION ENGINE - v6.19.4
        // Intelligently suggests guards for open shifts based on multiple factors
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const CoverageSuggestionEngine = {
            // Scoring weights (higher = more important)
            WEIGHTS: {
                AVAILABILITY_PREFERS: 30,      // Explicitly prefers this shift
                AVAILABILITY_AVAILABLE: 20,    // Marked available
                AVAILABILITY_UNSPECIFIED: 10,  // No record (assume available)
                PRIMARY_SITE: 25,              // This is their primary site
                SITE_FAMILIARITY: 15,          // Has worked here before (scaled by count)
                CERTIFICATION_MATCH: 40,       // Has required certification (armed/unarmed)
                LOW_FATIGUE: 20,               // Not fatigued
                NO_OT_RISK: 15,                // Won't trigger overtime
                RECENT_WORK: -5                // Worked recently (slight penalty to spread load)
            },

            // Penalties
            PENALTIES: {
                FATIGUE_WARNING: -20,
                FATIGUE_CRITICAL: -50,
                OT_RISK: -15,
                ALREADY_SCHEDULED: -1000,      // Effectively disqualifies
                UNAVAILABLE: -1000,            // Effectively disqualifies
                WRONG_CERTIFICATION: -1000     // Effectively disqualifies
            },

            /**
             * Get coverage suggestions for an open shift
             * @param {Object} params - { siteId, date, shiftLabel, postType: 'armed'|'unarmed'|'any' }
             * @returns {Array} Ranked list of suggestions with scores and explanations
             */
            getSuggestions: function(params) {
                const { siteId, date, shiftLabel, postType = 'any' } = params;
                
                if (!siteId || !date) {
                    console.error('[CoverageEngine] Missing required params: siteId, date');
                    return [];
                }

                const guards = DataStore.getActiveGuards();
                const availability = DataStore.getAvailability();
                const allSchedules = DataStore.getAllSchedules();
                const site = DataStore.getSiteById(siteId);
                
                // Build lookup maps
                const availLookup = this._buildAvailabilityLookup(availability, date, shiftLabel);
                const scheduledGuards = this._getScheduledGuards(allSchedules, date, shiftLabel);
                const weeklyHours = this._calculateWeeklyHours(allSchedules, date);
                const siteFamiliarity = this._calculateSiteFamiliarity(allSchedules, siteId, date);
                
                // Score each guard
                const suggestions = [];
                
                guards.forEach(guard => {
                    const result = this._scoreGuard(guard, {
                        siteId,
                        date,
                        shiftLabel,
                        postType,
                        availLookup,
                        scheduledGuards,
                        weeklyHours,
                        siteFamiliarity,
                        site
                    });
                    
                    suggestions.push(result);
                });
                
                // Sort by score descending
                suggestions.sort((a, b) => b.score - a.score);
                
                // Add rank
                suggestions.forEach((s, i) => s.rank = i + 1);
                
                return suggestions;
            },

            /**
             * Get top N suggestions (only eligible guards)
             */
            getTopSuggestions: function(params, limit = 5) {
                const all = this.getSuggestions(params);
                return all.filter(s => s.eligible).slice(0, limit);
            },

            /**
             * Score an individual guard
             */
            _scoreGuard: function(guard, context) {
                const { siteId, date, shiftLabel, postType, availLookup, scheduledGuards, weeklyHours, siteFamiliarity, site } = context;
                
                let score = 0;
                const factors = [];
                let eligible = true;
                let disqualifyReason = null;

                // â”€â”€â”€ CERTIFICATION CHECK â”€â”€â”€
                const certMatch = this._checkCertification(guard, postType);
                if (!certMatch.eligible) {
                    eligible = false;
                    disqualifyReason = certMatch.reason;
                    score += this.PENALTIES.WRONG_CERTIFICATION;
                    factors.push({ factor: 'certification', value: certMatch.reason, points: this.PENALTIES.WRONG_CERTIFICATION });
                } else if (certMatch.points > 0) {
                    score += certMatch.points;
                    factors.push({ factor: 'certification', value: certMatch.reason, points: certMatch.points });
                }

                // â”€â”€â”€ ALREADY SCHEDULED CHECK â”€â”€â”€
                if (scheduledGuards.has(guard.id)) {
                    eligible = false;
                    disqualifyReason = 'Already scheduled for this time';
                    score += this.PENALTIES.ALREADY_SCHEDULED;
                    factors.push({ factor: 'scheduled', value: 'Already working', points: this.PENALTIES.ALREADY_SCHEDULED });
                }

                // â”€â”€â”€ AVAILABILITY CHECK â”€â”€â”€
                const availStatus = availLookup[guard.id] || 'unspecified';
                if (availStatus === 'unavailable' || availStatus === 'blocked') {
                    eligible = false;
                    disqualifyReason = 'Marked unavailable';
                    score += this.PENALTIES.UNAVAILABLE;
                    factors.push({ factor: 'availability', value: 'Unavailable', points: this.PENALTIES.UNAVAILABLE });
                } else if (availStatus === 'prefers') {
                    score += this.WEIGHTS.AVAILABILITY_PREFERS;
                    factors.push({ factor: 'availability', value: 'Prefers this shift', points: this.WEIGHTS.AVAILABILITY_PREFERS });
                } else if (availStatus === 'available') {
                    score += this.WEIGHTS.AVAILABILITY_AVAILABLE;
                    factors.push({ factor: 'availability', value: 'Available', points: this.WEIGHTS.AVAILABILITY_AVAILABLE });
                } else {
                    score += this.WEIGHTS.AVAILABILITY_UNSPECIFIED;
                    factors.push({ factor: 'availability', value: 'No record', points: this.WEIGHTS.AVAILABILITY_UNSPECIFIED });
                }

                // â”€â”€â”€ PRIMARY SITE â”€â”€â”€
                const isPrimarySite = (guard.primarySites || []).includes(siteId);
                if (isPrimarySite) {
                    score += this.WEIGHTS.PRIMARY_SITE;
                    factors.push({ factor: 'primarySite', value: 'Primary site', points: this.WEIGHTS.PRIMARY_SITE });
                }

                // â”€â”€â”€ SITE FAMILIARITY â”€â”€â”€
                const familiarity = siteFamiliarity[guard.id] || 0;
                if (familiarity > 0) {
                    const familiarityPoints = Math.min(familiarity * 3, this.WEIGHTS.SITE_FAMILIARITY);
                    score += familiarityPoints;
                    factors.push({ factor: 'familiarity', value: `${familiarity} prior shifts`, points: familiarityPoints });
                }

                // â”€â”€â”€ FATIGUE CHECK â”€â”€â”€
                const fatigue = FatigueModule.getGuardFatigueScore(guard.id);
                if (fatigue.severity === 'red') {
                    score += this.PENALTIES.FATIGUE_CRITICAL;
                    factors.push({ factor: 'fatigue', value: 'Critical fatigue', points: this.PENALTIES.FATIGUE_CRITICAL });
                    // Don't disqualify, but heavily penalize
                } else if (fatigue.severity === 'yellow') {
                    score += this.PENALTIES.FATIGUE_WARNING;
                    factors.push({ factor: 'fatigue', value: 'Fatigue warning', points: this.PENALTIES.FATIGUE_WARNING });
                } else {
                    score += this.WEIGHTS.LOW_FATIGUE;
                    factors.push({ factor: 'fatigue', value: 'No fatigue', points: this.WEIGHTS.LOW_FATIGUE });
                }

                // â”€â”€â”€ OVERTIME RISK â”€â”€â”€
                const guardWeeklyHours = weeklyHours[guard.id] || 0;
                const wouldCauseOT = guardWeeklyHours + 8 > 40;
                if (wouldCauseOT) {
                    score += this.PENALTIES.OT_RISK;
                    factors.push({ factor: 'overtime', value: `${guardWeeklyHours + 8}h would trigger OT`, points: this.PENALTIES.OT_RISK });
                } else {
                    score += this.WEIGHTS.NO_OT_RISK;
                    factors.push({ factor: 'overtime', value: `${guardWeeklyHours}h this week`, points: this.WEIGHTS.NO_OT_RISK });
                }

                return {
                    guard,
                    score,
                    eligible,
                    disqualifyReason,
                    factors,
                    meta: {
                        weeklyHours: guardWeeklyHours,
                        fatigue: fatigue.severity,
                        isPrimarySite,
                        familiarity,
                        availability: availStatus,
                        wouldCauseOT
                    }
                };
            },

            /**
             * Check if guard has required certification
             */
            _checkCertification: function(guard, postType) {
                if (postType === 'any') {
                    return { eligible: true, points: 0, reason: 'Any certification accepted' };
                }

                const role = (guard.role || '').toLowerCase();
                const certs = (guard.certifications || []).map(c => 
                    typeof c === 'string' ? c.toLowerCase() : (c.name || '').toLowerCase()
                );

                if (postType === 'armed') {
                    // Check if guard can work armed posts
                    const isArmed = role === 'armed' || 
                                   role === 'supervisor' || 
                                   certs.some(c => c.includes('armed') || c.includes('sora') || c.includes('firearm'));
                    
                    if (isArmed) {
                        return { eligible: true, points: this.WEIGHTS.CERTIFICATION_MATCH, reason: 'Armed certified' };
                    } else {
                        return { eligible: false, points: 0, reason: 'Not armed certified' };
                    }
                }

                if (postType === 'unarmed') {
                    // Any active guard can work unarmed
                    return { eligible: true, points: this.WEIGHTS.CERTIFICATION_MATCH, reason: 'Unarmed post' };
                }

                return { eligible: true, points: 0, reason: 'Unknown post type' };
            },

            /**
             * Build availability lookup for date/shift
             */
            _buildAvailabilityLookup: function(availability, date, shiftLabel) {
                const lookup = {};
                availability.forEach(a => {
                    if (a.date === date) {
                        if (!shiftLabel || a.shiftLabel === shiftLabel) {
                            // Take most restrictive status
                            const priority = { 'blocked': 4, 'unavailable': 3, 'prefers': 2, 'available': 1 };
                            const current = lookup[a.guardId];
                            if (!current || priority[a.status] > priority[current]) {
                                lookup[a.guardId] = a.status;
                            }
                        }
                    }
                });
                return lookup;
            },

            /**
             * Get guards already scheduled for date/shift
             */
            _getScheduledGuards: function(schedules, date, shiftLabel) {
                const scheduled = new Set();
                schedules.forEach(s => {
                    if (s.date === date && s.guardId) {
                        if (!shiftLabel || s.shiftLabel === shiftLabel || s.shiftTime === shiftLabel) {
                            scheduled.add(s.guardId);
                        }
                    }
                });
                return scheduled;
            },

            /**
             * Calculate weekly hours for all guards
             */
            _calculateWeeklyHours: function(schedules, targetDate) {
                const weekStart = this._getWeekStart(targetDate);
                const weekEnd = this._getWeekEnd(targetDate);
                const hours = {};
                
                schedules.forEach(s => {
                    if (s.guardId && s.date >= weekStart && s.date <= weekEnd) {
                        hours[s.guardId] = (hours[s.guardId] || 0) + 8;
                    }
                });
                
                return hours;
            },

            /**
             * Calculate site familiarity (shifts in last 30 days)
             */
            _calculateSiteFamiliarity: function(schedules, siteId, targetDate) {
                const thirtyDaysAgo = new Date(targetDate);
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const cutoff = thirtyDaysAgo.toISOString().split('T')[0];
                
                const familiarity = {};
                schedules.forEach(s => {
                    if (s.guardId && s.siteId === siteId && s.date >= cutoff && s.date < targetDate) {
                        familiarity[s.guardId] = (familiarity[s.guardId] || 0) + 1;
                    }
                });
                
                return familiarity;
            },

            _getWeekStart: function(dateStr) {
                const d = new Date(dateStr);
                const day = d.getDay();
                d.setDate(d.getDate() - day);
                return d.toISOString().split('T')[0];
            },

            _getWeekEnd: function(dateStr) {
                const d = new Date(dateStr);
                const day = d.getDay();
                d.setDate(d.getDate() + (6 - day));
                return d.toISOString().split('T')[0];
            },

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // UI METHODS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            /**
             * Open suggestion modal for an open shift
             */
            openSuggestions: function(siteId, date, shiftLabel, postType = 'any') {
                const site = DataStore.getSiteById(siteId);
                const suggestions = this.getTopSuggestions({ siteId, date, shiftLabel, postType }, 10);
                
                const dateFormatted = new Date(date + 'T00:00:00').toLocaleDateString('en-US', {
                    weekday: 'long', month: 'short', day: 'numeric'
                });

                const postLabel = postType === 'armed' ? 'ğŸ›¡ï¸ Armed' : postType === 'unarmed' ? 'Unarmed' : 'Any';

                let html = `
                    <div style="background: var(--color-surface-elevated); padding: var(--space-3); border-radius: var(--radius-md); margin-bottom: var(--space-4);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${Utils.escapeHtml(site?.name || 'Unknown Site')}</strong>
                                <div class="text-sm text-muted">${dateFormatted} â€¢ ${shiftLabel || 'Any shift'} â€¢ ${postLabel}</div>
                            </div>
                            <span class="badge badge-info">${suggestions.length} candidates</span>
                        </div>
                    </div>
                `;

                if (suggestions.length === 0) {
                    html += `
                        <div class="empty-state" style="text-align: center; padding: var(--space-6);">
                            <div style="font-size: 48px; margin-bottom: var(--space-3);">ğŸ”</div>
                            <h4>No Eligible Guards Found</h4>
                            <p class="text-muted">All guards are either scheduled, unavailable, or lack required certifications.</p>
                        </div>
                    `;
                } else {
                    html += `<div style="max-height: 400px; overflow-y: auto;">`;
                    
                    suggestions.forEach((s, i) => {
                        const scoreClass = s.score >= 80 ? 'excellent' : s.score >= 50 ? 'good' : s.score >= 20 ? 'fair' : 'poor';
                        const badges = [];
                        
                        if (s.meta.isPrimarySite) badges.push('<span class="badge" style="background: var(--color-primary-bg); color: var(--color-primary); font-size: 10px;">â˜… Primary</span>');
                        if (s.meta.wouldCauseOT) badges.push('<span class="badge" style="background: var(--color-warning-bg); color: var(--color-warning); font-size: 10px;">âš  OT</span>');
                        if (s.meta.fatigue === 'yellow') badges.push('<span class="badge" style="background: var(--color-warning-bg); color: var(--color-warning); font-size: 10px;">ğŸ˜“ Fatigue</span>');
                        if (s.meta.fatigue === 'red') badges.push('<span class="badge" style="background: var(--color-danger-bg); color: var(--color-danger); font-size: 10px;">ğŸ”´ Fatigued</span>');
                        if (s.meta.familiarity > 0) badges.push(`<span class="badge" style="background: var(--color-surface); font-size: 10px;">${s.meta.familiarity} prior</span>`);

                        // Top factors (positive only)
                        const topFactors = s.factors
                            .filter(f => f.points > 0)
                            .sort((a, b) => b.points - a.points)
                            .slice(0, 2)
                            .map(f => f.value)
                            .join(' â€¢ ');

                        html += `
                            <div class="coverage-suggestion" style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3); border-bottom: 1px solid var(--color-border); ${i === 0 ? 'background: var(--color-success-bg);' : ''}">
                                <div style="width: 32px; text-align: center; font-weight: bold; color: var(--color-text-muted);">#${s.rank}</div>
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--color-surface-elevated); display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--color-primary);">
                                    ${s.guard.name.charAt(0).toUpperCase()}
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: var(--font-weight-medium);">${Utils.escapeHtml(s.guard.name)}</div>
                                    <div class="text-xs text-muted">${topFactors || 'Available'}</div>
                                    ${badges.length > 0 ? `<div style="margin-top: 2px; display: flex; gap: 4px; flex-wrap: wrap;">${badges.join('')}</div>` : ''}
                                </div>
                                <div style="text-align: right;">
                                    <div class="coverage-score ${scoreClass}" style="font-size: var(--font-size-lg); font-weight: bold;">${s.score}</div>
                                    <div class="text-xs text-muted">${s.meta.weeklyHours}h/wk</div>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="CoverageSuggestionEngine.assignGuard('${s.guard.id}', '${siteId}', '${date}', '${shiftLabel || ''}')">
                                    Assign
                                </button>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                }

                // Show ineligible count
                const allSuggestions = this.getSuggestions({ siteId, date, shiftLabel, postType });
                const ineligible = allSuggestions.filter(s => !s.eligible);
                if (ineligible.length > 0) {
                    html += `
                        <details style="margin-top: var(--space-3);">
                            <summary class="text-sm text-muted" style="cursor: pointer;">
                                ${ineligible.length} guards ineligible (scheduled, unavailable, or wrong certification)
                            </summary>
                            <div class="text-xs text-muted" style="margin-top: var(--space-2); max-height: 100px; overflow-y: auto;">
                                ${ineligible.map(s => `${s.guard.name}: ${s.disqualifyReason}`).join('<br>')}
                            </div>
                        </details>
                    `;
                }

                const footer = `<button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>`;
                UI.openModal('Coverage Suggestions', html, footer);
            },

            /**
             * Assign guard to shift (quick action from suggestions)
             */
            assignGuard: function(guardId, siteId, date, shiftLabel) {
                const guard = DataStore.getGuardById(guardId);
                const site = DataStore.getSiteById(siteId);
                
                if (!guard || !site) {
                    UI.toast('Error', 'Guard or site not found', 'error');
                    return;
                }

                // Get week key for this date
                const weekKey = Utils.getWeekKey(new Date(date));
                let shifts = DataStore.getScheduleForWeek(weekKey) || [];
                
                // Check if shift slot already exists (open shift)
                const existingIdx = shifts.findIndex(s => 
                    s.siteId === siteId && 
                    s.date === date && 
                    (!shiftLabel || s.shiftLabel === shiftLabel || s.shiftTime === shiftLabel) &&
                    (!s.guardId || s.status === 'OPEN')
                );

                if (existingIdx !== -1) {
                    // Update existing open shift
                    shifts[existingIdx].guardId = guardId;
                    shifts[existingIdx].status = 'FILLED';
                    shifts[existingIdx].updatedAt = new Date().toISOString();
                } else {
                    // Create new shift
                    const newShift = {
                        id: Utils.generateId('shift-'),
                        siteId: siteId,
                        guardId: guardId,
                        date: date,
                        shiftLabel: shiftLabel || '8A-4P',
                        shiftTime: shiftLabel || '8A-4P',
                        status: 'FILLED',
                        createdAt: new Date().toISOString()
                    };
                    shifts.push(newShift);
                }

                DataStore.saveScheduleForWeek(weekKey, shifts);
                
                UI.closeModal();
                UI.toast('Assigned', `${guard.name} assigned to ${site.name}`, 'success');
                
                // Refresh scheduler if visible
                if (typeof SchedulerModule !== 'undefined') {
                    SchedulerModule.render();
                }
            },

            /**
             * Quick access from command palette - shows form to get suggestions
             */
            openQuickSuggest: function() {
                const sites = DataStore.getSites();
                const today = Utils.toISODate(new Date());

                const content = `
                    <div style="margin-bottom: var(--space-4);">
                        <p class="text-muted">Get AI-ranked guard suggestions for an open shift based on availability, certifications, fatigue, overtime risk, and site familiarity.</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Site <span style="color: var(--color-danger);">*</span></label>
                        <select class="form-select" id="suggest-site" required>
                            <option value="">Select site...</option>
                            ${sites.map(s => `<option value="${s.id}">${Utils.escapeHtml(s.name)}</option>`).join('')}
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Date <span style="color: var(--color-danger);">*</span></label>
                            <input type="date" class="form-input" id="suggest-date" value="${today}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Shift</label>
                            <select class="form-select" id="suggest-shift">
                                <option value="">Any Shift</option>
                                <option value="12A-8A">12A-8A (Overnight)</option>
                                <option value="8A-4P">8A-4P (Day)</option>
                                <option value="4P-12A">4P-12A (Evening)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Post Type</label>
                        <select class="form-select" id="suggest-post-type">
                            <option value="any">Any (Armed or Unarmed)</option>
                            <option value="armed">ğŸ›¡ï¸ Armed Only</option>
                            <option value="unarmed">Unarmed Only</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="CoverageSuggestionEngine.runQuickSuggest()" style="width: 100%;">
                        ğŸ¯ Get Suggestions
                    </button>
                `;

                const footer = `<button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>`;
                UI.openModal('Coverage Suggestions', content, footer);
            },

            /**
             * Run suggestions from quick suggest form
             */
            runQuickSuggest: function() {
                const siteId = document.getElementById('suggest-site').value;
                const date = document.getElementById('suggest-date').value;
                const shiftLabel = document.getElementById('suggest-shift').value || null;
                const postType = document.getElementById('suggest-post-type').value || 'any';

                if (!siteId) {
                    UI.toast('Missing Site', 'Please select a site.', 'error');
                    return;
                }

                if (!date) {
                    UI.toast('Missing Date', 'Please select a date.', 'error');
                    return;
                }

                UI.closeModal();
                
                // Small delay so modal closes cleanly before opening new one
                setTimeout(() => {
                    this.openSuggestions(siteId, date, shiftLabel, postType);
                }, 100);
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // APP INITIALIZATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const App = {
            init: async function () {
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // UPDATE VERSION DISPLAYS
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const versionDisplay = document.getElementById('app-version-display');
                if (versionDisplay) versionDisplay.textContent = APP_FULL_NAME;
                const aboutVersion = document.getElementById('about-version');
                if (aboutVersion) aboutVersion.textContent = `v${APP_VERSION}`;
                const onboardingVersion = document.getElementById('onboarding-version');
                if (onboardingVersion) onboardingVersion.textContent = APP_FULL_NAME;
                document.title = `${APP_FULL_NAME} | Newark Security Operations`;
                console.log(`[SENTINEL] ${APP_FULL_NAME} starting...`);

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // SESSION SAFETY: Clear any orphaned portal state on hard refresh
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                if (
                    document.body.classList.contains('portal-mode') &&
                    (!window.ClientPortalModule || !ClientPortalModule.isAuthenticated)
                ) {
                    document.body.classList.remove('portal-mode');
                    console.log('[SENTINEL] Cleared orphaned portal-mode on refresh');
                }

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // BOOTSTRAP SEQUENCE â€” Integrity check, migrations, then init
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                console.log('[SENTINEL] Starting bootstrap sequence...');

                // Step 0: Initialize local-first storage (IndexedDB)
                await SafeStorage.init();

                
                // Step 1: Run integrity check (fix corrupted data structures)
                const integrityResult = IntegrityChecker.run();
                if (!integrityResult.passed) {
                    console.warn('[SENTINEL] Integrity issues fixed:', integrityResult.fixes);
                }
                
                // Step 2: Run any pending migrations
                const migrationResult = MigrationManager.runMigrations();
                if (migrationResult.migrated) {
                    console.log(`[SENTINEL] Schema migrated: v${migrationResult.from} â†’ v${migrationResult.to}`);
                }
                
                // Step 3: Mark startup complete
                SystemHealth.startupComplete = true;
                
                // Log startup health summary
                const health = SystemHealth.getSummary();
                if (health.errors > 0 || health.warnings > 0) {
                    console.warn('[SENTINEL] Startup complete with issues:', health);
                } else {
                    console.log('[SENTINEL] Startup complete. Schema v' + health.schemaVersion);
                }
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // STEP 4: BOOTSTRAP SITES FROM SOP_DATA IF EMPTY
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const existingSites = DataStore.getSites();
                if (existingSites.length === 0 && typeof SOP_DATA !== 'undefined' && Object.keys(SOP_DATA).length > 0) {
                    console.log('[SENTINEL] No sites found â€” bootstrapping from SOP_DATA...');
                    const bootstrappedSites = Object.entries(SOP_DATA).map(([siteId, sop]) => {
                        const siteName = sop.meta?.siteName || sop.siteName || 'Unknown Site';
                        const coverage = sop.coverage?.hours || sop.coverage || '24/7';
                        return {
                            id: siteId,
                            name: siteName,
                            status: 'active',
                            category: 'residential',
                            coverage: coverage,
                            address: '',
                            city: 'Newark',
                            state: 'NJ',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                    });
                    DataStore.saveSites(bootstrappedSites);
                    console.log(`[SENTINEL] Bootstrapped ${bootstrappedSites.length} sites from SOP_DATA`);
                }
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                // Load saved theme
                const settings = DataStore.getSettings();
                if (settings.theme) {
                    document.documentElement.setAttribute('data-theme', settings.theme);
                }

                // Migrate legacy data formats to new array-based formats
                DataStore.migrateLegacyAvailability();

                // Firebase/Firestore status
                this.checkFirestoreStatus();

                // Initialize Authentication & Security Module
                if (window.SentinelAuth) {
                    SentinelAuth.init().then(() => {
                        console.log('[SENTINEL] Auth module initialized');
                        // Wrap DataStore with audit logging
                        if (window.SecureFirestore) {
                            SecureFirestore.wrapDataStore();
                        }
                    }).catch(err => {
                        console.warn('[SENTINEL] Auth init failed:', err);
                    });
                }

                // Initialize all modules
                Router.init();
                DashboardModule.init();
                QuickOps.init();
                SchedulerModule.init();
                IncidentsModule.init();
                InspectionsModule.init();
                SupervisorLogModule.init();
                CommsLogModule.init();
                ExportModule.init();
                ClientPortalModule.init();
                ClientPortalModule.updatePinsList();
                CalloffsModule.init();
                SitesModule.init();
                ContactsModule.init();
                DocumentsModule.init();
                GuardPerformanceModule.init();
                RosterModule.init();
                AvailabilityModule.init();
                ReportsModule.init();
                AnalyticsModule.init();
                SettingsModule.init();
                CSVImportModule.init();
                AIInsights.init();
                TasksModule.init();
                AIAssistant.init();
                CommandConsole.init();
                CommandPalette.init();
                AutoBackup.init();

                // Close dropdowns when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.dropdown')) {
                        document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                            menu.classList.remove('show');
                        });
                    }
                });

                // Scroll to top button visibility
                const scrollTopBtn = document.getElementById('scroll-top-btn');
                const mainBody = document.querySelector('.main-body');
                if (scrollTopBtn && mainBody) {
                    mainBody.addEventListener('scroll', () => {
                        if (mainBody.scrollTop > 300) {
                            scrollTopBtn.classList.add('visible');
                        } else {
                            scrollTopBtn.classList.remove('visible');
                        }
                    });
                    
                    // Also update the click handler to scroll main-body
                    scrollTopBtn.onclick = () => {
                        mainBody.scrollTo({ top: 0, behavior: 'smooth' });
                    };
                }

                // Warn before leaving if there are pending syncs
                window.addEventListener('beforeunload', (e) => {
                    if (DataStore.hasPendingSyncs()) {
                        e.preventDefault();
                        e.returnValue = 'You have unsaved changes that are still syncing to the cloud. Are you sure you want to leave?';
                        return e.returnValue;
                    }
                });

                // Theme toggle in header
                document.getElementById('theme-toggle')?.addEventListener('click', () => {
                    const current = document.documentElement.getAttribute('data-theme');
                    const next = current === 'light' ? 'dark' : 'light';
                    SettingsModule.setTheme(next);
                    document.getElementById('settings-theme').value = next;
                });

                // Privacy mode toggle
                document.getElementById('privacy-toggle')?.addEventListener('click', () => {
                    const html = document.documentElement;
                    const btn = document.getElementById('privacy-toggle');
                    const isOn = html.getAttribute('data-privacy') === 'on';

                    if (isOn) {
                        html.removeAttribute('data-privacy');
                        btn.classList.remove('active');
                        btn.title = 'Privacy Mode (blur sensitive info)';
                    } else {
                        html.setAttribute('data-privacy', 'on');
                        btn.classList.add('active');
                        btn.title = 'Privacy Mode ON - Click to disable';
                    }
                });

                // Help button
                document.getElementById('help-btn')?.addEventListener('click', () => {
                    const content = document.getElementById('help-content').innerHTML;
                    UI.openModal('Help', content, '<button class="btn btn-secondary" onclick="UI.closeModal()">Close</button>');
                });

                // AI Console button is handled by CommandConsole.init()

                // Close modal on backdrop click
                document.getElementById('modal-backdrop')?.addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) UI.closeModal();
                });

                // Enhanced keyboard shortcuts v4.6
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') UI.closeModal();

                    // Ctrl+Z - Undo
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                        e.preventDefault();
                        UndoManager.undo();
                    }

                    // Ctrl+S - Export backup
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        if (typeof SettingsModule !== 'undefined' && SettingsModule.exportData) {
                            SettingsModule.exportData();
                        }
                    }

                    // Ctrl+D - Dashboard
                    if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                        e.preventDefault();
                        Router.navigate('dashboard');
                    }

                    // Quick navigation shortcuts (when not in input)
                    const activeEl = document.activeElement;
                    const isTyping = activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.isContentEditable);
                    
                    if (!isTyping && !e.ctrlKey && !e.metaKey && !e.altKey) {
                        // H - Home/Dashboard
                        if (e.key === 'h' || e.key === 'H') {
                            e.preventDefault();
                            Router.navigate('dashboard');
                        }
                        // G then S - Go to Scheduler
                        if (e.key === 's' || e.key === 'S') {
                            e.preventDefault();
                            Router.navigate('scheduler');
                        }
                        // G then I - Go to Incidents
                        if (e.key === 'i' || e.key === 'I') {
                            e.preventDefault();
                            Router.navigate('incidents');
                        }
                        // ? - Show help
                        if (e.key === '?') {
                            e.preventDefault();
                            document.getElementById('help-btn')?.click();
                        }
                    }
                });

                // Render initial dashboard
                DashboardModule.render();
                
                // Set home button active on load (since we start on dashboard)
                const homeBtn = document.getElementById('home-btn');
                if (homeBtn) homeBtn.classList.add('active');

                // Update badges on load
                SupervisorLogModule.updateOpenCount();
                CalloffsModule.updatePendingCount();


                // Initialize enhanced features v4.6
                UndoManager.loadStack();
                AutoBackup.init();
                setTimeout(() => BackupReminder.check(), 3000);

                // Show keyboard hint
                const hint = document.getElementById('keyboard-hint');
                if (hint) {
                    hint.classList.add('show');
                    setTimeout(() => hint.classList.remove('show'), 5000);
                }

                console.log(`[SENTINEL] ${APP_FULL_NAME} initialized - All modules loaded`);
                console.log('[AUTH] Authentication & RBAC available');
                console.log('ğŸ“ Audit Logging available');
                console.log('ğŸ“‹ Warning Notice Generator available');
                console.log('ğŸ“… Guard Availability Calendar available');
                console.log('ğŸ˜° Fatigue Management available');
                console.log('ğŸ“ Document Vault available');
                console.log('ğŸ” Quick Web Search available');
                console.log('ğŸ“Š Guard Performance Module available');
                console.log('ğŸ“‹ SOP Library + Version Control available');
                console.log('ğŸ“ Communications Log (Supervisor-Grade) available');
                console.log('ğŸ“¤ Integration/Export Layer available');
                console.log('ğŸ¢ Client Portal (Read-Only) available');
                console.log('â° Overtime Tracker available');
                console.log('ğŸ”„ Replacement Wizard available');
                console.log('ğŸ¨ UI Audit Applied: Typography, Layout, Branding');
                console.log('âŒ˜ Command Palette available (Ctrl/Cmd+K to open)');
                console.log('ğŸ¤– AI Operations Assistant available (click button in header)');
            },

            // Check Firestore connection status and offer migration
            checkFirestoreStatus: function () {
                // Wait for Firebase module to load
                setTimeout(() => {
                    if (window.FirestoreDB && window.FirestoreDB.enabled) {
                        console.log('[FIREBASE] Firestore connected - data will sync to cloud');
                        UI.toast('Cloud Sync', 'Connected to Firebase - your data syncs automatically', 'success');

                        // Check if localStorage has data but Firestore might not
                        const localSites = DataStore.getSites();
                        const localGuards = DataStore.getGuards();
                        const hasLocalData = (localSites.length > 0 || localGuards.length > 0);

                        if (hasLocalData) {
                            // Offer to sync existing data to Firestore
                            this.offerFirestoreMigration();
                        }
                    } else {
                        console.log('ğŸ’¾ Running in offline mode (localStorage only)');
                        console.log('To enable cloud sync, add your Firebase config at the top of the file');
                    }
                }, 500);
            },

            // Offer migration modal to user
            offerFirestoreMigration: function () {
                const sites = DataStore.getSites().length;
                const guards = DataStore.getGuards().length;
                const incidents = DataStore.getIncidents().length;

                const content = `
                    <div style="text-align: center; padding: var(--space-4);">
                        <div style="font-size: 48px; margin-bottom: var(--space-4);">ğŸ”„</div>
                        <h3 style="margin-bottom: var(--space-3);">Sync Local Data to Cloud?</h3>
                        <p class="text-muted" style="margin-bottom: var(--space-5);">
                            Found existing data in localStorage. Would you like to upload it to Firestore?
                        </p>
                        <div class="csv-import-stats" style="margin-bottom: var(--space-5);">
                            <div class="csv-import-stat">
                                <div class="csv-import-stat-value">${sites}</div>
                                <div class="csv-import-stat-label">Sites</div>
                            </div>
                            <div class="csv-import-stat">
                                <div class="csv-import-stat-value">${guards}</div>
                                <div class="csv-import-stat-label">Guards</div>
                            </div>
                            <div class="csv-import-stat">
                                <div class="csv-import-stat-value">${incidents}</div>
                                <div class="csv-import-stat-label">Incidents</div>
                            </div>
                        </div>
                        <p class="text-sm text-muted">
                            This is a one-time migration. Future changes will sync automatically.
                        </p>
                    </div>
                `;

                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Skip for Now</button>
                    <button class="btn btn-primary" onclick="App.migrateToFirestore()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        Sync to Cloud
                    </button>
                `;

                UI.openModal('Cloud Sync Available', content, footer);
            },

            // Execute migration
            migrateToFirestore: async function () {
                UI.closeModal();
                UI.toast('Syncing...', 'Uploading data to Firestore...', 'info');

                try {
                    const localData = DataStore.exportAllData();
                    const success = await window.FirestoreDB.migrateFromLocalStorage(localData);

                    if (success) {
                        UI.toast('Sync Complete', 'All data has been uploaded to Firestore!', 'success');
                    } else {
                        UI.toast('Sync Partial', 'Some data may not have synced. Check console for details.', 'warning');
                    }
                } catch (error) {
                    console.error('Migration failed:', error);
                    UI.toast('Sync Failed', 'Could not sync data. Check console for details.', 'error');
                }
            }
        };

        // Start the app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => App.init().catch(err => console.error('[SENTINEL] Fatal init error:', err)));

        // PWA Service Worker Registration
        // Note: Service workers don't work with file:// protocol
        if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('[PWA] ServiceWorker registered:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    UI.toast('Update Available', 'Refresh for latest version', 'info');
                                }
                            });
                        });
                    })
                    .catch(err => {
                        console.warn('[PWA] ServiceWorker registration failed:', err.message);
                    });
            });
        } else if (window.location.protocol === 'file:') {
            console.log('[PWA] Running from file:// - PWA features disabled. Use localhost for full PWA support.');
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button after a delay (don't be pushy)
            setTimeout(() => {
                if (deferredPrompt && !localStorage.getItem('pwa_install_dismissed')) {
                    showInstallPrompt();
                }
            }, 30000); // 30 seconds
        });

        function showInstallPrompt() {
            const content = `
                <div style="text-align: center; padding: var(--space-4);">
                    <div style="font-size: 48px; margin-bottom: var(--space-3);">ğŸ“²</div>
                    <h3 style="margin-bottom: var(--space-2);">Install Sentinel Ops</h3>
                    <p class="text-muted mb-4">Add to your home screen for quick access, offline support, and a native app experience.</p>
                </div>
            `;
            const footer = `
                <button class="btn btn-ghost" onclick="localStorage.setItem('pwa_install_dismissed', 'true'); UI.closeModal();">Not Now</button>
                <button class="btn btn-primary" onclick="installPWA()">Install App</button>
            `;
            UI.openModal('Install App', content, footer);
        }

        async function installPWA() {
            UI.closeModal();
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    UI.toast('Installing', 'Sentinel Ops is being added to your home screen', 'success');
                }
                deferredPrompt = null;
            }
        }

        // Detect if running as installed PWA
        if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
            document.body.classList.add('pwa-standalone');
            console.log('ğŸš€ Running as installed PWA');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SENTINEL AI LOCAL QUERY ENGINE v1.0
        // Adds instant local query handling - no API key required for simple lookups
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const LocalQueryEngine = {
            
            canResolveLocally: function(input) {
                const lower = input.toLowerCase().trim();
                
                if (/(?:find|search|where(?:'s| is)|locate|look(?:ing)? for|show me|get)\s+(?:guard|officer)?\s*[a-z]+/i.test(lower)) {
                    return { local: true, type: 'guard_search' };
                }
                if (/([a-z]+)'?s?\s+(?:info|details|contact|phone|number|schedule)/i.test(lower)) {
                    return { local: true, type: 'guard_search' };
                }
                if (/who(?:'s| is) (?:working|on|assigned|scheduled)/i.test(lower)) {
                    return { local: true, type: 'schedule' };
                }
                if (/(?:tonight|today|tomorrow)(?:'s)?\s*(?:schedule|shifts?|coverage|roster)/i.test(lower)) {
                    return { local: true, type: 'schedule' };
                }
                if (/^(?:status|overview|summary|sitrep)$/i.test(lower)) {
                    return { local: true, type: 'overview' };
                }
                if (/(?:coverage|staffing)\s*(?:gaps?|issues?|status)/i.test(lower)) {
                    return { local: true, type: 'metrics' };
                }
                if (/(?:open|active|critical)\s+incidents?/i.test(lower)) {
                    return { local: true, type: 'incidents' };
                }
                if (/(?:what(?:'s| is)|how(?:'s| is))\s+(?:happening|going on|the status)\s+(?:at|with)/i.test(lower)) {
                    return { local: true, type: 'site_query' };
                }
                if (/^(?:help|commands|what can you do)/i.test(lower)) {
                    return { local: true, type: 'help' };
                }
                if (['guards', 'sites', 'incidents', 'coverage', 'gaps'].includes(lower)) {
                    return { local: true, type: 'shortcut' };
                }
                
                return { local: false };
            },
            
            execute: function(input, analysis) {
                const guards = DataStore.getGuards() || [];
                const sites = DataStore.getSites() || [];
                const incidents = DataStore.getIncidents() || [];
                const weekKey = Utils.getWeekKey(new Date());
                const shifts = DataStore.getScheduleForWeek(weekKey) || [];
                const today = Utils.toISODate(new Date());
                
                switch (analysis.type) {
                    case 'guard_search': return this.searchGuards(input, guards, sites, shifts, today);
                    case 'schedule': return this.getSchedule(input, guards, sites, shifts, today);
                    case 'overview': return this.getOverview(guards, sites, incidents, shifts, today);
                    case 'metrics': return this.getMetrics(guards, sites, incidents, shifts, today);
                    case 'incidents': return this.getIncidents(input, incidents, sites);
                    case 'site_query': return this.querySite(input, guards, sites, incidents, shifts, today);
                    case 'shortcut': return this.handleShortcut(input, guards, sites, incidents, shifts, today);
                    case 'help': return this.getHelp();
                    default: return null;
                }
            },
            
            searchGuards: function(input, guards, sites, shifts, today) {
                const patterns = [
                    /(?:find|search|where(?:'s| is)|locate|look(?:ing)? for|show me|get)\s+(?:guard|officer)?\s*([a-z]+(?:\s+[a-z]+)?)/i,
                    /([a-z]+(?:\s+[a-z]+)?)'?s?\s+(?:info|details|contact|phone|schedule)/i,
                    /(?:who is|what about|info on)\s+([a-z]+(?:\s+[a-z]+)?)/i
                ];
                
                let searchName = null;
                for (const pattern of patterns) {
                    const match = input.match(pattern);
                    if (match && match[1]) {
                        searchName = match[1].trim().toLowerCase();
                        break;
                    }
                }
                
                if (!searchName) {
                    return 'âš ï¸ Please specify a guard name.\n\nExample: "find Vaughn"';
                }
                
                const excluded = ['guard', 'officer', 'the', 'a', 'an', 'for', 'about'];
                if (excluded.includes(searchName)) {
                    return 'âš ï¸ Please specify a guard name.\n\nExample: "find Vaughn"';
                }
                
                const matches = guards.filter(function(g) {
                    const fullName = (g.name || '').toLowerCase();
                    const firstName = fullName.split(' ')[0];
                    const lastName = fullName.split(' ').slice(1).join(' ');
                    return fullName.includes(searchName) || firstName.startsWith(searchName) || lastName.startsWith(searchName);
                });
                
                if (matches.length === 0) {
                    const activeGuards = guards.filter(function(g) { return g.status === 'active'; }).map(function(g) { return g.name; }).slice(0, 15);
                    return 'âŒ No guard found matching "' + searchName + '".\n\n**Active Guards:**\n' + activeGuards.map(function(n) { return 'â€¢ ' + n; }).join('\n');
                }
                
                var result = '';
                var self = this;
                matches.forEach(function(g) {
                    var guardShifts = shifts.filter(function(s) { return s.guardId === g.id; });
                    var todayShift = guardShifts.find(function(s) { return s.date === today; });
                    var primarySite = (g.primarySites && g.primarySites.length > 0) ? sites.find(function(s) { return s.id === g.primarySites[0]; }) : null;
                    var statusIcon = g.status === 'active' ? 'ğŸŸ¢' : (g.status === 'suspended' ? 'ğŸ”´' : 'âšª');
                    
                    result += '**' + g.name + '** ' + statusIcon + '\n';
                    result += 'â€¢ Status: ' + (g.status || 'Active') + '\n';
                    result += 'â€¢ Role: ' + (g.role || 'Guard') + '\n';
                    if (g.phone) result += 'â€¢ Phone: ' + g.phone + '\n';
                    if (g.email) result += 'â€¢ Email: ' + g.email + '\n';
                    if (primarySite) result += 'â€¢ Primary Site: ' + primarySite.name + '\n';
                    
                    if (todayShift) {
                        var siteName = sites.find(function(s) { return s.id === todayShift.siteId; });
                        result += 'â€¢ **Today:** ' + (siteName ? siteName.name : 'Unknown') + ' (' + todayShift.shiftLabel + ')\n';
                    } else {
                        result += 'â€¢ Today: Not scheduled\n';
                    }
                    result += '\n';
                });
                
                return result.trim();
            },
            
            getSchedule: function(input, guards, sites, shifts, today) {
                var lower = input.toLowerCase();
                var targetDate = today;
                var dateLabel = 'Today';
                
                if (lower.includes('tomorrow')) {
                    targetDate = Utils.toISODate(new Date(Date.now() + 86400000));
                    dateLabel = 'Tomorrow';
                }
                
                var dayShifts = shifts.filter(function(s) { return s.date === targetDate; });
                
                if (dayShifts.length === 0) {
                    return 'ğŸ“… No shifts scheduled for ' + dateLabel.toLowerCase() + ' (' + targetDate + ').';
                }
                
                var bySite = {};
                dayShifts.forEach(function(s) {
                    var siteName = sites.find(function(st) { return st.id === s.siteId; });
                    siteName = siteName ? siteName.name : 'Unknown Site';
                    if (!bySite[siteName]) bySite[siteName] = [];
                    var guard = guards.find(function(g) { return g.id === s.guardId; });
                    bySite[siteName].push({
                        guard: guard ? guard.name : 'âš ï¸ UNCOVERED',
                        shift: s.shiftLabel,
                        phone: guard ? guard.phone : null
                    });
                });
                
                var result = '**ğŸ“… ' + dateLabel + "'s Schedule** (" + targetDate + ')\n\n';
                var totalAssigned = 0, totalOpen = 0;
                
                Object.keys(bySite).forEach(function(siteName) {
                    result += '**' + siteName + '**\n';
                    bySite[siteName].forEach(function(s) {
                        var icon = s.guard.includes('UNCOVERED') ? 'âš ï¸' : 'âœ…';
                        result += icon + ' ' + s.shift + ': ' + s.guard;
                        if (s.phone && !s.guard.includes('UNCOVERED')) result += ' (' + s.phone + ')';
                        result += '\n';
                        if (s.guard.includes('UNCOVERED')) totalOpen++; else totalAssigned++;
                    });
                    result += '\n';
                });
                
                var coverage = (totalAssigned + totalOpen) > 0 ? Math.round((totalAssigned / (totalAssigned + totalOpen)) * 100) : 100;
                result += '**Coverage:** ' + coverage + '% (' + totalAssigned + ' assigned, ' + totalOpen + ' open)';
                
                return result;
            },
            
            getOverview: function(guards, sites, incidents, shifts, today) {
                var dayShifts = shifts.filter(function(s) { return s.date === today; });
                var covered = dayShifts.filter(function(s) { return s.guardId; }).length;
                var uncovered = dayShifts.filter(function(s) { return !s.guardId; }).length;
                var openIncidents = incidents.filter(function(i) { return i.status !== 'Resolved'; });
                var critical = openIncidents.filter(function(i) { return i.severity === 'Critical'; }).length;
                var activeGuards = guards.filter(function(g) { return g.status === 'active'; }).length;
                var suspended = guards.filter(function(g) { return g.status === 'suspended'; }).length;
                
                var statusIcon = 'ğŸŸ¢', statusText = 'All Systems Operational';
                if (critical > 0) { statusIcon = 'ğŸ”´'; statusText = critical + ' Critical Incident' + (critical !== 1 ? 's' : '') + ' Active'; }
                else if (uncovered > 2) { statusIcon = 'ğŸŸ¡'; statusText = 'Coverage Gaps Detected'; }
                else if (openIncidents.length > 0) { statusIcon = 'ğŸŸ¡'; statusText = openIncidents.length + ' Open Incident' + (openIncidents.length !== 1 ? 's' : ''); }
                
                var result = statusIcon + ' **' + statusText + '**\n\n';
                result += '**Quick Stats**\n';
                result += 'â€¢ Sites: ' + sites.length + ' locations\n';
                result += 'â€¢ Guards: ' + guards.length + ' total (' + activeGuards + ' active' + (suspended > 0 ? ', ' + suspended + ' suspended' : '') + ')\n';
                result += 'â€¢ Today Coverage: ' + covered + '/' + (covered + uncovered) + ' shifts' + (uncovered > 0 ? ' âš ï¸' : '') + '\n';
                result += 'â€¢ Open Incidents: ' + openIncidents.length + (critical > 0 ? ' (' + critical + ' critical)' : '') + '\n';
                
                return result;
            },
            
            getMetrics: function(guards, sites, incidents, shifts, today) {
                var dayShifts = shifts.filter(function(s) { return s.date === today; });
                var covered = dayShifts.filter(function(s) { return s.guardId; }).length;
                var uncovered = dayShifts.filter(function(s) { return !s.guardId; }).length;
                var total = covered + uncovered;
                var coveragePercent = total > 0 ? Math.round((covered / total) * 100) : 100;
                
                var result = '**ğŸ“Š Coverage Metrics**\n\n';
                result += 'â€¢ Coverage Rate: ' + coveragePercent + '%\n';
                result += 'â€¢ Shifts Filled: ' + covered + '/' + total + '\n';
                result += 'â€¢ Open Shifts: ' + uncovered + '\n';
                
                if (uncovered === 0) {
                    result += '\nâœ… All sites fully covered today';
                }
                
                return result;
            },
            
            getIncidents: function(input, incidents, sites) {
                var lower = input.toLowerCase();
                var filtered = incidents.filter(function(i) { return i.status !== 'Resolved'; });
                var filterLabel = 'Open';
                
                if (lower.includes('critical')) {
                    filtered = filtered.filter(function(i) { return i.severity === 'Critical'; });
                    filterLabel = 'Critical';
                }
                
                if (filtered.length === 0) {
                    return 'âœ… No ' + filterLabel.toLowerCase() + ' incidents found.';
                }
                
                var result = '**ğŸš¨ ' + filterLabel + ' Incidents** (' + filtered.length + ')\n\n';
                filtered.slice(0, 10).forEach(function(inc) {
                    var icon = {'Critical':'ğŸ”´','High':'ğŸŸ ','Medium':'ğŸŸ¡','Low':'ğŸŸ¢'}[inc.severity] || 'âšª';
                    var siteName = sites.find(function(s) { return s.id === inc.siteId; });
                    siteName = siteName ? siteName.name : 'Unknown';
                    result += icon + ' **' + (inc.type || 'Incident') + '** at ' + siteName + '\n';
                    result += '   Status: ' + (inc.status || 'Open') + '\n\n';
                });
                
                return result;
            },
            
            querySite: function(input, guards, sites, incidents, shifts, today) {
                var match = input.match(/(?:at|with|for)\s+([a-z0-9\s]+?)(?:\?|$)/i);
                if (!match) return 'âš ï¸ Please specify a site name.';
                
                var searchTerm = match[1].trim().toLowerCase();
                var site = sites.find(function(s) { return (s.name || '').toLowerCase().includes(searchTerm); });
                
                if (!site) {
                    return 'âŒ No site found matching "' + searchTerm + '".';
                }
                
                var siteShifts = shifts.filter(function(s) { return s.siteId === site.id && s.date === today; });
                var siteIncidents = incidents.filter(function(i) { return i.siteId === site.id && i.status !== 'Resolved'; });
                
                var result = '**ğŸ¢ ' + site.name + '**\n';
                if (site.address) result += 'ğŸ“ ' + site.address + '\n';
                result += '\n**Today Coverage**\n';
                
                if (siteShifts.length === 0) {
                    result += 'â€¢ No shifts scheduled\n';
                } else {
                    siteShifts.forEach(function(s) {
                        var guard = guards.find(function(g) { return g.id === s.guardId; });
                        var icon = guard ? 'âœ…' : 'âš ï¸';
                        result += icon + ' ' + s.shiftLabel + ': ' + (guard ? guard.name : 'UNCOVERED') + '\n';
                    });
                }
                
                result += '\n**Open Incidents:** ' + siteIncidents.length;
                return result;
            },
            
            handleShortcut: function(input, guards, sites, incidents, shifts, today) {
                var lower = input.toLowerCase().trim();
                if (lower === 'guards') {
                    var active = guards.filter(function(g) { return g.status === 'active'; });
                    var result = '**ğŸ‘¥ Guards** (' + guards.length + ' total, ' + active.length + ' active)\n\n';
                    active.slice(0, 20).forEach(function(g) {
                        result += 'â€¢ ' + g.name + ' - ' + (g.role || 'Guard') + '\n';
                    });
                    return result;
                }
                if (lower === 'sites') {
                    var result = '**ğŸ¢ Sites** (' + sites.length + ')\n\n';
                    sites.forEach(function(s) { result += 'â€¢ ' + s.name + '\n'; });
                    return result;
                }
                if (lower === 'incidents') return this.getIncidents('open', incidents, sites);
                if (lower === 'coverage' || lower === 'gaps') return this.getMetrics(guards, sites, incidents, shifts, today);
                return this.getOverview(guards, sites, incidents, shifts, today);
            },
            
            getHelp: function() {
                return '**ğŸ¤– Sentinel AI Commands**\n\n' +
                    '**âš¡ Instant (No API Key)**\n' +
                    'â€¢ find [name] â€” Guard lookup\n' +
                    'â€¢ who\'s working tonight â€” Schedule\n' +
                    'â€¢ status â€” Overview\n' +
                    'â€¢ coverage gaps â€” Metrics\n' +
                    'â€¢ open incidents â€” Incidents\n\n' +
                    '**ğŸ§  AI-Powered (API Key Required)**\n' +
                    'â€¢ Schedule changes\n' +
                    'â€¢ Recommendations\n' +
                    'â€¢ Complex analysis';
            }
        };

        // Patch AIAssistant.processMessage
        (function() {
            if (typeof AIAssistant === 'undefined') {
                console.warn('AIAssistant not found, LocalQueryEngine not activated');
                return;
            }
            
            var originalProcessMessage = AIAssistant.processMessage.bind(AIAssistant);
            
            AIAssistant.processMessage = function(userMessage) {
                var startTime = performance.now();
                var analysis = LocalQueryEngine.canResolveLocally(userMessage);
                
                if (analysis.local) {
                    var result = LocalQueryEngine.execute(userMessage, analysis);
                    if (result) {
                        var responseTime = Math.round(performance.now() - startTime);
                        this.showTyping(false);
                        this.addMessage(result + '\n\n_âš¡ Instant (' + responseTime + 'ms)_', 'assistant');
                        this.conversationHistory.push({ role: 'user', content: userMessage });
                        this.conversationHistory.push({ role: 'assistant', content: result });
                        if (this.conversationHistory.length > 20) {
                            this.conversationHistory = this.conversationHistory.slice(-20);
                        }
                        this.isProcessing = false;
                        return;
                    }
                }
                
                return originalProcessMessage(userMessage);
            };
            
            console.log('[AI] Local Query Engine activated');
        })();
    </script>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SENTINEL AUTH MODULE v6.6 - Authentication, RBAC, Audit Logging
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AUTHENTICATION MODULE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const SentinelAuth = {
            // State
            user: null,
            role: null,
            isInitialized: false,
            _authStateListeners: [],
            
            // Role hierarchy (higher index = more permissions)
            ROLES: {
                guest: 0,
                client: 1,
                guard: 2,
                supervisor: 3,
                admin: 4
            },
            
            // Role display names
            ROLE_LABELS: {
                guest: 'Guest',
                client: 'Client Portal',
                guard: 'Security Officer',
                supervisor: 'Supervisor',
                admin: 'Administrator'
            },
            
            async init() {
                console.log('[AUTH] Initializing authentication module...');
                
                // v6.8: Wait for Firebase module to load (max 3 seconds)
                if (!window.FirebaseModuleReady) {
                    console.log('[AUTH] Waiting for Firebase module...');
                    await new Promise((resolve) => {
                        const timeout = setTimeout(() => {
                            console.warn('[AUTH] Firebase module load timeout');
                            resolve();
                        }, 3000);
                        
                        window.addEventListener('firebase-ready', () => {
                            clearTimeout(timeout);
                            console.log('[AUTH] Firebase module ready');
                            resolve();
                        }, { once: true });
                        
                        // Check if it loaded while we were setting up listener
                        if (window.FirebaseModuleReady) {
                            clearTimeout(timeout);
                            resolve();
                        }
                    });
                }
                
                if (typeof window.getAuth === 'undefined' || !window.firebaseAuth) {
                    console.warn('[AUTH] Firebase Auth not loaded. Auth features disabled.');
                    this.isInitialized = true;
                    this._notifyAuthStateChange();
                    return;
                }
                
                try {
                    this.auth = window.firebaseAuth;
                    
                    window.onAuthStateChanged(this.auth, async (user) => {
                        await this._handleAuthStateChange(user);
                    });
                    
                    this.isInitialized = true;
                    console.log('[AUTH] Authentication module initialized');
                    
                } catch (error) {
                    console.error('[AUTH] Initialization failed:', error);
                    this.isInitialized = true;
                    this._notifyAuthStateChange();
                }
            },
            
            async _handleAuthStateChange(user) {
                if (user) {
                    this.user = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName || user.email.split('@')[0],
                        photoURL: user.photoURL,
                        emailVerified: user.emailVerified
                    };
                    
                    const tokenResult = await user.getIdTokenResult();
                    this.user.claims = tokenResult.claims;
                    this.role = tokenResult.claims.role || 'guard';
                    this.user.org = tokenResult.claims.org;
                    this.user.guardId = tokenResult.claims.guardId;
                    
                    console.log(`[AUTH] User signed in: ${this.user.email} (${this.role})`);
                    
                    this._updateLastLogin();
                    AuditLog.log('auth', 'login', null, { email: this.user.email, role: this.role });
                    
                } else {
                    const wasSignedIn = this.user !== null;
                    this.user = null;
                    this.role = null;
                    if (wasSignedIn) console.log('[AUTH] User signed out');
                }
                
                this._notifyAuthStateChange();
                this._updateAuthUI();
            },
            
            async _updateLastLogin() {
                if (!this.user || !window.FirestoreDB?.enabled) return;
                try {
                    await FirestoreDB.save('users', this.user.uid, {
                        lastLogin: new Date().toISOString(),
                        email: this.user.email,
                        displayName: this.user.displayName
                    });
                } catch (e) { console.warn('[AUTH] Could not update last login:', e); }
            },
            
            onAuthStateChange(callback) {
                this._authStateListeners.push(callback);
                if (this.isInitialized) callback(this.user, this.role);
                return () => { this._authStateListeners = this._authStateListeners.filter(cb => cb !== callback); };
            },
            
            _notifyAuthStateChange() {
                this._authStateListeners.forEach(cb => {
                    try { cb(this.user, this.role); } catch (e) { console.error('[AUTH] Listener error:', e); }
                });
            },
            
            async signIn(email, password) {
                if (!this.auth) throw new Error('Authentication not initialized');
                
                // SECURITY v6.8: Sanitize email and check rate limit
                const sanitizedEmail = SecurityUtils.sanitizeString(email.toLowerCase().trim());
                const rateCheck = RateLimiter.isAllowed(sanitizedEmail);
                if (!rateCheck.allowed) {
                    AuditLog.log('auth', 'login_blocked', null, { email: sanitizedEmail, reason: 'rate_limit' });
                    return { success: false, error: rateCheck.message, rateLimited: true };
                }
                
                try {
                    const result = await window.signInWithEmailAndPassword(this.auth, sanitizedEmail, password);
                    RateLimiter.clearAttempts(sanitizedEmail);
                    return { success: true, user: result.user };
                } catch (error) {
                    RateLimiter.recordAttempt(sanitizedEmail);
                    console.error('[AUTH] Sign in failed:', error);
                    const errorMessages = {
                        'auth/invalid-email': 'Invalid email address',
                        'auth/user-disabled': 'This account has been disabled',
                        'auth/user-not-found': 'Invalid email or password',
                        'auth/wrong-password': 'Invalid email or password',
                        'auth/too-many-requests': 'Too many failed attempts. Try again later.',
                        'auth/invalid-credential': 'Invalid email or password'
                    };
                    const remaining = RateLimiter.getRemainingAttempts(sanitizedEmail);
                    let errorMsg = errorMessages[error.code] || 'Authentication failed';
                    if (remaining <= 2 && remaining > 0) errorMsg += ` (${remaining} attempts remaining)`;
                    AuditLog.log('auth', 'login_failed', null, { email: sanitizedEmail, errorCode: error.code, remainingAttempts: remaining });
                    return { success: false, error: errorMsg };
                }
            },
            
            async signOut() {
                if (!this.auth) return;
                try {
                    if (this.user) AuditLog.log('auth', 'logout', null, { email: this.user.email });
                    await window.signOut(this.auth);
                    return { success: true };
                } catch (error) {
                    console.error('[AUTH] Sign out failed:', error);
                    return { success: false, error: error.message };
                }
            },
            
            async resetPassword(email) {
                if (!this.auth) throw new Error('Authentication not initialized');
                try {
                    await window.sendPasswordResetEmail(this.auth, email);
                    return { success: true };
                } catch (error) {
                    console.error('[AUTH] Password reset failed:', error);
                    return { success: false, error: error.message };
                }
            },
            
            isAuthenticated() { return this.user !== null; },
            hasRole(requiredRole) { return this.role ? this.ROLES[this.role] >= this.ROLES[requiredRole] : false; },
            isAdmin() { return this.hasRole('admin'); },
            isSupervisor() { return this.hasRole('supervisor'); },
            isGuard() { return this.hasRole('guard'); },
            
            /**
             * SECURITY NOTE: Client-side role checks (canAccess, hasRole, etc.) are for UX only.
             * They control what UI elements are shown/hidden but do NOT provide security.
             * 
             * Actual security is enforced by Firestore Security Rules (firestore.rules).
             * Even if a user bypasses client-side checks, Firestore will reject unauthorized writes.
             * 
             * Always deploy firestore.rules before using this in production.
             */
            canAccess(feature) {
                const featureRoles = {
                    'view-dashboard': 'guard', 'view-schedule': 'guard', 'view-sites': 'guard',
                    'view-guards': 'guard', 'view-incidents': 'guard', 'create-incident': 'guard',
                    'create-calloff': 'guard', 'submit-availability': 'guard',
                    'edit-schedule': 'supervisor', 'edit-guards': 'supervisor', 'manage-calloffs': 'supervisor',
                    'create-inspection': 'supervisor', 'supervisor-log': 'supervisor', 'communications': 'supervisor',
                    'reports': 'supervisor', 'manage-sites': 'admin', 'manage-users': 'admin',
                    'settings': 'admin', 'data-export': 'admin', 'data-import': 'admin', 'delete-records': 'admin'
                };
                const requiredRole = featureRoles[feature];
                return requiredRole ? this.hasRole(requiredRole) : false;
            },
            
            requireRole(requiredRole, featureName = 'this feature') {
                if (!this.isAuthenticated()) {
                    UI.toast('Authentication Required', 'Please sign in to continue.', 'warning');
                    this.showLoginModal();
                    return false;
                }
                if (!this.hasRole(requiredRole)) {
                    UI.toast('Access Denied', `You need ${this.ROLE_LABELS[requiredRole]} access for ${featureName}.`, 'error');
                    return false;
                }
                return true;
            },
            
            _updateAuthUI() {
                const authBtn = document.getElementById('auth-btn');
                const userDisplay = document.getElementById('user-display');
                
                if (this.user) {
                    if (authBtn) {
                        authBtn.innerHTML = `<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`;
                        authBtn.title = `${this.user.displayName} (${this.ROLE_LABELS[this.role]}) - Click to manage account`;
                        authBtn.classList.add('authenticated');
                        authBtn.onclick = () => this.showUserMenu();
                    }
                    if (userDisplay) {
                        userDisplay.innerHTML = `<span class="user-name">${Utils.escapeHtml(this.user.displayName)}</span><span class="user-role badge badge-${this.role}">${this.ROLE_LABELS[this.role]}</span>`;
                        userDisplay.style.display = 'flex';
                    }
                    const loginOverlay = document.getElementById('login-overlay');
                    if (loginOverlay) loginOverlay.remove();
                    this._updateRoleGatedElements();
                } else {
                    if (authBtn) {
                        authBtn.innerHTML = `<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg>`;
                        authBtn.title = 'Sign in';
                        authBtn.classList.remove('authenticated');
                        authBtn.onclick = () => this.showLoginModal();
                    }
                    if (userDisplay) userDisplay.style.display = 'none';
                    if (window.SENTINEL_REQUIRE_AUTH) this._showLoginOverlay();
                }
            },
            
            _updateRoleGatedElements() {
                document.querySelectorAll('[data-require-role]').forEach(el => {
                    const requiredRole = el.dataset.requireRole;
                    if (this.hasRole(requiredRole)) {
                        el.style.display = '';
                        el.removeAttribute('disabled');
                    } else {
                        el.style.display = 'none';
                        el.setAttribute('disabled', 'disabled');
                    }
                });
            },
            
            _showLoginOverlay() {
                if (document.getElementById('login-overlay')) return;
                const overlay = document.createElement('div');
                overlay.id = 'login-overlay';
                overlay.className = 'login-overlay';
                overlay.innerHTML = `
                    <div class="login-card">
                        <div class="login-header">
                            <span class="login-logo">S</span>
                            <h2>Sentinel Ops</h2>
                            <p class="text-muted">Newark Security Operations</p>
                        </div>
                        <form id="login-form" onsubmit="SentinelAuth.handleLoginSubmit(event)">
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="login-email" placeholder="you@newarksecurity.com" required autocomplete="email">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-input" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required autocomplete="current-password">
                            </div>
                            <div id="login-error" class="login-error" style="display: none;"></div>
                            <button type="submit" class="btn btn-primary btn-block" id="login-submit">Sign In</button>
                        </form>
                        <div class="login-footer">
                            <a href="#" onclick="SentinelAuth.showForgotPassword(event)">Forgot password?</a>
                        </div>
                        <div class="login-offline-note" style="margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--color-border);">
                            <p class="text-sm text-muted text-center">For offline mode, use <a href="#" onclick="SentinelAuth.enableOfflineMode(event)">local-only access</a></p>
                        </div>
                    </div>`;
                document.body.appendChild(overlay);
                setTimeout(() => document.getElementById('login-email')?.focus(), 100);
            },
            
            showLoginModal() {
                const content = `
                    <form id="login-modal-form" onsubmit="SentinelAuth.handleLoginSubmit(event)">
                        <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="login-email" placeholder="you@newarksecurity.com" required autocomplete="email"></div>
                        <div class="form-group"><label class="form-label">Password</label><input type="password" class="form-input" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required autocomplete="current-password"></div>
                        <div id="login-error" class="login-error" style="display: none;"></div>
                    </form>`;
                const footer = `<button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button><button class="btn btn-link" onclick="SentinelAuth.showForgotPassword(event)">Forgot password?</button><button class="btn btn-primary" onclick="SentinelAuth.handleLoginSubmit(event)">Sign In</button>`;
                UI.openModal('Sign In', content, footer);
                setTimeout(() => document.getElementById('login-email')?.focus(), 100);
            },
            
            showUserMenu() {
                const content = `
                    <div style="text-align: center; padding: var(--space-4);">
                        <div style="width: 64px; height: 64px; border-radius: 50%; background: var(--color-primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; margin: 0 auto var(--space-3);">${this.user.displayName.charAt(0).toUpperCase()}</div>
                        <h3 style="margin: 0;">${Utils.escapeHtml(this.user.displayName)}</h3>
                        <p class="text-muted">${Utils.escapeHtml(this.user.email)}</p>
                        <span class="badge badge-${this.role}" style="margin-top: var(--space-2);">${this.ROLE_LABELS[this.role]}</span>
                    </div>
                    <div style="border-top: 1px solid var(--color-border); padding-top: var(--space-4); margin-top: var(--space-4);">
                        <div class="text-sm text-muted" style="display: flex; justify-content: space-between; margin-bottom: var(--space-2);"><span>Organization</span><span>${this.user.org || 'Newark Security'}</span></div>
                        ${this.user.guardId ? `<div class="text-sm text-muted" style="display: flex; justify-content: space-between;"><span>Guard ID</span><span>${this.user.guardId}</span></div>` : ''}
                    </div>`;
                const footer = `<button class="btn btn-secondary" onclick="UI.closeModal()">Close</button><button class="btn btn-danger" onclick="SentinelAuth.handleSignOut()"><svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg> Sign Out</button>`;
                UI.openModal('Account', content, footer);
            },
            
            async handleLoginSubmit(event) {
                event.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const errorDiv = document.getElementById('login-error');
                const submitBtn = document.getElementById('login-submit') || event.target.querySelector('[type="submit"]');
                
                if (submitBtn) { submitBtn.disabled = true; submitBtn.innerHTML = '<span class="spinner"></span> Signing in...'; }
                
                const result = await this.signIn(email, password);
                
                if (result.success) {
                    UI.closeModal();
                    UI.toast('Welcome', `Signed in as ${this.user.displayName}`, 'success');
                } else {
                    if (errorDiv) { errorDiv.textContent = result.error; errorDiv.style.display = 'block'; }
                    if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Sign In'; }
                }
            },
            
            async handleSignOut() {
                UI.closeModal();
                const result = await this.signOut();
                if (result.success) {
                    UI.toast('Signed Out', 'You have been signed out.', 'info');
                    if (window.SENTINEL_REQUIRE_AUTH) this._showLoginOverlay();
                } else {
                    UI.toast('Error', result.error, 'error');
                }
            },
            
            showForgotPassword(event) {
                event.preventDefault();
                const content = `<p class="text-muted" style="margin-bottom: var(--space-4);">Enter your email address and we'll send you a link to reset your password.</p><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="reset-email" placeholder="you@newarksecurity.com" required></div><div id="reset-message" style="display: none;"></div>`;
                const footer = `<button class="btn btn-secondary" onclick="SentinelAuth.showLoginModal()">Back to Sign In</button><button class="btn btn-primary" onclick="SentinelAuth.handleResetPassword()">Send Reset Link</button>`;
                UI.openModal('Reset Password', content, footer);
            },
            
            async handleResetPassword() {
                const email = document.getElementById('reset-email').value;
                const messageDiv = document.getElementById('reset-message');
                if (!email) { messageDiv.className = 'login-error'; messageDiv.textContent = 'Please enter your email address.'; messageDiv.style.display = 'block'; return; }
                const result = await this.resetPassword(email);
                if (result.success) { messageDiv.className = 'login-success'; messageDiv.textContent = 'Password reset email sent. Check your inbox.'; } 
                else { messageDiv.className = 'login-error'; messageDiv.textContent = result.error; }
                messageDiv.style.display = 'block';
            },
            
            // SECURITY v6.8: Offline mode requires explicit confirmation
            enableOfflineMode(event) {
                event.preventDefault();
                const content = `
                    <div style="padding: var(--space-4);">
                        <div style="background: var(--color-warning-bg); border: 1px solid var(--color-warning); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-4);">
                            <strong style="color: var(--color-warning);">âš ï¸ Offline Mode Warning</strong>
                            <p class="text-sm" style="margin-top: var(--space-2);">
                                In offline mode:
                                <ul style="margin: var(--space-2) 0 0 var(--space-4);">
                                    <li>Data will NOT sync to the cloud</li>
                                    <li>Changes may be lost if browser data is cleared</li>
                                    <li>Some features may be limited</li>
                                    <li>This action will be logged for security</li>
                                </ul>
                            </p>
                        </div>
                        <p class="text-muted">Are you sure you want to continue in offline mode?</p>
                    </div>`;
                const footer = `
                    <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
                    <button class="btn btn-warning" onclick="SentinelAuth.confirmOfflineMode()">Enable Offline Mode</button>`;
                UI.openModal('Confirm Offline Mode', content, footer);
            },
            
            confirmOfflineMode() {
                UI.closeModal();
                const overlay = document.getElementById('login-overlay');
                if (overlay) overlay.remove();
                window.SENTINEL_OFFLINE_MODE = true;
                if (window.FirestoreDB) window.FirestoreDB.enabled = false;
                AuditLog.log('security', 'offline_mode_enabled', null, {
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent.substring(0, 100)
                });
                UI.toast('Offline Mode', 'Running in local-only mode. Data will not sync to cloud.', 'warning');
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AUDIT LOG MODULE (Append-Only) â€” HARDENED v6.8
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const AuditLog = {
            STORAGE_KEY: 'sentinel_audit_log',
            MAX_LOCAL_ENTRIES: 1000,
            _deviceId: null,
            
            getDeviceId() {
                if (this._deviceId) return this._deviceId;
                this._deviceId = localStorage.getItem('sentinel_device_id');
                if (!this._deviceId) {
                    // SECURITY v6.8: Use cryptographically secure ID
                    this._deviceId = SecurityUtils.generateSecureId('device');
                    localStorage.setItem('sentinel_device_id', this._deviceId);
                }
                return this._deviceId;
            },
            
            async log(action, entityType, entityId, details = {}) {
                const entry = {
                    // SECURITY v6.8: Use cryptographically secure ID
                    id: SecurityUtils.generateSecureId('audit'),
                    timestamp: new Date().toISOString(),
                    action, entityType, entityId,
                    userId: SentinelAuth.user?.uid || 'anonymous',
                    userEmail: SentinelAuth.user?.email || 'offline',
                    userRole: SentinelAuth.role || 'unknown',
                    deviceId: this.getDeviceId(),
                    sessionId: this._getSessionId(),
                    details: SecurityUtils.safeSpread(details),
                    _version: 1
                };
                this._saveLocal(entry);
                this._syncToCloud(entry);
                return entry;
            },
            
            _getSessionId() {
                // SECURITY v6.8: Use cryptographically secure ID
                if (!window._sentinelSessionId) window._sentinelSessionId = SecurityUtils.generateSecureId('session');
                return window._sentinelSessionId;
            },
            
            _saveLocal(entry) {
                try {
                    const log = this.getLocalLog();
                    log.push(entry);
                    if (log.length > this.MAX_LOCAL_ENTRIES) log.splice(0, log.length - this.MAX_LOCAL_ENTRIES);
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(log));
                } catch (e) { console.warn('[AUDIT] Local save failed:', e); }
            },
            
            async _syncToCloud(entry) {
                if (!window.FirestoreDB?.enabled || !SentinelAuth.isAuthenticated()) return;
                try { await FirestoreDB.add('auditLog', entry); } 
                catch (e) { console.warn('[AUDIT] Cloud sync failed:', e); }
            },
            
            getLocalLog() {
                try { const data = localStorage.getItem(this.STORAGE_KEY); return data ? JSON.parse(data) : []; } 
                catch (e) { return []; }
            },
            
            getRecent(count = 50, filters = {}) {
                let log = this.getLocalLog();
                if (filters.action) log = log.filter(e => e.action === filters.action);
                if (filters.entityType) log = log.filter(e => e.entityType === filters.entityType);
                if (filters.userId) log = log.filter(e => e.userId === filters.userId);
                if (filters.since) { const since = new Date(filters.since).getTime(); log = log.filter(e => new Date(e.timestamp).getTime() >= since); }
                return log.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, count);
            },
            
            export(format = 'json') {
                const log = this.getLocalLog();
                if (format === 'csv') {
                    const headers = ['timestamp', 'action', 'entityType', 'entityId', 'userEmail', 'userRole', 'deviceId'];
                    // SECURITY v6.8: Sanitize CSV output
                    const rows = log.map(e => headers.map(h => Validators.sanitizeCSVValue(String(e[h] || ''))).join(','));
                    return [headers.join(','), ...rows].join('\n');
                }
                return JSON.stringify(log, null, 2);
            },
            
            // SECURITY v6.8: Require confirmation for destructive action
            async clearLocal() {
                if (!SentinelAuth.isAdmin()) throw new Error('Admin access required');
                
                const confirmed = await new Promise((resolve) => {
                    const content = `
                        <div style="padding: var(--space-4);">
                            <div style="background: var(--color-danger-bg); border: 1px solid var(--color-danger); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-4);">
                                <strong style="color: var(--color-danger);">âš ï¸ Destructive Action</strong>
                                <p class="text-sm" style="margin-top: var(--space-2);">
                                    You are about to clear the local audit log. This action cannot be undone.
                                </p>
                            </div>
                            <p>To confirm, type "CONFIRM" below:</p>
                            <input type="text" class="form-input" id="confirm-clear-input" placeholder="Type CONFIRM" autocomplete="off">
                        </div>`;
                    const footer = `
                        <button class="btn btn-secondary" onclick="window._clearConfirmResolve(false); UI.closeModal();">Cancel</button>
                        <button class="btn btn-danger" onclick="
                            const input = document.getElementById('confirm-clear-input');
                            if (input.value === 'CONFIRM') { window._clearConfirmResolve(true); UI.closeModal(); }
                            else { input.style.borderColor = 'var(--color-danger)'; input.focus(); }
                        ">Clear Log</button>`;
                    window._clearConfirmResolve = resolve;
                    UI.openModal('Confirm Clear Audit Log', content, footer);
                });
                
                if (!confirmed) throw new Error('Action cancelled');
                
                // Log the clear action to cloud BEFORE clearing
                if (window.FirestoreDB?.enabled) {
                    await FirestoreDB.add('auditLog', {
                        id: SecurityUtils.generateSecureId('audit'),
                        timestamp: new Date().toISOString(),
                        action: 'audit_log_cleared',
                        entityType: 'system',
                        entityId: 'audit_log',
                        userId: SentinelAuth.user?.uid,
                        userEmail: SentinelAuth.user?.email,
                        entriesCleared: this.getLocalLog().length,
                        _version: 1
                    });
                }
                
                localStorage.removeItem(this.STORAGE_KEY);
                console.log('[AUDIT] Local log cleared by admin');
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SECURE FIRESTORE WRAPPER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const SecureFirestore = {
            wrapDataStore() {
                if (typeof DataStore === 'undefined') { console.warn('[SECURE] DataStore not found'); return; }
                
                this._wrapMethod('addGuard', 'create', 'guard', (guard) => guard.id);
                this._wrapMethod('updateGuard', 'update', 'guard', (id) => id);
                this._wrapMethod('deleteGuard', 'delete', 'guard', (id) => id);
                this._wrapMethod('addSite', 'create', 'site', (site) => site.id);
                this._wrapMethod('updateSite', 'update', 'site', (id) => id);
                this._wrapMethod('addIncident', 'create', 'incident', (incident) => incident.id);
                this._wrapMethod('updateIncident', 'update', 'incident', (id) => id);
                this._wrapMethod('saveInspection', 'create', 'inspection', (inspection) => inspection.id);
                this._wrapMethod('saveScheduleForWeek', 'update', 'schedule', (weekKey) => weekKey);
                this._wrapMethod('addCalloff', 'create', 'calloff', (calloff) => calloff.id);
                this._wrapMethod('updateCalloff', 'update', 'calloff', (id) => id);
                
                console.log('[SECURE] DataStore wrapped with audit logging');
            },
            
            _wrapMethod(methodName, action, entityType, getIdFn) {
                const original = DataStore[methodName];
                if (!original) return;
                DataStore[methodName] = function(...args) {
                    const entityId = getIdFn(...args);
                    AuditLog.log(action, entityType, entityId, { method: methodName });
                    return original.apply(DataStore, args);
                };
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AUTH CSS STYLES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        (function injectAuthStyles() {
            const style = document.createElement('style');
            style.id = 'sentinel-auth-styles';
            style.textContent = `
                .login-overlay { position: fixed; inset: 0; background: var(--color-bg); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: var(--space-4); }
                .login-card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-xl); padding: var(--space-8); width: 100%; max-width: 400px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
                .login-header { text-align: center; margin-bottom: var(--space-6); }
                .login-logo { display: inline-flex; align-items: center; justify-content: center; width: 48px; height: 48px; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover)); color: white; font-size: 24px; font-weight: bold; border-radius: var(--radius-lg); margin-bottom: var(--space-3); }
                .login-header h2 { margin: 0 0 var(--space-1) 0; font-size: var(--font-size-xl); }
                .login-error { background: var(--color-danger-bg); color: var(--color-danger); padding: var(--space-3); border-radius: var(--radius-md); font-size: var(--font-size-sm); margin-bottom: var(--space-4); }
                .login-success { background: var(--color-success-bg); color: var(--color-success); padding: var(--space-3); border-radius: var(--radius-md); font-size: var(--font-size-sm); margin-bottom: var(--space-4); }
                .login-footer { text-align: center; margin-top: var(--space-4); }
                .login-footer a { color: var(--color-text-muted); font-size: var(--font-size-sm); }
                .login-footer a:hover { color: var(--color-primary); }
                #auth-btn.authenticated { color: var(--color-success); }
                #auth-btn.authenticated:hover { background: var(--color-success-bg); }
                #user-display { display: none; align-items: center; gap: var(--space-2); padding: var(--space-1) var(--space-3); background: var(--color-surface); border-radius: var(--radius-full); font-size: var(--font-size-sm); }
                .user-name { font-weight: var(--font-weight-medium); max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
                .badge-admin { background: var(--color-danger-bg); color: var(--color-danger); }
                .badge-supervisor { background: var(--color-warning-bg); color: var(--color-warning); }
                .badge-guard { background: var(--color-info-bg); color: var(--color-info); }
                .badge-client { background: var(--color-surface); color: var(--color-text-muted); }
                [data-require-role][disabled] { opacity: 0.5; cursor: not-allowed; }
                .btn-block { display: block; width: 100%; }
                .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spin 0.75s linear infinite; vertical-align: middle; margin-right: var(--space-2); }
                @media (max-width: 480px) { .login-card { padding: var(--space-6); } #user-display { display: none !important; } }
            `;
            document.head.appendChild(style);
        })();

        // Make modules globally available
        window.SentinelAuth = SentinelAuth;
        window.AuditLog = AuditLog;
        window.SecureFirestore = SecureFirestore;
        window.SENTINEL_REQUIRE_AUTH = false; // Set to true to require login

        // v6.9.0: Expose modules for console debugging
        window.DataStore = DataStore;
        window.SchedulerModule = SchedulerModule;
        window.Utils = Utils;
        window.TasksModule = TasksModule;
        window.AIInsights = AIInsights;
        window.InsightsEngine = InsightsEngine;  // v6.9.0: New Insights Engine
        
        // v6.8.6: Task diagnostic helper
        window.TasksDiag = {
            list: function() {
                const tasks = DataStore.getTasks();
                console.table(tasks.map(t => ({ id: t.id, title: t.title, status: t.status, priority: t.priority })));
                return tasks;
            },
            clearAll: function() {
                if (confirm('Delete ALL tasks? This cannot be undone.')) {
                    DataStore.saveTasks([]);
                    TasksModule.render();
                    console.log('[TasksDiag] All tasks cleared');
                    return 'All tasks deleted';
                }
                return 'Cancelled';
            },
            deleteById: function(id) {
                let tasks = DataStore.getTasks();
                tasks = tasks.filter(t => t.id !== id);
                DataStore.saveTasks(tasks);
                TasksModule.render();
                console.log('[TasksDiag] Deleted task:', id);
            }
        };
        
        // v6.8.6: Schedule diagnostic helper
        window.ScheduleDiag = {
            // Show what's in the current week
            showThisWeek: function() {
                const weekKey = Utils.getWeekKey(new Date());
                const shifts = DataStore.getScheduleForWeek(weekKey);
                console.log(`\nğŸ“… WEEK: ${weekKey}`);
                console.log(`Total shifts: ${shifts.length}`);
                
                // Group by site
                const bySite = {};
                shifts.forEach(s => {
                    const site = DataStore.getSites().find(st => st.id === s.siteId);
                    const siteName = site?.name || s.siteId;
                    if (!bySite[siteName]) bySite[siteName] = [];
                    bySite[siteName].push(s);
                });
                
                Object.keys(bySite).sort().forEach(siteName => {
                    console.log(`\nğŸ¢ ${siteName}: ${bySite[siteName].length} shifts`);
                });
                return { weekKey, totalShifts: shifts.length, bySite };
            },
            
            // List all weeks with data
            allWeeks: function() {
                const schedules = DataStore.getSchedules();
                const weeks = Object.keys(schedules).sort();
                console.log('\nğŸ“† ALL SCHEDULE WEEKS:');
                weeks.forEach(w => {
                    console.log(`  ${w}: ${schedules[w]?.length || 0} shifts`);
                });
                return weeks;
            },
            
            // Clear everything and start fresh
            clearAll: function() {
                const count = DataStore.clearAllSchedules();
                console.log(`ğŸ—‘ï¸ Cleared ${count} shifts from all weeks`);
                return count;
            },
            
            // Show guards in system
            guards: function() {
                const guards = DataStore.getGuards();
                console.log(`\nğŸ‘® ${guards.length} GUARDS IN SYSTEM:`);
                guards.forEach(g => console.log(`  ${g.name} | ${g.phone || 'no phone'} | ${g.role}`));
                return guards;
            }
        };
        console.log('ğŸ’¡ Debug: ScheduleDiag.showThisWeek() | ScheduleDiag.clearAll() | ScheduleDiag.guards()');

        console.log('[AUTH] Sentinel Auth Module v6.8 (Hardened) loaded');

        // =====================================================================
        // v6.10.3 â€” BULK SCHEDULER MODULE
        // Adds: Duplicate last week, clear week, export CSV
        // Access: Press B then S (quick sequence) or via Command Palette
        // =====================================================================
        (function() {
            const BulkScheduler = {
                isOpen: false,
                
                init: function() {
                    this.createUI();
                    this.bindKeys();
                    
                    // Add to Command Palette if it exists
                    if (typeof CommandPalette !== 'undefined' && CommandPalette.commands) {
                        CommandPalette.commands.push(
                            { id: 'bulk-scheduler', title: 'Open Bulk Scheduler', desc: 'Mass scheduling operations (B,S)', action: () => BulkScheduler.open(), category: 'Tools', icon: 'âš¡' },
                            { id: 'bulk-duplicate', title: 'Duplicate Last Week', desc: 'Copy shifts from last week', action: () => BulkScheduler.duplicateLastWeek(), category: 'Tools', icon: 'ğŸ“‹' },
                            { id: 'bulk-export', title: 'Export Schedule CSV', desc: 'Download schedule as CSV', action: () => BulkScheduler.exportCSV(), category: 'Tools', icon: 'ğŸ“¤' }
                        );
                    }
                    
                    console.log('[BulkScheduler] v6.10.3 ready â€” press B then S to open');
                },
                
                createUI: function() {
                    const div = document.createElement('div');
                    div.id = 'bulk-scheduler-overlay';
                    div.style.cssText = 'display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.7);';
                    div.innerHTML = `
                        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--color-surface,#1a1a2e);border:1px solid var(--color-border,#333);border-radius:12px;padding:24px;width:90%;max-width:400px;color:var(--color-text,#fff);">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                                <h2 style="margin:0;font-size:1.25rem;">âš¡ Bulk Scheduler</h2>
                                <button onclick="BulkScheduler.close()" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--color-text-muted,#888);">Ã—</button>
                            </div>
                            <div id="bulk-actions" style="display:flex;flex-direction:column;gap:8px;"></div>
                            <div id="bulk-result" style="margin-top:12px;padding:10px;border-radius:6px;display:none;"></div>
                        </div>
                    `;
                    document.body.appendChild(div);
                    
                    // Add action buttons
                    const actions = document.getElementById('bulk-actions');
                    const btns = [
                        { icon: 'ğŸ“‹', label: 'Duplicate Last Week', fn: 'duplicateLastWeek' },
                        { icon: 'ğŸ—‘ï¸', label: 'Clear Current Week', fn: 'clearWeek' },
                        { icon: 'ğŸ“¤', label: 'Export Schedule CSV', fn: 'exportCSV' }
                    ];
                    btns.forEach(b => {
                        const btn = document.createElement('button');
                        btn.style.cssText = 'display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--color-surface-elevated,#252540);border:1px solid var(--color-border,#333);border-radius:8px;color:var(--color-text,#fff);cursor:pointer;font-size:0.95rem;text-align:left;';
                        btn.innerHTML = `<span style="font-size:1.25rem;">${b.icon}</span><span>${b.label}</span>`;
                        btn.onclick = () => this[b.fn]();
                        actions.appendChild(btn);
                    });
                    
                    // Close on backdrop click
                    div.addEventListener('click', (e) => { if (e.target === div) this.close(); });
                },
                
                bindKeys: function() {
                    let bPressed = false;
                    document.addEventListener('keydown', (e) => {
                        const tag = document.activeElement?.tagName;
                        if (tag === 'INPUT' || tag === 'TEXTAREA') return;
                        
                        if (e.key === 'b' && !e.ctrlKey && !e.metaKey) {
                            bPressed = true;
                            setTimeout(() => bPressed = false, 600);
                        }
                        if (bPressed && e.key === 's' && !e.ctrlKey && !e.metaKey) {
                            e.preventDefault();
                            bPressed = false;
                            this.open();
                        }
                        if (this.isOpen && e.key === 'Escape') {
                            this.close();
                        }
                    });
                },
                
                open: function() {
                    document.getElementById('bulk-scheduler-overlay').style.display = 'block';
                    this.isOpen = true;
                },
                
                close: function() {
                    document.getElementById('bulk-scheduler-overlay').style.display = 'none';
                    document.getElementById('bulk-result').style.display = 'none';
                    this.isOpen = false;
                },
                
                showResult: function(msg, success) {
                    const el = document.getElementById('bulk-result');
                    el.textContent = msg;
                    el.style.display = 'block';
                    el.style.background = success ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)';
                    el.style.color = success ? '#22c55e' : '#ef4444';
                },
                
                duplicateLastWeek: function() {
                    try {
                        const shifts = DataStore.getShifts();
                        const now = new Date();
                        const sun = new Date(now); 
                        sun.setDate(now.getDate() - now.getDay());
                        sun.setHours(0,0,0,0);
                        
                        const lastSun = new Date(sun);
                        lastSun.setDate(lastSun.getDate() - 7);
                        
                        const lastWeek = shifts.filter(s => {
                            const d = new Date(s.date);
                            return d >= lastSun && d < sun;
                        });
                        
                        if (!lastWeek.length) {
                            this.showResult('No shifts found from last week', false);
                            return;
                        }
                        
                        lastWeek.forEach(s => {
                            const d = new Date(s.date);
                            d.setDate(d.getDate() + 7);
                            DataStore.addShift({
                                ...s,
                                id: Utils.generateId(),
                                date: d.toISOString().split('T')[0],
                                createdAt: new Date().toISOString()
                            });
                        });
                        
                        this.showResult(`âœ… Duplicated ${lastWeek.length} shifts`, true);
                        if (typeof SchedulerModule !== 'undefined') SchedulerModule.render();
                    } catch (e) {
                        this.showResult('Error: ' + e.message, false);
                    }
                },
                
                clearWeek: function() {
                    if (!confirm('Delete ALL shifts for current week?')) return;
                    try {
                        const shifts = DataStore.getShifts();
                        const now = new Date();
                        const sun = new Date(now);
                        sun.setDate(now.getDate() - now.getDay());
                        sun.setHours(0,0,0,0);
                        const sat = new Date(sun);
                        sat.setDate(sat.getDate() + 7);
                        
                        let count = 0;
                        shifts.forEach(s => {
                            const d = new Date(s.date);
                            if (d >= sun && d < sat) {
                                DataStore.deleteShift(s.id);
                                count++;
                            }
                        });
                        
                        this.showResult(`ğŸ—‘ï¸ Removed ${count} shifts`, true);
                        if (typeof SchedulerModule !== 'undefined') SchedulerModule.render();
                    } catch (e) {
                        this.showResult('Error: ' + e.message, false);
                    }
                },
                
                exportCSV: function() {
                    try {
                        const shifts = DataStore.getShifts();
                        const guards = DataStore.getGuards();
                        const sites = DataStore.getSites();
                        
                        const gMap = {}; guards.forEach(g => gMap[g.id] = g.name);
                        const sMap = {}; sites.forEach(s => sMap[s.id] = s.name);
                        
                        let csv = 'Date,Site,Guard,Start,End\n';
                        shifts.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(s => {
                            csv += `"${s.date}","${sMap[s.siteId]||''}","${gMap[s.guardId]||''}","${s.startTime||''}","${s.endTime||''}"\n`;
                        });
                        
                        const blob = new Blob([csv], {type:'text/csv'});
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = 'schedule_' + new Date().toISOString().split('T')[0] + '.csv';
                        a.click();
                        
                        this.showResult(`ğŸ“¤ Exported ${shifts.length} shifts`, true);
                    } catch (e) {
                        this.showResult('Error: ' + e.message, false);
                    }
                }
            };
            
            // Initialize when DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => BulkScheduler.init());
            } else {
                BulkScheduler.init();
            }
            
            window.BulkScheduler = BulkScheduler;
        })();

        console.log('ğŸš€ Sentinel Ops v6.19.4 loaded');
    </script>
</body>

</html>
